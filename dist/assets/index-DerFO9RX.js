import{t as m,k as e,J as ge,L as z,M as oe,S as $,O as I,K as E,p as je,P as fe}from"./index-DrOkdIyL.js";import{c as P,m as he,a as ce,f as ve}from"./months-DiLwPhVv.js";import{c as be,d as ye,n as Ee,e as Me}from"./tableModels-D8x4D7lf.js";import{u as Ne,C as T}from"./workspace-hSJpURcw.js";import{t as A}from"./orderUtils-CdSgcPrO.js";import{D as M}from"./DeNumberInput-DYC0ZMi2.js";import{S as Re}from"./index-Bs0NWQOM.js";import"./productCompletenessV2-wFpo7RYV.js";import"./planProducts-CpwZ2WgY.js";import"./Dropdown-QmF6_rIx.js";import"./foSuggestion-Ck1952gl.js";import"./index-D1FgTqkK.js";const{Paragraph:Pe,Text:R,Title:O}=ge,Se=3;function Ce(s){return s instanceof HTMLElement?!!(s.matches("input:not([type='hidden']), textarea, [contenteditable='true']")||s.closest(".ant-select, .ant-picker, .ant-input-number")):!1}function ne(s){return/^\d{4}-\d{2}$/.test(String(s||"").trim())}function c(s){if(s==null||s==="")return null;if(typeof s=="number")return Number.isFinite(s)?s:null;const r=je(s);return Number.isFinite(r)?Number(r):null}function S(s,r=P()){const d=String(s||"").trim();return/^\d{4}-\d{2}$/.test(d)?d:r}function Ae(s,r){return{id:String(s.id||A("inc")),month:S(s.month,r),revenueEur:c(s.revenueEur),payoutPct:c(s.payoutPct),source:String(s.source||"manual")==="forecast"?"forecast":"manual"}}function U(s){return s.slice().sort((r,d)=>r.month===d.month?r.id.localeCompare(d.id):r.month.localeCompare(d.month))}function Q(s,r,d){const W=he(r,Math.max(1,Math.round(d||1))),H=new Set(W),K=new Map;return U(s).forEach(f=>{H.has(f.month)&&K.set(f.month,{...f,id:f.id||A("inc"),source:f.source==="forecast"?"forecast":"manual",revenueEur:c(f.revenueEur),payoutPct:c(f.payoutPct)})}),U(Array.from(K.values()))}function ue(s,r=2){const d=Number(s);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"—"}function de(s){if(!ne(s))return null;const r=Number(s.slice(5,7));return!Number.isFinite(r)||r<1||r>12?null:r}function Ue(s){return!Number.isFinite(s)||s<0?0:s>100?100:s}function ke(s){return Number.isFinite(s)?`${s>0?"+":""}${s.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}`:""}function te(s){return JSON.stringify({openingBalance:Number(s.openingBalance||0),startMonth:String(s.startMonth||""),horizonMonths:Math.max(1,Math.round(Number(s.horizonMonths||1))),incomings:U(s.incomings).map(r=>({id:String(r.id||""),month:String(r.month||""),revenueEur:c(r.revenueEur),payoutPct:c(r.payoutPct),source:r.source==="forecast"?"forecast":"manual"})),extras:s.extras.slice().sort((r,d)=>r.id.localeCompare(d.id)).map(r=>({id:String(r.id||""),date:String(r.date||""),label:String(r.label||""),amountEur:c(r.amountEur)})),dividends:s.dividends.slice().sort((r,d)=>r.month===d.month?r.id.localeCompare(d.id):r.month.localeCompare(d.month)).map(r=>({id:String(r.id||""),month:String(r.month||""),label:String(r.label||""),amountEur:c(r.amountEur)})),monthlyActuals:s.monthlyActuals.slice().sort((r,d)=>r.month.localeCompare(d.month)).map(r=>({month:String(r.month||""),realRevenueEUR:c(r.realRevenueEUR),realPayoutRatePct:c(r.realPayoutRatePct),realClosingBalanceEUR:c(r.realClosingBalanceEUR)}))})}function Xe(){const{state:s,loading:r,saving:d,error:W,lastSavedAt:H,saveWith:K}=Ne(),[f,ae]=m.useState(0),[v,se]=m.useState(P()),[b,V]=m.useState(18),[N,y]=m.useState([]),[X,k]=m.useState([]),[_,B]=m.useState([]),[F,C]=m.useState([]),[Y,G]=m.useState(!1),[ie,Z]=m.useState(""),D=m.useRef(null),J=m.useRef(""),w=m.useRef(!0),re=m.useMemo(()=>he(v,Math.max(1,Math.round(b||1))),[b,v]),le=m.useMemo(()=>{const t=s,a=be(t),n=ye(t,a),i=s.forecast||{},u=i.forecastImport||{},o=Ee(i.forecastManual||{});return Me({allMonths:re,products:n,manualDraft:o,forecastImport:u})},[re,s]);m.useEffect(()=>{const t=s.settings||{},a=Number(c(t.openingBalance)||0),n=S(t.startMonth,P()),i=Math.max(1,Math.round(Number(t.horizonMonths||18)||18)),u=(Array.isArray(s.incomings)?s.incomings:[]).map(j=>Ae(j,n)),o=Q(u,n,i),h=(Array.isArray(s.extras)?s.extras:[]).map(j=>{const x=j;return{id:String(x.id||A("extra")),date:String(x.date||""),label:String(x.label||"Extra"),amountEur:c(x.amountEur)}}),p=(Array.isArray(s.dividends)?s.dividends:[]).map(j=>{const x=j;return{id:String(x.id||A("div")),month:S(x.month,n),label:String(x.label||"Dividende"),amountEur:c(x.amountEur)}}),l=s.monthlyActuals&&typeof s.monthlyActuals=="object"?s.monthlyActuals:{},g=Object.entries(l).map(([j,x])=>({month:S(j,P()),realRevenueEUR:c(x.realRevenueEUR),realPayoutRatePct:c(x.realPayoutRatePct),realClosingBalanceEUR:c(x.realClosingBalanceEUR)})).sort((j,x)=>j.month.localeCompare(x.month));w.current=!0,ae(a),se(n),V(i),y(o),k(h),B(p),C(g),J.current=te({openingBalance:a,startMonth:n,horizonMonths:i,incomings:o,extras:h,dividends:p,monthlyActuals:g}),G(!1),Z("")},[s.dividends,s.extras,s.incomings,s.monthlyActuals,s.settings]),m.useEffect(()=>()=>{D.current!=null&&window.clearTimeout(D.current)},[]);const me=m.useMemo(()=>{const t=new Map;return N.forEach(a=>{const n=Number(a.revenueEur||0),i=Number(a.payoutPct||0);t.set(a.month,n*(i/100))}),t},[N]),q=m.useMemo(()=>{const t=F.map(n=>({month:S(n.month,""),payoutPct:c(n.realPayoutRatePct)})).filter(n=>ne(n.month)&&Number.isFinite(n.payoutPct)).sort((n,i)=>n.month.localeCompare(i.month)),a=new Map;return t.length&&N.forEach(n=>{const i=de(n.month);if(!i)return;let u=0,o=0;t.forEach((h,p)=>{const l=Number(h.payoutPct);if(!Number.isFinite(l))return;const g=de(h.month),L=(.5+(p+1)/t.length*.9)*(g===i?1.35:1);u+=l*L,o+=L}),!(!Number.isFinite(o)||o<=0)&&a.set(n.month,Ue(u/o))}),a},[N,F]),xe=m.useMemo(()=>Array.from(q.values()).some(t=>Number.isFinite(t)),[q]);async function pe(t){const a=Q(N,v,b),n={openingBalance:f,startMonth:v,horizonMonths:b,incomings:a,extras:X,dividends:_,monthlyActuals:F},i=te(n);if(i===J.current){G(!1);return}await K(u=>{const o=fe(u),h=o.settings||{};o.settings={...h,openingBalance:Number(n.openingBalance||0),startMonth:n.startMonth,horizonMonths:Math.max(1,Math.round(n.horizonMonths||1)),lastUpdatedAt:new Date().toISOString()},o.incomings=U(n.incomings).map(l=>({id:l.id,month:l.month,revenueEur:Number(l.revenueEur||0),payoutPct:Number(l.payoutPct||0),source:l.source})),o.extras=n.extras.map(l=>({id:l.id,date:l.date||null,month:l.date?l.date.slice(0,7):null,label:l.label,amountEur:Number(l.amountEur||0)})),o.dividends=n.dividends.map(l=>({id:l.id,month:l.month,date:`${l.month}-28`,label:l.label,amountEur:Number(l.amountEur||0)}));const p={};return n.monthlyActuals.forEach(l=>{if(!ne(l.month))return;const g={},j=c(l.realRevenueEUR),x=c(l.realPayoutRatePct),L=c(l.realClosingBalanceEUR);Number.isFinite(j)&&(g.realRevenueEUR=Number(j)),Number.isFinite(x)&&(g.realPayoutRatePct=Number(x)),Number.isFinite(L)&&(g.realClosingBalanceEUR=Number(L)),Object.keys(g).length&&(p[l.month]=g)}),o.monthlyActuals=p,o},t),J.current=i,G(!1),Z(`Gespeichert: ${new Date().toLocaleTimeString("de-DE")}`)}function ee(t=380){D.current!=null&&window.clearTimeout(D.current),D.current=window.setTimeout(()=>{if(D.current=null,d){ee(220);return}pe("v2:inputs:auto")},Math.max(80,Number(t)||380))}return m.useEffect(()=>{if(w.current){w.current=!1;return}const a=te({openingBalance:f,startMonth:v,horizonMonths:b,incomings:N,extras:X,dividends:_,monthlyActuals:F})!==J.current;G(a),a&&(Z("Ungespeicherte Aenderungen"),ee(380))},[f,v,b,N,X,_,F]),e.jsxs("div",{className:"v2-page",onBlurCapture:t=>{Ce(t.target)&&Y&&ee(120)},children:[e.jsxs(T,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(O,{level:3,children:"Eingaben"}),e.jsx(Pe,{children:"Opening Balance, Monats-Horizont, Umsaetze, Extras, Dividenden und Monats-Istwerte."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[d?e.jsx(z,{color:"processing",children:"Speichern..."}):null,Y?e.jsx(z,{color:"gold",children:"Ungespeicherte Aenderungen"}):e.jsx(z,{color:"green",children:"Synchron"}),H?e.jsxs(z,{color:"green",children:["Gespeichert: ",new Date(H).toLocaleTimeString("de-DE")]}):null,ie?e.jsx(z,{color:Y?"gold":"blue",children:ie}):null]})})]}),W?e.jsx(oe,{type:"error",showIcon:!0,message:W}):null,r?e.jsx(oe,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(T,{children:[e.jsx(O,{level:5,children:"Basis-Parameter"}),e.jsxs($,{wrap:!0,align:"start",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Opening Balance (EUR)"}),e.jsx("div",{"data-field-key":"inputs.openingBalance",children:e.jsx(M,{value:f,onChange:t=>{ae(Number(c(t)||0))},style:{width:190},mode:"decimal",min:0,step:100})})]}),e.jsxs("div",{children:[e.jsx(R,{children:"Startmonat"}),e.jsx("div",{"data-field-key":"inputs.startMonth",children:e.jsx(I,{type:"month",value:v,onChange:t=>{const a=S(t.target.value,v);se(a),y(n=>Q(n,a,b))},style:{width:170}})})]}),e.jsxs("div",{children:[e.jsx(R,{children:"Horizont (Monate)"}),e.jsx("div",{"data-field-key":"inputs.horizonMonths",children:e.jsx(M,{value:b,onChange:t=>{const a=Math.max(1,Number(c(t)||1));V(a),y(n=>Q(n,v,a))},mode:"int",min:1,max:48,style:{width:160}})})]})]})]}),e.jsxs(T,{children:[e.jsxs($,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(O,{level:5,style:{margin:0},children:"Umsaetze x Payout"}),e.jsxs($,{wrap:!0,children:[e.jsx(E,{onClick:()=>{y(t=>{var o;const a=U(t),n=a.length?a[a.length-1].month:ce(v||P(),Math.max(0,Math.round(b||1)-1)),i=ce(n,1);if(a.some(h=>h.month===i))return a;const u=(o=a.slice().reverse().find(h=>Number.isFinite(h.payoutPct)))==null?void 0:o.payoutPct;return U([...a,{id:A("inc"),month:i,revenueEur:0,payoutPct:Number.isFinite(u)?Number(u):0,source:"manual"}])}),V(t=>Math.max(1,Math.round(Number(t||1)))+1)},children:"Naechsten Monat anhaengen"}),e.jsx(E,{onClick:()=>{y(t=>t.map(a=>{const n=q.get(a.month);return Number.isFinite(n)?{...a,payoutPct:Number(Number(n).toFixed(2))}:a}))},disabled:!xe,children:"Empfehlung fuer alle Monate uebernehmen"})]})]}),e.jsxs(R,{type:"secondary",children:["Die Umsatzzeilen sind strikt auf den Planungszeitraum (",v," + ",b," Monate) synchronisiert."]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Umsatz EUR"}),e.jsx("th",{children:"Payout %"}),e.jsx("th",{children:"Empfohlen %"}),e.jsx("th",{children:"Payout EUR"}),e.jsx("th",{children:"Quelle"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:U(N).map(t=>{const a=q.get(t.month),n=Number.isFinite(a)&&Number.isFinite(t.payoutPct)?Number(t.payoutPct)-Number(a):null,i=Number.isFinite(n)&&Math.abs(Number(n))>=Se,u=Number(le.get(t.month)||0),o=t.source==="forecast"&&(!Number.isFinite(u)||u<=0);return e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx(R,{strong:!0,children:ve(t.month)}),e.jsx("div",{children:e.jsx(R,{type:"secondary",children:t.month})})]}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.incomings.${t.id}.revenueEur`,children:e.jsx(M,{value:t.revenueEur??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:h=>{y(p=>p.map(l=>l.id!==t.id?l:{...l,revenueEur:c(h),source:"manual"}))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.incomings.${t.id}.payoutPct`,children:e.jsx(M,{value:t.payoutPct??void 0,mode:"percent",min:0,max:100,step:.1,style:{width:"100%"},onChange:h=>{y(p=>p.map(l=>l.id===t.id?{...l,payoutPct:c(h)}:l))}})})}),e.jsx("td",{children:Number.isFinite(a)?e.jsxs("div",{children:[e.jsx("div",{children:ue(a,1)}),i?e.jsxs(z,{color:"orange",children:["Delta ",ke(Number(n))]}):null]}):e.jsx(R,{type:"secondary",children:"—"})}),e.jsx("td",{children:ue(me.get(t.month)||0,2)}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{"data-field-key":`inputs.incomings.${t.id}.source`,children:e.jsx(Re,{value:t.source,options:[{value:"manual",label:"Manuell"},{value:"forecast",label:"Forecast"}],onChange:h=>{y(p=>p.map(l=>{if(l.id!==t.id)return l;if(h==="forecast"){const g=Number(le.get(l.month)||0);return{...l,source:"forecast",revenueEur:Number.isFinite(g)?g:l.revenueEur}}return{...l,source:"manual"}}))},style:{width:120}})}),o?e.jsx("div",{children:e.jsx(R,{type:"warning",children:"Kein Forecast-Umsatz vorhanden"})}):null]})}),e.jsx("td",{children:e.jsx(E,{danger:!0,onClick:()=>{y(h=>h.filter(p=>p.id!==t.id))},children:"X"})})]},t.id)})})]})})]}),e.jsxs(T,{children:[e.jsxs($,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(O,{level:5,style:{margin:0},children:"Extras"}),e.jsx(E,{onClick:()=>{k(t=>[...t,{id:A("extra"),date:`${P()}-15`,label:"Extra",amountEur:0}])},children:"Extra"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Datum"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:X.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.date`,children:e.jsx(I,{type:"date",value:t.date,onChange:a=>{k(n=>n.map(i=>i.id===t.id?{...i,date:a.target.value}:i))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.label`,children:e.jsx(I,{value:t.label,onChange:a=>{k(n=>n.map(i=>i.id===t.id?{...i,label:a.target.value}:i))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.amountEur`,children:e.jsx(M,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:a=>{k(n=>n.map(i=>i.id===t.id?{...i,amountEur:c(a)}:i))}})})}),e.jsx("td",{children:e.jsx(E,{danger:!0,onClick:()=>{k(a=>a.filter(n=>n.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(T,{children:[e.jsxs($,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(O,{level:5,style:{margin:0},children:"Dividenden"}),e.jsx(E,{onClick:()=>{B(t=>[...t,{id:A("div"),month:P(),label:"Dividende",amountEur:0}])},children:"Dividende"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:_.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.month`,children:e.jsx(I,{type:"month",value:t.month,onChange:a=>{B(n=>n.map(i=>i.id===t.id?{...i,month:S(a.target.value,t.month)}:i))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.label`,children:e.jsx(I,{value:t.label,onChange:a=>{B(n=>n.map(i=>i.id===t.id?{...i,label:a.target.value}:i))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.amountEur`,children:e.jsx(M,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:a=>{B(n=>n.map(i=>i.id===t.id?{...i,amountEur:c(a)}:i))}})})}),e.jsx("td",{children:e.jsx(E,{danger:!0,onClick:()=>{B(a=>a.filter(n=>n.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(T,{children:[e.jsxs($,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(O,{level:5,style:{margin:0},children:"Monats-Istwerte"}),e.jsx(E,{onClick:()=>{C(t=>[...t,{month:P(),realRevenueEUR:0,realPayoutRatePct:0,realClosingBalanceEUR:0}])},children:"Ist-Monat"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Realer Umsatz EUR"}),e.jsx("th",{children:"Reale Auszahlungsquote %"}),e.jsx("th",{children:"Realer Kontostand EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:F.map((t,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${a}.month`,children:e.jsx(I,{type:"month",value:t.month,onChange:n=>{const i=S(n.target.value,t.month);C(u=>u.map((o,h)=>h===a?{...o,month:i}:o))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${a}.realRevenueEUR`,children:e.jsx(M,{value:t.realRevenueEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:n=>{C(i=>i.map((u,o)=>o===a?{...u,realRevenueEUR:c(n)}:u))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${a}.realPayoutRatePct`,children:e.jsx(M,{value:t.realPayoutRatePct??void 0,mode:"percent",style:{width:"100%"},onChange:n=>{C(i=>i.map((u,o)=>o===a?{...u,realPayoutRatePct:c(n)}:u))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${a}.realClosingBalanceEUR`,children:e.jsx(M,{value:t.realClosingBalanceEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:n=>{C(i=>i.map((u,o)=>o===a?{...u,realClosingBalanceEUR:c(n)}:u))}})})}),e.jsx("td",{children:e.jsx(E,{danger:!0,onClick:()=>{C(n=>n.filter((i,u)=>u!==a))},children:"X"})})]},`${t.month}-${a}`))})]})})]})]})}export{Xe as default};
