import{p as Xe,ai as Cn,J as wn,t as d,k as t,L as Mn,M as b,S as w,Q as B,ae as Je,N as ge,ad as Pe,$ as pe,V as An,a0 as Nn,Y as Dn,Z as In}from"./index-CafJOI4c.js";import{b as rn}from"./abcClassification-Buvc6Got.js";import{p as Fn}from"./forecastCsv-Bg9-7iuH.js";import{D as kt}from"./DataTable-BbeXkwXO.js";import{S as Ct}from"./SkuAliasCell-BX4TmRBm.js";import{b as Vn,s as Kt}from"./categoryOrder-C77cYWrY.js";import{c as Bn,g as En}from"./inventoryProjection-DsXUO31i.js";import{n as dt,c as Ze,a as Te,b as On,f as Pn}from"./months-BTPgK-LH.js";import{b as Tn,n as Un,r as zn,c as Rn,a as $t,s as Ln}from"./orderUtils-BI7ykWKR.js";import{n as Ge,e as sn,g as Ke,a as _n,b as qt,c as Wn,d as Kn,s as Gt,r as $n,f as qn}from"./forecastVersioning-6GimM0f7.js";import{n as Gn,b as Zn,c as Hn,d as Qn,f as Jn,e as Xn,g as Yn,h as er,i as tr,s as nr,j as rr}from"./tableModels-Brso-IxF.js";import{h as sr,g as or,s as ir}from"./uiPrefs-CxTlE9qM.js";import{u as ar,C as Ae}from"./workspace-C4SE8sRD.js";import{T as cr}from"./index-CSVe-8oF.js";import{R as ee}from"./index-DfL2d-Q6.js";import{S as lr}from"./index-nHnV0UFY.js";import{C as Ue}from"./index-B4GyXhgM.js";import{C as Zt}from"./Collapse-C0Uq0UCl.js";import{s as oe}from"./index-DnlK-bRe.js";import"./foSuggestion-DyBAXRuI.js";import"./productCompletenessV2-CiXnF4nC.js";import"./planProducts-CJ3gRTdZ.js";import"./Dropdown-DndRdFIP.js";import"./DownOutlined-BkdjXbmm.js";import"./useBubbleLock-CnVjY5By.js";function It(n){return String(n||"").trim()}function Ye(n){return It(n).toLowerCase()}function ur(n){return/^\d{4}-\d{2}$/.test(String(n||""))}function Ft(n){const r=Xe(n);return Number.isFinite(r)?Number(r):null}function Ht(n){const r={};return Object.entries(n||{}).forEach(([a,l])=>{const u=It(a);if(!u||!l||typeof l!="object")return;const f={};Object.entries(l).forEach(([j,A])=>{!ur(j)||!A||typeof A!="object"||(f[j]=A)}),Object.keys(f).length&&(r[u]=f)}),r}function dr(n){const r=new Map;return(Array.isArray(n)?n:[]).forEach(a=>{const l=It(a==null?void 0:a.sku);if(!l)return;const u=Ft(a==null?void 0:a.avgSellingPriceGrossEUR);!Number.isFinite(u)||Number(u)<=0||(r.set(l,Number(u)),r.set(Ye(l),Number(u)))}),r}function mr(n,r){if(!n)return"C";const a=n.get(r),l=n.get(Ye(r)),u=String((a==null?void 0:a.abcClass)||(l==null?void 0:l.abcClass)||"C").toUpperCase();return u==="A"||u==="B"||u==="C"?u:"C"}function Qt(n){const r=Ft(n==null?void 0:n.units);return Number.isFinite(r)?Number(r):0}function Jt(n,r,a){const l=Ft(n==null?void 0:n.revenueEur);return Number.isFinite(l)?Number(l):Number.isFinite(r)&&Number(r)>0?a*Number(r):0}function fr(n){if(n.abcClass!=="A"&&n.abcClass!=="B")return!1;const r=Math.abs(n.deltaPct)>=20&&Math.abs(n.deltaUnits)>=30,a=Math.abs(n.deltaRevenue)>=1500;return r||a}function hr(n){const r=n.profile||"medium",a=n.comparedAt||new Date().toISOString(),l=Math.max(1,Math.round(Number(n.topN||20))),u=Ht(n.previousImport||{}),f=Ht(n.nextImport||{}),j=dr(n.products||[]),A=new Set([...Object.keys(u),...Object.keys(f)]),N=[];A.forEach(g=>{const U=new Set([...Object.keys(u[g]||{}),...Object.keys(f[g]||{})]),G=mr(n.abcBySku,g);U.forEach(Z=>{var Q,ce;const R=(Q=u[g])==null?void 0:Q[Z],ye=(ce=f[g])==null?void 0:ce[Z];if(!R&&!ye)return;const W=Qt(R),ve=Qt(ye),ie=ve-W,ze=W===0?ve===0?0:100:ie/Math.abs(W)*100,V=j.get(g)??j.get(Ye(g))??null,be=Jt(R,V,W),De=Jt(ye,V,ve),ae=De-be;r==="medium"&&fr({abcClass:G,deltaPct:ze,deltaUnits:ie,deltaRevenue:ae})&&N.push({sku:g,month:Z,abcClass:G,prevUnits:W,nextUnits:ve,deltaUnits:ie,deltaPct:ze,prevRevenue:be,nextRevenue:De,deltaRevenue:ae})})}),N.sort((g,U)=>{const G=Math.abs(U.deltaRevenue)-Math.abs(g.deltaRevenue);if(G!==0)return G;const Z=Math.abs(U.deltaUnits)-Math.abs(g.deltaUnits);if(Z!==0)return Z;const R=Math.abs(U.deltaPct)-Math.abs(g.deltaPct);return R!==0?R:g.sku!==U.sku?g.sku.localeCompare(U.sku):g.month.localeCompare(U.month)});const I=new Set(N.map(g=>Ye(g.sku))),y=new Set(N.filter(g=>g.abcClass==="A"||g.abcClass==="B").map(g=>Ye(g.sku)));return{comparedAt:a,thresholdProfile:r,flaggedSkuCount:I.size,flaggedABCount:y.size,flaggedMonthCount:N.length,topItems:N.slice(0,l)}}const Xt={A:{pct:10,units:50},B:{pct:15,units:80},C:{pct:25,units:120}};function gr(){return new Date().toISOString()}function pr(n){const r=String(n||"").trim().toUpperCase();return r==="A"||r==="B"||r==="C"?r:"C"}function Yt(n){return n==="A"?0:n==="B"?1:2}function ft(n){const r=Xe(n);return Number.isFinite(r)?Number(r):null}function yr(n){const r=ft(n);return Number.isFinite(r)?Math.max(0,Number(r)):null}function wt(n,r){return n===0?r===0?0:100:(r-n)/Math.abs(n)*100}function vr(n,r,a){const l=n.get(String(r||"").trim().toLowerCase())||{},u=l==null?void 0:l[a];if(!u||typeof u!="object")return{units:0,revenue:null};const f=ft(u.units),j=ft(u.revenueEur);return{units:Number.isFinite(f)?Number(f):0,revenue:Number.isFinite(j)?Number(j):null}}function $e(n,r,a){let l=0,u=0,f=!1;return a.forEach(j=>{const A=vr(n,r,j);l+=Number(A.units||0),Number.isFinite(A.revenue)&&(u+=Number(A.revenue||0),f=!0)}),{units:l,revenue:f?u:null}}function en(n){const r=new Map;return Object.entries(n||{}).forEach(([a,l])=>{const u=String(a||"").trim();!u||!l||typeof l!="object"||r.set(u.toLowerCase(),l)}),r}function br(n){const r=["targetDeliveryDate","deliveryDate","etaDate","etaManual","eta","arrivalDate","arrivalDateDe"];for(const a of r){const l=String((n==null?void 0:n[a])||"").trim();if(/^\d{4}-\d{2}-\d{2}$/.test(l))return l}return null}function xr(n,r,a){var j;const l=Number(n.productionLeadTimeDays||0)+Number(n.logisticsLeadTimeDays||0)+Number(n.bufferDays||0);if(Number.isFinite(l)&&l>0)return Math.round(l);const u=Number((r==null?void 0:r.productionLeadTimeDaysDefault)||0)+Number((r==null?void 0:r.transitDays)||0)+Number((a==null?void 0:a.defaultBufferDays)||0);if(Number.isFinite(u)&&u>0)return Math.round(u);const f=Number((a==null?void 0:a.defaultProductionLeadTimeDays)||0)+Number(((j=a==null?void 0:a.transportLeadTimesDays)==null?void 0:j.sea)||0)+Number((a==null?void 0:a.defaultBufferDays)||0);return Number.isFinite(f)&&f>0?Math.round(f):0}function Sr(n){const r=new Map;return(Array.isArray(n.suppliers)?n.suppliers:[]).forEach(a=>{const l=a,u=String(l.id||"").trim();u&&r.set(u,String(l.name||u))}),r}function jr(n){const r=new Map;return(Array.isArray(n.products)?n.products:[]).forEach(a=>{const l=a,u=String(l.sku||"").trim();if(!u)return;const f=ft(l.avgSellingPriceGrossEUR);!Number.isFinite(f)||Number(f)<=0||r.set(u.toLowerCase(),Number(f))}),r}function kr(n){const r=new Map;return(Array.isArray(n.products)?n.products:[]).forEach(a=>{const l=a,u=String(l.sku||"").trim();u&&r.set(u.toLowerCase(),String(l.alias||u))}),r}function Cr(n){const r=structuredClone(n||{}),a=rn(r),l=new Map;return a.bySku.forEach((u,f)=>{const j=String(f||"").trim().toLowerCase();j&&l.set(j,pr(u==null?void 0:u.abcClass))}),l}function wr(n,r){const a=On(r,12),l=Bn({state:n,months:a,products:Array.isArray(n.products)?n.products:[],projectionMode:"units"}),u=new Map;return l.perSkuMonth.forEach((f,j)=>{const A=String(j||"").trim().toLowerCase();if(!A)return;let N=null;a.forEach(I=>{if(N)return;const y=f==null?void 0:f.get(I);if(!y)return;const g=En({projectionMode:"units",endAvailable:y.endAvailable,safetyUnits:y.safetyUnits,doh:y.doh,safetyDays:y.safetyDays});(g==="safety-low"||g==="safety-negative")&&(N=I)}),u.set(A,{hasSafetyRisk:!!N,firstSafetyMonth:N})}),u}function Mr(n){const r=n.abcClass==="A"?0:n.abcClass==="B"?1e3:2e3,a=n.recommendedArrivalMonth?Number(String(n.recommendedArrivalMonth).replace("-","")):999999,l=n.conflictTypes.includes("timing_too_late")?-150:n.conflictTypes.includes("units_too_small")?-90:n.conflictTypes.includes("timing_too_early")?-20:0,u=n.firstSafetyMonth?-40:0;return r+a+l+u}function mt(n){var ae,H,Q,ce,xe,He;const r=dt(n.nowMonth||Ze())||Ze(),a=[r],l=[r,Te(r,1),Te(r,2)],u=[r,Te(r,1),Te(r,2),Te(r,3),Te(r,4),Te(r,5)],f=gr(),j=Ge(((ae=n.fromVersion)==null?void 0:ae.forecastImport)||{}),A=Ge(((H=n.toVersion)==null?void 0:H.forecastImport)||{}),N=en(j),I=en(A),y=structuredClone(n.state||{});(!y.forecast||typeof y.forecast!="object")&&(y.forecast={}),y.forecast.forecastImport=structuredClone(A);const g=Cr(y),U=kr(y),G=jr(y),Z=wr(y,r),R=new Set([...Array.from(N.keys()),...Array.from(I.keys()),...(Array.isArray(y.products)?y.products:[]).map(m=>String((m==null?void 0:m.sku)||"").trim().toLowerCase()).filter(Boolean)]),ye=Array.from(R).map(m=>{const M=g.get(m)||"C",L=Xt[M],O=$e(N,m,a),le=$e(N,m,l),K=$e(N,m,u),te=$e(I,m,a),ue=$e(I,m,l),E=$e(I,m,u),ne=te.units-O.units,P=ue.units-le.units,Ie=E.units-K.units,T=wt(O.units,te.units),Se=wt(le.units,ue.units),J=wt(K.units,E.units),re=G.get(m)??null,Fe=Number.isFinite(O.revenue)&&Number.isFinite(te.revenue)?Number(te.revenue||0)-Number(O.revenue||0):Number.isFinite(re)?ne*Number(re):null,Ve=Number.isFinite(le.revenue)&&Number.isFinite(ue.revenue)?Number(ue.revenue||0)-Number(le.revenue||0):Number.isFinite(re)?P*Number(re):null,X=Number.isFinite(K.revenue)&&Number.isFinite(E.revenue)?Number(E.revenue||0)-Number(K.revenue||0):Number.isFinite(re)?Ie*Number(re):null,de=Z.get(m)||{hasSafetyRisk:!1,firstSafetyMonth:null},se=Math.abs(Se)>L.pct||Math.abs(P)>L.units,me=[];se&&me.push("abc_threshold"),de.hasSafetyRisk&&me.push("safety_risk");const Re=se||de.hasSafetyRisk;return{sku:m.toUpperCase(),alias:U.get(m)||m.toUpperCase(),abcClass:M,delta1Units:ne,delta1Pct:T,delta3Units:P,delta3Pct:Se,delta6Units:Ie,delta6Pct:J,delta1Revenue:Fe,delta3Revenue:Ve,delta6Revenue:X,flagged:Re,reasons:me,firstSafetyMonth:de.firstSafetyMonth}}).sort((m,M)=>{const L=Yt(m.abcClass)-Yt(M.abcClass);if(L!==0)return L;const O=Math.abs(M.delta3Units)-Math.abs(m.delta3Units);return O!==0?O:m.sku.localeCompare(M.sku)}),W=y.settings||{},ve=Array.isArray(y.products)?y.products:[],ie=Sr(y),ze=Tn(y),V=(Array.isArray(y.fos)?y.fos:[]).map(m=>m).filter(m=>{const M=Un(m.status);return M==="ACTIVE"||M==="DRAFT"}).map(m=>{const M=String(m.id||"").trim(),L=String(m.sku||"").trim(),O=L.toLowerCase();if(!M||!O)return null;const le=zn(ve,L),K=g.get(O)||"C",te=Xt[K],ue=xr(m,le,W),E=Rn({context:ze,sku:L,leadTimeDays:ue,product:le,settings:W,horizonMonths:12});if(!E||String(E.status||"")!=="ok")return null;const ne=String(E.requiredArrivalDate||"")||null,P=ne?ne.slice(0,7):null,Ie=String(E.orderDateAdjusted||E.orderDate||"")||null,T=Math.max(0,Math.round(Number(E.recommendedUnits||0))),Se=yr(E.coverageDays),J=Math.max(0,Math.round(Number(m.units||0))),re=String(m.targetDeliveryDate||"")||null,Fe=String(m.etaDate||"")||null,Ve=br(m),X=Ve?Ve.slice(0,7):null,de=Z.get(O)||{hasSafetyRisk:!1,firstSafetyMonth:null},se=de.firstSafetyMonth,me=J-T,Re=T>0?me/T*100:J>0?100:0,Be=Math.abs(Re)>te.pct||Math.abs(me)>te.units,fe=[];if(J<T&&(Be||de.hasSafetyRisk)&&fe.push("units_too_small"),J>T&&Be&&fe.push("units_too_large"),X&&(P&&X>P||se&&X>se)&&fe.push("timing_too_late"),X&&P&&X<P&&J>T&&Be&&fe.push("timing_too_early"),!fe.length)return null;const Qe=Mr({abcClass:K,firstSafetyMonth:se,conflictTypes:fe,recommendedArrivalMonth:P});return{foId:M,sku:L,alias:U.get(O)||L,abcClass:K,supplierName:ie.get(String(m.supplierId||""))||String(m.supplierId||"—"),supplierId:String(m.supplierId||""),conflictTypes:fe,currentUnits:J,currentTargetDeliveryDate:re,currentEtaDate:Fe,firstMonthBelowSafety:se,requiredArrivalDate:ne,requiredArrivalMonth:P,recommendedUnits:T,recommendedOrderDate:Ie,recommendedArrivalDate:ne,recommendedArrivalMonth:P,recommendedCoverageDays:Se,recommendedStatus:String(E.status||""),severityScore:Qe,rawFo:m}}).filter(Boolean);V.sort((m,M)=>m.severityScore!==M.severityScore?m.severityScore-M.severityScore:m.requiredArrivalMonth!==M.requiredArrivalMonth?String(m.requiredArrivalMonth||"").localeCompare(String(M.requiredArrivalMonth||"")):m.foId.localeCompare(M.foId));const be=ye.filter(m=>m.flagged),De={comparedAt:f,fromVersionId:(Q=n.fromVersion)!=null&&Q.id?String(n.fromVersion.id):null,fromVersionName:(ce=n.fromVersion)!=null&&ce.name?String(n.fromVersion.name):null,toVersionId:(xe=n.toVersion)!=null&&xe.id?String(n.toVersion.id):null,toVersionName:(He=n.toVersion)!=null&&He.name?String(n.toVersion.name):null,flaggedSkus:be.length,flaggedAB:be.filter(m=>m.abcClass==="A"||m.abcClass==="B").length,foConflictsTotal:V.length,foConflictsOpen:V.length};return{comparedAt:f,months:{now:r,months1:a,months3:l,months6:u},skuRows:ye,foConflicts:V,summary:De}}const{Paragraph:tn,Text:x,Title:qe}=Mn,nn=[{value:"next6",label:"Nächste 6",count:6},{value:"next12",label:"Nächste 12",count:12},{value:"next18",label:"Nächste 18",count:18},{value:"all",label:"Alle",count:null}];function lt(){return new Date().toISOString()}function Ar(n="id"){return`${n}-${Math.random().toString(36).slice(2,10)}-${Date.now().toString(36)}`}function Ne(n){(!n.forecast||typeof n.forecast!="object")&&(n.forecast={items:[],settings:{useForecast:!1},forecastImport:{},forecastManual:{},versions:[],activeVersionId:null,lastImpactSummary:null,foConflictDecisionsByVersion:{},lastImportAt:null,importSource:null});const r=n.forecast;(!r.settings||typeof r.settings!="object")&&(r.settings={useForecast:!1}),(!r.forecastManual||typeof r.forecastManual!="object")&&(r.forecastManual={}),sn(r)}function _(n,r=0){return Number.isFinite(n)?Number(n).toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"—"}function ut(n,r=0){if(!Number.isFinite(n))return"—";const a=Number(n);return`${a>0?"+":""}${a.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r})}`}function Mt(n){if(!Number.isFinite(n))return"—";const r=Number(n);return`${r>0?"+":""}${r.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`}function Nt(n){if(!n||typeof n!="object")return null;const r=n,a=String(r.comparedAt||"").trim(),l=r.toVersionId==null?null:String(r.toVersionId||"").trim()||null;return!a||!l?null:{comparedAt:a,fromVersionId:r.fromVersionId==null?null:String(r.fromVersionId||"").trim()||null,fromVersionName:r.fromVersionName==null?null:String(r.fromVersionName||""),toVersionId:l,toVersionName:r.toVersionName==null?null:String(r.toVersionName||""),flaggedSkus:Math.max(0,Math.round(Number(r.flaggedSkus||0))),flaggedAB:Math.max(0,Math.round(Number(r.flaggedAB||0))),foConflictsTotal:Math.max(0,Math.round(Number(r.foConflictsTotal||0))),foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function on(n,r){const a=n==null?void 0:n[r];return!a||typeof a!="object"?!1:a.ignored===!0}function Dt(n,r){return n.foConflicts.filter(a=>!on(r,a.foId)).length}function Nr(n){return n==="units_too_small"?"Menge zu klein":n==="units_too_large"?"Menge zu groß":n==="timing_too_late"?"Timing zu spät":n==="timing_too_early"?"Timing zu früh":n}function At(n,r){const a=Nt(r.lastImpactSummary);if(!a)return;const l=Array.isArray(r.versions)?r.versions:[],u=l.find(I=>I.id===a.toVersionId)||null;if(!u){r.lastImpactSummary=null;return}const f=a.fromVersionId&&l.find(I=>I.id===a.fromVersionId)||null,j=mt({state:n,fromVersion:f,toVersion:u,nowMonth:Ze()}),A=r.foConflictDecisionsByVersion&&typeof r.foConflictDecisionsByVersion=="object"?r.foConflictDecisionsByVersion:{},N=A[u.id]&&typeof A[u.id]=="object"?A[u.id]:{};r.lastImpactSummary={...j.summary,foConflictsOpen:Dt(j,N)}}function ns(){const{state:n,loading:r,saving:a,error:l,lastSavedAt:u,saveWith:f}=ar(),j=Cn(),A=wn(),N=sr("forecast"),[I,y]=d.useState("grid"),[g,U]=d.useState(""),[G,Z]=d.useState("next12"),[R,ye]=d.useState("units"),[W,ve]=d.useState(!0),[ie,ze]=d.useState(!1),[V,be]=d.useState({}),[De,ae]=d.useState(!1),[H,Q]=d.useState([]),[ce,xe]=d.useState([]),[He,m]=d.useState(""),[M,L]=d.useState("merge"),[O,le]=d.useState(!0),[K,te]=d.useState(""),[ue,E]=d.useState(""),[ne,P]=d.useState(""),[Ie,T]=d.useState(!1),[Se,J]=d.useState(!1),[re,Fe]=d.useState(!1),[Ve,X]=d.useState(null),[de,se]=d.useState(""),[me,Re]=d.useState(""),[Be,fe]=d.useState(!0),[Qe,an]=d.useState(!1),[cn,ht]=d.useState(!1),[gt,Vt]=d.useState([]),[et,tt]=d.useState(()=>or("forecast")),[Bt,nt]=d.useState([]),pt=n.settings||{},je=n.forecast||{},ln=(je.settings&&typeof je.settings=="object"?je.settings:{}).useForecast===!0,Ee=je.forecastImport||{},ke=n;d.useEffect(()=>{const e=new URLSearchParams(j.search),o=e.get("panel");if(o==="versions"?y("versions"):(o==="impact"||o==="conflicts")&&y("impact"),e.get("source")==="dashboard"){const s=String(e.get("sku")||"").trim();s&&U(s)}},[j.search]),d.useEffect(()=>{be(Gn(je.forecastManual||{})),ae(!1)},[je.forecastManual]);const Le=d.useMemo(()=>Zn(pt),[pt.horizonMonths,pt.startMonth]),_e=d.useMemo(()=>{const e=nn.find(o=>o.value===G);return!e||e.count==null?Le:Le.slice(0,e.count)},[Le,G]),Et=d.useMemo(()=>Hn(ke),[ke]),rt=d.useMemo(()=>Vn(ke),[n.productCategories,ke]),Ce=d.useMemo(()=>Qn(ke,Et),[Et,ke]),un=d.useMemo(()=>{const e=new Map;return(Array.isArray(n.products)?n.products:[]).map(o=>o).forEach(o=>{const s=String(o.sku||"").trim();s&&e.set(s.toLowerCase(),o)}),e},[n.products]),st=d.useMemo(()=>Ce.filter(e=>e.isActive).filter(e=>{const o=Number(e.sellerboardMarginPct);return!(Number.isFinite(o)&&o>0&&o<=100)}),[Ce]),yt=d.useMemo(()=>Jn({products:Ce,search:g,onlyActive:W,onlyWithForecast:ie,visibleMonths:_e,manualDraft:V,forecastImport:Ee}),[Ee,V,W,ie,Ce,g,_e]),he=d.useMemo(()=>{const e=new Map;yt.forEach(s=>{var c;const i=String(s.categoryLabel||"Ohne Kategorie");e.has(i)||e.set(i,[]),(c=e.get(i))==null||c.push(s)});const o=Array.from(e.entries()).map(([s,i])=>({key:s,label:s,rows:i.sort((c,h)=>c.sku.localeCompare(h.sku))}));return Kt(o,rt)},[rt,yt]);d.useEffect(()=>{tt(e=>{if(!he.length)return[];const o=new Set(he.map(i=>i.key)),s=e.filter(i=>o.has(i));return s.length||N?s:he.map(i=>i.key)})},[he,N]),d.useEffect(()=>{ir("forecast",et)},[et]);const vt=d.useMemo(()=>Xn({allMonths:Le,products:Ce,manualDraft:V,forecastImport:Ee}),[Le,Ee,V,Ce]),$=d.useMemo(()=>{const e=structuredClone(je||{});return sn(e),e},[je]),ot=d.useMemo(()=>(Array.isArray($.versions)?$.versions:[]).slice().sort((o,s)=>String(s.createdAt||"").localeCompare(String(o.createdAt||""))),[$.versions]),bt=d.useMemo(()=>new Map(ot.map(e=>[e.id,e])),[ot]),it=d.useMemo(()=>Ke($),[$]),Y=(it==null?void 0:it.id)||null,dn=d.useMemo(()=>_n($),[$]),F=d.useMemo(()=>Nt($.lastImpactSummary),[$.lastImpactSummary]),xt=$.foConflictDecisionsByVersion&&typeof $.foConflictDecisionsByVersion=="object"?$.foConflictDecisionsByVersion:{},Ot=Y&&xt[Y]&&typeof xt[Y]=="object"?xt[Y]:{},Oe=d.useMemo(()=>{if(!(F!=null&&F.toVersionId))return null;const e=bt.get(F.toVersionId)||null;if(!e)return null;const o=F.fromVersionId&&bt.get(F.fromVersionId)||null;return mt({state:ke,fromVersion:o,toVersion:e,nowMonth:Ze()})},[F,n.forecast,n.fos,n.inventory,n.pos,n.products,n.settings,n.suppliers,ke,bt]),St=d.useMemo(()=>{if(!Oe)return[];const e=new Map;return Ce.forEach(o=>{e.set(String(o.sku||"").trim().toLowerCase(),String(o.categoryLabel||"Ohne Kategorie"))}),Oe.skuRows.map(o=>({...o,categoryLabel:e.get(String(o.sku||"").trim().toLowerCase())||"Ohne Kategorie"}))},[Oe,Ce]),Pt=d.useMemo(()=>Be?St.filter(o=>o.flagged):St,[St,Be]),we=d.useMemo(()=>{const e=new Map;Pt.forEach(s=>{var c;const i=String(s.categoryLabel||"Ohne Kategorie");e.has(i)||e.set(i,[]),(c=e.get(i))==null||c.push(s)});const o=Array.from(e.entries()).map(([s,i])=>({key:s,label:s,rows:i}));return Kt(o,rt)},[rt,Pt]);d.useEffect(()=>{nt(e=>{if(!we.length)return[];const o=new Set(we.map(i=>i.key)),s=e.filter(i=>o.has(i));return s.length?s:we.map(i=>i.key)})},[we]);const at=d.useMemo(()=>Oe?Oe.foConflicts.map(e=>({...e,ignored:on(Ot,e.foId)})):[],[Ot,Oe]),We=d.useMemo(()=>at.filter(e=>!e.ignored),[at]),Tt=d.useMemo(()=>Qe?at:We,[at,We,Qe]),Ut=F&&Y&&F.toVersionId===Y?F.foConflictsOpen:0,mn=d.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:300,minWidth:300},cell:({row:s})=>t.jsx(Ct,{alias:s.original.alias||(s.original.isPlan?s.original.plannedSku:s.original.sku),sku:s.original.sku})},{header:"Status",meta:{width:86,minWidth:86},cell:({row:s})=>s.original.isPlan?t.jsx(b,{color:"blue",children:"Plan"}):s.original.isActive?t.jsx(b,{color:"green",children:"Aktiv"}):t.jsx(b,{children:"Inaktiv"})}],o=_e.map(s=>({id:s,header:Pn(s),meta:{width:118,minWidth:118,align:"right"},cell:({row:i})=>{var D;const c=i.original.sku,h=(D=V==null?void 0:V[c])==null?void 0:D[s],p=Yn(Ee,c,s),C=er(V,Ee,c,s,i.original.plannedUnitsByMonth);if(R==="units")return i.original.isPlan?t.jsxs("div",{className:"v2-forecast-cell",children:[t.jsx("div",{children:_(C,0)}),t.jsx(x,{type:"secondary",style:{fontSize:11},children:"Quelle: Plan (Baseline + Saisonalitaet)"})]}):t.jsxs("div",{className:"v2-forecast-cell",children:[t.jsx(cr,{className:"v2-grid-input",value:Number.isFinite(h)?h:null,onChange:S=>{be(k=>{const z={...k},q={...z[c]||{}},Me=typeof S=="number"&&Number.isFinite(S)?S:null;return Me==null?delete q[s]:q[s]=Me,Object.keys(q).length?z[c]=q:delete z[c],z}),ae(!0)},min:0,controls:!1,placeholder:Number.isFinite(C)?String(Math.round(Number(C))):"—",style:{width:"100%"}}),t.jsxs(x,{type:"secondary",style:{fontSize:11},children:["Imp: ",_((p==null?void 0:p.units)??null,0)]})]});const v=tr(R,C,i.original);return t.jsxs("div",{children:[t.jsx("div",{children:_(v,2)}),t.jsxs(x,{type:"secondary",style:{fontSize:11},children:["Units: ",_(C,0)]})]})}}));return[...e,...o]},[Ee,V,R,_e]),fn=d.useMemo(()=>[{header:"Alias",accessorKey:"alias",meta:{width:260,minWidth:260},cell:({row:e})=>t.jsx(Ct,{alias:e.original.alias,sku:e.original.sku})},{header:"ABC",accessorKey:"abcClass",meta:{width:80,minWidth:80,align:"center"},cell:({row:e})=>t.jsx(b,{color:e.original.abcClass==="A"?"red":e.original.abcClass==="B"?"gold":"blue",children:e.original.abcClass})},{header:"Δ 1M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ut(e.original.delta1Units,0)},{header:"Δ 1M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>Mt(e.original.delta1Pct)},{header:"Δ 3M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ut(e.original.delta3Units,0)},{header:"Δ 3M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>Mt(e.original.delta3Pct)},{header:"Δ 6M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ut(e.original.delta6Units,0)},{header:"Δ 6M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>Mt(e.original.delta6Pct)},{header:"Δ Umsatz 3M",meta:{width:130,minWidth:130,align:"right"},cell:({row:e})=>ut(e.original.delta3Revenue,2)},{header:"Flags",meta:{width:170,minWidth:170},cell:({row:e})=>t.jsxs(w,{wrap:!0,children:[e.original.flagged?t.jsx(b,{color:"gold",children:"Review"}):t.jsx(b,{color:"green",children:"OK"}),e.original.reasons.includes("safety_risk")?t.jsx(b,{color:"red",children:"Safety"}):null,e.original.reasons.includes("abc_threshold")?t.jsx(b,{color:"blue",children:"Δ3M"}):null]})}],[]);function jt(){Q([]),xe([]),m(""),te(""),E(""),P(""),T(!1)}function hn(e){const o=M==="overwrite"?{}:structuredClone(Ge(e||{}));return H.forEach(s=>{const i=String(s.sku||"").trim();if(!i)return;const c=dt(s.month);if(!c)return;const h=un.get(i.toLowerCase())||null;h&&(O&&!rr(h)||((!o[i]||typeof o[i]!="object")&&(o[i]={}),o[i][c]={units:s.units,revenueEur:s.revenueEur,profitEur:s.profitEur}))}),Ge(o)}async function gn(){await f(e=>{const o=pe(e),s=o;Ne(s);const i=s.forecast;return i.forecastManual=nr(V),o},"v2:forecast:manual-save"),ae(!1)}async function pn(e){m(""),xe([]);try{const o=await e.text(),s=Fn(o);if(s.error){Q([]),m(s.error),xe(s.warnings||[]),T(!1);return}const i=(s.records||[]).map(c=>({sku:String(c.sku||"").trim(),month:dt(c.month)||String(c.month||""),units:Xe(c.units),revenueEur:Xe(c.revenueEur),profitEur:Xe(c.profitEur)})).filter(c=>c.sku&&dt(c.month));if(!i.length){Q([]),m("Keine gültigen Forecast-Zeilen erkannt."),xe(s.warnings||[]),T(!1);return}Q(i),xe(s.warnings||[]),te(e.name),E(qt(new Date)),P(""),T(!0)}catch(o){m(o instanceof Error?o.message:"Datei konnte nicht gelesen werden."),Q([]),T(!1)}}async function zt(e){if(H.length){J(!0);try{const o=lt(),s=K||"VentoryOne CSV",i=String(ue||"").trim()||qt(new Date(o)),c=String(ne||"").trim()||null,h=it||null,p=hn((h==null?void 0:h.forecastImport)||{});if(!Object.keys(p).length)throw new Error("Keine gültigen Zeilen für den aktuellen Import-Filter.");const C=Wn({name:i,note:c,createdAt:o,sourceLabel:s,importMode:M,onlyActiveSkus:O,forecastImport:p});await f(v=>{const D=pe(v),S=D;Ne(S);const k=S.forecast,z=Ke(k),q=Kn(k,C);if(k.lastImportAt=o,k.importSource=s,k.importCadence="monthly",k.lastDriftSummary=hr({previousImport:Ge((z==null?void 0:z.forecastImport)||{}),nextImport:Ge(q.forecastImport||{}),products:Array.isArray(S.products)?S.products:[],abcBySku:rn(S).bySku,comparedAt:o,profile:"medium"}),e==="activate"){const Me=Gt(k,q.id,{touchImportMeta:!0});if(!Me.ok)throw new Error(Me.reason||"Baseline konnte nicht aktiviert werden.");const ct=mt({state:S,fromVersion:z,toVersion:Me.version||q,nowMonth:Ze()}),kn=(k.foConflictDecisionsByVersion&&typeof k.foConflictDecisionsByVersion=="object"?k.foConflictDecisionsByVersion:{})[q.id]||{};k.lastImpactSummary={...ct.summary,foConflictsOpen:Dt(ct,kn)}}return D},e==="activate"?"v2:forecast:import:activate":"v2:forecast:import:save"),e==="activate"?(y("impact"),oe.success("Version gespeichert und als aktive Baseline gesetzt.")):oe.success("Version gespeichert. Baseline bleibt unverändert."),jt()}catch(o){oe.error(o instanceof Error?o.message:"Import konnte nicht gespeichert werden.")}finally{J(!1)}}}async function yn(){gt.length&&(await f(e=>{var C;const o=pe(e),s=o,i=Array.isArray(s.incomings)?[...s.incomings]:[],c=v=>{const D=An(v);return Number.isFinite(D)?Nn(Number(D),In,Dn):50},h=(C=i.slice().reverse().find(v=>String(v.payoutPct||"").trim()))==null?void 0:C.payoutPct,p=c(h);return gt.forEach(v=>{const D=Number(vt.get(v)||0),S=i.findIndex(k=>String(k.month||"")===v);if(S>=0){const k=c(i[S].payoutPct);i[S]={...i[S],month:v,revenueEur:D,payoutPct:k||p,source:"forecast"};return}i.push({month:v,revenueEur:D,payoutPct:p,source:"forecast",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null})}),i.sort((v,D)=>String(v.month||"").localeCompare(String(D.month||""))),s.incomings=i,o},"v2:forecast:transfer-revenue"),ht(!1))}function vn(e){X(e.id),se(e.name||""),Re(e.note||""),Fe(!0)}async function bn(){if(Ve)try{await f(e=>{const o=pe(e),s=o;Ne(s);const i=s.forecast;if(!$n(i,Ve,{name:de,note:me}))throw new Error("Version nicht gefunden.");return o},"v2:forecast:version:rename"),Fe(!1),X(null),oe.success("Version aktualisiert.")}catch(e){oe.error(e instanceof Error?e.message:"Version konnte nicht gespeichert werden.")}}function xn(e){!(e!=null&&e.id)||e.id===Y||Pe.confirm({title:"Aktive Baseline wechseln?",content:`Neue Baseline: ${e.name}`,okText:"Baseline wechseln",cancelText:"Abbrechen",onOk:async()=>{await f(o=>{const s=pe(o),i=s;Ne(i);const c=i.forecast,h=Ke(c),p=Gt(c,e.id,{touchImportMeta:!0});if(!p.ok)throw new Error(p.reason||"Baseline konnte nicht gesetzt werden.");const C=p.version||Ke(c);if(!C)throw new Error("Aktive Baseline fehlt.");const v=mt({state:i,fromVersion:h,toVersion:C,nowMonth:Ze()}),S=(c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"?c.foConflictDecisionsByVersion:{})[C.id]||{};return c.lastImpactSummary={...v.summary,foConflictsOpen:Dt(v,S)},s},"v2:forecast:version:activate"),y("impact"),oe.success("Baseline gewechselt. Impact-Analyse wurde aktualisiert.")}})}function Sn(e){e!=null&&e.id&&Pe.confirm({title:"Version löschen?",content:`Die Version "${e.name}" wird dauerhaft gelöscht.`,okText:"Version löschen",okType:"danger",cancelText:"Abbrechen",onOk:async()=>{await f(o=>{const s=pe(o),i=s;Ne(i);const c=i.forecast,h=qn(c,e.id);if(!h.ok)throw h.reason==="ACTIVE_VERSION"?new Error("Aktive Baseline kann nicht gelöscht werden. Bitte zuerst Baseline wechseln."):new Error("Version konnte nicht gelöscht werden.");if(c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"){const C={...c.foConflictDecisionsByVersion};delete C[e.id],c.foConflictDecisionsByVersion=C}const p=Nt(c.lastImpactSummary);return p&&(p.toVersionId===e.id||p.fromVersionId===e.id)&&(c.lastImpactSummary=null),s},"v2:forecast:version:delete"),oe.success("Version gelöscht.")}})}function Rt(e,o,s){if(!o)return;const i=e.foConflictDecisionsByVersion&&typeof e.foConflictDecisionsByVersion=="object"?{...e.foConflictDecisionsByVersion}:{},c={...i[o]||{}};delete c[s],i[o]=c,e.foConflictDecisionsByVersion=i}function Lt(e){e.ignored||Pe.confirm({title:`FO ${e.foId} aktualisieren?`,content:t.jsxs(w,{direction:"vertical",size:4,children:[t.jsxs(x,{children:["Aktuell: ",_(e.currentUnits,0)," Units · Target ",e.currentTargetDeliveryDate||"—"]}),t.jsxs(x,{children:["Neu: ",_(e.recommendedUnits,0)," Units · Arrival ",e.recommendedArrivalDate||"—"]})]}),okText:"FO aktualisieren",cancelText:"Abbrechen",onOk:async()=>{await f(o=>{const s=pe(o),i=s;Ne(i);const c=i.forecast,h=Ke(c),p=Array.isArray(s.fos)?[...s.fos]:[],C=p.findIndex(z=>String(z.id||"")===e.foId);if(C<0)throw new Error("FO nicht gefunden.");const v=p[C],D=e.recommendedArrivalDate||e.requiredArrivalDate||String(v.targetDeliveryDate||"")||null,S=$t({targetDeliveryDate:D,productionLeadTimeDays:v.productionLeadTimeDays,logisticsLeadTimeDays:v.logisticsLeadTimeDays,bufferDays:v.bufferDays}),k=lt();return p[C]={...v,units:Math.max(0,Math.round(Number(e.recommendedUnits||0))),targetDeliveryDate:D,orderDate:S.orderDate,productionEndDate:S.productionEndDate,etdDate:S.etdDate,etaDate:S.etaDate,deliveryDate:S.deliveryDate,forecastBasisVersionId:(h==null?void 0:h.id)||null,forecastBasisVersionName:(h==null?void 0:h.name)||null,forecastBasisSetAt:k,forecastConflictState:"reviewed_updated",supersededByFoId:null,updatedAt:k},s.fos=p,Rt(c,(h==null?void 0:h.id)||null,e.foId),At(i,c),s},"v2:forecast:conflict:update"),oe.success(`FO ${e.foId} wurde aktualisiert.`)}})}function _t(e){e.ignored||Pe.confirm({title:`Draft-FO für ${e.foId} erzeugen?`,content:t.jsxs(w,{direction:"vertical",size:4,children:[t.jsxs(x,{children:["Neue Draft-FO: ",_(e.recommendedUnits,0)," Units · Arrival ",e.recommendedArrivalDate||"—"]}),t.jsx(x,{children:"Bestehende FO bleibt erhalten und wird als superseded markiert."})]}),okText:"Draft erzeugen",cancelText:"Abbrechen",onOk:async()=>{await f(o=>{const s=pe(o),i=s;Ne(i);const c=i.forecast,h=Ke(c),p=Array.isArray(s.fos)?[...s.fos]:[],C=p.findIndex(ct=>String(ct.id||"")===e.foId);if(C<0)throw new Error("FO nicht gefunden.");const v=p[C],D=e.recommendedArrivalDate||e.requiredArrivalDate||String(v.targetDeliveryDate||"")||null,S=$t({targetDeliveryDate:D,productionLeadTimeDays:v.productionLeadTimeDays,logisticsLeadTimeDays:v.logisticsLeadTimeDays,bufferDays:v.bufferDays}),k=lt(),z=Ar("fo"),q=Ln(p,k),Me={...v,id:z,foNo:q.foNo,foNumber:q.foNumber,status:"DRAFT",units:Math.max(0,Math.round(Number(e.recommendedUnits||0))),targetDeliveryDate:D,orderDate:S.orderDate,productionEndDate:S.productionEndDate,etdDate:S.etdDate,etaDate:S.etaDate,deliveryDate:S.deliveryDate,convertedPoId:null,convertedPoNo:null,forecastBasisVersionId:(h==null?void 0:h.id)||null,forecastBasisVersionName:(h==null?void 0:h.name)||null,forecastBasisSetAt:k,forecastConflictState:"review_needed",supersedesFoId:String(v.id||e.foId),supersededByFoId:null,createdAt:k,updatedAt:k};return p[C]={...v,forecastConflictState:"superseded",supersededByFoId:z,updatedAt:k},p.push(Me),s.fos=p,Rt(c,(h==null?void 0:h.id)||null,e.foId),At(i,c),s},"v2:forecast:conflict:draft"),oe.success(`Neue Draft-FO zu ${e.foId} erstellt.`)}})}async function Wt(e){e.ignored||!Y||(await f(o=>{const s=pe(o),i=s;Ne(i);const c=i.forecast,h=c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"?{...c.foConflictDecisionsByVersion}:{},p={...h[Y]||{}};return p[e.foId]={ignored:!0,ignoredAt:lt(),reason:"manual_ignore"},h[Y]=p,c.foConflictDecisionsByVersion=h,At(i,c),s},"v2:forecast:conflict:ignore"),oe.success(`FO ${e.foId} für diese Forecast-Version ignoriert.`))}const jn=d.useMemo(()=>[{header:"FO",meta:{width:90,minWidth:90},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsx(x,{strong:!0,children:String(e.original.foId||"").slice(-6).toUpperCase()}),e.original.ignored?t.jsx(b,{color:"default",children:"Ignoriert"}):t.jsx(b,{color:"gold",children:"To Review"})]})},{header:"Produkt",meta:{width:220,minWidth:220},cell:({row:e})=>t.jsx(Ct,{alias:e.original.alias,sku:e.original.sku})},{header:"Supplier",accessorKey:"supplierName",meta:{width:170,minWidth:170}},{header:"Aktuelle FO",meta:{width:190,minWidth:190},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(x,{children:[_(e.original.currentUnits,0)," Units"]}),t.jsxs(x,{type:"secondary",children:["Target: ",e.original.currentTargetDeliveryDate||"—"]}),t.jsxs(x,{type:"secondary",children:["ETA: ",e.original.currentEtaDate||"—"]})]})},{header:"Neuer Forecast",meta:{width:190,minWidth:190},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(x,{children:["Safety-Bruch: ",e.original.firstMonthBelowSafety||"—"]}),t.jsxs(x,{type:"secondary",children:["Required Arrival: ",e.original.requiredArrivalDate||"—"]})]})},{header:"Empfehlung",meta:{width:210,minWidth:210},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(x,{children:[_(e.original.recommendedUnits,0)," Units"]}),t.jsxs(x,{type:"secondary",children:["Order: ",e.original.recommendedOrderDate||"—"]}),t.jsxs(x,{type:"secondary",children:["Arrival: ",e.original.recommendedArrivalDate||"—"]})]})},{header:"Konflikte",meta:{width:220,minWidth:220},cell:({row:e})=>t.jsx(w,{wrap:!0,children:e.original.conflictTypes.map(o=>t.jsx(b,{color:o.includes("late")||o.includes("small")?"red":"orange",children:Nr(o)},`${e.original.foId}-${o}`))})},{header:"Aktionen",meta:{width:310,minWidth:310},cell:({row:e})=>t.jsxs("div",{className:"v2-actions-nowrap",children:[t.jsx(B,{size:"small",disabled:e.original.ignored,onClick:()=>Lt(e.original),children:"FO aktualisieren"}),t.jsx(B,{size:"small",disabled:e.original.ignored,onClick:()=>_t(e.original),children:"Als Draft neu erzeugen"}),t.jsx(B,{size:"small",disabled:e.original.ignored,onClick:()=>{Wt(e.original)},children:"Ignorieren"})]})}],[Wt,_t,Lt]);return t.jsxs("div",{className:"v2-page",children:[t.jsxs(Ae,{className:"v2-intro-card",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsx(qe,{level:3,children:"Forecast"}),t.jsx(tn,{children:"Versionierte VentoryOne-Imports mit aktiver Baseline, Impact-Analyse und FO-Konflikt-Workflow."})]}),t.jsxs(w,{wrap:!0,children:[t.jsxs(b,{color:"blue",children:["Baseline Forecast: ",dn]}),Ut>0?t.jsxs(b,{color:"gold",children:["Forecast-Änderung: ",Ut," FOs prüfen"]}):null]})]}),t.jsxs("div",{className:"v2-toolbar",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(ee.Group,{value:I,onChange:e=>y(e.target.value),children:[t.jsx(ee.Button,{value:"grid",children:"Forecast Grid"}),t.jsx(ee.Button,{value:"versions",children:"Versionen"}),t.jsx(ee.Button,{value:"impact",children:"Impact & FO-Konflikte"})]}),t.jsxs(w,{wrap:!0,children:[t.jsxs(x,{children:["Forecast wird im Cashflow genutzt: ",t.jsx("strong",{children:ln?"Ja":"Nein"})]}),t.jsx(B,{size:"small",onClick:()=>A("/v2/methodik"),children:"In Methodik & Regeln ändern"})]})]}),I==="grid"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(Je,{value:g,onChange:e=>U(e.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),t.jsx(lr,{value:G,onChange:e=>Z(e),options:nn.map(e=>({value:e.value,label:e.label})),style:{width:140,maxWidth:"100%"}}),t.jsxs(ee.Group,{value:R,onChange:e=>ye(e.target.value),children:[t.jsx(ee.Button,{value:"units",children:"Units"}),t.jsx(ee.Button,{value:"revenue",children:"Umsatz"}),t.jsx(ee.Button,{value:"profit",children:"Gewinn"})]}),t.jsx(Ue,{checked:W,onChange:e=>ve(e.target.checked),children:"Nur aktive Produkte"}),t.jsx(Ue,{checked:ie,onChange:e=>ze(e.target.checked),children:"Nur mit Forecast"})]}),t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(B,{type:"primary",onClick:()=>{gn()},disabled:!De,loading:a,children:"Manuelle Änderungen speichern"}),t.jsx(B,{onClick:()=>{const e=_e.filter(o=>Number(vt.get(o)||0)>0);Vt(e),ht(!0)},children:"Umsatz übertragen"}),De?t.jsx(b,{color:"orange",children:"Ungespeicherte Änderungen"}):t.jsx(b,{color:"green",children:"Synchron"}),u?t.jsxs(b,{color:"green",children:["Gespeichert: ",new Date(u).toLocaleTimeString("de-DE")]}):null]})]}):null]})]}),l?t.jsx(ge,{type:"error",showIcon:!0,message:l}):null,r?t.jsx(ge,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,st.length?t.jsx(ge,{type:"warning",showIcon:!0,message:`Brutto-Marge fehlt für ${st.length} aktive Forecast-Produkt(e). Gewinn-Ansicht ist dadurch unvollständig.`,description:t.jsxs(w,{wrap:!0,children:[t.jsxs(x,{type:"secondary",children:["Beispiele: ",st.slice(0,5).map(e=>e.sku).join(", "),st.length>5?" ...":""]}),t.jsx(B,{size:"small",onClick:()=>{window.location.hash="/v2/products?issues=revenue&expand=all"},children:"Produkte öffnen"}),t.jsx(B,{size:"small",onClick:()=>{window.location.hash="/v2/plan-products"},children:"Neue Produkte öffnen"})]})}):null,t.jsxs(Ae,{children:[t.jsx(qe,{level:4,children:"VentoryOne CSV Import"}),t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var s;const o=(s=e.target.files)==null?void 0:s[0];o&&pn(o)}}),t.jsxs(w,{wrap:!0,children:[t.jsxs(ee.Group,{value:M,onChange:e=>L(e.target.value),children:[t.jsx(ee.Button,{value:"merge",children:"Merge"}),t.jsx(ee.Button,{value:"overwrite",children:"Overwrite"})]}),t.jsx(Ue,{checked:O,onChange:e=>le(e.target.checked),children:"Nur aktive SKUs importieren"}),K?t.jsx(b,{children:K}):null,H.length?t.jsxs(b,{color:"blue",children:[H.length," Zeilen geladen"]}):null,Ie?t.jsx(b,{color:"gold",children:"Importkandidat bereit"}):null]}),He?t.jsx(ge,{type:"error",showIcon:!0,message:He}):null,ce.length?t.jsx(ge,{type:"warning",showIcon:!0,message:`${ce.length} Warnung(en) beim Import`,description:ce.slice(0,5).join(" | ")}):null,t.jsx(x,{type:"secondary",children:"`Merge` startet aus aktiver Baseline und überlagert importierte Zellen. `Overwrite` erstellt eine Version nur aus den Importdaten."})]})]}),I==="grid"?t.jsxs(Ae,{children:[t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(x,{type:"secondary",children:[yt.length," Produkte in ",he.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(B,{size:"small",onClick:()=>tt(he.map(e=>e.key)),disabled:!he.length,children:"Alles auf"}),t.jsx(B,{size:"small",onClick:()=>tt([]),disabled:!et.length,children:"Alles zu"})]})]}),he.length?t.jsx(Zt,{className:"v2-category-collapse",activeKey:et,onChange:e=>tt((Array.isArray(e)?e:[e]).map(String)),items:he.map(e=>({key:e.key,label:t.jsxs(w,{children:[t.jsx(x,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(kt,{className:"v2-products-grid-wrap",data:e.rows,columns:mn,minTableWidth:Math.max(920,400+_e.length*118),tableLayout:"fixed"})})}))}):t.jsx(x,{type:"secondary",children:"Keine Forecast-Zeilen für den aktuellen Filter."})]}):null,I==="versions"?t.jsxs(Ae,{children:[t.jsx(qe,{level:4,children:"Forecast-Versionen"}),ot.length?t.jsx(w,{direction:"vertical",style:{width:"100%"},children:ot.map(e=>{var s,i,c;const o=e.id===Y;return t.jsx(Ae,{size:"small",children:t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsxs(w,{wrap:!0,children:[t.jsx(x,{strong:!0,children:e.name}),o?t.jsx(b,{color:"blue",children:"Aktive Baseline"}):null,t.jsx(b,{children:new Date(e.createdAt).toLocaleString("de-DE")}),e.sourceLabel?t.jsx(b,{children:e.sourceLabel}):null,e.importMode?t.jsx(b,{children:e.importMode}):null]}),t.jsx("div",{children:t.jsxs(x,{type:"secondary",children:["Rows: ",_(((s=e.stats)==null?void 0:s.rowCount)??0,0)," · SKUs: ",_(((i=e.stats)==null?void 0:i.skuCount)??0,0)," · Monate: ",_(((c=e.stats)==null?void 0:c.monthCount)??0,0)]})}),e.note?t.jsx(tn,{type:"secondary",style:{marginBottom:0},children:e.note}):null]}),t.jsxs(w,{wrap:!0,children:[t.jsx(B,{size:"small",onClick:()=>vn(e),children:"Umbenennen / Notiz"}),t.jsx(B,{size:"small",type:o?"default":"primary",disabled:o,onClick:()=>xn(e),children:"Als Baseline aktiv setzen"}),t.jsx(B,{size:"small",danger:!0,disabled:o,onClick:()=>Sn(e),children:"Löschen"})]})]})},e.id)})}):t.jsx(ge,{type:"info",showIcon:!0,message:"Noch keine Forecast-Versionen vorhanden."})]}):null,I==="impact"?t.jsxs(Ae,{children:[t.jsx(qe,{level:4,children:"Impact & FO-Konflikte"}),!F||!Oe?t.jsx(ge,{type:"info",showIcon:!0,message:"Noch keine Impact-Analyse vorhanden.",description:"Die Analyse wird erzeugt, sobald eine Forecast-Version als Baseline aktiviert wird."}):t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsxs(w,{wrap:!0,children:[t.jsxs(b,{color:"blue",children:["Von: ",F.fromVersionName||"—"]}),t.jsxs(b,{color:"blue",children:["Nach: ",F.toVersionName||"—"]}),t.jsxs(b,{children:["Verglichen: ",new Date(F.comparedAt).toLocaleString("de-DE")]}),t.jsxs(b,{color:F.flaggedSkus>0?"gold":"green",children:["Flagged SKUs: ",F.flaggedSkus]}),t.jsxs(b,{color:F.flaggedAB>0?"gold":"green",children:["Flagged A/B: ",F.flaggedAB]}),t.jsxs(b,{color:We.length>0?"red":"green",children:["FO offen: ",We.length]}),t.jsxs(b,{children:["FO total: ",F.foConflictsTotal]})]}),We.length>0?t.jsx(ge,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${We.length} FOs prüfen`}):t.jsx(ge,{type:"success",showIcon:!0,message:"Keine offenen FO-Konflikte."}),t.jsxs(Ae,{size:"small",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsx(qe,{level:5,style:{marginBottom:0},children:"SKU-Abweichungen"}),t.jsxs(w,{wrap:!0,children:[t.jsx(Ue,{checked:Be,onChange:e=>fe(e.target.checked),children:"Nur flagged anzeigen"}),t.jsx(B,{size:"small",onClick:()=>nt(we.map(e=>e.key)),disabled:!we.length,children:"Alles auf"}),t.jsx(B,{size:"small",onClick:()=>nt([]),disabled:!Bt.length,children:"Alles zu"})]})]}),we.length?t.jsx(Zt,{className:"v2-category-collapse",activeKey:Bt,onChange:e=>nt((Array.isArray(e)?e:[e]).map(String)),items:we.map(e=>({key:e.key,label:t.jsxs(w,{children:[t.jsx(x,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," SKUs"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(kt,{className:"v2-products-grid-wrap",data:e.rows,columns:fn,minTableWidth:1460,tableLayout:"fixed"})})}))}):t.jsx(x,{type:"secondary",children:"Keine SKU-Abweichungen für den aktuellen Filter."})]}),t.jsxs(Ae,{size:"small",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsx(qe,{level:5,style:{marginBottom:0},children:"FO-Konflikte"}),t.jsx(Ue,{checked:Qe,onChange:e=>an(e.target.checked),children:"Ignorierte anzeigen"})]}),Tt.length?t.jsx(kt,{data:Tt,columns:jn,minTableWidth:1800,tableLayout:"fixed"}):t.jsx(x,{type:"secondary",children:"Keine Konflikte im aktuellen Filter."})]})]})]}):null,t.jsx(Pe,{title:"Import erfolgreich",open:Ie,onCancel:()=>{jt()},footer:[t.jsx(B,{onClick:()=>jt(),disabled:Se,children:"Abbrechen (verwerfen)"},"cancel"),t.jsx(B,{onClick:()=>{zt("save")},loading:Se,disabled:!H.length,children:"Nur speichern"},"save"),t.jsx(B,{type:"primary",onClick:()=>{zt("activate")},loading:Se,disabled:!H.length,children:"Als Baseline aktiv setzen"},"activate")],children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsxs(x,{children:[H.length," Forecast-Zeilen erkannt."]}),t.jsx(Je,{value:ue,onChange:e=>E(e.target.value),placeholder:"Versionsname"}),t.jsx(Je.TextArea,{value:ne,onChange:e=>P(e.target.value),placeholder:"Optionale Notiz",rows:3}),t.jsx(x,{type:"secondary",children:"Abbrechen verwirft den aktuellen Importkandidaten (es wird keine Version gespeichert)."})]})}),t.jsx(Pe,{title:"Version bearbeiten",open:re,onCancel:()=>{Fe(!1),X(null)},onOk:()=>{bn()},okText:"Speichern",children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx(Je,{value:de,onChange:e=>se(e.target.value),placeholder:"Versionsname"}),t.jsx(Je.TextArea,{value:me,onChange:e=>Re(e.target.value),rows:3,placeholder:"Optionale Notiz"})]})}),t.jsx(Pe,{title:"Umsatz in Cash-in Setup übertragen",open:cn,onCancel:()=>ht(!1),onOk:()=>{yn()},children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx(x,{type:"secondary",children:"Monate auswählen, deren Forecast-Umsatz in `incomings` übernommen wird."}),t.jsx(Ue.Group,{value:gt,onChange:e=>Vt(e),style:{width:"100%"},children:t.jsx(w,{direction:"vertical",style:{width:"100%"},children:Le.map(e=>t.jsxs(Ue,{value:e,children:[e," · ",_(vt.get(e)||0,2)," €"]},e))})})]})})]})}export{ns as default};
