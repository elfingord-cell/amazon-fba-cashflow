import{k as Oe,T as On,g as Mn,m as Fn,u as sn,h as xt,p as f,n as Bn,f as an,q as Kn,t as W,w as z,x as rn,y as Gn,z as $n,A as qn}from"./index-CAzQztwo.js";import{l as Lt,a as st,g as Vn,s as ln,b as at}from"./store-BzgQ-F5B.js";import{b as zn}from"./supplierLabels-BolgyxWX.js";import{c as on}from"./costing-CmZrILJ2.js";import{e as rt}from"./productCompleteness-CNODPsSo.js";import{u as cn}from"./useDraftForm-cLNRxzoZ.js";import{b as Wn}from"./abcClassification-D8Ca84qt.js";import{F as jn}from"./Table-v8LS_Cg4.js";import"./deepEqual-CGWqzo0t.js";import"./index-C15xyCf_.js";import"./index-5SR9pC2K.js";import"./useBubbleLock-Cjjrx1CM.js";import"./Dropdown-CZlZd-6U.js";import"./index-BZ5evjDG.js";import"./Pagination-B0SkKhC9.js";function Pt({title:r,children:p,placement:F="topLeft"}){return r?Oe.jsx(On,{title:r,placement:F,mouseEnterDelay:.15,children:p}):p}function Hn(r){if(r==null||r==="")return"—";const p=typeof r=="string"||typeof r=="number"?String(r):r;return typeof p!="string"?p:Oe.jsx(Pt,{title:p,children:Oe.jsx("span",{className:"app-table-ellipsis",children:p})})}function Xn({columns:r,dataSource:p,rowKey:F="id",stickyFirstColumn:P=!1,scrollY:D,className:T,...C}){const ie=(r||[]).map((G,me)=>{const $={...G};if(G.tooltip){const xe=G.title??G.label??"";$.title=Oe.jsx(Pt,{title:G.tooltip,children:Oe.jsx("span",{children:xe})})}if(G.numeric&&!$.align&&($.align="right"),P&&me===0&&!$.fixed&&($.fixed="left"),G.ellipsis!==!1){const xe=G.render;$.ellipsis={showTitle:!1},$.render=(it,Ne,je)=>{const Rt=xe?xe(it,Ne,je):it;return Hn(Rt)}}return $}),oe={x:"max-content",...D?{y:D}:{}};return Oe.jsx(jn,{className:T,size:"middle",pagination:!1,sticky:!0,rowKey:F,columns:ie,dataSource:p||[],scroll:oe,...C})}function ze(r,p=document){return p.querySelector(r)}function e(r,p={},F=[]){const P=document.createElement(r);Object.entries(p).forEach(([D,T])=>{D==="class"?P.className=T:D.startsWith("on")&&typeof T=="function"?P.addEventListener(D.slice(2),T):D==="dataset"&&T&&typeof T=="object"?Object.entries(T).forEach(([C,ie])=>P.dataset[C]=ie):T!=null&&P.setAttribute(D,T)});for(const D of Array.isArray(F)?F:[F])D!=null&&P.append(D.nodeType?D:document.createTextNode(String(D)));return P}function fn(r){if(!r)return"—";const[p,F,P]=r.split("-").map(Number);if(!p||!F||!P)return"—";const D=new Date(Date.UTC(p,F-1,P));return Number.isNaN(D.getTime())?"—":D.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function gn(r){const p=f(r);return p==null?"—":p.toLocaleString("de-DE",{style:"currency",currency:"USD"})}function Zn(r){const p=f(r);return p==null?"—":p.toLocaleString("de-DE",{style:"currency",currency:"EUR"})}const Dt=["A","B","C"],Jn={A:0,B:1,C:2};function Ut(r){const p=String(r||"").trim().toUpperCase();return Dt.includes(p)?p:null}function lt(r){return Ut(r)||"—"}function un(r){const p=Ut(r);return p?Jn[p]:Dt.length}function M(r,p=2){return z(r,p,{emptyValue:"",useGrouping:!1})}function dn(r){if(!r.length)return"";const F=r.map(P=>P.field).map(P=>{switch(P){case"alias":return"Alias";case"currency":return"Currency";case"unitPrice":return"Unit Price";case"avgSellingPriceGrossEUR":return"Ø VK-Preis";case"sellerboardMarginPct":return"Sellerboard Marge";case"ddp":return"DDP";default:return P}});return`Fehlt: ${[...new Set(F)].join(", ")}`}function _e(r){let p=document.getElementById("products-toast");p||(p=document.createElement("div"),p.id="products-toast",p.className="po-toast",document.body.appendChild(p)),p.textContent=r,p.hidden=!1,setTimeout(()=>{p.hidden=!0},2e3)}function pn({title:r,content:p,actions:F=[],onClose:P}){const D=e("div",{class:"po-modal-backdrop"}),T=e("div",{class:"po-modal product-modal-frame"}),C=e("div",{class:"po-modal-header"},[e("h3",{},[r]),e("button",{type:"button",class:"btn tertiary",onclick:()=>{if(typeof P=="function"){P();return}document.body.removeChild(D),document.removeEventListener("keydown",me)},"aria-label":"Schließen"},["✕"])]),ie=e("div",{class:"po-modal-body"},[p]),oe=e("div",{class:"po-modal-actions"});F.forEach($=>oe.append($)),T.append(C,ie,oe),D.append(T);let G=!1;D.addEventListener("mousedown",$=>{G=$.target===D}),D.addEventListener("mouseup",$=>{G&&$.target===D&&(typeof P=="function"?P():(document.body.removeChild(D),document.removeEventListener("keydown",me))),G=!1});function me($){if($.key==="Escape"){if(typeof P=="function"){P();return}document.body.removeChild(D),document.removeEventListener("keydown",me)}}return document.addEventListener("keydown",me),document.body.append(D),{overlay:D,modal:T,body:ie,footer:oe}}function mn(r,p){const F=(r.pos||[]).filter(C=>((C==null?void 0:C.sku)||"").trim().toLowerCase()===String(p||"").trim().toLowerCase()).sort((C,ie)=>(ie.orderDate||"").localeCompare(C.orderDate||"")).slice(0,10);if(!F.length)return e("p",{class:"empty-state"},["Keine Bestellhistorie verfügbar."]);const P=e("table",{class:"table ui-table-standard","data-ui-table":"true"}),D=e("thead",{},[e("tr",{},[e("th",{},["PO-Nr."]),e("th",{},["Bestelldatum"]),e("th",{},["Stückzahl"]),e("th",{},["Stückpreis (USD)"]),e("th",{},["Produktionstage"]),e("th",{},["Transit"]),e("th",{},["Transport"]),e("th",{},["Fracht (€)"]),e("th",{},["Zoll %"]),e("th",{},["EUSt %"]),e("th",{},["FX-Fee %"])])]),T=e("tbody");return F.forEach(C=>{T.append(e("tr",{},[e("td",{},[C.poNumber||C.number||"—"]),e("td",{},[fn(C.orderDate)]),e("td",{},[C.units!=null?z(f(C.units),0):"—"]),e("td",{},[gn(C.unitCostUsd)]),e("td",{},[Number.isFinite(Number(C.prodDays))?String(C.prodDays):"—"]),e("td",{},[Number.isFinite(Number(C.transitDays))?String(C.transitDays):"—"]),e("td",{},[C.transport||"—"]),e("td",{},[Zn(C.freightEur)]),e("td",{},[C.dutyRatePct!=null?z(f(C.dutyRatePct),2):"—"]),e("td",{},[C.eustRatePct!=null?z(f(C.eustRatePct),2):"—"]),e("td",{},[C.fxFeePct!=null?z(f(C.fxFeePct),2):"—"])]))}),P.append(D,T),P}function We(r){const p=Lt(),F=Wn(p),P=Mn().map(n=>{const i=String((n==null?void 0:n.sku)||"").trim().toLowerCase(),c=i?F.bySku.get(i):null;return{...n,abcClass:(c==null?void 0:c.abcClass)??null,abcMeta:c||null}}),D=Fn(P,p.settings||{}),T=new Map;D.forEach(n=>{const i=String(n.entityId||"").trim();i&&(T.has(i)||T.set(i,[]),T.get(i).push(n))});const C=Array.isArray(p.productCategories)?p.productCategories:[],ie=new Map(C.map(n=>[String(n.id),n])),oe=zn(p,P);let G="";const me="productsCompletenessView";let ke=st(me,{filter:"all"}).filter||"all";const xe="productsAbcFilter";let Ne=st(xe,{filter:"all"}).filter||"all";const je="productsTableSort";let He=st(je,{mode:"category"}).mode||"category";ke==="ready"&&(ke="ok");let Q=Vn("productsView");Q!=="table"&&Q!=="list"&&(Q="list");const ce=r.__productsBulkDraft||cn({},{key:"products:bulk",enableDraftCache:!0});r.__productsBulkDraft=ce;const fe=ce.draft;r.__productsBulkGuard&&(r.__productsBulkGuard.unregister(),r.__productsBulkGuard.detachBeforeUnload());const ot=sn(()=>ce.isDirty,"Ungespeicherte Änderungen verwerfen?");r.__productsBulkGuard=ot,ot.register(),ot.attachBeforeUnload();const It="productsCategoryCollapse",Nt=sessionStorage.getItem("healthFocus");if(Nt){try{const n=JSON.parse(Nt);(n==null?void 0:n.tab)==="produkte"&&n.sku&&(G=String(n.sku))}catch{}sessionStorage.removeItem("healthFocus")}const ct=ce.loadDraftIfAvailable();!r.__bulkDraftPrompted&&(ct!=null&&ct.exists)&&Object.keys(fe).length===0&&(r.__bulkDraftPrompted=!0,xt({title:"Entwurf gefunden",message:"Es gibt ungespeicherte Tabellenänderungen. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{ce.restoreDraft(),X()},onCancel:()=>{ce.discardDraft()}}));function yn(n){const i=T.get(n)||[];if(!i.length)return null;const c=dn(i);return e("button",{class:"data-health-dot",type:"button",title:c,"aria-label":c,onclick:l=>{l.stopPropagation(),rn({scope:"product",entityId:n})}})}const ut=new Map,bn={state:p};function Xe(n){return n!=null&&n.sku?(ut.has(n.sku)||ut.set(n.sku,rt(n,bn)),ut.get(n.sku)):rt(n,{state:p})}function At(n){var y;const i=f((y=p==null?void 0:p.settings)==null?void 0:y.moqDefaultUnits),c=f(n==null?void 0:n.moqOverrideUnits);if(c!=null&&c>0)return Math.round(c);const l=f(n==null?void 0:n.moqUnits);return l!=null&&l>0?Math.round(l):i!=null&&i>0?Math.round(i):null}function hn(n,i,c,l){const y=i?n.filter(s=>{const d=i.trim().toLowerCase(),b=Ft(s.categoryId),x=oe.get(s.supplierId);return[s.alias,s.sku,s.supplierId,x,b].filter(Boolean).some(S=>String(S).toLowerCase().includes(d))}):n,h=!l||l==="all"?y:y.filter(s=>Ut(s.abcClass)===l);if(!c||c==="all")return h;const u=c==="ready"?"ok":c==="warning"?"warn":c;return h.filter(s=>Xe(s).status===u)}function Tt(n){return n==="ok"?"OK":n==="warn"?"WARN":"BLOCKED"}function Ae(n,i=3){const c=(n||[]).map(h=>h.label).filter(Boolean);if(!c.length)return"";const l=c.slice(0,i),y=c.length-l.length;return`${l.join(", ")}${y>0?` +${y} weitere`:""}`}function vn(n){const i=[],c=Ae(n.blockingMissing),l=Ae(n.defaulted),y=Ae(n.suggestedMissing);c&&i.push(`Fehlt: ${c}`);const h=[];return l&&h.push(`Standardwert: ${l}`),y&&h.push(`Empfohlen: ${y}`),h.length&&i.push(h.join(" · ")),i.length||i.push("Alle Pflichtfelder vorhanden."),i.slice(0,2).map(u=>e("div",{},[u]))}function dt(){let n=document.getElementById("products-completeness-tooltip");return n||(n=e("div",{id:"products-completeness-tooltip",class:"portal-tooltip",role:"tooltip",hidden:!0}),document.body.appendChild(n)),n}function kn(n,i,{delay:c=150}={}){let l=null,y=!1,h=null;function u(){const S=dt(),U=n.getBoundingClientRect(),_=S.getBoundingClientRect(),K=8;let I=U.left,Z=U.bottom+8;const se=window.innerWidth-_.width-K;I>se&&(I=se),I<K&&(I=K),Z+_.height>window.innerHeight-K&&(Z=U.top-_.height-8),Z<K&&(Z=K),S.style.left=`${I}px`,S.style.top=`${Z}px`}function s(){if(y)return;y=!0;const S=dt();S.innerHTML="",S.append(...i()),S.hidden=!1,S.classList.add("is-visible"),n.setAttribute("aria-describedby",S.id),requestAnimationFrame(u);const U=()=>u(),_=()=>u();window.addEventListener("scroll",U,!0),window.addEventListener("resize",_),h=()=>{window.removeEventListener("scroll",U,!0),window.removeEventListener("resize",_)}}function d(){if(clearTimeout(l),!y)return;y=!1;const S=dt();S.hidden=!0,S.classList.remove("is-visible"),S.innerHTML="",h&&h(),h=null}function b(){clearTimeout(l),l=setTimeout(s,c)}function x(){d()}n.addEventListener("mouseenter",b),n.addEventListener("focus",b),n.addEventListener("mouseleave",x),n.addEventListener("blur",x)}function Sn(n){const i=Xe(n),c=i.status||"blocked",l=Tt(c),y=e("button",{class:`tooltip-trigger completeness-badge ${c}`,type:"button","aria-label":l,onclick:h=>{var u;h.stopPropagation(),c==="blocked"&&((u=i.blockingMissing)!=null&&u.length)&&Me(n,{focusFieldKey:i.blockingMissing[0].fieldKey})}},[l]);return kn(y,()=>vn(i)),y}function En(n){const i=Xe(n),c=i.status||"blocked",l=Tt(c),y=[Ae(i.blockingMissing),Ae(i.defaulted),Ae(i.suggestedMissing)].filter(Boolean).join(" · ")||"Alle Pflichtfelder vorhanden.",h=W.createElement("button",{className:`tooltip-trigger completeness-badge ${c}`,type:"button",onClick:u=>{var s;u.stopPropagation(),c==="blocked"&&((s=i.blockingMissing)!=null&&s.length)&&Me(n,{focusFieldKey:i.blockingMissing[0].fieldKey})}},l);return W.createElement(Pt,{title:y},h)}function wn(n){const i=T.get(n)||[];if(!i.length)return null;const c=dn(i);return W.createElement("button",{className:"data-health-dot",type:"button","aria-label":c,onClick:l=>{l.stopPropagation(),rn({scope:"product",entityId:n})}})}r.__productsActionsCleanup&&r.__productsActionsCleanup();let ne=null,ue=null;function Se(){ue&&ue.setAttribute("aria-expanded","false"),ne&&ne.remove(),ne=null,ue=null}function pt(){if(!ne||!ue)return;const n=ue.getBoundingClientRect(),i=ne.getBoundingClientRect(),c=8,l=window.innerWidth-i.width-c,y=window.innerHeight-i.height-c;let h=n.right-i.width,u=n.bottom+6;h=Math.min(l,h),h=Math.max(c,h),u>y&&(u=n.top-i.height-6),u=Math.max(c,u),ne.style.left=`${h}px`,ne.style.top=`${u}px`}function Cn(n,i){if(!n||!i)return;if(ue===n){Se();return}Se();const c=e("div",{class:"product-actions-menu",role:"menu"}),l=e("button",{class:"product-actions-menu-item",type:"button",onclick:u=>{u.stopPropagation(),Kt(i),Se()}},["Historie"]),y=e("button",{class:"product-actions-menu-item",type:"button",onclick:u=>{u.stopPropagation(),$n(i.sku,i.status==="inactive"?"active":"inactive"),Se(),We(r)}},[i.status==="inactive"?"Aktiv setzen":"Inaktiv setzen"]),h=e("button",{class:"product-actions-menu-item danger",type:"button",onclick:u=>{u.stopPropagation(),confirm("Produkt wirklich löschen?")&&(qn(i.sku),Se(),We(r))}},["Löschen"]);c.append(l,y,h),document.body.appendChild(c),ne=c,ue=n,ue.setAttribute("aria-expanded","true"),pt(),requestAnimationFrame(pt)}function _t(n){ne&&(ne.contains(n.target)||ue&&ue.contains(n.target)||Se())}function Ot(){pt()}function Mt(){ne&&Se()}document.addEventListener("click",_t),window.addEventListener("resize",Ot),window.addEventListener("scroll",Mt,!0),r.__productsActionsCleanup=()=>{Se(),document.removeEventListener("click",_t),window.removeEventListener("resize",Ot),window.removeEventListener("scroll",Mt,!0)};function Ft(n){if(!n)return"Ohne Kategorie";const i=ie.get(String(n));return(i==null?void 0:i.name)||"Ohne Kategorie"}function Ze(){return st(It,{})}function mt(n){at(It,n)}function Bt(n){const i={};ft(P).forEach(l=>{i[l.id]=n}),mt(i)}function ft(n,{sortMode:i}={}){const c=new Map;n.forEach(u=>{const s=u.categoryId?String(u.categoryId):"";c.has(s)||c.set(s,[]),c.get(s).push(u)}),i==="abc"&&c.forEach(u=>{u.sort((s,d)=>{const b=un(s.abcClass)-un(d.abcClass);return b||String(s.alias||s.sku||"").localeCompare(String(d.alias||d.sku||""))})});const y=C.slice().sort((u,s)=>(u.sortOrder??0)-(s.sortOrder??0)||String(u.name||"").localeCompare(String(s.name||""))).map(u=>({id:String(u.id),name:u.name||"Ohne Kategorie",items:c.get(String(u.id))||[]})),h=c.get("")||[];return h.length&&y.push({id:"uncategorized",name:"Ohne Kategorie",items:h}),y}function Me(n,i={}){var nn;const c=Lt();let l=n?{...n}:{sku:"",alias:"",supplierId:"",status:"active",tags:[],template:null,abcClass:null};const y=cn(l,{key:l.sku?`product:${l.sku}`:"product:new",enableDraftCache:!0});l=y.draft;const h=sn(()=>y.isDirty,"Ungespeicherte Änderungen verwerfen?"),u=e("form",{class:"form"}),s=i.focusFieldKey,d=e("input",{value:l.sku||"",required:!0}),b=e("input",{value:l.alias||"",required:!0}),x=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Supplier"])),(c.suppliers||[]).forEach(a=>{const m=oe.get(a.id)||a.name||a.id;t.append(e("option",{value:a.id},[m]))}),t.value=l.supplierId||"",t})(),S=e("select",{},[e("option",{value:"active",selected:l.status!=="inactive"},["Aktiv"]),e("option",{value:"inactive",selected:l.status==="inactive"},["Inaktiv"])]),U=e("input",{value:lt(l.abcClass),disabled:!0}),_=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Kategorie"])),C.forEach(a=>{t.append(e("option",{value:a.id},[a.name]))}),t.value=l.categoryId||"",t})(),K=e("input",{value:l.avgSellingPriceGrossEUR!=null?M(f(l.avgSellingPriceGrossEUR),2):"",inputmode:"decimal"}),I=e("input",{value:l.sellerboardMarginPct!=null?M(f(l.sellerboardMarginPct),2):"",inputmode:"decimal"}),Z=e("input",{value:l.productionLeadTimeDaysDefault!=null?M(f(l.productionLeadTimeDaysDefault),0):"",inputmode:"decimal"}),se=e("input",{value:l.moqUnits!=null?M(f(l.moqUnits),0):"",inputmode:"decimal"}),ge=e("input",{value:l.safetyStockDohOverride!=null?M(f(l.safetyStockDohOverride),0):"",inputmode:"decimal"}),ye=e("input",{value:l.foCoverageDohOverride!=null?M(f(l.foCoverageDohOverride),0):"",inputmode:"decimal"}),Ee=e("input",{value:l.moqOverrideUnits!=null?M(f(l.moqOverrideUnits),0):"",inputmode:"decimal"}),be=e("input",{value:l.landedUnitCostEur!=null?M(f(l.landedUnitCostEur),2):"",inputmode:"decimal"}),J=(nn=l.template)!=null&&nn.fields?{...l.template.fields}:l.template||{};!J.transportMode&&J.transport&&(J.transportMode=J.transport);const ae=c.settings||{},Fe=Number(ae.safetyStockDohDefault??60),Le=Number(ae.foCoverageDohDefault??90),Pe=Number(ae.moqDefaultUnits??500),he=f(ae.fxRate)??f(ae.fxRate)??null,De={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,vatImportPct:19,vatRefundLag:0,fxRate:he,fxFeePct:0,ddp:ae.defaultDdp===!0,currency:ae.defaultCurrency||"EUR"},gt=[{key:"unitPriceUsd",label:"Stückpreis (USD)",valueType:"number",decimals:2},{key:"extraPerUnitUsd",label:"Zusatz je Stück (USD)",valueType:"number",decimals:2},{key:"extraFlatUsd",label:"Zusatz pauschal (USD)",valueType:"number",decimals:2},{key:"transportMode",label:"Transport",type:"select",options:["SEA","RAIL","AIR"]},{key:"productionDays",label:"Produktionstage",valueType:"number",decimals:0},{key:"transitDays",label:"Transit-Tage",valueType:"number",decimals:0},{key:"freightEur",label:"Logistik / Stk. (EUR)",valueType:"number",decimals:2},{key:"dutyPct",label:"Zoll %",valueType:"number",decimals:2},{key:"dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox"},{key:"vatImportPct",label:"EUSt %",valueType:"number",decimals:2},{key:"vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox"},{key:"vatRefundLag",label:"EUSt-Lag (Monate)",valueType:"number",decimals:0},{key:"fxRate",label:"FX-Kurs",valueType:"number",decimals:4},{key:"fxFeePct",label:"FX-Gebühr %",valueType:"number",decimals:2},{key:"currency",label:"Currency",type:"select",options:["USD","EUR","CNY"]},{key:"ddp",label:"DDP",type:"checkbox"}],Be=e("div",{class:"table-card-header"},[e("h4",{},["Template-Werte"]),e("button",{class:"btn secondary",type:"button",id:"product-apply-latest"},["Letzte PO Werte übernehmen"])]),Y=e("div",{class:"product-completeness-summary",hidden:!0}),Je=e("div",{class:"product-completeness-summary-title"}),Ue=e("div",{class:"product-completeness-summary-list"});Y.append(Je,Ue);const Ke=e("label",{},["SKU",d]),o=e("label",{},["Alias",b]),E=e("label",{},["Supplier",x]),v=e("label",{},["Kategorie",_]),j=e("label",{},["Status",S]),O=e("label",{},["ABC Klassifizierung",U]),L=e("label",{},["Ø VK-Preis (Brutto)",K]),q=e("label",{},["Sellerboard Marge (%)",I]),A=e("label",{},["Default Production Lead Time (Fallback)",Z]),re=e("label",{},["MOQ (Einheiten)",se]),V=e("label",{},["Safety Stock DOH Override (optional)",ge,e("small",{class:"muted",id:"safety-stock-effective"},[])]),N=e("label",{},["FO Coverage DOH Override (optional)",ye,e("small",{class:"muted",id:"fo-coverage-effective"},[])]),H=e("label",{},["MOQ Override (optional)",Ee,e("small",{class:"muted",id:"moq-effective"},[])]),le=e("label",{},["Einstandspreis (EUR)",be,e("small",{class:"muted",id:"shipping-derived"},[])]);u.append(Y,Ke,o,E,v,j,O,L,q,A,re,e("hr"),e("h4",{},["Inventory Planning Overrides"]),V,N,H,le,e("hr"),Be),[{input:K,decimals:2},{input:I,decimals:2},{input:Z,decimals:0},{input:se,decimals:0},{input:ge,decimals:0},{input:ye,decimals:0},{input:Ee,decimals:0},{input:be,decimals:2}].forEach(({input:t,decimals:a})=>{t.addEventListener("blur",()=>{const m=f(t.value);t.value=m==null?"":M(m,a),Re()}),t.addEventListener("input",()=>{Re()})});const Qe=e("div",{class:"grid two"}),ve={},Gt={},yt={},bt=new Map,$t=new Map,qt="Pflichtfeld – benötigt für PO/FO & Kalkulation",Dn={avgSellingPriceGrossEUR:"Empfohlen für Pricing Analytics.",sellerboardMarginPct:"Empfohlen für Pricing Analytics.",landedUnitCostEur:"Wird verfügbar nach erster PO / kann später gepflegt werden."},ht={unitPriceUsd:{min:0},extraPerUnitUsd:{min:0},extraFlatUsd:{min:0},productionDays:{min:0,integer:!0},transitDays:{min:0,integer:!0},freightEur:{min:0},dutyPct:{min:0,max:100},vatImportPct:{min:0,max:100},vatRefundLag:{min:0,integer:!0},fxRate:{min:1e-4},fxFeePct:{min:0,max:100}};function $e(t){const a=ht[t];if(!a)return!0;const m=ve[t],g=Gt[t];if(!m||!g)return!0;const k=String(m.value||"").trim();if(!k){const R=De[t];return t==="fxRate"&&(R==null||R<=0)?(g.textContent="FX-Kurs ist erforderlich.",!1):(g.textContent="",!0)}const w=f(k);return w==null?(g.textContent="Ungültiger Wert.",!1):a.integer&&!Number.isInteger(w)?(g.textContent="Bitte eine ganze Zahl eingeben.",!1):a.min!=null&&w<a.min?(g.textContent=`Wert muss ≥ ${a.min} sein.`,!1):a.max!=null&&w>a.max?(g.textContent=`Wert muss ≤ ${a.max} sein.`,!1):(g.textContent="",!0)}function Vt(){return Object.keys(ht).every(t=>$e(t))}function we(){const t=Vt(),m=(Ye||wt()).status==="blocked";Ie.disabled=!t||!y.isDirty||m}const Un=(()=>{const a=(c.pos||[]).filter(R=>String((R==null?void 0:R.sku)||"").trim().toLowerCase()===String(l.sku||"").trim().toLowerCase()).sort((R,B)=>(B.orderDate||"").localeCompare(R.orderDate||""))[0];if(!a)return"Hinweis: —";const m=f(a.freightPerUnitEur),g=f(a.units),k=f(a.freightEur),w=m??(k!=null&&g?k/g:null);return w==null||!Number.isFinite(w)?"Hinweis: —":`Hinweis: Logistik / Stk. (EUR) aus letzter PO: ${z(w,2)} €`})();function de(t,a,m){if(!a||!m)return;const g=e("small",{class:"field-required-helper",hidden:!0},[qt]);a.append(g),bt.set(t,{input:m,helper:g})}function zt(t,a,m){if(!a||!m)return;const g=e("small",{class:"field-suggested-helper",hidden:!0},[Dn[t]||"Empfohlen."]);a.append(g),$t.set(t,{input:m,helper:g})}function Wt(t){const a=bt.get(t);a&&(a.input.scrollIntoView({behavior:"smooth",block:"center"}),a.input.focus({preventScroll:!0}))}gt.forEach(t=>{if(yt[t.key]=t,t.type==="checkbox"){const a=e("input",{type:"checkbox",name:t.key,checked:!!J[t.key]});ve[t.key]=a,Qe.append(e("label",{class:"inline-checkbox"},[a," ",t.label]))}else if(t.type==="select"){const a=e("select",{name:t.key});(t.options||[]).forEach(g=>{a.append(e("option",{value:g},[g]))});const m=J[t.key]??De[t.key];a.value=m||(t.options?t.options[0]:""),ve[t.key]=a,Qe.append(e("label",{},[t.label,a]))}else{const a=typeof t.decimals=="number"?t.decimals:2,m=J[t.key]??De[t.key],g=f(m),k=g!=null?M(g,a):"",w=e("input",{name:t.key,value:k,inputmode:"decimal"});w.addEventListener("blur",()=>{const te=f(w.value),pe=De[t.key],Ce=te??pe;w.value=Ce==null?"":M(Ce,a),$e(t.key),we(),t.key==="unitPriceUsd"&&Re()}),w.addEventListener("input",()=>{$e(t.key),we(),t.key==="unitPriceUsd"&&Re()}),ve[t.key]=w;const R=e("small",{class:"form-error"},[]);Gt[t.key]=R;const B=e("label",{},[t.label,w,R]);t.key==="freightEur"&&B.append(e("small",{class:"muted"},[Un])),t.key==="unitPriceUsd"&&de("unitPriceUsd",B,w),t.key==="transitDays"&&de("transitDays",B,w),t.key==="dutyPct"&&de("dutyPct",B,w),t.key==="vatImportPct"&&de("vatImportPct",B,w),Qe.append(B)}}),u.append(Qe);const jt=ze("#safety-stock-effective",u),Ht=ze("#fo-coverage-effective",u),Xt=ze("#moq-effective",u),qe=ze("#shipping-derived",u);function Re(){var R,B;const t=f(ge.value),a=f(ye.value),m=f(Ee.value),g=t??Fe,k=a??Le,w=m??Pe;if(jt&&(jt.textContent=`Effektiv: ${z(g,0)} Tage (Default: ${z(Fe,0)})`),Ht&&(Ht.textContent=`Effektiv: ${z(k,0)} Tage (Default: ${z(Le,0)})`),Xt&&(Xt.textContent=`Effektiv: ${z(w,0)} Einheiten (Default: ${z(Pe,0)})`),qe){const te=f((R=ve.unitPriceUsd)==null?void 0:R.value),pe=f(be.value),Ce=f((B=ve.fxRate)==null?void 0:B.value)??he,Te=on({unitPriceUsd:te,landedCostEur:pe,fxUsdPerEur:Ce});qe.innerHTML="";const tt=Te.value==null?"Logistik / Stk. (EUR, berechnet): —":`Logistik / Stk. (EUR, berechnet): ${z(Te.value,2)} €`;qe.append(document.createTextNode(tt));const Ve=Te.missingFields.map(nt=>nt==="landedCostEur"?"Einstandspreis (EUR)":nt==="unitPriceUsd"?"Stückpreis USD":nt==="fxUsdPerEur"?"FX (USD je EUR)":nt);qe.append(e("span",{class:"tooltip"},[e("button",{class:"tooltip-trigger",type:"button","aria-label":"Formel"},["ℹ️"]),e("span",{class:"tooltip-content"},["Formel: Einstandspreis (EUR) – (Stückpreis USD ÷ FX). Negative Werte werden auf 0 gesetzt.",Ve.length?` Fehlend: ${Ve.join(", ")}.`:""])])),Te.warning&&qe.append(e("span",{class:"badge fo-recommendation-badge"},["Check landed cost / FX"]))}}function ee(t,a){const m=ve[t];if(!m)return;const g=yt[t]||{};if(m.type==="checkbox"){m.checked=!!a;return}if(m.tagName==="SELECT"){m.value=a!=null?String(a):m.value;return}const k=typeof g.decimals=="number"?g.decimals:2,w=f(a);m.value=w==null?"":M(w,k),$e(t)}function Rn(){var m;const t=y.draft||{};d.value=t.sku||"",b.value=t.alias||"",x.value=t.supplierId||"",S.value=t.status||"active",_.value=t.categoryId||"",U.value=lt(l.abcClass),K.value=t.avgSellingPriceGrossEUR!=null?M(f(t.avgSellingPriceGrossEUR),2):"",I.value=t.sellerboardMarginPct!=null?M(f(t.sellerboardMarginPct),2):"",Z.value=t.productionLeadTimeDaysDefault!=null?M(f(t.productionLeadTimeDaysDefault),0):"",se.value=t.moqUnits!=null?M(f(t.moqUnits),0):"",ge.value=t.safetyStockDohOverride!=null?M(f(t.safetyStockDohOverride),0):"",ye.value=t.foCoverageDohOverride!=null?M(f(t.foCoverageDohOverride),0):"",Ee.value=t.moqOverrideUnits!=null?M(f(t.moqOverrideUnits),0):"",be.value=t.landedUnitCostEur!=null?M(f(t.landedUnitCostEur),2):"";const a=(m=t.template)!=null&&m.fields?t.template.fields:t.template||{};Object.keys(ve).forEach(g=>{ee(g,a[g])}),vt.value=a.milestones?JSON.stringify(a.milestones,null,2):"",Re(),Ct()}function In(){const t=d.value.trim();if(!t){_e("Bitte zuerst eine SKU angeben.");return}const a=(c.pos||[]).filter(R=>String((R==null?void 0:R.sku)||"").trim().toLowerCase()===t.toLowerCase()).sort((R,B)=>(B.orderDate||"").localeCompare(R.orderDate||""))[0];if(!a){_e("Keine PO vorhanden.");return}const m=f(a.freightPerUnitEur),g=f(a.units),k=f(a.freightEur),w=m??(k!=null&&g?k/g:null);ee("unitPriceUsd",a.unitCostUsd),ee("freightEur",w),ee("productionDays",a.prodDays),ee("transitDays",a.transitDays),ee("transportMode",String(a.transport||"SEA").toUpperCase()),ee("dutyPct",a.dutyRatePct),ee("vatImportPct",a.eustRatePct),ee("fxRate",a.fxOverride??ae.fxRate),ee("fxFeePct",a.fxFeePct),ee("ddp",a.ddp===!0),ee("currency","USD"),Re(),et(),_e("Letzte PO Werte übernommen.")}const vt=e("textarea",{placeholder:"Milestones im JSON-Format (optional)",value:J.milestones?JSON.stringify(J.milestones,null,2):"",rows:6,style:"width:100%; margin-top:12px;"});u.append(e("label",{},["Meilensteine (JSON)",vt]));const Nn=e("div",{class:"product-history"},[e("h4",{},["Historie"]),mn(c,l.sku)]),An=e("div",{class:"product-suppliers"},[e("h4",{},["Suppliers"]),e("p",{class:"muted"},["SKU-Mappings wurden entfernt. Lieferanten und Preise werden direkt im Produktstamm gepflegt."])]),Ie=e("button",{class:"btn",type:"submit"},["Speichern"]),Zt=e("button",{class:"btn secondary",type:"button"},["Abbrechen"]);let kt,Ye=rt(l,{state:c});h.register(),h.attachBeforeUnload();function Jt(){h.unregister(),h.detachBeforeUnload(),r.__productsBulkGuard&&r.__productsBulkGuard.register(),kt.overlay.remove()}function Qt(){if(!y.isDirty){Jt();return}h({confirmWithModal:({onConfirm:t})=>xt({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{y.discardDraft(),t==null||t(),Jt()}})})}kt=pn({title:n?`Produkt bearbeiten – ${n.alias||n.sku}`:"Neues Produkt",content:e("div",{},[u,Nn,An]),actions:[Zt,Ie],onClose:Qt}),Zt.addEventListener("click",Qt),Ie.addEventListener("click",t=>{t.preventDefault(),u.requestSubmit()});const St=y.loadDraftIfAvailable();St!=null&&St.exists&&xt({title:"Entwurf gefunden",message:"Es gibt einen ungespeicherten Entwurf. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{y.restoreDraft(),Rn(),et()},onCancel:()=>{y.discardDraft(),we()}});const Yt=ze("#product-apply-latest",u);Yt&&Yt.addEventListener("click",In),de("sku",Ke,d),de("alias",o,b),de("categoryId",v,_),de("moqUnits",re,se),de("productionLeadTimeDaysDefault",A,Z),de("avgSellingPriceGrossEUR",L,K),zt("sellerboardMarginPct",q,I),zt("landedUnitCostEur",le,be),Object.keys(ht).forEach(t=>$e(t)),Ct(),Re(),s&&requestAnimationFrame(()=>Wt(s));function Tn({strict:t}={}){const a=vt.value.trim();if(!a)return null;try{const m=JSON.parse(a);if(!Array.isArray(m))return null;const g=m.reduce((k,w)=>k+Number(w.percent||0),0);if(t&&Math.round(g)!==100)throw new Error("Meilensteine müssen in Summe 100 % ergeben.");return m}catch(m){if(t)throw m;return null}}function Et({strictMilestones:t=!1}={}){var R,B;const a={sku:d.value.trim(),alias:b.value.trim(),supplierId:x.value.trim(),categoryId:_.value.trim()||null,status:S.value,tags:Array.isArray(l.tags)?[...l.tags]:[],avgSellingPriceGrossEUR:f(K.value.trim()),sellerboardMarginPct:f(I.value.trim()),productionLeadTimeDaysDefault:f(Z.value.trim()),moqUnits:f(se.value.trim()),safetyStockDohOverride:f(ge.value.trim()),foCoverageDohOverride:f(ye.value.trim()),moqOverrideUnits:f(Ee.value.trim()),landedUnitCostEur:f(be.value.trim())};n!=null&&n.sku&&(a.originalSku=n.sku);const m={};Object.entries(ve).forEach(([te,pe])=>{if(!pe)return;if(pe.type==="checkbox"){m[te]=pe.checked;return}if(pe.tagName==="SELECT"){m[te]=pe.value;return}const Ce=pe.value.trim(),Te=yt[te]||{};if(Ce===""){const Ve=De[te];Ve!=null&&(m[te]=Ve);return}if(Te.valueType==="text"){m[te]=Ce;return}const tt=f(Ce);tt!=null&&(m[te]=tt)});const g=Tn({strict:t});g&&(m.milestones=g),Object.keys(m).length?a.template={scope:((R=n==null?void 0:n.template)==null?void 0:R.scope)||"SKU",name:((B=n==null?void 0:n.template)==null?void 0:B.name)||"Standard (SKU)",fields:m}:a.template=null;const k=m.fxRate??he,w=on({unitPriceUsd:m.unitPriceUsd??null,landedCostEur:a.landedUnitCostEur,fxUsdPerEur:k});return a.fxUsdPerEur=k??null,a.logisticsPerUnitEur=w.value,a.freightPerUnitEur=w.value,a}function wt(){const t=Et();return rt(t,{state:c})}function _n(t){if(!t)return"";if(t.fieldKey==="unitPriceUsd"&&t.value){const a=z(t.value.amount,2),m=t.value.currency||"";return`Default aktiv: ${a} ${m}`.trim()}return t.fieldKey==="moqUnits"?`Default aktiv: ${z(t.value,0)} Einheiten`:t.fieldKey==="productionLeadTimeDaysDefault"||t.fieldKey==="transitDays"?`Default aktiv: ${z(t.value,0)} Tage`:t.fieldKey==="dutyPct"||t.fieldKey==="vatImportPct"?`Default aktiv: ${z(t.value,2)} %`:"Default aktiv"}function en(t){const a=t.blockingMissing||[],m=t.defaulted||[];if(Ue.innerHTML="",a.length){Y.hidden=!1,Y.classList.add("blocked"),Y.classList.remove("warn"),Je.textContent=`Blockiert: ${a.length} Pflichtfelder fehlen`,a.forEach(g=>{const k=e("button",{class:"btn secondary sm",type:"button"},[g.label]);k.addEventListener("click",()=>Wt(g.fieldKey)),Ue.append(k)});return}if(m.length){Y.hidden=!1,Y.classList.add("warn"),Y.classList.remove("blocked"),Je.textContent="Hinweis: Defaults aktiv",m.forEach(g=>{const k=e("span",{class:"btn secondary sm"},[g.label]);Ue.append(k)});return}Y.hidden=!0,Y.classList.remove("blocked","warn")}function tn(t){const a=new Set((t.blockingMissing||[]).map(k=>k.fieldKey)),m=new Map((t.defaulted||[]).map(k=>[k.fieldKey,k]));bt.forEach((k,w)=>{const R=a.has(w),B=m.get(w);if(k.input.classList.toggle("field-missing-required",R),k.input.setAttribute("aria-invalid",R?"true":"false"),R){k.helper.textContent=qt,k.helper.classList.add("is-missing"),k.helper.classList.remove("is-defaulted"),k.helper.hidden=!1;return}if(B){k.helper.textContent=_n(B),k.helper.classList.add("is-defaulted"),k.helper.classList.remove("is-missing"),k.helper.hidden=!1;return}k.helper.textContent="",k.helper.classList.remove("is-missing","is-defaulted"),k.helper.hidden=!0});const g=new Set((t.suggestedMissing||[]).map(k=>k.fieldKey));$t.forEach((k,w)=>{const R=g.has(w);k.helper.hidden=!R})}function Ct(){Ye=wt(),tn(Ye),en(Ye),we()}function et(){const t=Et();y.setDraft(t),Ct()}u.addEventListener("submit",async t=>{if(t.preventDefault(),!Vt()){we();return}const a=wt();if(a.status==="blocked"){tn(a),en(a),_e("Bitte Pflichtfelder ergänzen."),we();return}Ie.disabled=!0,Ie.textContent="Speichern…";let m;try{m=Et({strictMilestones:!0})}catch(g){alert(g.message||String(g)),Ie.textContent="Speichern",we();return}try{await y.commit(()=>an(m)),kt.overlay.remove(),We(r)}catch(g){alert(g.message||String(g)),Ie.textContent="Speichern",we()}}),u.addEventListener("input",et),u.addEventListener("change",et)}function xn(n){if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const i=Ze(),c=ft(n),l=[];c.forEach(s=>{const d=!!i[s.id];l.push({id:`group-${s.id}`,isGroup:!0,categoryId:s.id,categoryName:s.name,count:s.items.length,collapsed:d}),!d&&s.items.forEach(b=>{l.push({id:`product-${b.sku}`,isGroup:!1,product:b})})});const y=[{key:"alias",title:"Alias",dataIndex:"alias",width:230,fixed:"left",onCell:s=>s.isGroup?{colSpan:14}:{},render:(s,d)=>{if(d.isGroup)return W.createElement("button",{className:"product-group-toggle",type:"button","aria-expanded":String(!d.collapsed),onClick:()=>{const S=Ze();S[d.categoryId]=!d.collapsed,mt(S),X()}},`${d.categoryName} (${d.count})`);const b=d.product,x=b.alias||"—";return W.createElement("div",{className:"data-health-inline"},[wn(b.sku),W.createElement("span",{className:"truncate-text"},x),b.status==="inactive"?W.createElement("span",{className:"badge muted"},"inaktiv"):null])}},{key:"sku",title:"SKU",dataIndex:"sku",width:130,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>d.isGroup?null:d.product.sku||"—"},{key:"supplier",title:"Supplier",dataIndex:"supplier",width:180,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{if(d.isGroup)return null;const b=d.product;return oe.get(b.supplierId)||b.supplierId||"—"}},{key:"category",title:"Kategorie",dataIndex:"category",width:150,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>d.isGroup?null:Ft(d.product.categoryId)},{key:"status",title:"Status",dataIndex:"status",width:100,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>d.isGroup?null:d.product.status==="inactive"?W.createElement("span",{className:"badge muted"},"inaktiv"):W.createElement("span",{className:"badge"},"aktiv")},{key:"abcClass",title:"ABC",dataIndex:"abcClass",width:70,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{if(d.isGroup)return null;const b=lt(d.product.abcClass);return W.createElement("span",{className:b==="—"?"badge muted":"badge"},b)}},{key:"completeness",title:"Vollständigkeit",dataIndex:"completeness",width:130,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>d.isGroup?null:En(d.product)},{key:"moqUnits",title:"MOQ",tooltip:"Minimum Order Quantity",dataIndex:"moqUnits",width:90,numeric:!0,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{if(d.isGroup)return null;const b=At(d.product);return Number.isFinite(b)?Number(b).toLocaleString("de-DE"):"—"}},{key:"lastPo",title:"Letzte PO",dataIndex:"lastPo",width:110,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{var b;return d.isGroup?null:(b=d.product.stats)!=null&&b.lastOrderDate?fn(d.product.stats.lastOrderDate):"—"}},{key:"avg",title:"Ø Stückpreis",dataIndex:"avg",width:120,numeric:!0,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{var b;return d.isGroup?null:((b=d.product.stats)==null?void 0:b.avgUnitPriceUsd)!=null?gn(d.product.stats.avgUnitPriceUsd):"—"}},{key:"count",title:"POs",dataIndex:"count",width:80,numeric:!0,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{var b;return d.isGroup?null:String(((b=d.product.stats)==null?void 0:b.poCount)??0)}},{key:"template",title:"Template",dataIndex:"template",width:100,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>d.isGroup?null:d.product.template?W.createElement("span",{className:"badge"},"vorhanden"):W.createElement("span",{className:"badge muted"},"—")},{key:"actions",title:"Aktionen",dataIndex:"actions",width:170,fixed:"right",ellipsis:!1,onCell:s=>s.isGroup?{colSpan:0}:{},render:(s,d)=>{if(d.isGroup)return null;const b=d.product;return W.createElement("div",{className:"table-actions"},[W.createElement("button",{className:"btn secondary sm",type:"button",onClick:()=>Me(b)},"Bearbeiten"),W.createElement("button",{className:"btn secondary sm",type:"button","aria-haspopup":"menu","aria-expanded":"false",onClick:x=>{x.stopPropagation(),Cn(x.currentTarget,b)}},"Mehr…")])}}],h=e("div",{class:"table-wrap ui-table-shell ui-scroll-host products-list products-list-antd"}),u=e("div",{class:"products-list-react-mount"});return h.append(u),r.__productsListReactRoot=Kn(u),r.__productsListReactRoot.render(W.createElement(Xn,{className:"products-list-table-antd",columns:y,dataSource:l,rowKey:"id",rowClassName:s=>s.isGroup?"product-group-row":"product-product-row"})),r.__productsListScrollCleanup=null,h}function Ln(n,{key:i,colgroup:c=null,widths:l=[]}={}){if(!n)return;const y=n.querySelector("thead tr:last-child");if(!y)return;const h=Array.from(y.querySelectorAll("th"));if(!h.length)return;n.style.tableLayout="fixed",h.forEach((x,S)=>{if(x.querySelector(".col-resizer"))return;const U=e("span",{class:"col-resizer","aria-hidden":"true"});x.append(U),x.dataset.colIndex=String(S)});const u=c?Array.from(c.children):null;h.forEach((x,S)=>{const U=l[S];if(Number.isFinite(U)){x.style.width=`${U}px`,u&&u[S]&&(u[S].style.width=`${U}px`);return}const _=x.getBoundingClientRect().width;_&&(x.style.width=`${_}px`,u&&u[S]&&(u[S].style.width=`${_}px`))});let s=null;function d(x){if(!s)return;const S=x.clientX-s.startX,U=Math.max(s.minWidth,s.startWidth+S);s.th.style.width=`${U}px`,s.col&&(s.col.style.width=`${U}px`)}function b(){if(!s)return;document.removeEventListener("pointermove",d),document.removeEventListener("pointerup",b);const x=h.map((S,U)=>u&&u[U]?u[U].getBoundingClientRect().width:S.getBoundingClientRect().width);i&&Gn(i,x),s=null,n.classList.remove("is-resizing")}n.addEventListener("pointerdown",x=>{const S=x.target.closest(".col-resizer");if(!S)return;const U=S.closest("th");if(!U)return;x.preventDefault();const _=Number(U.dataset.colIndex),K=u&&Number.isFinite(_)?u[_]:null,I=U.getBoundingClientRect().width;s={th:U,col:K,startX:x.clientX,startWidth:I,minWidth:80},n.classList.add("is-resizing"),document.addEventListener("pointermove",d),document.addEventListener("pointerup",b)})}function Pn(n){var Ue,Ke;if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const i=p.settings||{},l={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,dutyIncludesFreight:!1,vatImportPct:19,vatRefundActive:!1,vatRefundLag:0,fxRate:f(i.fxRate)??null??0,fxFeePct:0,ddp:i.defaultDdp===!0,currency:i.defaultCurrency||"EUR"},h=(Array.isArray(p.suppliers)?p.suppliers:[]).map(o=>({value:String(o.id||"").trim(),label:oe.get(o.id)||o.name||o.id||"—"})).filter(o=>o.value),u=C.map(o=>({value:String(o.id),label:o.name||"Ohne Kategorie"})),s=[{key:"alias",label:"Alias",type:"text",width:"240px",className:"col-alias"},{key:"sku",label:"SKU",type:"text",width:"160px",readOnly:!0,className:"col-sku"},{key:"supplierId",label:"Supplier",type:"select",options:h,width:"180px",className:"col-supplier"},{key:"categoryId",label:"Kategorie",type:"select",options:[{value:"",label:"Ohne Kategorie"},...u],width:"180px",className:"col-category"},{key:"status",label:"Status",type:"select",options:[{value:"active",label:"Aktiv"},{value:"inactive",label:"Inaktiv"}],width:"110px",className:"col-status"},{key:"abcClass",label:"ABC",type:"display",width:"80px",className:"col-abc"},{key:"completeness",label:"Vollständigkeit",type:"display",width:"160px",className:"col-completeness"},{key:"avgSellingPriceGrossEUR",label:"Ø VK-Preis (Brutto)",type:"number",decimals:2,width:"150px",className:"col-amount"},{key:"sellerboardMarginPct",label:"Sellerboard Marge (%)",type:"number",decimals:2,width:"140px",className:"col-short"},{key:"productionLeadTimeDaysDefault",label:"Default Production Lead Time (Fallback)",type:"number",decimals:0,width:"170px",className:"col-days"},{key:"moqUnits",label:"MOQ (Einheiten)",type:"number",decimals:0,width:"120px",className:"col-short col-group-end"},{key:"template.unitPriceUsd",label:"Stückpreis (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraPerUnitUsd",label:"Zusatz je Stück (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraFlatUsd",label:"Zusatz pauschal (USD)",type:"number",decimals:2,width:"140px",className:"col-amount col-group-end"},{key:"template.transportMode",label:"Transport",type:"select",options:[{value:"SEA",label:"SEA"},{value:"RAIL",label:"RAIL"},{value:"AIR",label:"AIR"}],width:"130px",className:"col-transport"},{key:"template.productionDays",label:"Produktionstage",type:"number",decimals:0,width:"120px",className:"col-days"},{key:"template.transitDays",label:"Transit-Tage",type:"number",decimals:0,width:"120px",className:"col-days col-group-end"},{key:"template.freightEur",label:"Logistik / Stk. (EUR)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.dutyPct",label:"Zoll %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatImportPct",label:"EUSt %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatRefundLag",label:"EUSt-Lag",type:"number",decimals:0,width:"80px",className:"col-short col-group-end"},{key:"template.fxRate",label:"FX-Kurs",type:"number",decimals:4,width:"140px",className:"col-amount"},{key:"template.fxFeePct",label:"FX-Gebühr %",type:"number",decimals:2,width:"90px",className:"col-short col-group-end"},{key:"template.currency",label:"Currency",type:"select",options:[{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"CNY",label:"CNY"}],width:"110px",className:"col-currency"},{key:"template.ddp",label:"DDP",type:"checkbox",width:"56px",className:"col-check col-group-end"}];function d(o){var v;const E=((v=o.template)==null?void 0:v.fields)||o.template||{};return{...l,...E}}function b(o,E){if(E.key.startsWith("template.")){const v=E.key.replace("template.","");return d(o)[v]}if(E.key==="categoryId")return o.categoryId||"";if(E.key==="abcClass")return lt(o.abcClass);if(E.key==="completeness")return Xe(o);if(E.key==="moqUnits"){const v=At(o);return v??""}return o[E.key]??""}function x(o,E){if(E.type==="number"){const v=f(o);return v==null?"":M(v,E.decimals??2)}return E.type==="display"?o:E.type==="checkbox"?!!o:o??""}function S(o,E){return E.type==="number"?f(o):E.type==="display"?o:E.type==="checkbox"?!!o:String(o??"").trim()}function U(o){return fe[o]||(fe[o]={}),fe[o]}function _(o,E){const v=fe[o];v&&(delete v[E],Object.keys(v).length||delete fe[o])}function K(){return Object.values(fe).reduce((o,E)=>o+Object.keys(E||{}).length,0)}const I=e("div",{class:"products-grid-toolbar"}),Z=e("select",{onchange:o=>{He=o.target.value,at(je,{mode:He}),X()}},[e("option",{value:"category"},["Sortierung: Kategorie"]),e("option",{value:"abc"},["Sortierung: ABC (A → C)"])]);Z.value=He;const se=e("span",{class:"muted"},["0 Änderungen"]),ge=e("button",{class:"btn",type:"button",disabled:!0},["Änderungen speichern"]),ye=e("button",{class:"btn secondary",type:"button",disabled:!0},["Änderungen verwerfen"]);I.append(Z,se,e("div",{class:"products-grid-actions"},[ye,ge]));function Ee(){const o=K();se.textContent=`${o} Änderungen`,ge.disabled=o===0,ye.disabled=o===0}function be(o){const E=!!o.querySelector("td.is-dirty");o.classList.toggle("is-dirty",E)}function J(o,E,v){var re;const j=v.type==="checkbox"?o.checked:o.value;v.type==="select"&&(o.title=((re=o.options[o.selectedIndex])==null?void 0:re.textContent)||String(j??""));const O=S(j,v),L=S(b(E,v),v),q=v.type==="number"?Number(O)!==Number(L):O!==L;if(q){const V=U(E.sku);V[v.key]=O}else _(E.sku,v.key);const A=o.closest("td");if(A){A.classList.toggle("is-dirty",q);const V=A.closest("tr");V&&be(V)}Ee(),ce.setDraft(ce.draft)}const ae=e("div",{class:"products-grid"}),Fe=e("div",{class:"products-grid-scroll ui-table-shell ui-scroll-host"}),Le=e("table",{class:"products-grid-table ui-table-standard","data-ui-table":"true","data-sticky-cols":"1"}),Pe=e("colgroup"),he=((Ke=(Ue=p==null?void 0:p.settings)==null?void 0:Ue.productsTableColumns)==null?void 0:Ke.grid)||[];s.forEach((o,E)=>{const v=Number.isFinite(he[E])?`${he[E]}px`:o.width;Pe.append(e("col",{style:v?`width:${v}`:null}))});const De=Number.isFinite(he[s.length])?`${he[s.length]}px`:"180px";Pe.append(e("col",{style:`width:${De}`}));const gt=e("thead",{},[e("tr",{class:"products-grid-group-header"},[e("th",{colspan:"10",title:"Stammdaten"},["Stammdaten"]),e("th",{colspan:"3",title:"Kosten"},["Kosten"]),e("th",{colspan:"4",title:"Logistik"},["Logistik"]),e("th",{colspan:"5",title:"Steuern"},["Steuern"]),e("th",{colspan:"3",title:"FX & Währung"},["FX & Währung"]),e("th",{colspan:"1",title:"Sonstiges"},["Sonstiges"]),e("th",{colspan:"1",title:"Tags"},["Tags"]),e("th",{colspan:"1",class:"actions",title:"Aktionen"},["Aktionen"])]),e("tr",{},[...s.map(o=>e("th",{class:o.className||"",title:o.label},[o.label])),e("th",{class:"actions",title:"Aktionen"},["Aktionen"])])]),Be=e("tbody"),Y=Ze();return ft(n,{sortMode:He}).forEach(o=>{const E=!!Y[o.id];Be.append(e("tr",{class:"product-group-row"},[e("td",{colspan:String(s.length+1)},[e("button",{class:"product-group-toggle",type:"button",dataset:{categoryId:o.id},"aria-expanded":String(!E)},[`${o.name} (${o.items.length})`])])])),!E&&o.items.forEach(v=>{const j=e("tr");s.forEach(L=>{var re,V;const q=e("td",{class:L.className||""}),A=((re=fe[v.sku])==null?void 0:re[L.key])??b(v,L);if(L.type==="display")q.append(Sn(v));else if(L.type==="checkbox"){const N=e("input",{type:"checkbox",checked:!!A,onchange:()=>J(N,v,L),title:L.label});q.append(N)}else if(L.type==="select"){const N=e("select",{onchange:()=>J(N,v,L)}),H=L.options||[],le=String(A??"");["supplierId","status","categoryId","template.transportMode","template.currency"].includes(L.key)&&(N.title=le),!H.some(Ge=>Ge.value===le)&&le&&N.append(e("option",{value:le},[le])),H.forEach(Ge=>{N.append(e("option",{value:Ge.value},[Ge.label]))}),N.value=le,N.title=((V=N.options[N.selectedIndex])==null?void 0:V.textContent)||le,q.append(N)}else{const N=e("input",{value:x(A,L),inputmode:L.type==="number"?"decimal":"text",readonly:L.readOnly?"readonly":null,title:["alias","sku","supplierId"].includes(L.key)?String(A??""):null,oninput:()=>J(N,v,L),onblur:()=>{if(L.type==="number"){const H=f(N.value);N.value=H==null?"":M(H,L.decimals??2)}}});if(L.key==="alias"){const H=yn(v.sku);H&&q.append(H)}q.append(N)}if(L.type!=="display"){const N=S(b(v,L),L),H=S(A,L);(L.type==="number"?Number(H)!==Number(N):H!==N)&&q.classList.add("is-dirty")}j.append(q)});const O=e("td",{class:"actions"},[e("button",{class:"btn secondary",type:"button",onclick:()=>Me(v)},["Bearbeiten"]),e("button",{class:"btn tertiary",type:"button",onclick:()=>Kt(v)},["Historie"])]);j.append(O),be(j),Be.append(j)})}),Le.append(Pe,gt,Be),Ln(Le,{key:"grid",colgroup:Pe,widths:he}),Fe.append(Le),ae.append(I,Fe),Ee(),Le.addEventListener("click",o=>{const E=o.target.closest(".product-group-toggle");if(!E)return;const v=Ze(),j=E.dataset.categoryId;v[j]=!v[j],mt(v),X()}),ye.addEventListener("click",()=>{ce.resetDraft(),X()}),ge.addEventListener("click",async()=>{const o=Object.entries(fe);if(!o.length)return;const E=[];await Promise.allSettled(o.map(([v,j])=>{var re;const O=Bn(v);if(!O)return E.push(v),Promise.resolve();const L=Object.keys(j).some(V=>V.startsWith("template.")),q=L?d(O):null,A={sku:O.sku,alias:O.alias,supplierId:O.supplierId,categoryId:O.categoryId??null,status:O.status,tags:Array.isArray(O.tags)?[...O.tags]:[],template:O.template?{...O.template}:null,avgSellingPriceGrossEUR:O.avgSellingPriceGrossEUR??null,sellerboardMarginPct:O.sellerboardMarginPct??null,originalSku:O.sku};Object.entries(j).forEach(([V,N])=>{if(V.startsWith("template.")){const H=V.replace("template.","");A.template||(A.template={scope:"SKU",name:"Standard (SKU)",fields:{}}),A.template.fields||(A.template.fields={...q}),A.template.fields[H]=N}else V==="categoryId"?A.categoryId=N?String(N):null:A[V]=N}),L&&((re=A.template)!=null&&re.fields)&&q&&(A.template.fields={...q,...A.template.fields});try{an(A)}catch{E.push(v)}})),E.length?_e(`Fehler bei SKUs: ${E.join(", ")}`):_e("Änderungen gespeichert"),ce.resetDraft(),X()}),ae}function Kt(n){const i=Lt(),c=mn(i,n.sku),l=e("button",{class:"btn",type:"button"},["Schließen"]),y=pn({title:`Historie – ${n.alias||n.sku}`,content:c,actions:[l],onClose:()=>{}});l.addEventListener("click",()=>y.overlay.remove())}function X(){const n=r.querySelector('input[type="search"]'),i=document.activeElement===n,c=i?n.selectionStart:null;typeof r.__productsListScrollCleanup=="function"&&(r.__productsListScrollCleanup(),r.__productsListScrollCleanup=null),r.__productsListReactRoot&&(r.__productsListReactRoot.unmount(),r.__productsListReactRoot=null),r.innerHTML="";const l=hn(P,G,ke,Ne),y=P.filter(I=>I.alias.startsWith("Ohne Alias")).length,h=e("div",{class:"products-header ui-page-head"}),u=e("h2",{},["Produkte"]),s=e("div",{class:"products-actions"}),d=e("button",{class:"btn",type:"button",onclick:()=>Me(null)},["+ Produkt anlegen"]),b=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!1),X()}},["Alles auf"]),x=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!0),X()}},["Alles zu"]),S=e("input",{type:"search",placeholder:"Suche nach Alias, SKU, Supplier",value:G,oninput:I=>{G=I.target.value,X()}}),U=e("select",{class:"products-completeness-filter",onchange:I=>{ke=I.target.value,at(me,{filter:ke}),X()}},[e("option",{value:"all"},["Alle Vollständigkeiten"]),e("option",{value:"blocked"},["Nur Blockierte"]),e("option",{value:"warn"},["Nur Warnungen"]),e("option",{value:"ok"},["Nur Vollständige"])]);U.value=ke==="warning"?"warn":ke;const _=e("select",{class:"products-abc-filter",onchange:I=>{Ne=I.target.value,at(xe,{filter:Ne}),X()}},[e("option",{value:"all"},["ABC: Alle"]),...Dt.map(I=>e("option",{value:I},[`ABC: ${I}`]))]);_.value=Ne;const K=e("div",{class:"view-toggle"},[e("button",{type:"button",class:`btn tertiary${Q==="list"?" is-active":""}`,"aria-pressed":Q==="list",onclick:()=>{Q="list",ln("productsView",Q),X()}},["Liste"]),e("button",{type:"button",class:`btn tertiary${Q==="table"?" is-active":""}`,"aria-pressed":Q==="table",onclick:()=>{Q="table",ln("productsView",Q),X()}},["Tabelle"])]);s.append(S,U,_,b,x,K,d),h.append(u,s),r.append(h),y&&r.append(e("div",{class:"banner info"},[`${y} Produkte ohne Alias – bitte ergänzen.`])),r.append(Q==="table"?Pn(l):xn(l)),i&&(S.focus(),c!=null&&S.setSelectionRange(c,c))}X()}function ms(r){const p=()=>We(r);return r.__productsCleanup&&r.__productsCleanup(),document.addEventListener("state:changed",p),r.__productsCleanup=()=>{typeof r.__productsListScrollCleanup=="function"&&(r.__productsListScrollCleanup(),r.__productsListScrollCleanup=null),r.__productsListReactRoot&&(r.__productsListReactRoot.unmount(),r.__productsListReactRoot=null),document.removeEventListener("state:changed",p),r.__productsActionsCleanup&&(r.__productsActionsCleanup(),r.__productsActionsCleanup=null),r.__productsBulkGuard&&(r.__productsBulkGuard.unregister(),r.__productsBulkGuard.detachBeforeUnload(),r.__productsBulkGuard=null)},We(r),{cleanup:r.__productsCleanup}}export{ms as default};
