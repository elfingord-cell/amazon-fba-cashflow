import{l as q,g as G}from"./index-LScGhqvu.js";import{g as Y,b as Q}from"./orderEditorFactory-C4uOMHHG.js";import{f as Z}from"./prefill-DQYhMWuT.js";import"./store-kRkpVkNt.js";import"./dateUtils-D7NmXfd-.js";import"./productCompleteness-CNGcv3R4.js";import"./useDraftForm-opmY9Ns9.js";function s(e,t={},n=[]){const a=document.createElement(e);return Object.entries(t).forEach(([l,c])=>{l==="class"?a.className=c:l.startsWith("on")&&typeof c=="function"?a.addEventListener(l.slice(2),c):c!=null&&a.setAttribute(l,c)}),(Array.isArray(n)?n:[n]).forEach(l=>{l!=null&&a.append(l.nodeType?l:document.createTextNode(String(l)))}),a}function $(e){return String(e||"").trim().toLowerCase()}function L(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function B(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?"—":t.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function U(e){if(e==null||e==="")return"—";const t=Number(e);return Number.isFinite(t)?`${Z(t,2)} EUR`:"—"}function x(e){if(e==null||e==="")return"";const t=Number(e);return Number.isFinite(t)?Z(t,2):""}function X(e,t,n=";"){const a=o=>`"${(o==null?"":String(o)).replace(/"/g,'""')}"`,l=t.map(o=>a(o.label)).join(n),c=e.map(o=>t.map(p=>a(o[p.key])).join(n)).join(`
`);return`${l}
${c}`}function R(e){const t=new Map;return(e.suppliers||[]).forEach(n=>{if(!n)return;const a=String(n.name||"").trim();if(!a)return;const l=$(n.id),c=$(a);l&&t.set(l,a),c&&t.set(c,a)}),t}function j(e,t){const n=e.supplierName||e.supplier||"",a=$(e.supplierId||e.supplier||e.supplierName||"");return t.get(a)||(n?String(n):"—")}function w(e){const t=new Map;return(e||[]).forEach(n=>{const a=$(n==null?void 0:n.sku);a&&t.set(a,(n==null?void 0:n.alias)||(n==null?void 0:n.sku)||"")}),t}function tt(e,t){const n=Array.isArray(e==null?void 0:e.items)?e.items.filter(Boolean):[],a=n.length?n.map(c=>c==null?void 0:c.sku).filter(Boolean):[e==null?void 0:e.sku];return Array.from(new Set(a.map(c=>{const o=$(c);return o?t.get(o)||c:null}).filter(Boolean))).join(", ")||"—"}function z({label:e,eventType:t}){const n=String(e||"").toLowerCase();return t==="fx_fee"||n.includes("fx")?null:t==="freight"||n.includes("shipping")||n.includes("fracht")?"Fracht":t==="eust"||n.includes("eust")?"EUSt":n.includes("balance2")||n.includes("balance 2")||n.includes("second balance")?"Balance2":n.includes("balance")||n.includes("rest")?"Balance":n.includes("deposit")||n.includes("anzahlung")?"Deposit":null}function H(e,t=[]){const n=t.map(p=>Number(p.plannedEur||0)),a=n.reduce((p,h)=>p+h,0);if(!Number.isFinite(a)||a<=0)return null;const l=n.map((p,h)=>{const f=p/a,i=e*f;return{eventId:t[h].id,planned:p,raw:i,actual:Math.round(i*100)/100}}),c=l.reduce((p,h)=>p+h.actual,0),o=Math.round((e-c)*100)/100;if(Math.abs(o)>0){let p=l[l.length-1];l.length>1&&(p=l.reduce((h,f)=>f.planned>h.planned?f:h,p)),p.actual=Math.round((p.actual+o)*100)/100}return l}function et(e=[]){const t=new Map,n=new Map;return(e||[]).forEach(a=>{a!=null&&a.id&&(t.set(a.id,a),Array.isArray(a.allocations)&&a.allocations.forEach(l=>{l!=null&&l.eventId&&n.set(l.eventId,l)}))}),{byId:t,allocationByEvent:n}}function nt({payment:e,paymentRow:t,paymentRows:n}){if(!e||!(t!=null&&t.paymentId))return null;const a=Number(e.amountActualEurTotal);if(!Number.isFinite(a))return null;const l=(n||[]).filter(o=>o.paymentId&&o.paymentId===t.paymentId);if(!l.length)return null;const c=H(a,l);return c&&c.find(o=>o.eventId===t.id)||null}function C(e){const t=e.status==="PAID"?e.paidDate:e.dueDate;return t?t.slice(0,7):""}function S(e,t){if(!Number.isFinite(Number(e)))return!1;const n=Number(e),a=Number.isFinite(Number(t))?Number(t):null;return n>0||n===0&&a!=null&&a===0}function at({row:e,paymentRow:t,paymentRows:n,paymentRecord:a,paymentIndexes:l,state:c}){var p,h;const o=[];if(e.status!=="PAID")return{amountActualEur:null,issues:o};if(e.paidDate||o.push("PAID_WITHOUT_DATE"),Number.isFinite(Number(t==null?void 0:t.paidEurActual)))return S(t.paidEurActual,e.amountPlannedEur)?{amountActualEur:Number(t.paidEurActual),issues:o}:(o.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:Number(t.paidEurActual),issues:o});if((p=a==null?void 0:a.allocations)!=null&&p.length){const f=a.allocations.find(i=>{if(!i)return!1;if(i.eventId&&(t!=null&&t.id)&&i.eventId===t.id||i.plannedId&&(t!=null&&t.id)&&i.plannedId===t.id)return!0;if(i.entityType&&i.paymentType){const v=String(i.paymentType)===String(e.paymentType),g=String(i.entityType)===String(e.entityType),T=String(i.poNumber||"")===String(e.poNumber||"");return v&&g&&T}return!1});if(f&&S(f.amountEur,e.amountPlannedEur))return{amountActualEur:Number(f.amountEur),issues:o}}if(a&&(t!=null&&t.paymentId)){const f=((h=l==null?void 0:l.allocationByEvent)==null?void 0:h.get(t.id))||nt({payment:a,paymentRow:t,paymentRows:n});if(f&&S(f.actual,e.amountPlannedEur))return o.push("PRO_RATA_ALLOCATION"),{amountActualEur:Number(f.actual),issues:o};if(S(a.amountActualEurTotal,e.amountPlannedEur)&&(n==null?void 0:n.length)===1)return{amountActualEur:Number(a.amountActualEurTotal),issues:o}}if(!(t!=null&&t.paymentId)&&e.paidDate&&(t!=null&&t.id)){const f=(c.payments||[]).find(i=>!i||i.paidDate!==e.paidDate?!1:!!(Array.isArray(i.coveredEventIds)&&i.coveredEventIds.includes(t.id)));if(f&&S(f.amountActualEurTotal,e.amountPlannedEur))return{amountActualEur:Number(f.amountActualEurTotal),issues:o}}return o.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:null,issues:o}}function _({month:e,scope:t}){const n=q(),a=Y(),l=G(),c=R(n),o=w(l),p=Array.isArray(n.pos)?n.pos:[],h=Array.isArray(n.fos)?n.fos:[],f=et(n.payments||[]),i=[],v={entityLabel:"PO",numberField:"poNo"};p.forEach(r=>{if(!r)return;const E=j(r,c),u=tt(r,o),m=JSON.parse(JSON.stringify(r)),A=Q(m,v,a,n.payments||[]);A.forEach(d=>{const y=z({label:d.typeLabel||d.label,eventType:d.eventType});if(!y)return;const I=d.paymentId?f.byId.get(d.paymentId):null,D=d.status==="paid"||d.status==="PAID"?"PAID":"OPEN",N=d.dueDate||"",k=(I==null?void 0:I.paidDate)||d.paidDate||"",P=Number.isFinite(Number(d.plannedEur))?Number(d.plannedEur):null,O=`PO-${r.id||r.poNo||""}-${y}-${N||k||""}`,F={rowId:O,eventId:d.id,month:C({status:D,dueDate:N,paidDate:k}),entityType:"PO",poNumber:r.poNo||"",foNumber:"",supplierName:E,skuAliases:u,paymentType:y,status:D,dueDate:N,paidDate:k,paymentId:d.paymentId||"",amountPlannedEur:P,payer:d.paidBy||"",paymentMethod:d.method||"",note:d.note||"",internalId:d.paymentInternalId||d.id||r.id||O},{amountActualEur:W,issues:J}=at({row:F,paymentRow:d,paymentRows:A,paymentRecord:I,paymentIndexes:f,state:n});i.push({...F,amountActualEur:W,issues:J})})}),h.forEach(r=>{if(!r||!Array.isArray(r.payments))return;const E=j(r,c),u=r.sku?o.get($(r.sku))||r.sku:"—",m=Number(r.fxRate||0);r.payments.forEach(A=>{if(!A||A.category==="eust_refund")return;const d=z({label:A.label,eventType:A.category});if(!d)return;const y=Number(A.amount||0);if(!Number.isFinite(y)||y<=0)return;const D=(A.currency||"EUR")==="EUR"?y:m>0?y/m:y,N=A.dueDate||"",P=`FO-${r.id||r.foNumber||""}-${d}-${N||""}`;i.push({rowId:P,eventId:A.id||P,month:C({status:"OPEN",dueDate:N,paidDate:""}),entityType:"FO",poNumber:r.convertedPoNo||"",foNumber:r.foNumber||r.id||"",supplierName:E,skuAliases:u,paymentType:d,status:"OPEN",dueDate:N,paidDate:"",paymentId:"",amountPlannedEur:D,amountActualEur:null,payer:"",paymentMethod:"",note:"",internalId:r.id||P,issues:[]})})});const g=t||"both",T=i.filter(r=>!(g==="paid"&&r.status!=="PAID"||g==="open"&&r.status!=="OPEN"||e&&r.month!==e)),M=[],b=new Set;return T.forEach(r=>{b.has(r.rowId)||(b.add(r.rowId),M.push(r))}),M.sort((r,E)=>{const u=r.dueDate||r.paidDate||"",m=E.dueDate||E.paidDate||"";return u.localeCompare(m)})}function st(e){return e.map(t=>{var n;return{month:t.month||"",entityType:t.entityType,poNumber:t.poNumber,foNumber:t.foNumber,supplierName:t.supplierName,skuAliases:t.skuAliases,paymentType:t.paymentType,status:t.status,dueDate:t.dueDate,paidDate:t.paidDate,amountPlannedEur:x(t.amountPlannedEur),amountActualEur:t.status==="PAID"?x(t.amountActualEur):"",issues:(n=t.issues)!=null&&n.length?t.issues.join("|"):"",paymentId:t.paymentId||"",payer:t.payer,paymentMethod:t.paymentMethod,note:t.note,internalId:t.internalId}})}function V(e,t){return e.reduce((n,a)=>n+(Number(a[t])||0),0)}let K=!1;function ut(){if(K)return;K=!0;const e=[{id:"dep",plannedEur:3e3,dueDate:"2025-01-10",status:"open"},{id:"bal",plannedEur:7e3,dueDate:"2025-02-10",status:"open"}],t=H(9500,e)||[],n=t.reduce((l,c)=>l+Number(c.actual||0),0);console.assert(Math.round(n*100)/100===9500,"Allocation sum should match total");const a=t.find(l=>l.eventId==="dep");console.assert(a&&Math.round(a.actual*100)/100===2850,"Deposit allocation should be proportional"),console.assert(e[0].plannedEur===3e3&&e[1].plannedEur===7e3,"Planned values should remain unchanged")}function lt(e,{month:t,scope:n}){const a=window.open("","_blank","noopener,noreferrer");if(!a)return;const l=n==="paid"?"Paid":n==="open"?"Open":"Both",c=`Zahlungsjournal ${t||""}`.trim(),o=V(e.filter(i=>i.status==="PAID"),"amountActualEur"),p=V(e.filter(i=>i.status==="OPEN"),"amountPlannedEur"),h=e.map(i=>{var v;return`
    <tr>
      <td>${i.entityType}</td>
      <td>${i.entityType==="PO"?i.poNumber:i.foNumber}</td>
      <td>${i.supplierName}</td>
      <td>${i.paymentType}</td>
      <td>${i.status}</td>
      <td>${i.dueDate||""}</td>
      <td>${i.paidDate||""}</td>
      <td>${i.status==="PAID"?x(i.amountActualEur):""}</td>
      <td>${(v=i.issues)!=null&&v.length?i.issues.join(" | "):""}</td>
      <td>${i.paymentId||""}</td>
      <td>${i.paymentMethod||""}</td>
      <td>${i.payer||""}</td>
    </tr>
  `}).join(""),f=`<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>${c}</title>
  <style>
    body { font-family: "Inter", "Helvetica Neue", Arial, sans-serif; color: #0f1b2d; margin: 24px; }
    h1 { font-size: 20px; margin-bottom: 4px; }
    .summary { margin-bottom: 12px; font-size: 12px; color: #6b7280; }
    .actions { margin-bottom: 16px; }
    .btn { background: #3bc2a7; color: #fff; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { border: 1px solid #d7dde5; padding: 6px 8px; text-align: left; vertical-align: top; }
    th { background: #f4f7fa; font-weight: 600; }
    .totals { margin-top: 12px; font-size: 12px; }
    @media print {
      body { margin: 12mm; }
      .actions { display: none; }
      @page { size: A4; margin: 12mm; }
    }
  </style>
</head>
<body>
  <h1>${c}</h1>
  <div class="summary">Scope: ${l} · Rows: ${e.length}</div>
  <div class="actions"><button class="btn" onclick="window.print()">Drucken / Als PDF speichern</button></div>
  <table>
    <thead>
      <tr>
        <th>Typ</th>
        <th>PO/FO Nr</th>
        <th>Supplier</th>
        <th>PaymentType</th>
        <th>Status</th>
        <th>DueDate</th>
        <th>PaidDate</th>
        <th>Ist EUR</th>
        <th>Issues</th>
        <th>PaymentId</th>
        <th>Methode</th>
        <th>Zahler</th>
      </tr>
    </thead>
    <tbody>
      ${h}
    </tbody>
  </table>
  <div class="totals">
    <div>Sum Actual EUR (PAID): ${x(o)}</div>
    <div>Sum Planned EUR (OPEN): ${x(p)}</div>
  </div>
</body>
</html>`;a.document.open(),a.document.write(f),a.document.close()}function it(e){const t=s("input",{type:"month",value:L()}),n=[{value:"paid",label:"Paid"},{value:"open",label:"Open"},{value:"both",label:"Both"}],a=[{value:"csv",label:"CSV"},{value:"print",label:"PDF (Print)"}];function l(b,r,E){const u=s("div",{class:"segment-control"});return r.forEach(m=>{const A=s("input",{type:"radio",name:b,value:m.value,id:`${b}-${m.value}`});m.value===E&&(A.checked=!0);const d=s("label",{for:`${b}-${m.value}`},[m.label]);u.append(A,d)}),u}const c=l("payment-scope",n,"both"),o=l("payment-format",a,"csv"),p=s("table",{class:"table payments-export-table","data-ui-table":"true"}),h=s("thead",{},[s("tr",{},[s("th",{},["Monat"]),s("th",{},["Typ"]),s("th",{},["PO/FO Nr"]),s("th",{},["Supplier"]),s("th",{},["SKU Alias"]),s("th",{},["Payment Type"]),s("th",{},["Status"]),s("th",{},["Fällig"]),s("th",{},["Bezahlt"]),s("th",{class:"num"},["Soll EUR"]),s("th",{class:"num"},["Ist EUR"]),s("th",{},["Issues"]),s("th",{},["Payment ID"]),s("th",{},["Zahler"]),s("th",{},["Methode"]),s("th",{},["Notiz"])])]),f=s("tbody");p.append(h,f);function i(){const b=c.querySelector("input:checked");return b?b.value:"both"}function v(){const b=o.querySelector("input:checked");return b?b.value:"csv"}function g(){f.innerHTML="";const b=t.value||"",r=i(),E=_({month:b,scope:r});return ut(),E.forEach(u=>{if(u.status==="PAID"&&Number.isFinite(Number(u.amountActualEur))){const m=Number.isFinite(Number(u.amountPlannedEur))?Number(u.amountPlannedEur):null;(m==null||m>0)&&console.assert(Number(u.amountActualEur)>0,"Paid rows should not have 0 actual amounts")}}),E.length?(E.forEach(u=>{var N;const m=S(u.amountActualEur,u.amountPlannedEur),A=m?U(u.amountActualEur):"—",d=(N=u.issues)!=null&&N.length?u.issues.join(" | "):"",y=u.status==="PAID"&&!m,I=u.entityType==="PO"?u.poNumber||"—":u.foNumber||"—",D=[`${u.entityType}: ${I}`,u.skuAliases?`Alias: ${u.skuAliases}`:"",u.supplierName?`Supplier: ${u.supplierName}`:"",u.paymentType?`Payment: ${u.paymentType}`:""].filter(Boolean).join(`
`);f.append(s("tr",{},[s("td",{},[u.month||"—"]),s("td",{},[u.entityType]),s("td",{"data-ui-tooltip":D},[I]),s("td",{},[u.supplierName]),s("td",{"data-ui-tooltip":u.skuAliases||"—"},[u.skuAliases]),s("td",{},[u.paymentType]),s("td",{},[u.status==="PAID"?"Bezahlt":"Offen"]),s("td",{},[B(u.dueDate)]),s("td",{},[B(u.paidDate)]),s("td",{class:"num"},[U(u.amountPlannedEur)]),s("td",{class:"num"},[u.status==="PAID"?A:"—",y?s("span",{class:"cell-warning",title:"Bezahlt, aber keine Ist-Zahlung zugeordnet"},["⚠︎"]):null]),s("td",{},[d||"—"]),s("td",{},[u.paymentId||"—"]),s("td",{},[u.payer||"—"]),s("td",{},[u.paymentMethod||"—"]),s("td",{},[u.note||"—"])]))}),E):(f.append(s("tr",{},[s("td",{colspan:"16",class:"muted"},["Keine Zahlungen gefunden."])])),E)}const T=s("button",{class:"btn primary",type:"button"},["Export"]),M=s("button",{class:"btn secondary",type:"button"},["Preview"]);T.addEventListener("click",()=>{const b=t.value||"",r=i(),E=_({month:b,scope:r});if(!E.length){window.alert("Keine passenden Zahlungen für den Export gefunden.");return}if(v()==="print"){lt(E,{month:b,scope:r});return}const m=[{key:"month",label:"month"},{key:"entityType",label:"entityType"},{key:"poNumber",label:"poNumber"},{key:"foNumber",label:"foNumber"},{key:"supplierName",label:"supplierName"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"status",label:"status"},{key:"dueDate",label:"dueDate"},{key:"paidDate",label:"paidDate"},{key:"amountPlannedEur",label:"amountPlannedEur"},{key:"amountActualEur",label:"amountActualEur"},{key:"issues",label:"issues"},{key:"paymentId",label:"paymentId"},{key:"payer",label:"payer"},{key:"paymentMethod",label:"paymentMethod"},{key:"note",label:"note"},{key:"internalId",label:"internalId"}],A=st(E),d=X(A,m,";"),y=r||"both",D=`payment_journal_${b||L()}_${y}.csv`,N=new Blob([d],{type:"text/csv"}),k=URL.createObjectURL(N),P=s("a",{href:k,download:D});document.body.append(P),P.click(),P.remove(),URL.revokeObjectURL(k)}),M.addEventListener("click",()=>{g()}),t.addEventListener("change",g),c.addEventListener("change",g),e.innerHTML="",e.append(s("section",{class:"card"},[s("h2",{},["Payment Exports"]),s("div",{class:"payments-export-toolbar"},[s("div",{class:"payments-export-filters"},[s("label",{class:"payments-export-field"},[s("span",{},["Monat"]),t]),s("div",{class:"payments-export-field"},[s("span",{},["Scope"]),c]),s("div",{class:"payments-export-field"},[s("span",{},["Format"]),o])]),s("div",{class:"payments-export-actions"},[T,M])]),p])),g()}const bt={render:it};export{bt as default,it as render};
