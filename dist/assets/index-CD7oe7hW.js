import{p as Xt,I as Jt,t as g,k as e,J as es,K as $,T as Pe,L as b,S as fe,M as ve,R as Mt,N as xe,O as At,P as rt}from"./index-DrOkdIyL.js";import{E as ts}from"./index-rKZEcphe.js";import{c as ss}from"./cashflow-LLmd6-JE.js";import{T as ns}from"./TanStackGrid-DNQbnxKh.js";import{b as rs}from"./dashboardMaturity-CwXMJyUs.js";import{b as Et}from"./abcClassification-CaF87ldU.js";import{c as lt}from"./inventoryProjection-BSwUHpBo.js";import{c as We,a as It,m as os,n as as,b as Ue,f as ue}from"./months-DiLwPhVv.js";import{e as is}from"./productCompletenessV2-wFpo7RYV.js";import{e as ls,g as cs}from"./forecastVersioning-CgxN5ixE.js";import{u as us,C as K}from"./workspace-hSJpURcw.js";import{h as ds,g as hs,s as ms}from"./uiPrefs-CxTlE9qM.js";import{s as fs}from"./index-f0YJWE_y.js";import{C as ae}from"./Collapse-BrChyUuB.js";import{S as ot}from"./index-Bs0NWQOM.js";import{S as ge}from"./index-BKZNtPIy.js";import{R as Ft}from"./InfoCircleOutlined-BQt5nQVr.js";import{F as gs}from"./Table-DZmxMdD5.js";import{T as ps}from"./index-D1FgTqkK.js";import"./planProducts-CpwZ2WgY.js";import"./Dropdown-QmF6_rIx.js";import"./index-CwWsayj4.js";import"./useBubbleLock-BNNYgWjU.js";import"./index-D-YTDARI.js";import"./Pagination-DA_hDQym.js";function Ze(t){return String(t||"").trim()}function je(t){return Ze(t).toLowerCase()}function bs(t){if(typeof t.active=="boolean")return t.active;const n=String(t.status||"").trim().toLowerCase();return n?n==="active"||n==="aktiv":!0}function vs(t){return/^\d{4}-\d{2}$/.test(String(t||""))}function Kt(t){return t!=null&&String(t).trim()!==""}function $e(t){const n=Xt(t);return Number.isFinite(n)?Number(n):null}function $t(t,n){const r=t.get(n),o=t.get(je(n)),i=String((r==null?void 0:r.abcClass)||(o==null?void 0:o.abcClass)||"C").toUpperCase();return i==="A"||i==="B"||i==="C"?i:"C"}function xs(t,n){const o=(Array.isArray(t.incomings)?t.incomings:[]).find(v=>String(v.month||"")===n);if(o){const v=$e(o.revenueEur),x=$e(o.payoutPct);if(Number.isFinite(v)||Number.isFinite(x))return!0}const a=(t.monthlyActuals&&typeof t.monthlyActuals=="object"?t.monthlyActuals:{})[n];return a?Number.isFinite($e(a.realRevenueEUR))||Number.isFinite($e(a.realPayoutRatePct)):!1}function ys(t){const n=t.settings&&typeof t.settings=="object"?t.settings:{},r=n.vatPreview&&typeof n.vatPreview=="object"?n.vatPreview:{},o=t.vatPreviewMonths&&typeof t.vatPreviewMonths=="object"?t.vatPreviewMonths:{};return{active:[r.deShareDefault,r.feeRateDefault,r.fixInputDefault,r.feeRateOfGrossDefault,r.fixInputVatDefault].some(Kt),defaults:r,monthOverrides:o}}function js(t,n){if(!t.active)return!0;const r=t.monthOverrides[n]&&typeof t.monthOverrides[n]=="object"?t.monthOverrides[n]:{};return[t.defaults.deShareDefault,t.defaults.feeRateDefault,t.defaults.fixInputDefault,t.defaults.feeRateOfGrossDefault,t.defaults.fixInputVatDefault,r.deShare,r.feeRateOfGross,r.fixInputVat].some(Kt)}function ks(t,n){const r=Et(t).bySku,o=[],i=[];return n.forEach(a=>{const v=Ze(a.sku);if(!v)return;const x=String(a.alias||v),m=$t(r,v),w={sku:v,alias:x,abcClass:m},f=$e(a.avgSellingPriceGrossEUR);(!Number.isFinite(f)||Number(f)<=0)&&o.push(w);const h=is({product:a,state:t});(h==null?void 0:h.status)==="blocked"&&i.push(w)}),{missingPrice:o,blockedCompleteness:i}}function Ss(t){const n=t.months.reduce((x,m)=>x+m.coverage.missingForecastSkus.length,0),r=t.months.reduce((x,m)=>x+m.coverage.safetyRiskSkus.length,0),o=t.months.filter(x=>{const m=x.checks.find(w=>w.key==="cash_in");return m&&!m.passed}).length,i=t.months.filter(x=>{const m=x.checks.find(w=>w.key==="vat");return m&&!m.passed}).length,a=[];n>0&&a.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${n} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:n,impact:"Kontostand nicht belastbar"}),r>0&&a.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${r} SKU-Monat(e) unter Safety.`,severity:"error",route:"/v2/inventory/projektion",count:r,impact:"Stockout-Risiko in A/B möglich"}),o>0&&a.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${o} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:o,impact:"Kontostand-Projektion instabil"}),t.hasFixcostBasis||a.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:t.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),t.vatActive&&i>0&&a.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${i} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:i,impact:"Outflow-Bild unvollständig"}),t.revenueIssueSkus>0&&a.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${t.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:t.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const v=x=>x==="error"?2:1;return a.sort((x,m)=>{const w=v(m.severity)-v(x.severity);if(w!==0)return w;const f=m.count-x.count;return f!==0?f:x.title.localeCompare(m.title)}),a.slice(0,5)}function Ot(t){const n=Array.from(new Set((Array.isArray(t.months)?t.months:[]).filter(vs))).sort(),r=t.state||{},i=(Array.isArray(r.products)?r.products:[]).map(c=>c||{}).filter(c=>Ze(c.sku)).filter(bs),a=i.length,v=Array.isArray(r.fixcosts)&&r.fixcosts.length>0,x=ys(r),m=ks(r,i),w=new Set(m.missingPrice.map(c=>je(c.sku))),f=We(),h=n.filter(c=>c<f),N=n.filter(c=>c>=f),I={perSkuMonth:new Map},O=h.length?lt({state:r,months:h,products:i,snapshot:null,snapshotMonth:h[0]||void 0,projectionMode:"units"}):I,L=N.length?lt({state:r,months:N,products:i,snapshot:null,snapshotMonth:It(f,-1),projectionMode:"units"}):I,X=Et(r).bySku,C=n.map(c=>{const U=[],T=[];let H=0;i.forEach(u=>{const R=Ze(u.sku);if(!R)return;const k=String(u.alias||R),se=$t(X,R),ne=c<f?O:L,y=ne.perSkuMonth.get(R)||ne.perSkuMonth.get(je(R)),D=y==null?void 0:y.get(c),Ee=!!(D!=null&&D.hasForecast);if(Ee&&!!(D!=null&&D.isCovered)){H+=1;return}const ze={sku:R,alias:k,abcClass:se};if(!Ee){U.push(ze);return}T.push(ze)});const W=a>0&&U.length===0&&T.length===0&&H===a,F=xs(r,c),be=v,_=js(x,c),te=m.missingPrice.length===0&&m.blockedCompleteness.length===0,me=[],Z=u=>{me.push({id:`${u.checkKey}:${u.month}:${me.length}`,...u})};W||(a===0&&Z({month:c,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"}),U.slice(0,20).forEach(u=>{Z({month:c,checkKey:"sku_coverage",severity:"error",message:`${u.sku} (${u.alias}): Forecast fehlt.`,sku:u.sku,alias:u.alias,route:"/v2/forecast"})}),U.length>20&&Z({month:c,checkKey:"sku_coverage",severity:"error",message:`+ ${U.length-20} weitere SKU(s) ohne Forecast.`,route:"/v2/forecast"}),T.slice(0,20).forEach(u=>{Z({month:c,checkKey:"sku_coverage",severity:"error",message:`${u.sku} (${u.alias}): unter Safety (${u.abcClass}).`,sku:u.sku,alias:u.alias,route:"/v2/inventory/projektion"})}),T.length>20&&Z({month:c,checkKey:"sku_coverage",severity:"error",message:`+ ${T.length-20} weitere SKU(s) unter Safety.`,route:"/v2/inventory/projektion"})),F||Z({month:c,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),be||Z({month:c,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),_||Z({month:c,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),te||(m.missingPrice.slice(0,20).forEach(R=>{Z({month:c,checkKey:"revenue_inputs",severity:"error",message:`${R.sku} (${R.alias}): Ø VK-Preis fehlt.`,sku:R.sku,alias:R.alias,route:"/v2/products"})}),m.blockedCompleteness.filter(R=>!w.has(je(R.sku))).slice(0,20).forEach(R=>{Z({month:c,checkKey:"revenue_inputs",severity:"error",message:`${R.sku} (${R.alias}): Stammdaten unvollständig.`,sku:R.sku,alias:R.alias,route:"/v2/products"})}));const Re=[{key:"sku_coverage",label:"SKU-Coverage 100%",status:W?"ok":"error",passed:W,detail:`${H}/${a} abgedeckt · Forecast fehlt ${U.length} · Safety ${T.length}`,blockerCount:U.length+T.length+(a===0?1:0),route:U.length>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:F?"ok":"error",passed:F,detail:F?"vorhanden":"fehlend",blockerCount:F?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:be?"ok":"error",passed:be,detail:be?"vorhanden":"fehlend",blockerCount:be?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:_?"ok":"error",passed:_,detail:x.active?_?"vorhanden":"fehlend":"nicht aktiv",blockerCount:_?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:te?"ok":"error",passed:te,detail:te?"vollständig":`${m.missingPrice.length} ohne Preis · ${m.blockedCompleteness.length} unvollständig`,blockerCount:te?0:m.missingPrice.length+m.blockedCompleteness.length,route:"/v2/products"}],B=Re.every(u=>u.passed),ke=new Set(T.filter(u=>u.abcClass==="A"||u.abcClass==="B").map(u=>je(u.sku)));return{month:c,robust:B,checks:Re,blockers:me,blockerCount:me.length,coverage:{activeSkus:a,coveredSkus:H,ratio:a?H/a:0,missingForecastSkus:U.map(u=>u.sku),safetyRiskSkus:T.map(u=>u.sku),abRiskSkuCount:ke.size}}}),G=new Map;C.forEach(c=>G.set(c.month,c));const J=C.filter(c=>c.robust).length;let ee=null;for(let c=0;c<C.length&&C[c].robust;c+=1)ee=C[c].month;const he=new Set([...m.missingPrice.map(c=>je(c.sku)),...m.blockedCompleteness.map(c=>je(c.sku))]).size;return{months:C,monthMap:G,actions:Ss({months:C,hasFixcostBasis:v,vatActive:x.active,revenueIssueSkus:he}),robustUntilMonth:ee,robustMonthsCount:J,totalMonths:C.length,activeSkuCount:a}}function Ge(t){if(!t)return null;const n=new Date(String(t));return Number.isNaN(n.getTime())?null:n}function Ns(t){if(typeof t.active=="boolean")return t.active;const n=String(t.status||"").trim().toLowerCase();return n?n==="active"||n==="aktiv"||n==="prelaunch"||n==="not_launched"||n==="planned":!0}function ct(t){return String(t||"").trim()}function Cs(t){return(Array.isArray(t.products)?t.products:[]).filter(r=>ct(r.sku)?Ns(r):!1).map(r=>({sku:ct(r.sku),alias:String(r.alias||r.sku||""),status:String(r.status||"active"),safetyStockDohOverride:r.safetyStockDohOverride,foCoverageDohOverride:r.foCoverageDohOverride}))}function Ms(t){const n=t.lastDriftSummary&&typeof t.lastDriftSummary=="object"?t.lastDriftSummary:{},r=typeof n.comparedAt=="string"?n.comparedAt:null;return r&&Ge(r)?r:null}function As(t){return{id:`gate:${t.key}`,key:t.key,severity:"error",label:t.label,message:t.detail,route:t.route}}function Ds(t){const n=t.state||{},r=Number.isFinite(t.horizonMonths)?Math.max(1,Math.round(Number(t.horizonMonths))):12,o=os(We(),r),i=Ot({state:n,months:o}),a=i.robustMonthsCount>=o.length&&o.length>0,v=Cs(n),x=lt({state:n,months:o,products:v,snapshot:null,snapshotMonth:It(We(),-1),projectionMode:"units"}),m=Array.isArray(x.anchorSkuMissingHistory)?x.anchorSkuMissingHistory.map(W=>ct(W)).filter(Boolean).sort((W,F)=>W.localeCompare(F,"de-DE")):[],w=m.length===0,f=n.forecast&&typeof n.forecast=="object"?n.forecast:{},h=typeof f.lastImportAt=="string"?f.lastImportAt:null,N=Ge(h),I=new Date,O=24*60*60*1e3,L=N?Math.floor((I.getTime()-N.getTime())/O):null,X=L!=null&&L<=35,C=Ms(f),G=typeof f.lastDriftReviewedComparedAt=="string"?f.lastDriftReviewedComparedAt:null,J=typeof f.lastDriftReviewedAt=="string"?f.lastDriftReviewedAt:null,ee=!!(C&&G&&as(String(C).slice(0,7))&&G===C&&Ge(J)),he=t.runtimeErrorAt&&Ge(t.runtimeErrorAt)?String(t.runtimeErrorAt):null,c=!he,U=[{key:"runtime_stable",label:"Runtime stabil",passed:c,status:c?"ok":"error",detail:c?"Keine offenen Tab-Ladefehler.":`Offener Tab-Ladefehler seit ${new Date(he).toLocaleString("de-DE")}${t.runtimeErrorRoute?` (${t.runtimeErrorRoute})`:""}.`,route:"/v2/dashboard",blockerCount:c?0:1},{key:"robust_12m",label:"Robustheit 12M",passed:a,status:a?"ok":"error",detail:a?`${i.robustMonthsCount}/${o.length} Monate robust.`:`${i.robustMonthsCount}/${o.length} Monate robust (erforderlich: ${o.length}).`,route:"/v2/dashboard",blockerCount:a?0:Math.max(0,o.length-i.robustMonthsCount)},{key:"anchor_history_complete",label:"Anchor-Historie vollständig",passed:w,status:w?"ok":"error",detail:w?"Alle aktiven/prelaunch SKUs haben Snapshot-Historie.":`${m.length} SKU(s) ohne Snapshot-Historie (Anker=0).`,route:"/v2/inventory/projektion?source=dashboard&risk=under_safety&abc=ab&expand=all",blockerCount:m.length},{key:"forecast_fresh",label:"Forecast aktuell",passed:X,status:X?"ok":"error",detail:X?`${L} Tage seit Import.`:L==null?"Kein Forecast-Import vorhanden.":`${L} Tage seit Import (erlaubt <= 35).`,route:"/v2/forecast",blockerCount:X?0:1},{key:"forecast_drift_reviewed",label:"Drift geprüft",passed:ee,status:ee?"ok":"error",detail:ee?`Drift-Stand vom ${new Date(C).toLocaleDateString("de-DE")} geprüft.`:C?"Aktueller Drift-Stand ist noch nicht als geprüft markiert.":"Noch kein Driftvergleich verfügbar.",route:"/v2/forecast",blockerCount:ee?0:1}],T=U.filter(W=>!W.passed).map(W=>As(W)),H=T.length===0;return{ready:H,status:H?"ready":"not_ready",horizonMonths:r,checks:U,blockers:T,robustMonthsCount:i.robustMonthsCount,robustRequiredCount:o.length,anchorMissingHistoryCount:m.length,anchorMissingHistorySkus:m,forecastDaysSinceImport:L,driftComparedAt:C,driftReviewedAt:J,driftReviewedForComparedAt:G}}function Oe(t){return String(t||"").trim().toLowerCase()}function Ye(t){const n=String(t||"").trim();if(!n)return null;const r=n.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!r)return null;const o=Number(r[1]),i=Number(r[2]),a=Number(r[3]),v=new Date(o,i-1,a);return Number.isNaN(v.getTime())||v.getFullYear()!==o||v.getMonth()!==i-1||v.getDate()!==a?null:`${o}-${String(i).padStart(2,"0")}-${String(a).padStart(2,"0")}`}function ws(t){if(!t)return null;const[n,r,o]=t.split("-").map(Number);if(!n||!r||!o)return null;const i=new Date(n,r-1,o);return Number.isNaN(i.getTime())?null:i}function Ps(){const t=new Date,n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}function Dt(t){const n=Number(t);return Number.isFinite(n)?Math.max(0,Math.round(n)):0}function Rs(t){const n=Ye(t.etaManual||t.etaDate||t.eta);if(n)return n;const r=ws(Ye(t.orderDate));if(!r)return null;const o=Math.max(0,Number(t.prodDays||0)),i=Math.max(0,Number(t.transitDays||0)),a=new Date(r.getTime());a.setDate(a.getDate()+o+i);const v=a.getFullYear(),x=String(a.getMonth()+1).padStart(2,"0"),m=String(a.getDate()).padStart(2,"0");return`${v}-${x}-${m}`}function Es(t,n){const r=Oe(t.supplierId||t.supplier||t.supplierName);return r&&n.has(r)?String(n.get(r)):String(t.supplierName||t.supplier||"-")}function Is(t,n){const r=Array.isArray(t.items)?t.items:[],o=r.length?r.map(a=>String(a.sku||"").trim()).filter(Boolean):[String(t.sku||"").trim()].filter(Boolean);return Array.from(new Set(o.map(a=>n.get(Oe(a))||a))).join(", ")||"-"}function Fs(t){const n=Array.isArray(t.items)?t.items:[];return n.length?n.reduce((r,o)=>r+Dt(o.units),0):Dt(t.units)}function Ks(t){const n=t.state&&typeof t.state=="object"?t.state:{},r=String(t.month||""),o=Ye(t.todayIso)||Ps(),i=new Map;(Array.isArray(n.suppliers)?n.suppliers:[]).forEach(f=>{const h=f&&typeof f=="object"?f:{},N=String(h.name||"").trim();if(!N)return;const I=Oe(h.id),O=Oe(N);I&&i.set(I,N),O&&i.set(O,N)});const v=new Map;(Array.isArray(n.products)?n.products:[]).forEach(f=>{const h=f&&typeof f=="object"?f:{},N=String(h.sku||"").trim();N&&v.set(Oe(N),String(h.alias||N))});const m=[];return(Array.isArray(n.pos)?n.pos:[]).forEach(f=>{const h=f&&typeof f=="object"?f:{};if(h.archived||String(h.status||"").toUpperCase()==="CANCELLED")return;const N=String(h.id||h.poNo||"").trim();if(!N)return;const I=Rs(h);if(!I)return;const O=Ye(h.arrivalDate),X=I.slice(0,7)===r,C=!O,G=C&&I<o;!X&&!G||m.push({id:N,poNumber:String(h.poNo||h.id||""),supplier:Es(h,i),skuAliases:Is(h,v),units:Fs(h),etaDate:I,arrivalDate:O,monthRelevant:X,isOverdue:G,pending:C})}),m.sort((f,h)=>{if(f.pending!==h.pending)return f.pending?-1:1;if(f.monthRelevant!==h.monthRelevant)return f.monthRelevant?-1:1;const N=f.etaDate||"9999-12-31",I=h.etaDate||"9999-12-31",O=N.localeCompare(I);return O!==0?O:f.poNumber.localeCompare(h.poNumber)})}const{Paragraph:pe,Text:A,Title:de}=es,$s="v2:last-route-error";function Os(){return new Date().toISOString()}function Bs(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const wt=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],zs=[{key:"inflow",label:"Einzahlungen"},{key:"po_fo",label:"PO/FO Zahlungen"},{key:"fixcost",label:"Fixkosten"},{key:"tax",label:"Steuern & Importkosten"},{key:"outflow",label:"Sonstige Auszahlungen"},{key:"other",label:"Sonstige"}],Ls=new Set(["signals","cashflow","actions","robustness","simulation","pnl","actuals","kpis"]),Ts=["signals","cashflow"];function Pt(t){const n=new Set;return t.forEach(r=>{const o=String(r||"").trim();Ls.has(o)&&n.add(o)}),Array.from(n)}function _s(t){return Array.isArray(t)?t:t?[t]:[]}function P(t){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function Ae(t){return Number.isFinite(t)?t<0?`−${P(Math.abs(t))}`:P(t):"-"}function ye(t,n=0){const r=Number(t);return Number.isFinite(r)?r.toLocaleString("de-DE",{minimumFractionDigits:n,maximumFractionDigits:n}):"-"}function at(t){const n=Number(t);return Number.isFinite(n)?`${n.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"-"}function De(t){if(!t)return"-";const n=new Date(t);return Number.isNaN(n.getTime())?t:n.toLocaleDateString("de-DE")}function Us(t){return t==="ok"?e.jsx(b,{color:"green",children:"OK"}):e.jsx(b,{color:"red",children:"Offen"})}function we(t){return t.reduce((n,r)=>n+Number(r.amount||0),0)}function Vs(t,n){const r=new Date(t.getTime());return r.setDate(r.getDate()+n),r}function He(t){return t==="dividend"?"Dividende (Simulation)":"CAPEX (Simulation)"}function Ve(t,n){return e.jsxs("span",{className:"v2-dashboard-signal-title",children:[t,e.jsx(Pe,{title:n,children:e.jsx(Ft,{})})]})}function Bt(t,n){const[r,o=""]=String(t||"").split("?"),i=new URLSearchParams(o);Object.entries(n).forEach(([v,x])=>{if(x==null||x===""){i.delete(v);return}i.set(v,x)});const a=i.toString();return a?`${r}?${a}`:r}function Gs(t){return Bt("/v2/inventory/projektion",{source:"dashboard",risk:t.risk,abc:t.abc,month:t.month||null,sku:t.sku||null,expand:"all"})}function Hs(t){return Bt("/v2/products",{source:"dashboard",issues:t.issues,sku:t.sku||null,expand:"all"})}function it(t){const n=String(t.route||"");if(n.startsWith("/v2/inventory/projektion")){const r=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"under_safety":"all",o=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"ab":"all";return Gs({risk:r,abc:o,month:t.month||null,sku:t.sku||null})}if(n.startsWith("/v2/products")){const r=t.actionId==="revenue_inputs"||t.checkKey==="revenue_inputs"?"revenue":"needs_fix";return Hs({issues:r,sku:t.sku||null})}return n}function Ws(t){const n=t.map(r=>(Array.isArray(r.entries)?r.entries:[]).filter(a=>String(a.direction||"").toLowerCase()==="out"&&String(a.group||"")==="Fixkosten").reduce((a,v)=>a+Math.abs(Number(v.amount||0)),0)).filter(r=>r>0);return n.length?n.reduce((r,o)=>r+o,0)/n.length:0}function Zs(t,n){var o;if(!n||!Number.isFinite(n.amount)||n.amount<=0)return t.map(i=>({...i}));let r=Number(((o=t[0])==null?void 0:o.opening)||0);return t.map((i,a)=>{const v=a===0?Number(i.opening||0):r,x=i.month===n.month,m=x?Math.abs(Number(n.amount||0)):0,w=Number(i.inflow||0),f=Number(i.outflow||0)+m,h=w-f,N=v+h;r=N;const I=x?[{id:`sim-${n.type}-${n.month}`,direction:"out",amount:m,label:n.label||He(n.type),month:n.month,kind:n.type==="dividend"?"dividend":"capex",group:n.type==="dividend"?"Dividende & KapESt":"Extras (Out)",source:"simulation"}]:[];return{...i,opening:v,inflow:w,outflow:f,net:h,closing:N,entries:[...Array.isArray(i.entries)?i.entries:[],...I],simApplied:x}})}function Ys(t,n){var r;for(let o=0;o<t.length;o+=1){const i=t[o].month;if((r=n.get(i))!=null&&r.robust&&Number(t[o].closing||0)<0)return i}return null}function qs(t){if(!t||typeof t!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0,topItems:[]};const n=t,r=Array.isArray(n.topItems)?n.topItems:[];return{comparedAt:typeof n.comparedAt=="string"?n.comparedAt:null,thresholdProfile:String(n.thresholdProfile||"medium"),flaggedSkuCount:Number(n.flaggedSkuCount||0),flaggedABCount:Number(n.flaggedABCount||0),flaggedMonthCount:Number(n.flaggedMonthCount||0),topItems:r.map(o=>{const i=o;return{sku:String(i.sku||""),month:String(i.month||""),abcClass:String(i.abcClass||"C"),deltaPct:Number(i.deltaPct||0),deltaUnits:Number(i.deltaUnits||0),deltaRevenue:Number(i.deltaRevenue||0)}}).filter(o=>o.sku&&o.month)}}function Qs(t){if(!t||typeof t!="object")return{toVersionId:null,foConflictsOpen:0};const n=t;return{toVersionId:n.toVersionId==null?null:String(n.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(n.foConflictsOpen||0)))}}function Rt(){if(typeof window>"u"||!window.sessionStorage)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};try{const t=window.sessionStorage.getItem($s);if(!t)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};const n=JSON.parse(t);return{errorAt:typeof n.errorAt=="string"?n.errorAt:null,routeKey:typeof n.routeKey=="string"?n.routeKey:null,routePath:typeof n.routePath=="string"?n.routePath:null,routeLabel:typeof n.routeLabel=="string"?n.routeLabel:null,message:typeof n.message=="string"?n.message:null}}catch{return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null}}}function An(){var xt,yt,jt,kt;const{state:t,loading:n,error:r,saving:o,saveWith:i}=us(),a=Jt(),[v,x]=fs.useMessage(),m=ds("dashboard"),[w,f]=g.useState("next12"),[h,N]=g.useState(""),[I,O]=g.useState([]),[L,X]=g.useState("dividend"),[C,G]=g.useState(""),[J,ee]=g.useState(null),[he,c]=g.useState(""),[U,T]=g.useState({}),[H,W]=g.useState(()=>Rt()),[F,be]=g.useState(()=>{const s=hs("dashboard");return m?Pt(s):Ts.slice()}),_=t,te=g.useMemo(()=>ss(_),[t]),me=te.months||[],Z=te.breakdown||[],Re=te.actualComparisons||[],B=g.useMemo(()=>{const s=wt.find(l=>l.value===w);return!s||s.count==null?me:me.slice(0,s.count)},[me,w]),ke=g.useMemo(()=>new Set(B),[B]),u=g.useMemo(()=>Z.filter(s=>ke.has(s.month)),[Z,ke]),R=g.useMemo(()=>Re.filter(s=>ke.has(s.month)),[Re,ke]),k=g.useMemo(()=>Ot({state:_,months:B}),[_,B]),se=g.useMemo(()=>Ds({state:_,horizonMonths:12,runtimeErrorAt:H.errorAt,runtimeErrorRoute:H.routePath}),[H.errorAt,H.routePath,_]);g.useEffect(()=>{var s;if(!k.months.length){N("");return}if(!h||!k.monthMap.has(h)){const l=((s=k.months.find(p=>!p.robust))==null?void 0:s.month)||k.months[0].month;N(l)}},[k,h]),g.useEffect(()=>{if(!u.length){O([]);return}O(s=>{const l=new Set(u.map(j=>j.month)),p=s.filter(j=>l.has(j));return p.length?p:[u[0].month]})},[u]),g.useEffect(()=>{if(!B.length){G("");return}(!C||!B.includes(C))&&G(B[0])},[C,B]),g.useEffect(()=>{ms("dashboard",F)},[F]);const ne=s=>{be(Pt(_s(s)))},y=g.useMemo(()=>!C||!Number.isFinite(J)||Number(J)<=0?null:{month:C,amount:Math.abs(Number(J)),type:L,label:he.trim()||He(L)},[J,he,C,L]),D=g.useMemo(()=>Zs(u,y),[y,u]),Ee=g.useMemo(()=>{const s=new Map;return D.forEach(l=>s.set(l.month,l)),s},[D]),Be=D[D.length-1]||null,ze=D.reduce((s,l)=>s+Number(l.inflow||0),0),zt=D.reduce((s,l)=>s+Number(l.outflow||0),0),ut=D.reduce((s,l)=>s+Number(l.net||0),0),Y=g.useMemo(()=>Ws(u),[u])*2,qe=g.useMemo(()=>D.filter(s=>{var l;return(l=k.monthMap.get(s.month))==null?void 0:l.robust}).map(s=>Number(s.closing||0)),[k.monthMap,D]),dt=g.useMemo(()=>!qe.length||Y<=0?null:Math.min(...qe)-Y,[Y,qe]),ht=g.useMemo(()=>Ys(D,k.monthMap),[k.monthMap,D]),Qe=g.useMemo(()=>{var s;return!y||Y<=0?null:((s=D.find(l=>{const p=Ue(l.month),j=Ue(y.month);return p==null||j==null||p<j?!1:Number(l.closing||0)<Y}))==null?void 0:s.month)||null},[Y,D,y]),mt=!!y&&Y>0&&!Qe,ie=t.forecast&&typeof t.forecast=="object"?t.forecast:{},Le=g.useMemo(()=>{const s=structuredClone(ie||{});return ls(s),s},[ie]),Lt=g.useMemo(()=>cs(Le),[Le]),Xe=Qs(Le.lastImpactSummary),ft=String(Le.activeVersionId||"").trim()||null,Te=Xe.toVersionId&&ft&&Xe.toVersionId===ft?Xe.foConflictsOpen:0,Je=typeof ie.lastImportAt=="string"?ie.lastImportAt:null,q=qs(ie.lastDriftSummary),gt=typeof ie.lastDriftReviewedComparedAt=="string"?ie.lastDriftReviewedComparedAt:null,et=typeof ie.lastDriftReviewedAt=="string"?ie.lastDriftReviewedAt:null,tt=!!(q.comparedAt&&gt&&gt===q.comparedAt&&et),Se=Je?new Date(Je):null,Tt=new Date,_t=24*60*60*1e3,Ie=Se?Math.floor((Tt.getTime()-Se.getTime())/_t):null,Ne=Se?Ie!=null&&Ie<=35?"fresh":Ie!=null&&Ie<=45?"aging":"stale":"none",Ut=Se?`${Ie} Tage seit Import`:"Kein Forecast-Import",pt=Se?Vs(Se,30):null,V=h&&k.monthMap.get(h)||null,st=We(),Ce=Bs(),bt=Ue(st),Vt=g.useMemo(()=>{var s;return((s=k.months.find(l=>!l.robust))==null?void 0:s.month)||h||B[0]||null},[k.months,h,B]),Fe=g.useMemo(()=>Ks({state:_,month:st,todayIso:Ce}),[st,_,Ce]);g.useEffect(()=>{const s=()=>W(Rt());return s(),window.addEventListener("v2:route-load-state",s),window.addEventListener("storage",s),()=>{window.removeEventListener("v2:route-load-state",s),window.removeEventListener("storage",s)}},[]),g.useEffect(()=>{T(s=>{const l=new Set(Fe.map(M=>M.id));let p=!1;const j={};return Object.entries(s).forEach(([M,oe])=>{if(!l.has(M)){p=!0;return}j[M]=oe}),Fe.forEach(M=>{j[M.id]||(j[M.id]=M.arrivalDate||Ce,p=!0)}),p?j:s})},[Fe,Ce]);const vt=g.useMemo(()=>rs({breakdown:u,state:_}),[_,u]),Gt=g.useMemo(()=>{const s=B.map(d=>ue(d)),l=u.map(d=>Number(d.closing||0)),p=u.map(d=>{var E;return!!((E=k.monthMap.get(d.month))!=null&&E.robust)}),j=l.map((d,E)=>p[E]&&d>=0?d:null),M=l.map((d,E)=>p[E]&&d<0?d:null),oe=l.map((d,E)=>!p[E]&&d>=0?d:null),le=l.map((d,E)=>!p[E]&&d<0?d:null),S=y?u.map(d=>{var E;return Number(((E=Ee.get(d.month))==null?void 0:E.closing)||0)}):[];return{tooltip:{trigger:"axis",formatter:d=>{const E=Array.isArray(d)?d:[d],Q=E[0],ce=[`<div><strong>${(Q==null?void 0:Q.axisValueLabel)||""}</strong></div>`];return E.forEach(Me=>{const re=Me,Ke=Number(re==null?void 0:re.value);Number.isFinite(Ke)&&ce.push(`<div>${(re==null?void 0:re.marker)||""}${(re==null?void 0:re.seriesName)||""}: ${P(Ke)}</div>`)}),ce.join("")}},legend:{top:0},grid:{left:56,right:70,top:44,bottom:32},xAxis:{type:"category",data:s},yAxis:[{type:"value",name:"Cashflow",axisLabel:{formatter:d=>Ae(d)}},{type:"value",name:"Kontostand",position:"right",axisLabel:{formatter:d=>P(d)}}],series:[{name:"Einzahlungen",type:"bar",stack:"cash",data:D.map(d=>Number(d.inflow||0)),itemStyle:{color:"#27ae60"}},{name:"Auszahlungen",type:"bar",stack:"cash",data:D.map(d=>-Number(d.outflow||0)),itemStyle:{color:"#e74c3c"}},{name:"Netto",type:"line",smooth:!0,data:D.map(d=>Number(d.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:j,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:M,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend (nicht robust)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:oe,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:le,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}},...y?[{name:"Simulation",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:S,lineStyle:{width:2,type:"dashed",color:"#f59e0b"},itemStyle:{color:"#f59e0b"}}]:[]]}},[k.monthMap,D,Ee,y,u,B]),Ht=g.useMemo(()=>[{header:"Monat",accessorKey:"month"},{header:"Plan Umsatz",accessorKey:"plannedRevenue",cell:({row:s})=>P(s.original.plannedRevenue)},{header:"Ist Umsatz",accessorKey:"actualRevenue",cell:({row:s})=>P(s.original.actualRevenue)},{header:"Delta Umsatz",accessorKey:"revenueDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.revenueDelta||0)<0?"v2-negative":void 0,children:P(s.original.revenueDelta)})},{header:"Delta Umsatz %",accessorKey:"revenueDeltaPct",cell:({row:s})=>at(s.original.revenueDeltaPct)},{header:"Plan Kontostand",accessorKey:"plannedClosing",cell:({row:s})=>P(s.original.plannedClosing)},{header:"Ist Kontostand",accessorKey:"actualClosing",cell:({row:s})=>P(s.original.actualClosing)},{header:"Delta Kontostand",accessorKey:"closingDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.closingDelta||0)<0?"v2-negative":void 0,children:P(s.original.closingDelta)})}],[]),Wt=g.useMemo(()=>[{title:"Check",dataIndex:"label",key:"label",sorter:(s,l)=>String(s.label||"").localeCompare(String(l.label||""),"de-DE")},{title:"Status",dataIndex:"status",key:"status",width:130,sorter:(s,l)=>String(s.status||"").localeCompare(String(l.status||""),"de-DE"),render:s=>Us(s)},{title:"Detail",dataIndex:"detail",key:"detail",width:320,sorter:(s,l)=>String(s.detail||"").localeCompare(String(l.detail||""),"de-DE"),render:s=>e.jsx(A,{type:"secondary",children:s})},{title:"",key:"route",width:132,render:(s,l)=>e.jsx($,{size:"small",onClick:()=>a(it({route:l.route,checkKey:l.key,month:(V==null?void 0:V.month)||null})),children:"Öffnen"})}],[a,V==null?void 0:V.month]),Zt=g.useMemo(()=>u.map(s=>{var le;const l=vt.get(s.month)||[],p=zs.map(S=>({...S,rows:l.filter(d=>d.group===S.key)})).filter(S=>S.rows.length>0),j=l.filter(S=>S.group==="inflow"),M=l.filter(S=>S.amount<0),oe=((le=k.monthMap.get(s.month))==null?void 0:le.robust)||!1;return{key:s.month,label:e.jsxs("div",{className:"v2-dashboard-pnl-header",children:[e.jsx(A,{strong:!0,children:ue(s.month)}),e.jsxs(fe,{wrap:!0,children:[e.jsxs(b,{color:"green",children:["Einzahlungen: ",P(we(j))]}),e.jsxs(b,{color:"red",children:["Auszahlungen: ",P(Math.abs(we(M)))]}),e.jsxs(b,{color:s.net>=0?"green":"red",children:["Netto: ",P(s.net)]}),e.jsxs(b,{color:oe?"green":"red",children:["Robust: ",oe?"ja":"nein"]})]})]}),children:e.jsx("div",{className:"v2-dashboard-pnl-month",children:p.map(S=>{if(S.key==="po_fo"){const d=new Map;S.rows.forEach(Q=>{const ce=`${Q.source}:${Q.sourceNumber||Q.label}`,Me=d.get(ce)||[];Me.push(Q),d.set(ce,Me)});const E=Array.from(d.entries()).map(([Q,ce])=>{var St;const[Me,re]=Q.split(":"),Ke=we(ce),_e=(St=ce.find(z=>z.tooltipMeta))==null?void 0:St.tooltipMeta;return{key:Q,label:e.jsxs("div",{className:"v2-dashboard-pnl-order-row",children:[e.jsxs(A,{strong:!0,children:[String(Me).toUpperCase()," ",re||"—"]}),e.jsxs(fe,{size:6,children:[e.jsx(b,{color:Ke<0?"red":"green",children:Ae(Ke)}),(_e==null?void 0:_e.units)!=null?e.jsxs(b,{children:["Stück: ",ye(_e.units,0)]}):null]})]}),children:e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:ce.map((z,Qt)=>{var Ct;const Nt=z.tooltipMeta?e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("strong",{children:[String(z.source).toUpperCase()," ",z.sourceNumber||"—"]})}),e.jsxs("div",{children:["Alias: ",z.tooltipMeta.aliases.join(", ")||"-"]}),e.jsxs("div",{children:["Stückzahl: ",z.tooltipMeta.units!=null?ye(z.tooltipMeta.units,0):"-"]}),e.jsxs("div",{children:["Fälligkeit: ",De(z.tooltipMeta.dueDate)]})]}):null;return e.jsxs("tr",{children:[e.jsx("td",{children:Nt?e.jsx(Pe,{title:Nt,children:z.label}):z.label}),e.jsx("td",{className:z.amount<0?"v2-negative":void 0,children:Ae(z.amount)}),e.jsx("td",{children:De((Ct=z.tooltipMeta)==null?void 0:Ct.dueDate)}),e.jsx("td",{children:z.paid==null?e.jsx(b,{children:"—"}):z.paid?e.jsx(b,{color:"green",children:"Bezahlt"}):e.jsx(b,{color:"gold",children:"Offen"})})]},`${Q}-${Qt}`)})})]})})}});return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(A,{strong:!0,children:S.label}),e.jsx(b,{color:"blue",children:Ae(we(S.rows))})]}),e.jsx(ae,{size:"small",items:E})]},`${s.month}-${S.key}`)}return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(A,{strong:!0,children:S.label}),e.jsx(b,{color:we(S.rows)<0?"red":"green",children:Ae(we(S.rows))})]}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:S.rows.map((d,E)=>e.jsxs("tr",{children:[e.jsx("td",{children:d.label}),e.jsx("td",{className:d.amount<0?"v2-negative":void 0,children:Ae(d.amount)}),e.jsx("td",{children:d.paid==null?e.jsx(b,{children:"—"}):d.paid?e.jsx(b,{color:"green",children:"Bezahlt"}):e.jsx(b,{color:"gold",children:"Offen"})})]},`${s.month}-${S.key}-${E}`))})]})})]},`${s.month}-${S.key}`)})})}}),[vt,k.monthMap,u]);async function Yt(){y&&(await i(s=>{const l=rt(s),p=l,j=y.label||He(y.type);if(y.type==="dividend"){const M=Array.isArray(p.dividends)?[...p.dividends]:[];M.push({id:`div-${Date.now()}`,month:y.month,label:j,amountEur:Math.abs(y.amount)}),p.dividends=M}else{const M=Array.isArray(p.extras)?[...p.extras]:[];M.push({id:`extra-${Date.now()}`,month:y.month,label:j,amountEur:-Math.abs(y.amount)}),p.extras=M}return l},`v2:dashboard:simulation-commit:${y.type}`),ee(null),c(""))}async function qt(){q.comparedAt&&await i(s=>{const l=rt(s),p=l;(!p.forecast||typeof p.forecast!="object")&&(p.forecast={});const j=p.forecast;return j.lastDriftReviewedAt=Os(),j.lastDriftReviewedComparedAt=q.comparedAt,l},"v2:dashboard:forecast-drift-reviewed")}async function nt(s,l,p){try{await i(j=>{const M=rt(j),oe=Array.isArray(M.pos)?M.pos:[];return M.pos=oe.map(le=>{if(!le||typeof le!="object")return le;const S=le;return String(S.id||S.poNo||"").trim()!==s?S:{...S,arrivalDate:l||null}}),M},p),v.success(l?"Wareneingang gespeichert.":"Wareneingang zurückgesetzt.")}catch(j){console.error(j),v.error(j instanceof Error?j.message:"Wareneingang konnte nicht gespeichert werden.")}}return((yt=(xt=t.settings)==null?void 0:xt.featureFlags)==null?void 0:yt.executiveDashboardV2)!==!1?e.jsxs("div",{className:"v2-page",children:[x,e.jsxs(K,{className:"v2-intro-card",children:[e.jsxs("div",{className:"v2-page-head",children:[e.jsxs("div",{children:[e.jsx(de,{level:3,children:"Dashboard"}),e.jsx(pe,{children:"Executive-Cockpit für Kontostand, Robustheit und Maßnahmenpriorisierung. Nicht robuste Monate sind klar markiert."})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(A,{children:"Zeitraum"}),e.jsx(ot,{value:w,onChange:s=>f(s),options:wt.map(s=>({value:s.value,label:s.label})),style:{width:220,maxWidth:"100%"}})]})]}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx($,{onClick:()=>a("/v2/forecast"),children:"Zur Absatzprognose"}),e.jsx($,{onClick:()=>a("/v2/inventory/projektion"),children:"Zur Bestandsprojektion"}),e.jsx($,{onClick:()=>a("/v2/orders/po"),children:"Zu Bestellungen"}),e.jsx($,{onClick:()=>a("/v2/abschluss/eingaben"),children:"Zum Abschluss"})]}),e.jsxs(A,{type:"secondary",children:["Aktueller Betrachtungszeitraum: ",B.length," Monat(e)."]})]})]}),r?e.jsx(ve,{type:"error",showIcon:!0,message:r}):null,n?e.jsx(ve,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,Te>0?e.jsx(ve,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${Te} FOs prüfen`,description:e.jsx($,{size:"small",onClick:()=>a("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"signals",label:"Executive Signals",children:e.jsxs("div",{className:"v2-dashboard-signal-grid",children:[e.jsxs(K,{className:"v2-dashboard-signal-card v2-dashboard-readiness-card",children:[e.jsx(ge,{title:Ve("Readiness Gate","Go/No-Go vor großer Datenpflege. Alle Checks müssen grün sein."),value:se.ready?"Bereit":"Nicht bereit"}),e.jsxs(fe,{wrap:!0,children:[e.jsx(b,{color:se.ready?"green":"red",children:se.ready?"Go":"No-Go"}),e.jsxs(b,{color:se.ready?"green":"gold",children:[se.robustMonthsCount,"/",se.robustRequiredCount," robuste Monate"]})]}),!se.ready&&se.blockers.length?e.jsx("div",{className:"v2-dashboard-readiness-blockers",children:se.blockers.slice(0,2).map(s=>e.jsxs("div",{className:"v2-dashboard-readiness-blocker-item",children:[e.jsxs(A,{type:"secondary",children:[s.label,": ",s.message]}),e.jsx($,{size:"small",onClick:()=>a(s.route),children:"Öffnen"})]},s.id))}):e.jsx(A,{type:"secondary",children:"Alle Gate-Checks erfüllt."})]}),e.jsxs(K,{className:"v2-dashboard-signal-card",children:[e.jsx(ge,{title:Ve("Robust bis","Letzter Monat, in dem alle Hard-Checks erfüllt sind. Danach ist der Kontostand nur Orientierung."),value:k.robustUntilMonth?ue(k.robustUntilMonth):"—"}),e.jsxs(A,{type:"secondary",children:[k.robustMonthsCount,"/",k.totalMonths," Monate robust"]})]}),e.jsxs(K,{className:"v2-dashboard-signal-card",children:[e.jsx(ge,{title:Ve("Erster negativer Monat (robust)","Erster belastbarer Monat mit negativem Kontostand. Nicht robuste Monate werden dafür ignoriert."),value:ht?ue(ht):"Keiner"}),e.jsx(A,{type:"secondary",children:"Simulation wird berücksichtigt"})]}),e.jsxs(K,{className:"v2-dashboard-signal-card",children:[e.jsx(ge,{title:Ve("Freier Cash nach Buffer","Minimaler belastbarer Kontostand minus Sicherheitsreserve aus 2 Monaten Fixkosten."),value:dt!=null?P(dt):"—"}),e.jsxs(A,{type:"secondary",children:["Buffer (2M Fixkosten): ",P(Y)]})]}),e.jsxs(K,{className:"v2-dashboard-signal-card",children:[e.jsxs("div",{className:"v2-dashboard-forecast-status-head",children:[e.jsxs(A,{strong:!0,children:["Forecast Freshness",e.jsx(Pe,{title:"Ampel nach Importalter: Grün <=35 Tage, Gelb 36-45 Tage, Rot >45 Tage.",children:e.jsx(Ft,{className:"v2-dashboard-inline-info"})})]}),e.jsx(b,{color:Ne==="fresh"?"green":Ne==="aging"?"gold":Ne==="stale"?"red":"default",children:Ne==="fresh"?"Grün":Ne==="aging"?"Gelb":Ne==="stale"?"Rot":"Keine Daten"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-status-meta",children:[e.jsxs("div",{children:["Baseline Forecast: ",Lt]}),e.jsx("div",{children:Ut}),e.jsxs("div",{children:["Letzter Import: ",De(Je)]}),e.jsxs("div",{children:["Nächster Import empfohlen: ",pt?pt.toLocaleDateString("de-DE"):"—"]}),Te>0?e.jsx("div",{children:e.jsxs($,{size:"small",onClick:()=>a("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",Te," FOs prüfen"]})}):null]})]})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"cashflow",label:"Kontostand & Cashflow",children:e.jsxs(K,{className:"v2-dashboard-chart-card",children:[e.jsx(de,{level:4,children:"Kontostand & Cashflow"}),e.jsxs(fe,{wrap:!0,children:[e.jsxs(b,{color:"green",children:["Einzahlungen: ",P(ze)]}),e.jsxs(b,{color:"red",children:["Auszahlungen: ",P(zt)]}),e.jsxs(b,{color:ut>=0?"green":"red",children:["Netto: ",P(ut)]}),e.jsxs(b,{color:y?"gold":"default",children:["Simulation: ",y?"aktiv":"aus"]})]}),e.jsxs("div",{className:"v2-dashboard-legend-help",children:[e.jsx(Pe,{title:"Durchgezogene Linie: belastbarer Kontostand (alle Hard-Checks bestanden).",children:e.jsx(b,{className:"v2-dashboard-legend-tag",children:"Linie solid = belastbar"})}),e.jsx(Pe,{title:"Gestrichelte Linie: orientierend, weil mindestens ein Hard-Check fehlt.",children:e.jsx(b,{className:"v2-dashboard-legend-tag",children:"Linie gestrichelt = orientierend"})}),e.jsx(Pe,{title:"Rot markiert: Kontostand liegt unter 0 im jeweiligen Zustand.",children:e.jsx(b,{className:"v2-dashboard-legend-tag",children:"Rot = unter 0"})})]}),e.jsx(ts,{style:{height:380},option:Gt})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"actions",label:"Action Center & Forecast Ops",children:e.jsxs(Mt,{gutter:[12,12],children:[e.jsx(xe,{xs:24,xl:14,children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Action Center"}),e.jsx(pe,{type:"secondary",children:"Priorisierte Maßnahmen, damit der Kontostand wieder belastbar wird."}),k.actions.length?e.jsx("div",{className:"v2-dashboard-actions",children:k.actions.map(s=>e.jsxs("div",{className:`v2-dashboard-action-card is-${s.severity}`,children:[e.jsxs("div",{children:[e.jsx(A,{strong:!0,children:s.title}),e.jsx("div",{className:"v2-dashboard-action-detail",children:s.detail}),e.jsxs("div",{className:"v2-dashboard-action-impact",children:["Impact: ",s.impact]})]}),e.jsxs("div",{className:"v2-dashboard-action-meta",children:[e.jsx(b,{color:s.severity==="error"?"red":"gold",children:s.count}),e.jsx($,{size:"small",onClick:()=>a(it({route:s.route,actionId:s.id,month:Vt})),children:"Öffnen"})]})]},s.id))}):e.jsx(ve,{type:"success",showIcon:!0,message:"Keine offenen Hard-Blocker im gewählten Zeitraum."})]})}),e.jsx(xe,{xs:24,xl:10,children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Forecast Ops"}),e.jsxs(pe,{type:"secondary",children:["Monatlicher Import mit Drift-Alarm (A/B Fokus, Profil: ",q.thresholdProfile,")."]}),e.jsxs(fe,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(b,{color:tt?"green":"gold",children:["Drift-Review: ",tt?"geprüft":"offen"]}),et?e.jsxs(b,{children:["Geprüft am: ",new Date(et).toLocaleDateString("de-DE")]}):null,e.jsx($,{size:"small",onClick:()=>{qt()},disabled:!q.comparedAt||tt||o,children:"Drift geprüft"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-ops",children:[e.jsxs("div",{children:["Flagged SKUs: ",e.jsx("strong",{children:ye(q.flaggedSkuCount,0)})]}),e.jsxs("div",{children:["Flagged A/B: ",e.jsx("strong",{children:ye(q.flaggedABCount,0)})]}),e.jsxs("div",{children:["Flagged SKU-Monate: ",e.jsx("strong",{children:ye(q.flaggedMonthCount,0)})]}),e.jsxs("div",{children:["Verglichen am: ",e.jsx("strong",{children:De(q.comparedAt)})]})]}),q.topItems.length?e.jsxs("div",{className:"v2-dashboard-drift-list",children:[q.topItems.slice(0,5).map((s,l)=>e.jsxs("div",{className:"v2-dashboard-drift-item",children:[e.jsxs("div",{children:[e.jsx(A,{strong:!0,children:s.sku}),e.jsxs(A,{type:"secondary",children:[" · ",ue(s.month)," · ",s.abcClass]})]}),e.jsxs("div",{children:["ΔUnits ",ye(s.deltaUnits,0)," · ΔUmsatz ",P(s.deltaRevenue)," · Δ% ",at(s.deltaPct)]})]},`${s.sku}-${s.month}-${l}`)),e.jsx($,{size:"small",onClick:()=>a("/v2/forecast"),children:"Zur Forecast-Prüfung"})]}):e.jsx(ve,{type:"success",showIcon:!0,message:"Keine kritischen Drift-Abweichungen im letzten Vergleich."})]})}),e.jsx(xe,{xs:24,xl:24,children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"PO Wareneingang bestätigen"}),e.jsx(pe,{type:"secondary",children:"Sichtbar sind POs mit ETA im aktuellen Monat sowie überfällige ETA ohne bestätigten Wareneingang."}),Fe.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"PO"}),e.jsx("th",{children:"Supplier"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"Stückzahl"}),e.jsx("th",{children:"ETA"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Fe.map(s=>{const l=U[s.id]||s.arrivalDate||Ce,p=/^\d{4}-\d{2}-\d{2}$/.test(l);return e.jsxs("tr",{children:[e.jsx("td",{children:s.poNumber||"PO"}),e.jsx("td",{children:s.supplier||"-"}),e.jsx("td",{children:s.skuAliases||"-"}),e.jsx("td",{children:ye(s.units,0)}),e.jsx("td",{children:De(s.etaDate)}),e.jsx("td",{children:s.arrivalDate?e.jsxs(b,{color:"green",children:["Angekommen am ",De(s.arrivalDate)]}):s.isOverdue?e.jsx(b,{color:"red",children:"Überfällig"}):e.jsx(b,{color:"gold",children:"Offen"})}),e.jsx("td",{children:e.jsxs(fe,{wrap:!0,children:[e.jsx($,{size:"small",onClick:()=>{nt(s.id,Ce,"v2:dashboard:po-arrival-today")},disabled:o,children:"Heute"}),e.jsx(At,{type:"date",value:l,onChange:j=>{const M=j.target.value||"";T(oe=>({...oe,[s.id]:M}))},style:{width:160}}),e.jsx($,{size:"small",onClick:()=>{p&&nt(s.id,l,"v2:dashboard:po-arrival-date")},disabled:o||!p||l===s.arrivalDate,children:"Datum setzen"}),s.arrivalDate?e.jsx($,{size:"small",danger:!0,onClick:()=>{nt(s.id,null,"v2:dashboard:po-arrival-clear")},disabled:o,children:"Zurücksetzen"}):null]})})]},s.id)})})]})}):e.jsx(ve,{type:"success",showIcon:!0,message:"Keine offenen PO-Wareneingänge für den aktuellen Scope."})]})})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"robustness",label:"Robustheits-Matrix",children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Robustheits-Matrix"}),e.jsx(pe,{type:"secondary",children:"Ein Monat ist nur robust, wenn alle Hard-Checks erfüllt sind (Coverage 100 %, Cash-In, Fixkosten, VAT und Revenue-Basis)."}),e.jsx("div",{className:"v2-dashboard-robust-grid",children:k.months.map(s=>{const l=Ue(s.month),p=l!=null&&bt!=null&&l<bt;return e.jsxs("button",{type:"button",className:["v2-dashboard-robust-item",h===s.month?"is-selected":"",s.robust?"is-robust":"is-open",p?"is-past":""].filter(Boolean).join(" "),onClick:()=>N(s.month),children:[e.jsxs("div",{className:"v2-dashboard-robust-item-head",children:[e.jsx("span",{children:ue(s.month)}),e.jsx(b,{color:p?"default":s.robust?"green":"red",children:p?"Vergangen (Info)":s.robust?"Robust":"Offen"})]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Coverage: ",at(s.coverage.ratio*100)," (",s.coverage.coveredSkus,"/",s.coverage.activeSkus,")"]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Blocker: ",s.blockerCount]})]},s.month)})}),V?e.jsxs("div",{className:"v2-dashboard-robust-detail",children:[e.jsxs("div",{className:"v2-dashboard-robust-detail-head",children:[e.jsx(A,{strong:!0,children:ue(V.month)}),e.jsxs(fe,{children:[e.jsx(b,{color:V.robust?"green":"red",children:V.robust?"Robust":"Nicht robust"}),e.jsxs(b,{children:["A/B Risiko: ",V.coverage.abRiskSkuCount]})]})]}),e.jsx(gs,{size:"small",pagination:!1,rowKey:"key",columns:Wt,dataSource:V.checks}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsx(A,{strong:!0,children:"Blocker"}),V.blockers.length?e.jsx("div",{className:"v2-dashboard-blocker-list",children:V.blockers.map(s=>e.jsxs("div",{className:"v2-dashboard-blocker-item",children:[e.jsxs("div",{children:[e.jsx(A,{children:s.message}),s.sku?e.jsxs(A,{type:"secondary",children:[" · ",s.sku]}):null]}),e.jsx($,{size:"small",onClick:()=>a(it({route:s.route,checkKey:s.checkKey,month:s.month,sku:s.sku||null})),children:"Öffnen"})]},s.id))}):e.jsx(A,{type:"secondary",children:"Keine Blocker in diesem Monat."})]})]}):null]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"simulation",label:"Payout Planner (Simulation)",children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Payout Planner (Simulation)"}),e.jsx(pe,{type:"secondary",children:"Einmalige Dividenden oder CAPEX simulieren und optional als echten Eintrag übernehmen."}),e.jsxs("div",{className:"v2-dashboard-sim-grid",children:[e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(A,{children:"Typ"}),e.jsx(ot,{value:L,onChange:s=>X(s),options:[{value:"dividend",label:"Dividende"},{value:"capex",label:"CAPEX"}]})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(A,{children:"Monat"}),e.jsx(ot,{value:C,onChange:s=>G(s),options:B.map(s=>({value:s,label:ue(s)}))})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(A,{children:"Betrag (EUR)"}),e.jsx(ps,{value:Number.isFinite(J)?J:null,onChange:s=>ee(typeof s=="number"?s:null),min:0,controls:!1,placeholder:"0"})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(A,{children:"Label"}),e.jsx(At,{value:he,onChange:s=>c(s.target.value),placeholder:He(L)})]})]}),e.jsxs("div",{className:"v2-dashboard-sim-status",children:[e.jsx(b,{color:y?"gold":"default",children:y?"Simulation aktiv":"Keine Simulation"}),e.jsxs(b,{color:Y>0?"blue":"red",children:["Buffer-Ziel: ",P(Y)]}),y&&Y<=0?e.jsx(b,{color:"red",children:"Fixkostenbasis fehlt"}):null,y&&Y>0?e.jsx(b,{color:mt?"green":"red",children:mt?"Sicher":`Kritisch ab ${Qe?ue(Qe):"sofort"}`}):null]}),e.jsxs(fe,{children:[e.jsx($,{onClick:()=>{ee(null),c("")},children:"Simulation zurücksetzen"}),e.jsx($,{type:"primary",onClick:()=>{Yt()},disabled:!y,loading:o,children:"Als echten Eintrag übernehmen"})]})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"pnl",label:"Monatliche PnL (Drilldown)",children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Monatliche PnL (Drilldown)"}),e.jsx(pe,{type:"secondary",children:"Einzahlungen, PO/FO-Zahlungen, Fixkosten und Steuern je Monat. PO/FO-Positionen sind bis auf Milestone-Ebene aufklappbar."}),e.jsx(ae,{className:"v2-dashboard-pnl-collapse",activeKey:I,onChange:s=>O(Array.isArray(s)?s.map(String):[String(s)]),items:Zt})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"actuals",label:"Plan/Ist Drilldown",children:e.jsxs(K,{children:[e.jsx(de,{level:4,children:"Plan/Ist Drilldown"}),e.jsx(pe,{type:"secondary",children:"Monatsvergleich zwischen geplantem und erfasstem Istwert aus den Monats-Ist-Daten."}),e.jsx(ns,{data:R,columns:Ht,minTableWidth:980,tableLayout:"auto"})]})}]}),e.jsx(ae,{className:"v2-dashboard-module-collapse",activeKey:F,onChange:ne,items:[{key:"kpis",label:"KPI-Übersicht",children:e.jsxs(Mt,{gutter:[12,12],children:[e.jsx(xe,{xs:24,md:12,xl:6,children:e.jsx(K,{children:e.jsx(ge,{title:"Opening Balance",value:Number(((jt=te.kpis)==null?void 0:jt.opening)||0),formatter:s=>P(s)})})}),e.jsx(xe,{xs:24,md:12,xl:6,children:e.jsx(K,{children:e.jsx(ge,{title:"Sales Payout Ø",value:Number(((kt=te.kpis)==null?void 0:kt.salesPayoutAvg)||0),formatter:s=>P(s)})})}),e.jsx(xe,{xs:24,md:12,xl:6,children:e.jsx(K,{children:e.jsx(ge,{title:"Robuste Monate",value:`${k.robustMonthsCount}/${k.totalMonths}`})})}),e.jsx(xe,{xs:24,md:12,xl:6,children:e.jsx(K,{children:e.jsx(ge,{title:"Letzter Kontostand",value:Number((Be==null?void 0:Be.closing)||0),formatter:s=>P(s)})})})]})}]})]}):e.jsx("div",{className:"v2-page",children:e.jsx(ve,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{An as default};
