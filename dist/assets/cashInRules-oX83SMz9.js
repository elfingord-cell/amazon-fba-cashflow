const H=[3,6,12],h=40,N=60,ee=51;function p(e){if(e==null||typeof e=="string"&&e.trim()==="")return null;const t=Number(e);return Number.isFinite(t)?t:null}function d(e){return/^\d{4}-\d{2}$/.test(String(e||"").trim())}function D(e){if(!d(e))return null;const[t,n]=String(e).split("-").map(Number);return t*12+(n-1)}function te(e,t=6){const n=Math.round(Number(e||0));return H.includes(n)?n:H.includes(Math.round(Number(t||0)))?Math.round(Number(t||0)):6}function ne(e,t,n){const r=Number(e);if(!(Number.isFinite(r)&&r>0))return 1;const a=Math.max(1,Math.round(Number(t||1))),i=Math.max(0,Math.round(Number(n||0)));if(a<=1)return i===0?r:1;if(i>=a)return 1;const u=i/(a-1),f=r+(1-r)*u;return Number.isFinite(f)&&f>0?f:1}function g(e,t=h,n=N){const r=Number(e);return Number.isFinite(r)?Math.min(n,Math.max(t,r)):t}function I(e){if(e==null||String(e).trim()==="")return null;let t=Number(String(e).replace(",","."));return Number.isFinite(t)?(t>0&&t<=1&&(t*=100),t):null}function G(e){const t=(Array.isArray(e)?e:[]).map(r=>Number(r)).filter(r=>Number.isFinite(r)).sort((r,a)=>r-a);if(!t.length)return null;const n=Math.floor(t.length/2);return t.length%2===1?t[n]:(t[n-1]+t[n])/2}function $(e){const t=(Array.isArray(e)?e:[]).map(n=>Number(n)).filter(n=>Number.isFinite(n));return t.length?t.reduce((n,r)=>n+r,0)/t.length:null}function z(e){if(!d(e))return!1;const t=Number(String(e).slice(5,7));return t>=10&&t<=12}function re(e){if(!d(e))return null;const[t,n]=String(e).split("-").map(Number);return new Date(t,n,0).getDate()}function oe(e){if(!/^\d{4}-\d{2}-\d{2}$/.test(String(e||"").trim()))return null;const[t,n,r]=String(e).split("-").map(Number),a=new Date(t,n-1,r);return Number.isNaN(a.getTime())||a.getFullYear()!==t||a.getMonth()+1!==n||a.getDate()!==r?null:r}function se(e,t){return String(e||"").slice(0,7)===String(t||"")}function ae(e){const t=e&&typeof e=="object"?e:{},n=p(t.realRevenueEUR),r=I(t.realPayoutRatePct);if(Number.isFinite(n)&&n>0&&Number.isFinite(r))return Number(r);const a=p(t.realPayoutEUR??t.realPayoutEur);return Number.isFinite(n)&&n>0&&Number.isFinite(a)&&a>=0?Number(a)/Number(n)*100:null}function ie(e={}){const t=new Set;(Array.isArray(e.months)?e.months:[]).forEach(i=>{d(i)&&t.add(String(i))}),(Array.isArray(e.incomings)?e.incomings:[]).forEach(i=>{if(!i||typeof i!="object")return;const u=String(i.month||"").trim();d(u)&&t.add(u)});const a=e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{};return Object.keys(a).forEach(i=>{d(i)&&t.add(i)}),Array.from(t).sort((i,u)=>i.localeCompare(u))}function le(e={}){const t=e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{},n=Array.isArray(e.incomings)?e.incomings:[],r=e.ignoreQ4===!0,a=d(e.maxMonth)?e.maxMonth:d(e.currentMonth)?e.currentMonth:null,i=d(e.currentMonth)?e.currentMonth:a,u=Math.max(1,Math.round(Number(e.minSamples||4))),f=I(e.baselineNormalPct),l=g(Number.isFinite(f)?Number(f):ee,h,N),s=Object.entries(t).map(([o,F])=>{if(!d(o)||a&&o>a)return null;const y=F&&typeof F=="object"?F:{},C=ae(y);return Number.isFinite(C)?{month:o,quotePct:g(Number(C),h,N),realRevenueEUR:p(y.realRevenueEUR),realPayoutRatePct:I(y.realPayoutRatePct)}:null}).filter(Boolean).sort((o,F)=>String(o.month).localeCompare(String(F.month))),c=new Map(s.map(o=>[String(o.month),o])),m=s.filter(o=>!z(o.month)),b=G(m.map(o=>o.quotePct)),A=$(m.map(o=>o.quotePct)),P=s.filter(o=>String(o.month).slice(5,7)==="12").sort((o,F)=>String(o.month).localeCompare(String(F.month))),M=P.length?P[P.length-1]:null,v=Number.isFinite(M==null?void 0:M.quotePct)?g(Number(M.quotePct),h,N):null,S=Number.isFinite(v)?l+.5*(Number(v)-l):l,E=g(S,h,N),x=I(e.baselineQ4Pct),q=g(Number.isFinite(x)?Number(x):E,h,N),k=Number.isFinite(x)?"manual":"suggested",R=i&&n.find(o=>String((o==null?void 0:o.month)||"")===i)||null,Q=p(R==null?void 0:R.calibrationSellerboardMonthEndEur),w=p(R==null?void 0:R.calibrationPayoutRateToDatePct),U=Number.isFinite(Q)&&Q>0&&Number.isFinite(w)&&w>=0?Number(w)/Number(Q)*100:null,O=Number.isFinite(U)?g(U,h,N):null,j=!!(i&&Number.isFinite(O)&&(!z(i)||r)),T=j?[...m.map(o=>o.quotePct),Number(O)]:m.map(o=>o.quotePct),W=G(T),L=$(T),B=ie({months:e.months,incomings:n,monthlyActuals:t}),_={};B.forEach(o=>{const F=c.get(o);if(F){_[o]={month:o,quotePct:g(F.quotePct,h,N),sourceTag:"IST",explanation:"IST: Auszahlungsquote aus Monats-Istwerten."};return}if(i&&o===i&&Number.isFinite(O)){_[o]={month:o,quotePct:Number(O),sourceTag:"PROGNOSE",explanation:"PROGNOSE: Auszahlung Monatsende / Umsatzprognose Monatsende."};return}const y=z(o)&&!r,C=y?q:l,J=y?"BASELINE_Q4":"BASELINE_NORMAL",V=y?"Baseline Q4: Q4 = Normal + 0,5 * (Dez - Normal) (manuell ueberschreibbar).":"Baseline Normal: manuell gesetzter Referenzwert.";_[o]={month:o,quotePct:C,sourceTag:J,explanation:V}});const K=Number.isFinite(b)?g(b,h,N):null,X=Number.isFinite(A)?g(A,h,N):null,Y=Number.isFinite(W)?g(W,h,N):null,Z=Number.isFinite(L)?g(L,h,N):null;return{medianPct:l,sampleCount:s.length,usedMonths:s.map(o=>o.month),uncertain:s.length<u,ignoreQ4:r,minSamples:u,points:s,byMonth:_,baselineNormalPct:l,baselineQ4Pct:q,baselineQ4SuggestedPct:E,baselineQ4Source:k,decemberQuotePct:v,currentMonth:i,currentMonthForecastQuotePct:O,currentMonthForecastPointUsed:j,observedNormalMedianPct:K,observedNormalAveragePct:X,observedNormalSampleCount:m.length,observedNormalUsedMonths:m.map(o=>o.month),observedNormalWithForecastMedianPct:Y,observedNormalWithForecastAveragePct:Z,observedNormalWithForecastSampleCount:T.length}}function ue(e){return Array.isArray(e)?e.map(t=>{const n=t&&typeof t=="object"?t:{},r=d(n.month)?String(n.month):null;if(!r)return null;const a=n.calibrationCutoffDate?String(n.calibrationCutoffDate):"",i=p(n.calibrationRevenueToDateEur),u=p(n.calibrationSellerboardMonthEndEur);return{month:r,cutoffDate:a,revenueToDate:i,sellerboardMonthEnd:u}}).filter(Boolean).sort((t,n)=>t.month.localeCompare(n.month)):[]}function ce(e,t){const n=e.month,r=e.cutoffDate,a=e.revenueToDate,i=e.sellerboardMonthEnd,u=!!r,f=Number.isFinite(a)&&a>=0,l=Number.isFinite(i)&&i>=0;if(!u&&!f&&!l)return{month:n,active:!1,reason:"no_input",rawForecastRevenue:Number((t==null?void 0:t[n])||0)};const s=Number((t==null?void 0:t[n])||0);if(!(s>0))return{month:n,active:!1,reason:"missing_forecast_revenue",rawForecastRevenue:s};let c=null,m=null;if(l)c=Number(i),m="sellerboard";else{if(!Number.isFinite(a))return{month:n,active:!1,reason:"missing_inputs",rawForecastRevenue:s};if(!u||!f)return{month:n,active:!1,reason:"missing_inputs",rawForecastRevenue:s};const A=oe(r),P=re(n);if(!A||!P||!se(r,n))return{month:n,active:!1,reason:"invalid_cutoff_date",rawForecastRevenue:s};c=Number(a)*(P/A),m="linear"}if(!(Number.isFinite(c)&&c>=0))return{month:n,active:!1,reason:"invalid_expected_revenue",rawForecastRevenue:s};const b=c/s;return!Number.isFinite(b)||b<=0?{month:n,active:!1,reason:"invalid_factor",rawForecastRevenue:s}:{month:n,active:!0,reason:"ok",method:m,rawFactor:b,rawForecastRevenue:s,expectedRevenue:c}}function me(e={}){const n=(Array.isArray(e.months)?e.months.filter(d):[]).slice().sort((s,c)=>s.localeCompare(c)),r=e.forecastRevenueByMonth&&typeof e.forecastRevenueByMonth=="object"?e.forecastRevenueByMonth:{},a=te(e.horizonMonths,6),u=ue(e.incomings).map(s=>ce(s,r)),f=u.filter(s=>s.active).sort((s,c)=>s.month.localeCompare(c.month)),l={};return n.forEach(s=>{const c=D(s);if(c==null){l[s]={month:s,active:!1,factor:1,sourceMonth:null,method:null,rawFactor:null,rawForecastRevenue:Number((r==null?void 0:r[s])||0),expectedRevenue:null,horizonOffset:null};return}const m=f.filter(v=>{const S=D(v.month);if(S==null||S>c)return!1;const E=c-S;return a<=1?E===0:E<a}).sort((v,S)=>v.month.localeCompare(S.month)),b=m.length?m[m.length-1]:null;if(!b){l[s]={month:s,active:!1,factor:1,sourceMonth:null,method:null,rawFactor:null,rawForecastRevenue:Number((r==null?void 0:r[s])||0),expectedRevenue:null,horizonOffset:null};return}const A=D(b.month),P=c-A,M=ne(b.rawFactor,a,P);l[s]={month:s,active:!0,factor:Number.isFinite(M)&&M>0?M:1,sourceMonth:b.month,method:b.method||null,rawFactor:Number(b.rawFactor),rawForecastRevenue:Number((r==null?void 0:r[s])||0),expectedRevenue:Number(b.expectedRevenue),horizonOffset:P}}),{horizonMonths:a,candidates:f,evaluations:u,byMonth:l}}export{ee as C,N as a,h as b,g as c,le as d,me as e,ne as f,te as n,I as p};
