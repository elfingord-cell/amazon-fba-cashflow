import{g as bt,e as Ft,u as It,f as $t,o as Vt,h as Bt,v as _t}from"./index-LScGhqvu.js";import{b as zt}from"./supplierLabels-BolgyxWX.js";import{b as Kt,p as Ht,D as jt}from"./prefill-DQYhMWuT.js";import{e as kt,c as qt}from"./productCompleteness-CNGcv3R4.js";import{l as ht,c as ze}from"./store-kRkpVkNt.js";import{u as Wt}from"./useDraftForm-opmY9Ns9.js";const Nt=24*60*60*1e3;function Ue(e){if(e instanceof Date)return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()));if(typeof e!="string")throw new Error(`Invalid date: ${e}`);const[n,i,a]=e.split("-").map(Number);if(!n||!i||!a)throw new Error(`Invalid ISO date: ${e}`);return new Date(Date.UTC(n,i-1,a))}function Ke(e){const n=e.getUTCFullYear(),i=String(e.getUTCMonth()+1).padStart(2,"0"),a=String(e.getUTCDate()).padStart(2,"0");return`${n}-${i}-${a}`}function Ut(e){const n=e.getUTCFullYear(),i=String(e.getUTCMonth()+1).padStart(2,"0");return`${n}-${i}`}function Ce(e){const[n,i]=e.split("-").map(Number);if(!n||!i)throw new Error(`Invalid month: ${e}`);return{year:n,month:i-1}}function Yt(e,n){const i=Ce(e),a=Ce(n),d=i.year*12+i.month,D=a.year*12+a.month;return d-D}function Xt(e,n){const{year:i,month:a}=Ce(e),d=new Date(Date.UTC(i,a,1));return d.setUTCMonth(d.getUTCMonth()+n),Ut(d)}function Qt(e){const{year:n,month:i}=Ce(e);return new Date(Date.UTC(n,i,1))}function Zt(e,n){return new Date(Date.UTC(e,n+1,0)).getUTCDate()}function We(e,n){return new Date(e.getTime()+n*Nt)}function Gt(e,n,i,a){if(!e||!n||!i||!a)return 0;const d=Ue(e),D=Ue(n),y=Ue(i),v=Ue(a);if(!d||!D||!y||!v)return 0;const E=d>y?d:y,T=We(v,1),O=(D<T?D:T).getTime()-E.getTime();return O<=0?0:Math.ceil(O/Nt)}function Jt(e=[]){let n=null;return e.forEach(i=>{const a=i==null?void 0:i.month;a&&(!n||Yt(a,n)>0)&&(n=a)}),n}function en({sku:e,baselineMonth:n,stock0:i=0,forecastByMonth:a={},inboundByMonth:d={},horizonMonths:D=12}){const y=[],v=[];let E=Number(i||0);for(let T=1;T<=D;T+=1){const S=Xt(n,T),O=a==null?void 0:a[S],A=Number.isFinite(Number(O))?Number(O):0;O==null&&v.push(S);const p=Number((d==null?void 0:d[S])||0),{year:C,month:P}=Ce(S),L=Zt(C,P),b=A===0?0:A/L,R=E+p-A,k=b===0?Number.POSITIVE_INFINITY:Math.max(0,R/b);y.push({month:S,startStock:E,inbound:p,demand:A,endStock:R,avgDailyDemand:b,doh:k}),E=R}return{sku:e,baselineMonth:n,months:y,missingForecastMonths:v}}function tn({sku:e,baselineMonth:n,projection:i,safetyStockDays:a=60,coverageDays:d=90,leadTimeDays:D=0,cnyPeriod:y,inboundWithoutEtaCount:v=0,moqUnits:E=0}){var k;if(!n)return{sku:e,status:"no_snapshot",issues:[]};const T=(k=i==null?void 0:i.months)==null?void 0:k.find(m=>Number.isFinite(m.doh)&&m.doh<a);if(!T)return{sku:e,status:"no_fo_needed",baselineMonth:n,issues:vt(i,v)};const S=Qt(T.month),O=We(S,-Number(D||0)),A=Gt(O,S,y==null?void 0:y.start,y==null?void 0:y.end),p=A>0?We(O,-A):O,C=Number(a||0)+Number(d||0),P=T.avgDailyDemand*C,L=T.startStock;let b=Math.max(0,Math.ceil(P-L)),R=!1;return b>0&&E>0&&b<E&&(b=E,R=!0),{sku:e,status:"ok",baselineMonth:n,criticalMonth:T.month,requiredArrivalDate:Ke(S),orderDate:Ke(O),orderDateAdjusted:Ke(p),overlapDays:A,recommendedUnits:b,safetyStockDays:a,coverageDays:d,moqUnits:E,moqApplied:R,stockAtArrival:L,avgDailyDemand:T.avgDailyDemand,issues:vt(i,v)}}function vt(e,n){var d;const i=[],a=((d=e==null?void 0:e.missingForecastMonths)==null?void 0:d.length)||0;return a>0&&i.push({code:"MISSING_FORECAST",count:a}),n>0&&i.push({code:"INBOUND_WITHOUT_ETA",count:n}),i}const nn={monthKey:Ut};function c(e,n=document){return n.querySelector(e)}function t(e,n={},i=[]){const a=document.createElement(e);for(const[d,D]of Object.entries(n))d==="class"?a.className=D:d==="dataset"?Object.entries(D).forEach(([y,v])=>a.dataset[y]=v):d.startsWith("on")&&typeof D=="function"?a.addEventListener(d.slice(2),D):D!=null&&a.setAttribute(d,D);for(const d of[].concat(i))d!=null&&a.append(d.nodeType?d:document.createTextNode(String(d)));return a}const sn=["SEA","RAIL","AIR"],rn=["EXW","DDP"],ve=["ORDER_DATE","PRODUCTION_END","ETD","ETA","DELIVERY"],Ye=["EUR","USD","CNY"],an={DRAFT:"Draft",PLANNED:"Planned",CONVERTED:"Converted",CANCELLED:"Cancelled"};function Et(e,n="EUR"){const i=String(e||"").trim().toUpperCase();return Ye.includes(i)?i:n}function on(){return jt.map(e=>({...e}))}function Q(e){if(!e)return"—";const[n,i,a]=String(e).split("-").map(Number);if(!n||!i||!a)return"—";const d=new Date(Date.UTC(n,i-1,a));return Number.isNaN(d.getTime())?"—":d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function z(e){return Ht(e)}function un(e){return z(e)}function Z(e){const n=z(e);return!Number.isFinite(n)||n<0?null:n}function ee(e){if(!e)return null;const[n,i,a]=String(e).split("-").map(Number);if(!n||!i||!a)return null;const d=new Date(Date.UTC(n,i-1,a));return Number.isNaN(d.getTime())?null:d}function W(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?null:e.toISOString().slice(0,10)}function ie(e,n){const i=new Date(e.getTime());return i.setUTCDate(i.getUTCDate()+n),i}function Oe(e,n){const i=new Date(e.getTime());return i.setUTCMonth(i.getUTCMonth()+n),i}function me(e,n){const i=Number(e||0);return Number.isFinite(i)?i.toLocaleString("de-DE",{style:"currency",currency:n||"EUR"}):"—"}function ne(e){const n=Number(e);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function pe(e){const n=Number(e);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2}):"—"}function xe(e){const n=Number(e);return Number.isFinite(n)?Math.round(n).toLocaleString("de-DE",{maximumFractionDigits:0}):"—"}function Pt(e){return Number.isFinite(e)?Math.round(e*100)/100:null}function cn(e){var D,y;const n=((D=e==null?void 0:e.forecast)==null?void 0:D.forecastManual)||{},i=((y=e==null?void 0:e.forecast)==null?void 0:y.forecastImport)||{},a={},d=v=>{const E=String(v||"").trim();if(!E)return;a[E]||(a[E]={});const T=n[E]||{},S=i[E]||{};new Set([...Object.keys(S),...Object.keys(T)]).forEach(A=>{var P;const p=z(T[A]);if(Number.isFinite(p)){a[E][A]=p;return}const C=z((P=S[A])==null?void 0:P.units);Number.isFinite(C)&&(a[E][A]=C)})};return Object.keys(i||{}).forEach(d),Object.keys(n||{}).forEach(d),a}function ln(e){var a;const n={};return(((a=e==null?void 0:e.inventory)==null?void 0:a.snapshots)||[]).forEach(d=>{const D=d==null?void 0:d.month;D&&(d.items||[]).forEach(y=>{const v=String((y==null?void 0:y.sku)||"").trim();if(!v)return;n[v]||(n[v]={});const E=Number((y==null?void 0:y.amazonUnits)||0),T=Number((y==null?void 0:y.threePLUnits)||0);n[v][D]=E+T})}),n}function Rt(e){const n=(e==null?void 0:e.arrivalDateDe)||(e==null?void 0:e.arrivalDate)||(e==null?void 0:e.etaDate)||(e==null?void 0:e.etaManual)||(e==null?void 0:e.eta);if(n)return ee(n);const i=ee(e==null?void 0:e.orderDate);if(!i)return null;const a=Number((e==null?void 0:e.prodDays)??(e==null?void 0:e.productionLeadTimeDays)??0),d=Number((e==null?void 0:e.transitDays)??(e==null?void 0:e.logisticsLeadTimeDays)??0);return ie(i,a+d)}function St(e){return Array.isArray(e==null?void 0:e.items)&&e.items.length>0?e.items.map(n=>({sku:String((n==null?void 0:n.sku)||"").trim(),units:z(n==null?void 0:n.units)})):e!=null&&e.sku?[{sku:String(e.sku||"").trim(),units:z(e==null?void 0:e.units)}]:[]}function dn(e){const n={};let i=0;const a=nn.monthKey;return(Array.isArray(e==null?void 0:e.pos)?e.pos:[]).forEach(y=>{if(y!=null&&y.archived)return;const v=Rt(y);if(!v){i+=1;return}const E=a(v);St(y).forEach(T=>{if(!T.sku)return;const S=Number(T.units||0);!Number.isFinite(S)||S<=0||(n[T.sku]||(n[T.sku]={}),n[T.sku][E]=(n[T.sku][E]||0)+S)})}),(Array.isArray(e==null?void 0:e.fos)?e.fos:[]).forEach(y=>{const v=String((y==null?void 0:y.status)||"").toUpperCase();if(v==="CANCELLED"||v==="CONVERTED")return;const E=Rt(y);if(!E){i+=1;return}const T=a(E);St(y).forEach(S=>{if(!S.sku)return;const O=Number(S.units||0);!Number.isFinite(O)||O<=0||(n[S.sku]||(n[S.sku]={}),n[S.sku][T]=(n[S.sku][T]||0)+O)})}),{inboundBySku:n,inboundWithoutEtaCount:i}}function be(e,n,i){const a=Number(e||0);if(!Number.isFinite(a))return 0;if(!n||n==="EUR")return a;const d=Number(i||0);return!Number.isFinite(d)||d<=0?a:a/d}function fn(e){return e?String(e).slice(-6).toUpperCase():"—"}function pn(e=[]){if(!e.length)return"—";const n=e.slice(0,2).map(a=>`${a.percent||0}% ${Q(a.dueDate)}`).join(", "),i=e.length>2?` +${e.length-2}`:"";return`${e.length} payments: ${n}${i}`}function mn(e=[],n=0){return e.reduce((a,d)=>{const D=Number(d.amount||0);if(!Number.isFinite(D))return a;const y=d.currency||"EUR",v=be(D,y,n);return a+v},0)}function gn(e=[],n=0){return e.length?e.map(i=>{const a=Number(i.amount||0);if(!Number.isFinite(a))return null;const d=i.currency||"EUR",D=be(a,d,n);return`${i.label||"Payment"}: ${me(a,d)} (${me(D,"EUR")})`}).filter(Boolean).join(" | "):""}function yn(e){return e==="PRODUCTION_END"?"PROD_DONE":e||"ORDER_DATE"}function se(e,n){if(!n)return null;const i=String(n).trim().toLowerCase();return e.find(a=>String((a==null?void 0:a.sku)||"").trim().toLowerCase()===i)||null}function He(e,n){if(!n)return null;const i=String(n).trim().toLowerCase();return e.find(a=>String((a==null?void 0:a.alias)||"").trim().toLowerCase()===i)||null}function Dn(e,n){return(e||[]).filter(Boolean).map(i=>{const a=String(i.alias||"").trim(),d=String(i.sku||"").trim(),D=a||d,y=kt(i,{state:n});return{sku:d,alias:D,label:D,completeness:y}}).sort((i,a)=>i.label.localeCompare(a.label))}function bn(e){return e==="ok"?"✅ OK":e==="warn"?"⚠️ Warnung":"❌ Blockiert"}function Tt(e){var i,a,d;const n=[];return(i=e==null?void 0:e.blockingMissing)!=null&&i.length&&n.push(`Fehlt (blockierend): ${e.blockingMissing.map(D=>D.label).join(", ")}`),(a=e==null?void 0:e.defaulted)!=null&&a.length&&n.push(`Defaults aktiv: ${e.defaulted.map(D=>D.label).join(", ")}`),(d=e==null?void 0:e.suggestedMissing)!=null&&d.length&&n.push(`Empfohlen: ${e.suggestedMissing.map(D=>D.label).join(", ")}`),n.join(" • ")}function hn(e){var n;return((n=e==null?void 0:e.template)==null?void 0:n.fields)||(e==null?void 0:e.template)||{}}function Ct(e,n){const i=Kt(n.sku,{mode:"FO",supplierId:n.supplierId,transportMode:n.transportMode,incoterm:n.incoterm},{state:e}),a=String(i.incoterm).toUpperCase()==="DDP"?"USD":"EUR";return{transportMode:i.transportMode,incoterm:i.incoterm,unitPrice:i.unitPrice,unitPriceSource:i.sources.unitPrice||null,currency:i.currency,freight:i.logisticsPerUnitEur,freightMissingFields:i.logisticsMissingFields||[],freightCurrency:a,dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:i.fxRate,fxRateSource:i.sources.fxRate,supplierId:i.supplierId,supplierSource:i.sources.supplier,productionLeadTimeDays:i.productionLeadTimeDays,productionLeadTimeSource:i.sources.productionLeadTimeDays,incotermSource:i.sources.incoterm,paymentTermsSource:i.sources.paymentTerms,preferredSupplier:!1,logisticsLeadTimeDays:i.logisticsLeadTimeDays,bufferDays:i.bufferDays}}function re(e){const n=ee(e.targetDeliveryDate),i=Z(e.productionLeadTimeDays),a=Number(e.logisticsLeadTimeDays||0),d=Number(e.bufferDays||0);if(!n||i==null||i===0)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null,deliveryDate:null};const D=ie(n,-(i+a+d)),y=ie(D,i),v=y,E=ie(v,a);return{orderDate:W(D),productionEndDate:W(y),etdDate:W(v),etaDate:W(E),deliveryDate:W(n),logisticsLeadTimeDays:a}}function De(e){const n=z(e.unitPrice)||0,i=Number(e.units||0),a=i*n,d=z(e.fxRate)||0,D=e.currency||"USD",y=be(a,D,d),v=z(e.freight)||0,E=v*i,T=e.freightCurrency||"EUR",S=be(E,T,d),O=z(e.dutyRatePct)||0,A=O>0?y*(O/100):0,p=z(e.eustRatePct)||0,C=p>0?(y+A+S)*(p/100):0,P=y+A+S+C;return{unitPrice:n,units:i,supplierCost:a,supplierCostEur:y,freightPerUnit:v,freightTotal:E,freightCurrency:T,freightEur:S,dutyRatePct:O,eustRatePct:p,fxRate:d,landedCostEur:P}}function vn(e){return!e||!e.length?"":`Logistik nicht berechenbar – ${e.map(i=>i==="landedCostEur"?"Einstandspreis":i==="unitPriceUsd"?"Unit Price":i==="fxUsdPerEur"?"FX":i).join(", ")} fehlt`}function je({product:e,units:n,unitPrice:i,currency:a,fxRate:d}){const D=[],y=z(e==null?void 0:e.landedUnitCostEur),v=String(a||"USD").toUpperCase(),E=hn(e),T=z(E.unitPriceUsd??(e==null?void 0:e.unitPriceUsd)??(e==null?void 0:e.defaultUnitPrice)??(e==null?void 0:e.unitPrice)),S=v==="USD"?z(i)??T:T,O=z(E.extraPerUnitUsd??(e==null?void 0:e.extraPerUnitUsd))||0,A=z(d),p=qt({unitPriceUsd:S!=null?S+O:S,landedCostEur:y,fxUsdPerEur:A});if(p.missingFields.length)return p.missingFields.forEach(R=>{R==="landedCostEur"&&D.push("Einstandspreis (EUR) fehlt (Produkt)"),R==="unitPriceUsd"&&D.push("Stückpreis USD fehlt (Produkt/FO)"),R==="fxUsdPerEur"&&D.push("FX (USD je EUR) fehlt (FO/Settings)")}),{total:null,perUnit:null,warning:!1,missing:!0,missingFields:D};const C=p.warning,P=p.value!=null?Pt(p.value):null,L=Number(n||0);return{total:P!=null&&L>0?Pt(P*L):null,perUnit:P,warning:C,missing:!1,missingFields:[]}}function Me(e,n,i,a){const d=ee(e);if(!d)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null};const D=ie(d,Number(n||0)+Number(i||0)),y=D,v=ie(y,Number(a||0));return{orderDate:W(d),productionEndDate:W(D),etdDate:W(y),etaDate:W(v),logisticsLeadTimeDays:Number(a||0)}}function we(e,n){const i={ORDER_DATE:e!=null&&e.orderDate?ee(e.orderDate):null,PRODUCTION_END:e!=null&&e.productionEndDate?ee(e.productionEndDate):null,ETD:e!=null&&e.etdDate?ee(e.etdDate):null,ETA:e!=null&&e.etaDate?ee(e.etaDate):null,DELIVERY:e!=null&&e.deliveryDate?ee(e.deliveryDate):n?ee(n):null};return!i.ETD&&i.ETA&&Number.isFinite(Number(e==null?void 0:e.logisticsLeadTimeDays))&&(i.ETD=ie(i.ETA,-Number(e.logisticsLeadTimeDays||0))),i}function Fe(e,n){const i=ve.includes(e)?e:"ORDER_DATE";return(n==null?void 0:n[i])||null}function En(e,n){const i=we(n||{},n==null?void 0:n.deliveryDate);return e.map(a=>{const d=ve.includes(a.triggerEvent)?a.triggerEvent:"ORDER_DATE",D=Number(a.offsetDays||0),y=Number(a.offsetMonths||0),v=Fe(d,i);let E=a.dueDate;if(!(a.dueDateManuallySet===!0||!!a.paidDate||a.dueDate&&typeof a.dueDateManuallySet>"u")){let S=v?ie(v,D):null;S&&y&&(S=Oe(S,y)),E=S?W(S):null}return{...a,triggerEvent:d,offsetDays:D,offsetMonths:y,dueDate:E}})}function Ae({supplier:e,baseValue:n,currency:i,schedule:a,freight:d,freightCurrency:D,dutyRatePct:y,eustRatePct:v,fxRate:E,supplierCostEur:T,incoterm:S}){const O=Array.isArray(e==null?void 0:e.paymentTermsDefault)&&e.paymentTermsDefault.length?e.paymentTermsDefault:on(),A=we(a||{},a==null?void 0:a.deliveryDate),p=O.map(k=>{const m=ve.includes(k.triggerEvent)?k.triggerEvent:"ORDER_DATE",w=Number(k.offsetDays||0),x=Number(k.offsetMonths||0),s=n*(Number(k.percent||0)/100),N=Fe(m,A);let K=N?W(ie(N,w)):null;return K&&x&&(K=W(Oe(ee(K),x))),{id:`pay-${Math.random().toString(36).slice(2,9)}`,label:k.label||"Milestone",percent:Number(k.percent||0),amount:s,currency:i||"EUR",triggerEvent:m,offsetDays:w,offsetMonths:x,dueDate:K,isOverridden:!1,dueDateManuallySet:!1,category:"supplier"}}),C=[],P=String(S||"").toUpperCase(),L=Number(d||0);P!=="DDP"&&L>0&&C.push({id:`freight-${Math.random().toString(36).slice(2,9)}`,label:"Fracht",percent:0,amount:L,currency:D||"EUR",triggerEvent:"ETD",offsetDays:0,dueDate:A.ETD?W(A.ETD):null,isOverridden:!1,dueDateManuallySet:!1,category:"freight"});const b=Number(y||0);if(P!=="DDP"&&b>0){const k=T;C.push({id:`duty-${Math.random().toString(36).slice(2,9)}`,label:"Duty",percent:b,amount:k*(b/100),currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:A.ETA?W(A.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"duty"})}const R=Number(v||0);if(P!=="DDP"&&R>0){const k=be(L,D,E),m=b>0?T*(b/100):0,x=(T+m+k)*(R/100);C.push({id:`eust-${Math.random().toString(36).slice(2,9)}`,label:"EUSt",percent:R,amount:x,currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:A.ETA?W(A.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust"}),C.push({id:`eust-refund-${Math.random().toString(36).slice(2,9)}`,label:"EUSt Erstattung",percent:R,amount:-x,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:2,dueDate:A.ETA?W(Oe(A.ETA,2)):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust_refund"})}return[...p,...C]}function Lt(e,n){const{baseValue:i,schedule:a,currency:d,freight:D,freightCurrency:y,dutyRatePct:v,eustRatePct:E,fxRate:T,supplierCostEur:S,incoterm:O}=n,A=Number(v||0),p=Number(E||0),C=Number(D||0),P=be(C,y,T),L=A>0?S*(A/100):0,b=S+L+P,R=String(O||"").toUpperCase(),k=we(a||{},a==null?void 0:a.deliveryDate);return e.map(m=>{const w=ve.includes(m.triggerEvent)?m.triggerEvent:"ORDER_DATE",x=Number(m.offsetDays||0),s=Number(m.offsetMonths||0);let N=Number(m.amount||0);m.category==="supplier"?N=i*(Number(m.percent||0)/100):m.category==="freight"?N=C:m.category==="duty"?N=R==="DDP"?0:L:m.category==="eust"?N=R==="DDP"?0:p>0?b*(p/100):0:m.category==="eust_refund"&&(N=p>0?b*(p/100):0,N=-N);let K=m.dueDate;if(!(m.dueDateManuallySet===!0||!!m.paidDate||m.dueDate&&typeof m.dueDateManuallySet>"u")){const g=Fe(w,k);let U=g?ie(g,x):null;U&&s&&(U=Oe(U,s)),K=U?W(U):null}const M=m.category==="supplier"?d||"EUR":m.category==="freight"&&y||"EUR";return{...m,triggerEvent:w,offsetDays:x,amount:N,currency:M,dueDate:K}})}function Te(e,n){return String(n||"").toUpperCase()!=="DDP"?e:e.filter(a=>a.category!=="freight")}function qe(e,n,i=[],a){const d=t("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),D=t("div",{class:"po-modal fo-modal-frame"},[t("header",{class:"po-modal-header"},[t("h3",{},[e]),t("button",{class:"btn ghost",type:"button",onclick:()=>{if(typeof a=="function"){a();return}d.remove()},"aria-label":"Schließen"},["✕"])]),t("div",{class:"po-modal-body"},[n]),t("footer",{class:"po-modal-actions"},i)]);d.append(D),document.body.append(d);let y=!1;return d.addEventListener("mousedown",v=>{y=v.target===d}),d.addEventListener("mouseup",v=>{y&&v.target===d&&(typeof a=="function"?a():d.remove()),y=!1}),d}function Pn(e,n,i){const a=new Date().toISOString(),d=e.productionLeadTimeDaysManual!=null?Number(e.productionLeadTimeDaysManual):null,D=Z(e.productionLeadTimeDays);return{id:e.id,sku:e.sku,supplierId:e.supplierId,targetDeliveryDate:e.targetDeliveryDate,units:Number(e.units||0),transportMode:e.transportMode,incoterm:e.incoterm,unitPrice:z(e.unitPrice)||0,unitPriceIsOverridden:!!e.unitPriceIsOverridden,currency:Et(e.currency,"EUR"),freight:z(e.freight)||0,freightCurrency:Et(e.freightCurrency,"EUR"),dutyRatePct:z(e.dutyRatePct)||0,eustRatePct:z(e.eustRatePct)||0,fxRate:z(e.fxRate)||0,productionLeadTimeDays:Number.isFinite(D)?D:null,productionLeadTimeDaysManual:Number.isFinite(d)?d:null,productionLeadTimeSource:e.productionLeadTimeSource||null,logisticsLeadTimeDays:Number(e.logisticsLeadTimeDays||0),bufferDays:Number(e.bufferDays||0),orderDate:n.orderDate,productionEndDate:n.productionEndDate,etdDate:n.etdDate,etaDate:n.etaDate,deliveryDate:n.deliveryDate,payments:i,status:e.status||"DRAFT",convertedPoId:e.convertedPoId||null,convertedPoNo:e.convertedPoNo||null,createdAt:e.createdAt||a,updatedAt:a}}function Nn(e){const n=ht();Array.isArray(n.fos)||(n.fos=[]),Array.isArray(n.suppliers)||(n.suppliers=[]);const i=bt(),a=zt(n,i);e.innerHTML=`
    <section class="card">
      <h2>Forecast Orders (FO)</h2>
      <div class="table-card-header">
        <span class="muted">Planung neuer Bestände</span>
        <div class="fo-toolbar">
          <input type="text" id="fo-search" placeholder="Alias oder SKU suchen" />
          <select id="fo-status-filter">
            <option value="ALL">Status: Alle</option>
            <option value="DRAFT">Draft</option>
            <option value="PLANNED">Planned</option>
            <option value="CONVERTED">Converted</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
          <button class="btn primary" id="fo-add">Create FO</button>
        </div>
      </div>
      <div id="fo-table"></div>
    </section>
  `;const d=c("#fo-table",e),D=c("#fo-search",e),y=c("#fo-status-filter",e);function v(p,C,P){const L=`po-${Math.random().toString(36).slice(2,9)}`,b=String(C||"").trim(),R=z(p.fxRate)||0,k=be(z(p.freight)||0,p.freightCurrency,R),m=(p.payments||[]).filter(N=>N.category==="supplier").map(N=>({id:N.id||`ms-${Math.random().toString(36).slice(2,9)}`,label:N.label||"Milestone",percent:Number(N.percent||0),anchor:yn(N.triggerEvent),lagDays:Number(N.offsetDays||0)})),w=Number(p.productionLeadTimeDays||0)+Number(p.bufferDays||0),x=Number(p.logisticsLeadTimeDays||0),s=Me(P,w,0,x);return{id:L,poNo:b,sku:p.sku,supplierId:p.supplierId,units:Number(p.units||0),unitCostUsd:ne(p.unitPrice||0),unitExtraUsd:"0,00",extraFlatUsd:"0,00",orderDate:s.orderDate||p.orderDate||null,prodDays:w,transitDays:x,transport:p.transportMode||"SEA",freightEur:ne(k),dutyRatePct:pe(p.dutyRatePct||0),eustRatePct:pe(p.eustRatePct||0),fxOverride:ne(R||0),ddp:String(p.incoterm||"").toUpperCase()==="DDP",milestones:m,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}function E(){var R,k;const p=(((R=c("#fo-search",e))==null?void 0:R.value)||"").trim().toLowerCase(),C=((k=c("#fo-status-filter",e))==null?void 0:k.value)||"ALL",P=n.fos.slice().filter(m=>{if(C!=="ALL"&&String(m.status||"DRAFT").toUpperCase()!==C)return!1;if(!p)return!0;const w=se(i,m.sku),x=String((w==null?void 0:w.alias)||"").toLowerCase(),s=String(m.sku||"").toLowerCase();return x.includes(p)||s.includes(p)}).sort((m,w)=>(m.targetDeliveryDate||"").localeCompare(w.targetDeliveryDate||""));if(!P.length){d.innerHTML='<p class="muted">Keine Forecast Orders vorhanden.</p>';return}const L=P.map(m=>{var ae;const w=n.suppliers.find(B=>B.id===m.supplierId),x=se(i,m.sku),s=re(m),N=De(m),K=je({product:x,units:Number(m.units||0),unitPrice:m.unitPrice,currency:m.currency,fxRate:m.fxRate||((ae=n.settings)==null?void 0:ae.fxRate)}),$=pn(m.payments),M=mn(m.payments,m.fxRate),g=gn(m.payments,m.fxRate),U=String(m.status||"DRAFT").toUpperCase();return{fo:m,supplierLabel:w&&(a.get(w.id)||w.name)||"—",alias:(x==null?void 0:x.alias)||m.sku||"—",skuLabel:m.sku||"—",schedule:s,costValues:N,freightEstimate:K,paymentsSummary:$,paymentsTotal:M,paymentsTooltip:g,status:U,statusLabel:an[U]||U,statusClass:`badge${U==="CONVERTED"?" muted":""}`}}),b=[{key:"id",label:"FO ID"},{key:"product",label:"Produkt"},{key:"supplier",label:"Supplier"},{key:"units",label:"Units",className:"num"},{key:"target",label:"Target Delivery"},{key:"order",label:"Order Date"},{key:"timeline",label:"ETD / ETA"},{key:"total",label:"Total Value (EUR)",className:"num"},{key:"freight",label:"Geschätzte Fracht (EUR)",className:"num"},{key:"payments",label:"Payments"},{key:"status",label:"Status"},{key:"actions",label:"Actions"}];d.innerHTML="",d.append(Ft({columns:b,rows:L,rowKey:m=>m.fo.id,rowAttrs:m=>({dataset:{id:m.fo.id}}),renderCell:(m,w)=>{var s,N;const{fo:x}=m;switch(w.key){case"id":return fn(x.id);case"product":return t("div",{class:"fo-product-cell"},[t("strong",{},[m.alias]),t("small",{class:"muted"},[m.skuLabel])]);case"supplier":return t("button",{class:"btn ghost fo-link",type:"button",dataset:{action:"supplier"}},[m.supplierLabel]);case"units":return Number(x.units||0).toLocaleString("de-DE");case"target":return Q(x.targetDeliveryDate);case"order":return Q(x.orderDate);case"timeline":return t("div",{class:"fo-date-stack"},[t("span",{},[`ETD ${Q(x.etdDate||m.schedule.etdDate)}`]),t("span",{class:"muted"},[`ETA ${Q(x.etaDate||m.schedule.etaDate)}`])]);case"total":return me(m.costValues.landedCostEur,"EUR");case"freight":{const K=(s=m.freightEstimate)==null?void 0:s.total,$=((N=m.freightEstimate)==null?void 0:N.missingFields)||[],M=$.length?`Fehlend: ${$.join(", ")}`:"";return t("span",{title:M},[K==null?"—":me(K,"EUR")])}case"payments":return t("div",{title:m.paymentsTooltip},[m.paymentsSummary,t("br"),t("span",{class:"muted"},[me(m.paymentsTotal,"EUR")])]);case"status":return t("span",{class:m.statusClass},[m.statusLabel]);case"actions":return t("div",{class:"table-actions"},[t("button",{class:"btn",type:"button",dataset:{action:"edit"}},["View/Edit"]),t("button",{class:"btn secondary",type:"button",dataset:{action:"convert"},disabled:m.status==="CONVERTED"?"true":null},["Convert to PO"]),t("button",{class:"btn danger",type:"button",dataset:{action:"delete"}},["Delete"])]);default:return"—"}}}))}D&&D.addEventListener("input",E),y&&y.addEventListener("change",E);function T(p,C=[],P){const L=t("div",{class:"fo-info-list"},C.map(m=>t("p",{class:"muted"},[m]))),b=t("button",{class:"btn",type:"button"},["Schließen"]),R=t("button",{class:"btn primary",type:"button",onclick:()=>{k.remove(),location.hash="#suppliers"}},["Zu Suppliers"]),k=qe(p,L,R?[b,R]:[b]);b.addEventListener("click",()=>k.remove())}function S(p){const C=(n.pos||[]).map(M=>String(M.poNo||"").trim()).filter(Boolean);let L=re(p).orderDate||p.orderDate||"",b=Me(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0);const R=t("div",{class:"fo-convert-modal"},[t("label",{},["PO Number (Ventory One)",t("input",{type:"text",id:"fo-po-number",placeholder:"e.g. 250029",maxlength:"30"}),t("small",{class:"muted"},["Must match Ventory One PO number"]),t("small",{class:"form-error",id:"fo-po-error"},[])]),t("label",{style:"margin-top:10px"},["Order Date (PO)",t("input",{type:"date",id:"fo-po-order-date",value:L}),t("div",{class:"fo-convert-actions"},[t("button",{class:"btn secondary",type:"button",id:"fo-po-today"},["Today"])]),t("small",{class:"muted"},["Default is calculated from FO backward scheduling."])]),t("div",{class:"fo-convert-preview"},[t("p",{class:"muted"},["This will update PO dates:"]),t("div",{class:"fo-date-stack"},[t("span",{id:"fo-preview-production-convert"},["Production End: —"]),t("span",{id:"fo-preview-etd-convert"},["ETD: —"]),t("span",{id:"fo-preview-eta-convert"},["ETA: —"])])])]),k=t("button",{class:"btn primary",type:"button",disabled:"true"},["Convert"]),m=t("button",{class:"btn",type:"button"},["Cancel"]),w=qe("Convert FO to PO",R,[m,k]),x=c("#fo-po-number",R),s=c("#fo-po-order-date",R),N=c("#fo-po-error",R);function K(){b=Me(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0),c("#fo-preview-production-convert",R).textContent=`Production End: ${Q(b.productionEndDate)}`,c("#fo-preview-etd-convert",R).textContent=`ETD: ${Q(b.etdDate)}`,c("#fo-preview-eta-convert",R).textContent=`ETA: ${Q(b.etaDate)}`}function $(){const M=x.value.trim();let g="";return M||(g="PO number is required."),M.length>30&&(g="Max length is 30."),C.includes(M)&&(g="PO number already exists."),L||(g=g||"Order date is required."),N.textContent=g,k.disabled=!!g,!g}c("#fo-po-today",R).addEventListener("click",()=>{const M=new Date;L=W(new Date(Date.UTC(M.getFullYear(),M.getMonth(),M.getDate()))),s.value=L,K()}),x.addEventListener("input",$),s.addEventListener("input",M=>{L=M.target.value,K()}),m.addEventListener("click",()=>w.remove()),K(),$(),k.addEventListener("click",()=>{if(!$())return;const M=Me(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0);p.orderDate=M.orderDate,p.productionEndDate=M.productionEndDate,p.etdDate=M.etdDate,p.etaDate=M.etaDate,p.payments=En(p.payments||[],M);const g=v(p,x.value,M.orderDate);Array.isArray(n.pos)||(n.pos=[]),n.pos.push(g),p.status="CONVERTED",p.convertedPoId=g.id,p.convertedPoNo=g.poNo,p.updatedAt=new Date().toISOString(),ze(n,{source:"fo:convert",entityKey:`fo:${p.id}`,action:"update"}),E(),w.remove(),window.confirm("PO created. Open PO?")&&(location.hash="#po")})}function O(p,C={}){var at,ot,ut,ct,lt,dt,ft,pt,mt;const P=bt(),L=Dn(P,n),b=!!p,R=String((p==null?void 0:p.status)||"").toUpperCase()==="CONVERTED",k=cn(n),m=ln(n),w=dn(n),x={anchorMonth:(C==null?void 0:C.anchorMonth)||""};let s=p?JSON.parse(JSON.stringify(p)):{id:`fo-${Math.random().toString(36).slice(2,9)}`,sku:"",supplierId:"",targetDeliveryDate:"",units:"",transportMode:"SEA",incoterm:"EXW",unitPrice:"",unitPriceIsOverridden:!1,currency:((at=n.settings)==null?void 0:at.defaultCurrency)||"EUR",freight:"",freightCurrency:"EUR",dutyRatePct:((ot=n.settings)==null?void 0:ot.dutyRatePct)??0,eustRatePct:((ut=n.settings)==null?void 0:ut.eustRatePct)??0,fxRate:((ct=n.settings)==null?void 0:ct.fxRate)??"",productionLeadTimeDays:"",productionLeadTimeDaysManual:null,productionLeadTimeSource:null,logisticsLeadTimeDays:"",bufferDays:((lt=n.settings)==null?void 0:lt.defaultBufferDays)??0,payments:[],status:"DRAFT",createdAt:new Date().toISOString()};if(!b&&C){const r=String(C.sku||"").trim(),o=String(C.alias||"").trim(),u=se(P,r)||He(P,o)||He(P,r);u!=null&&u.sku?s.sku=u.sku:r&&(s.sku=r),C.targetDeliveryDate&&(s.targetDeliveryDate=C.targetDeliveryDate)}s.freightCurrency||(s.freightCurrency="EUR"),s.freight==null&&(s.freight=""),s.dutyRatePct==null&&(s.dutyRatePct=((dt=n.settings)==null?void 0:dt.dutyRatePct)??0),s.eustRatePct==null&&(s.eustRatePct=((ft=n.settings)==null?void 0:ft.eustRatePct)??0),s.fxRate==null&&(s.fxRate=((pt=n.settings)==null?void 0:pt.fxRate)??""),s.currency||(s.currency="USD"),typeof s.productionLeadTimeDaysManual>"u"&&(s.productionLeadTimeDaysManual=null),s.productionLeadTimeSource||(s.productionLeadTimeSource=null),Array.isArray(s.payments)&&(s.payments=s.payments.map(r=>({...r,category:r.category||"supplier"})));const N=Wt(s,{key:`fo:${s.id||"new"}`,enableDraftCache:!1});s=N.draft;const K=It(()=>N.isDirty,"Ungespeicherte Änderungen verwerfen?");K.register(),K.attachBeforeUnload();const $={transportMode:b,incoterm:b,currency:b,freightCurrency:b,freight:b,dutyRatePct:b,eustRatePct:b,fxRate:b,productionLeadTimeDays:b,logisticsLeadTimeDays:b,bufferDays:b};s.productionLeadTimeDaysManual!=null&&($.productionLeadTimeDays=!0),typeof s.unitPriceIsOverridden!="boolean"&&(s.unitPriceIsOverridden=b);let M=b&&Array.isArray(s.payments)&&s.payments.length>0,g=Ct(n,s);function U(r,o){s[r]=o,$[r]=!1,r==="productionLeadTimeDays"&&(s.productionLeadTimeDaysManual=null,s.productionLeadTimeSource=g.productionLeadTimeSource||null);const u=c(`#fo-${r}`,f);if(u){const l=o==null?"":["unitPrice","freight","fxRate"].includes(r)?ne(o):["dutyRatePct","eustRatePct"].includes(r)?pe(o):o;u.value=l}}function ae(){const r=s.supplierId;if(g=Ct(n,s),!s.supplierId&&g.supplierId){s.supplierId=g.supplierId;const o=c("#fo-supplierId",f);o&&(o.value=g.supplierId)}if($.transportMode||U("transportMode",g.transportMode),$.incoterm||U("incoterm",g.incoterm),s.unitPriceIsOverridden||U("unitPrice",g.unitPrice??""),$.currency||U("currency",g.currency||"USD"),$.freight||U("freight",g.freight??""),$.freightCurrency||U("freightCurrency",g.freightCurrency||"EUR"),$.dutyRatePct||U("dutyRatePct",g.dutyRatePct??""),$.eustRatePct||U("eustRatePct",g.eustRatePct??""),$.fxRate||U("fxRate",g.fxRate??""),$.productionLeadTimeDays||U("productionLeadTimeDays",g.productionLeadTimeDays),$.logisticsLeadTimeDays||U("logisticsLeadTimeDays",g.logisticsLeadTimeDays),$.bufferDays||U("bufferDays",g.bufferDays),B(),Ze(),Xe(),Qe(),!M&&s.supplierId&&s.supplierId!==r){const o=re(s),u=ge(),l=n.suppliers.find(_=>_.id===s.supplierId)||null,h=De(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(h.dutyRatePct=0,h.eustRatePct=0),s.payments=Ae({supplier:l,baseValue:u,currency:s.currency,schedule:o,freight:h.freightTotal,freightCurrency:h.freightCurrency,dutyRatePct:h.dutyRatePct,eustRatePct:h.eustRatePct,fxRate:h.fxRate,supplierCostEur:h.supplierCostEur,incoterm:s.incoterm}),s.payments=Te(s.payments,s.incoterm)}}function B(){var l;if(c("#suggested-transport",f).textContent=`Suggested: ${g.transportMode}`,c("#suggested-incoterm",f).textContent=`Suggested: ${g.incoterm}`,g.unitPrice!=null){const h=g.unitPriceSource?` (Quelle: ${g.unitPriceSource})`:"";c("#suggested-unitPrice",f).textContent=`Suggested: ${ne(g.unitPrice)}${h}`}else c("#suggested-unitPrice",f).textContent="Suggested: —";c("#suggested-currency",f).textContent=`Suggested: ${g.currency||"USD"}`,c("#suggested-freight",f).textContent=`Suggested: ${g.freight!=null?ne(g.freight):"—"}`;const r=c("#fo-freight-warning",f);r&&(r.textContent=(l=g.freightMissingFields)!=null&&l.length?vn(g.freightMissingFields):""),c("#suggested-freightCurrency",f).textContent=`Suggested: ${g.freightCurrency||"EUR"}`,c("#suggested-dutyRatePct",f).textContent=`Suggested: ${g.dutyRatePct!=null?pe(g.dutyRatePct):"—"} %`,c("#suggested-eustRatePct",f).textContent=`Suggested: ${g.eustRatePct!=null?pe(g.eustRatePct):"—"} %`,c("#suggested-fxRate",f).textContent=`Suggested: ${g.fxRate!=null?ne(g.fxRate):"—"}`;const o=g.productionLeadTimeDays!=null?g.productionLeadTimeDays:"—",u=g.productionLeadTimeSource?` (Quelle: ${g.productionLeadTimeSource})`:"";c("#suggested-productionLeadTimeDays",f).textContent=`Vorschlag: ${o}${u}`,c("#suggested-logisticsLeadTimeDays",f).textContent=`Suggested: ${g.logisticsLeadTimeDays}`,c("#suggested-bufferDays",f).textContent=`Suggested: ${g.bufferDays}`,xt()}function xt(){var j,I;const r=c(".fo-suggestion-list",f);if(!r)return;r.innerHTML="";const o=s.supplierId&&s.supplierId!==g.supplierId?"Manual override":g.supplierSource||"—",u=s.unitPriceIsOverridden?"Manual override":g.unitPriceSource||"—",l=$.productionLeadTimeDays?"Manual override":g.productionLeadTimeSource||"missing",h=$.incoterm?"Manual override":g.incotermSource||"—",_=Array.isArray(s.payments)&&s.payments.length&&g.paymentTermsSource||"—",Y=$.fxRate?"Manual override":g.fxRateSource||"—",H=se(P,s.sku),X=je({product:H,units:Number(s.units||0),unitPrice:s.unitPrice,currency:s.currency,fxRate:s.fxRate||((j=n.settings)==null?void 0:j.fxRate)}),G=(I=X==null?void 0:X.missingFields)!=null&&I.length?` Fehlend: ${X.missingFields.join(", ")}`:"";r.append(t("li",{},[`Supplier source: ${o}`]),t("li",{},[`Price source: ${u}`]),t("li",{},[`Production lead time source: ${l}`]),t("li",{},[`Incoterm source: ${h}`]),t("li",{},[`Payment terms source: ${_}`]),t("li",{},[`FX source: ${Y}`]),t("li",{},[`Logistikquelle: Einstandspreis (Produkt) + FX (Settings) + Stückpreis USD (Produkt/FO).${G}`]))}function Xe(){var l;const r=c("#fo-warning-info",f),o=c(".fo-warning-list",f);if(!r||!o)return;o.innerHTML="";const u=se(P,s.sku);if(s.sku&&!s.supplierId&&!(u!=null&&u.supplierId)&&o.append(t("li",{},["Supplier fehlt in Produktdaten."])),u){const h=((l=u.template)==null?void 0:l.fields)||{},_=u.freight!=null||u.freightAir!=null||u.freightSea!=null||u.freightRail!=null||h.freightEur!=null,Y=u.dutyRatePct!=null||h.dutyPct!=null,H=u.eustRatePct!=null||h.vatImportPct!=null;(!_||!Y||!H)&&o.append(t("li",{},["Produktkosten fehlen (Logistik/Zoll/EUSt)."," ",t("button",{class:"btn ghost fo-fix-now",type:"button",dataset:{sku:u.sku,tab:"produkte"}},["Fix now"])]))}r.style.display=o.childElementCount?"block":"none"}function Qe(){var Re,Se,ue,Ne,gt,yt,Dt;const r=c("#fo-recommendation",f),o=c("#fo-recommendation-summary",f),u=c("#fo-recommendation-details",f),l=c("#fo-recommendation-baseline",f),h=c("#fo-recommendation-critical",f),_=c("#fo-recommendation-arrival",f),Y=c("#fo-recommendation-order",f),H=c("#fo-recommendation-units",f),X=c("#fo-recommendation-issues",f),G=c("#fo-recommendation-notes",f);if(!r||!o||!u||!l||!h||!_||!Y||!H||!X||!G)return;X.innerHTML="",G.textContent="";const j=String(s.sku||"").trim();if(!j){o.textContent="SKU auswählen, um Empfehlung zu sehen.",u.style.display="none";return}const I=Jt(((Re=n==null?void 0:n.inventory)==null?void 0:Re.snapshots)||[]);if(!I){o.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",u.style.display="none";return}const V=se(P,j),oe=Number((V==null?void 0:V.safetyStockDohOverride)??((Se=n.settings)==null?void 0:Se.safetyStockDohDefault)??60),J=Number((V==null?void 0:V.foCoverageDohOverride)??((ue=n.settings)==null?void 0:ue.foCoverageDohDefault)??90),Pe=Number(s.productionLeadTimeDays||0)+Number(s.logisticsLeadTimeDays||0)+Number(s.bufferDays||0),de=((Ne=m==null?void 0:m[j])==null?void 0:Ne[I])??0,fe=en({sku:j,baselineMonth:I,stock0:de,forecastByMonth:(k==null?void 0:k[j])||{},inboundByMonth:((gt=w.inboundBySku)==null?void 0:gt[j])||{},horizonMonths:12}),q=tn({sku:j,baselineMonth:I,projection:fe,safetyStockDays:oe,coverageDays:J,leadTimeDays:Pe,cnyPeriod:(yt=n==null?void 0:n.settings)==null?void 0:yt.cny,inboundWithoutEtaCount:w.inboundWithoutEtaCount,moqUnits:Number((V==null?void 0:V.moqOverrideUnits)??(V==null?void 0:V.moqUnits)??((Dt=n.settings)==null?void 0:Dt.moqDefaultUnits)??0)});if(l.textContent=`Closing Snapshot ${I}`,u.style.display="flex",q.status==="no_fo_needed")o.textContent="Keine FO innerhalb des Horizons erforderlich.",h.textContent="—",_.textContent="—",Y.textContent="—",H.textContent="—";else if(q.status==="ok"){o.textContent="Empfehlung basierend auf dem letzten Closing Snapshot.",h.textContent=q.criticalMonth||"—",_.textContent=q.requiredArrivalDate?Q(q.requiredArrivalDate):"—",Y.textContent=q.orderDateAdjusted?Q(q.orderDateAdjusted):"—",H.textContent=`SKU ${j}: ${xe(q.recommendedUnits)}`;const ce=[];q.overlapDays>0&&ce.push(`CNY berücksichtigt: +${q.overlapDays} Tage`),ce.push(`Safety DOH: ${xe(q.safetyStockDays)} · Coverage DOH: ${xe(q.coverageDays)}`),q.moqApplied&&ce.push(`MOQ berücksichtigt: ${xe(q.moqUnits)} Einheiten`),G.textContent=ce.join(" • ")}else o.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",u.style.display="none";(q.issues||[]).forEach(ce=>{const wt=ce.count?`${ce.code} (${ce.count})`:ce.code;X.append(t("span",{class:"badge fo-recommendation-badge"},[wt]))})}function Ze(){const r=String(s.incoterm||"").toUpperCase()==="DDP",o=c("#fo-dutyRatePct",f),u=c("#fo-eustRatePct",f),l=c("#fo-freightCurrency",f);r&&(s.dutyRatePct=0,s.eustRatePct=0,s.freightCurrency="USD",o&&(o.value=pe(0)),u&&(u.value=pe(0)),l&&(l.value="USD")),o&&(o.disabled=r),u&&(u.disabled=r),l&&(l.disabled=r)}function Ie(){const r=String(s.sku||"").trim(),o=P.some(h=>String(h.sku||"").trim().toLowerCase()===r.toLowerCase()),u=c("#fo-product-banner",f);r&&!o?u.style.display="block":u.style.display="none";const l=c("#fo-sku-display",f);l&&(l.textContent=r?`SKU: ${r}`:"SKU: —")}function le(){const r=re(s),o=ge(),u=De(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(u.dutyRatePct=0,u.eustRatePct=0),s.payments=Lt(s.payments,{baseValue:o,schedule:r,currency:s.currency,freight:u.freight,freightCurrency:u.freightCurrency,dutyRatePct:u.dutyRatePct,eustRatePct:u.eustRatePct,fxRate:u.fxRate,supplierCostEur:u.supplierCostEur,incoterm:s.incoterm}),s.payments=Te(s.payments,s.incoterm),nt(),Je(),Ge(r),tt(u),et(),rt()}function Ge(r){c("#fo-preview-order",f).textContent=Q(r.orderDate),c("#fo-preview-production",f).textContent=Q(r.productionEndDate),c("#fo-preview-etd",f).textContent=Q(r.etdDate),c("#fo-preview-eta",f).textContent=Q(r.etaDate),c("#fo-preview-target",f).textContent=Q(s.targetDeliveryDate);const o=c("#fo-user-anchor",f);o&&(x.anchorMonth?(o.textContent=`User-Anker: ETA-Monat ${x.anchorMonth}`,o.style.display="block"):(o.textContent="",o.style.display="none"));const u=[];s.targetDeliveryDate||u.push("Zieltermin"),(!Number.isFinite(Number(s.productionLeadTimeDays))||Number(s.productionLeadTimeDays)<=0)&&u.push("Produktionszeit"),(!Number.isFinite(Number(s.logisticsLeadTimeDays))||Number(s.logisticsLeadTimeDays)<=0)&&u.push("Frachtlaufzeit");const l=c("#fo-schedule-missing",f),h=c("#fo-schedule-missing-list",f);l&&h&&(h.innerHTML="",u.forEach(X=>h.append(t("li",{},[X]))),l.style.display=u.length?"block":"none");const _=ee(r.etaDate),Y=ee(s.targetDeliveryDate),H=c("#fo-date-warning",f);_&&Y&&_>Y?(H.textContent="Warnung: ETA liegt nach dem Zieltermin.",H.style.display="block"):(H.textContent="",H.style.display="none")}function Je(){const r=s.payments.filter(u=>u.category==="supplier").reduce((u,l)=>u+(Number(l.percent)||0),0),o=c("#fo-payment-total",f);Math.round(r)===100?(o.textContent="Summe: 100%",o.style.color="#0f9960"):(o.textContent=`Summe: ${r.toFixed(2)}% (muss 100% sein)`,o.style.color="#c23636")}function et(){const r=c("#fo-ddp-note",f);if(!r)return;const o=String(s.incoterm||"").toUpperCase()==="DDP";r.style.display=o?"block":"none"}function tt(r){var h;const o=se(P,s.sku),u=je({product:o,units:Number(s.units||0),unitPrice:s.unitPrice,currency:s.currency,fxRate:s.fxRate||((h=n.settings)==null?void 0:h.fxRate)});c("#fo-supplier-cost",f).textContent=me(r.supplierCost,s.currency||"USD"),c("#fo-landed-cost",f).textContent=me(r.landedCostEur,"EUR"),c("#fo-shipping-estimate",f).textContent=u.total==null?"—":me(u.total,"EUR");const l=c("#fo-shipping-note",f);l&&(u.missing?l.textContent=`Fehlend: ${u.missingFields.join(", ")}`:u.warning?l.textContent="Hinweis: Einstandspreis liegt unter Warenwert.":l.textContent="")}function ge(){return Number(s.units||0)*(z(s.unitPrice)||0)}function Mt(){const o=s.payments.filter(u=>u.category==="supplier").reduce((u,l)=>u+(Number(l.percent)||0),0);o&&(s.payments=s.payments.map(u=>u.category!=="supplier"?u:{...u,percent:Math.round((Number(u.percent)||0)/o*1e4)/100,isOverridden:!0}),le())}function nt(){const r=c("#fo-payments-body",f);r.innerHTML="";const o=we(re(s),s.targetDeliveryDate),u={ORDER_DATE:"Order Date",PRODUCTION_END:"Production End",ETD:"ETD",ETA:"ETA",DELIVERY:"Target Delivery"};s.payments.forEach((l,h)=>{const _=l.category==="supplier",Y=Number.isFinite(Number(l.amount))?ne(Number(l.amount)):"0,00",H=ve.includes(l.triggerEvent)?l.triggerEvent:"ORDER_DATE",G=!Fe(H,o)&&!l.dueDate?`Due Date kann nicht berechnet werden: ${u[H]||H} fehlt.`:"",j=t("tr",{},[t("td",{},[t("input",{type:"text",value:l.label||"",oninput:I=>{l.label=I.target.value,M=!0}})]),t("td",{class:"num"},[t("input",{type:"number",min:"0",max:"100",step:"0.1",value:l.percent??0,disabled:!_,oninput:I=>{l.percent=Z(I.target.value)??0,l.isOverridden=!0,M=!0,le()}})]),t("td",{class:"num"},[t("div",{class:"fo-amount-field"},[t("input",{type:"text",inputmode:"decimal",value:Y,oninput:I=>{const V=Z(I.target.value)??0;if(_){const oe=ge();l.percent=oe?V/oe*100:0}l.amount=V,l.isOverridden=!0,M=!0,le()},onblur:I=>{const V=Z(I.target.value);V!=null&&(I.target.value=ne(V))}}),t("span",{class:"fo-amount-currency muted"},[l.currency||"EUR"])])]),t("td",{},[(()=>{const I=t("select",{onchange:V=>{l.triggerEvent=V.target.value,l.isOverridden=!1,l.dueDateManuallySet=!1,M=!0,le()}});return ve.forEach(V=>I.append(t("option",{value:V},[V]))),I.value=l.triggerEvent||"ORDER_DATE",I})()]),t("td",{class:"num"},[t("input",{type:"number",step:"1",value:l.offsetDays??0,oninput:I=>{l.offsetDays=un(I.target.value)??0,l.isOverridden=!1,l.dueDateManuallySet=!1,M=!0,le()}})]),t("td",{},[t("input",{type:"date",value:l.dueDate||"",oninput:I=>{l.dueDate=I.target.value||null,l.isOverridden=!0,l.dueDateManuallySet=!0,M=!0,le()}}),G?t("span",{class:"fo-due-date-warning",title:G},["⚠️"]):null]),t("td",{},[t("button",{class:"btn secondary",type:"button",onclick:()=>{const I=n.suppliers.find(fe=>fe.id===s.supplierId)||null,V=re(s),oe=ge(),J=De(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(J.dutyRatePct=0,J.eustRatePct=0);const de=Ae({supplier:I,baseValue:oe,currency:s.currency,schedule:V,freight:J.freightTotal,freightCurrency:J.freightCurrency,dutyRatePct:J.dutyRatePct,eustRatePct:J.eustRatePct,fxRate:J.fxRate,supplierCostEur:J.supplierCostEur,incoterm:s.incoterm})[h];de&&(s.payments[h]={...de,id:l.id||de.id},s.payments[h].dueDateManuallySet=!1,M=!0,le())}},["Reset"])])]);r.append(j)})}const f=t("div",{class:"fo-modal"},[R?t("div",{class:"banner info fo-converted-banner"},[t("strong",{},["Converted to PO."]),t("span",{class:"muted"},[` PO: ${s.convertedPoNo||s.convertedPoId||"—"}`])]):null,t("div",{class:"grid two"},[t("section",{class:"card"},[t("h3",{},["Inputs"]),t("div",{class:"grid two"},[t("label",{},["Produkt (Alias)",t("div",{class:"fo-product-picker"},[t("input",{type:"text",id:"fo-product-input",value:((mt=se(P,s.sku))==null?void 0:mt.alias)||s.sku||"",placeholder:"Alias oder SKU suchen",autocomplete:"off"}),t("div",{class:"fo-product-dropdown",id:"fo-product-dropdown"},[])]),t("div",{class:"muted fo-sku-display",id:"fo-sku-display"},["SKU: —"]),t("small",{class:"form-error",id:"fo-product-error"},[])]),t("label",{},["Units",t("input",{type:"number",min:"0",step:"1",id:"fo-units",value:s.units||""}),t("small",{class:"form-error",id:"fo-units-error"},[])]),t("label",{},["Target Delivery Date",t("input",{type:"date",id:"fo-targetDeliveryDate",value:s.targetDeliveryDate||""}),t("small",{class:"form-error",id:"fo-target-error"},[])]),t("label",{},["Supplier",(()=>{const r=t("select",{id:"fo-supplierId"});return r.append(t("option",{value:""},["Bitte auswählen"])),n.suppliers.forEach(o=>{const u=a.get(o.id)||o.name||o.id;r.append(t("option",{value:o.id},[u]))}),r.value=s.supplierId||"",r})(),t("small",{class:"form-error",id:"fo-supplier-error"},[])])]),t("div",{class:"grid two"},[t("label",{},["Transport Mode",(()=>{const r=t("select",{id:"fo-transportMode"});return sn.forEach(o=>r.append(t("option",{value:o},[o]))),r.value=s.transportMode||"SEA",r})(),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-transport"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-transportMode"},["Reset"])])]),t("label",{},["Incoterm",(()=>{const r=t("select",{id:"fo-incoterm"});return rn.forEach(o=>r.append(t("option",{value:o},[o]))),r.value=s.incoterm||"EXW",r})(),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-incoterm"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-incoterm"},["Reset"])])]),t("label",{},["Unit Price",t("input",{type:"text",inputmode:"decimal",id:"fo-unitPrice",value:s.unitPrice??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-unitPrice"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-unitPrice"},["Reset"])]),t("small",{class:"form-error",id:"fo-unitPrice-error"},[])]),t("label",{},["Currency",(()=>{const r=t("select",{id:"fo-currency"});return Ye.forEach(o=>r.append(t("option",{value:o},[o]))),r.value=s.currency||"USD",r})(),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-currency"},["USD"]),t("button",{class:"btn ghost",type:"button",id:"reset-currency"},["Reset"])]),t("small",{class:"form-error",id:"fo-currency-error"},[])]),t("label",{},["Logistik / Stk. (EUR)",t("input",{type:"text",inputmode:"decimal",id:"fo-freight",value:s.freight??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-freight"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-freight"},["Reset"])]),t("small",{class:"form-error",id:"fo-freight-warning"},[])]),t("label",{},["Logistik-Währung",(()=>{const r=t("select",{id:"fo-freightCurrency"});return Ye.forEach(o=>r.append(t("option",{value:o},[o]))),r.value=s.freightCurrency||"EUR",r})(),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-freightCurrency"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-freightCurrency"},["Reset"])])]),t("label",{},["Duty %",t("input",{type:"text",inputmode:"decimal",id:"fo-dutyRatePct",value:s.dutyRatePct??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-dutyRatePct"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-dutyRatePct"},["Reset"])])]),t("label",{},["EUSt %",t("input",{type:"text",inputmode:"decimal",id:"fo-eustRatePct",value:s.eustRatePct??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-eustRatePct"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-eustRatePct"},["Reset"])])]),t("label",{},["FX (USD je EUR)",t("input",{type:"text",inputmode:"decimal",id:"fo-fxRate",value:s.fxRate??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-fxRate"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-fxRate"},["Reset"])])]),t("label",{},["Production Lead Time (used)",t("input",{type:"number",min:"0",step:"1",id:"fo-productionLeadTimeDays",value:s.productionLeadTimeDays??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-productionLeadTimeDays"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-productionLeadTimeDays"},["Reset"])])]),t("label",{},["Fracht-LT (Tage)",t("input",{type:"number",min:"0",step:"1",id:"fo-logisticsLeadTimeDays",value:s.logisticsLeadTimeDays??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-logisticsLeadTimeDays"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-logisticsLeadTimeDays"},["Reset"])])]),t("label",{},[t("span",{class:"fo-buffer-label"},["Buffer (days)",t("span",{class:"tooltip"},[t("button",{class:"tooltip-trigger",type:"button","aria-label":"Buffer Erklärung"},["ℹ️"]),t("span",{class:"tooltip-content"},["Puffer in Tagen, der zur Sicherheit zusätzlich eingeplant wird. Er wird zur Summe aus Produktions- und Logistik-Leadtimes addiert und verschiebt das Bestelldatum entsprechend nach vorne."])])]),t("input",{type:"number",min:"0",step:"1",id:"fo-bufferDays",value:s.bufferDays??""}),t("div",{class:"suggested-row"},[t("span",{class:"muted",id:"suggested-bufferDays"},[]),t("button",{class:"btn ghost",type:"button",id:"reset-bufferDays"},["Reset"])])])]),t("div",{class:"fo-cost-summary"},[t("div",{class:"fo-cost-row"},[t("span",{class:"muted"},["Supplier Cost"]),t("strong",{id:"fo-supplier-cost"},["—"])]),t("div",{class:"fo-cost-row"},[t("span",{class:"muted"},["Landed Cost (EUR)"]),t("strong",{id:"fo-landed-cost"},["—"])]),t("div",{class:"fo-cost-row"},[t("span",{class:"muted"},["Geschätzte Fracht (EUR)"]),t("strong",{id:"fo-shipping-estimate"},["—"])]),t("small",{class:"muted",id:"fo-shipping-note"},[])]),t("div",{class:"banner info",id:"fo-suggestion-info"},[t("strong",{},["Why this suggestion"]),t("ul",{class:"fo-suggestion-list"},[])]),t("div",{class:"banner warning",id:"fo-warning-info",style:"display:none"},[t("strong",{},["Hinweise"]),t("ul",{class:"fo-warning-list"},[])]),t("div",{class:"banner info",id:"fo-product-banner",style:"display:none"},[t("strong",{},["SKU nicht in Produktdatenbank."]),t("span",{class:"muted"},[" Bitte Produkt anlegen."]),t("div",{class:"fo-banner-actions"},[t("input",{type:"text",id:"fo-product-name",placeholder:"Produktname (optional)"}),t("button",{class:"btn secondary",type:"button",id:"fo-product-create"},["Produkt anlegen"])])]),t("div",{class:"form-error",id:"fo-save-error",role:"alert"},[])]),t("section",{class:"card"},[t("h3",{},["Rückwärtsterminierung"]),t("div",{class:"fo-date-list"},[t("div",{class:"fo-date-row"},[t("span",{},["Ziel Delivery"]),t("strong",{id:"fo-preview-target"},["—"])]),t("div",{class:"fo-date-row"},[t("span",{},["Order Date"]),t("strong",{id:"fo-preview-order"},["—"])]),t("div",{class:"fo-date-row"},[t("span",{},["Production End"]),t("strong",{id:"fo-preview-production"},["—"])]),t("div",{class:"fo-date-row"},[t("span",{},["ETD"]),t("strong",{id:"fo-preview-etd"},["—"])]),t("div",{class:"fo-date-row"},[t("span",{},["ETA"]),t("strong",{id:"fo-preview-eta"},["—"])])]),t("p",{class:"muted",id:"fo-user-anchor",style:"display:none;"},[]),t("div",{class:"fo-schedule-missing",id:"fo-schedule-missing",style:"display:none;"},[t("strong",{},["Fehlende Daten"]),t("ul",{class:"fo-schedule-missing-list",id:"fo-schedule-missing-list"},[])]),t("p",{class:"muted",id:"fo-date-warning",style:"display:none; margin-top:10px"},[]),t("div",{class:"fo-recommendation-card",id:"fo-recommendation"},[t("strong",{},["FO Empfehlung"]),t("p",{class:"muted",id:"fo-recommendation-summary"},["—"]),t("div",{class:"fo-recommendation-rows",id:"fo-recommendation-details"},[t("div",{class:"fo-recommendation-row"},[t("span",{class:"muted"},["Baseline"]),t("strong",{id:"fo-recommendation-baseline"},["—"])]),t("div",{class:"fo-recommendation-row"},[t("span",{class:"muted"},["First month below safety DOH"]),t("strong",{id:"fo-recommendation-critical"},["—"])]),t("div",{class:"fo-recommendation-row"},[t("span",{class:"muted"},["Required arrival (DE)"]),t("strong",{id:"fo-recommendation-arrival"},["—"])]),t("div",{class:"fo-recommendation-row"},[t("span",{class:"muted"},["Recommended order date"]),t("strong",{id:"fo-recommendation-order"},["—"])]),t("div",{class:"fo-recommendation-row"},[t("span",{class:"muted"},["Recommended units"]),t("strong",{id:"fo-recommendation-units"},["—"])])]),t("div",{class:"fo-recommendation-issues",id:"fo-recommendation-issues"},[]),t("p",{class:"muted",id:"fo-recommendation-notes"},[])])])]),t("section",{class:"card"},[t("h3",{},["Payments"]),t("div",{class:"table-wrap"},[t("table",{class:"table fo-payments-table"},[t("thead",{},[t("tr",{},[t("th",{},["Label"]),t("th",{class:"num"},["%"]),t("th",{class:"num"},["Amount"]),t("th",{},["Trigger"]),t("th",{class:"num"},["Offset Days"]),t("th",{},["Due Date"]),t("th",{},["Reset"])])]),t("tbody",{id:"fo-payments-body"},[])])]),t("p",{class:"muted fo-ddp-note",id:"fo-ddp-note",style:"display:none;"},["Bei DDP ist Fracht typischerweise in Deposit/Balance enthalten."]),t("div",{class:"fo-payments-footer"},[t("p",{class:"muted",id:"fo-payment-total"},["Summe: 100%"]),t("p",{class:"form-error",id:"fo-payment-error"},[]),t("button",{class:"btn secondary",type:"button",id:"fo-payment-normalize"},["Normalize to 100%"])])])]),ye=t("button",{class:"btn primary",type:"button"},["Save FO"]),$e=t("button",{class:"btn",type:"button"},["Cancel"]);let Le=null;function Ve(){K.unregister(),K.detachBeforeUnload(),Le&&document.removeEventListener("keydown",Le),st.remove()}function Be(){if(!N.isDirty){Ve();return}K({confirmWithModal:({onConfirm:r})=>Bt({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{N.discardDraft(),r==null||r(),Ve()}})})}const st=qe(b?"FO bearbeiten":"FO anlegen",f,[$e,ye],Be);Le=r=>{r.key==="Escape"&&(r.preventDefault(),Be())},document.addEventListener("keydown",Le),$e.addEventListener("click",Be),R&&(ye.disabled=!0,f.querySelectorAll("input, select, textarea, button.btn.secondary, button.btn.ghost").forEach(r=>{r!==$e&&r.setAttribute("disabled","true")}));function te(r,o){s[r]=o,$[r]=!0,r==="productionLeadTimeDays"&&(s.productionLeadTimeDaysManual=o,s.productionLeadTimeSource="Manual override")}function ke(){const r=String(s.sku||"").trim(),o=String(s.supplierId||"").trim(),u=Number(s.units||0),l=z(s.unitPrice)||0,h=s.targetDeliveryDate,_=se(P,r),Y=!!_,H=_?kt(_,{state:n}):null,X=(H==null?void 0:H.status)==="blocked",G=s.payments.filter(ue=>ue.category==="supplier"),j=G.reduce((ue,Ne)=>ue+(Number(Ne.percent)||0),0),I=String(s.currency||"").trim(),V=G.length>0&&Math.round(j)===100,oe=r&&o&&u>0&&l>0&&h&&V&&I&&Y&&!X,J=c("#fo-unitPrice-error",f),Pe=c("#fo-units-error",f),de=c("#fo-target-error",f),fe=c("#fo-product-error",f),q=c("#fo-supplier-error",f),Re=c("#fo-currency-error",f),Se=c("#fo-payment-error",f);if(J&&(J.textContent=l>0?"":"Unit Price ist erforderlich."),Pe&&(Pe.textContent=u>0?"":"Units ist erforderlich."),de&&(de.textContent=h?"":"Zieltermin ist erforderlich."),fe)if(!Y)fe.textContent="Produkt fehlt in der Datenbank.";else if(X){const ue=Tt(H);fe.textContent=ue?`Produkt blockiert: ${ue}`:"Produkt blockiert."}else fe.textContent="";q&&(q.textContent=o?"":"Supplier ist erforderlich."),Re&&(Re.textContent=I?"":"Currency ist erforderlich."),Se&&(Se.textContent=V?"":"Payment Terms fehlen oder ergeben nicht 100%."),ye.disabled=!oe||!N.isDirty,c("#fo-save-error",f).textContent=oe?"":"Bitte fehlende Felder korrigieren."}function rt(){N.setDraft(s),ke()}let _e=null;function F(){_e&&clearTimeout(_e),_e=setTimeout(()=>{const r=re(s),o=ge(),u=De(s);s.payments=Lt(s.payments,{baseValue:o,schedule:r,currency:s.currency,freight:u.freight,freightCurrency:u.freightCurrency,dutyRatePct:u.dutyRatePct,eustRatePct:u.eustRatePct,fxRate:u.fxRate,supplierCostEur:u.supplierCostEur,incoterm:s.incoterm}),s.payments=Te(s.payments,s.incoterm),Ge(r),Je(),ke(),Xe(),Qe(),nt(),tt(u),et(),rt()},300)}const Ee=c("#fo-product-input",f),he=c("#fo-product-dropdown",f);function At(r){const o=se(P,r);return o||He(P,r)}function it(r=""){he.innerHTML="";const o=String(r||"").trim().toLowerCase(),u=L.filter(l=>o?l.label.toLowerCase().includes(o)||l.sku.toLowerCase().includes(o):!0).slice(0,12);if(!u.length){he.append(t("div",{class:"muted fo-product-empty"},["Keine Produkte gefunden."]));return}u.forEach(l=>{var X,G,j;const h=((X=l.completeness)==null?void 0:X.status)==="blocked",_=bn((G=l.completeness)==null?void 0:G.status),Y=Tt(l.completeness),H=t("button",{class:`fo-product-option${h?" is-blocked":""}`,type:"button",disabled:h,title:Y||_,onclick:()=>{s.sku=l.sku,Ee.value=l.alias||l.sku,he.style.display="none",ae(),Ie(),F()}},[t("span",{class:"fo-product-alias",title:l.alias||l.sku},[l.alias||l.sku]),t("span",{class:"fo-product-sku muted",title:l.sku},[l.sku]),t("span",{class:`fo-product-status ${((j=l.completeness)==null?void 0:j.status)||"blocked"}`},[_])]);he.append(H)})}Ee.addEventListener("focus",()=>{he.style.display="block",it(Ee.value)}),Ee.addEventListener("input",r=>{const o=r.target.value;it(o);const u=At(o);s.sku=u?u.sku:o.trim(),ae(),Ie(),F()}),Ee.addEventListener("blur",()=>{setTimeout(()=>{he.style.display="none"},150)}),c("#fo-units",f).addEventListener("input",r=>{s.units=Z(r.target.value)??"",F()}),c("#fo-targetDeliveryDate",f).addEventListener("input",r=>{s.targetDeliveryDate=r.target.value,F()}),c("#fo-supplierId",f).addEventListener("change",r=>{if(s.supplierId=r.target.value,ae(),!M){const o=re(s),u=ge(),l=n.suppliers.find(_=>_.id===s.supplierId)||null,h=De(s);s.payments=Ae({supplier:l,baseValue:u,currency:s.currency,schedule:o,freight:h.freightTotal,freightCurrency:h.freightCurrency,dutyRatePct:h.dutyRatePct,eustRatePct:h.eustRatePct,fxRate:h.fxRate,supplierCostEur:h.supplierCostEur,incoterm:s.incoterm}),s.payments=Te(s.payments,s.incoterm)}F()}),c("#fo-transportMode",f).addEventListener("change",r=>{te("transportMode",r.target.value),ae(),F()}),c("#fo-incoterm",f).addEventListener("change",r=>{te("incoterm",r.target.value),ae(),B(),Ze(),F()}),c("#fo-unitPrice",f).addEventListener("input",r=>{s.unitPrice=Z(r.target.value)??"",s.unitPriceIsOverridden=!0,B(),F()}),c("#fo-currency",f).addEventListener("change",r=>{te("currency",r.target.value.trim()||"USD"),B(),F()}),c("#fo-freight",f).addEventListener("input",r=>{te("freight",Z(r.target.value)??""),B(),F()}),c("#fo-freightCurrency",f).addEventListener("change",r=>{te("freightCurrency",r.target.value.trim()||"EUR"),B(),F()}),c("#fo-dutyRatePct",f).addEventListener("input",r=>{te("dutyRatePct",Z(r.target.value)??""),B(),F()}),c("#fo-eustRatePct",f).addEventListener("input",r=>{te("eustRatePct",Z(r.target.value)??""),B(),F()}),c("#fo-fxRate",f).addEventListener("input",r=>{te("fxRate",Z(r.target.value)??""),B(),F()}),c("#fo-productionLeadTimeDays",f).addEventListener("input",r=>{const o=Z(r.target.value);o==null?U("productionLeadTimeDays",g.productionLeadTimeDays):te("productionLeadTimeDays",o),B(),F()}),c("#fo-logisticsLeadTimeDays",f).addEventListener("input",r=>{te("logisticsLeadTimeDays",Z(r.target.value)??""),B(),F()}),c("#fo-bufferDays",f).addEventListener("input",r=>{te("bufferDays",Z(r.target.value)??""),B(),F()}),c("#reset-transportMode",f).addEventListener("click",()=>{U("transportMode",g.transportMode),B(),F()}),c("#reset-incoterm",f).addEventListener("click",()=>{U("incoterm",g.incoterm),B(),F()}),c("#reset-unitPrice",f).addEventListener("click",()=>{U("unitPrice",g.unitPrice??""),s.unitPriceIsOverridden=!1,B(),F()}),c("#reset-currency",f).addEventListener("click",()=>{U("currency",g.currency||"USD"),B(),F()}),c("#reset-freight",f).addEventListener("click",()=>{U("freight",g.freight??""),B(),F()}),c("#reset-freightCurrency",f).addEventListener("click",()=>{U("freightCurrency",g.freightCurrency||"EUR"),B(),F()}),c("#reset-dutyRatePct",f).addEventListener("click",()=>{U("dutyRatePct",g.dutyRatePct??""),B(),F()}),c("#reset-eustRatePct",f).addEventListener("click",()=>{U("eustRatePct",g.eustRatePct??""),B(),F()}),c("#reset-fxRate",f).addEventListener("click",()=>{U("fxRate",g.fxRate??""),B(),F()}),["fo-unitPrice","fo-freight","fo-dutyRatePct","fo-eustRatePct","fo-fxRate"].forEach(r=>{const o=c(`#${r}`,f);o&&o.addEventListener("blur",()=>{const u=Z(o.value);u!=null&&(r==="fo-dutyRatePct"||r==="fo-eustRatePct"?o.value=pe(u):o.value=ne(u))})}),c("#reset-productionLeadTimeDays",f).addEventListener("click",()=>{U("productionLeadTimeDays",g.productionLeadTimeDays),B(),F()}),c("#reset-logisticsLeadTimeDays",f).addEventListener("click",()=>{U("logisticsLeadTimeDays",g.logisticsLeadTimeDays),B(),F()}),c("#reset-bufferDays",f).addEventListener("click",()=>{U("bufferDays",g.bufferDays),B(),F()}),c("#fo-payment-normalize",f).addEventListener("click",Mt),c("#fo-product-create",f).addEventListener("click",()=>{const r=String(s.sku||"").trim();if(!r)return;const o=c("#fo-product-name",f).value.trim();try{$t({sku:r,alias:o||r,supplierId:s.supplierId||""}),P.push({sku:r,alias:o||r}),L.push({sku:r,alias:o||r,label:o||r}),c("#fo-product-banner",f).style.display="none",F()}catch(u){window.alert((u==null?void 0:u.message)||"Produkt konnte nicht angelegt werden.")}}),f.addEventListener("click",r=>{const o=r.target.closest(".fo-fix-now");if(!o)return;const u=o.dataset.sku,l=o.dataset.tab||"suppliers";u&&(sessionStorage.setItem("healthFocus",JSON.stringify({tab:l,sku:u})),l==="produkte"?location.hash="#produkte":location.hash="#suppliers",st.remove())});function Ot(){const{issues:r}=_t({settings:n.settings,products:n.products,suppliers:n.suppliers});return r.filter(o=>o.blocking?o.scope==="settings"?o.field==="fxRate":o.scope==="product"?o.entityId===s.sku&&(o.field==="currency"||o.field==="unitPrice"):o.scope==="supplier"?o.entityId===s.supplierId&&(o.field==="paymentTerms"||o.field==="productionLeadTime"):!1:!1)}if(ye.addEventListener("click",async()=>{if(ke(),ye.disabled)return;const r=Ot();if(r.length){Vt(r);return}ye.disabled=!0,ye.textContent="Speichern…",String(s.incoterm||"").toUpperCase()==="DDP"&&(s.dutyRatePct=0,s.eustRatePct=0,s.freightCurrency="USD");const o=re(s),u=Pn(s,o,s.payments);await N.commit(()=>{const l=ht();Array.isArray(l.fos)||(l.fos=[]);const h=l.fos.findIndex(_=>_.id===u.id);h>=0?l.fos[h]=u:l.fos.push(u),ze(l,{source:"fo:save",entityKey:`fo:${u.id}`,action:h>=0?"update":"create"})}),E(),window.alert("FO gespeichert."),Ve()}),!s.payments.length){const r=re(s),o=ge(),u=n.suppliers.find(h=>h.id===s.supplierId)||null,l=De(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(l.dutyRatePct=0,l.eustRatePct=0),s.payments=Ae({supplier:u,baseValue:o,currency:s.currency,schedule:r,freight:l.freightTotal,freightCurrency:l.freightCurrency,dutyRatePct:l.dutyRatePct,eustRatePct:l.eustRatePct,fxRate:l.fxRate,supplierCostEur:l.supplierCostEur,incoterm:s.incoterm}),s.payments=Te(s.payments,s.incoterm)}ae(),Ie(),le(),ke()}c("#fo-add",e).addEventListener("click",()=>O(null)),d.addEventListener("click",p=>{var k,m,w,x;const C=(k=p.target)!=null&&k.closest?p.target:(m=p.target)==null?void 0:m.parentElement;if(!C)return;const P=C.closest("tr[data-id], tr[data-key]");if(!P)return;const L=P.dataset.id||P.dataset.key,b=n.fos.find(s=>s.id===L);if(!b)return;const R=(x=(w=C.closest("button"))==null?void 0:w.dataset)==null?void 0:x.action;if(R==="edit")O(b);else if(R==="convert"){if(String(b.status||"").toUpperCase()==="CONVERTED")return;S(b)}else if(R==="delete"){const N=String(b.status||"").toUpperCase()==="CONVERTED"?"Diese FO wurde bereits in eine PO umgewandelt. FO trotzdem löschen? (Die PO bleibt bestehen.)":"Forecast Order wirklich löschen?";if(!window.confirm(N))return;n.fos=n.fos.filter($=>$.id!==L),ze(n,{source:"fo:delete",entityKey:`fo:${L}`,action:"delete"}),E()}else if(R==="supplier"){const s=n.suppliers.find(N=>N.id===b.supplierId);s?T("Supplier Details",[`Name: ${s.name}`,`Incoterm: ${s.incotermDefault||"—"}`,`Currency: ${s.currencyDefault||"—"}`]):T("Supplier Details",["Supplier ist nicht vorhanden."])}}),E();function A(){const p=window.__routeQuery||{};if(p.create==="1"||p.mode==="create"){O(null,{sku:p.sku||"",alias:p.alias||"",targetDeliveryDate:p.target||"",anchorMonth:p.anchorMonth||""}),window.__routeQuery={};return}if(!p.open)return;const P=String(p.open||"").trim().toLowerCase();if(!P)return;const L=n.fos.find(b=>{if(!b)return!1;const R=String(b.id||"").toLowerCase()===P,k=String(b.foNo||"").toLowerCase()===P;return R||k});L&&(O(L),window.__routeQuery={})}A()}export{Nn as default};
