function b(t){if(t instanceof Date)return new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));if(typeof t!="string")throw new Error(`Invalid date: ${t}`);const[e,n,a]=t.split("-").map(Number);if(!e||!n||!a)throw new Error(`Invalid ISO date: ${t}`);return new Date(Date.UTC(e,n-1,a))}function E(t){const e=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0"),a=String(t.getUTCDate()).padStart(2,"0");return`${e}-${n}-${a}`}function w(t){const e=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0");return`${e}-${n}`}function p(t){const[e,n]=t.split("-").map(Number);if(!e||!n)throw new Error(`Invalid month: ${t}`);return{year:e,month:n-1}}function H(t,e){const n=p(t),a=p(e),s=n.year*12+n.month,o=a.year*12+a.month;return s-o}function W(t,e){const{year:n,month:a}=p(t),s=new Date(Date.UTC(n,a,1));return s.setUTCMonth(s.getUTCMonth()+e),w(s)}function X(t){const{year:e,month:n}=p(t);return new Date(Date.UTC(e,n,1))}function v(t,e){return new Date(Date.UTC(t,e+1,0)).getUTCDate()}function R(t,e){return new Date(t.getTime()+e*864e5)}function st(t,e={},n={}){const a=(e==null?void 0:e[t])??{};return{safetyStockDaysTotalDe:a.safetyStockDaysTotalDe??n.safetyStockDaysTotalDe??60,minimumStockDaysTotalDe:a.minimumStockDaysTotalDe??n.minimumStockDaysTotalDe??null,leadTimeDaysTotal:a.leadTimeDaysTotal??n.leadTimeDaysTotal??0,moqUnits:a.moqUnits??n.moqUnits??0,operationalCoverageDaysDefault:a.operationalCoverageDaysOverride??n.operationalCoverageDaysDefault??120}}function Z(t,e,n){var a;return((a=t==null?void 0:t[e])==null?void 0:a[n])??null}function ot(t,e,n){var a;return((a=t==null?void 0:t[e])==null?void 0:a[n])??null}function P({plansBySku:t,sku:e,month:n,fallbackDailyRate:a,warnings:s}){const o=Z(t,e,n),{year:c,month:r}=p(n),l=v(c,r);return o==null?a!=null?(s.push(`Forecast missing for ${n}; using last available daily rate.`),{dailyRate:a,days:l,missingForecast:!0,usedFallback:!0,forecastMonthUnits:null}):(s.push(`Forecast missing for ${n}; daily rate assumed 0.`),{dailyRate:0,days:l,missingForecast:!0,usedFallback:!1,forecastMonthUnits:null}):(o===0&&s.push(`Forecast for ${n} is zero; demand treated as 0.`),{dailyRate:o/l,days:l,missingForecast:!1,usedFallback:!1,forecastMonthUnits:o})}function rt({plansBySku:t,sku:e,date:n,fallbackDailyRate:a,warnings:s}){const o=w(n);return P({plansBySku:t,sku:e,month:o,fallbackDailyRate:a,warnings:s}).dailyRate}function it({snapshotsBySku:t,plansBySku:e,sku:n,date:a,fallbackDailyRate:s,warnings:o}){const c=w(a),r=ot(t,n,c);if(r==null)return o.push("Latest closing stock snapshot missing."),{inventoryUnits:null,missingSnapshot:!0,missingForecast:!1};const l=Z(e,n,c),{year:f,month:m}=p(c),d=v(f,m);let u=l,D=!1;u==null&&(D=!0,s!=null?(u=s*d,o.push(`Forecast missing for ${c}; inventory estimated using fallback rate.`)):(u=0,o.push(`Forecast missing for ${c}; inventory estimated without sales drawdown.`)));const h=u/d,y=r+u,U=a.getUTCDate()-1;return{inventoryUnits:y-U*h,missingSnapshot:!1,missingForecast:D}}function B({plansBySku:t,sku:e,startDate:n,endDate:a,warnings:s}){let o=new Date(n.getTime()),c=0,r=null,l=!1;const f=[];for(;o<a;){const m=w(o),{year:d,month:u}=p(m),D=v(d,u),h=new Date(Date.UTC(d,u+1,1)),y=h<a?h:a,U=Math.ceil((y.getTime()-o.getTime())/864e5),i=P({plansBySku:t,sku:e,month:m,fallbackDailyRate:r,warnings:s}),g=i.dailyRate*U;c+=g,f.push({month:m,daysCovered:U,forecastMonthUnits:i.forecastMonthUnits,demandUnitsInWindow:g,usedFallback:i.usedFallback}),i.missingForecast?l=!0:r=i.dailyRate,o=y,U>=D&&i.dailyRate!=null&&(r=i.dailyRate)}return{demandUnits:c,missingForecast:l,fallbackDailyRate:r,coverageDemandBreakdown:f}}function ct(t,e,n,a){if(!t||!e||!n||!a)return 0;const s=b(t),o=b(e),c=b(n),r=b(a);if(!s||!o||!c||!r)return 0;const l=s>c?s:c,f=R(r,1),d=(o<f?o:f).getTime()-l.getTime();return d<=0?0:Math.ceil(d/864e5)}function ut(t=[]){let e=null;return t.forEach(n=>{const a=n==null?void 0:n.month;a&&(!e||H(a,e)>0)&&(e=a)}),e}function mt({sku:t,baselineMonth:e,stock0:n=0,forecastByMonth:a={},inboundByMonth:s={},horizonMonths:o=12}){const c=[],r=[];let l=Number(n||0);for(let f=1;f<=o;f+=1){const m=W(e,f),d=a==null?void 0:a[m],u=Number.isFinite(Number(d))?Number(d):0;d==null&&r.push(m);const D=Number((s==null?void 0:s[m])||0),{year:h,month:y}=p(m),U=v(h,y),i=u===0?0:u/U,g=l+D-u,N=i===0?Number.POSITIVE_INFINITY:Math.max(0,g/i);c.push({month:m,startStock:l,inbound:D,demand:u,endStock:g,avgDailyDemand:i,doh:N}),l=g}return{sku:t,baselineMonth:e,months:c,missingForecastMonths:r}}function dt({sku:t,baselineMonth:e,projection:n,plannedSalesBySku:a={},safetyStockDays:s=60,coverageDays:o=90,leadTimeDays:c=0,cnyPeriod:r,inboundWithoutEtaCount:l=0,moqUnits:f=0,unitsPerCarton:m=null,roundupCartonBlock:d=null,roundupMaxPct:u=null,requiredArrivalMonth:D=null}){var J;if(!e)return{sku:t,status:"no_snapshot",issues:[]};const h=(J=n==null?void 0:n.months)==null?void 0:J.find(C=>Number.isFinite(C.doh)&&C.doh<s);if(!h)return{sku:t,status:"no_fo_needed",baselineMonth:e,issues:Q(n,l)};const y=new Map(((n==null?void 0:n.months)||[]).map(C=>[C.month,C])),U=D&&y.has(D)&&H(D,e)>0?D:h.month,i=y.get(U)||h,g=X(U),N=R(g,-Number(c||0)),$=ct(N,g,r==null?void 0:r.start,r==null?void 0:r.end),j=$>0?R(N,-$):N,O=Math.max(1,Number(o||0)),M=B({plansBySku:a,sku:t,startDate:g,endDate:R(g,O),warnings:[]}),V=Number.isFinite(M==null?void 0:M.demandUnits)?Number(M.demandUnits):Number((i==null?void 0:i.avgDailyDemand)||0)*O,tt=Array.isArray(M==null?void 0:M.coverageDemandBreakdown)?M.coverageDemandBreakdown:[],nt=Number((i==null?void 0:i.startStock)||0),Y=Math.max(0,Math.ceil(V));let T=Y,q=!1;const A=Number.isFinite(Number(f))?Math.max(0,Math.ceil(Number(f))):0;T>0&&A>0&&T<A&&(T=A,q=!0);const z=Number.isFinite(Number(m))?Math.max(1,Math.round(Number(m))):null,F=z&&z>1?z:null,I=F&&T>0?Math.ceil(T/F)*F:T,et=I!==T,S=Number.isFinite(Number(d))?Math.max(1,Math.round(Number(d))):null,K=Number.isFinite(Number(u))?Math.max(0,Number(u)):0;let x=I,k=I,L=0,G=0,_=!1;if(F&&S&&S>1&&K>0&&I>0){const C=Math.ceil(I/F);k=Math.ceil(C/S)*S*F,L=Math.max(0,k-I),G=I>0?L/I*100:0,L>0&&G<=K&&(x=k,_=!0)}const at=F&&x>0?Math.ceil(x/F):null;return{sku:t,status:"ok",baselineMonth:e,criticalMonth:h.month,selectedArrivalMonth:U,requiredArrivalDate:E(g),orderDate:E(N),orderDateAdjusted:E(j),overlapDays:$,coverageDaysForOrder:O,coverageDemandUnits:V,coverageDemandBreakdown:tt,recommendedUnitsRaw:Y,recommendedUnits:x,unitsAfterMoq:T,unitsAfterCartonRounding:I,unitsPerCarton:F,recommendedCartons:at,cartonRoundingApplied:et,roundupCartonBlock:S,roundupMaxPct:K,blockRoundupApplied:_,roundupCandidateUnits:k,roundupLiftUnits:_?L:0,roundupLiftPct:_?G:0,safetyStockDays:s,coverageDays:o,moqUnits:A,moqApplied:q,moqLiftUnits:q?Math.max(0,T-Y):0,stockAtArrival:nt,avgDailyDemand:(i==null?void 0:i.avgDailyDemand)??h.avgDailyDemand,issues:Q(n,l)}}function Q(t,e){var s;const n=[],a=((s=t==null?void 0:t.missingForecastMonths)==null?void 0:s.length)||0;return a>0&&n.push({code:"MISSING_FORECAST",count:a}),e>0&&n.push({code:"INBOUND_WITHOUT_ETA",count:e}),n}const ft={parseIsoDate:b,formatIsoDate:E,monthKey:w,addMonthsToKey:W,monthKeyToDate:X,compareMonthKeys:H,daysInMonth:v,addDays:R,getDailyRateForDate:rt,estimateInventoryOnDate:it,integrateDemand:B,resolveSkuPolicy:st};export{mt as b,dt as c,ft as f,ut as g};
