import{ai as fn,J as pn,t as c,an as It,k as t,T as je,L as gn,M as v,ae as Jt,Q as E,N as ze,S as Ye,$ as yn}from"./index-CLY33OwN.js";import{b as bn}from"./abcClassification-b_BVCFOs.js";import{r as jn,a as vn,c as Sn,g as ue}from"./inventoryProjection-DlrA-LhN.js";import{D as zt}from"./DataTable-BjeYtyGx.js";import{S as kn}from"./StatsTableShell-CiCN7VSV.js";import{S as xn}from"./SkuAliasCell-B8t6PcT3.js";import{c as ne,n as F,b as Kt,a as Mn,f as se,d as de}from"./months-BTPgK-LH.js";import{b as Cn,c as An,s as Nn}from"./categoryOrder-C77cYWrY.js";import{e as Un,a as Dn}from"./forecastVersioning-Du1EAF0c.js";import{b as wn,c as Fn}from"./orderUtils-wOo4mSxP.js";import{h as Rt,g as $t,s as Tt}from"./uiPrefs-CxTlE9qM.js";import{u as Pn,C as et}from"./workspace-C0RZrezu.js";import{b as On}from"./planProducts-BiK-QjG5.js";import{a as Ht}from"./index-D3jCFyu6.js";import{S as _t}from"./index-D9EVM7K1.js";import{C as Ln}from"./index-CNjYVI11.js";import{R as Ke}from"./index-prCWcUNA.js";import{R as En}from"./InfoCircleOutlined-BGT-N4po.js";import{C as qt}from"./Collapse-CQPvdfZJ.js";const{Paragraph:Bn,Text:f,Title:tt}=gn,Xt=[6,12,18];function In(a){if(!a||typeof a!="object")return{toVersionId:null,foConflictsOpen:0};const i=a;return{toVersionId:i.toVersionId==null?null:String(i.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(i.foConflictsOpen||0)))}}function zn(a){(!a.inventory||typeof a.inventory!="object")&&(a.inventory={snapshots:[],settings:{projectionMonths:12,safetyDays:60}});const i=a.inventory;Array.isArray(i.snapshots)||(i.snapshots=[]),(!i.settings||typeof i.settings!="object")&&(i.settings={projectionMonths:12,safetyDays:60})}function Z(a){const i=Number(a);return Number.isFinite(i)?Math.max(0,Math.round(i)):0}function Vt(a){return String(Z(a))}function Kn(a){return String(a||"").replace(/[^\d]/g,"")}function Wt({sku:a,field:i,value:d,onCommit:l}){const[y,C]=c.useState(()=>Vt(d)),[x,D]=c.useState(!1);c.useEffect(()=>{x||C(Vt(d))},[x,d]);const R=c.useCallback(()=>{const z=Z(d),$=Z(y);if($===z){C(String(z));return}l({sku:a,field:i,value:$}),C(String($))},[y,i,l,a,d]);return t.jsx(Jt,{className:"v2-grid-input",value:y,inputMode:"numeric",autoComplete:"off",style:{width:"100%"},"data-snapshot-editor":"units","data-snapshot-sku":a,"data-snapshot-field":i,onFocus:()=>D(!0),onBlur:()=>{D(!1),R()},onChange:z=>{C(Kn(z.target.value))},onKeyDown:z=>{if(z.key!=="Enter")return;z.preventDefault(),R();const $=z.currentTarget,me=Array.from(document.querySelectorAll("input[data-snapshot-editor='units']")),N=me.indexOf($),J=N>=0?me[N+1]:null;J?(J.focus(),J.select()):$.blur()}})}function j(a){return Number.isFinite(a)?Math.round(Number(a)).toLocaleString("de-DE"):"—"}function he(a){if(!a)return"—";const[i,d,l]=String(a).split("-").map(Number);if(!i||!d||!l)return"—";const y=new Date(Date.UTC(i,d-1,l));return Number.isNaN(y.getTime())?"—":y.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function nt(a){const i={};return Array.isArray(a)&&a.forEach(d=>{const l=d||{},y=String(l.sku||"").trim();y&&(i[y]={amazonUnits:Z(l.amazonUnits),threePLUnits:Z(l.threePLUnits),note:String(l.note||"")})}),i}function Rn(){return new Date().toISOString()}function $n(a,i){var C;const d=((C=a.inventory)==null?void 0:C.snapshots)||[],l=F(i);return l&&d.find(x=>F(x.month)===l)||null}function Gt(a,i){var C;const d=F(i);if(!d)return null;const l=(((C=a.inventory)==null?void 0:C.snapshots)||[]).map(x=>x).filter(x=>F(x.month)).sort((x,D)=>String(F(x.month)).localeCompare(String(F(D.month))));let y=null;return l.forEach(x=>{const D=F(x.month);D&&D<d&&(y=x)}),y}function Tn(a){var d;const i=(((d=a.inventory)==null?void 0:d.snapshots)||[]).map(l=>F(l.month)).filter(Boolean);return i.length?(i.sort((l,y)=>l.localeCompare(y)),i[i.length-1]||null):null}function Qt(a,i){const d=new Map;a.forEach(y=>{var x;const C=y.categoryLabel||"Ohne Kategorie";d.has(C)||d.set(C,[]),(x=d.get(C))==null||x.push(y)});const l=Array.from(d.entries()).map(([y,C])=>({key:y,label:y,rows:C.sort((x,D)=>{const R=x.alias.localeCompare(D.alias,"de-DE",{sensitivity:"base"});return R!==0?R:x.sku.localeCompare(D.sku,"de-DE",{sensitivity:"base"})})}));return Nn(l,i)}function Hn(a){return/^\d{4}-\d{2}$/.test(a)?`${a}-01`:null}function K(a){const i=Number(a);return!Number.isFinite(i)||i<=0?null:i}function _n(a){const i=Number(a);return!Number.isFinite(i)||i<0?null:i}function qn(a){const i=String(a||"").trim().toUpperCase();return i==="SEA"||i==="RAIL"||i==="AIR"?i:"SEA"}function Vn(a,i){const d=a.transportLeadTimesDays||{},l=K(d[i.toLowerCase()]);if(l!=null)return Math.round(l);const y=K(d.sea);return y!=null?Math.round(y):null}function Yt(a,i="PLAN"){return String(a||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"-").replace(/^-+|-+$/g,"")||i}function Wn(a,i){const d=Yt(a,"PLAN");let l=d,y=2;for(;i.has(l.toLowerCase());)l=`${d}-${y}`,y+=1;return l}function Gn(a,i){var R;const d=K(a==null?void 0:a.productionLeadTimeDaysDefault)??K(i.defaultProductionLeadTimeDays)??45,l=(R=a==null?void 0:a.template)==null?void 0:R.fields,y=String((l==null?void 0:l.transportMode)??(a==null?void 0:a.transportMode)??"sea").toLowerCase(),C=i.transportLeadTimesDays||{},x=K(a==null?void 0:a.transitDays)??K(l==null?void 0:l.transitDays)??K(C[y])??K(C.sea)??45,D=Number(i.defaultBufferDays??0);return Math.max(0,Math.round(d+x+(Number.isFinite(D)?D:0)))}function Qn(a){return a==="doh"?"DOH zeigt die Reichweite des projizierten Monatsendbestands in Tagen.":a==="plan"?"Plan zeigt den geplanten Monatsabsatz (Forecast) je SKU.":"Units zeigt den projizierten Monatsendbestand je SKU inklusive Inbound-Wirkung."}function Zt(a){return a==="revenue_6m"?"ABC-Basis: Umsatz (6 Monate)":a==="units_6m_fallback"?"ABC-Basis: Units-Fallback (6 Monate)":"ABC-Basis: keine Forecast-Daten"}function Zn(a,i){const d=String(a||"C").toUpperCase();return i==="safety-negative"?d==="A"?6:d==="B"?4:2:i==="safety-low"?d==="A"?3:d==="B"?2:1:0}function Jn(a){const i=String(a||"").trim().toLowerCase();return i==="oos"?"oos":i==="under_safety"?"under_safety":"all"}function Xn(a){const i=String(a||"").trim().toLowerCase();return i==="a"?"a":i==="b"?"b":i==="ab"?"ab":i==="abc"?"abc":"all"}function st(a){const i=Number(a);if(!Number.isFinite(i))return 12;const d=Math.round(i);return Xt.includes(d)?d:d<9?6:d<15?12:18}function Yn(a){const i=String(a||"").trim().toLowerCase();return i==="doh"?"doh":i==="plan"?"plan":"units"}function rt(a){const i=String(a||"").trim().toUpperCase();return i==="A"||i==="B"||i==="C"?i:null}function es(a){const i=rt(a);return i==="A"?0:i==="B"?1:i==="C"?2:3}function ts(a,i){if(i==="all")return!0;const d=rt(a);return i==="a"?d==="A":i==="b"?d==="B":i==="ab"?d==="A"||d==="B":d!=null}function ns(a){if(!a)return t.jsx(f,{type:"secondary",children:"Kein Inbound in diesem Monat."});const i=Array.isArray(a.poItems)?a.poItems:[],d=Array.isArray(a.foItems)?a.foItems:[];return t.jsxs("div",{style:{minWidth:260,maxWidth:340},children:[t.jsxs("div",{style:{marginBottom:8},children:[t.jsx(f,{strong:!0,children:"PO Inbound"}),i.length?t.jsx("div",{children:i.map(l=>t.jsx("div",{children:t.jsxs(f,{children:[l.ref," · +",j(l.units)," · ",he(l.arrivalDate)]})},`po-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(f,{type:"secondary",children:" Keine PO-Ankunft"})]}),t.jsxs("div",{children:[t.jsx(f,{strong:!0,children:"FO Inbound"}),d.length?t.jsx("div",{children:d.map(l=>t.jsx("div",{children:t.jsxs(f,{children:[l.ref," · +",j(l.units)," · ",he(l.arrivalDate)]})},`fo-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(f,{type:"secondary",children:" Keine FO-Ankunft"})]})]})}function ks({view:a="both"}={}){const i=fn(),d=pn(),{state:l,loading:y,saving:C,error:x,lastSavedAt:D,saveWith:R}=Pn(),z=Rt("inventory_snapshot"),$=Rt("inventory_projection"),me=c.useRef(!1),[N,J]=c.useState(()=>ne()),[ot,at]=c.useState(!1),[Re,$e]=c.useState({}),[it,ve]=c.useState(!1),[S,lt]=c.useState("units"),[Te,ct]=c.useState(""),[He,en]=c.useState(!0),[re,Se]=c.useState("all"),[X,oe]=c.useState("all"),[Y,ut]=c.useState(12),[ke,xe]=c.useState(()=>$t("inventory_snapshot")),[Me,fe]=c.useState(()=>$t("inventory_projection")),[B,Ce]=c.useState(null),[Ae,dt]=c.useState(null),[ht,mt]=c.useState(!1),[ae,ft]=c.useState(null),[pt,_e]=c.useState(!1),[qe,Ve]=c.useState(null),[ie,We]=c.useState(null),T=a!=="projection",I=a!=="snapshot",U=l,Ne=l.inventory||{},gt=Ne.settings||{},ee=l.settings||{},yt=l.forecast&&typeof l.forecast=="object"?l.forecast:{},Ue=c.useMemo(()=>{const e=structuredClone(yt||{});return Un(e),e},[yt]),tn=c.useMemo(()=>Dn(Ue),[Ue]),Ge=In(Ue.lastImpactSummary),bt=String(Ue.activeVersionId||"").trim()||null,De=Ge.toVersionId&&bt&&Ge.toVersionId===bt?Ge.foConflictsOpen:0;c.useEffect(()=>{if(me.current)return;const e=new URLSearchParams(i.search);if(e.get("source")!=="dashboard")return;me.current=!0;const s=String(e.get("sku")||"").trim();s?(ct(s),ft(s),_e(!1)):(ft(null),_e(!0),Ve(null));const n=F(e.get("month"));n&&dt(n),Se(Jn(e.get("risk"))),oe(Xn(e.get("abc"))),e.has("mode")&&lt(Yn(e.get("mode"))),e.get("expand")==="all"&&mt(!0)},[i.search]);const W=c.useMemo(()=>{const e=new Set;return e.add(ne()),(Array.isArray(Ne.snapshots)?Ne.snapshots:[]).forEach(s=>{const o=F(s.month);o&&e.add(o)}),Array.from(e).sort()},[Ne.snapshots]),we=c.useMemo(()=>Tn(U),[l.inventory]);c.useEffect(()=>{W.includes(N)||(J(we||W[W.length-1]||ne()),at(!1))},[we,W,N]),c.useEffect(()=>{if(ot)return;const e=we||W[W.length-1]||ne();e&&e!==N&&J(e)},[we,W,N,ot]),c.useEffect(()=>{const e=$n(U,N),s=nt((e==null?void 0:e.items)||[]);$e(s),ve(!1)},[N,U]),c.useEffect(()=>{const e=Number(gt.projectionMonths);Number.isFinite(e)&&e>0&&ut(st(e))},[gt.projectionMonths]);const jt=c.useMemo(()=>{const e=new Map;return(Array.isArray(l.productCategories)?l.productCategories:[]).forEach(s=>{const n=s,o=String(n.id||"");o&&e.set(o,String(n.name||"Ohne Kategorie"))}),e},[l.productCategories]),le=c.useMemo(()=>Cn(U),[l.productCategories]),Qe=c.useMemo(()=>bn(U).bySku,[l]),vt=c.useMemo(()=>{const e=Math.round(Number(ee.horizonMonths||18)),s=Number.isFinite(e)&&e>0?Math.max(18,e):18;return Kt(ne(),s)},[ee.horizonMonths]),Fe=c.useMemo(()=>{const e=Array.isArray(l.products)?l.products:[],s=new Set(e.map(r=>String((r==null?void 0:r.sku)||"").trim().toLowerCase()).filter(Boolean)),n=On({state:U,months:vt}),o=[];return n.forEach((r,u)=>{if(!It(r.includeInForecast,!0))return;const m=String(r.status||"").trim().toLowerCase();if(m&&m!=="active"&&m!=="aktiv"||String(r.mappedSku||"").trim())return;const p=String(r.alias||"").trim();if(!p)return;const k=String(r.plannedSku||"").trim(),w=`PLAN-${Yt(r.id||p,String(u+1))}`,L=Wn(k||w,s);s.add(L.toLowerCase());const A=qn(r.transportMode),_=K(r.transitDays)??Vn(ee,A),q=K(r.productionLeadTimeDaysDefault),te=K(r.unitPriceUsd),V=_n(r.logisticsPerUnitEur??r.freightPerUnitEur),be={},dn=r.unitsByMonth&&typeof r.unitsByMonth=="object"?r.unitsByMonth:{};Object.entries(dn).forEach(([hn,mn])=>{const Et=F(hn),Bt=Number(mn);!Et||!Number.isFinite(Bt)||(be[Et]=Math.max(0,Math.round(Bt)))}),o.push({sku:L,raw:{...r,id:`plan-virtual-${String(r.id||u+1)}`,sku:L,alias:p,status:"active",includeInForecast:!0,productionLeadTimeDaysDefault:q!=null?Math.round(q):null,transportMode:A,transitDays:_!=null?Math.round(_):null,unitPriceUsd:te!=null?Number(te):null,logisticsPerUnitEur:V!=null?Number(V):null,freightPerUnitEur:V!=null?Number(V):null,template:{scope:"SKU",name:"Planprodukt",fields:{transportMode:A,transitDays:_!=null?Math.round(_):null,productionDays:q!=null?Math.round(q):null,unitPriceUsd:te!=null?Number(te):null,freightEur:V!=null?Number(V):null}},__planVirtual:!0,__planProductId:String(r.id||"")},plannedUnitsByMonth:be})}),o},[vt,ee,l.forecast,l.planProducts,l.products,U]),Pe=c.useMemo(()=>{const e={};return Fe.forEach(s=>{e[s.sku]={...s.plannedUnitsByMonth}}),e},[Fe]),Oe=c.useMemo(()=>{const e=(Array.isArray(l.products)?l.products:[]).map(n=>n),s=Fe.map(n=>n.raw);return[...e,...s].map(n=>({sku:String(n.sku||"").trim(),raw:n})).filter(n=>n.sku)},[l.products,Fe]),St=c.useMemo(()=>new Map(Oe.map(e=>[e.sku,e.raw])),[Oe]),ce=c.useMemo(()=>Gt(U,N),[N,U]),kt=c.useMemo(()=>nt((ce==null?void 0:ce.items)||[]),[ce==null?void 0:ce.items]),xt=c.useMemo(()=>Oe.map(e=>{const s=e.raw,n=String(e.sku||"").trim();if(!n)return null;const o=String(s.alias||n),r=String(s.status||"").trim().toLowerCase(),u=It(s.includeInForecast,!0)&&(!r||r==="active"||r==="aktiv"),h=jt.get(String(s.categoryId||""))||"Ohne Kategorie",m=Re[n]||{amazonUnits:0,threePLUnits:0},b=kt[n]||{amazonUnits:0,threePLUnits:0},p=m.amazonUnits+m.threePLUnits,k=b.amazonUnits+b.threePLUnits,w=jn(s,U),L=vn(s,U),A=Qe.get(n.toLowerCase())||Qe.get(n)||null,_=(A==null?void 0:A.abcClass)??null,q=(A==null?void 0:A.abcBasis)||"no_data";return{sku:n,alias:o,categoryLabel:h,abcClass:_,abcBasis:q,isActive:u,amazonUnits:m.amazonUnits,threePLUnits:m.threePLUnits,totalUnits:p,delta:p-k,safetyDays:Number.isFinite(w)?Number(w):null,coverageDays:Number.isFinite(L)?Number(L):null}}).filter(Boolean),[Qe,jt,kt,Oe,Re,U]),P=c.useMemo(()=>{const e=Te.trim().toLowerCase();return xt.filter(s=>He&&!s.isActive||!ts(s.abcClass,X)?!1:e?[s.sku,s.alias,s.categoryLabel,s.abcClass||""].join(" ").toLowerCase().includes(e):!0).sort((s,n)=>{const o=An(s.categoryLabel,n.categoryLabel,le);if(o!==0)return o;const r=s.alias.localeCompare(n.alias,"de-DE",{sensitivity:"base"});return r!==0?r:s.sku.localeCompare(n.sku,"de-DE",{sensitivity:"base"})})},[X,xt,le,He,Te]),H=c.useMemo(()=>Qt(P,le),[le,P]);c.useEffect(()=>{T&&xe(e=>{if(!H.length)return[];const s=new Set(H.map(o=>o.key)),n=e.filter(o=>s.has(o));return n.length||z?n:H.map(o=>o.key)})},[H,z,T]),c.useEffect(()=>{Tt("inventory_snapshot",ke)},[ke]),c.useEffect(()=>{Tt("inventory_projection",Me)},[Me]);const pe=ne(),Mt=c.useMemo(()=>Mn(pe,-1),[pe]),M=c.useMemo(()=>Kt(pe,Y),[pe,Y]),g=c.useMemo(()=>Sn({state:U,months:M,products:P.map(e=>({sku:e.sku,alias:e.alias,status:e.isActive?"active":"inactive",safetyStockDohOverride:e.safetyDays,foCoverageDohOverride:e.coverageDays})),snapshot:null,snapshotMonth:Mt,projectionMode:S,forecastUnitsBySkuMonth:Pe}),[P,Mt,S,M,U,Pe]),Ct=c.useMemo(()=>{const e=wn(U),s={...e.plannedSalesBySku||{}};return Object.entries(Pe).forEach(([n,o])=>{s[n]={...s[n]||{},...o}}),{...e,plannedSalesBySku:s}},[l.forecast,l.inventory,l.pos,l.fos,U,Pe]),G=c.useMemo(()=>{const e=new Set,s=new Set;let n=null,o=null;return P.forEach(r=>{M.forEach(u=>{var b;const h=(b=g.perSkuMonth.get(r.sku))==null?void 0:b.get(u);if(!h)return;const m=ue({projectionMode:S,endAvailable:h.endAvailable,safetyUnits:h.safetyUnits,doh:h.doh,safetyDays:h.safetyDays});m&&(e.add(r.sku),(!n||u<n)&&(n=u),m==="safety-negative"&&(s.add(r.sku),(!o||u<o)&&(o=u)))})}),{underSafetySkus:e.size,oosSkus:s.size,criticalMonth:o||n,missingEta:Number(g.inboundMissingDateCount||0)}},[P,g,S,M]),ge=c.useMemo(()=>{const e=new Map;return M.forEach(s=>{e.set(s,{month:s,score:0,oosCount:0,underSafetyCount:0,criticalSkus:new Set})}),P.forEach(s=>{M.forEach(n=>{var h;const o=(h=g.perSkuMonth.get(s.sku))==null?void 0:h.get(n);if(!o)return;const r=ue({projectionMode:S,endAvailable:o.endAvailable,safetyUnits:o.safetyUnits,doh:o.doh,safetyDays:o.safetyDays});if(!r)return;const u=e.get(n);u&&(u.score+=Zn(s.abcClass,r),u.underSafetyCount+=1,r==="safety-negative"&&(u.oosCount+=1),u.criticalSkus.add(s.sku))})}),e},[P,g,S,M]),At=c.useMemo(()=>{const e=Array.from(ge.values()).map(s=>Number(s.score||0));return e.length?Math.max(...e,0):0},[ge]),Nt=c.useMemo(()=>{const e=new Map;return P.forEach(s=>{let n=!1,o=!1;M.forEach(r=>{var m;const u=(m=g.perSkuMonth.get(s.sku))==null?void 0:m.get(r);if(!u)return;const h=ue({projectionMode:S,endAvailable:u.endAvailable,safetyUnits:u.safetyUnits,doh:u.doh,safetyDays:u.safetyDays});h&&(o=!0,h==="safety-negative"&&(n=!0))}),e.set(s.sku,{hasOos:n,hasUnderSafety:o})}),e},[P,g,S,M]),ye=c.useMemo(()=>re==="all"?P:P.filter(e=>{const s=Nt.get(e.sku);return s?re==="oos"?s.hasOos:s.hasUnderSafety:!1}),[P,Nt,re]),Le=c.useMemo(()=>Qt(ye,le),[le,ye]),Ee=c.useMemo(()=>{var e;return B?((e=ge.get(B))==null?void 0:e.criticalSkus)||new Set:null},[B,ge]),O=c.useMemo(()=>!B||!Ee||!Ee.size?Le:Le.map(e=>({...e,rows:e.rows.filter(s=>Ee.has(s.sku))})).filter(e=>e.rows.length>0),[Le,Ee,B]);function Ut(e,s,n,o){const r=St.get(e.sku)||null,u=Gn(r,ee),h=Fn({context:Ct,sku:e.sku,leadTimeDays:u,product:r,settings:ee,horizonMonths:Math.max(6,Y),requiredArrivalMonth:s}),m=String((h==null?void 0:h.status)||""),b=Number((h==null?void 0:h.recommendedUnits)||0),p=Math.max(0,Math.ceil(Number(n.safetyUnits||0)-Number(n.endAvailable||0))),k=Math.max(0,Math.round(Number.isFinite(b)&&b>0?b:p)),w=String((h==null?void 0:h.requiredArrivalDate)||Hn(s)||"")||null,L=String((h==null?void 0:h.orderDateAdjusted)||(h==null?void 0:h.orderDate)||"")||null;return{cellKey:o,row:e,month:s,data:n,recommendedUnits:k,requiredArrivalDate:w,recommendedOrderDate:L,recommendation:h,recommendationStatus:m}}const Be=c.useMemo(()=>{if(S==="plan")return new Map;const e=new Map;return ye.forEach(s=>{var h,m;let n=null;for(const b of M){const p=(h=g.perSkuMonth.get(s.sku))==null?void 0:h.get(b);if(!p)continue;const k=ue({projectionMode:S,endAvailable:p.endAvailable,safetyUnits:p.safetyUnits,doh:p.doh,safetyDays:p.safetyDays});if(k==="safety-negative"||k==="safety-low"){n=b;break}}if(!n)return;const o=(m=g.perSkuMonth.get(s.sku))==null?void 0:m.get(n);if(!o)return;const r=`${s.sku}|${n}`,u=Ut(s,n,o,r);u.recommendationStatus!=="ok"||u.recommendedUnits<=0||e.set(r,u)}),e},[St,g,S,M,ye,Y,Ct,ee]),Q=c.useMemo(()=>{const e=Array.from(Be.values()).map(s=>{const n=ue({projectionMode:S,endAvailable:s.data.endAvailable,safetyUnits:s.data.safetyUnits,doh:s.data.doh,safetyDays:s.data.safetyDays});if(n!=="safety-negative"&&n!=="safety-low")return null;const o=rt(s.row.abcClass),r=s.month,u=Number(String(r||"").replace("-","")),h=n==="safety-negative"?-.5:0,m=es(o)*1e3+(Number.isFinite(u)?u:999999)+h;return{key:`${s.row.sku}|${s.month}`,sku:s.row.sku,alias:s.row.alias,abcClass:o,month:r,riskClass:n,recommendedUnits:s.recommendedUnits,requiredArrivalDate:s.requiredArrivalDate,recommendedOrderDate:s.recommendedOrderDate,priority:m,intent:s}}).filter(Boolean);return e.sort((s,n)=>{if(s.priority!==n.priority)return s.priority-n.priority;if(s.month!==n.month)return s.month.localeCompare(n.month);const o=Number(n.recommendedUnits||0)-Number(s.recommendedUnits||0);return o!==0?o:s.sku.localeCompare(n.sku,"de-DE",{sensitivity:"base"})}),e},[Be,S]);c.useEffect(()=>{B&&!M.includes(B)&&Ce(null)},[M,B]),c.useEffect(()=>{Ae&&M.length&&(M.includes(Ae)&&Ce(Ae),dt(null))},[Ae,M]),c.useEffect(()=>{I&&fe(e=>{if(!O.length)return[];const s=new Set(O.map(o=>o.key)),n=e.filter(o=>s.has(o));return n.length||$?n:O.map(o=>o.key)})},[$,O,I]),c.useEffect(()=>{!I||!ht||O.length&&(fe(O.map(e=>e.key)),mt(!1))},[ht,O,I]),c.useEffect(()=>{if(!I||!ae||pt)return;const e=`v2-proj-sku-${encodeURIComponent(ae)}`,s=ae.toLowerCase(),n=Array.from(document.querySelectorAll("[data-proj-sku-key]")).find(r=>String(r.dataset.projSkuKey||"")===s)||document.getElementById(e);if(!(n instanceof HTMLElement))return;n.scrollIntoView({behavior:"smooth",block:"center"}),Ve(ae),_e(!0);const o=window.setTimeout(()=>{Ve(r=>r&&(r.toLowerCase()===ae.toLowerCase()?null:r))},2200);return()=>window.clearTimeout(o)},[pt,ae,O,I]);function Dt(e,s,n,o){We(Ut(e,s,n,o))}function Ie(e,s){if(!e)return;const n=new URLSearchParams;n.set("source","inventory_projection"),n.set("sku",e.row.sku),n.set("month",e.month),n.set("suggestedUnits",String(e.recommendedUnits||0)),n.set("projectedEnd",String(Math.round(Number(e.data.endAvailable||0)))),n.set("mode",S),e.requiredArrivalDate&&n.set("requiredArrivalDate",e.requiredArrivalDate),e.recommendedOrderDate&&n.set("recommendedOrderDate",e.recommendedOrderDate),n.set("returnTo","/v2/inventory/projektion");const o=(s==null?void 0:s.nextIntent)||null;o&&(n.set("nextSku",o.row.sku),n.set("nextMonth",o.month),n.set("nextSuggestedUnits",String(o.recommendedUnits||0)),o.requiredArrivalDate&&n.set("nextRequiredArrivalDate",o.requiredArrivalDate),o.recommendedOrderDate&&n.set("nextRecommendedOrderDate",o.recommendedOrderDate)),d(`/v2/orders/fo?${n.toString()}`),We(null)}function nn(e){var s,n,o,r,u,h,m,b,p,k,w,L,A,_,q,te,V,be;return t.jsxs("div",{className:"v2-proj-action-menu",children:[t.jsx(f,{strong:!0,children:e.row.alias}),t.jsx(f,{type:"secondary",children:e.row.sku}),t.jsx(f,{type:"secondary",children:se(e.month)}),t.jsxs(f,{children:["Bestand EOM: ",t.jsx("strong",{children:j(e.data.endAvailable)})]}),t.jsxs(f,{children:["Safety: ",t.jsx("strong",{children:j(e.data.safetyUnits)})]}),t.jsxs(f,{children:["Ankunft: ",t.jsx("strong",{children:he(e.requiredArrivalDate)})]}),t.jsxs(f,{children:["Bestellen bis: ",t.jsx("strong",{children:he(e.recommendedOrderDate)})]}),t.jsxs(f,{children:["Vorschlag: ",t.jsx("strong",{children:j(e.recommendedUnits)})]}),e.recommendationStatus!=="ok"?t.jsx(f,{type:"warning",children:"Hinweis: Empfehlung ist nicht vollständig belastbar."}):null,Number(((s=e.recommendation)==null?void 0:s.coverageDaysForOrder)||0)>0?t.jsxs(f,{type:"secondary",children:["Bedarf (",j(Number(((n=e.recommendation)==null?void 0:n.coverageDaysForOrder)||0))," Tage): ",j(Number(((o=e.recommendation)==null?void 0:o.coverageDemandUnits)||0))]}):null,(r=e.recommendation)!=null&&r.moqApplied?t.jsxs(f,{type:"warning",children:["MOQ angewendet: kalkulatorisch ",j(Number(((u=e.recommendation)==null?void 0:u.recommendedUnitsRaw)||0))," → MOQ ",j(Number(((h=e.recommendation)==null?void 0:h.unitsAfterMoq)||0))]}):null,Number(((m=e.recommendation)==null?void 0:m.unitsPerCarton)||0)>1?t.jsxs(f,{type:"secondary",children:["Kartonbasis: ",j(Number(((b=e.recommendation)==null?void 0:b.unitsPerCarton)||0))," Units/Karton",Number(((p=e.recommendation)==null?void 0:p.recommendedCartons)||0)>0?` · ${j(Number(((k=e.recommendation)==null?void 0:k.recommendedCartons)||0))} Kartons`:""]}):null,(w=e.recommendation)!=null&&w.cartonRoundingApplied?t.jsxs(f,{type:"secondary",children:["Karton-Aufrundung: ",j(Number(((L=e.recommendation)==null?void 0:L.unitsAfterMoq)||0))," → ",j(Number(((A=e.recommendation)==null?void 0:A.unitsAfterCartonRounding)||0))]}):null,(_=e.recommendation)!=null&&_.blockRoundupApplied?t.jsxs(f,{type:"warning",children:["Block-Roundup (",j(Number(((q=e.recommendation)==null?void 0:q.roundupCartonBlock)||0))," ","Kartons, max"," ",Number(((te=e.recommendation)==null?void 0:te.roundupMaxPct)||0).toLocaleString("de-DE",{maximumFractionDigits:2}),"%):"," ",j(Number(((V=e.recommendation)==null?void 0:V.unitsAfterCartonRounding)||0))," → ",j(Number(((be=e.recommendation)==null?void 0:be.recommendedUnits)||0))]}):null,t.jsx("div",{className:"v2-actions-inline",children:t.jsx(E,{size:"small",type:"primary",onClick:()=>Ie(e),children:"FO erstellen"})})]})}const Ze=c.useCallback(e=>{const s=Z(e.value);$e(n=>{const o=n[e.sku]||{amazonUnits:0,threePLUnits:0,note:""};return o[e.field]===s?n:{...n,[e.sku]:{...o,[e.field]:s}}}),ve(!0)},[]),sn=c.useMemo(()=>[{header:"Alias",accessorKey:"alias",meta:{width:270,minWidth:250},cell:({row:e})=>t.jsx(xn,{alias:e.original.alias,sku:e.original.sku})},{header:"ABC",accessorKey:"abcClass",meta:{width:72,align:"center"},cell:({row:e})=>t.jsx(je,{title:Zt(e.original.abcBasis),children:t.jsx("span",{children:e.original.abcClass||"—"})})},{header:"Amazon",accessorKey:"amazonUnits",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(Wt,{sku:e.original.sku,field:"amazonUnits",value:e.original.amazonUnits,onCommit:Ze})},{header:"3PL",accessorKey:"threePLUnits",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(Wt,{sku:e.original.sku,field:"threePLUnits",value:e.original.threePLUnits,onCommit:Ze})},{header:"Total",accessorKey:"totalUnits",meta:{width:92,align:"right"},cell:({row:e})=>j(e.original.totalUnits)},{header:"Delta",accessorKey:"delta",meta:{width:92,align:"right"},cell:({row:e})=>t.jsx("span",{className:e.original.delta<0?"v2-negative":"",children:j(e.original.delta)})},{header:"Safety DOH",accessorKey:"safetyDays",meta:{width:96,align:"right"},cell:({row:e})=>j(e.original.safetyDays)},{header:"Coverage DOH",accessorKey:"coverageDays",meta:{width:108,align:"right"},cell:({row:e})=>j(e.original.coverageDays)}],[Ze]),wt=Array.isArray(g.anchorForecastGapSkus)?g.anchorForecastGapSkus:[],Ft=Array.isArray(g.anchorSkuFallbackSkus)?g.anchorSkuFallbackSkus:[],Pt=Array.isArray(g.anchorSkuMissingHistory)?g.anchorSkuMissingHistory:[],Ot=c.useMemo(()=>new Set(Ft.map(e=>String(e||"").trim())),[Ft]),Lt=c.useMemo(()=>new Set(Pt.map(e=>String(e||"").trim())),[Pt]),rn=c.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:270,minWidth:250},cell:({row:n})=>t.jsxs("div",{id:`v2-proj-sku-${encodeURIComponent(n.original.sku)}`,"data-proj-sku-key":n.original.sku.toLowerCase(),className:["v2-proj-alias",qe&&n.original.sku.toLowerCase()===qe.toLowerCase()?"v2-proj-alias--highlight":""].filter(Boolean).join(" "),children:[t.jsx("div",{className:"v2-proj-alias-main",title:n.original.alias,children:n.original.alias}),t.jsx(f,{className:"v2-proj-sku-secondary",type:"secondary",title:n.original.sku,children:n.original.sku})]})},{header:"ABC",accessorKey:"abcClass",meta:{width:68,align:"center"},cell:({row:n})=>t.jsx(je,{title:Zt(n.original.abcBasis),children:t.jsx("span",{children:n.original.abcClass||"—"})})},{header:"Safety DOH",accessorKey:"safetyDays",meta:{width:96,align:"right"},cell:({row:n})=>j(n.original.safetyDays)},{header:"Coverage DOH",accessorKey:"coverageDays",meta:{width:110,align:"right"},cell:({row:n})=>j(n.original.coverageDays)},{header:"Ankerbestand",meta:{width:118,align:"right",sortAccessor:n=>{const o=String(n.sku||"").trim(),r=g.startAvailableBySku.get(o);return Number.isFinite(r)?Number(r):0}},cell:({row:n})=>{var k,w;const o=String(n.original.sku||"").trim(),r=g.startAvailableBySku.get(o),u=Ot.has(o),h=Lt.has(o),m=((w=(k=g.anchorSourceBySku)==null?void 0:k.get)==null?void 0:w.call(k,o))||null,b=m!=null&&m.month?de(String(m.month),"long"):"—",p=h?"Keine Snapshot-Historie für diese SKU. Startwert = 0.":u?`SKU-Fallback: letzter verfügbarer Snapshot (${b}).`:`Anchor-Snapshot (${b}).`;return t.jsx(je,{title:p,children:t.jsx("span",{children:j(Number.isFinite(r)?Number(r):0)})})}}],s=M.map(n=>({id:n,header:se(n),meta:{minWidth:106,width:106,align:"right",sortAccessor:o=>{var u;const r=(u=g.perSkuMonth.get(o.sku))==null?void 0:u.get(n);return r?S==="plan"?Number.isFinite(r.forecastUnits)?Number(r.forecastUnits):null:S==="doh"?Number.isFinite(r.doh)?Number(r.doh):null:Number.isFinite(r.endAvailable)?Number(r.endAvailable):null:null}},cell:({row:o})=>{var L;const r=(L=g.perSkuMonth.get(o.original.sku))==null?void 0:L.get(n);if(!r)return"—";let u=null;S==="plan"?u=Number.isFinite(r.forecastUnits)?Number(r.forecastUnits):null:S==="doh"?u=Number.isFinite(r.doh)?Number(r.doh):null:u=Number.isFinite(r.endAvailable)?Number(r.endAvailable):null;const h=ue({projectionMode:S,endAvailable:r.endAvailable,safetyUnits:r.safetyUnits,doh:r.doh,safetyDays:r.safetyDays}),m=S!=="plan",b=r.inboundDetails,p=`${o.original.sku}|${n}`,k=Be.get(p)||null,w=(ie==null?void 0:ie.cellKey)===p;return t.jsx(Ht,{trigger:m?"click":"hover",placement:"rightTop",open:m?w:void 0,onOpenChange:A=>{m&&!A&&w&&We(null)},content:w&&ie?nn(ie):null,children:t.jsxs("div",{className:["v2-proj-cell",h?`v2-proj-cell--${h}`:"",m?"v2-proj-cell--actionable":""].filter(Boolean).join(" "),role:m?"button":void 0,tabIndex:m?0:void 0,onClick:m?()=>Dt(o.original,n,r,p):void 0,onKeyDown:m?A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),Dt(o.original,n,r,p))}:void 0,children:[t.jsx("div",{className:"v2-proj-cell-main",children:j(u)}),S!=="plan"&&Number.isFinite(r.safetyUnits)?t.jsxs(f,{type:"secondary",style:{fontSize:11},children:["SB: ",j(r.safetyUnits)]}):null,k?t.jsx("button",{type:"button",className:"v2-proj-fo-badge",onClick:A=>{A.stopPropagation(),Ie(k)},children:"FO empfohlen"}):null,b&&b.totalUnits>0?t.jsx(Ht,{content:ns(b),trigger:"hover",placement:"topLeft",children:t.jsxs("div",{className:"v2-proj-inbound-row",children:[b.poUnits>0?t.jsxs(v,{className:"v2-proj-inbound v2-proj-inbound--po",children:["PO +",j(b.poUnits)]}):null,b.foUnits>0?t.jsxs(v,{className:"v2-proj-inbound v2-proj-inbound--fo",children:["FO +",j(b.foUnits)]}):null]})}):null]})})}}));return[...e,...s]},[ie,Lt,Ot,Be,qe,g,S,M]);async function on(){await R(e=>{const s=yn(e),n=s;zn(n);const o=n.inventory,r=Array.isArray(o.snapshots)?[...o.snapshots]:[],u=Object.entries(Re).map(([p,k])=>({sku:p,amazonUnits:Z(k.amazonUnits),threePLUnits:Z(k.threePLUnits),note:String(k.note||"")})).filter(p=>p.amazonUnits>0||p.threePLUnits>0||p.note),h=F(N)||ne(),m=r.findIndex(p=>F(p.month)===h),b={month:h,items:u,updatedAt:Rn()};return m>=0?r[m]={...r[m]||{},...b}:r.push(b),r.sort((p,k)=>String(F(p.month)).localeCompare(String(F(k.month)))),o.snapshots=r,o.settings={...o.settings||{},projectionMonths:st(Y)},s},"v2:inventory:save-snapshot"),ve(!1)}async function an(){const e=Gt(U,N);e&&($e(nt(e.items||[])),ve(!0))}function ln(){const s=[["SKU","Alias","Kategorie","AmazonUnits","ThreePLUnits","TotalUnits"],...P.map(u=>[u.sku,u.alias,u.categoryLabel,String(u.amazonUnits),String(u.threePLUnits),String(u.totalUnits)])].map(u=>u.map(h=>`"${String(h).replace(/"/g,'""')}"`).join(";")).join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=`inventory-snapshot-${N}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}const Je=String(g.anchorMode||"no_snapshot"),Xe=F(g.anchorTargetMonth||g.anchorMonth),cn=pe,un=Je==="rollforward"?`Anker: ${g.anchorSourceMonth||"—"} Snapshot → Rollforward bis ${Xe||"—"}`:Je==="snapshot"?`Anker: Snapshot ${Xe||g.anchorSourceMonth||"—"}`:"Anker: kein Snapshot (Start bei 0)";return t.jsxs("div",{className:"v2-page",children:[t.jsxs(et,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(tt,{level:3,children:T&&!I?"Bestandsaufnahme":I&&!T?"Bestandsprojektion":"Inventory"}),t.jsx(Bn,{children:T&&!I?"Monatliche Snapshot-Erfassung mit Kategoriegruppen, Copy-Forward, Speicherung und CSV-Export.":I&&!T?"Bestandsprojektion mit Risikoampel, PO/FO-Inbound-Sicht und direkter Bestellbrücke.":"Snapshot-Erfassung und Projektion (Units / DOH / Plan) in einem Arbeitsbereich."})]})}),t.jsxs("div",{className:"v2-toolbar",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[T?t.jsx(_t,{value:N,onChange:e=>{J(e),at(!0)},options:W.map(e=>({value:e,label:`${e} · ${de(e,"long")}`})),style:{width:260,maxWidth:"100%"}}):null,t.jsx(Jt,{value:Te,onChange:e=>ct(e.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),t.jsx(Ln,{checked:He,onChange:e=>en(e.target.checked),children:"Nur aktive Produkte"}),I?t.jsxs(t.Fragment,{children:[t.jsxs(Ke.Group,{value:S,onChange:e=>lt(e.target.value),children:[t.jsx(Ke.Button,{value:"units",children:"Units"}),t.jsx(Ke.Button,{value:"doh",children:"DOH"}),t.jsx(Ke.Button,{value:"plan",children:"Plan"})]}),t.jsx(je,{title:Qn(S),children:t.jsx(En,{style:{color:"#64748b",fontSize:16}})}),t.jsx(_t,{value:Y,onChange:e=>ut(st(e)),style:{width:160,maxWidth:"100%"},options:Xt.map(e=>({value:e,label:`Horizont ${e} Monate`}))})]}):null,t.jsxs(v,{color:"blue",children:["Baseline Forecast: ",tn]}),De>0?t.jsxs(E,{size:"small",onClick:()=>d("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",De," FOs prüfen"]}):null]}),T?t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(E,{onClick:()=>{an()},children:"Vorherigen Monat kopieren"}),t.jsx(E,{type:"primary",onClick:()=>{on()},disabled:!it,loading:C,children:"Snapshot speichern"}),t.jsx(E,{onClick:ln,children:"Snapshot CSV"}),it?t.jsx(v,{color:"orange",children:"Ungespeicherte Änderungen"}):t.jsx(v,{color:"green",children:"Gespeichert"}),t.jsx(v,{color:"blue",children:de(N,"long")}),D?t.jsxs(v,{color:"green",children:["Gespeichert: ",new Date(D).toLocaleTimeString("de-DE")]}):null]}):null]})]}),x?t.jsx(ze,{type:"error",showIcon:!0,message:x}):null,y?t.jsx(ze,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,De>0?t.jsx(ze,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${De} FOs prüfen`,description:t.jsx(E,{size:"small",onClick:()=>d("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,T?t.jsxs(et,{children:[t.jsxs(tt,{level:4,children:["Snapshot zum Stichtag ",de(N,"long")]}),t.jsxs(f,{type:"secondary",children:["Monatsschlüssel: ",N]}),t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(f,{type:"secondary",children:[P.length," Produkte in ",H.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(E,{size:"small",onClick:()=>xe(H.map(e=>e.key)),disabled:!H.length,children:"Alles auf"}),t.jsx(E,{size:"small",onClick:()=>xe([]),disabled:!ke.length,children:"Alles zu"})]})]}),H.length?t.jsx(qt,{className:"v2-category-collapse",activeKey:ke,onChange:e=>xe((Array.isArray(e)?e:[e]).map(String)),items:H.map(e=>({key:e.key,label:t.jsxs(Ye,{children:[t.jsx(f,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(zt,{data:e.rows,columns:sn,minTableWidth:1e3,tableLayout:"fixed"})}))}):t.jsx(f,{type:"secondary",children:"Keine Snapshot-Zeilen für den aktuellen Filter."})]}):null,I?t.jsxs(et,{children:[t.jsxs(tt,{level:4,children:["Projektion (",S.toUpperCase(),")"]}),t.jsxs("div",{className:"v2-proj-cluster-grid",children:[t.jsxs("div",{className:"v2-proj-context-cluster",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(v,{color:"blue",children:["Heute: ",de(cn,"long")]}),t.jsx(v,{color:Je==="no_snapshot"?"red":"blue",children:un}),t.jsxs(v,{color:"default",children:["Zeitraum: ",M[0]||"—"," bis ",M[M.length-1]||"—"]}),t.jsxs(v,{color:"default",children:["Horizont: ",Y," Monate"]})]}),t.jsxs("div",{className:"v2-toolbar-row",children:[g.snapshotFallbackUsed?t.jsx(v,{color:"gold",children:"Fallback auf letzten Snapshot ≤ Ankermonat"}):null,g.resolvedSnapshotMonth?t.jsxs(v,{color:"blue",children:["Stichtag Anchor: ",de(String(g.resolvedSnapshotMonth||Xe||""),"long")]}):null,Number(g.anchorSkuFallbackCount||0)>0?t.jsxs(v,{color:"gold",children:["SKU-Fallback aktiv: ",Number(g.anchorSkuFallbackCount||0)]}):null,G.missingEta>0?t.jsxs(v,{color:"orange",children:["Fehlende ETA: ",G.missingEta]}):t.jsx(v,{color:"green",children:"Fehlende ETA: 0"}),t.jsx(je,{title:"Units = projizierter Monatsendbestand · DOH = Reichweite in Tagen · Plan = Forecast-Absatz · Safety = Vergleich gegen Safety-Schwelle je SKU/Monat",children:t.jsx(v,{color:"default",children:"Modus-Hilfe"})})]}),wt.length>0?t.jsx(ze,{className:"v2-proj-anchor-warning",type:"warning",showIcon:!0,message:`Anker-Rollforward mit Forecast-Lücken bei ${wt.length} SKU(s) – diese Monate wurden mit 0 Units gerechnet.`}):null]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(f,{type:"secondary",children:"Risiko-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${re==="all"?"is-active":""}`,onClick:()=>Se("all"),children:"Alle Risiken"}),t.jsxs("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--negative ${re==="oos"?"is-active":""}`,onClick:()=>Se("oos"),children:["OOS / ","<="," 0"]}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--low ${re==="under_safety"?"is-active":""}`,onClick:()=>Se("under_safety"),children:"Unter Safety"})]})]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(f,{type:"secondary",children:"ABC-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${X==="all"?"is-active":""}`,onClick:()=>oe("all"),children:"Alle"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${X==="a"?"is-active":""}`,onClick:()=>oe("a"),children:"A"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${X==="b"?"is-active":""}`,onClick:()=>oe("b"),children:"B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${X==="ab"?"is-active":""}`,onClick:()=>oe("ab"),children:"A+B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${X==="abc"?"is-active":""}`,onClick:()=>oe("abc"),children:"ABC"})]})]})]}),t.jsxs("div",{className:"v2-proj-score-strip",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(v,{color:G.underSafetySkus>0?"gold":"green",children:["SKUs unter Safety: ",G.underSafetySkus]}),t.jsxs(v,{color:G.oosSkus>0?"red":"green",children:["OOS: ",G.oosSkus]}),t.jsxs(v,{color:"blue",children:["Kritischster Monat: ",G.criticalMonth?se(G.criticalMonth):"—"]})]}),t.jsxs("div",{className:"v2-proj-heatmap",children:[M.map(e=>{const s=ge.get(e),n=Number((s==null?void 0:s.score)||0),o=At>0?Math.min(1,n/At):0,r=B===e;return t.jsxs("button",{type:"button",className:`v2-proj-heatmap-item${r?" is-active":""}`,style:{background:`rgba(220, 38, 38, ${.08+o*.3})`,borderColor:r?"rgba(220, 38, 38, 0.8)":"rgba(15, 27, 45, 0.12)"},onClick:()=>Ce(u=>u===e?null:e),title:`${se(e)} · ABC-gewichteter Risikoscore ${n} · OOS ${Number((s==null?void 0:s.oosCount)||0)} · Unter Safety ${Number((s==null?void 0:s.underSafetyCount)||0)}`,children:[t.jsx("span",{children:se(e)}),t.jsxs("strong",{children:["Score ",n]})]},e)}),B?t.jsx(E,{size:"small",onClick:()=>Ce(null),children:"Filter löschen"}):null]}),t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(v,{className:"v2-proj-legend v2-proj-legend--negative",children:["Rot = OOS / ","<="," 0"]}),t.jsx(v,{className:"v2-proj-legend v2-proj-legend--low",children:"Orange = Unter Safety"}),t.jsx(v,{className:"v2-proj-legend",children:"Inbound Marker: PO / FO"}),t.jsx(f,{type:"secondary",children:"`FO empfohlen` im ersten Risikomonat anklicken oder Zelle öffnen für FO-Anlage."})]})]}),t.jsxs("div",{className:"v2-proj-worklist",children:[t.jsxs("div",{className:"v2-proj-worklist-head",children:[t.jsxs(Ye,{wrap:!0,children:[t.jsx(f,{strong:!0,children:"FO-Arbeitsliste"}),t.jsxs(v,{color:Q.length?"gold":"green",children:[Q.length," SKU(s)"]}),t.jsx(v,{color:"blue",children:"Sortierung: A/B zuerst, frühester Risikomonat"})]}),Q.length?t.jsx(E,{size:"small",type:"primary",onClick:()=>{var e,s;return Ie(((e=Q[0])==null?void 0:e.intent)||null,{nextIntent:((s=Q[1])==null?void 0:s.intent)||null})},children:"Erste SKU öffnen"}):null]}),Q.length?t.jsx(kn,{children:t.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"SKU"}),t.jsx("th",{children:"ABC"}),t.jsx("th",{children:"Risikomonat"}),t.jsx("th",{children:"Risiko"}),t.jsx("th",{children:"Empfohlen"}),t.jsx("th",{children:"ETA-Ziel"}),t.jsx("th",{children:"Bestellen bis"}),t.jsx("th",{children:"Aktion"})]})}),t.jsx("tbody",{children:Q.map((e,s)=>{var o;const n=((o=Q[s+1])==null?void 0:o.intent)||null;return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx(f,{className:"v2-proj-alias-main",children:e.alias||e.sku}),t.jsx(f,{className:"v2-proj-sku-secondary",type:"secondary",children:e.sku})]})}),t.jsx("td",{children:e.abcClass||"—"}),t.jsx("td",{children:se(e.month)}),t.jsx("td",{children:e.riskClass==="safety-negative"?t.jsx(v,{color:"red",children:"OOS / ≤ 0"}):t.jsx(v,{color:"gold",children:"Unter Safety"})}),t.jsx("td",{children:j(e.recommendedUnits)}),t.jsx("td",{children:he(e.requiredArrivalDate)}),t.jsx("td",{children:he(e.recommendedOrderDate)}),t.jsx("td",{children:t.jsx(E,{size:"small",type:"primary",onClick:()=>Ie(e.intent,{nextIntent:n}),children:"FO öffnen"})})]},e.key)})})]})}):t.jsx(f,{type:"secondary",children:"Keine FO-Empfehlungen im aktuellen Filterumfang."})]}),t.jsxs("div",{className:"v2-category-tools",style:{marginTop:10},children:[t.jsx(f,{type:"secondary",children:B?`${O.reduce((e,s)=>e+s.rows.length,0)} kritische Produkte in ${O.length} Kategorien (${se(B)})`:`${ye.length} Produkte in ${Le.length} Kategorien`}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(E,{size:"small",onClick:()=>fe(O.map(e=>e.key)),disabled:!O.length,children:"Alles auf"}),t.jsx(E,{size:"small",onClick:()=>fe([]),disabled:!Me.length,children:"Alles zu"})]})]}),O.length?t.jsx(qt,{className:"v2-category-collapse",activeKey:Me,onChange:e=>fe((Array.isArray(e)?e:[e]).map(String)),items:O.map(e=>({key:e.key,label:t.jsxs(Ye,{children:[t.jsx(f,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(zt,{data:e.rows,columns:rn,minTableWidth:Math.max(1080,760+M.length*118),tableLayout:"fixed",crosshair:"matrix"})}))}):t.jsx(f,{type:"secondary",children:"Keine Projektion für den aktuellen Filter."})]}):null]})}export{ks as I};
