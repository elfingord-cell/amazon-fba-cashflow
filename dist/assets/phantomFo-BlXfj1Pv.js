import{p as Fe}from"./index-DZx8ouWC.js";import{e as Ve,r as Ie}from"./productCompletenessV2-D1rSyPRd.js";import{c as Ne,a as We,n as Z,m as qe}from"./months-DiLwPhVv.js";import{e as Ge,f as He,b as Xe,h as Ye,k as Ze}from"./orderUtils-CvLwbyX7.js";import{b as Oe}from"./abcClassification-sRzf5rvu.js";import{c as De,g as Je}from"./inventoryProjection-yyAEANAV.js";const Ce={wide:.95,partial:.8},Qe={full:{label:"Vollständig",detail:"Coverage 100% und keine Blocker."},wide:{label:"Weitgehend",detail:"Coverage ≥95% und keine A/B-Blocker."},partial:{label:"Teilweise",detail:"Coverage ≥80%."},insufficient:{label:"Unzureichend",detail:"Coverage <80% oder A/B-Blocker."}};function L(e){return String(e||"").trim()}function F(e){return L(e).toLowerCase()}function et(e){if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function xe(e){return/^\d{4}-\d{2}$/.test(String(e||""))}function $e(e){return e!=null&&String(e).trim()!==""}function x(e){const t=Fe(e);return Number.isFinite(t)?Number(t):null}function O(e){const t=x(e);return!Number.isFinite(t)||Number(t)<=0?null:Math.round(Number(t))}function tt(e){if(!xe(e))return null;const[t,s]=e.split("-").map(Number);return!t||!s?null:new Date(Date.UTC(t,s-1,1))}function st(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function rt(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`}function ot(e,t){const s=new Date(e.getTime());return s.setUTCDate(s.getUTCDate()+t),s}function we(e,t){const s=e.get(t),r=e.get(F(t)),o=String((s==null?void 0:s.abcClass)||(r==null?void 0:r.abcClass)||"C").toUpperCase();return o==="A"||o==="B"||o==="C"?o:"C"}function nt(e){const t=e.inventory&&typeof e.inventory=="object"?e.inventory:{},s=t.settings&&typeof t.settings=="object"?t.settings:{};return String(s.projectionMode||"").toLowerCase()==="doh"?"doh":"units"}function it(e){return Number.isFinite(e)?`${Math.max(0,Math.min(100,e*100)).toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}%`:"0.0%"}function Be(e,t){return!e||!e.hasForecast?"":Je({projectionMode:t,endAvailable:e.endAvailable,safetyUnits:e.safetyUnits,doh:e.doh,safetyDays:e.safetyDays})}function at(e,t){return e!=null&&e.hasForecast?t==="safety-negative"?"stock_oos":"stock_under_safety":"forecast_missing"}function ut(e){return e==="forecast_missing"?"Forecast fehlt":e==="stock_oos"?"Out-of-Stock":"Unter Safety"}function Pe(e){return e==="A"||e==="B"}function Y(e){return e==="A"?0:e==="B"?1:2}function Ae(e){return e==="stock_oos"?0:e==="stock_under_safety"?1:2}function Re(e){return e.slice().sort((t,s)=>{const r=Y(t.abcClass)-Y(s.abcClass);if(r!==0)return r;const o=Ae(t.issueType)-Ae(s.issueType);return o!==0?o:t.sku.localeCompare(s.sku,"de-DE")})}function Te(e){return e.slice().sort((t,s)=>{const r=Number(s.overdue)-Number(t.overdue);if(r!==0)return r;const o=Y(t.abcClass)-Y(s.abcClass);if(o!==0)return o;const n=t.orderMonth.localeCompare(s.orderMonth);return n!==0?n:t.sku.localeCompare(s.sku,"de-DE")})}function ct(e){const{coverageRatio:t,blockerCount:s,blockerAbCount:r,hasOrderDutyBlocker:o,hasOverdueOrderDutyBlocker:n}=e;return t>=.999999&&s===0?"full":r>0?"insufficient":t>=Ce.wide?o||n?"partial":"wide":t>=Ce.partial?"partial":"insufficient"}function lt(e,t){const r=(Array.isArray(e.incomings)?e.incomings:[]).find(l=>String(l.month||"")===t);if(r){const l=x(r.revenueEur),i=x(r.payoutPct);if(Number.isFinite(l)||Number.isFinite(i))return!0}const n=(e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{})[t];return n?Number.isFinite(x(n.realRevenueEUR))||Number.isFinite(x(n.realPayoutRatePct)):!1}function dt(e){const t=e.settings&&typeof e.settings=="object"?e.settings:{},s=t.vatPreview&&typeof t.vatPreview=="object"?t.vatPreview:{},r=e.vatPreviewMonths&&typeof e.vatPreviewMonths=="object"?e.vatPreviewMonths:{};return{active:[s.deShareDefault,s.feeRateDefault,s.fixInputDefault,s.feeRateOfGrossDefault,s.fixInputVatDefault].some($e),defaults:s,monthOverrides:r}}function ft(e,t){if(!e.active)return!0;const s=e.monthOverrides[t]&&typeof e.monthOverrides[t]=="object"?e.monthOverrides[t]:{};return[e.defaults.deShareDefault,e.defaults.feeRateDefault,e.defaults.fixInputDefault,e.defaults.feeRateOfGrossDefault,e.defaults.fixInputVatDefault,s.deShare,s.feeRateOfGross,s.fixInputVat].some($e)}function ht(e,t){const s=Oe(e).bySku,r=[],o=[];return t.forEach(n=>{const l=L(n.sku);if(!l)return;const i=String(n.alias||l),c=we(s,l),u={sku:l,alias:i,abcClass:c},a=x(n.avgSellingPriceGrossEUR);(!Number.isFinite(a)||Number(a)<=0)&&r.push(u);const f=Ve({product:n,state:e});(f==null?void 0:f.status)==="blocked"&&o.push(u)}),{missingPrice:r,blockedCompleteness:o}}function mt(e){const{state:t,product:s}=e,r=Ie({state:t,product:s,sku:String(s.sku||""),supplierId:String(s.supplierId||""),orderContext:"product"}),o=r.fields&&typeof r.fields=="object"?r.fields:{},n=C=>{const S=o[C];return!S||typeof S!="object"?null:S.value??null},l=String(n("transportMode")||"").toUpperCase(),i=String((s.template&&typeof s.template=="object"?s.template.transportMode:null)||"SEA").toUpperCase(),c=l||i||"SEA",u=n("ddp")===!0||String(s.incoterm||"").toUpperCase()==="DDP"||!!(s.template&&typeof s.template=="object"&&s.template.ddp===!0),a=u||c==="AIR",f=a?14:45,y=a?21:45,m=O(n("productionLeadTimeDays"))??O(s.productionLeadTimeDaysDefault)??O(s.template&&typeof s.template=="object"?s.template.productionDays:null)??f,b=O(n("transitDays"))??O(s.template&&typeof s.template=="object"?s.template.transitDays:null)??O(s.transitDays)??y;return{productionDays:m,transitDays:b,totalDays:Math.max(1,m+b),transportMode:c,ddp:u}}function gt(e){const t=new Map,s=e.months.filter(r=>r>=e.nowMonth).sort((r,o)=>r.localeCompare(o));return s.length&&e.products.forEach(r=>{const o=L(r.sku);if(!o)return;const n=F(o),l=e.projection.perSkuMonth.get(o)||e.projection.perSkuMonth.get(n);if(!l)return;let i=null,c=null;for(let D=0;D<s.length;D+=1){const p=s[D],T=l.get(p),z=Be(T,e.projectionMode);if(z==="safety-negative"||z==="safety-low"){i=p,c=T||null;break}}if(!i)return;const u=tt(i);if(!(u instanceof Date)||Number.isNaN(u.getTime()))return;const a=mt({state:e.state,product:r}),f=ot(u,-a.totalDays),y=st(f),m=rt(f),b=m<e.nowMonth,C=Number(c==null?void 0:c.safetyUnits),S=Number(c==null?void 0:c.endAvailable),M=Number.isFinite(C)&&Number.isFinite(S)?Math.max(0,Math.ceil(C-S)):null;t.set(n,{sku:o,firstRiskMonth:i,latestOrderDate:y,orderMonth:m,leadTimeDays:a.totalDays,overdue:b,requiredArrivalDate:`${i}-01`,recommendedOrderDate:y,shortageUnits:M})}),t}function kt(e){const t=e.months.reduce((u,a)=>{const f=a.coverage.stockIssues.filter(y=>y.issueType==="forecast_missing").length;return u+f},0),s=e.months.reduce((u,a)=>u+a.coverage.safetyRiskSkus.length,0),r=e.months.reduce((u,a)=>u+a.coverage.orderDutyRiskSkus.length,0),o=e.months.reduce((u,a)=>u+a.coverage.overdueOrderDutySkuCount,0),n=e.months.filter(u=>{const a=u.checks.find(f=>f.key==="cash_in");return a&&!a.passed}).length,l=e.months.filter(u=>{const a=u.checks.find(f=>f.key==="vat");return a&&!a.passed}).length,i=[];if(t>0&&i.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${t} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:t,impact:"Kontostand nicht belastbar"}),s>0||r>0){const u=s+r,a=o>0?` · Überfällig ${o}`:"";i.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${u} SKU-Monat(e) mit Safety-/Bestellpflicht-Risiko${a}.`,severity:"error",route:"/v2/inventory/projektion",count:u,impact:"Stockout-Risiko in A/B möglich"})}n>0&&i.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${n} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:n,impact:"Kontostand-Projektion instabil"}),e.hasFixcostBasis||i.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:e.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),e.vatActive&&l>0&&i.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${l} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:l,impact:"Outflow-Bild unvollständig"}),e.revenueIssueSkus>0&&i.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${e.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:e.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const c=u=>u==="error"?2:1;return i.sort((u,a)=>{const f=c(a.severity)-c(u.severity);if(f!==0)return f;const y=a.count-u.count;return y!==0?y:u.title.localeCompare(a.title)}),i.slice(0,5)}function yt(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).filter(xe))).sort(),s=e.state||{},o=(Array.isArray(s.products)?s.products:[]).map(d=>d||{}).filter(d=>L(d.sku)).filter(et),n=o.length,l=Array.isArray(s.fixcosts)&&s.fixcosts.length>0,i=dt(s),c=ht(s,o),u=new Set(c.missingPrice.map(d=>F(d.sku))),a=Ne(),f=nt(s),y=t.filter(d=>d<a),m=t.filter(d=>d>=a),b={perSkuMonth:new Map},C=y.length?De({state:s,months:y,products:o,snapshot:null,snapshotMonth:y[0]||void 0,projectionMode:f}):b,S=m.length?De({state:s,months:m,products:o,snapshot:null,snapshotMonth:We(a,-1),projectionMode:f}):b,M=Oe(s).bySku,D=gt({state:s,products:o,months:t,projection:S,projectionMode:f,nowMonth:a}),p=t.map(d=>{const Q=new Set,fe=new Set,he=new Set,ee=new Set,te=new Set,se=new Set,re=new Set;let V=0;const W=[],B=[];o.forEach(v=>{const g=L(v.sku);if(!g)return;const h=F(g),I=String(v.alias||g),N=we(M,g),pe=d<a?C:S,ae=pe.perSkuMonth.get(g)||pe.perSkuMonth.get(h),k=ae==null?void 0:ae.get(d),ve=Be(k,f),be=!!(k!=null&&k.hasForecast)&&!ve;if(!be){const Me=at(k,ve),Le=f==="doh"?Number.isFinite(Number(k==null?void 0:k.doh))?Number(k==null?void 0:k.doh):null:Number.isFinite(Number(k==null?void 0:k.endAvailable))?Number(k==null?void 0:k.endAvailable):null,ze=f==="doh"?Number.isFinite(Number(k==null?void 0:k.safetyDays))?Number(k==null?void 0:k.safetyDays):null:Number.isFinite(Number(k==null?void 0:k.safetyUnits))?Number(k==null?void 0:k.safetyUnits):null;W.push({sku:g,alias:I,abcClass:N,issueType:Me,issueLabel:ut(Me),value:Le,safetyValue:ze,projectionMode:f}),ee.add(h),Pe(N)?te.add(h):se.add(h),k!=null&&k.hasForecast?fe.add(g):Q.add(g)}const P=D.get(h)||null,Se=!!(P&&P.orderMonth<=d);P&&Se&&(B.push({sku:g,alias:I,abcClass:N,firstRiskMonth:P.firstRiskMonth,latestOrderDate:P.latestOrderDate,orderMonth:P.orderMonth,leadTimeDays:P.leadTimeDays,overdue:P.overdue,requiredArrivalDate:P.requiredArrivalDate,recommendedOrderDate:P.recommendedOrderDate,shortageUnits:P.shortageUnits,reason:"Keine FO/PO vorhanden, die die Lücke schließt."}),he.add(g),ee.add(h),Pe(N)?te.add(h):se.add(h),P.overdue&&re.add(h)),be&&!Se&&(V+=1)});const oe=n?V/n:0,q=ee.size,G=te.size,me=se.size,_e=B.length>0,je=re.size>0,H=ct({coverageRatio:oe,blockerCount:q,blockerAbCount:G,hasOrderDutyBlocker:_e,hasOverdueOrderDutyBlocker:je}),ne=Qe[H],ie=H==="full"||H==="wide",E=lt(s,d),_=l,j=ft(i,d),K=c.missingPrice.length===0&&c.blockedCompleteness.length===0,X=[],A=v=>{X.push({id:`${v.checkKey}:${v.month}:${X.length}`,...v})};if(!ie){n===0&&A({month:d,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"});const v=Re(W);v.slice(0,20).forEach(h=>{const I=h.issueType==="forecast_missing"?"/v2/forecast":"/v2/inventory/projektion",N=h.issueType==="forecast_missing"?"Forecast fehlt":h.issueType==="stock_oos"?"Out-of-Stock":"unter Safety";A({month:d,checkKey:"sku_coverage",severity:"error",message:`${h.sku} (${h.alias}): ${N} (${h.abcClass}).`,sku:h.sku,alias:h.alias,abcClass:h.abcClass,issueType:h.issueType,route:I})}),v.length>20&&A({month:d,checkKey:"sku_coverage",severity:"error",message:`+ ${v.length-20} weitere SKU(s) mit Bestandsproblemen.`,route:"/v2/inventory/projektion"});const g=Te(B);g.slice(0,20).forEach(h=>{const I=h.overdue?"überfällig":"fällig";A({month:d,checkKey:"sku_coverage",severity:"error",message:`${h.sku} (${h.alias}): Bestellpflicht ${I} bis ${h.latestOrderDate} (Risikomonat ${h.firstRiskMonth}).`,sku:h.sku,alias:h.alias,abcClass:h.abcClass,issueType:"order_duty",firstRiskMonth:h.firstRiskMonth,latestOrderDate:h.latestOrderDate,orderMonth:h.orderMonth,leadTimeDays:h.leadTimeDays,overdue:h.overdue,requiredArrivalDate:h.requiredArrivalDate,recommendedOrderDate:h.recommendedOrderDate,suggestedUnits:h.shortageUnits,route:"/v2/orders/fo"})}),g.length>20&&A({month:d,checkKey:"sku_coverage",severity:"error",message:`+ ${g.length-20} weitere SKU(s) mit Bestellpflicht.`,route:"/v2/orders/fo"})}E||A({month:d,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),_||A({month:d,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),j||A({month:d,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),K||(c.missingPrice.slice(0,20).forEach(g=>{A({month:d,checkKey:"revenue_inputs",severity:"error",message:`${g.sku} (${g.alias}): Ø VK-Preis fehlt.`,sku:g.sku,alias:g.alias,abcClass:g.abcClass,route:"/v2/products"})}),c.blockedCompleteness.filter(g=>!u.has(F(g.sku))).slice(0,20).forEach(g=>{A({month:d,checkKey:"revenue_inputs",severity:"error",message:`${g.sku} (${g.alias}): Stammdaten unvollständig.`,sku:g.sku,alias:g.alias,abcClass:g.abcClass,route:"/v2/products"})}));const ge=[{key:"sku_coverage",label:"Bestands- & Bestellpflicht-Coverage",status:ie?"ok":"error",passed:ie,detail:`${ne.label}: ${it(oe)} (${V}/${n}) · Blocker ${q} (A/B ${G}, C ${me}) · Bestand ${W.length} · Bestellpflicht ${B.length}`,blockerCount:q+(n===0?1:0),route:Q.size>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:E?"ok":"error",passed:E,detail:E?"vorhanden":"fehlend",blockerCount:E?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:_?"ok":"error",passed:_,detail:_?"vorhanden":"fehlend",blockerCount:_?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:j?"ok":"error",passed:j,detail:i.active?j?"vorhanden":"fehlend":"nicht aktiv",blockerCount:j?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:K?"ok":"error",passed:K,detail:K?"vollständig":`${c.missingPrice.length} ohne Preis · ${c.blockedCompleteness.length} unvollständig`,blockerCount:K?0:c.missingPrice.length+c.blockedCompleteness.length,route:"/v2/products"}],Ke=ge.every(v=>v.passed),ke=Re(W),ye=Te(B);return{month:d,robust:Ke,checks:ge,blockers:X,blockerCount:X.length,coverage:{statusKey:H,statusLabel:ne.label,statusDetail:ne.detail,projectionMode:f,activeSkus:n,coveredSkus:V,ratio:oe,blockerCount:q,blockerAbCount:G,blockerCCount:me,stockIssueCount:ke.length,orderDutyIssueCount:ye.length,overdueOrderDutySkuCount:re.size,missingForecastSkus:Array.from(Q).sort((v,g)=>v.localeCompare(g,"de-DE")),safetyRiskSkus:Array.from(fe).sort((v,g)=>v.localeCompare(g,"de-DE")),orderDutyRiskSkus:Array.from(he).sort((v,g)=>v.localeCompare(g,"de-DE")),stockIssues:ke,orderDutyIssues:ye,abRiskSkuCount:G}}}),T=new Map;p.forEach(d=>T.set(d.month,d));const z=p.filter(d=>d.robust).length;let de=null;for(let d=0;d<p.length&&p[d].robust;d+=1)de=p[d].month;const Ee=new Set([...c.missingPrice.map(d=>F(d.sku)),...c.blockedCompleteness.map(d=>F(d.sku))]).size;return{months:p,monthMap:T,actions:kt({months:p,hasFixcostBasis:l,vatActive:i.active,revenueIssueSkus:Ee}),robustUntilMonth:de,robustMonthsCount:z,totalMonths:p.length,activeSkuCount:n}}const pt="robustness_order_duty_v2";function J(e){return String(e||"").trim()}function ce(e){return J(e).toLowerCase()}function ue(e){const t=String(e||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const s=new Date(`${t}T00:00:00Z`);return Number.isNaN(s.getTime())?null:t}function vt(e){const t=Z(e);return t?`${t}-01`:null}function $(e,t=0){const s=Fe(e);return Number.isFinite(s)?Number(s):t}function R(e){const t=$(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function U(e){const t=$(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:t}function bt(e){return Number.isFinite(e)?Math.round(e*100)/100:0}function St(e){if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function w(e,t="PH"){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"")||t}function Mt(e){const t=w(e.sku,"SKU").slice(0,14),s=w(e.orderMonth,"OM"),r=w(e.firstRiskMonth,"RM");return`phantom-fo-${t}-${s}-${r}`}function Dt(e){const t=w(e.orderMonth,"000000").slice(0,6),s=w(e.sku,"SKU").slice(0,6),r=w(e.firstRiskMonth,"000000").slice(0,6);return`PH-${t}-${s}-${r}`}function Ct(e){const t=new Map;return e.forEach(s=>{const r=J(s.sku);if(!r)return;const o=ce(r);t.has(o)||t.set(o,s)}),t}function Pt(e,t){const s=yt({state:e,months:t}),r=new Map;return s.months.forEach(o=>{Ct(o.coverage.orderDutyIssues).forEach((l,i)=>{r.has(i)||r.set(i,l)})}),Array.from(r.values())}function le(e){const t=e!=null&&e.template&&typeof e.template=="object"?e.template:{};return(t.fields&&typeof t.fields=="object"?t.fields:t)||{}}function At(e){const t=le(e);return U(t.unitPriceUsd)??U(e==null?void 0:e.unitPriceUsd)??U(e==null?void 0:e.unitPrice)??0}function Rt(e){const t=le(e);return U(e==null?void 0:e.logisticsPerUnitEur)??U(e==null?void 0:e.freightPerUnitEur)??U(t.logisticsPerUnitEur)??U(t.freightEur)??0}function Tt(e){const t=e.product||{},s=e.settings||{},r=le(t),o=Ie({state:e.state,product:t||void 0,sku:String(t.sku||""),supplierId:e.supplierId||String(t.supplierId||""),orderContext:"fo"}),n=o.fields&&typeof o.fields=="object"?o.fields:{},l=S=>{const M=n[S];return!M||typeof M!="object"?null:M.value??null},i=String(l("transportMode")||r.transportMode||t.transportMode||"SEA").trim().toUpperCase(),c=i==="AIR"||i==="SEA"||i==="RAIL"?i:"SEA",u=l("ddp")===!0||String(t.incoterm||"").toUpperCase()==="DDP",a=u||c==="AIR",f=R(l("productionLeadTimeDays"))??R(t.productionLeadTimeDaysDefault)??R(r.productionDays)??R(s.defaultProductionLeadTimeDays)??(a?14:45),y=R(l("transitDays"))??R(r.transitDays)??R(t.transitDays)??(a?21:45),m=$(l("dutyRatePct"),$(s.dutyRatePct,0)),b=$(l("eustRatePct"),$(s.eustRatePct,0)),C=String(l("incoterm")||t.incoterm||(u?"DDP":"EXW")).trim().toUpperCase()||"EXW";return{productionDays:f,transitDays:y,totalDays:Math.max(1,f+y),transportMode:c,incoterm:C,dutyRatePct:Math.max(0,m),eustRatePct:Math.max(0,b)}}function Ut(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).map(s=>String(s||"").trim()))).filter(s=>/^\d{4}-\d{2}$/.test(s)).sort((s,r)=>s.localeCompare(r));return t.length?t:xt(e.state)}function Ft(e){return Ze([],e||void 0)}function Ue(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function It(e,t){const s=Number(t.overdue)-Number(e.overdue);if(s!==0)return s;const r=i=>i==="A"?0:i==="B"?1:2,o=r(e.abcClass)-r(t.abcClass);if(o!==0)return o;const n=e.orderMonth.localeCompare(t.orderMonth);if(n!==0)return n;const l=e.firstRiskMonth.localeCompare(t.firstRiskMonth);return l!==0?l:e.sku.localeCompare(t.sku,"de-DE")}function Nt(e,t){if(!e.length)return null;const s=Z(t);if(!s)return e[e.length-1];let r=null;return e.forEach(o=>{o<=s&&(r=o)}),r||e[0]}function Ot(e){const t=e.issue,s=J(t.sku);if(!s)return null;const r=ce(s),o=e.productBySkuKey.get(r)||null,n=String((o==null?void 0:o.supplierId)||"").trim(),l=e.supplierById.get(n)||null,i=Tt({state:e.state,product:o,supplierId:n,settings:e.settings}),c=ue(t.requiredArrivalDate)||vt(t.firstRiskMonth);if(!c)return null;const u=He({context:e.recommendationContext,sku:s,leadTimeDays:i.totalDays,product:o,settings:e.settings,horizonMonths:Math.max(6,Math.round(Number(e.horizonMonths)||6)),requiredArrivalMonth:t.firstRiskMonth}),a=Ue(u==null?void 0:u.recommendedUnits),f=Ue(t.shortageUnits),y=Math.max(a||0,f||0);if(!(y>0))return null;const m=Xe({targetDeliveryDate:c,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0}),b=At(o),C=Rt(o),S=bt(C*y),M=U(e.settings.fxRate)??0,D=Ye({supplierTerms:Ft(l),schedule:m,unitPrice:b,units:y,currency:"USD",freight:S,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:M,incoterm:i.incoterm,vatRefundLagMonths:e.settings.vatRefundLagMonths,paymentDueDefaults:e.settings.paymentDueDefaults,existingPayments:[]}),p=Mt(t),T=Dt(t);return{id:p,sku:s,alias:String(t.alias||(o==null?void 0:o.alias)||s),abcClass:t.abcClass,supplierId:n,orderMonth:String(t.orderMonth||"").trim(),firstRiskMonth:String(t.firstRiskMonth||"").trim(),latestOrderDate:ue(t.latestOrderDate)||m.orderDate||"",requiredArrivalDate:c,recommendedOrderDate:ue(t.recommendedOrderDate)||m.orderDate||"",leadTimeDays:i.totalDays,overdue:t.overdue===!0,suggestedUnits:y,shortageUnits:f??null,recommendationStatus:u?String(u.status||""):null,recommendationUnits:a??null,foRecord:{id:p,foNo:T,foNumber:T,sku:s,supplierId:n,targetDeliveryDate:c,units:y,transportMode:i.transportMode,incoterm:i.incoterm,unitPrice:b,currency:"USD",freight:S,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:M,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0,orderDate:m.orderDate||null,productionEndDate:m.productionEndDate||null,etdDate:m.etdDate||null,etaDate:m.etaDate||c,deliveryDate:m.deliveryDate||c,payments:D,status:"ACTIVE",phantom:!0,phantomSource:pt,phantomStatus:"suggested",phantomGeneratedAt:new Date().toISOString(),phantomMeta:{firstRiskMonth:t.firstRiskMonth,orderMonth:t.orderMonth,latestOrderDate:t.latestOrderDate,recommendedOrderDate:t.recommendedOrderDate,leadTimeDays:i.totalDays,abcClass:t.abcClass,shortageUnits:t.shortageUnits,reason:t.reason}}}}function xt(e,t=18){const s=e.settings&&typeof e.settings=="object"?e.settings:{},r=Z(s.startMonth)||Ne(),o=R(s.horizonMonths)??Math.max(6,Math.round(Number(t)||18));return qe(r,o)}function Vt(e){const t=e.state||{},s=Ut({state:t,months:e.months});if(!s.length)return[];const r=Nt(s,e.targetMonth);if(!r)return[];const o=(Array.isArray(t.products)?t.products:[]).map(m=>m).filter(m=>J(m.sku)).filter(St),n=new Map;o.forEach(m=>{n.set(ce(m.sku),m)});const l=new Map;(Array.isArray(t.suppliers)?t.suppliers:[]).map(m=>m).forEach(m=>{const b=String(m.id||"").trim();b&&l.set(b,m)});const i=t.settings&&typeof t.settings=="object"?t.settings:{},c=[],u=new Set;let a=t;const f=R(e.maxSuggestions),y=Math.max(1,s.length*2);for(let m=0;m<y;m+=1){const b=Ge(a),C=Pt(a,s).filter(D=>{const p=Z(D.orderMonth);return p?p<=r:!1});if(!C.length)break;const S=new Set((Array.isArray(a.fos)?a.fos:[]).map(D=>String((D==null?void 0:D.id)||"").trim()).filter(Boolean)),M=[];if(C.forEach(D=>{const p=Ot({state:a,issue:D,productBySkuKey:n,supplierById:l,settings:i,recommendationContext:b,horizonMonths:s.length});p&&(u.has(p.id)||S.has(p.id)||(u.add(p.id),M.push(p)))}),!M.length||(c.push(...M),f!=null&&c.length>=f))break;a=$t({state:a,suggestions:M})}return c.sort(It),f!=null?c.slice(0,f):c}function $t(e){const t=e.state||{},s=Array.isArray(t.fos)?t.fos:[],r=new Set(s.map(n=>String(n.id||"").trim()).filter(Boolean)),o=e.suggestions.map(n=>n.foRecord).filter(n=>{const l=String(n.id||"").trim();return l?!r.has(l):!1});return{...t,fos:[...s,...o]}}export{Vt as a,yt as b,$t as c,xt as r};
