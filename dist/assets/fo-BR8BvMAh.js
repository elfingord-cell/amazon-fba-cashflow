import{g as mt,e as Nt,u as xt,f as Ut,o as Mt,h as Ot,v as At}from"./index-DZx8ouWC.js";import{b as wt}from"./supplierLabels-BolgyxWX.js";import{b as Ft,p as It,D as $t}from"./prefill-BaEKHkHB.js";import{c as Bt}from"./costing-CmZrILJ2.js";import{e as Rt}from"./productCompleteness-CNODPsSo.js";import{l as gt,c as Ve}from"./store-CGIcF1vR.js";import{u as Vt}from"./useDraftForm-CNG_ojts.js";import{g as _t,b as zt,c as jt,f as Kt}from"./foSuggestion-Ck1952gl.js";import"./deepEqual-CGWqzo0t.js";function u(t,s=document){return s.querySelector(t)}function e(t,s={},a=[]){const c=document.createElement(t);for(const[m,D]of Object.entries(s))m==="class"?c.className=D:m==="dataset"?Object.entries(D).forEach(([y,E])=>c.dataset[y]=E):m.startsWith("on")&&typeof D=="function"?c.addEventListener(m.slice(2),D):D!=null&&c.setAttribute(m,D);for(const m of[].concat(a))m!=null&&c.append(m.nodeType?m:document.createTextNode(String(m)));return c}const Ht=["SEA","RAIL","AIR"],Wt=["EXW","DDP","FCA"],ve=["ORDER_DATE","PRODUCTION_END","ETD","ETA","DELIVERY"],Ke=["EUR","USD","CNY"],qt={DRAFT:"Draft",PLANNED:"Planned",CONVERTED:"Converted",CANCELLED:"Cancelled"};function yt(t,s="EUR"){const a=String(t||"").trim().toUpperCase();return Ke.includes(a)?a:s}function Xt(){return $t.map(t=>({...t}))}function Q(t){if(!t)return"—";const[s,a,c]=String(t).split("-").map(Number);if(!s||!a||!c)return"—";const m=new Date(Date.UTC(s,a-1,c));return Number.isNaN(m.getTime())?"—":m.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function V(t){return It(t)}function Yt(t){return V(t)}function Z(t){const s=V(t);return!Number.isFinite(s)||s<0?null:s}function ee(t){if(!t)return null;const[s,a,c]=String(t).split("-").map(Number);if(!s||!a||!c)return null;const m=new Date(Date.UTC(s,a-1,c));return Number.isNaN(m.getTime())?null:m}function q(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}function ie(t,s){const a=new Date(t.getTime());return a.setUTCDate(a.getUTCDate()+s),a}function Me(t,s){const a=new Date(t.getTime());return a.setUTCMonth(a.getUTCMonth()+s),a}function me(t,s){const a=Number(t||0);return Number.isFinite(a)?a.toLocaleString("de-DE",{style:"currency",currency:s||"EUR"}):"—"}function ne(t){const s=Number(t);return Number.isFinite(s)?s.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function pe(t){const s=Number(t);return Number.isFinite(s)?s.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2}):"—"}function Ne(t){const s=Number(t);return Number.isFinite(s)?Math.round(s).toLocaleString("de-DE",{maximumFractionDigits:0}):"—"}function Dt(t){return Number.isFinite(t)?Math.round(t*100)/100:null}function Qt(t){var D,y;const s=((D=t==null?void 0:t.forecast)==null?void 0:D.forecastManual)||{},a=((y=t==null?void 0:t.forecast)==null?void 0:y.forecastImport)||{},c={},m=E=>{const C=String(E||"").trim();if(!C)return;c[C]||(c[C]={});const M=s[C]||{},k=a[C]||{};new Set([...Object.keys(k),...Object.keys(M)]).forEach(_=>{var v;const f=V(M[_]);if(Number.isFinite(f)){c[C][_]=f;return}const R=V((v=k[_])==null?void 0:v.units);Number.isFinite(R)&&(c[C][_]=R)})};return Object.keys(a||{}).forEach(m),Object.keys(s||{}).forEach(m),c}function Zt(t){var c;const s={};return(((c=t==null?void 0:t.inventory)==null?void 0:c.snapshots)||[]).forEach(m=>{const D=m==null?void 0:m.month;D&&(m.items||[]).forEach(y=>{const E=String((y==null?void 0:y.sku)||"").trim();if(!E)return;s[E]||(s[E]={});const C=Number((y==null?void 0:y.amazonUnits)||0),M=Number((y==null?void 0:y.threePLUnits)||0);s[E][D]=C+M})}),s}function bt(t){const s=(t==null?void 0:t.arrivalDateDe)||(t==null?void 0:t.arrivalDate)||(t==null?void 0:t.etaDate)||(t==null?void 0:t.etaManual)||(t==null?void 0:t.eta);if(s)return ee(s);const a=ee(t==null?void 0:t.orderDate);if(!a)return null;const c=Number((t==null?void 0:t.prodDays)??(t==null?void 0:t.productionLeadTimeDays)??0),m=Number((t==null?void 0:t.transitDays)??(t==null?void 0:t.logisticsLeadTimeDays)??0);return ie(a,c+m)}function ht(t){return Array.isArray(t==null?void 0:t.items)&&t.items.length>0?t.items.map(s=>({sku:String((s==null?void 0:s.sku)||"").trim(),units:V(s==null?void 0:s.units)})):t!=null&&t.sku?[{sku:String(t.sku||"").trim(),units:V(t==null?void 0:t.units)}]:[]}function Jt(t){const s={};let a=0;const c=Kt.monthKey;return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(y=>{if(y!=null&&y.archived)return;const E=bt(y);if(!E){a+=1;return}const C=c(E);ht(y).forEach(M=>{if(!M.sku)return;const k=Number(M.units||0);!Number.isFinite(k)||k<=0||(s[M.sku]||(s[M.sku]={}),s[M.sku][C]=(s[M.sku][C]||0)+k)})}),(Array.isArray(t==null?void 0:t.fos)?t.fos:[]).forEach(y=>{const E=String((y==null?void 0:y.status)||"").toUpperCase();if(E==="CANCELLED"||E==="CONVERTED")return;const C=bt(y);if(!C){a+=1;return}const M=c(C);ht(y).forEach(k=>{if(!k.sku)return;const K=Number(k.units||0);!Number.isFinite(K)||K<=0||(s[k.sku]||(s[k.sku]={}),s[k.sku][M]=(s[k.sku][M]||0)+K)})}),{inboundBySku:s,inboundWithoutEtaCount:a}}function be(t,s,a){const c=Number(t||0);if(!Number.isFinite(c))return 0;if(!s||s==="EUR")return c;const m=Number(a||0);return!Number.isFinite(m)||m<=0?c:c/m}function Gt(t){return t?String(t).slice(-6).toUpperCase():"—"}function en(t=[]){if(!t.length)return"—";const s=t.slice(0,2).map(c=>`${c.percent||0}% ${Q(c.dueDate)}`).join(", "),a=t.length>2?` +${t.length-2}`:"";return`${t.length} payments: ${s}${a}`}function tn(t=[],s=0){return t.reduce((c,m)=>{const D=Number(m.amount||0);if(!Number.isFinite(D))return c;const y=m.currency||"EUR",E=be(D,y,s);return c+E},0)}function nn(t=[],s=0){return t.length?t.map(a=>{const c=Number(a.amount||0);if(!Number.isFinite(c))return null;const m=a.currency||"EUR",D=be(c,m,s);return`${a.label||"Payment"}: ${me(c,m)} (${me(D,"EUR")})`}).filter(Boolean).join(" | "):""}function sn(t){return t==="PRODUCTION_END"?"PROD_DONE":t||"ORDER_DATE"}function se(t,s){if(!s)return null;const a=String(s).trim().toLowerCase();return t.find(c=>String((c==null?void 0:c.sku)||"").trim().toLowerCase()===a)||null}function _e(t,s){if(!s)return null;const a=String(s).trim().toLowerCase();return t.find(c=>String((c==null?void 0:c.alias)||"").trim().toLowerCase()===a)||null}function rn(t,s){return(t||[]).filter(Boolean).map(a=>{const c=String(a.alias||"").trim(),m=String(a.sku||"").trim(),D=c||m,y=Rt(a,{state:s});return{sku:m,alias:D,label:D,completeness:y}}).sort((a,c)=>a.label.localeCompare(c.label))}function an(t){return t==="ok"?"✅ OK":t==="warn"?"⚠️ Warnung":"❌ Blockiert"}function vt(t){var a,c,m;const s=[];return(a=t==null?void 0:t.blockingMissing)!=null&&a.length&&s.push(`Fehlt (blockierend): ${t.blockingMissing.map(D=>D.label).join(", ")}`),(c=t==null?void 0:t.defaulted)!=null&&c.length&&s.push(`Defaults aktiv: ${t.defaulted.map(D=>D.label).join(", ")}`),(m=t==null?void 0:t.suggestedMissing)!=null&&m.length&&s.push(`Empfohlen: ${t.suggestedMissing.map(D=>D.label).join(", ")}`),s.join(" • ")}function on(t){var s;return((s=t==null?void 0:t.template)==null?void 0:s.fields)||(t==null?void 0:t.template)||{}}function Et(t,s){const a=Ft(s.sku,{mode:"FO",supplierId:s.supplierId,transportMode:s.transportMode,incoterm:s.incoterm},{state:t}),c=String(a.incoterm).toUpperCase()==="DDP"?"USD":"EUR";return{transportMode:a.transportMode,incoterm:a.incoterm,unitPrice:a.unitPrice,unitPriceSource:a.sources.unitPrice||null,currency:a.currency,freight:a.logisticsPerUnitEur,freightMissingFields:a.logisticsMissingFields||[],freightCurrency:c,dutyRatePct:a.dutyRatePct,eustRatePct:a.eustRatePct,fxRate:a.fxRate,fxRateSource:a.sources.fxRate,supplierId:a.supplierId,supplierSource:a.sources.supplier,productionLeadTimeDays:a.productionLeadTimeDays,productionLeadTimeSource:a.sources.productionLeadTimeDays,incotermSource:a.sources.incoterm,paymentTermsSource:a.sources.paymentTerms,preferredSupplier:!1,logisticsLeadTimeDays:a.logisticsLeadTimeDays,bufferDays:a.bufferDays}}function re(t){const s=ee(t.targetDeliveryDate),a=Z(t.productionLeadTimeDays),c=Number(t.logisticsLeadTimeDays||0),m=Number(t.bufferDays||0);if(!s||a==null||a===0)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null,deliveryDate:null};const D=ie(s,-(a+c+m)),y=ie(D,a),E=y,C=ie(E,c);return{orderDate:q(D),productionEndDate:q(y),etdDate:q(E),etaDate:q(C),deliveryDate:q(s),logisticsLeadTimeDays:c}}function De(t){const s=V(t.unitPrice)||0,a=Number(t.units||0),c=a*s,m=V(t.fxRate)||0,D=t.currency||"USD",y=be(c,D,m),E=V(t.freight)||0,C=E*a,M=t.freightCurrency||"EUR",k=be(C,M,m),K=V(t.dutyRatePct)||0,_=K>0?y*(K/100):0,f=V(t.eustRatePct)||0,R=f>0?(y+_+k)*(f/100):0,v=y+_+k+R;return{unitPrice:s,units:a,supplierCost:c,supplierCostEur:y,freightPerUnit:E,freightTotal:C,freightCurrency:M,freightEur:k,dutyRatePct:K,eustRatePct:f,fxRate:m,landedCostEur:v}}function un(t){return!t||!t.length?"":`Logistik nicht berechenbar – ${t.map(a=>a==="landedCostEur"?"Einstandspreis":a==="unitPriceUsd"?"Unit Price":a==="fxUsdPerEur"?"FX":a).join(", ")} fehlt`}function ze({product:t,units:s,unitPrice:a,currency:c,fxRate:m}){const D=[],y=V(t==null?void 0:t.landedUnitCostEur),E=String(c||"USD").toUpperCase(),C=on(t),M=V(C.unitPriceUsd??(t==null?void 0:t.unitPriceUsd)??(t==null?void 0:t.defaultUnitPrice)??(t==null?void 0:t.unitPrice)),k=E==="USD"?V(a)??M:M,K=V(C.extraPerUnitUsd??(t==null?void 0:t.extraPerUnitUsd))||0,_=V(m),f=Bt({unitPriceUsd:k!=null?k+K:k,landedCostEur:y,fxUsdPerEur:_});if(f.missingFields.length)return f.missingFields.forEach(P=>{P==="landedCostEur"&&D.push("Einstandspreis (EUR) fehlt (Produkt)"),P==="unitPriceUsd"&&D.push("Stückpreis USD fehlt (Produkt/FO)"),P==="fxUsdPerEur"&&D.push("FX (USD je EUR) fehlt (FO/Settings)")}),{total:null,perUnit:null,warning:!1,missing:!0,missingFields:D};const R=f.warning,v=f.value!=null?Dt(f.value):null,N=Number(s||0);return{total:v!=null&&N>0?Dt(v*N):null,perUnit:v,warning:R,missing:!1,missingFields:[]}}function xe(t,s,a,c){const m=ee(t);if(!m)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null};const D=ie(m,Number(s||0)+Number(a||0)),y=D,E=ie(y,Number(c||0));return{orderDate:q(m),productionEndDate:q(D),etdDate:q(y),etaDate:q(E),logisticsLeadTimeDays:Number(c||0)}}function Oe(t,s){const a={ORDER_DATE:t!=null&&t.orderDate?ee(t.orderDate):null,PRODUCTION_END:t!=null&&t.productionEndDate?ee(t.productionEndDate):null,ETD:t!=null&&t.etdDate?ee(t.etdDate):null,ETA:t!=null&&t.etaDate?ee(t.etaDate):null,DELIVERY:t!=null&&t.deliveryDate?ee(t.deliveryDate):s?ee(s):null};return!a.ETD&&a.ETA&&Number.isFinite(Number(t==null?void 0:t.logisticsLeadTimeDays))&&(a.ETD=ie(a.ETA,-Number(t.logisticsLeadTimeDays||0))),a}function Ae(t,s){const a=ve.includes(t)?t:"ORDER_DATE";return(s==null?void 0:s[a])||null}function cn(t,s){const a=Oe(s||{},s==null?void 0:s.deliveryDate);return t.map(c=>{const m=ve.includes(c.triggerEvent)?c.triggerEvent:"ORDER_DATE",D=Number(c.offsetDays||0),y=Number(c.offsetMonths||0),E=Ae(m,a);let C=c.dueDate;if(!(c.dueDateManuallySet===!0||!!c.paidDate||c.dueDate&&typeof c.dueDateManuallySet>"u")){let k=E?ie(E,D):null;k&&y&&(k=Me(k,y)),C=k?q(k):null}return{...c,triggerEvent:m,offsetDays:D,offsetMonths:y,dueDate:C}})}function Ue({supplier:t,baseValue:s,currency:a,schedule:c,freight:m,freightCurrency:D,dutyRatePct:y,eustRatePct:E,fxRate:C,supplierCostEur:M,incoterm:k}){const K=Array.isArray(t==null?void 0:t.paymentTermsDefault)&&t.paymentTermsDefault.length?t.paymentTermsDefault:Xt(),_=Oe(c||{},c==null?void 0:c.deliveryDate),f=K.map(x=>{const p=ve.includes(x.triggerEvent)?x.triggerEvent:"ORDER_DATE",O=Number(x.offsetDays||0),L=Number(x.offsetMonths||0),n=s*(Number(x.percent||0)/100),S=Ae(p,_);let z=S?q(ie(S,O)):null;return z&&L&&(z=q(Me(ee(z),L))),{id:`pay-${Math.random().toString(36).slice(2,9)}`,label:x.label||"Milestone",percent:Number(x.percent||0),amount:n,currency:a||"EUR",triggerEvent:p,offsetDays:O,offsetMonths:L,dueDate:z,isOverridden:!1,dueDateManuallySet:!1,category:"supplier"}}),R=[],v=String(k||"").toUpperCase(),N=Number(m||0);v!=="DDP"&&N>0&&R.push({id:`freight-${Math.random().toString(36).slice(2,9)}`,label:"Fracht",percent:0,amount:N,currency:D||"EUR",triggerEvent:"ETD",offsetDays:0,dueDate:_.ETD?q(_.ETD):null,isOverridden:!1,dueDateManuallySet:!1,category:"freight"});const h=Number(y||0);if(v!=="DDP"&&h>0){const x=M;R.push({id:`duty-${Math.random().toString(36).slice(2,9)}`,label:"Duty",percent:h,amount:x*(h/100),currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:_.ETA?q(_.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"duty"})}const P=Number(E||0);if(v!=="DDP"&&P>0){const x=be(N,D,C),p=h>0?M*(h/100):0,L=(M+p+x)*(P/100);R.push({id:`eust-${Math.random().toString(36).slice(2,9)}`,label:"EUSt",percent:P,amount:L,currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:_.ETA?q(_.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust"}),R.push({id:`eust-refund-${Math.random().toString(36).slice(2,9)}`,label:"EUSt Erstattung",percent:P,amount:-L,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:2,dueDate:_.ETA?q(Me(_.ETA,2)):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust_refund"})}return[...f,...R]}function Pt(t,s){const{baseValue:a,schedule:c,currency:m,freight:D,freightCurrency:y,dutyRatePct:E,eustRatePct:C,fxRate:M,supplierCostEur:k,incoterm:K}=s,_=Number(E||0),f=Number(C||0),R=Number(D||0),v=be(R,y,M),N=_>0?k*(_/100):0,h=k+N+v,P=String(K||"").toUpperCase(),x=Oe(c||{},c==null?void 0:c.deliveryDate);return t.map(p=>{const O=ve.includes(p.triggerEvent)?p.triggerEvent:"ORDER_DATE",L=Number(p.offsetDays||0),n=Number(p.offsetMonths||0);let S=Number(p.amount||0);p.category==="supplier"?S=a*(Number(p.percent||0)/100):p.category==="freight"?S=R:p.category==="duty"?S=P==="DDP"?0:N:p.category==="eust"?S=P==="DDP"?0:f>0?h*(f/100):0:p.category==="eust_refund"&&(S=f>0?h*(f/100):0,S=-S);let z=p.dueDate;if(!(p.dueDateManuallySet===!0||!!p.paidDate||p.dueDate&&typeof p.dueDateManuallySet>"u")){const g=Ae(O,x);let T=g?ie(g,L):null;T&&n&&(T=Me(T,n)),z=T?q(T):null}const U=p.category==="supplier"?m||"EUR":p.category==="freight"&&y||"EUR";return{...p,triggerEvent:O,offsetDays:L,amount:S,currency:U,dueDate:z}})}function Ce(t,s){return String(s||"").toUpperCase()!=="DDP"?t:t.filter(c=>c.category!=="freight")}function je(t,s,a=[],c){const m=e("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),D=e("div",{class:"po-modal fo-modal-frame"},[e("header",{class:"po-modal-header"},[e("h3",{},[t]),e("button",{class:"btn ghost",type:"button",onclick:()=>{if(typeof c=="function"){c();return}m.remove()},"aria-label":"Schließen"},["✕"])]),e("div",{class:"po-modal-body"},[s]),e("footer",{class:"po-modal-actions"},a)]);m.append(D),document.body.append(m);let y=!1;return m.addEventListener("mousedown",E=>{y=E.target===m}),m.addEventListener("mouseup",E=>{y&&E.target===m&&(typeof c=="function"?c():m.remove()),y=!1}),m}function ln(t,s,a){const c=new Date().toISOString(),m=t.productionLeadTimeDaysManual!=null?Number(t.productionLeadTimeDaysManual):null,D=Z(t.productionLeadTimeDays);return{id:t.id,sku:t.sku,supplierId:t.supplierId,targetDeliveryDate:t.targetDeliveryDate,units:Number(t.units||0),transportMode:t.transportMode,incoterm:t.incoterm,unitPrice:V(t.unitPrice)||0,unitPriceIsOverridden:!!t.unitPriceIsOverridden,currency:yt(t.currency,"EUR"),freight:V(t.freight)||0,freightCurrency:yt(t.freightCurrency,"EUR"),dutyRatePct:V(t.dutyRatePct)||0,eustRatePct:V(t.eustRatePct)||0,fxRate:V(t.fxRate)||0,productionLeadTimeDays:Number.isFinite(D)?D:null,productionLeadTimeDaysManual:Number.isFinite(m)?m:null,productionLeadTimeSource:t.productionLeadTimeSource||null,logisticsLeadTimeDays:Number(t.logisticsLeadTimeDays||0),bufferDays:Number(t.bufferDays||0),orderDate:s.orderDate,productionEndDate:s.productionEndDate,etdDate:s.etdDate,etaDate:s.etaDate,deliveryDate:s.deliveryDate,payments:a,status:t.status||"DRAFT",convertedPoId:t.convertedPoId||null,convertedPoNo:t.convertedPoNo||null,createdAt:t.createdAt||c,updatedAt:c}}function vn(t){const s=gt();Array.isArray(s.fos)||(s.fos=[]),Array.isArray(s.suppliers)||(s.suppliers=[]);const a=mt(),c=wt(s,a);t.innerHTML=`
    <section class="card">
      <h2>Forecast Orders (FO)</h2>
      <div class="table-card-header">
        <span class="muted">Planung neuer Bestände</span>
        <div class="fo-toolbar">
          <input type="text" id="fo-search" placeholder="Alias oder SKU suchen" />
          <select id="fo-status-filter">
            <option value="ALL">Status: Alle</option>
            <option value="DRAFT">Draft</option>
            <option value="PLANNED">Planned</option>
            <option value="CONVERTED">Converted</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
          <button class="btn primary" id="fo-add">Create FO</button>
        </div>
      </div>
      <div id="fo-table"></div>
    </section>
  `;const m=u("#fo-table",t),D=u("#fo-search",t),y=u("#fo-status-filter",t);function E(f,R,v){const N=`po-${Math.random().toString(36).slice(2,9)}`,h=String(R||"").trim(),P=V(f.fxRate)||0,x=be(V(f.freight)||0,f.freightCurrency,P),p=(f.payments||[]).filter(S=>S.category==="supplier").map(S=>({id:S.id||`ms-${Math.random().toString(36).slice(2,9)}`,label:S.label||"Milestone",percent:Number(S.percent||0),anchor:sn(S.triggerEvent),lagDays:Number(S.offsetDays||0)})),O=Number(f.productionLeadTimeDays||0)+Number(f.bufferDays||0),L=Number(f.logisticsLeadTimeDays||0),n=xe(v,O,0,L);return{id:N,poNo:h,sku:f.sku,supplierId:f.supplierId,units:Number(f.units||0),unitCostUsd:ne(f.unitPrice||0),unitExtraUsd:"0,00",extraFlatUsd:"0,00",orderDate:n.orderDate||f.orderDate||null,prodDays:O,transitDays:L,transport:f.transportMode||"SEA",freightEur:ne(x),dutyRatePct:pe(f.dutyRatePct||0),eustRatePct:pe(f.eustRatePct||0),fxOverride:ne(P||0),ddp:String(f.incoterm||"").toUpperCase()==="DDP",milestones:p,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}function C(){var P,x;const f=(((P=u("#fo-search",t))==null?void 0:P.value)||"").trim().toLowerCase(),R=((x=u("#fo-status-filter",t))==null?void 0:x.value)||"ALL",v=s.fos.slice().filter(p=>{if(R!=="ALL"&&String(p.status||"DRAFT").toUpperCase()!==R)return!1;if(!f)return!0;const O=se(a,p.sku),L=String((O==null?void 0:O.alias)||"").toLowerCase(),n=String(p.sku||"").toLowerCase();return L.includes(f)||n.includes(f)}).sort((p,O)=>(p.targetDeliveryDate||"").localeCompare(O.targetDeliveryDate||""));if(!v.length){m.innerHTML='<p class="muted">Keine Forecast Orders vorhanden.</p>';return}const N=v.map(p=>{var ae;const O=s.suppliers.find($=>$.id===p.supplierId),L=se(a,p.sku),n=re(p),S=De(p),z=ze({product:L,units:Number(p.units||0),unitPrice:p.unitPrice,currency:p.currency,fxRate:p.fxRate||((ae=s.settings)==null?void 0:ae.fxRate)}),F=en(p.payments),U=tn(p.payments,p.fxRate),g=nn(p.payments,p.fxRate),T=String(p.status||"DRAFT").toUpperCase();return{fo:p,supplierLabel:O&&(c.get(O.id)||O.name)||"—",alias:(L==null?void 0:L.alias)||p.sku||"—",skuLabel:p.sku||"—",schedule:n,costValues:S,freightEstimate:z,paymentsSummary:F,paymentsTotal:U,paymentsTooltip:g,status:T,statusLabel:qt[T]||T,statusClass:`badge${T==="CONVERTED"?" muted":""}`}}),h=[{key:"id",label:"FO ID"},{key:"product",label:"Produkt"},{key:"supplier",label:"Supplier"},{key:"units",label:"Units",className:"num"},{key:"target",label:"Target Delivery"},{key:"order",label:"Order Date"},{key:"timeline",label:"ETD / ETA"},{key:"total",label:"Total Value (EUR)",className:"num"},{key:"freight",label:"Shipping total (EUR)",className:"num"},{key:"payments",label:"Payments"},{key:"status",label:"Status"},{key:"actions",label:"Actions"}];m.innerHTML="",m.append(Nt({columns:h,rows:N,rowKey:p=>p.fo.id,stickyColumns:1,rowAttrs:p=>({dataset:{id:p.fo.id}}),renderCell:(p,O)=>{var n,S;const{fo:L}=p;switch(O.key){case"id":return Gt(L.id);case"product":return e("div",{class:"fo-product-cell"},[e("strong",{},[p.alias]),e("small",{class:"muted"},[p.skuLabel])]);case"supplier":return e("button",{class:"btn secondary sm",type:"button",dataset:{action:"supplier"}},[p.supplierLabel]);case"units":return Number(L.units||0).toLocaleString("de-DE");case"target":return Q(L.targetDeliveryDate);case"order":return Q(L.orderDate);case"timeline":return e("div",{class:"fo-date-stack"},[e("span",{},[`ETD ${Q(L.etdDate||p.schedule.etdDate)}`]),e("span",{class:"muted"},[`ETA ${Q(L.etaDate||p.schedule.etaDate)}`])]);case"total":return me(p.costValues.landedCostEur,"EUR");case"freight":{const z=(n=p.freightEstimate)==null?void 0:n.total,F=((S=p.freightEstimate)==null?void 0:S.missingFields)||[],U=F.length?`Fehlend: ${F.join(", ")}`:"";return e("span",{title:U},[z==null?"—":me(z,"EUR")])}case"payments":return e("div",{title:p.paymentsTooltip},[p.paymentsSummary,e("br"),e("span",{class:"muted"},[me(p.paymentsTotal,"EUR")])]);case"status":return e("span",{class:p.statusClass},[p.statusLabel]);case"actions":return e("div",{class:"table-actions ui-table-actions-nowrap"},[e("button",{class:"btn sm",type:"button",dataset:{action:"edit"}},["View/Edit"]),e("button",{class:"btn secondary sm",type:"button",dataset:{action:"convert"},disabled:p.status==="CONVERTED"?"true":null},["Convert to PO"]),e("button",{class:"btn danger sm",type:"button",dataset:{action:"delete"}},["Delete"])]);default:return"—"}}}))}D&&D.addEventListener("input",C),y&&y.addEventListener("change",C);function M(f,R=[],v){const N=e("div",{class:"fo-info-list"},R.map(p=>e("p",{class:"muted"},[p]))),h=e("button",{class:"btn",type:"button"},["Schließen"]),P=e("button",{class:"btn primary",type:"button",onclick:()=>{x.remove(),location.hash="#suppliers"}},["Zu Suppliers"]),x=je(f,N,P?[h,P]:[h]);h.addEventListener("click",()=>x.remove())}function k(f){const R=(s.pos||[]).map(U=>String(U.poNo||"").trim()).filter(Boolean);let N=re(f).orderDate||f.orderDate||"",h=xe(N,f.productionLeadTimeDays||0,f.bufferDays||0,f.logisticsLeadTimeDays||0);const P=e("div",{class:"fo-convert-modal"},[e("label",{},["PO Number (Ventory One)",e("input",{type:"text",id:"fo-po-number",placeholder:"e.g. 250029",maxlength:"30"}),e("small",{class:"muted"},["Must match Ventory One PO number"]),e("small",{class:"form-error",id:"fo-po-error"},[])]),e("label",{style:"margin-top:10px"},["Order Date (PO)",e("input",{type:"date",id:"fo-po-order-date",value:N}),e("div",{class:"fo-convert-actions"},[e("button",{class:"btn secondary",type:"button",id:"fo-po-today"},["Today"])]),e("small",{class:"muted"},["Default is calculated from FO backward scheduling."])]),e("div",{class:"fo-convert-preview"},[e("p",{class:"muted"},["This will update PO dates:"]),e("div",{class:"fo-date-stack"},[e("span",{id:"fo-preview-production-convert"},["Production End: —"]),e("span",{id:"fo-preview-etd-convert"},["ETD: —"]),e("span",{id:"fo-preview-eta-convert"},["ETA: —"])])])]),x=e("button",{class:"btn primary",type:"button",disabled:"true"},["Convert"]),p=e("button",{class:"btn",type:"button"},["Cancel"]),O=je("Convert FO to PO",P,[p,x]),L=u("#fo-po-number",P),n=u("#fo-po-order-date",P),S=u("#fo-po-error",P);function z(){h=xe(N,f.productionLeadTimeDays||0,f.bufferDays||0,f.logisticsLeadTimeDays||0),u("#fo-preview-production-convert",P).textContent=`Production End: ${Q(h.productionEndDate)}`,u("#fo-preview-etd-convert",P).textContent=`ETD: ${Q(h.etdDate)}`,u("#fo-preview-eta-convert",P).textContent=`ETA: ${Q(h.etaDate)}`}function F(){const U=L.value.trim();let g="";return U||(g="PO number is required."),U.length>30&&(g="Max length is 30."),R.includes(U)&&(g="PO number already exists."),N||(g=g||"Order date is required."),S.textContent=g,x.disabled=!!g,!g}u("#fo-po-today",P).addEventListener("click",()=>{const U=new Date;N=q(new Date(Date.UTC(U.getFullYear(),U.getMonth(),U.getDate()))),n.value=N,z()}),L.addEventListener("input",F),n.addEventListener("input",U=>{N=U.target.value,z()}),p.addEventListener("click",()=>O.remove()),z(),F(),x.addEventListener("click",()=>{if(!F())return;const U=xe(N,f.productionLeadTimeDays||0,f.bufferDays||0,f.logisticsLeadTimeDays||0);f.orderDate=U.orderDate,f.productionEndDate=U.productionEndDate,f.etdDate=U.etdDate,f.etaDate=U.etaDate,f.payments=cn(f.payments||[],U);const g=E(f,L.value,U.orderDate);Array.isArray(s.pos)||(s.pos=[]),s.pos.push(g),f.status="CONVERTED",f.convertedPoId=g.id,f.convertedPoNo=g.poNo,f.updatedAt=new Date().toISOString(),Ve(s,{source:"fo:convert",entityKey:`fo:${f.id}`,action:"update"}),C(),O.remove(),window.confirm("PO created. Open PO?")&&(location.hash="#po")})}function K(f,R={}){var nt,st,rt,it,at,ot,ut,ct,lt;const v=mt(),N=rn(v,s),h=!!f,P=String((f==null?void 0:f.status)||"").toUpperCase()==="CONVERTED",x=Qt(s),p=Zt(s),O=Jt(s),L={anchorMonth:(R==null?void 0:R.anchorMonth)||""};let n=f?JSON.parse(JSON.stringify(f)):{id:`fo-${Math.random().toString(36).slice(2,9)}`,sku:"",supplierId:"",targetDeliveryDate:"",units:"",transportMode:"SEA",incoterm:"EXW",unitPrice:"",unitPriceIsOverridden:!1,currency:((nt=s.settings)==null?void 0:nt.defaultCurrency)||"EUR",freight:"",freightCurrency:"EUR",dutyRatePct:((st=s.settings)==null?void 0:st.dutyRatePct)??0,eustRatePct:((rt=s.settings)==null?void 0:rt.eustRatePct)??0,fxRate:((it=s.settings)==null?void 0:it.fxRate)??"",productionLeadTimeDays:"",productionLeadTimeDaysManual:null,productionLeadTimeSource:null,logisticsLeadTimeDays:"",bufferDays:((at=s.settings)==null?void 0:at.defaultBufferDays)??0,payments:[],status:"DRAFT",createdAt:new Date().toISOString()};if(!h&&R){const r=String(R.sku||"").trim(),i=String(R.alias||"").trim(),o=se(v,r)||_e(v,i)||_e(v,r);o!=null&&o.sku?n.sku=o.sku:r&&(n.sku=r),R.targetDeliveryDate&&(n.targetDeliveryDate=R.targetDeliveryDate)}n.freightCurrency||(n.freightCurrency="EUR"),n.freight==null&&(n.freight=""),n.dutyRatePct==null&&(n.dutyRatePct=((ot=s.settings)==null?void 0:ot.dutyRatePct)??0),n.eustRatePct==null&&(n.eustRatePct=((ut=s.settings)==null?void 0:ut.eustRatePct)??0),n.fxRate==null&&(n.fxRate=((ct=s.settings)==null?void 0:ct.fxRate)??""),n.currency||(n.currency="USD"),typeof n.productionLeadTimeDaysManual>"u"&&(n.productionLeadTimeDaysManual=null),n.productionLeadTimeSource||(n.productionLeadTimeSource=null),Array.isArray(n.payments)&&(n.payments=n.payments.map(r=>({...r,category:r.category||"supplier"})));const S=Vt(n,{key:`fo:${n.id||"new"}`,enableDraftCache:!1});n=S.draft;const z=xt(()=>S.isDirty,"Ungespeicherte Änderungen verwerfen?");z.register(),z.attachBeforeUnload();const F={transportMode:h,incoterm:h,currency:h,freightCurrency:h,freight:h,dutyRatePct:h,eustRatePct:h,fxRate:h,productionLeadTimeDays:h,logisticsLeadTimeDays:h,bufferDays:h};n.productionLeadTimeDaysManual!=null&&(F.productionLeadTimeDays=!0),typeof n.unitPriceIsOverridden!="boolean"&&(n.unitPriceIsOverridden=h);let U=h&&Array.isArray(n.payments)&&n.payments.length>0,g=Et(s,n);function T(r,i){n[r]=i,F[r]=!1,r==="productionLeadTimeDays"&&(n.productionLeadTimeDaysManual=null,n.productionLeadTimeSource=g.productionLeadTimeSource||null);const o=u(`#fo-${r}`,d);if(o){const l=i==null?"":["unitPrice","freight","fxRate"].includes(r)?ne(i):["dutyRatePct","eustRatePct"].includes(r)?pe(i):i;o.value=l}}function ae(){const r=n.supplierId;if(g=Et(s,n),!n.supplierId&&g.supplierId){n.supplierId=g.supplierId;const i=u("#fo-supplierId",d);i&&(i.value=g.supplierId)}if(F.transportMode||T("transportMode",g.transportMode),F.incoterm||T("incoterm",g.incoterm),n.unitPriceIsOverridden||T("unitPrice",g.unitPrice??""),F.currency||T("currency",g.currency||"USD"),F.freight||T("freight",g.freight??""),F.freightCurrency||T("freightCurrency",g.freightCurrency||"EUR"),F.dutyRatePct||T("dutyRatePct",g.dutyRatePct??""),F.eustRatePct||T("eustRatePct",g.eustRatePct??""),F.fxRate||T("fxRate",g.fxRate??""),F.productionLeadTimeDays||T("productionLeadTimeDays",g.productionLeadTimeDays),F.logisticsLeadTimeDays||T("logisticsLeadTimeDays",g.logisticsLeadTimeDays),F.bufferDays||T("bufferDays",g.bufferDays),$(),qe(),He(),We(),!U&&n.supplierId&&n.supplierId!==r){const i=re(n),o=ge(),l=s.suppliers.find(B=>B.id===n.supplierId)||null,b=De(n);String(n.incoterm||"").toUpperCase()==="DDP"&&(b.dutyRatePct=0,b.eustRatePct=0),n.payments=Ue({supplier:l,baseValue:o,currency:n.currency,schedule:i,freight:b.freightTotal,freightCurrency:b.freightCurrency,dutyRatePct:b.dutyRatePct,eustRatePct:b.eustRatePct,fxRate:b.fxRate,supplierCostEur:b.supplierCostEur,incoterm:n.incoterm}),n.payments=Ce(n.payments,n.incoterm)}}function $(){var l;if(u("#suggested-transport",d).textContent=`Suggested: ${g.transportMode}`,u("#suggested-incoterm",d).textContent=`Suggested: ${g.incoterm}`,g.unitPrice!=null){const b=g.unitPriceSource?` (Quelle: ${g.unitPriceSource})`:"";u("#suggested-unitPrice",d).textContent=`Suggested: ${ne(g.unitPrice)}${b}`}else u("#suggested-unitPrice",d).textContent="Suggested: —";u("#suggested-currency",d).textContent=`Suggested: ${g.currency||"USD"}`,u("#suggested-freight",d).textContent=`Suggested: ${g.freight!=null?ne(g.freight):"—"}`;const r=u("#fo-freight-warning",d);r&&(r.textContent=(l=g.freightMissingFields)!=null&&l.length?un(g.freightMissingFields):""),u("#suggested-freightCurrency",d).textContent=`Suggested: ${g.freightCurrency||"EUR"}`,u("#suggested-dutyRatePct",d).textContent=`Suggested: ${g.dutyRatePct!=null?pe(g.dutyRatePct):"—"} %`,u("#suggested-eustRatePct",d).textContent=`Suggested: ${g.eustRatePct!=null?pe(g.eustRatePct):"—"} %`,u("#suggested-fxRate",d).textContent=`Suggested: ${g.fxRate!=null?ne(g.fxRate):"—"}`;const i=g.productionLeadTimeDays!=null?g.productionLeadTimeDays:"—",o=g.productionLeadTimeSource?` (Quelle: ${g.productionLeadTimeSource})`:"";u("#suggested-productionLeadTimeDays",d).textContent=`Vorschlag: ${i}${o}`,u("#suggested-logisticsLeadTimeDays",d).textContent=`Suggested: ${g.logisticsLeadTimeDays}`,u("#suggested-bufferDays",d).textContent=`Suggested: ${g.bufferDays}`,St()}function St(){var H,w;const r=u(".fo-suggestion-list",d);if(!r)return;r.innerHTML="";const i=n.supplierId&&n.supplierId!==g.supplierId?"Manual override":g.supplierSource||"—",o=n.unitPriceIsOverridden?"Manual override":g.unitPriceSource||"—",l=F.productionLeadTimeDays?"Manual override":g.productionLeadTimeSource||"missing",b=F.incoterm?"Manual override":g.incotermSource||"—",B=Array.isArray(n.payments)&&n.payments.length&&g.paymentTermsSource||"—",X=F.fxRate?"Manual override":g.fxRateSource||"—",j=se(v,n.sku),Y=ze({product:j,units:Number(n.units||0),unitPrice:n.unitPrice,currency:n.currency,fxRate:n.fxRate||((H=s.settings)==null?void 0:H.fxRate)}),J=(w=Y==null?void 0:Y.missingFields)!=null&&w.length?` Fehlend: ${Y.missingFields.join(", ")}`:"";r.append(e("li",{},[`Supplier source: ${i}`]),e("li",{},[`Price source: ${o}`]),e("li",{},[`Production lead time source: ${l}`]),e("li",{},[`Incoterm source: ${b}`]),e("li",{},[`Payment terms source: ${B}`]),e("li",{},[`FX source: ${X}`]),e("li",{},[`Logistikquelle: Einstandspreis (Produkt) + FX (Settings) + Stückpreis USD (Produkt/FO).${J}`]))}function He(){var l;const r=u("#fo-warning-info",d),i=u(".fo-warning-list",d);if(!r||!i)return;i.innerHTML="";const o=se(v,n.sku);if(n.sku&&!n.supplierId&&!(o!=null&&o.supplierId)&&i.append(e("li",{},["Supplier fehlt in Produktdaten."])),o){const b=((l=o.template)==null?void 0:l.fields)||{},B=o.freight!=null||o.freightAir!=null||o.freightSea!=null||o.freightRail!=null||b.freightEur!=null,X=o.dutyRatePct!=null||b.dutyPct!=null,j=o.eustRatePct!=null||b.vatImportPct!=null;(!B||!X||!j)&&i.append(e("li",{},["Produktkosten fehlen (Logistik/Zoll/EUSt)."," ",e("button",{class:"btn ghost fo-fix-now",type:"button",dataset:{sku:o.sku,tab:"produkte"}},["Fix now"])]))}r.style.display=i.childElementCount?"block":"none"}function We(){var Re,Se,ue,ke,dt,ft,pt;const r=u("#fo-recommendation",d),i=u("#fo-recommendation-summary",d),o=u("#fo-recommendation-details",d),l=u("#fo-recommendation-baseline",d),b=u("#fo-recommendation-critical",d),B=u("#fo-recommendation-arrival",d),X=u("#fo-recommendation-order",d),j=u("#fo-recommendation-units",d),Y=u("#fo-recommendation-issues",d),J=u("#fo-recommendation-notes",d);if(!r||!i||!o||!l||!b||!B||!X||!j||!Y||!J)return;Y.innerHTML="",J.textContent="";const H=String(n.sku||"").trim();if(!H){i.textContent="SKU auswählen, um Empfehlung zu sehen.",o.style.display="none";return}const w=_t(((Re=s==null?void 0:s.inventory)==null?void 0:Re.snapshots)||[]);if(!w){i.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",o.style.display="none";return}const I=se(v,H),oe=Number((I==null?void 0:I.safetyStockDohOverride)??((Se=s.settings)==null?void 0:Se.safetyStockDohDefault)??60),G=Number((I==null?void 0:I.foCoverageDohOverride)??((ue=s.settings)==null?void 0:ue.foCoverageDohDefault)??90),Pe=Number(n.productionLeadTimeDays||0)+Number(n.logisticsLeadTimeDays||0)+Number(n.bufferDays||0),de=((ke=p==null?void 0:p[H])==null?void 0:ke[w])??0,fe=zt({sku:H,baselineMonth:w,stock0:de,forecastByMonth:(x==null?void 0:x[H])||{},inboundByMonth:((dt=O.inboundBySku)==null?void 0:dt[H])||{},horizonMonths:12}),W=jt({sku:H,baselineMonth:w,projection:fe,safetyStockDays:oe,coverageDays:G,leadTimeDays:Pe,cnyPeriod:(ft=s==null?void 0:s.settings)==null?void 0:ft.cny,inboundWithoutEtaCount:O.inboundWithoutEtaCount,moqUnits:Number((I==null?void 0:I.moqOverrideUnits)??(I==null?void 0:I.moqUnits)??((pt=s.settings)==null?void 0:pt.moqDefaultUnits)??0)});if(l.textContent=`Closing Snapshot ${w}`,o.style.display="flex",W.status==="no_fo_needed")i.textContent="Keine FO innerhalb des Horizons erforderlich.",b.textContent="—",B.textContent="—",X.textContent="—",j.textContent="—";else if(W.status==="ok"){i.textContent="Empfehlung basierend auf dem letzten Closing Snapshot.",b.textContent=W.criticalMonth||"—",B.textContent=W.requiredArrivalDate?Q(W.requiredArrivalDate):"—",X.textContent=W.orderDateAdjusted?Q(W.orderDateAdjusted):"—",j.textContent=`SKU ${H}: ${Ne(W.recommendedUnits)}`;const ce=[];W.overlapDays>0&&ce.push(`CNY berücksichtigt: +${W.overlapDays} Tage`),ce.push(`Safety DOH: ${Ne(W.safetyStockDays)} · Coverage DOH: ${Ne(W.coverageDays)}`),W.moqApplied&&ce.push(`MOQ berücksichtigt: ${Ne(W.moqUnits)} Einheiten`),J.textContent=ce.join(" • ")}else i.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",o.style.display="none";(W.issues||[]).forEach(ce=>{const kt=ce.count?`${ce.code} (${ce.count})`:ce.code;Y.append(e("span",{class:"badge fo-recommendation-badge"},[kt]))})}function qe(){const r=String(n.incoterm||"").toUpperCase()==="DDP",i=u("#fo-dutyRatePct",d),o=u("#fo-eustRatePct",d),l=u("#fo-freightCurrency",d);r&&(n.dutyRatePct=0,n.eustRatePct=0,n.freightCurrency="USD",i&&(i.value=pe(0)),o&&(o.value=pe(0)),l&&(l.value="USD")),i&&(i.disabled=r),o&&(o.disabled=r),l&&(l.disabled=r)}function we(){const r=String(n.sku||"").trim(),i=v.some(b=>String(b.sku||"").trim().toLowerCase()===r.toLowerCase()),o=u("#fo-product-banner",d);r&&!i?o.style.display="block":o.style.display="none";const l=u("#fo-sku-display",d);l&&(l.textContent=r?`SKU: ${r}`:"SKU: —")}function le(){const r=re(n),i=ge(),o=De(n);String(n.incoterm||"").toUpperCase()==="DDP"&&(o.dutyRatePct=0,o.eustRatePct=0),n.payments=Pt(n.payments,{baseValue:i,schedule:r,currency:n.currency,freight:o.freight,freightCurrency:o.freightCurrency,dutyRatePct:o.dutyRatePct,eustRatePct:o.eustRatePct,fxRate:o.fxRate,supplierCostEur:o.supplierCostEur,incoterm:n.incoterm}),n.payments=Ce(n.payments,n.incoterm),Je(),Ye(),Xe(r),Ze(o),Qe(),et()}function Xe(r){u("#fo-preview-order",d).textContent=Q(r.orderDate),u("#fo-preview-production",d).textContent=Q(r.productionEndDate),u("#fo-preview-etd",d).textContent=Q(r.etdDate),u("#fo-preview-eta",d).textContent=Q(r.etaDate),u("#fo-preview-target",d).textContent=Q(n.targetDeliveryDate);const i=u("#fo-user-anchor",d);i&&(L.anchorMonth?(i.textContent=`User-Anker: ETA-Monat ${L.anchorMonth}`,i.style.display="block"):(i.textContent="",i.style.display="none"));const o=[];n.targetDeliveryDate||o.push("Zieltermin"),(!Number.isFinite(Number(n.productionLeadTimeDays))||Number(n.productionLeadTimeDays)<=0)&&o.push("Produktionszeit"),(!Number.isFinite(Number(n.logisticsLeadTimeDays))||Number(n.logisticsLeadTimeDays)<=0)&&o.push("Frachtlaufzeit");const l=u("#fo-schedule-missing",d),b=u("#fo-schedule-missing-list",d);l&&b&&(b.innerHTML="",o.forEach(Y=>b.append(e("li",{},[Y]))),l.style.display=o.length?"block":"none");const B=ee(r.etaDate),X=ee(n.targetDeliveryDate),j=u("#fo-date-warning",d);B&&X&&B>X?(j.textContent="Warnung: ETA liegt nach dem Zieltermin.",j.style.display="block"):(j.textContent="",j.style.display="none")}function Ye(){const r=n.payments.filter(o=>o.category==="supplier").reduce((o,l)=>o+(Number(l.percent)||0),0),i=u("#fo-payment-total",d);Math.round(r)===100?(i.textContent="Summe: 100%",i.style.color="#0f9960"):(i.textContent=`Summe: ${r.toFixed(2)}% (muss 100% sein)`,i.style.color="#c23636")}function Qe(){const r=u("#fo-ddp-note",d);if(!r)return;const i=String(n.incoterm||"").toUpperCase()==="DDP";r.style.display=i?"block":"none"}function Ze(r){var b;const i=se(v,n.sku),o=ze({product:i,units:Number(n.units||0),unitPrice:n.unitPrice,currency:n.currency,fxRate:n.fxRate||((b=s.settings)==null?void 0:b.fxRate)});u("#fo-supplier-cost",d).textContent=me(r.supplierCost,n.currency||"USD"),u("#fo-landed-cost",d).textContent=me(r.landedCostEur,"EUR"),u("#fo-shipping-estimate",d).textContent=me(r.freightTotal,"EUR");const l=u("#fo-shipping-note",d);l&&(o.missing?l.textContent=`Fehlend: ${o.missingFields.join(", ")}`:o.warning?l.textContent="Hinweis: Einstandspreis liegt unter Warenwert.":l.textContent="")}function ge(){return Number(n.units||0)*(V(n.unitPrice)||0)}function Ct(){const i=n.payments.filter(o=>o.category==="supplier").reduce((o,l)=>o+(Number(l.percent)||0),0);i&&(n.payments=n.payments.map(o=>o.category!=="supplier"?o:{...o,percent:Math.round((Number(o.percent)||0)/i*1e4)/100,isOverridden:!0}),le())}function Je(){const r=u("#fo-payments-body",d);r.innerHTML="";const i=Oe(re(n),n.targetDeliveryDate),o={ORDER_DATE:"Order Date",PRODUCTION_END:"Production End",ETD:"ETD",ETA:"ETA",DELIVERY:"Target Delivery"};n.payments.forEach((l,b)=>{const B=l.category==="supplier",X=Number.isFinite(Number(l.amount))?ne(Number(l.amount)):"0,00",j=ve.includes(l.triggerEvent)?l.triggerEvent:"ORDER_DATE",J=!Ae(j,i)&&!l.dueDate?`Due Date kann nicht berechnet werden: ${o[j]||j} fehlt.`:"",H=e("tr",{},[e("td",{},[e("input",{type:"text",value:l.label||"",oninput:w=>{l.label=w.target.value,U=!0}})]),e("td",{class:"num"},[e("input",{type:"number",min:"0",max:"100",step:"0.1",value:l.percent??0,disabled:!B,oninput:w=>{l.percent=Z(w.target.value)??0,l.isOverridden=!0,U=!0,le()}})]),e("td",{class:"num"},[e("div",{class:"fo-amount-field"},[e("input",{type:"text",inputmode:"decimal",value:X,oninput:w=>{const I=Z(w.target.value)??0;if(B){const oe=ge();l.percent=oe?I/oe*100:0}l.amount=I,l.isOverridden=!0,U=!0,le()},onblur:w=>{const I=Z(w.target.value);I!=null&&(w.target.value=ne(I))}}),e("span",{class:"fo-amount-currency muted"},[l.currency||"EUR"])])]),e("td",{},[(()=>{const w=e("select",{onchange:I=>{l.triggerEvent=I.target.value,l.isOverridden=!1,l.dueDateManuallySet=!1,U=!0,le()}});return ve.forEach(I=>w.append(e("option",{value:I},[I]))),w.value=l.triggerEvent||"ORDER_DATE",w})()]),e("td",{class:"num"},[e("input",{type:"number",step:"1",value:l.offsetDays??0,oninput:w=>{l.offsetDays=Yt(w.target.value)??0,l.isOverridden=!1,l.dueDateManuallySet=!1,U=!0,le()}})]),e("td",{},[e("input",{type:"date",value:l.dueDate||"",oninput:w=>{l.dueDate=w.target.value||null,l.isOverridden=!0,l.dueDateManuallySet=!0,U=!0,le()}}),J?e("span",{class:"fo-due-date-warning",title:J},["⚠️"]):null]),e("td",{},[e("button",{class:"btn secondary",type:"button",onclick:()=>{const w=s.suppliers.find(fe=>fe.id===n.supplierId)||null,I=re(n),oe=ge(),G=De(n);String(n.incoterm||"").toUpperCase()==="DDP"&&(G.dutyRatePct=0,G.eustRatePct=0);const de=Ue({supplier:w,baseValue:oe,currency:n.currency,schedule:I,freight:G.freightTotal,freightCurrency:G.freightCurrency,dutyRatePct:G.dutyRatePct,eustRatePct:G.eustRatePct,fxRate:G.fxRate,supplierCostEur:G.supplierCostEur,incoterm:n.incoterm})[b];de&&(n.payments[b]={...de,id:l.id||de.id},n.payments[b].dueDateManuallySet=!1,U=!0,le())}},["Reset"])])]);r.append(H)})}const d=e("div",{class:"fo-modal"},[P?e("div",{class:"banner info fo-converted-banner"},[e("strong",{},["Converted to PO."]),e("span",{class:"muted"},[` PO: ${n.convertedPoNo||n.convertedPoId||"—"}`])]):null,e("div",{class:"grid two"},[e("section",{class:"card"},[e("h3",{},["Inputs"]),e("div",{class:"grid two"},[e("label",{},["Produkt (Alias)",e("div",{class:"fo-product-picker"},[e("input",{type:"text",id:"fo-product-input",value:((lt=se(v,n.sku))==null?void 0:lt.alias)||n.sku||"",placeholder:"Alias oder SKU suchen",autocomplete:"off"}),e("div",{class:"fo-product-dropdown",id:"fo-product-dropdown"},[])]),e("div",{class:"muted fo-sku-display",id:"fo-sku-display"},["SKU: —"]),e("small",{class:"form-error",id:"fo-product-error"},[])]),e("label",{},["Units",e("input",{type:"number",min:"0",step:"1",id:"fo-units",value:n.units||""}),e("small",{class:"form-error",id:"fo-units-error"},[])]),e("label",{},["Target Delivery Date",e("input",{type:"date",id:"fo-targetDeliveryDate",value:n.targetDeliveryDate||""}),e("small",{class:"form-error",id:"fo-target-error"},[])]),e("label",{},["Supplier",(()=>{const r=e("select",{id:"fo-supplierId"});return r.append(e("option",{value:""},["Bitte auswählen"])),s.suppliers.forEach(i=>{const o=c.get(i.id)||i.name||i.id;r.append(e("option",{value:i.id},[o]))}),r.value=n.supplierId||"",r})(),e("small",{class:"form-error",id:"fo-supplier-error"},[])])]),e("div",{class:"grid two"},[e("label",{},["Transport Mode",(()=>{const r=e("select",{id:"fo-transportMode"});return Ht.forEach(i=>r.append(e("option",{value:i},[i]))),r.value=n.transportMode||"SEA",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-transport"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-transportMode"},["Reset"])])]),e("label",{},["Incoterm",(()=>{const r=e("select",{id:"fo-incoterm"});return Wt.forEach(i=>r.append(e("option",{value:i},[i]))),r.value=n.incoterm||"EXW",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-incoterm"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-incoterm"},["Reset"])])]),e("label",{},["Unit Price (USD/Stück)",e("input",{type:"text",inputmode:"decimal",id:"fo-unitPrice",value:n.unitPrice??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-unitPrice"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-unitPrice"},["Reset"])]),e("small",{class:"form-error",id:"fo-unitPrice-error"},[])]),e("label",{},["Currency",(()=>{const r=e("select",{id:"fo-currency"});return Ke.forEach(i=>r.append(e("option",{value:i},[i]))),r.value=n.currency||"USD",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-currency"},["USD"]),e("button",{class:"btn ghost",type:"button",id:"reset-currency"},["Reset"])]),e("small",{class:"form-error",id:"fo-currency-error"},[])]),e("label",{},["Shipping costs (EUR/Stück)",e("input",{type:"text",inputmode:"decimal",id:"fo-freight",value:n.freight??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-freight"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-freight"},["Reset"])]),e("small",{class:"form-error",id:"fo-freight-warning"},[])]),e("label",{},["Logistik-Währung",(()=>{const r=e("select",{id:"fo-freightCurrency"});return Ke.forEach(i=>r.append(e("option",{value:i},[i]))),r.value=n.freightCurrency||"EUR",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-freightCurrency"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-freightCurrency"},["Reset"])])]),e("label",{},["Duty %",e("input",{type:"text",inputmode:"decimal",id:"fo-dutyRatePct",value:n.dutyRatePct??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-dutyRatePct"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-dutyRatePct"},["Reset"])])]),e("label",{},["EUSt %",e("input",{type:"text",inputmode:"decimal",id:"fo-eustRatePct",value:n.eustRatePct??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-eustRatePct"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-eustRatePct"},["Reset"])])]),e("label",{},["FX (USD je EUR)",e("input",{type:"text",inputmode:"decimal",id:"fo-fxRate",value:n.fxRate??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-fxRate"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-fxRate"},["Reset"])])]),e("label",{},["Production Lead Time (used)",e("input",{type:"number",min:"0",step:"1",id:"fo-productionLeadTimeDays",value:n.productionLeadTimeDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-productionLeadTimeDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-productionLeadTimeDays"},["Reset"])])]),e("label",{},["Fracht-LT (Tage)",e("input",{type:"number",min:"0",step:"1",id:"fo-logisticsLeadTimeDays",value:n.logisticsLeadTimeDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-logisticsLeadTimeDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-logisticsLeadTimeDays"},["Reset"])])]),e("label",{},[e("span",{class:"fo-buffer-label"},["Buffer (days)",e("span",{class:"tooltip"},[e("button",{class:"tooltip-trigger",type:"button","aria-label":"Buffer Erklärung"},["ℹ️"]),e("span",{class:"tooltip-content"},["Puffer in Tagen, der zur Sicherheit zusätzlich eingeplant wird. Er wird zur Summe aus Produktions- und Logistik-Leadtimes addiert und verschiebt das Bestelldatum entsprechend nach vorne."])])]),e("input",{type:"number",min:"0",step:"1",id:"fo-bufferDays",value:n.bufferDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-bufferDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-bufferDays"},["Reset"])])])]),e("div",{class:"fo-cost-summary"},[e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Supplier Cost"]),e("strong",{id:"fo-supplier-cost"},["—"])]),e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Landed Cost (EUR)"]),e("strong",{id:"fo-landed-cost"},["—"])]),e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Shipping total (EUR)"]),e("strong",{id:"fo-shipping-estimate"},["—"])]),e("small",{class:"muted",id:"fo-shipping-note"},[])]),e("div",{class:"banner info",id:"fo-suggestion-info"},[e("strong",{},["Why this suggestion"]),e("ul",{class:"fo-suggestion-list"},[])]),e("div",{class:"banner warning",id:"fo-warning-info",style:"display:none"},[e("strong",{},["Hinweise"]),e("ul",{class:"fo-warning-list"},[])]),e("div",{class:"banner info",id:"fo-product-banner",style:"display:none"},[e("strong",{},["SKU nicht in Produktdatenbank."]),e("span",{class:"muted"},[" Bitte Produkt anlegen."]),e("div",{class:"fo-banner-actions"},[e("input",{type:"text",id:"fo-product-name",placeholder:"Produktname (optional)"}),e("button",{class:"btn secondary",type:"button",id:"fo-product-create"},["Produkt anlegen"])])]),e("div",{class:"form-error",id:"fo-save-error",role:"alert"},[])]),e("section",{class:"card"},[e("h3",{},["Rückwärtsterminierung"]),e("div",{class:"fo-date-list"},[e("div",{class:"fo-date-row"},[e("span",{},["Ziel Delivery"]),e("strong",{id:"fo-preview-target"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["Order Date"]),e("strong",{id:"fo-preview-order"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["Production End"]),e("strong",{id:"fo-preview-production"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["ETD"]),e("strong",{id:"fo-preview-etd"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["ETA"]),e("strong",{id:"fo-preview-eta"},["—"])])]),e("p",{class:"muted",id:"fo-user-anchor",style:"display:none;"},[]),e("div",{class:"fo-schedule-missing",id:"fo-schedule-missing",style:"display:none;"},[e("strong",{},["Fehlende Daten"]),e("ul",{class:"fo-schedule-missing-list",id:"fo-schedule-missing-list"},[])]),e("p",{class:"muted",id:"fo-date-warning",style:"display:none; margin-top:10px"},[]),e("div",{class:"fo-recommendation-card",id:"fo-recommendation"},[e("strong",{},["FO Empfehlung"]),e("p",{class:"muted",id:"fo-recommendation-summary"},["—"]),e("div",{class:"fo-recommendation-rows",id:"fo-recommendation-details"},[e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Baseline"]),e("strong",{id:"fo-recommendation-baseline"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["First month below safety DOH"]),e("strong",{id:"fo-recommendation-critical"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Required arrival (DE)"]),e("strong",{id:"fo-recommendation-arrival"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Recommended order date"]),e("strong",{id:"fo-recommendation-order"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Recommended units"]),e("strong",{id:"fo-recommendation-units"},["—"])])]),e("div",{class:"fo-recommendation-issues",id:"fo-recommendation-issues"},[]),e("p",{class:"muted",id:"fo-recommendation-notes"},[])])])]),e("section",{class:"card"},[e("h3",{},["Payments"]),e("div",{class:"table-wrap ui-table-shell ui-scroll-host"},[e("table",{class:"table-compact ui-table-standard ui-data-table fo-payments-table","data-ui-table":"true"},[e("thead",{},[e("tr",{},[e("th",{},["Label"]),e("th",{class:"num"},["%"]),e("th",{class:"num"},["Amount"]),e("th",{},["Trigger"]),e("th",{class:"num"},["Offset Days"]),e("th",{},["Due Date"]),e("th",{},["Reset"])])]),e("tbody",{id:"fo-payments-body"},[])])]),e("p",{class:"muted fo-ddp-note",id:"fo-ddp-note",style:"display:none;"},["Bei DDP ist Fracht typischerweise in Deposit/Balance enthalten."]),e("div",{class:"fo-payments-footer"},[e("p",{class:"muted",id:"fo-payment-total"},["Summe: 100%"]),e("p",{class:"form-error",id:"fo-payment-error"},[]),e("button",{class:"btn secondary",type:"button",id:"fo-payment-normalize"},["Normalize to 100%"])])])]),ye=e("button",{class:"btn primary",type:"button"},["Save FO"]),Fe=e("button",{class:"btn",type:"button"},["Cancel"]);let Te=null;function Ie(){z.unregister(),z.detachBeforeUnload(),Te&&document.removeEventListener("keydown",Te),Ge.remove()}function $e(){if(!S.isDirty){Ie();return}z({confirmWithModal:({onConfirm:r})=>Ot({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{S.discardDraft(),r==null||r(),Ie()}})})}const Ge=je(h?"FO bearbeiten":"FO anlegen",d,[Fe,ye],$e);Te=r=>{r.key==="Escape"&&(r.preventDefault(),$e())},document.addEventListener("keydown",Te),Fe.addEventListener("click",$e),P&&(ye.disabled=!0,d.querySelectorAll("input, select, textarea, button.btn.secondary, button.btn.ghost").forEach(r=>{r!==Fe&&r.setAttribute("disabled","true")}));function te(r,i){n[r]=i,F[r]=!0,r==="productionLeadTimeDays"&&(n.productionLeadTimeDaysManual=i,n.productionLeadTimeSource="Manual override")}function Le(){const r=String(n.sku||"").trim(),i=String(n.supplierId||"").trim(),o=Number(n.units||0),l=V(n.unitPrice)||0,b=n.targetDeliveryDate,B=se(v,r),X=!!B,j=B?Rt(B,{state:s}):null,Y=(j==null?void 0:j.status)==="blocked",J=n.payments.filter(ue=>ue.category==="supplier"),H=J.reduce((ue,ke)=>ue+(Number(ke.percent)||0),0),w=String(n.currency||"").trim(),I=J.length>0&&Math.round(H)===100,oe=r&&i&&o>0&&l>0&&b&&I&&w&&X&&!Y,G=u("#fo-unitPrice-error",d),Pe=u("#fo-units-error",d),de=u("#fo-target-error",d),fe=u("#fo-product-error",d),W=u("#fo-supplier-error",d),Re=u("#fo-currency-error",d),Se=u("#fo-payment-error",d);if(G&&(G.textContent=l>0?"":"Unit Price ist erforderlich."),Pe&&(Pe.textContent=o>0?"":"Units ist erforderlich."),de&&(de.textContent=b?"":"Zieltermin ist erforderlich."),fe)if(!X)fe.textContent="Produkt fehlt in der Datenbank.";else if(Y){const ue=vt(j);fe.textContent=ue?`Produkt blockiert: ${ue}`:"Produkt blockiert."}else fe.textContent="";W&&(W.textContent=i?"":"Supplier ist erforderlich."),Re&&(Re.textContent=w?"":"Currency ist erforderlich."),Se&&(Se.textContent=I?"":"Payment Terms fehlen oder ergeben nicht 100%."),ye.disabled=!oe||!S.isDirty,u("#fo-save-error",d).textContent=oe?"":"Bitte fehlende Felder korrigieren."}function et(){S.setDraft(n),Le()}let Be=null;function A(){Be&&clearTimeout(Be),Be=setTimeout(()=>{const r=re(n),i=ge(),o=De(n);n.payments=Pt(n.payments,{baseValue:i,schedule:r,currency:n.currency,freight:o.freight,freightCurrency:o.freightCurrency,dutyRatePct:o.dutyRatePct,eustRatePct:o.eustRatePct,fxRate:o.fxRate,supplierCostEur:o.supplierCostEur,incoterm:n.incoterm}),n.payments=Ce(n.payments,n.incoterm),Xe(r),Ye(),Le(),He(),We(),Je(),Ze(o),Qe(),et()},300)}const Ee=u("#fo-product-input",d),he=u("#fo-product-dropdown",d);function Tt(r){const i=se(v,r);return i||_e(v,r)}function tt(r=""){he.innerHTML="";const i=String(r||"").trim().toLowerCase(),o=N.filter(l=>i?l.label.toLowerCase().includes(i)||l.sku.toLowerCase().includes(i):!0).slice(0,12);if(!o.length){he.append(e("div",{class:"muted fo-product-empty"},["Keine Produkte gefunden."]));return}o.forEach(l=>{var Y,J,H;const b=((Y=l.completeness)==null?void 0:Y.status)==="blocked",B=an((J=l.completeness)==null?void 0:J.status),X=vt(l.completeness),j=e("button",{class:`fo-product-option${b?" is-blocked":""}`,type:"button",disabled:b,title:X||B,onclick:()=>{n.sku=l.sku,Ee.value=l.alias||l.sku,he.style.display="none",ae(),we(),A()}},[e("span",{class:"fo-product-alias",title:l.alias||l.sku},[l.alias||l.sku]),e("span",{class:"fo-product-sku muted",title:l.sku},[l.sku]),e("span",{class:`fo-product-status ${((H=l.completeness)==null?void 0:H.status)||"blocked"}`},[B])]);he.append(j)})}Ee.addEventListener("focus",()=>{he.style.display="block",tt(Ee.value)}),Ee.addEventListener("input",r=>{const i=r.target.value;tt(i);const o=Tt(i);n.sku=o?o.sku:i.trim(),ae(),we(),A()}),Ee.addEventListener("blur",()=>{setTimeout(()=>{he.style.display="none"},150)}),u("#fo-units",d).addEventListener("input",r=>{n.units=Z(r.target.value)??"",A()}),u("#fo-targetDeliveryDate",d).addEventListener("input",r=>{n.targetDeliveryDate=r.target.value,A()}),u("#fo-supplierId",d).addEventListener("change",r=>{if(n.supplierId=r.target.value,ae(),!U){const i=re(n),o=ge(),l=s.suppliers.find(B=>B.id===n.supplierId)||null,b=De(n);n.payments=Ue({supplier:l,baseValue:o,currency:n.currency,schedule:i,freight:b.freightTotal,freightCurrency:b.freightCurrency,dutyRatePct:b.dutyRatePct,eustRatePct:b.eustRatePct,fxRate:b.fxRate,supplierCostEur:b.supplierCostEur,incoterm:n.incoterm}),n.payments=Ce(n.payments,n.incoterm)}A()}),u("#fo-transportMode",d).addEventListener("change",r=>{te("transportMode",r.target.value),ae(),A()}),u("#fo-incoterm",d).addEventListener("change",r=>{te("incoterm",r.target.value),ae(),$(),qe(),A()}),u("#fo-unitPrice",d).addEventListener("input",r=>{n.unitPrice=Z(r.target.value)??"",n.unitPriceIsOverridden=!0,$(),A()}),u("#fo-currency",d).addEventListener("change",r=>{te("currency",r.target.value.trim()||"USD"),$(),A()}),u("#fo-freight",d).addEventListener("input",r=>{te("freight",Z(r.target.value)??""),$(),A()}),u("#fo-freightCurrency",d).addEventListener("change",r=>{te("freightCurrency",r.target.value.trim()||"EUR"),$(),A()}),u("#fo-dutyRatePct",d).addEventListener("input",r=>{te("dutyRatePct",Z(r.target.value)??""),$(),A()}),u("#fo-eustRatePct",d).addEventListener("input",r=>{te("eustRatePct",Z(r.target.value)??""),$(),A()}),u("#fo-fxRate",d).addEventListener("input",r=>{te("fxRate",Z(r.target.value)??""),$(),A()}),u("#fo-productionLeadTimeDays",d).addEventListener("input",r=>{const i=Z(r.target.value);i==null?T("productionLeadTimeDays",g.productionLeadTimeDays):te("productionLeadTimeDays",i),$(),A()}),u("#fo-logisticsLeadTimeDays",d).addEventListener("input",r=>{te("logisticsLeadTimeDays",Z(r.target.value)??""),$(),A()}),u("#fo-bufferDays",d).addEventListener("input",r=>{te("bufferDays",Z(r.target.value)??""),$(),A()}),u("#reset-transportMode",d).addEventListener("click",()=>{T("transportMode",g.transportMode),$(),A()}),u("#reset-incoterm",d).addEventListener("click",()=>{T("incoterm",g.incoterm),$(),A()}),u("#reset-unitPrice",d).addEventListener("click",()=>{T("unitPrice",g.unitPrice??""),n.unitPriceIsOverridden=!1,$(),A()}),u("#reset-currency",d).addEventListener("click",()=>{T("currency",g.currency||"USD"),$(),A()}),u("#reset-freight",d).addEventListener("click",()=>{T("freight",g.freight??""),$(),A()}),u("#reset-freightCurrency",d).addEventListener("click",()=>{T("freightCurrency",g.freightCurrency||"EUR"),$(),A()}),u("#reset-dutyRatePct",d).addEventListener("click",()=>{T("dutyRatePct",g.dutyRatePct??""),$(),A()}),u("#reset-eustRatePct",d).addEventListener("click",()=>{T("eustRatePct",g.eustRatePct??""),$(),A()}),u("#reset-fxRate",d).addEventListener("click",()=>{T("fxRate",g.fxRate??""),$(),A()}),["fo-unitPrice","fo-freight","fo-dutyRatePct","fo-eustRatePct","fo-fxRate"].forEach(r=>{const i=u(`#${r}`,d);i&&i.addEventListener("blur",()=>{const o=Z(i.value);o!=null&&(r==="fo-dutyRatePct"||r==="fo-eustRatePct"?i.value=pe(o):i.value=ne(o))})}),u("#reset-productionLeadTimeDays",d).addEventListener("click",()=>{T("productionLeadTimeDays",g.productionLeadTimeDays),$(),A()}),u("#reset-logisticsLeadTimeDays",d).addEventListener("click",()=>{T("logisticsLeadTimeDays",g.logisticsLeadTimeDays),$(),A()}),u("#reset-bufferDays",d).addEventListener("click",()=>{T("bufferDays",g.bufferDays),$(),A()}),u("#fo-payment-normalize",d).addEventListener("click",Ct),u("#fo-product-create",d).addEventListener("click",()=>{const r=String(n.sku||"").trim();if(!r)return;const i=u("#fo-product-name",d).value.trim();try{Ut({sku:r,alias:i||r,supplierId:n.supplierId||""}),v.push({sku:r,alias:i||r}),N.push({sku:r,alias:i||r,label:i||r}),u("#fo-product-banner",d).style.display="none",A()}catch(o){window.alert((o==null?void 0:o.message)||"Produkt konnte nicht angelegt werden.")}}),d.addEventListener("click",r=>{const i=r.target.closest(".fo-fix-now");if(!i)return;const o=i.dataset.sku,l=i.dataset.tab||"suppliers";o&&(sessionStorage.setItem("healthFocus",JSON.stringify({tab:l,sku:o})),l==="produkte"?location.hash="#produkte":location.hash="#suppliers",Ge.remove())});function Lt(){const{issues:r}=At({settings:s.settings,products:s.products,suppliers:s.suppliers});return r.filter(i=>i.blocking?i.scope==="settings"?i.field==="fxRate":i.scope==="product"?i.entityId===n.sku&&(i.field==="currency"||i.field==="unitPrice"):i.scope==="supplier"?i.entityId===n.supplierId&&(i.field==="paymentTerms"||i.field==="productionLeadTime"):!1:!1)}if(ye.addEventListener("click",async()=>{if(Le(),ye.disabled)return;const r=Lt();if(r.length){Mt(r);return}ye.disabled=!0,ye.textContent="Speichern…",String(n.incoterm||"").toUpperCase()==="DDP"&&(n.dutyRatePct=0,n.eustRatePct=0,n.freightCurrency="USD");const i=re(n),o=ln(n,i,n.payments);await S.commit(()=>{const l=gt();Array.isArray(l.fos)||(l.fos=[]);const b=l.fos.findIndex(B=>B.id===o.id);b>=0?l.fos[b]=o:l.fos.push(o),Ve(l,{source:"fo:save",entityKey:`fo:${o.id}`,action:b>=0?"update":"create"})}),C(),window.alert("FO gespeichert."),Ie()}),!n.payments.length){const r=re(n),i=ge(),o=s.suppliers.find(b=>b.id===n.supplierId)||null,l=De(n);String(n.incoterm||"").toUpperCase()==="DDP"&&(l.dutyRatePct=0,l.eustRatePct=0),n.payments=Ue({supplier:o,baseValue:i,currency:n.currency,schedule:r,freight:l.freightTotal,freightCurrency:l.freightCurrency,dutyRatePct:l.dutyRatePct,eustRatePct:l.eustRatePct,fxRate:l.fxRate,supplierCostEur:l.supplierCostEur,incoterm:n.incoterm}),n.payments=Ce(n.payments,n.incoterm)}ae(),we(),le(),Le()}u("#fo-add",t).addEventListener("click",()=>K(null)),m.addEventListener("click",f=>{var x,p,O,L;const R=(x=f.target)!=null&&x.closest?f.target:(p=f.target)==null?void 0:p.parentElement;if(!R)return;const v=R.closest("tr[data-id], tr[data-key]");if(!v)return;const N=v.dataset.id||v.dataset.key,h=s.fos.find(n=>n.id===N);if(!h)return;const P=(L=(O=R.closest("button"))==null?void 0:O.dataset)==null?void 0:L.action;if(P==="edit")K(h);else if(P==="convert"){if(String(h.status||"").toUpperCase()==="CONVERTED")return;k(h)}else if(P==="delete"){const S=String(h.status||"").toUpperCase()==="CONVERTED"?"Diese FO wurde bereits in eine PO umgewandelt. FO trotzdem löschen? (Die PO bleibt bestehen.)":"Forecast Order wirklich löschen?";if(!window.confirm(S))return;s.fos=s.fos.filter(F=>F.id!==N),Ve(s,{source:"fo:delete",entityKey:`fo:${N}`,action:"delete"}),C()}else if(P==="supplier"){const n=s.suppliers.find(S=>S.id===h.supplierId);n?M("Supplier Details",[`Name: ${n.name}`,`Incoterm: ${n.incotermDefault||"—"}`,`Currency: ${n.currencyDefault||"—"}`]):M("Supplier Details",["Supplier ist nicht vorhanden."])}}),C();function _(){const f=window.__routeQuery||{};if(f.create==="1"||f.mode==="create"){K(null,{sku:f.sku||"",alias:f.alias||"",targetDeliveryDate:f.target||"",anchorMonth:f.anchorMonth||""}),window.__routeQuery={};return}if(!f.open)return;const v=String(f.open||"").trim().toLowerCase();if(!v)return;const N=s.fos.find(h=>{if(!h)return!1;const P=String(h.id||"").toLowerCase()===v,x=String(h.foNo||"").toLowerCase()===v;return P||x});N&&(K(N),window.__routeQuery={})}_()}export{vn as default};
