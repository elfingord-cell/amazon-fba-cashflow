import{u as Us,bF as Ce,f as An,h as Cn,g as Ls,bG as ws,e as Fs,v as Ps,bH as Ts,o as xs}from"./index-BzKrUq3k.js";import{l as wt,c as Ge}from"./store-Dw0Hn2Rh.js";import{a as Zn,c as Ns,p as Ms,d as Ze,b as As}from"./prefill-Bj1vc-GN.js";import{a as Xe,o as Cs,p as Rn}from"./dateUtils-D7NmXfd-.js";import{c as Wn,e as In}from"./productCompleteness-CNGcv3R4.js";import{u as On,s as ge,d as pn}from"./useDraftForm-Bad4PRzn.js";function Yn(t){if(!t)return null;const e=String(t).trim();return e?`pay-${e.replace(/^(pay-?)+/i,"")}`:null}function Rs(){return Yn(`pay-${Math.random().toString(36).slice(2,9)}`)}function _t(t){return String(t||"").trim()}function ye(t){if(!t)return!1;try{const e=new URL(t);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}}function Xn(t,e){if(!Number.isFinite(t))return null;const s=(e||[]).filter(p=>p&&Number.isFinite(Number(p.plannedEur)));if(!s.length)return null;const u=s.reduce((p,m)=>p+Number(m.plannedEur||0),0);if(u<=0){const p=Math.round(t/s.length*100)/100;return s.map(m=>({eventId:m.id,planned:0,actual:p}))}const l=s.map(p=>{const m=Number(p.plannedEur||0),E=m/u,k=Math.round(t*E*100)/100;return{eventId:p.id,planned:m,actual:k}}),r=l.reduce((p,m)=>p+m.actual,0),a=Math.round((t-r)*100)/100;if(a!==0){let p=l[l.length-1];l.length>1&&(p=l.reduce((m,E)=>E.planned>m.planned?E:m,p)),p.actual=Math.round((p.actual+a)*100)/100}return l}function Is({selectedEvents:t,actualRaw:e,invoiceUrl:s,folderUrl:u,paymentRecord:l,paymentIdValue:r,mergedPayments:a=[]}){const p={},m=t||[];if(!m.length)return p.events="Bitte mindestens ein Event auswÃ¤hlen.",{valid:!1,reason:p.events,fieldErrors:p};const E=m.reduce((h,B)=>{const j=Number(B.plannedEur);return h+(Number.isFinite(j)?j:0)},0),k=e?Zn(e):E;if(!Number.isFinite(k))return p.actual="Bitte einen gÃ¼ltigen Ist-Betrag eingeben.",{valid:!1,reason:p.actual,fieldErrors:p,sumPlanned:E};if(k<0)return p.actual="Ist-Betrag darf nicht negativ sein.",{valid:!1,reason:p.actual,fieldErrors:p,sumPlanned:E,parsedActual:k};if(k===0&&E>0)return p.actual="Ist-Betrag darf nicht 0 sein, wenn ein Soll-Betrag vorhanden ist.",{valid:!1,reason:p.actual,fieldErrors:p,sumPlanned:E,parsedActual:k};const F=Xn(k,m);if(!F)return p.actual="Konnte die Ist-BetrÃ¤ge nicht aufteilen.",{valid:!1,reason:p.actual,fieldErrors:p,sumPlanned:E,parsedActual:k};if(s&&!ye(s))return p.invoiceUrl="Invoice URL muss mit http:// oder https:// beginnen.",{valid:!1,reason:p.invoiceUrl,fieldErrors:p,sumPlanned:E,parsedActual:k};if(u&&!ye(u))return p.folderUrl="Folder URL muss mit http:// oder https:// beginnen.",{valid:!1,reason:p.folderUrl,fieldErrors:p,sumPlanned:E,parsedActual:k};const x=Yn(r)||(l==null?void 0:l.id)||Rs();return l!=null&&l.id&&x!==l.id&&a.find(B=>(B==null?void 0:B.id)===x)?(p.paymentId="Diese Payment-ID ist bereits vergeben.",{valid:!1,reason:p.paymentId,fieldErrors:p,sumPlanned:E,parsedActual:k}):{valid:!0,fieldErrors:p,selectedEvents:m,sumPlanned:E,parsedActual:k,allocations:F,invoiceUrl:s,folderUrl:u,requestedPaymentId:x}}function cn(t){return t?String(t).trim().replace(/\s+/g,"-").replace(/[\\/:*?"<>|]/g,"-").replace(/[-_]{2,}/g,"-").replace(/^[-_]+|[-_]+$/g,""):""}function Os(t,e){if(!t)return e;if(typeof t=="string"){const s=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(s)return s[0]}return t instanceof Date&&!Number.isNaN(t.getTime())?t.toISOString().slice(0,10):e}function _s(t){const e=Number(t);return Number.isFinite(e)?e.toFixed(2).replace(/\./g,"-").replace(/,/g,""):"0-00"}function _n(t){if(t==null)return 0;if(typeof t=="number")return t;const e=String(t).trim();if(!e)return 0;const s=e.replace(/\./g,"").replace(/,/g,"."),u=Number(s);return Number.isFinite(u)?u:0}function Bs(t,e=[]){const s=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];let u=null;s.length===1?u=s[0]:s.length>1&&(u=s.reduce((r,a)=>{const p=_n(a==null?void 0:a.units),m=_n(r==null?void 0:r.units);return p>m?a:r||a},null));let l=(u==null?void 0:u.sku)||"";if(!l){const r=s.find(a=>(a==null?void 0:a.sku)||(a==null?void 0:a.alias));l=(r==null?void 0:r.sku)||(r==null?void 0:r.alias)||""}if(l||(l=(t==null?void 0:t.sku)||""),!l&&(t!=null&&t.sku)){const r=e.find(a=>String((a==null?void 0:a.sku)||"").toLowerCase()===String((t==null?void 0:t.sku)||"").toLowerCase());l=(r==null?void 0:r.alias)||(r==null?void 0:r.sku)||""}if(!l&&e.length){const r=e.find(a=>(a==null?void 0:a.alias)||(a==null?void 0:a.sku));l=(r==null?void 0:r.alias)||(r==null?void 0:r.sku)||""}return l||"SKU"}function Ks(t,e){const s=String(t||"").toLowerCase(),u=String(e||"").toLowerCase();return u==="freight"?"Fracht":u==="eust"?"EUSt":u==="duty"?"Zoll":s.includes("deposit")||s.includes("anzahlung")?"Deposit":s.includes("balance")||s.includes("rest")?"Balance":s.includes("shipping")||s.includes("fracht")?"Fracht":s.includes("eust")?"EUSt":s.includes("zoll")||s.includes("duty")?"Zoll":(s.includes("other")||s.includes("sonst"),"Other")}function zs(t,e,s={}){if(!t||!e)return"";const u="YYYY-MM-DD",l=e.status==="paid"||e.status==="PAID"||e.isPaid===!0,r=l?e.paidDate:e.dueDate,a=Os(r,u),p=s.poNumber||(t==null?void 0:t.poNo)||(t==null?void 0:t.poNumber)||(t==null?void 0:t.id)||"",E=`PO${String(p||"").trim().replace(/^PO/i,"")}`,k=(t==null?void 0:t.supplier)||(t==null?void 0:t.supplierName)||(t==null?void 0:t.supplierId)||"",F=cn(k)||"Supplier",x=Bs(t,s.products||[]),h=cn(x)||"SKU",B=Ks(e.typeLabel||e.label,e.eventType||e.type),j=cn(B)||"Other",J=l?e.amountActualEur??e.paidEurActual:e.amountPlannedEur??e.plannedEur,Q=`${_s(J)}EUR`,V=(L,D)=>`${[a,E,L,D,j,Q].filter(Boolean).join("_")}.pdf`;let S=V(F,h);if(S.length>120){const L=F.slice(0,20),D=h.slice(0,25);S=V(L,D)}return S.replace(/[-_]{2,}/g,"-")}function Bn(t){if(t==null||t==="")return null;const e=typeof t=="number"?t:Number(String(t).replace(",","."));return Number.isFinite(e)?e:null}function Hs({units:t,shippingPerUnitEur:e}){const s=Bn(t)??0,u=Bn(e);if(!Number.isFinite(s)||!Number.isFinite(u))return 0;const l=s*u;return Number.isFinite(l)?Math.round(l*100)/100:0}const js=new Set(["TOTAL_EUR","PER_UNIT_EUR","AUTO_FROM_LANDED"]);function Qt(t){if(t==null||t==="")return null;if(typeof t=="number")return Number.isFinite(t)?t:null;const e=String(t).trim();if(!e)return null;const s=e.includes(","),u=e.includes(".");let l=e;s?l=e.replace(/\./g,"").replace(",","."):u&&(l=e.replace(/,/g,""));const r=Number(l);return Number.isFinite(r)?r:null}function Re(t){return Math.round(t*100)/100}function Js(t,e){if(!e||!t)return null;const s=String(e).trim().toLowerCase();return t instanceof Map?t.get(s)||t.get(String(e).trim())||null:t[s]||t[String(e).trim()]||null}function Vs(t){var s;const e=(s=t==null?void 0:t.timeline)==null?void 0:s.freightInputMode;return js.has(e)?e:(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR"}function qs(t){var u;const e=Qt((u=t==null?void 0:t.timeline)==null?void 0:u.fxUsdPerEur);if(e!=null&&e>0)return e;const s=Qt(t==null?void 0:t.fxOverride);return s!=null&&s>0?s:null}function Gs(t,e){var S,L,D;const s=new Set,u=[],l=Array.isArray(t==null?void 0:t.items)?t.items:[],r=qs(t),a=r!=null&&r>0;a||s.add("MISSING_FX");let p=0,m=0,E=0;l.forEach(y=>{const c=String((y==null?void 0:y.sku)||"").trim(),P=Js(e,c),A=Qt(P==null?void 0:P.landedUnitCostEur),I=Qt((y==null?void 0:y.unitCostUsd)??(y==null?void 0:y.stueckkostenUsd)),z=Qt(y==null?void 0:y.units),_=[];let $=null,et=null;if(a||_.push("MISSING_FX"),A==null&&(_.push("MISSING_LANDED_COST"),m+=1),a&&I!=null&&A!=null){const T=Wn({unitPriceUsd:I,landedCostEur:A,fxUsdPerEur:r});$=T.goodsCostEur,T.value!=null&&(T.warning&&(_.push("NEGATIVE_DERIVED_LOGISTICS"),E+=1),et=Re(T.value),p+=Hs({units:z,shippingPerUnitEur:et}))}_.forEach(T=>s.add(T)),u.push({id:y==null?void 0:y.id,sku:c,units:z,landedUnitCostEur:A,goodsPerUnitEur:$!=null?Re($):null,derivedLogisticsPerUnitEur:et,issues:_})});const k=Re(p),F=l.reduce((y,c)=>y+(Qt(c==null?void 0:c.units)||0),0),x=(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR",h=Qt(((S=t==null?void 0:t.timeline)==null?void 0:S.freightPerUnitEur)??(t==null?void 0:t.freightPerUnitEur))||0,B=Qt(((L=t==null?void 0:t.timeline)==null?void 0:L.freightTotalEur)??(t==null?void 0:t.freightEur))||0,j=Re(x==="PER_UNIT_EUR"?h*F:B),J=((D=t==null?void 0:t.timeline)==null?void 0:D.includeFreight)!==!1,Q=Vs(t);return{estimatedFreightEur:J&&Q==="AUTO_FROM_LANDED"?k:j,autoFreightEur:k,manualFreightEur:j,includeFreight:J,mode:Q,issues:Array.from(s),lines:u,missingLandedCount:m,negativeCount:E,fxUsdPerEur:r}}function C(t,e=document){return e.querySelector(t)}function n(t,e={},s=[]){const u=document.createElement(t);for(const[l,r]of Object.entries(e))if(l==="class")u.className=r;else if(l==="dataset")for(const[a,p]of Object.entries(r))u.dataset[a]=p;else typeof r=="boolean"?(u[l]=r,r&&u.setAttribute(l,"")):l.startsWith("on")&&typeof r=="function"?u.addEventListener(l.slice(2),r):u.setAttribute(l,r);for(const l of[].concat(s))l!=null&&u.append(l.nodeType?l:document.createTextNode(String(l)));return u}let ft=[];function Ft(){ft=Ls()}function fn(t){if(!t)return"â€”";const e=ft.find(s=>s&&s.sku&&s.sku.trim().toLowerCase()===String(t).trim().toLowerCase());return e?`${e.alias||e.sku} (${e.sku})`:t}function Zs(){Ft();const t=new Map;return ft.forEach(e=>{if(!(e!=null&&e.sku))return;const s=e.sku.trim().toLowerCase();t.set(s,e),t.set(e.sku.trim(),e)}),t}function hn(t){var s;const e=(s=t==null?void 0:t.timeline)==null?void 0:s.freightInputMode;return e==="TOTAL_EUR"||e==="PER_UNIT_EUR"||e==="AUTO_FROM_LANDED"?e:(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR"}function Qn(t,e=Z()){if(!t)return{};(!t.timeline||typeof t.timeline!="object")&&(t.timeline={}),t.timeline.includeFreight==null&&(t.timeline.includeFreight=!0),t.timeline.freightInputMode=hn(t);const s=Number(t.fxOverride||e.fxRate||0),u=Number(t.timeline.fxUsdPerEur||0);return(!Number.isFinite(u)||u<=0)&&(Number.isFinite(s)&&s>0?t.timeline.fxUsdPerEur=s:Number.isFinite(e.fxRate)&&e.fxRate>0&&(t.timeline.fxUsdPerEur=e.fxRate)),t.timeline}function pe(t,e=Z()){var E;if(!t)return null;const s=Qn(t,e),u=H(t.freightEur),l=H(t.freightPerUnitEur);s.freightTotalEur=Number.isFinite(u)?u:0,s.freightPerUnitEur=Number.isFinite(l)?l:0;const r=Gs({...t,timeline:s},Zs()),a=new Set(r.issues||[]),p=Array.isArray(t.autoEvents)?t.autoEvents.find(k=>(k==null?void 0:k.type)==="freight"):null;if(p!=null&&p.id){const k=((E=t.paymentLog)==null?void 0:E[p.id])||{};k.status==="paid"&&!Number.isFinite(Number(k.amountActualEur))&&a.add("MISSING_PAYMENT_MAPPING")}r.issues=Array.from(a),t.derived={...t.derived||{},estimatedFreightEur:r.estimatedFreightEur,freightIssues:r.issues};const m=new Map;return r.lines.forEach(k=>{k.id&&m.set(k.id,k),k.sku&&m.set(`sku:${String(k.sku).toLowerCase()}`,k)}),Array.isArray(t.items)&&(t.items=t.items.map(k=>{const F=m.get(k.id)||m.get(`sku:${String(k.sku||"").toLowerCase()}`)||null;return{...k,derivedLogisticsPerUnitEur:(F==null?void 0:F.derivedLogisticsPerUnitEur)??null,derivedIssues:(F==null?void 0:F.issues)??[]}})),r}function mn(t){const e=wt(),s=Array.isArray(e.payments)?e.payments:[],u=(t==null?void 0:t.paymentDrafts)||{},l=s.map(r=>{const a=u[r==null?void 0:r.id];return a?{...r,...a}:r});return Object.values(u).forEach(r=>{l.some(a=>(a==null?void 0:a.id)===(r==null?void 0:r.id))||l.push(r)}),l}function Kn(t,e){const s=ge(t||{});return oa(s),Pt(s,e),Gt(s,e,s.milestones||[]),_e(s),Qe(s),s.paymentDrafts||(s.paymentDrafts={}),pe(s,e),s}function Ws(t){var u,l,r,a;if(!t)return[];const e=(u=ft.find(p=>{var m;return((m=p==null?void 0:p.sku)==null?void 0:m.trim().toLowerCase())===String(t.sku||"").trim().toLowerCase()}))==null?void 0:u.alias,s=[`SKU: ${t.sku||"â€”"}`,`Alias: ${e||"â€”"}`,`Einstand (EUR/Stk): ${t.landedUnitCostEur!=null?At(t.landedUnitCostEur):"â€”"}`,`Warenwert (EUR/Stk): ${t.goodsPerUnitEur!=null?At(t.goodsPerUnitEur):"â€”"}`,`Logistik / Stk. (EUR): ${t.derivedLogisticsPerUnitEur!=null?At(t.derivedLogisticsPerUnitEur):"â€”"}`];return(l=t.issues)!=null&&l.includes("MISSING_LANDED_COST")&&s.push("Einstandskosten fehlen"),(r=t.issues)!=null&&r.includes("NEGATIVE_DERIVED_LOGISTICS")&&s.push("Einstand < Warenwert (FX/EK prÃ¼fen)"),(a=t.issues)!=null&&a.includes("MISSING_FX")&&s.push("FX fehlt"),s}function Ys(t){var r;if(!t)return null;const e=ft.find(a=>a&&a.sku&&a.sku.trim().toLowerCase()===String(t).trim().toLowerCase());if(!e)return null;const s=(r=e.template)!=null&&r.fields?e.template.fields:e.template,u=(s==null?void 0:s.unitPriceUsd)??e.unitPriceUsd??null,l=typeof u=="number"?u:Number(u);return!Number.isFinite(l)||l<=0?null:l}function Xs(t){return!t||!t.length?"":`Logistik nicht berechenbar â€“ ${t.map(s=>s==="landedCostEur"?"Einstandspreis":s==="unitPriceUsd"?"Unit Price":s==="fxUsdPerEur"?"FX":s).join(", ")} fehlt`}function ts(t){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];if(!e.length)return fn(t==null?void 0:t.sku);const s=Array.from(new Set(e.map(l=>((l==null?void 0:l.sku)||"").trim()).filter(Boolean)));if(!s.length)return fn(t==null?void 0:t.sku);const u=fn(s[0]);return s.length===1?u:`${u} +${s.length-1}`}function H(t){const e=Ms(t);return e??NaN}function Tt(t){return Number(t||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})}function At(t){const e=Number(t||0);return Number.isFinite(e)?Ze(e,2):"0,00"}function tt(t){const e=t==null?"":String(t),s=H(e);return e.trim()?Number.isFinite(s)?Ns(s,2,{minimumFractionDigits:2,maximumFractionDigits:2}):e:""}function Se(t){return Number(t||0).toLocaleString("de-DE",{style:"currency",currency:"USD"})}function vt(t){const e=Number.isFinite(Number(t))?Number(t):H(t);return Number(e||0).toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2})}function We(t){const e=typeof t=="number"?t:H(t);return!Number.isFinite(e)||e<=0?"":Number(e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:4})}function it(t){if(!t)return"â€”";let e;if(typeof t=="string"){const s=t.split("-");if(s.length===3){const[u,l,r]=s.map(Number);Number.isFinite(u)&&Number.isFinite(l)&&Number.isFinite(r)&&(e=new Date(Date.UTC(u,l-1,r)))}}else t instanceof Date&&(e=t);return!(e instanceof Date)||Number.isNaN(e.getTime())?"â€”":e.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Qs(t){var e;return t?(e=navigator.clipboard)!=null&&e.writeText?navigator.clipboard.writeText(t).then(()=>!0).catch(()=>!1):new Promise(s=>{const u=document.createElement("textarea");u.value=t,u.setAttribute("readonly",""),u.style.position="absolute",u.style.left="-9999px",document.body.append(u),u.select();try{const l=document.execCommand("copy");u.remove(),s(l)}catch{u.remove(),s(!1)}}):Promise.resolve(!1)}function zn(t){if(!t)return null;const e=String(t).trim(),s=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(e);if(!s)return null;const[u,l,r,a]=s,p=Number(a),m=Number(r),E=Number(l);if(!Number.isFinite(p)||!Number.isFinite(m)||!Number.isFinite(E))return null;const k=new Date(Date.UTC(p,m-1,E));return Number.isNaN(k.getTime())?null:k}function ee(t){if(!t)return null;const e=String(t).split("-");if(e.length!==3)return null;const[s,u,l]=e.map(Number);return[s,u,l].every(r=>Number.isFinite(r))?new Date(Date.UTC(s,u-1,l)):null}function Ie(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}function Hn(t){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return null;const e=t.getUTCFullYear(),s=String(t.getUTCMonth()+1).padStart(2,"0");return`${e}-${s}`}function ta(t){if(!t)return"â€”";const[e,s]=String(t).split("-");return!e||!s?"â€”":`${s}/${e}`}function ea(t,e){var a;const s=t==null?void 0:t.cny;if(s!=null&&s.start&&(s!=null&&s.end)){const p=Rn(s.start),m=Rn(s.end);if(p&&m&&m>=p)return{start:p,end:m}}const u=(a=t==null?void 0:t.cnyBlackoutByYear)==null?void 0:a[String(e)];if(!u)return null;const l=ee(u.start),r=ee(u.end);return!(l instanceof Date)||Number.isNaN(l.getTime())||!(r instanceof Date)||Number.isNaN(r.getTime())||r<l?null:{start:l,end:r}}function es(t,e,s){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return{prodDone:t,adjustmentDays:0,cnyStart:null,cnyEnd:null};const u=Math.max(0,Number(e||0)),l=Xe(t,u);if(!l)return{prodDone:t,adjustmentDays:0,cnyStart:null,cnyEnd:null};let r=0,a=null,p=null;const m=t.getUTCFullYear(),E=l.getUTCFullYear();for(let F=m;F<=E;F+=1){const x=ea(s,F);if(!x)continue;const h=Cs(t,l,x.start,x.end);h>0&&(r+=h,a=!a||x.start<a?x.start:a,p=!p||x.end>p?x.end:p)}return{prodDone:(r?Xe(l,r):l)||l,adjustmentDays:r,cnyStart:a,cnyEnd:p}}const ns=["units","unitCostUsd","unitExtraUsd","extraFlatUsd","fxOverride","fxFeePct","transport","prodDays","transitDays","freightEur","freightMode","freightPerUnitEur","dutyRatePct","dutyIncludeFreight","eustRatePct","vatRefundEnabled","vatRefundLagMonths","ddp"],na=["milestones","autoEvents","items"],sa=[{key:"units",label:"StÃ¼ckzahl"},{key:"unitCostUsd",label:"StÃ¼ckkosten (USD)"},{key:"unitExtraUsd",label:"Zusatzkosten je StÃ¼ck (USD)"},{key:"extraFlatUsd",label:"Zusatzkosten pauschal (USD)"},{key:"fxOverride",label:"FX-Kurs"},{key:"fxFeePct",label:"FX-GebÃ¼hr (%)"},{key:"transport",label:"Transport"},{key:"prodDays",label:"Produktionstage"},{key:"transitDays",label:"Transit-Tage"},{key:"freightEur",label:"Fracht (â‚¬)"},{key:"freightMode",label:"Fracht-Modus"},{key:"freightPerUnitEur",label:"Logistik / Stk. (EUR)"},{key:"dutyRatePct",label:"Zoll (%)"},{key:"dutyIncludeFreight",label:"Fracht einbeziehen"},{key:"eustRatePct",label:"EUSt (%)"},{key:"vatRefundEnabled",label:"EUSt-Erstattung aktiv"},{key:"vatRefundLagMonths",label:"EUSt-Lag (Monate)"},{key:"ddp",label:"DDP"},{key:"items",label:"Positionen"},{key:"milestones",label:"Meilensteine"},{key:"autoEvents",label:"Importkosten-Einstellungen"}];function ss(t=[]){return t.map(e=>({...e,id:Math.random().toString(36).slice(2,9)}))}function as(t=[]){return t.map(e=>({...e,id:`auto-${e.type||"evt"}-${Math.random().toString(36).slice(2,7)}`}))}function aa(t=[]){return t.map(e=>({...e,id:e.id||`item-${Math.random().toString(36).slice(2,9)}`}))}function jn(t,e){if(!e)return t;const s=JSON.parse(JSON.stringify(t));for(const u of ns)e[u]!=null&&(s[u]=Array.isArray(e[u])?JSON.parse(JSON.stringify(e[u])):e[u]);return e.milestones&&(s.milestones=ss(e.milestones)),e.autoEvents&&(s.autoEvents=as(e.autoEvents)),e.items&&(s.items=aa(e.items)),e.fxOverride==null&&t.fxOverride!=null&&(s.fxOverride=t.fxOverride),s}function ia(t,e){var a,p;const s=[],u={units:"StÃ¼ckzahl",unitCostUsd:"StÃ¼ckkosten (USD)",unitExtraUsd:"Zusatzkosten je StÃ¼ck (USD)",extraFlatUsd:"Zusatzkosten pauschal (USD)",fxOverride:"FX-Kurs",fxFeePct:"FX-GebÃ¼hr (%)",transport:"Transport",prodDays:"Produktionstage",transitDays:"Transit-Tage",freightEur:"Fracht (â‚¬)",freightMode:"Fracht-Modus",freightPerUnitEur:"Logistik / Stk. (EUR)",dutyRatePct:"Zoll (%)",dutyIncludeFreight:"Fracht einbeziehen",eustRatePct:"EUSt (%)",vatRefundEnabled:"EUSt-Erstattung aktiv",vatRefundLagMonths:"EUSt-Lag (Monate)",ddp:"DDP",milestones:"Meilensteine",autoEvents:"Importkosten-Einstellungen"},l=new Set(["unitCostUsd","unitExtraUsd","extraFlatUsd","freightEur","freightPerUnitEur"]),r=new Set(["fxFeePct","dutyRatePct","eustRatePct"]);for(const m of[...ns,...na]){const E=u[m]||m;if(m==="milestones"||m==="autoEvents"){const h=JSON.stringify(t[m]||[]),B=JSON.stringify(e[m]||[]);h!==B&&s.push({label:E,before:((a=t[m])==null?void 0:a.length)||0,after:((p=e[m])==null?void 0:p.length)||0,type:"list"});continue}const k=t[m],F=e[m];if(k==null&&F==null||k===F)continue;const x=h=>h==null?"â€”":l.has(m)?m==="freightEur"||m==="freightPerUnitEur"?Tt(H(h)):Se(H(h)):r.has(m)?`${vt(h)} %`:m==="fxOverride"?We(h):m==="freightMode"?h==="per_unit"?"Pro StÃ¼ck":"Gesamt":typeof h=="boolean"?h?"Ja":"Nein":String(h);x(k)!==x(F)&&s.push({label:E,before:x(k),after:x(F)})}return s}function Oe({title:t,content:e,actions:s=[]}){const u=n("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),l=n("div",{class:"po-modal"},[n("header",{class:"po-modal-header"},[n("h4",{},[t||""]),n("button",{class:"btn ghost",type:"button",onclick:()=>gt(u),"aria-label":"SchlieÃŸen"},["âœ•"])]),n("div",{class:"po-modal-body"},[e]),n("footer",{class:"po-modal-actions"},s.length?s:[n("button",{class:"btn",type:"button",onclick:()=>gt(u)},["SchlieÃŸen"])])]);u.append(l),document.body.append(u);const r=u.querySelector("button, [href], input, select, textarea");r&&r.focus();function a(m){m.key==="Escape"&&gt(u)}let p=!1;return u.addEventListener("mousedown",m=>{p=m.target===u}),u.addEventListener("mouseup",m=>{p&&m.target===u&&gt(u),p=!1}),u.addEventListener("keydown",a),u}function gt(t){t&&t.remove()}function ct(t){const e=H(t);return e<0?0:e>100?100:e}function Ee(t){return t?((!Array.isArray(t.items)||!t.items.length)&&(t.items=[{id:`item-${Math.random().toString(36).slice(2,9)}`,sku:t.sku||"",units:t.units??"0",unitCostUsd:t.unitCostUsd??"0,00",unitExtraUsd:t.unitExtraUsd??"0,00",extraFlatUsd:t.extraFlatUsd??"0,00",unitCostManuallyEdited:!1}]),t.items=t.items.map(e=>({id:e.id||`item-${Math.random().toString(36).slice(2,9)}`,sku:e.sku||"",units:e.units??"0",unitCostUsd:e.unitCostUsd??"0,00",unitExtraUsd:e.unitExtraUsd??"0,00",extraFlatUsd:e.extraFlatUsd??"0,00",unitCostManuallyEdited:e.unitCostManuallyEdited===!0})),t.items):[]}function Ct(t,e=Z()){const s=Ee(t);let u=0,l=0,r=0,a=0,p=0;s.forEach((F,x)=>{const h=H(F.units),B=H(F.unitCostUsd),j=H(F.unitExtraUsd),J=H(F.extraFlatUsd),Q=Number.isFinite(h)?h:0,V=Number.isFinite(B)?B:0,S=Number.isFinite(j)?j:0,L=Number.isFinite(J)?J:0;x===0&&(r=V,a=S,p=L),Q>0&&(l+=Q);const D=(V+S)*Q+L;Number.isFinite(D)&&(u+=D)}),u=Math.max(0,Math.round(u*100)/100);let m=(e==null?void 0:e.fxRate)||0;if(t&&t.fxOverride!=null&&t.fxOverride!==""){const F=typeof t.fxOverride=="number"?t.fxOverride:H(t.fxOverride);Number.isFinite(F)&&F>0&&(m=F)}const E=H(t==null?void 0:t.goodsEur),k=m>0?Math.round(u/m*100)/100:Number.isFinite(E)?Math.round(E*100)/100:0;return{usd:u,eur:k,fxRate:m,units:l,unitCost:r,unitExtra:a,extraFlat:p}}function Zt(t,e=Ct(t,Z())){var r,a,p;if(!t)return 0;const s=hn(t),u=((r=t==null?void 0:t.timeline)==null?void 0:r.includeFreight)!==!1;if(s==="AUTO_FROM_LANDED"){const m=((a=t==null?void 0:t.derived)==null?void 0:a.estimatedFreightEur)??((p=pe(t))==null?void 0:p.estimatedFreightEur)??0;return u?Math.round(m*100)/100:0}if(s==="PER_UNIT_EUR"){const m=H(t==null?void 0:t.freightPerUnitEur),E=Number((e==null?void 0:e.units)||0),k=m*E;return Number.isFinite(k)?Math.round(k*100)/100:0}const l=H(t==null?void 0:t.freightEur);return Number.isFinite(l)?Math.round(l*100)/100:0}function ra(t,e=Z()){var u;if(!t)return{total:0,missing:0,used:[],estimate:null};const s=pe(t,e);return{total:Math.round(((s==null?void 0:s.estimatedFreightEur)||0)*100)/100,missing:(s==null?void 0:s.missingLandedCount)||0,used:((u=s==null?void 0:s.lines)==null?void 0:u.map(l=>l.sku).filter(Boolean))||[],estimate:s}}function Pt(t,e=Z()){var u,l,r,a;if(!t)return;if(Ee(t),t.items=t.items.map(p=>({...p,unitCostUsd:tt(p.unitCostUsd??"0,00"),unitExtraUsd:tt(p.unitExtraUsd??"0,00"),units:String(p.units??"0"),extraFlatUsd:tt(p.extraFlatUsd??"0,00"),unitCostManuallyEdited:p.unitCostManuallyEdited===!0})),t.fxOverride!=null&&t.fxOverride!==""){const p=typeof t.fxOverride=="number"?t.fxOverride:H(t.fxOverride);t.fxOverride=Number.isFinite(p)&&p>0?p:null}Ct(t,e);const s=Ct(t,e);t.goodsEur=tt(s.eur),t.goodsUsd=tt(s.usd),t.goodsValueUsd=s.usd,t.units=String(s.units||"0"),t.unitCostUsd=tt(((u=t.items[0])==null?void 0:u.unitCostUsd)??"0,00"),t.unitExtraUsd=tt(((l=t.items[0])==null?void 0:l.unitExtraUsd)??"0,00"),t.extraFlatUsd=tt(((r=t.items[0])==null?void 0:r.extraFlatUsd)??"0,00"),t.freightMode=t.freightMode==="per_unit"?"per_unit":"total",t.freightEur=tt(t.freightEur??"0,00"),t.freightPerUnitEur=tt(t.freightPerUnitEur??"0,00"),Qn(t,e),(!t.derived||typeof t.derived!="object")&&(t.derived={estimatedFreightEur:0,freightIssues:[]}),!t.sku&&((a=t.items[0])!=null&&a.sku)&&(t.sku=t.items[0].sku)}function Z(){const t=wt(),e=t&&t.settings||{};return{fxRate:H(e.fxRate??0)||0,fxFeePct:H(e.fxFeePct??0)||0,eurUsdRate:H(e.eurUsdRate??0)||0,dutyRatePct:H(e.dutyRatePct??0)||0,dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:H(e.eustRatePct??0)||0,vatRefundEnabled:e.vatRefundEnabled!==!1,vatRefundLagMonths:Number(e.vatRefundLagMonths??0)||0,freightLagDays:Number(e.freightLagDays??0)||0,cny:e.cny?{start:e.cny.start||"",end:e.cny.end||""}:{start:"",end:""},cnyBlackoutByYear:e.cnyBlackoutByYear&&typeof e.cnyBlackoutByYear=="object"?structuredClone(e.cnyBlackoutByYear):{}}}function la(t,e){const s=t.getUTCFullYear(),u=t.getUTCMonth();return new Date(Date.UTC(s,u+e,1))}function ua(t){const e=t.getUTCFullYear(),s=t.getUTCMonth();return new Date(Date.UTC(e,s+1,0))}function Gt(t,e,s=[]){t.autoEvents||(t.autoEvents=[]);const u=new Map(t.autoEvents.map(a=>[a.type,a])),l=(a,p)=>{if(u.has(a)){const m=u.get(a);Object.assign(m,{type:a,...p,...m})}else{const m={id:`auto-${a}`,type:a,...p};t.autoEvents.push(m),u.set(a,m)}return u.get(a)};l("freight",{label:"Fracht",anchor:"ETA",lagDays:e.freightLagDays||0,enabled:!0}),l("duty",{label:"Zoll",percent:e.dutyRatePct||0,anchor:"ETA",lagDays:e.freightLagDays||0,enabled:!0}),l("eust",{label:"EUSt",percent:e.eustRatePct||0,anchor:"ETA",lagDays:e.freightLagDays||0,enabled:!0}),l("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:e.vatRefundLagMonths||0,enabled:e.vatRefundEnabled!==!1});const r=s[0];if(l("fx_fee",{label:"FX-GebÃ¼hr",percent:e.fxFeePct||0,anchor:(r==null?void 0:r.anchor)||"ORDER_DATE",lagDays:(r==null?void 0:r.lagDays)||0,enabled:e.fxFeePct>0}),t.autoEvents=["freight","duty","eust","vat_refund","fx_fee"].map(a=>u.get(a)).filter(Boolean),t.ddp)for(const a of t.autoEvents)(a.type==="freight"||a.type==="duty"||a.type==="eust"||a.type==="vat_refund")&&(a.enabled!==!1&&(a._ddpEnabledBackup=a.enabled!==!1),a.enabled=!1);else for(const a of t.autoEvents)(a.type==="freight"||a.type==="duty"||a.type==="eust"||a.type==="vat_refund")&&a._ddpEnabledBackup!=null&&(a.enabled=a._ddpEnabledBackup,delete a._ddpEnabledBackup);return t.autoEvents}function _e(t){return t?((!t.paymentLog||typeof t.paymentLog!="object")&&(t.paymentLog={}),t.paymentLog):{}}function oa(t){!t||!Array.isArray(t.milestones)||t.milestones.forEach(e=>{!e||e.id||(e.id=`ms-${Math.random().toString(36).slice(2,9)}`)})}function is(t=[]){const e=new Map;return(t||[]).forEach(s=>{s!=null&&s.id&&e.set(s.id,s)}),e}function da(t,e){if(!t||!e)return null;const s=t.paymentLog||{};return(!s[e]||typeof s[e]!="object")&&(s[e]={}),s[e].paymentInternalId||(s[e].paymentInternalId=`payrow-${Math.random().toString(36).slice(2,9)}`),t.paymentLog=s,s[e].paymentInternalId}function ca(t,e){if(t.type==="freight")return"Fracht";if(t.type==="eust")return"EUSt";if(t.type==="duty"||t.type==="fx_fee")return"Other";const s=String((e==null?void 0:e.label)||t.label||"").toLowerCase();return s.includes("deposit")||s.includes("anzahlung")?"Deposit":s.includes("balance")||s.includes("rest")?"Balance":s.includes("shipping")||s.includes("fracht")?"Fracht":"Other"}function Jn(t,e,s,u=[]){_e(t);const l=Array.isArray(t.milestones)?t.milestones:[],r=new Map(l.map(m=>[m.id,m])),a=is(u);return bn(JSON.parse(JSON.stringify(t)),e,s).filter(m=>m&&Number(m.amount||0)<0).map(m=>{var j;const E=((j=t.paymentLog)==null?void 0:j[m.id])||{},k=da(t,m.id),F=Math.abs(Number(m.amount||0)),x=E.paymentId?a.get(E.paymentId):null,h=E.status==="paid"||x?"paid":"open",B=E.paidDate||(x==null?void 0:x.paidDate)||null;return{id:m.id,paymentInternalId:k,typeLabel:ca(m,r.get(m.id)),label:m.label,dueDate:m.date||null,plannedEur:F,status:h,paidDate:B,paidEurActual:Number.isFinite(Number(E.amountActualEur))?Number(E.amountActualEur):null,method:(x==null?void 0:x.method)||E.method||null,paidBy:(x==null?void 0:x.payer)||E.payer||null,paymentId:(x==null?void 0:x.id)||E.paymentId||null,note:E.note||"",invoiceDriveUrl:(x==null?void 0:x.invoiceDriveUrl)||"",invoiceFolderDriveUrl:(x==null?void 0:x.invoiceFolderDriveUrl)||"",eventType:m.type||null}})}function fa(t,e){let s=null;const u=/(\d+)(?!.*\d)/;for(const m of t||[]){const E=m==null?void 0:m[e];if(!E)continue;const k=u.exec(String(E));if(!k)continue;const F=Number(k[1]);Number.isFinite(F)&&(!s||F>s.numeric)&&(s={raw:String(E),numeric:F,digits:k[1],index:k.index??String(E).lastIndexOf(k[1])})}if(!s)return{raw:null,next:null};const l=String(s.numeric+1).padStart(s.digits.length,"0"),r=s.raw.slice(0,s.index),a=s.raw.slice(s.index+s.digits.length),p=`${r}${l}${a}`;return{raw:s.raw,next:p}}function qt(t,e){const s=new Date(t);return s.setDate(s.getDate()+Number(e||0)),s}function fe(t){if(!(t instanceof Date))return null;const e=t.getTime();return Number.isNaN(e)?null:new Date(e-t.getTimezoneOffset()*6e4).toISOString().slice(0,10)}function ve(t,e=Z()){const s=new Date().toISOString().slice(0,10),u={id:Math.random().toString(36).slice(2,9),[t.numberField]:"",orderDate:s,sku:"",supplier:"",items:[{id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1}],goodsEur:"0,00",fxOverride:e.fxRate||null,timeline:{fxUsdPerEur:e.fxRate||null,includeFreight:!0,freightInputMode:"TOTAL_EUR",freightTotalEur:0,freightPerUnitEur:0},freightEur:"0,00",freightMode:"total",freightPerUnitEur:"0,00",prodDays:60,transport:"sea",transitDays:60,ddp:!1,cnyAdjustmentDays:0,etdManual:null,etaManual:null,dutyRatePct:e.dutyRatePct||0,dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:e.eustRatePct||0,vatRefundLagMonths:e.vatRefundLagMonths||0,vatRefundEnabled:e.vatRefundEnabled!==!1,fxFeePct:e.fxFeePct||0,milestones:[{id:Math.random().toString(36).slice(2,9),label:"Deposit",percent:30,anchor:"ORDER_DATE",lagDays:0},{id:Math.random().toString(36).slice(2,9),label:"Balance",percent:70,anchor:"PROD_DONE",lagDays:0}],paymentLog:{},derived:{estimatedFreightEur:0,freightIssues:[]},archived:!1};return Gt(u,e,u.milestones),Pt(u,e),u}function Vn(t,e){return t?e==="ORDER_DATE"?t.order:e==="PROD_DONE"?t.prodDone:e==="ETD"?t.etd:t.eta:null}function pa(t){const e=(t||[]).reduce((s,u)=>s+ct(u.percent||0),0);return Math.round(e*10)/10}function bn(t,e,s){var V;const u=Ct(t,s);let l=u.eur;if(!l){const S=H(t.goodsEur);S&&(l=S)}const r=Zt(t,u),a=t[e.numberField]?`${e.entityLabel} ${t[e.numberField]} â€“ `:"",p=Array.isArray(t.milestones)?t.milestones:[],m=Gt(t,s,p),E=[],k=te(t,s),F=p.map(S=>{const L=ct(S.percent),D=Vn(k,S.anchor||"ORDER_DATE");if(!(D instanceof Date)||Number.isNaN(D.getTime()))return null;const y=qt(D,Number(S.lagDays||0)),c=fe(y);if(!c)return null;const P=-(l*(L/100));return Number.isFinite(P)?{id:S.id,label:`${a}${S.label||"Zahlung"}`.trim(),date:c,amount:P,type:"manual",due:y,auto:!1,direction:P<=0?"out":"in"}:null}).filter(Boolean);E.push(...F.map(S=>({id:S.id,label:S.label,date:S.date,amount:S.amount,type:S.type,auto:!1,due:S.due,direction:S.direction})));const x=t.dutyIncludeFreight!==!1,h=typeof t.dutyRatePct=="number"?t.dutyRatePct:ct(t.dutyRatePct),B=typeof t.eustRatePct=="number"?t.eustRatePct:ct(t.eustRatePct),j=typeof t.fxFeePct=="number"?t.fxFeePct:ct(t.fxFeePct),J=Number(t.vatRefundLagMonths??s.vatRefundLagMonths??0)||0,Q={};for(const S of m){if(!S||S.enabled===!1)continue;const L=S.anchor||"ETA",D=Vn(k,L);if(!(!(D instanceof Date)||Number.isNaN(D.getTime()))){if(S.type==="freight"){const y=Zt(t,u);if(!y){const I=qt(D,Number(S.lagDays||0)),z=fe(I);if(!z)continue;E.push({id:S.id,label:`${a}${S.label?` â€“ ${S.label}`:""}`.trim(),date:z,amount:0,type:"freight",auto:!0,due:I,direction:"out"});continue}const c=qt(D,Number(S.lagDays||0)),P=fe(c);if(!P)continue;const A=-y;E.push({id:S.id,label:`${a}${S.label?` â€“ ${S.label}`:""}`.trim(),date:P,amount:A,type:"freight",auto:!0,due:c,direction:A<=0?"out":"in"});continue}if(S.type==="duty"){const y=ct(S.percent??h??s.dutyRatePct??0),c=l+(x?r:0),P=qt(D,Number(S.lagDays||0)),A=-(c*(y/100)),I=fe(P);if(!I)continue;Q.duty={amount:A,due:P},E.push({id:S.id,label:`${a}${S.label||"Zoll"}`.trim(),date:I,amount:A,type:"duty",auto:!0,due:P,direction:A<=0?"out":"in"});continue}if(S.type==="eust"){const y=ct(S.percent??B??s.eustRatePct??0),c=Math.abs(((V=Q.duty)==null?void 0:V.amount)||0),P=l+r+c,A=qt(D,Number(S.lagDays||0)),I=-(P*(y/100)),z=fe(A);if(!z)continue;Q.eust={amount:I,due:A},E.push({id:S.id,label:`${a}${S.label||"EUSt"}`.trim(),date:z,amount:I,type:"eust",auto:!0,due:A,direction:I<=0?"out":"in"});continue}if(S.type==="vat_refund"){const y=Q.eust;if(!y||y.amount===0||t.vatRefundEnabled===!1)continue;const c=ct(S.percent??100),P=Number((S.lagMonths??J)||0),A=qt(y.due||D,Number(S.lagDays||0)),I=la(A,P),z=ua(I),_=fe(z);if(!_)continue;const $=Math.abs(y.amount)*(c/100);Q.vat={amount:$,due:z},E.push({id:S.id,label:`${a}${S.label||"EUSt-Erstattung"}`.trim(),date:_,amount:$,type:"vat_refund",auto:!0,due:z,direction:$<=0?"out":"in"});continue}if(S.type==="fx_fee"){const y=ct(S.percent??j??s.fxFeePct??0),c=qt(D,Number(S.lagDays||0)),P=fe(c);if(!P)continue;const A=-(l*(y/100));E.push({id:S.id,label:`${a}${S.label||"FX"}`.trim(),date:P,amount:A,type:"fx_fee",auto:!0,due:c,direction:A<=0?"out":"in"});continue}}}return E.filter(S=>S&&Number.isFinite(S.amount)).sort((S,L)=>S.date===L.date?(S.label||"").localeCompare(L.label||""):S.date.localeCompare(L.date))}function ma(t,e={},s=[]){const u=n("div",{class:"po-event-table"});if(!t.length)return u.append(n("div",{class:"muted"},["Keine Ereignisse definiert."])),u;const l=is(s);u.append(n("div",{class:"po-event-head"},[n("span",{class:"po-event-col"},["Name"]),n("span",{class:"po-event-col"},["Datum"]),n("span",{class:"po-event-col amount"},["Betrag"]),n("span",{class:"po-event-col status"},["Status"]),n("span",{class:"po-event-col status"},["Transfer"])]));for(const r of t){const a=(e==null?void 0:e[r.id])||{},p=a.paymentId?l.get(a.paymentId):null,m=a.status==="paid"||p?"paid":"open",E=m==="paid"?"Bezahlt":"Offen",k=(p==null?void 0:p.id)||a.paymentId||"â€”";u.append(n("div",{class:"po-event-row"},[n("span",{class:"po-event-col"},[r.label]),n("span",{class:"po-event-col"},[it(r.due||r.date)]),n("span",{class:"po-event-col amount"},[Tt(r.amount)]),n("span",{class:"po-event-col status"},[n("span",{class:`po-status-pill ${m==="paid"?"is-paid":"is-open"}`},[E])]),n("span",{class:"po-event-col status"},[n("span",{class:"po-transaction-pill"},[k])])]))}return u}function ha(t,e,s,u,l,r={}){if(s.slug==="po"){ba(t,e,s,u,l,r);return}t.innerHTML="",Ft();const a=Z(),p=Array.isArray(e)?e:[];for(const F of p)Pt(F,a);const m=p.map(F=>{const x=Ct(F,a);return{rec:F,totals:x}}),E=[{key:"number",label:`${s.entityLabel}-Nr.`},...s.slug==="po"||s.slug==="fo"?[{key:"product",label:"Produkt"}]:[],{key:"order",label:"Order"},{key:"timeline",label:"Timeline"},{key:"units",label:"StÃ¼ck",className:"num"},{key:"usd",label:"Summe USD",className:"num"},{key:"freight",label:"Fracht (â‚¬)",className:"num"},{key:"payments",label:"Zahlungen"},{key:"transport",label:"Transport"},{key:"actions",label:"Aktionen"}],k=Fs({columns:E,rows:m,rowKey:F=>F.rec.id,renderCell:(F,x)=>{const h=F.rec;switch(x.key){case"number":return h[s.numberField]||"â€”";case"product":return ts(h);case"order":return it(h.orderDate);case"timeline":return ya(h,a);case"units":return Number(F.totals.units||0).toLocaleString("de-DE");case"usd":return Se(F.totals.usd);case"freight":return Tt(Zt(h,F.totals));case"payments":return String((h.milestones||[]).length);case"transport":return`${h.transport||"sea"} Â· ${h.transitDays||0}d`;case"actions":return n("div",{class:"table-actions"},[n("button",{class:"btn",onclick:()=>u(h)},["Bearbeiten"]),n("button",{class:"btn danger",onclick:()=>l(h)},["LÃ¶schen"])]);default:return"â€”"}}});t.append(k)}function ba(t,e,s,u,l,r={}){t.innerHTML="",Ft();const a=Z(),p=Array.isArray(e)?e:[];p.forEach(D=>{Pt(D,a),Qe(D)});const m=String(r.searchTerm||"").trim().toLowerCase(),E=r.showArchived===!0,F=p.filter(D=>{if(!E&&D.archived)return!1;if(!m)return!0;const c=(Array.isArray(D.items)?D.items:[]).map(A=>{const I=(A==null?void 0:A.sku)||"",z=ft.find(_=>{var $;return(($=_==null?void 0:_.sku)==null?void 0:$.trim().toLowerCase())===String(I).trim().toLowerCase()});return[I,(z==null?void 0:z.alias)||""].filter(Boolean).join(" ")});return[D[s.numberField],D.sku,D.supplier,...c].filter(Boolean).join(" ").toLowerCase().includes(m)}).map(D=>({rec:D,totals:Ct(D,a),freightEstimate:ra(D,a)})),x=r.sortKey,h=r.sortDir;if(x&&h){const D=h==="desc"?-1:1;F.sort((y,c)=>{const P=y.rec,A=c.rec,I=et=>{var T;switch(et){case"number":return String(P[s.numberField]||"");case"order":return P.orderDate||"";case"supplier":return String(P.supplier||"");case"usd":return Number(y.totals.usd||0);case"freight":return Number(Zt(P,y.totals)||0);case"estFreight":return Number(((T=y.freightEstimate)==null?void 0:T.total)||0);case"payments":return(P.milestones||[]).length;case"transport":return String(P.transport||"");default:return""}},z=et=>{var T;switch(et){case"number":return String(A[s.numberField]||"");case"order":return A.orderDate||"";case"supplier":return String(A.supplier||"");case"usd":return Number(c.totals.usd||0);case"freight":return Number(Zt(A,c.totals)||0);case"estFreight":return Number(((T=c.freightEstimate)==null?void 0:T.total)||0);case"payments":return(A.milestones||[]).length;case"transport":return String(A.transport||"");default:return""}},_=I(x),$=z(x);return typeof _=="number"&&typeof $=="number"?(_-$)*D:String(_).localeCompare(String($))*D})}const B=n("table",{class:"table-compact"}),j=D=>{if(!r.onUpdate)return;const y=x!==D?"asc":h==="asc"?"desc":h==="desc"?null:"asc";r.onUpdate({sortKey:y?D:null,sortDir:y})},J=D=>x!==D?"â†•":h==="asc"?"â†‘":"â†“",Q=n("thead",{},[n("tr",{},[n("th",{style:"width:90px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("number")},["PO-Nr. ",J("number")])]),n("th",{style:"width:160px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("supplier")},["Lieferant ",J("supplier")])]),n("th",{style:"width:200px"},["Produkt/Items"]),n("th",{style:"width:110px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("order")},["Bestelldatum ",J("order")])]),n("th",{style:"width:180px"},["Timeline"]),n("th",{style:"width:80px",class:"num"},["StÃ¼ck"]),n("th",{style:"width:110px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("usd")},["Summe USD ",J("usd")])]),n("th",{style:"width:110px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("freight")},["Fracht (â‚¬) ",J("freight")])]),n("th",{style:"width:140px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("estFreight")},["GeschÃ¤tzte Fracht (â‚¬) ",J("estFreight")])]),n("th",{style:"width:120px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("payments")},["Zahlungen ",J("payments")])]),n("th",{style:"width:120px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>j("transport")},["Transport ",J("transport")])]),n("th",{style:"width:120px"},["Aktionen"])])]),V=n("tbody");B.append(Q,V);function S(D){const y=Array.isArray(D.milestones)?D.milestones:[],c=D.paymentLog||{};if(!y.length)return n("span",{class:"muted"},["â€”"]);const P=n("div",{class:"po-payment-badges"});return y.forEach(A=>{var $;const I=(A.label||"Z").trim(),z=I.split(" ")[0].slice(0,3),_=(($=c==null?void 0:c[A.id])==null?void 0:$.status)==="paid";P.append(n("span",{class:`po-payment-badge ${_?"is-paid":"is-open"}`,title:I},[z]))}),P}function L(D,y){const c=wt(),P=Array.isArray(c[s.entityKey])?c[s.entityKey]:[],A=P.findIndex(I=>(I==null?void 0:I.id)===D.id||(I==null?void 0:I[s.numberField])===D[s.numberField]);A>=0&&(P[A]={...P[A],archived:y},c[s.entityKey]=P,Ge(c,{source:`${s.slug}:archive`,entityKey:`${s.slug}:${D[s.numberField]||D.id}`,action:"update"}),typeof r.onUpdate=="function"&&r.onUpdate())}if(!F.length){V.append(n("tr",{},[n("td",{colspan:"12",class:"muted"},["Keine Bestellungen gefunden."])])),t.append(B);return}F.forEach(({rec:D,totals:y,freightEstimate:c})=>{const P=ts(D),A=Sa(D),I=Ea(D,a),z=`${D.transport||"sea"} Â· ${D.transitDays||0}d`,_=n("tr",{},[n("td",{class:"cell-ellipsis",title:D[s.numberField]||"â€”"},[D[s.numberField]||"â€”"]),n("td",{class:"cell-ellipsis",title:D.supplier||"â€”"},[D.supplier||"â€”"]),n("td",{class:"cell-ellipsis",title:A},[P||"â€”"]),n("td",{class:"cell-ellipsis",title:it(D.orderDate)},[it(D.orderDate)]),n("td",{class:"cell-ellipsis",title:I},[I]),n("td",{class:"cell-ellipsis num",title:String(y.units||0)},[Number(y.units||0).toLocaleString("de-DE")]),n("td",{class:"cell-ellipsis num",title:Se(y.usd)},[Se(y.usd)]),n("td",{class:"cell-ellipsis num",title:Tt(Zt(D,y))},[Tt(Zt(D,y))]),n("td",{class:"cell-ellipsis num",title:Tt((c==null?void 0:c.total)||0)},[Tt((c==null?void 0:c.total)||0)]),n("td",{class:"cell-ellipsis",title:"Zahlungen"},[S(D)]),n("td",{class:"cell-ellipsis",title:z},[z]),n("td",{class:"cell-ellipsis"},[n("div",{class:"po-table-actions"},[n("button",{class:"btn sm",type:"button",title:"Bearbeiten",onclick:()=>u(D)},["Bearbeiten"]),n("button",{class:"btn sm secondary",type:"button",title:D.archived?"Reaktivieren":"Archivieren",onclick:()=>L(D,!D.archived)},[D.archived?"Aktivieren":"Archivieren"]),n("button",{class:"btn sm danger",type:"button",title:"LÃ¶schen",onclick:()=>l(D)},["LÃ¶schen"])])])]);V.append(_)}),t.append(B)}function Ye(t,e,s,u){var x;if(!t)return;Ft(),Ee(e);const l=pe(e,Z()),r=new Map;(x=l==null?void 0:l.lines)==null||x.forEach(h=>{h.id&&r.set(h.id,h),h.sku&&r.set(`sku:${String(h.sku).toLowerCase()}`,h)}),t.innerHTML="";const a=(h,B)=>{h&&(h.classList.toggle("is-missing",B),h.title=B?"StÃ¼ckpreis fehlt im Produktstamm":"")},p=(h,B,{force:j}={})=>{if(!h||!B||h.unitCostManuallyEdited)return;const J=H(h.unitCostUsd);if(Number.isFinite(J)&&J>0&&!j){a(B,!1);return}const V=Ys(h.sku);V!=null?(h.unitCostUsd=tt(V),B.value=h.unitCostUsd,a(B,!1)):h.sku?(h.unitCostUsd="",B.value="",a(B,!0)):a(B,!1)},m=n("thead",{},[n("tr",{},[n("th",{},["SKU"]),n("th",{},["StÃ¼ck"]),n("th",{},["StÃ¼ckkosten (USD)"]),n("th",{},["Zusatz/ StÃ¼ck (USD)"]),n("th",{},["Pauschal (USD)"]),n("th",{},["Logistik / Stk. (EUR)"]),n("th",{},[""])])]),E=n("tbody"),k=n("datalist",{id:u});ft.forEach(h=>{k.append(n("option",{value:h.sku,label:h.alias?`${h.alias}`:h.sku}))}),e.items.forEach(h=>{const B=n("tr",{dataset:{itemId:h.id,unitCostManual:h.unitCostManuallyEdited?"true":"false"}}),j=h.type==="misc"?{value:h.sku||"",placeholder:"Freie Position"}:{list:u,value:h.sku||"",placeholder:"SKU"},J=n("input",j),Q=n("input",{type:"number",min:"0",step:"1",value:h.units||"0"});Q.addEventListener("input",()=>{h.units=Q.value,s()});const V=n("input",{inputmode:"decimal",value:tt(h.unitCostUsd??"0,00"),placeholder:"0,00"});p(h,V,{force:!1}),V.addEventListener("blur",()=>{h.unitCostUsd=tt(V.value),V.value=h.unitCostUsd,h.unitCostManuallyEdited=V.value!=="",B.dataset.unitCostManual=h.unitCostManuallyEdited?"true":"false",a(V,!1),s()}),V.addEventListener("input",()=>{h.unitCostUsd=V.value,h.unitCostManuallyEdited=!0,B.dataset.unitCostManual="true",a(V,!1)}),J.addEventListener("input",()=>{h.sku=J.value.trim(),s()}),J.addEventListener("change",()=>{h.sku=J.value.trim(),p(h,V,{force:!0}),s()}),J.addEventListener("blur",()=>{h.sku=J.value.trim(),p(h,V,{force:!0}),s()});const S=n("input",{inputmode:"decimal",value:tt(h.unitExtraUsd??"0,00"),placeholder:"0,00"});S.addEventListener("blur",()=>{h.unitExtraUsd=tt(S.value),S.value=h.unitExtraUsd,s()}),S.addEventListener("input",()=>{h.unitExtraUsd=S.value});const L=n("input",{inputmode:"decimal",value:tt(h.extraFlatUsd??"0,00"),placeholder:"0,00"});L.addEventListener("blur",()=>{h.extraFlatUsd=tt(L.value),L.value=h.extraFlatUsd,s()}),L.addEventListener("input",()=>{h.extraFlatUsd=L.value});const D=r.get(h.id)||r.get(`sku:${String(h.sku||"").toLowerCase()}`)||null,y=rs(D),c=n("button",{class:"btn danger",type:"button"},["âœ•"]);c.addEventListener("click",()=>{(e.items||[]).length<=1||(e.items=e.items.filter(P=>P.id!==h.id),Ye(t,e,s,u),s())}),B.append(n("td",{},[J]),n("td",{},[Q]),n("td",{},[V]),n("td",{},[S]),n("td",{},[L]),n("td",{dataset:{logisticsCell:"true"}},[y]),n("td",{},[c])),E.append(B)});const F=n("table",{class:"po-items-table"},[m,E]);t.append(F,k)}function rs(t){var E,k;const e=t==null?void 0:t.derivedLogisticsPerUnitEur,s=e!=null?At(e):"â€”",u=Ws(t),l=n("span",{class:"tooltip"},[n("button",{class:"tooltip-trigger",type:"button","aria-label":"Fracht Details"},["â„¹ï¸"]),n("span",{class:"tooltip-content"},u.map(F=>n("div",{},[F])))]),r=(E=t==null?void 0:t.issues)==null?void 0:E.includes("MISSING_LANDED_COST"),a=(k=t==null?void 0:t.issues)==null?void 0:k.includes("NEGATIVE_DERIVED_LOGISTICS"),p=r?"Einstandskosten fehlen":a?"Einstand < Warenwert (FX/EK prÃ¼fen)":"",m=p?n("span",{class:"cell-warning",title:p},["âš ï¸Ž"]):null;return n("div",{class:"po-logistics-cell"},[n("span",{class:"num"},[s]),m,l])}function va(t,e){var l;if(!t||!e)return;const s=new Map;(l=e==null?void 0:e.lines)==null||l.forEach(r=>{r.id&&s.set(r.id,r),r.sku&&s.set(`sku:${String(r.sku).toLowerCase()}`,r)}),Array.from(t.querySelectorAll("[data-item-id]")).forEach(r=>{var F;const a=r.querySelector("[data-logistics-cell]");if(!a)return;const p=r.dataset.itemId,m=r.querySelector("input"),E=((F=m==null?void 0:m.value)==null?void 0:F.trim())||"",k=s.get(p)||s.get(`sku:${E.toLowerCase()}`)||null;a.innerHTML="",a.append(rs(k))})}function te(t,e=Z()){if(!t)return null;const s=ee(t.orderDate)||null;if(!s)return null;const u=Math.max(0,Number(t.prodDays||0)),l=Math.max(0,Number(t.transitDays||0)),r=es(s,u,e),a=r.prodDone??qt(s,u),p=a,m=qt(p,l),E=ee(t.etdManual),k=ee(t.etaManual),F=E||p,x=k||m,h=Math.max(u+l+(r.adjustmentDays||0),1);return{order:s,prodDone:a,etd:F,eta:x,etdComputed:p,etaComputed:m,etdManual:E,etaManual:k,prodDays:u,transitDays:l,totalDays:h,cnyAdjustmentDays:r.adjustmentDays||0,cnyStart:r.cnyStart,cnyEnd:r.cnyEnd}}function ga(t,e,s=Z()){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return null;const u=Math.max(0,Number((e==null?void 0:e.prodDays)||0)),l=Math.max(0,Number((e==null?void 0:e.transitDays)||0)),r=Math.max(0,Number((s==null?void 0:s.defaultBufferDays)||0)),a=u+l+r;let p=Xe(t,-a);const m=es(p,u,s);return m.adjustmentDays&&(p=Xe(p,-m.adjustmentDays)),p}function ya(t,e){const s=te(t,e);return s?[`Order ${it(s.order)}`,`ETD ${it(s.etd)}`,`ETA ${it(s.eta)}`].join(" â€¢ "):"â€”"}function Ea(t,e){const s=te(t,e);return s?`ETD ${it(s.etd)} â€¢ ETA ${it(s.eta)}`:"â€”"}function Sa(t){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];return e.length?e.map(u=>{const l=(u==null?void 0:u.sku)||"",r=ft.find(a=>{var p;return((p=a==null?void 0:a.sku)==null?void 0:p.trim().toLowerCase())===String(l).trim().toLowerCase()});return r?r.alias?`${r.alias} (${r.sku})`:r.sku:l||"â€”"}).filter(Boolean).join(", "):(t==null?void 0:t.sku)||"â€”"}function Qe(t){t&&t.archived==null&&(t.archived=!1)}function ka(t){return t==="air"?"âœˆï¸":t==="rail"?"ðŸš†":"ðŸš¢"}function qn(t,e,s,u,l){if(!t||!e)return;const r=te(s,u);if(e.innerHTML="",t.innerHTML="",l&&(l.innerHTML="",l.hidden=!0),!r){e.append(n("span",{class:"muted"},["Bitte gÃ¼ltiges Bestelldatum eingeben."]));return}const a=n("div",{class:"po-timeline-summary-items"},[n("span",{class:"po-timeline-summary-item"},[n("strong",{},["Order"])," ",it(r.order)]),n("span",{class:"po-timeline-summary-item"},[n("strong",{},["ETD"])," ",it(r.etd)]),n("span",{class:"po-timeline-summary-item"},[n("strong",{},["ETA"])," ",it(r.eta)])]);if(e.append(a),l&&r.cnyAdjustmentDays>0){const P=r.cnyStart?it(r.cnyStart):"â€”",A=r.cnyEnd?it(r.cnyEnd):"â€”";l.textContent=`CNY berÃ¼cksichtigt: +${r.cnyAdjustmentDays} Tage Produktionspause. ETD/ETA angepasst. (${P} â€“ ${A})`,l.hidden=!1}const p=n("div",{class:"po-timeline-track"});p.append(n("div",{class:"po-timeline-base"}));const m=n("div",{class:"po-timeline-segments"}),E=r.totalDays,k=E?r.prodDays/E*100:0,F=E?r.transitDays/E*100:0,x=Math.max(0,Math.min(100,k)),h=Math.max(0,Math.min(100,F));if(r.prodDays>0&&m.append(n("div",{class:"po-timeline-segment production",style:`left:0%; width:${x}%`},[n("span",{class:"po-timeline-segment-icon","aria-hidden":"true"},["ðŸ­"]),n("span",{class:"sr-only"},[`Produktion ${r.prodDays} Tage`])])),r.transitDays>0){const P=x;m.append(n("div",{class:"po-timeline-segment transit",style:`left:${P}% ; width:${h}%`},[n("span",{class:"po-timeline-segment-icon","aria-hidden":"true"},[ka(s.transport)]),n("span",{class:"sr-only"},[`Transport ${r.transitDays} Tage`])]))}p.append(m);const B=n("div",{class:"po-timeline-markers"}),j=(P,A,I,z,_="")=>{const $=n("div",{class:`po-timeline-marker po-timeline-marker-${z}${_?` ${_}`:""}`,style:`left:${I}%`},[n("span",{class:"po-timeline-dot"}),n("span",{class:"po-timeline-marker-label"},[n("strong",{},[P]),n("span",{},[it(A)])])]);B.append($)};j("Order",r.order,0,"start");const J=x<=10?"start":x>=90?"end":"center";j("ETD",r.etd,x,J),j("ETA",r.eta,100,"end");const Q=new Date,V=new Date(Date.UTC(Q.getUTCFullYear(),Q.getUTCMonth(),Q.getUTCDate())),S=24*60*60*1e3,L=(V.getTime()-r.order.getTime())/S,D=Math.max(0,Math.min(r.totalDays,L)),y=r.totalDays?D/r.totalDays*100:0,c=y<=10?"start":y>=90?"end":"center";j("Heute",V,y,c,"po-timeline-marker-current"),p.append(B),t.append(p)}function Gn(t,e,s,u,l,r,a={}){const p=typeof a.showToast=="function"?a.showToast:c=>{typeof window<"u"&&window.alert&&window.alert(c)};t.innerHTML="",t.append(n("div",{class:"muted",style:"margin-bottom:6px"},["Zahlungsmeilensteine & Importkosten"])),Gt(e,r,e.milestones||[]);const m=bn(JSON.parse(JSON.stringify(e)),s,r),E=new Map(m.map(c=>[c.id,c])),k=n("table",{},[n("thead",{},[n("tr",{},[n("th",{},["Label"]),n("th",{},["%"]),n("th",{},["Anker"]),n("th",{},["Lag (Einheit)"]),n("th",{},["Datum"]),n("th",{},["Betrag (â‚¬)"]),n("th",{},["Aktion"])])])]),F=n("tbody",{});k.append(F);const x=Ct(e,r),h=x.eur||H(e.goodsEur);(e.milestones||[]).forEach((c,P)=>{const A=E.get(c.id),I=it((A==null?void 0:A.due)||(A==null?void 0:A.date)),z=(A==null?void 0:A.amount)??-(h*(ct(c.percent)/100)),_=n("tr",{dataset:{msId:c.id}},[n("td",{},[n("input",{value:c.label||"",dataset:{field:"label"},oninput:$=>{c.label=$.target.value,u()},onblur:$=>{c.label=$.target.value.trim(),u()}})]),n("td",{},[n("input",{type:"text",inputmode:"decimal",value:vt(c.percent??0),dataset:{field:"percent"},oninput:$=>{c.percent=$.target.value,u()},onblur:$=>{const et=ct($.target.value);c.percent=et,$.target.value=vt(et),u()}})]),n("td",{},[(()=>{const $=n("select",{dataset:{field:"anchor"},onchange:et=>{c.anchor=et.target.value,u()}},[n("option",{value:"ORDER_DATE"},["ORDER_DATE"]),n("option",{value:"PROD_DONE"},["PROD_DONE"]),n("option",{value:"ETD"},["ETD"]),n("option",{value:"ETA"},["ETA"])]);return $.value=c.anchor||"ORDER_DATE",$})()]),n("td",{},[n("div",{class:"lag-field"},[n("input",{type:"number",value:String(c.lagDays||0),dataset:{field:"lag"},oninput:$=>{c.lagDays=Number($.target.value||0),u()},onblur:$=>{const et=Number.isFinite(Number($.target.value))?Number($.target.value):0;$.target.value=String(et),c.lagDays=et,u()}}),n("span",{class:"muted"},["Tage"])])]),n("td",{dataset:{role:"ms-date"}},[I]),n("td",{dataset:{role:"ms-amount"}},[Tt(z)]),n("td",{},[n("button",{class:"btn danger",onclick:()=>{e.milestones.splice(P,1),u()}},["Entfernen"])])]);F.append(_)}),(e.autoEvents||[]).forEach(c=>{const P=E.get(c.id),A=c.type==="freight"?-(Zt(e,x)||0):0,I=it((P==null?void 0:P.due)||(P==null?void 0:P.date)),z=(P==null?void 0:P.amount)??A,_=c.enabled!==!1,$=c.type==="vat_refund"?Number(c.lagMonths??e.vatRefundLagMonths??r.vatRefundLagMonths??0):Number(c.lagDays||0),et=n("tr",{dataset:{msId:c.id},class:`auto-ms${_?"":" disabled"}`},[n("td",{},[n("input",{value:c.label||"",dataset:{field:"label"},oninput:T=>{c.label=T.target.value,u()},onblur:T=>{c.label=T.target.value.trim(),u()}})]),c.type==="freight"?n("td",{},[n("span",{class:"muted"},["â€”"])]):n("td",{},[n("input",{type:"text",inputmode:"decimal",value:vt(c.percent??0),dataset:{field:"percent"},oninput:T=>{c.percent=T.target.value,u()},onblur:T=>{const W=ct(T.target.value);c.percent=W,T.target.value=vt(W),u()}})]),n("td",{},[(()=>{const T=n("select",{dataset:{field:"anchor"},onchange:W=>{c.anchor=W.target.value,u()}},[n("option",{value:"ORDER_DATE"},["ORDER_DATE"]),n("option",{value:"PROD_DONE"},["PROD_DONE"]),n("option",{value:"ETD"},["ETD"]),n("option",{value:"ETA"},["ETA"])]);return T.value=c.anchor||"ETA",T})()]),n("td",{},[n("div",{class:"lag-field"},[c.type==="vat_refund"?n("input",{type:"number",min:"0",value:String($),dataset:{field:"lagMonths"},oninput:T=>{c.lagMonths=Number(T.target.value||0),u()}}):n("input",{type:"number",value:String($),dataset:{field:"lag"},oninput:T=>{c.lagDays=Number(T.target.value||0),u()},onblur:T=>{const W=Number.isFinite(Number(T.target.value))?Number(T.target.value):0;T.target.value=String(W),c.lagDays=W,u()}}),n("span",{class:"muted"},[c.type==="vat_refund"?"Monate":"Tage"])])]),n("td",{dataset:{role:"ms-date"}},[I]),n("td",{dataset:{role:"ms-amount"}},[Tt(z)]),n("td",{},[n("label",{class:"inline-checkbox"},[n("input",{type:"checkbox",checked:_,onchange:T=>{const W=T.target.checked;c.enabled=W,W?delete c._ddpEnabledBackup:c._ddpEnabledBackup=!1,u()}})," Aktiv"])])]);F.append(et)}),t.append(k);const B=n("button",{class:"btn",style:"margin-top:8px",onclick:()=>{const c=(e.milestones||[]).length,P=Math.random().toString(36).slice(2,9);e.milestones.push({id:P,label:`Milestone ${c+1}`,percent:0,anchor:"ETA",lagDays:0}),u({focusInfo:{id:P,field:"label"}})}},["+ Zahlung hinzufÃ¼gen"]);t.append(B);const j=pa(e.milestones),J=j!==100,Q=n("div",{dataset:{role:"ms-sum"},style:`margin-top:8px;font-weight:600;${J?"color:#c23636":"color:#0f9960"}`},[J?`Summe: ${j}% â€” Bitte auf 100% anpassen.`:"Summe: 100% âœ“"]);t.append(Q);const V=Jn(e,s,r,mn(e));_e(e);const S=n("div",{class:"po-payments-section"},[n("h4",{},["Zahlungen"]),n("p",{class:"muted"},["Markiere Zahlungen als bezahlt und ergÃ¤nze Ist-Daten fÃ¼r die Buchhaltung."])]),L=n("table",{class:"po-payments-table"},[n("thead",{},[n("tr",{},[n("th",{},["Typ"]),n("th",{},["FÃ¤llig am"]),n("th",{},["Geplant (EUR)"]),n("th",{},["Status"]),n("th",{},["Bezahlt am"]),n("th",{},["Ist (EUR)"]),n("th",{},["Methode"]),n("th",{},["Paid by"]),n("th",{},["Transfer"]),n("th",{},["Dateiname (Vorschlag)"]),n("th",{},["Aktion"])])])]),D=n("tbody");L.append(D);function y(c){var b;const P=typeof window<"u"&&window.__DEBUG_FORMS__===!0,A=mn(e),I=Jn(e,s,r,A),z=c?((b=e.paymentLog)==null?void 0:b[c.id])||{}:{},_=z.paymentId||(c==null?void 0:c.paymentId)||null,$=_&&A.find(w=>(w==null?void 0:w.id)===_)||null,et=($==null?void 0:$.id)||_||null,T=new Set,W=($==null?void 0:$.paidDate)||z.paidDate||new Date().toISOString().slice(0,10),bt=($==null?void 0:$.method)||z.method||"",Wt=($==null?void 0:$.payer)||z.payer||"",Yt=($==null?void 0:$.note)||z.note||"",Be=($==null?void 0:$.id)||z.paymentId||"",Ke=($==null?void 0:$.invoiceDriveUrl)||"",ke=($==null?void 0:$.invoiceFolderDriveUrl)||"",ne=n("input",{type:"date",value:W}),ut=n("select",{},[n("option",{value:""},["â€”"]),n("option",{value:"Alibaba Trade Assurance"},["Alibaba Trade Assurance"]),n("option",{value:"Wise/Transferwise"},["Wise/Transferwise"]),n("option",{value:"PayPal"},["PayPal"]),n("option",{value:"Bank Transfer"},["Bank Transfer"]),n("option",{value:"Credit Card"},["Credit Card"]),n("option",{value:"Other"},["Other"])]);bt&&!Array.from(ut.options).some(w=>w.value===bt)&&ut.append(n("option",{value:bt},[bt])),ut.value=bt;const pt=n("select",{},[n("option",{value:""},["â€”"]),n("option",{value:"Pierre"},["Pierre"]),n("option",{value:"Patrick"},["Patrick"])]);Wt&&!Array.from(pt.options).some(w=>w.value===Wt)&&pt.append(n("option",{value:Wt},[Wt])),pt.value=Wt;const $t=n("input",{type:"text",inputmode:"decimal",placeholder:"0,00"});Number.isFinite(Number($==null?void 0:$.amountActualEurTotal))?$t.value=Ze(Number($.amountActualEurTotal),2):Number.isFinite(Number(c==null?void 0:c.paidEurActual))&&($t.value=Ze(Number(c.paidEurActual),2));const yt=n("textarea",{rows:"2",placeholder:"Notiz (optional)"},[Yt]),rt=n("input",{type:"text",placeholder:"pay-..."});rt.value=Be;const Et=n("input",{type:"url",placeholder:"https://drive.google.com/..."});Et.value=Ke;const xt=n("input",{type:"url",placeholder:"https://drive.google.com/..."});xt.value=ke;const Xt=n("a",{class:"btn secondary sm",target:"_blank",rel:"noopener noreferrer"},["Open Invoice"]),se=n("a",{class:"btn secondary sm",target:"_blank",rel:"noopener noreferrer"},["Open Folder"]),Bt=n("div",{class:"po-payment-summary muted"}),Kt=n("table",{class:"table po-payment-allocation"},[n("thead",{},[n("tr",{},[n("th",{},["Event"]),n("th",{},["Geplant (EUR)"]),n("th",{},["Ist (EUR)"])])])]),Nt=n("tbody");Kt.append(Nt);function me(){Nt.innerHTML="";const w=I.filter(X=>T.has(X.id));if(!w.length){Nt.append(n("tr",{},[n("td",{colspan:"3",class:"muted"},["Bitte Events auswÃ¤hlen, um die Aufteilung zu sehen."])]));return}const R=Zn($t.value),nt=Number.isFinite(R)?Xn(R,w):null;w.forEach(X=>{const St=nt==null?void 0:nt.find(ot=>ot.eventId===X.id);Nt.append(n("tr",{},[n("td",{},[X.label]),n("td",{},[At(X.plannedEur)]),n("td",{},[St?Ze(St.actual,2):"â€”"])]))})}function zt(){const w=I.filter(nt=>T.has(nt.id)),R=w.reduce((nt,X)=>nt+Number(X.plannedEur||0),0);Bt.textContent=w.length?`AusgewÃ¤hlt: ${w.length} Events Â· Geplant ${At(R)} EUR`:"Bitte mindestens ein Event auswÃ¤hlen.",me()}const Rt=n("div",{class:"po-payment-event-list"}),De=I;Array.isArray($==null?void 0:$.coveredEventIds)&&$.coveredEventIds.forEach(w=>{w&&T.add(w)}),et&&Object.entries(e.paymentLog||{}).forEach(([w,R])=>{(R==null?void 0:R.paymentId)===et&&T.add(w)}),!T.size&&(c!=null&&c.id)&&T.add(c.id);const ae=(w,R)=>{R===!0?T.add(w):R===!1||T.has(w)?T.delete(w):T.add(w),zt(),It()};De.forEach(w=>{const R=w.status==="paid"&&w.paymentId!==et,nt=n("input",{type:"checkbox",checked:T.has(w.id),disabled:R});nt.addEventListener("change",()=>{R||ae(w.id,nt.checked)});const X=w.status==="paid"?"Bezahlt":"Offen",St=n("div",{class:`po-payment-event-row ${R?"is-disabled":""}`,role:"button",tabindex:R?"-1":"0"},[nt,n("span",{class:"po-payment-event-main"},[n("span",{class:"po-payment-event-title"},[w.label]),n("span",{class:"muted"},[`${it(w.dueDate)} Â· ${At(w.plannedEur)} EUR`])]),n("span",{class:`po-status-pill ${w.status==="paid"?"is-paid":"is-open"}`},[X]),n("span",{class:"po-transaction-pill"},[w.paymentId||"â€”"])]);St.addEventListener("click",ot=>{R||ot.target instanceof HTMLInputElement||(ae(w.id),nt.checked=T.has(w.id))}),St.addEventListener("keydown",ot=>{R||(ot.key==="Enter"||ot.key===" ")&&(ot.preventDefault(),ae(w.id),nt.checked=T.has(w.id))}),Rt.append(St)}),$t.addEventListener("input",me);const ie=()=>{const w=_t(Et.value),R=_t(xt.value),nt=w&&ye(w),X=R&&ye(R);Xt.href=nt?w:"#",se.href=X?R:"#",Xt.style.display=nt?"inline-flex":"none",se.style.display=X?"inline-flex":"none"};Et.addEventListener("input",ie),xt.addEventListener("input",ie),zt(),ie();const $e=n("div",{class:"form-error po-payment-error"},[]),Ue=n("div",{class:"form-error po-payment-field-error",dataset:{field:"events"}},[]),Le=n("div",{class:"form-error po-payment-field-error",dataset:{field:"actual"}},[]),we=n("div",{class:"form-error po-payment-field-error",dataset:{field:"paymentId"}},[]),Fe=n("div",{class:"form-error po-payment-field-error",dataset:{field:"invoiceUrl"}},[]),Mt=n("div",{class:"form-error po-payment-field-error",dataset:{field:"folderUrl"}},[]);function Ut(){return{selectedIds:Array.from(T).sort(),paidDate:ne.value||"",method:ut.value||"",paidBy:pt.value||"",actual:$t.value.trim(),paymentId:rt.value.trim(),invoiceUrl:_t(Et.value)||"",folderUrl:_t(xt.value)||"",note:yt.value.trim()}}const re=Ut();function Ht(w){$e.textContent=w||""}function Pe(){const w=I.filter(R=>T.has(R.id));return Is({selectedEvents:w,actualRaw:$t.value.trim(),invoiceUrl:_t(Et.value),folderUrl:_t(xt.value),paymentRecord:$,paymentIdValue:rt.value,mergedPayments:A})}const le=n("div",{class:"po-payment-form"},[$e,n("div",{class:"po-payment-debug muted"},["Status: bereit"]),n("label",{},["Events (mehrere mÃ¶glich)"]),Rt,Ue,Bt,n("label",{},["Bezahlt am"]),ne,n("label",{},["Methode"]),ut,n("label",{},["Paid by"]),pt,n("label",{},["Ist bezahlt (EUR)"]),$t,Le,n("label",{},["Transfer / Payment-ID"]),rt,we,n("label",{},["Invoice (GDrive URL)"]),n("div",{style:"display:flex;gap:8px;align-items:center;"},[Et,Xt]),Fe,n("label",{},["Invoice Folder (GDrive URL)"]),n("div",{style:"display:flex;gap:8px;align-items:center;"},[xt,se]),Mt,n("label",{},["Aufteilung (Preview)"]),Kt,n("label",{},["Notiz"]),yt]),ue=n("div",{class:"muted po-payment-save-hint"},[]),Te=n("button",{class:"btn",type:"button"},["Speichern"]),tn=!_&&!$;function oe(w={}){Ue.textContent=w.events||"",Le.textContent=w.actual||"",we.textContent=w.paymentId||"",Fe.textContent=w.invoiceUrl||"",Mt.textContent=w.folderUrl||"",Rt.classList.toggle("input-error",!!w.events),$t.classList.toggle("input-error",!!w.actual),rt.classList.toggle("input-error",!!w.paymentId),Et.classList.toggle("input-error",!!w.invoiceUrl),xt.classList.toggle("input-error",!!w.folderUrl)}function It(){const w=Pe(),R=!pn(Ut(),re),nt=(c==null?void 0:c.status)!=="paid",X=w.valid;return Te.disabled=!X,w.valid?!R&&!tn&&!nt?(ue.textContent="Keine Ã„nderungen",Ht("")):(ue.textContent="",Ht("")):(ue.textContent=w.reason||"Bitte Pflichtfelder ausfÃ¼llen",Ht(w.reason||"Bitte Pflichtfelder ausfÃ¼llen")),oe(w.fieldErrors||{}),{isDirty:R,validation:w}}[ne,ut,pt,$t,rt,Et,xt,yt].forEach(w=>{w.addEventListener("input",It),w.addEventListener("change",It)}),It(),Te.addEventListener("click",()=>{var St;const w=!pn(Ut(),re),R=Pe();c==null||c.status;const nt=Array.isArray(R.allocations)?R.allocations.reduce((ot,kt)=>ot+Number(kt.actual||0),0):null;if(P&&console.debug("[po-payment-modal] save click",{isDirty:w,valid:R.valid,reason:R.reason||null,allocationsSum:nt}),!R.valid){console.warn("[po-payment-modal] validation failed",{reason:R.reason||null,selectedCount:((St=R.selectedEvents)==null?void 0:St.length)||0,sumPlanned:R.sumPlanned||0}),Ht(`Speichern nicht mÃ¶glich: ${R.reason}`),oe(R.fieldErrors||{}),It();return}const X={id:R.requestedPaymentId,paidDate:ne.value||null,method:ut.value||null,payer:pt.value||null,currency:"EUR",amountActualEurTotal:R.parsedActual,coveredEventIds:R.allocations.map(ot=>ot.eventId),note:yt.value.trim()||null,invoiceDriveUrl:R.invoiceUrl||"",invoiceFolderDriveUrl:R.folderUrl||""};try{const ot=e||{},kt={...ot.paymentDrafts||{}};_&&_!==X.id&&delete kt[_],kt[X.id]=X;const mt=ot.paymentLog||{},jt={...mt},ze=new Set;_&&Object.entries(mt).forEach(([ht,Dt])=>{(Dt==null?void 0:Dt.paymentId)===_&&!T.has(ht)&&ze.add(ht)}),ze.forEach(ht=>{const Dt=(mt==null?void 0:mt[ht])||{};jt[ht]={...Dt,status:"open",paidDate:null,paymentId:null,amountActualEur:null,method:null,payer:null,note:null}}),R.allocations.forEach(ht=>{const Dt=(mt==null?void 0:mt[ht.eventId])||{},en=Dt.paymentInternalId||`payrow-${Math.random().toString(36).slice(2,9)}`;jt[ht.eventId]={...Dt,paymentInternalId:en,status:"paid",paidDate:X.paidDate,paymentId:X.id,amountActualEur:ht.actual,method:X.method,payer:X.payer,note:X.note}}),ot.paymentDrafts=kt,ot.paymentLog=jt,console.info("[po-payment-modal] payment marked as paid",{eventCount:R.allocations.length,sumPlanned:R.sumPlanned,amountActual:R.parsedActual}),u(),gt(dt)}catch(ot){console.error("[po-payment-modal] save failed",ot),p("Speichern fehlgeschlagen. Bitte erneut versuchen.")}});const dt=Oe({title:$||_?"Zahlung bearbeiten":"Zahlungen als bezahlt markieren",content:le,actions:[n("button",{class:"btn secondary",type:"button",onclick:()=>gt(dt)},["Abbrechen"]),ue,Te]})}if(V.forEach(c=>{const P=`${At(c.plannedEur)} EUR`,A=c.status==="paid"?"Bezahlt":"Offen",I=c.paidEurActual!=null?`${At(c.paidEurActual)} EUR`:"â€”",z=c.paidEurActual!=null?`Î” ${At(c.paidEurActual-c.plannedEur)} EUR`:null,_=zs(e,{status:c.status,paidDate:c.paidDate,dueDate:c.dueDate,typeLabel:c.typeLabel,eventType:c.eventType,amountActualEur:c.paidEurActual,amountPlannedEur:c.plannedEur},{poNumber:e==null?void 0:e[s.numberField],products:ft}),$=n("button",{class:"btn secondary sm",type:"button",onclick:async()=>{if(!await Qs(_)){alert("Konnte den Dateinamen nicht kopieren.");return}const W=$.textContent;$.textContent="Copied",setTimeout(()=>{$.textContent=W},1200)}},["Copy"]),et=n("tr",{dataset:{paymentId:c.id,paymentType:c.typeLabel,paymentEventType:c.eventType||""}},[n("td",{},[c.typeLabel]),n("td",{},[it(c.dueDate)]),n("td",{},[P]),n("td",{},[n("span",{class:`po-status-pill ${c.status==="paid"?"is-paid":"is-open"}`},[A])]),n("td",{},[c.paidDate?it(c.paidDate):"â€”"]),n("td",{},[I,z?n("div",{class:"muted"},[z]):null]),n("td",{},[c.method||"â€”"]),n("td",{},[c.paidBy||"â€”"]),n("td",{},[c.paymentId?n("span",{class:"po-transaction-pill"},[c.paymentId]):"â€”"]),n("td",{},[n("div",{class:"po-payment-filename"},[n("div",{class:"po-filename-suggestion"},[_||"â€”"]),$])]),n("td",{},[n("div",{style:"display:flex;gap:6px;flex-wrap:wrap;"},[n("button",{class:"btn secondary sm",type:"button",onclick:()=>y(c)},[c.status==="paid"?"Edit":"Mark as paid"]),ye(_t(c.invoiceDriveUrl))?n("a",{class:"btn secondary sm",href:_t(c.invoiceDriveUrl),target:"_blank",rel:"noopener noreferrer"},["Open Invoice"]):null,ye(_t(c.invoiceFolderDriveUrl))?n("a",{class:"btn secondary sm",href:_t(c.invoiceFolderDriveUrl),target:"_blank",rel:"noopener noreferrer"},["Open Folder"]):null])])]);D.append(et)}),V.length||D.append(n("tr",{},[n("td",{colspan:"11",class:"muted"},["Keine Zahlungen verfÃ¼gbar."])])),S.append(L),t.append(S),l&&l.id&&l.field){const c=t.querySelector(`[data-ms-id="${l.id}"] [data-field="${l.field}"]`);c&&(c.focus(),l.selectionStart!=null&&l.selectionEnd!=null&&c.setSelectionRange&&c.setSelectionRange(l.selectionStart,l.selectionEnd))}}function Pa(t,e){const s=wt();Array.isArray(s[e.entityKey])||(s[e.entityKey]=[]);const u=Z();s[e.entityKey].forEach(i=>Pt(i,u));const l=e.slug==="po",r=e.slug==="po",a={list:`${e.slug}-list`,number:`${e.slug}-number`,orderDate:`${e.slug}-order-date`,orderDateDisplay:`${e.slug}-order-date-display`,orderDatePicker:`${e.slug}-order-date-picker`,orderDateError:`${e.slug}-order-date-error`,items:`${e.slug}-items`,addItem:`${e.slug}-add-item`,goodsSummary:`${e.slug}-goods-summary`,fxRate:`${e.slug}-fx-rate`,freight:`${e.slug}-freight`,freightMode:`${e.slug}-freight-mode`,freightModeHint:`${e.slug}-freight-mode-hint`,freightPerUnit:`${e.slug}-freight-per-unit`,freightPerUnitSuggested:`${e.slug}-freight-per-unit-suggested`,freightPerUnitReset:`${e.slug}-freight-per-unit-reset`,freightPerUnitWarning:`${e.slug}-freight-per-unit-warning`,prod:`${e.slug}-prod`,transport:`${e.slug}-transport`,transit:`${e.slug}-transit`,dutyRate:`${e.slug}-duty-rate`,dutyInclude:`${e.slug}-duty-include`,eustRate:`${e.slug}-eust-rate`,fxFee:`${e.slug}-fx-fee`,vatLag:`${e.slug}-vat-lag`,vatToggle:`${e.slug}-vat-toggle`,ddp:`${e.slug}-ddp`,timeline:`${e.slug}-timeline`,timelineSummary:`${e.slug}-timeline-summary`,cnyBanner:`${e.slug}-cny-banner`,prefillBanner:`${e.slug}-prefill-banner`,etdComputed:`${e.slug}-etd-computed`,etaComputed:`${e.slug}-eta-computed`,etdManual:`${e.slug}-etd-manual`,etaManual:`${e.slug}-eta-manual`,etdReset:`${e.slug}-etd-reset`,etaReset:`${e.slug}-eta-reset`,msZone:`${e.slug}-ms-zone`,preview:`${e.slug}-preview`,save:`${e.slug}-save`,create:`${e.slug}-create`,remove:`${e.slug}-remove`,cancel:`${e.slug}-cancel`};l&&Object.assign(a,{sku:`${e.slug}-sku`,skuList:`${e.slug}-sku-list`,recent:`${e.slug}-sku-recent`,supplier:`${e.slug}-supplier`,quickLatest:`${e.slug}-quick-latest`,quickHistory:`${e.slug}-quick-history`,templateLoad:`${e.slug}-template-load`,templateSave:`${e.slug}-template-save`,quickStatus:`${e.slug}-quick-status`,productCreate:`${e.slug}-quick-create-product`,showBlocked:`${e.slug}-show-blocked`}),r&&Object.assign(a,{search:`${e.slug}-search`,archiveToggle:`${e.slug}-archive-toggle`,newButton:`${e.slug}-new`,modal:`${e.slug}-modal`,modalClose:`${e.slug}-modal-close`,status:`${e.slug}-status`,addMiscItem:`${e.slug}-add-misc-item`,meta:`${e.slug}-meta`,saveHeader:`${e.slug}-save-header`}),e.convertTo&&(a.convert=`${e.slug}-convert`);const p=`
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Header</h4>
          <span class="po-form-section-meta" id="${a.status}"></span>
        </div>
        <div id="${a.prefillBanner}" class="banner warning" hidden></div>
        ${l?`
        <div class="grid two po-quickfill">
        <div class="po-product-field">
          <label>Produkt (Alias/SKU)</label>
          <input id="${a.sku}" list="${a.skuList}" placeholder="Tippe Alias oder SKU â€¦" autocomplete="off" />
          <datalist id="${a.skuList}"></datalist>
          <div class="po-product-recent" id="${a.recent}" aria-live="polite"></div>
          <label class="inline-checkbox po-show-blocked">
            <input type="checkbox" id="${a.showBlocked}" />
            Blockierte Produkte anzeigen
          </label>
        </div>
        <div class="po-quickfill-actions">
          <div class="po-quickfill-buttons">
            <button class="btn secondary" type="button" id="${a.quickLatest}">Neueste Ã¼bernehmen</button>
            <button class="btn" type="button" id="${a.quickHistory}">Aus Historie wÃ¤hlen</button>
            <button class="btn secondary" type="button" id="${a.templateLoad}">Template laden</button>
            <button class="btn secondary" type="button" id="${a.templateSave}">Als Template speichernâ€¦</button>
            <button class="btn tertiary" type="button" id="${a.productCreate}">Neues Produkt anlegen</button>
          </div>
          <p class="po-quickfill-status" id="${a.quickStatus}" aria-live="polite"></p>
        </div>
        </div>
        `:""}
        <div class="grid ${l?"three":"two"}">
        <div>
          <label>${e.numberLabel}</label>
          <input id="${a.number}" placeholder="${e.numberPlaceholder}" />
        </div>
        <div>
          <label>Bestelldatum</label>
          <div class="po-date-picker">
            <input
              id="${a.orderDateDisplay}"
              placeholder="TT.MM.JJJJ"
              inputmode="numeric"
              aria-describedby="${a.orderDateError}"
            />
            <button type="button" class="btn tertiary" id="${a.orderDate}-picker-btn" aria-label="Datum auswÃ¤hlen">ðŸ“…</button>
            <input id="${a.orderDate}" type="date" aria-hidden="true" tabindex="-1" class="sr-only" />
          </div>
          <div id="${a.orderDateError}" class="form-error" role="alert"></div>
        </div>
        ${l?`
        <div>
          <label>Lieferant</label>
          <input id="${a.supplier}" placeholder="z. B. Ningbo Trading" />
        </div>
        `:""}
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Positionen</h4>
        </div>
        <div class="po-items-card">
          <div class="po-items-card-header">
            <h4>Artikel</h4>
            <div class="po-table-actions">
              <button class="btn sm" type="button" id="${a.addItem}">+ SKU Position</button>
              ${r?`<button class="btn sm secondary" type="button" id="${a.addMiscItem}">+ Freie Position</button>`:""}
            </div>
          </div>
          <div id="${a.items}"></div>
        </div>
        <div class="po-goods-summary" id="${a.goodsSummary}">Summe Warenwert: 0,00 â‚¬ (0,00 USD)</div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Timeline / Termine</h4>
        </div>
        <div class="grid two" style="margin-top:12px">
        <div>
          <label>FX-Kurs (USD je EUR)</label>
          <input id="${a.fxRate}" placeholder="z. B. 1,08" inputmode="decimal" />
        </div>
        </div>
        <div class="grid two" style="margin-top:12px">
        <div>
          <label>Fracht (Eingabeart)</label>
          <select id="${a.freightMode}">
            <option value="TOTAL_EUR">Gesamtbetrag (â‚¬)</option>
            <option value="PER_UNIT_EUR">Pro StÃ¼ck (â‚¬)</option>
            <option value="AUTO_FROM_LANDED">Auto (aus Einstandskosten)</option>
          </select>
          <p class="muted" id="${a.freightModeHint}" hidden>Berechnung: Einstandskosten (EUR/Stk) âˆ’ Warenwert (USD Ã· FX). Fehlende Einstandskosten werden markiert.</p>
        </div>
        <div>
          <label>Fracht gesamt (â‚¬)</label>
          <input id="${a.freight}" placeholder="z. B. 4.800,00" />
        </div>
        <div>
          <label>Logistik / Stk. (EUR)</label>
          <input id="${a.freightPerUnit}" placeholder="z. B. 1,25" />
          <div class="po-suggested-row">
            <span class="muted" id="${a.freightPerUnitSuggested}"></span>
            <button class="btn ghost" type="button" id="${a.freightPerUnitReset}">Reset</button>
          </div>
          <small class="form-error" id="${a.freightPerUnitWarning}"></small>
        </div>
        <div>
          <label>Produktionstage</label>
          <input id="${a.prod}" type="number" value="60" />
        </div>
        <div>
          <label>Transport</label>
          <select id="${a.transport}">
            <option value="sea">Sea</option>
            <option value="rail">Rail</option>
            <option value="air">Air</option>
          </select>
        </div>
        <div>
          <label>Transit-Tage</label>
          <input id="${a.transit}" type="number" value="60" />
        </div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div>
          <label>Zollsatz (%)</label>
          <input id="${a.dutyRate}" placeholder="z. B. 6,5" />
          <label class="inline-checkbox"><input type="checkbox" id="${a.dutyInclude}" /> Fracht einbeziehen</label>
        </div>
        <div>
          <label>EUSt (%)</label>
          <input id="${a.eustRate}" placeholder="z. B. 19" />
        </div>
        <div>
          <label>FX-GebÃ¼hr (%)</label>
          <input id="${a.fxFee}" placeholder="z. B. 0,5" />
        </div>
        <div>
          <label>EUSt-Erstattung (Monate)</label>
          <input id="${a.vatLag}" type="number" min="0" step="1" />
          <label class="inline-checkbox"><input type="checkbox" id="${a.vatToggle}" /> Erstattung aktiv</label>
        </div>
        <div class="checkbox-line">
          <label><input type="checkbox" id="${a.ddp}" /> DDP (Importkosten enthalten)</label>
        </div>
        </div>
        <div class="po-timeline-card">
          <div class="po-timeline-card-header">
            <h4>PO Timeline</h4>
            <div id="${a.timelineSummary}" class="po-timeline-summary"></div>
          </div>
          <div class="po-timeline-dates">
            <div class="po-timeline-date">
              <span class="muted">Berechnet ETD</span>
              <strong id="${a.etdComputed}">â€”</strong>
            </div>
            <div class="po-timeline-date">
              <span class="muted">Berechnet ETA</span>
              <strong id="${a.etaComputed}">â€”</strong>
            </div>
            <div class="po-timeline-date">
              <label>ETD Override</label>
              <div class="po-timeline-input-row">
                <input id="${a.etdManual}" type="date" />
                <button class="btn sm" type="button" id="${a.etdReset}">Reset</button>
              </div>
            </div>
            <div class="po-timeline-date">
              <label>ETA Override</label>
              <div class="po-timeline-input-row">
                <input id="${a.etaManual}" type="date" />
                <button class="btn sm" type="button" id="${a.etaReset}">Reset</button>
              </div>
            </div>
          </div>
          <div id="${a.cnyBanner}" class="banner warning" hidden></div>
          <div id="${a.timeline}" class="po-timeline-track-wrapper"></div>
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Zahlungsplan & Importkosten</h4>
        </div>
        <div id="${a.msZone}" style="margin-top:10px"></div>
      </div>
      <div class="po-sticky-footer">
        <div class="po-sticky-actions">
          <button class="btn primary sm" id="${a.save}">Speichern</button>
          <button class="btn sm" id="${a.cancel}">SchlieÃŸen</button>
          <button class="btn sm" id="${a.create}">${e.newButtonLabel}</button>
          ${e.convertTo?`<button class="btn secondary sm" id="${a.convert}">${e.convertTo.buttonLabel||"In PO umwandeln"}</button>`:""}
          <button class="btn danger sm" id="${a.remove}">LÃ¶schen</button>
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Ereignisse / Ledger</h4>
        </div>
        <div id="${a.preview}" class="po-event-preview"></div>
      </div>
  `,m=r?`
      <section class="card po-form-card">
        <div class="po-form-modal-header">
          <div>
            <h3>${e.formTitle}</h3>
            <div class="po-form-modal-meta" id="${a.meta}"></div>
          </div>
          <div class="po-table-actions">
            <button class="btn primary sm" type="button" id="${a.saveHeader}">Speichern</button>
            <button class="btn ghost" type="button" id="${a.modalClose}" aria-label="SchlieÃŸen">âœ•</button>
          </div>
        </div>
        ${p}
      </section>
    `:`
      <section class="card">
        <h3>${e.formTitle}</h3>
        ${p}
      </section>
    `;t.innerHTML=r?`
      <section class="card po-list-card">
        <div class="po-list-toolbar">
          <div>
            <h2>${e.listTitle}</h2>
          </div>
          <div class="po-list-actions">
            <input id="${a.search}" placeholder="Suche PO-Nr., SKU, Alias, Supplier" />
            <label class="po-archive-toggle">
              <input type="checkbox" id="${a.archiveToggle}" />
              Archiviert
            </label>
            <button class="btn primary" type="button" id="${a.newButton}">+ Neue PO</button>
          </div>
        </div>
        <div id="${a.list}" class="po-table-wrap"></div>
      </section>
      <div class="po-form-modal" id="${a.modal}" aria-hidden="true">
        <div class="po-form-modal-panel">
          ${m}
        </div>
      </div>
    `:`
      <section class="card">
        <h2>${e.listTitle}</h2>
        <div id="${a.list}"></div>
      </section>
      ${m}
    `;const E=C(`#${a.list}`,t),k=r?C(`#${a.search}`,t):null,F=r?C(`#${a.archiveToggle}`,t):null,x=r?C(`#${a.newButton}`,t):null,h=r?C(`#${a.modal}`,t):null,B=r&&h?h.querySelector(".po-form-modal-panel"):null,j=r?C(`#${a.modalClose}`,t):null,J=r?C(`#${a.status}`,t):null,Q=r?C(`#${a.meta}`,t):null,V=r?C(`#${a.saveHeader}`,t):null,S=C(`#${a.prefillBanner}`,t),L=l?C(`#${a.sku}`,t):null,D=l?C(`#${a.skuList}`,t):null,y=l?C(`#${a.supplier}`,t):null,c=l?C(`#${a.quickLatest}`,t):null,P=l?C(`#${a.quickHistory}`,t):null,A=l?C(`#${a.productCreate}`,t):null,I=l?C(`#${a.templateLoad}`,t):null,z=l?C(`#${a.templateSave}`,t):null,_=l?C(`#${a.quickStatus}`,t):null,$=l?C(`#${a.showBlocked}`,t):null,et=C(`#${a.number}`,t),T=C(`#${a.orderDate}`,t),W=C(`#${a.orderDateDisplay}`,t),bt=C(`#${a.orderDateError}`,t),Wt=C(`#${a.orderDate}-picker-btn`,t),Yt=C(`#${a.items}`,t),Be=C(`#${a.addItem}`,t),Ke=r?C(`#${a.addMiscItem}`,t):null,ke=`${a.items}-dl`,ne=C(`#${a.goodsSummary}`,t),ut=C(`#${a.fxRate}`,t),pt=C(`#${a.freightMode}`,t),$t=C(`#${a.freightModeHint}`,t),yt=C(`#${a.freight}`,t),rt=C(`#${a.freightPerUnit}`,t),Et=C(`#${a.freightPerUnitSuggested}`,t),xt=C(`#${a.freightPerUnitReset}`,t),Xt=C(`#${a.freightPerUnitWarning}`,t),se=C(`#${a.prod}`,t),Bt=C(`#${a.transport}`,t),Kt=C(`#${a.transit}`,t),Nt=C(`#${a.dutyRate}`,t),me=C(`#${a.dutyInclude}`,t),zt=C(`#${a.eustRate}`,t),Rt=C(`#${a.fxFee}`,t),De=C(`#${a.vatLag}`,t),ae=C(`#${a.vatToggle}`,t),ie=C(`#${a.ddp}`,t),$e=C(`#${a.timeline}`,t),Ue=C(`#${a.timelineSummary}`,t),Le=C(`#${a.cnyBanner}`,t),we=C(`#${a.etdComputed}`,t),Fe=C(`#${a.etaComputed}`,t),Mt=C(`#${a.etdManual}`,t),Ut=C(`#${a.etaManual}`,t),re=C(`#${a.etdReset}`,t),Ht=C(`#${a.etaReset}`,t),Pe=C(`#${a.msZone}`,t),le=C(`#${a.save}`,t),ue=C(`#${a.cancel}`,t),Te=C(`#${a.create}`,t),tn=C(`#${a.remove}`,t),oe=C(`#${a.preview}`,t),It=a.convert?C(`#${a.convert}`,t):null;let dt=On(Kn(ve(e,Z()),Z()),{key:`${e.slug}:new`,enableDraftCache:!0}),b=dt.draft,w=JSON.parse(JSON.stringify(b));const R=Us(()=>dt.isDirty,"Ungespeicherte Ã„nderungen verwerfen?");R.register(),R.attachBeforeUnload();let nt=!1;const X=r?{searchTerm:"",showArchived:!1,sortKey:null,sortDir:null}:null;let St=!1;function ot(i){if(!i)return"";const d=i.alias||i.sku||"Produkt",o=i.sku||"",f=i.supplierId?` â€¢ ${i.supplierId}`:"";return`${d} â€“ ${o}${f}`}function kt(i){const d=String(i||"").trim().toLowerCase(),o=d.split("â€¢")[0].trim();return d&&ft.find(f=>{if(!f||!f.sku)return!1;const g=String(f.alias||"").trim().toLowerCase(),v=String(f.sku||"").trim().toLowerCase(),U=`${g} â€“ ${v}`,N=f.supplierId?`${U} â€¢ ${String(f.supplierId).trim().toLowerCase()}`:null;return!!(d===U.toLowerCase()||o===U.toLowerCase()||N&&d===N||g&&(d===g||o===g)||v&&(d===v||o===v))})||null}function mt(i){const d=kt(i);return d?d.sku:String(i||"").trim()}function jt(i){!l||!L||(i?(L.value=ot(i),L.dataset.sku=i.sku,y&&!b.supplier&&i.supplierId&&(y.value=i.supplierId,b.supplier=i.supplierId)):L.dataset.sku="")}function ze(){if(!l)return;const i=C(`#${a.recent}`,t);if(!i)return;const d=ws();if(i.innerHTML="",!d.length){i.append(n("span",{class:"muted"},["Zuletzt genutzte Produkte erscheinen hier."]));return}d.forEach(o=>{const f=n("button",{type:"button",class:"chip",onclick:()=>{jt(o),b.sku=o.sku,Jt(),nt=!1,Vt(o),ce()}},[o.alias?`${o.alias} (${o.sku})`:o.sku]);i.append(f)})}function ht(i){_&&(_.textContent=i||"")}function Dt(i=[],d="Hinweise"){if(!S)return;if(!i.length){S.hidden=!0,S.innerHTML="";return}const o=i.map(f=>`<li>${f}</li>`).join("");S.innerHTML=`<strong>${d}</strong><ul>${o}</ul>`,S.hidden=!1}function en(i){var o,f,g;if(!i)return[];const d=[];return(o=i.blockingMissing)!=null&&o.length&&d.push(`Pflichtfelder fehlen: ${i.blockingMissing.map(v=>v.label).join(", ")}`),(f=i.defaulted)!=null&&f.length&&d.push(`Defaults aktiv: ${i.defaulted.map(v=>v.label).join(", ")}`),(g=i.suggestedMissing)!=null&&g.length&&d.push(`Empfohlen: ${i.suggestedMissing.map(v=>v.label).join(", ")}`),d}function nn(i){if(_){_.textContent=i;return}let d=document.getElementById(`${e.slug}-toast`);d||(d=document.createElement("div"),d.id=`${e.slug}-toast`,d.className="po-toast",document.body.appendChild(d)),d.textContent=i,d.hidden=!1,setTimeout(()=>{d.hidden=!0},2e3)}function ls(){const i=Z(),d=JSON.parse(JSON.stringify(b));be(i,d);const o=!pn(d,w);return o?(b=d,dt.setDraft(b)):dt.setDraft(w),o}function us(i){Cn({title:"Ungespeicherte Ã„nderungen",message:"Ungespeicherte Ã„nderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:i})}function os(i){if(!i)return"unbekannt";const d=new Date(i);return Number.isNaN(d.getTime())?"unbekannt":d.toLocaleString("de-DE",{dateStyle:"medium",timeStyle:"short"})}function sn(i){const d=(i==null?void 0:i[e.numberField])||(i==null?void 0:i.id)||"new";return`${e.slug}:${d}`}function an(){if(!r||!h)return;h.classList.add("is-open"),h.setAttribute("aria-hidden","false");const i=h.querySelector("input, select, textarea, button");i&&i.focus()}function He(){!r||!h||(h.classList.remove("is-open"),h.setAttribute("aria-hidden","true"))}function je({reset:i}={}){if(!r)return;if(!ls()){i&&Ot(w||b),He();return}R({confirmWithModal:({onConfirm:o})=>us(o),onConfirm:()=>{i&&Ot(w||b),He()}})}let Je=!1;B&&(B.addEventListener("mousedown",()=>{Je=!0}),window.addEventListener("mouseup",()=>{Je&&setTimeout(()=>{Je=!1},0)}));function xe(){return wt()}function rn(){const i=xe();return Array.isArray(i[e.entityKey])||(i[e.entityKey]=[]),i[e.entityKey]}function de(i,d=null){const o=i||rn();r&&d&&(Object.prototype.hasOwnProperty.call(d,"sortKey")&&(X.sortKey=d.sortKey),Object.prototype.hasOwnProperty.call(d,"sortDir")&&(X.sortDir=d.sortDir));const f=r?{...X,onUpdate:g=>de(null,g)}:void 0;ha(E,o,e,Pn,Tn,f)}function vn(i){const d=Z();return(i||[]).map(o=>{const f=JSON.parse(JSON.stringify(o));return Pt(f,d),Gt(f,d,f.milestones||[]),f})}function gn(i){const d=ee(i);return d?d.getTime():0}function he(i,d,o=10){if(!i)return[];const f=i.trim().toLowerCase(),g=d?d.trim().toLowerCase():null,v=rn().filter(U=>{const N=((U==null?void 0:U.sku)||"").trim().toLowerCase(),O=Array.isArray(U==null?void 0:U.items)?U.items.some(M=>((M==null?void 0:M.sku)||"").trim().toLowerCase()===f):!1;return!N&&!O||N&&N!==f&&!O?!1:g?((U==null?void 0:U.supplier)||"").trim().toLowerCase()===g:!0});return v.sort((U,N)=>gn(N.orderDate)-gn(U.orderDate)),v.slice(0,o)}function yn(i,d){if(!i)return null;const o=d?he(i,d,1):[];if(o.length)return o[0];const f=he(i,null,1);return f.length?f[0]:null}function ds(){const i=xe();return Array.isArray(i.poTemplates)||(i.poTemplates=[]),i.poTemplates}function cs(i,d){if(!i)return[];const o=i.trim().toLowerCase(),f=d?d.trim().toLowerCase():null;return ds().filter(g=>{if(!g||!g.sku||String(g.sku).trim().toLowerCase()!==o)return!1;if(g.scope==="SKU_SUPPLIER"){const U=(g.supplier||"").trim().toLowerCase();return f?U===f:!1}return g.scope==="SKU"}).sort((g,v)=>new Date(v.updatedAt||0)-new Date(g.updatedAt||0))}function Ve(i,d){if(!i)return[];const o=[],f=ft.find(v=>v&&v.sku&&v.sku.trim().toLowerCase()===i.trim().toLowerCase());if(f&&f.template){const v=f.template.scope==="SKU_SUPPLIER"?"SKU_SUPPLIER":"SKU",U=(f.template.supplierId||f.supplierId||"").trim().toLowerCase(),N=(d||"").trim().toLowerCase();(v==="SKU_SUPPLIER"?N&&U===N:!0)&&o.push({id:`product-${f.sku}-${v}`,name:f.template.name||(v==="SKU_SUPPLIER"?"Produkt-Template (SKU+Supplier)":"Produkt-Template (SKU)"),scope:v,source:"product",template:f.template})}return cs(i,d).forEach(v=>{o.push({id:v.id,name:v.name||(v.scope==="SKU_SUPPLIER"?"Legacy (SKU+Supplier)":"Legacy (SKU)"),scope:v.scope,source:"legacy",template:v})}),o}function fs(){!l||!D||(Ft(),D.innerHTML="",ft.filter(i=>i&&i.status!=="inactive").filter(i=>St?!0:In(i,{state:xe()}).status!=="blocked").forEach(i=>{D.append(n("option",{value:ot(i)}))}))}function Jt(){var g;if(!l)return;fs(),ze();const i=mt((L==null?void 0:L.value)||b.sku||""),d=((g=y==null?void 0:y.value)==null?void 0:g.trim())||"",o=yn(i,d),f=Ve(i,d);if(c&&(c.disabled=!o&&f.length===0,o?c.title=`Werte aus ${e.entityLabel} ${o[e.numberField]||"â€”"} Ã¼bernehmen`:f.length?c.title=`Werte aus ${f[0].name} Ã¼bernehmen`:c.title="Keine Produktvorlage oder VorgÃ¤nger-POs fÃ¼r diese SKU"),P){const v=i&&(he(i,d).length>0||!d&&he(i,null).length>0);P.disabled=!v,P.title=v?"":"Keine VorgÃ¤nger-POs fÃ¼r diese SKU"}if(I){const v=Ve(i,d);I.disabled=v.length===0,I.title=v.length?"":"Kein Template verfÃ¼gbar"}}function qe(i,d){var v,U;if(!i)return;const o=Z(),f=jn(b,i);if(l){const N=(((v=L==null?void 0:L.value)==null?void 0:v.trim())||i.sku||"").trim(),O=(((U=y==null?void 0:y.value)==null?void 0:U.trim())||i.supplier||"").trim();f.sku=mt(N),f.supplier=O}Pt(f,o),Gt(f,o,f.milestones||[]),Ot(f);const g=mt(f.sku);if(g){const N=kt(g)||ft.find(O=>O&&O.sku&&O.sku.trim().toLowerCase()===g.trim().toLowerCase());N&&(jt(N),Ce(N.sku))}d&&ht(d)}function ps(i,d){if(!d)return;if(d.innerHTML="",!i.length){d.append(n("p",{class:"muted"},["Keine Unterschiede zum aktuellen Formular."]));return}const o=n("dl",{class:"po-diff-list"});i.forEach(f=>{o.append(n("dt",{},[f.label]),n("dd",{},[f.type==="list"?`Anzahl ${f.before} â†’ ${f.after}`:`${f.before} â†’ ${f.after}`]))}),d.append(o)}function ms(){var K;if(!l)return;const i=mt((L==null?void 0:L.value)||b.sku||"");if(!i){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const d=((K=y==null?void 0:y.value)==null?void 0:K.trim())||"";let o=he(i,d),f=!0;if(!o.length&&d&&(o=he(i,null),f=!1),!o.length){window.alert("Keine VorgÃ¤nger-POs fÃ¼r diese SKU gefunden.");return}const g=n("tbody"),v=n("div",{class:"po-history-diff"}),U=n("div",{class:"po-history"},[n("p",{class:"muted"},[f?"Sortiert nach Datum (neueste zuerst).":"Keine passende Lieferantenhistorie â€“ zeige jÃ¼ngste POs dieser SKU."]),n("table",{class:"po-history-table"},[n("thead",{},[n("tr",{},[n("th",{},["PO-Nr."]),n("th",{},["Bestelldatum"]),n("th",{},["StÃ¼ckzahl"]),n("th",{},["StÃ¼ckpreis (USD)"]),n("th",{},["Produktionstage"]),n("th",{},["Transit-Tage"]),n("th",{},["Transport"]),n("th",{},["Fracht (â‚¬)"]),n("th",{},["Zoll %"]),n("th",{},["EUSt %"]),n("th",{},["FX-Fee %"]),n("th",{},["Aktionen"])])]),g]),v]),N=Oe({title:`Historie fÃ¼r ${i}`,content:U,actions:[]}),O=N.querySelector(".po-modal-actions");O&&(O.innerHTML="",O.append(n("button",{class:"btn",type:"button",onclick:()=>gt(N)},["Abbrechen"])));const st=Z(),M=JSON.parse(JSON.stringify(b));Pt(M,st),Gt(M,st,M.milestones||[]),o.slice(0,10).forEach((G,at)=>{const Y=vn([G])[0],Lt=n("button",{class:"btn secondary",type:"button"},["Vergleichen"]),lt=n("button",{class:"btn primary",type:"button"},["Ãœbernehmen"]);lt.addEventListener("click",()=>{gt(N),qe(Y,`Werte aus ${e.entityLabel} ${G[e.numberField]||""} Ã¼bernommen. Du kannst alles anpassen.`)}),Lt.addEventListener("click",()=>{const Me=jn(M,Y),Ae=ia(M,Me);ps(Ae,v)});const Ne=Tt(Zt(Y,Ct(Y,st)));g.append(n("tr",{class:at===0?"po-history-latest":""},[n("td",{},[G[e.numberField]||"â€”"]),n("td",{},[it(G.orderDate)]),n("td",{},[Number(H(Y.units||G.units||0)||0).toLocaleString("de-DE")]),n("td",{},[Se(H(Y.unitCostUsd||G.unitCostUsd||0))]),n("td",{},[String(G.prodDays||0)]),n("td",{},[String(G.transitDays||0)]),n("td",{},[G.transport||"â€”"]),n("td",{},[Ne]),n("td",{},[`${vt(Y.dutyRatePct??G.dutyRatePct??0)} %`]),n("td",{},[`${vt(Y.eustRatePct??G.eustRatePct??0)} %`]),n("td",{},[`${vt(Y.fxFeePct??G.fxFeePct??0)} %`]),n("td",{class:"po-history-actions"},[Lt,lt])]))})}function hs(){var O;if(!l)return;const i=mt((L==null?void 0:L.value)||b.sku||"");if(!i){window.alert("Bitte zuerst eine SKU eingeben.");return}const d=((O=y==null?void 0:y.value)==null?void 0:O.trim())||"";Ft();const o=n("input",{type:"text",placeholder:"z. B. Standardbestellung"}),f=n("select",{},[n("option",{value:"SKU"},["SKU"]),n("option",{value:"SKU_SUPPLIER"},["SKU+Supplier"])]);d||(f.value="SKU");const g=n("div",{class:"po-template-fields"});sa.forEach(st=>{const M=n("input",{type:"checkbox",value:st.key,id:`tpl-${st.key}`});st.key!=="autoEvents"&&(M.checked=!0);const K=n("label",{for:`tpl-${st.key}`},[st.label]),G=n("div",{class:"po-template-field"},[M,K]);g.append(G)});const v=n("div",{class:"po-template-form"},[n("label",{},["Name"]),o,n("label",{style:"margin-top:12px"},["Geltungsbereich"]),f,n("p",{class:"muted"},["Welche Felder Ã¼bernehmen?"]),g]),U=Oe({title:"Als Template speichern",content:v,actions:[]}),N=U.querySelector(".po-modal-actions");if(N){N.innerHTML="";const st=n("button",{class:"btn",type:"button",onclick:()=>gt(U)},["Abbrechen"]),M=n("button",{class:"btn primary",type:"button"},["Speichern"]);M.addEventListener("click",()=>{const K=Array.from(g.querySelectorAll("input[type=checkbox]:checked")).map(lt=>lt.value);if(!K.length){window.alert("Bitte mindestens ein Feld auswÃ¤hlen.");return}const G=f.value==="SKU_SUPPLIER"&&d?"SKU_SUPPLIER":"SKU",at={scope:G,supplierId:G==="SKU_SUPPLIER"?d:"",name:o.value.trim()||(G==="SKU_SUPPLIER"?"Standard (SKU+Supplier)":"Standard (SKU)"),fields:{},updatedAt:new Date().toISOString()};K.forEach(lt=>{lt==="milestones"?at.fields[lt]=ss(b.milestones||[]):lt==="autoEvents"?at.fields[lt]=as(b.autoEvents||[]):at.fields[lt]=b[lt]});const Y=ft.find(lt=>lt&&lt.sku&&lt.sku.trim().toLowerCase()===i.trim().toLowerCase()),Lt={sku:i,alias:(Y==null?void 0:Y.alias)||i,supplierId:(Y==null?void 0:Y.supplierId)||"",status:(Y==null?void 0:Y.status)||"active",tags:(Y==null?void 0:Y.tags)||[],template:at};Y!=null&&Y.sku&&(Lt.originalSku=Y.sku),An(Lt),Ce(i),Ft(),Jt(),ht(`Template â€ž${at.name}â€œ gespeichert.`),gt(U)}),N.append(st,M)}}function En(i){if(!i||!i.template)return;const d=i.template.fields?JSON.parse(JSON.stringify(i.template.fields)):JSON.parse(JSON.stringify(i.template));qe(d,`Template â€ž${i.name}â€œ geladen. Du kannst alles anpassen.`)}function bs(i){let d;const o=n("div",{class:"po-template-picker"});i.forEach(g=>{const v=g.scope==="SKU_SUPPLIER"?"SKU+Supplier":"SKU",U=n("div",{class:"po-template-row"},[n("div",{class:"po-template-info"},[n("strong",{},[g.name||"Template"]),n("span",{class:"muted"},[`${v} â€¢ ${g.source==="product"?"Produkt":"Legacy"}`])]),n("div",{class:"po-template-actions"},[n("button",{class:"btn",type:"button",onclick:()=>{En(g),gt(d)}},["Ãœbernehmen"])])]);o.append(U)}),d=Oe({title:"Template wÃ¤hlen",content:o,actions:[]});const f=d.querySelector(".po-modal-actions");f&&(f.innerHTML="",f.append(n("button",{class:"btn",type:"button",onclick:()=>gt(d)},["Abbrechen"])))}function vs(){var f;if(!l)return;const i=mt((L==null?void 0:L.value)||b.sku||"");if(!i){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const d=((f=y==null?void 0:y.value)==null?void 0:f.trim())||"";Ft();const o=Ve(i,d);if(!o.length){window.alert("Kein Template verfÃ¼gbar.");return}if(o.length===1){En(o[0]);return}bs(o)}function gs(){Ft();const i=n("form",{class:"po-product-create"}),d=n("input",{required:!0,placeholder:"SKU"}),o=n("input",{required:!0,placeholder:"Alias"}),f=n("input",{placeholder:"Supplier"});i.append(n("label",{},["SKU",d]),n("label",{},["Alias",o]),n("label",{},["Supplier",f]));const g=Oe({title:"Neues Produkt anlegen",content:i,actions:[]}),v=g.querySelector(".po-modal-actions");if(v){const U=n("button",{class:"btn",type:"button",onclick:()=>gt(g)},["Abbrechen"]),N=n("button",{class:"btn primary",type:"button"},["Speichern"]);N.addEventListener("click",()=>{const O=d.value.trim(),st=o.value.trim();if(!O||!st){window.alert("Bitte SKU und Alias angeben.");return}try{if(An({sku:O,alias:st,supplierId:f.value.trim(),status:"active",tags:[]}),Ce(O),Ft(),L){const M=ft.find(K=>K&&K.sku&&K.sku.trim().toLowerCase()===O.trim().toLowerCase());M&&(jt(M),b.sku=M.sku,Jt(),ce())}gt(g),ht("Produkt angelegt.")}catch(M){window.alert(M.message||String(M))}}),v.innerHTML="",v.append(U,N)}}function ln(i){const d=JSON.parse(JSON.stringify(b));be(i,d);const o=JSON.parse(JSON.stringify(d));Pt(o,i);const f=bn(o,e,i);oe.innerHTML="",oe.append(n("h4",{},["Ereignisse"])),oe.append(ma(f,b.paymentLog,mn(b)))}function Sn(i){we&&(we.textContent=it(i==null?void 0:i.etdComputed)),Fe&&(Fe.textContent=it(i==null?void 0:i.etaComputed)),re&&(re.disabled=!b.etdManual),Ht&&(Ht.disabled=!b.etaManual)}function ce(){const i=(b.milestones||[]).reduce((f,g)=>f+ct(g.percent||0),0),d=!l||L&&L.value.trim()!==""||(b.items||[]).some(f=>f.sku),o=Math.round(i*10)/10===100&&et.value.trim()!==""&&Ct(b,Z()).usd>0&&!!T.value&&d;le.disabled=!o||!dt.isDirty,It&&(It.disabled=!o),on()}function kn(i){[le,V].forEach(d=>{d&&(d.dataset.label||(d.dataset.label=d.textContent),d.textContent=i?"Speichernâ€¦":d.dataset.label,d.disabled=i||d.disabled)})}async function un(){le.disabled||(kn(!0),await Fn(),kn(!1),ce())}function on(){if(!J)return;const i=b.archived?"Status: Archiviert":"Status: Aktiv";J.textContent=dt.isDirty?`${i} â€¢ Ungespeichert`:i}function Dn(i,d){if(!ne)return;const o=Tt(i.eur||0),f=Se(i.usd||0),g=We(i.fxRate),v=d||pe(b,Z()),U=Tt((v==null?void 0:v.estimatedFreightEur)||0),N=(v==null?void 0:v.mode)==="AUTO_FROM_LANDED"&&(v!=null&&v.missingLandedCount)?` Â· Einstandskosten fehlen (${v.missingLandedCount})`:"";ne.textContent=g?`Summe Warenwert: ${o} (${f} Ã· FX ${g}) Â· GeschÃ¤tzte Fracht (EUR): ${U}${N}`:`Summe Warenwert: ${o} (${f}) Â· GeschÃ¤tzte Fracht (EUR): ${U}${N}`}function $n(){if(!pt||!yt||!rt)return;const i=pt.value||"TOTAL_EUR",d=i==="AUTO_FROM_LANDED";yt.disabled=i==="PER_UNIT_EUR"||d,rt.disabled=i!=="PER_UNIT_EUR"||d,$t&&($t.hidden=!d)}function ys(i,d){var U;const o=H((ut==null?void 0:ut.value)??"");if(Number.isFinite(o)&&o>0)return o;const f=(U=i==null?void 0:i.template)!=null&&U.fields?i.template.fields:i==null?void 0:i.template,g=H((i==null?void 0:i.fxUsdPerEur)??(f==null?void 0:f.fxRate)??"");if(Number.isFinite(g)&&g>0)return g;const v=typeof d.fxRate=="number"?d.fxRate:H(d.fxRate);return Number.isFinite(v)&&v>0?v:null}function Es(i,d){var N;if(!i)return{value:null,warning:!1,missingFields:[]};const o=H(i.logisticsPerUnitEur??i.freightPerUnitEur);if(Number.isFinite(o)&&o>0)return{value:o,warning:!1,missingFields:[]};const f=(N=i.template)!=null&&N.fields?i.template.fields:i.template,g=H((f==null?void 0:f.unitPriceUsd)??i.unitPriceUsd??""),v=H(i.landedUnitCostEur??i.landedCostEur??""),U=ys(i,d);return Wn({unitPriceUsd:g,landedCostEur:v,fxUsdPerEur:U})}function Vt(i,{force:d=!1}={}){if(!rt)return;if(!i){Et&&(Et.textContent=""),Xt&&(Xt.textContent="");return}const o=Z(),f=Es(i,o);Et&&(Et.textContent=f.value!=null?`Vorschlag: ${At(f.value)}`:"Vorschlag: â€”"),Xt&&(Xt.textContent=f.missingFields.length?Xs(f.missingFields):"");const g=H(rt.value),v=Number.isFinite(g)&&g>0;!nt&&(d||!v)&&(f.value!=null?rt.value=tt(f.value):(d||!v)&&(rt.value=""))}function dn(i){var st;if(!i)return!1;const d=xe(),o=As(i.sku,{mode:"PO",supplierId:((st=y==null?void 0:y.value)==null?void 0:st.trim())||i.supplierId,transportMode:Bt==null?void 0:Bt.value},{state:d}),f=JSON.parse(JSON.stringify(b)),g=M=>{const K=typeof M=="number"?M:H(M);return Number.isFinite(K)?K:null},v=M=>{const K=g(M);return K==null||K<=0},U=(M,K)=>{K==null||!v(f[M])||(f[M]=K)};Array.isArray(f.items)&&(f.items=f.items.map(M=>{if(!M||M.sku&&M.sku!==i.sku)return M;const K={...M},G=g(K.unitCostUsd);return!K.unitCostManuallyEdited&&(G==null||G<=0)&&o.unitPrice!=null&&(K.unitCostUsd=tt(o.unitPrice),K.unitCostManuallyEdited=!1),K})),U("fxOverride",o.fxRate),U("prodDays",o.productionLeadTimeDays),f.transport||(f.transport=String(o.transportMode).toLowerCase()),U("transitDays",o.logisticsLeadTimeDays),o.logisticsPerUnitEur!=null&&v(f.freightPerUnitEur)&&(f.freightMode="per_unit",f.freightPerUnitEur=tt(o.logisticsPerUnitEur),f.freightEur=tt(0)),U("dutyRatePct",o.dutyRatePct),U("eustRatePct",o.eustRatePct),o.ddp===!0&&f.ddp!==!0&&(f.ddp=!0);const N=[{label:"Deposit",percent:30,anchor:"ORDER_DATE",lagDays:0},{label:"Balance",percent:70,anchor:"PROD_DONE",lagDays:0}],O=M=>!Array.isArray(M)||M.length!==N.length?!1:M.every((K,G)=>{const at=N[G];return K.label===at.label&&Number(K.percent)===at.percent&&K.anchor===at.anchor});return Array.isArray(o.paymentTerms)&&o.paymentTerms.length&&O(f.milestones)&&(f.milestones=o.paymentTerms.map(M=>({id:`ms-${Math.random().toString(36).slice(2,9)}`,label:M.label||"Milestone",percent:Number(M.percent)||0,anchor:M.triggerEvent==="PRODUCTION_END"?"PROD_DONE":M.triggerEvent||"ORDER_DATE",lagDays:Number(M.offsetDays||M.lagDays||0)||0}))),Ot(f),!0}function be(i=Z(),d=b){const o=d||b;l&&(o.sku=L?mt(L.value):"",o.supplier=y?y.value.trim():""),o[e.numberField]=et.value.trim();const f=zn((W==null?void 0:W.value)||""),g=f?Ie(f):null,v=(T==null?void 0:T.value)||null;o.orderDate=g||v||o.orderDate;const U=Yt?Array.from(Yt.querySelectorAll("[data-item-id]")):[],N=[];U.forEach(at=>{var Mn;const Y=at.dataset.itemId||`item-${Math.random().toString(36).slice(2,9)}`,[Lt,lt,Ne,Me,Ae]=at.querySelectorAll("input");N.push({id:Y,sku:((Mn=Lt==null?void 0:Lt.value)==null?void 0:Mn.trim())||"",units:(lt==null?void 0:lt.value)||"0",unitCostUsd:tt((Ne==null?void 0:Ne.value)||"0,00"),unitExtraUsd:tt((Me==null?void 0:Me.value)||"0,00"),extraFlatUsd:tt((Ae==null?void 0:Ae.value)||"0,00"),unitCostManuallyEdited:at.dataset.unitCostManual==="true"})}),N.length&&(o.items=N),Ee(o);const O=H((ut==null?void 0:ut.value)??"");o.fxOverride=Number.isFinite(O)&&O>0?O:null,o.timeline=o.timeline||{},o.timeline.fxUsdPerEur=o.fxOverride?o.fxOverride:Number.isFinite(i.fxRate)&&i.fxRate>0?i.fxRate:null,Pt(o,i);const st=Ct(o,i),M=(pt==null?void 0:pt.value)||"TOTAL_EUR";o.timeline=o.timeline||{},o.timeline.freightInputMode=M,o.freightMode=M==="PER_UNIT_EUR"?"per_unit":"total",o.freightEur=tt(yt.value),o.freightPerUnitEur=tt((rt==null?void 0:rt.value)||"");const K=pe(o,i);Dn(st,K),o.prodDays=Number(se.value||0),o.transport=Bt.value,o.transitDays=Number(Kt.value||0),o.dutyRatePct=ct(Nt.value),o.dutyIncludeFreight=me.checked,o.eustRatePct=ct(zt.value),o.fxFeePct=ct(Rt.value),o.vatRefundLagMonths=Number(De.value||0),o.vatRefundEnabled=ae.checked,o.ddp=ie.checked,Mt&&(o.etdManual=Mt.value||null),Ut&&(o.etaManual=Ut.value||null);const G=te(o,i);return o.cnyAdjustmentDays=(G==null?void 0:G.cnyAdjustmentDays)||0,K}function q(i={}){var g,v;let d=i.focusInfo||null;if(!d){const U=document.activeElement;if(U&&U.closest&&U.closest("[data-ms-id]")){const N=U.closest("[data-ms-id]");d={id:(g=N==null?void 0:N.dataset)==null?void 0:g.msId,field:((v=U.dataset)==null?void 0:v.field)||null,selectionStart:U.selectionStart,selectionEnd:U.selectionEnd}}}const o=Z();let f=be(o);Kt.value||(Kt.value=b.transport==="air"?"10":b.transport==="rail"?"30":"60"),f=be(o),Gt(b,o,b.milestones),_e(b),qn($e,Ue,b,o,Le),Sn(te(b,o)),Gn(Pe,b,e,q,d,o,{showToast:nn}),ln(o),va(Yt,f),ce(),dt.setDraft(b),dt.isDirty}function Un(i){const d=i||new Date().toISOString().slice(0,10);T&&(T.value=d),W&&(W.value=it(d)),bt&&(bt.textContent="")}function Ln(i=!1){const d=zn((W==null?void 0:W.value)||"")||ee((T==null?void 0:T.value)||"");if(!d)return bt&&i&&(bt.textContent="Bitte Datum im Format TT.MM.JJJJ eingeben"),null;bt&&(bt.textContent="");const o=Ie(d);return T&&(T.value=o),W&&(W.value=it(o)),o}function wn(){const i=Z();if(b=dt.draft,Pt(b,i),Gt(b,i,b.milestones),_e(b),Qe(b),b.paymentDrafts||(b.paymentDrafts={}),J&&(J.textContent=b.archived?"Status: Archiviert":"Status: Aktiv"),Q){const g=b[e.numberField]||"â€”",v=b.supplier||"â€”";Q.textContent=`${g} â€¢ ${v}`}if(Ye(Yt,b,()=>q(),ke),l){if(Ft(),L){const g=ft.find(v=>v&&v.sku&&v.sku.trim().toLowerCase()===String(b.sku||"").trim().toLowerCase());g?jt(g):(L.value=b.sku||"",L.dataset.sku=b.sku||"")}y&&(y.value=b.supplier||""),ht(""),Jt()}et.value=b[e.numberField]||"",Un(b.orderDate||new Date().toISOString().slice(0,10));const d=b.fxOverride??i.fxRate??0;ut&&(ut.value=d?We(d):"");const o=pe(b,i);if(Dn(Ct(b,i),o),pt&&(pt.value=hn(b)),yt.value=tt(b.freightEur??"0,00"),rt&&(rt.value=tt(b.freightPerUnitEur??"0,00")),nt=Number.isFinite(H(b.freightPerUnitEur))&&H(b.freightPerUnitEur)>0,rt){const g=ft.find(v=>v&&v.sku&&v.sku.trim().toLowerCase()===String(b.sku||"").trim().toLowerCase());Vt(g)}$n(),se.value=String(b.prodDays??60),Bt.value=b.transport||"sea",Kt.value=String(b.transitDays??(b.transport==="air"?10:b.transport==="rail"?30:60)),Nt.value=vt(b.dutyRatePct??i.dutyRatePct??0),me.checked=b.dutyIncludeFreight!==!1,zt.value=vt(b.eustRatePct??i.eustRatePct??0),Rt.value=vt(b.fxFeePct??i.fxFeePct??0),De.value=String(b.vatRefundLagMonths??i.vatRefundLagMonths??0),ae.checked=b.vatRefundEnabled!==!1,ie.checked=!!b.ddp,Mt&&(Mt.value=b.etdManual||""),Ut&&(Ut.value=b.etaManual||"");const f=te(b,i);qn($e,Ue,b,i,Le),Sn(f),Gn(Pe,b,e,q,null,i,{showToast:nn}),ln(i),ce()}function Ot(i){Dt([]);const d=Z();dt=On(Kn(i,d),{key:sn(i),enableDraftCache:!0}),b=dt.draft,w=ge(b),wn(),dt.markClean();const o=dt.loadDraftIfAvailable();o!=null&&o.exists&&Cn({title:"Entwurf gefunden",message:`Es gibt einen ungespeicherten Entwurf von ${os(o.updatedAt)}. Wiederherstellen?`,confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{dt.restoreDraft(),wn(),on()},onCancel:()=>{dt.discardDraft(),on()}})}async function Fn(){if(!Ln(!0)){W&&W.focus();return}const d=Z();be(d),Qe(b);const o=wt(),{issues:f}=Ps({settings:o.settings,products:o.products,suppliers:o.suppliers}),g=f.filter(v=>v.blocking&&v.scope==="product"&&v.entityId===b.sku&&(v.field==="currency"||v.field==="unitPrice"));if(b.supplier||g.push(Ts({scope:"po",entityId:b.id||b[e.numberField]||"po",severity:"error",field:"supplier",message:"Supplier fehlt.",hint:"Bitte einen Supplier hinterlegen.",blocking:!0})),g.length){xs(g);return}await dt.commit(v=>{const U=wt(),N=ge(v),O=N.paymentDrafts||{};delete N.paymentDrafts;const M=(Array.isArray(U.payments)?U.payments:[]).map(at=>ge(at));Object.values(O).forEach(at=>{if(!(at!=null&&at.id))return;const Y=M.findIndex(lt=>(lt==null?void 0:lt.id)===at.id),Lt=ge(at);Y>=0?M[Y]={...M[Y],...Lt}:M.push(Lt)}),U.payments=M;const K=Array.isArray(U[e.entityKey])?U[e.entityKey]:[],G=K.findIndex(at=>at.id&&at.id===N.id||at[e.numberField]&&at[e.numberField]===N[e.numberField]);G>=0?K[G]=N:K.push(N),U[e.entityKey]=K,Ge(U,{source:`${e.slug}:save`,entityKey:sn(N),action:G>=0?"update":"create"}),w=ge(N)}),de(wt()[e.entityKey]),Jt(),l&&b.sku&&Ce(b.sku),nn(`${e.entityLabel||"PO"} gespeichert`),r&&He()}async function Ss(){if(!e.convertTo)return;const i=Z();if(be(i),le.disabled){window.alert("Bitte gÃ¼ltige Daten eingeben, bevor die FO umgewandelt wird.");return}await Fn();const d=wt();Array.isArray(d[e.convertTo.entityKey])||(d[e.convertTo.entityKey]=[]);const o=d[e.convertTo.entityKey],f=fa(o,e.convertTo.numberField),g=e.convertTo.targetLabel||e.convertTo.numberField||"PO",v=f.raw?`Aktuell hÃ¶chste ${g}-Nummer: ${f.raw}`:`Es existiert noch keine ${g}-Nummer.`,U=f.next||"",N=window.prompt(`${v}
Bitte neue ${g}-Nummer eingeben:`,U);if(N==null)return;const O=N.trim();if(!O){window.alert("Bitte eine gÃ¼ltige Nummer eingeben.");return}if(o.some(G=>((G==null?void 0:G[e.convertTo.numberField])||"").toLowerCase()===O.toLowerCase())){window.alert(`${g}-Nummer ${O} ist bereits vergeben.`);return}const K={...JSON.parse(JSON.stringify(b)),id:Math.random().toString(36).slice(2,9),[e.convertTo.numberField]:O};delete K[e.numberField],o.push(K),Ge(d,{source:`${e.slug}:convert`,entityKey:`${e.convertTo.slug||e.convertTo.entityKey}:${K[e.convertTo.numberField]||K.id}`,action:"create"}),window.alert(`${g} ${O} wurde angelegt.`)}function Pn(i){Ot(i),r&&an()}function Tn(i){const d=wt(),o=Array.isArray(d[e.entityKey])?d[e.entityKey]:[];d[e.entityKey]=o.filter(f=>f.id&&i.id?f.id!==i.id:f[e.numberField]!==i[e.numberField]),Ge(d,{source:`${e.slug}:delete`,entityKey:sn(i),action:"delete"}),de(wt()[e.entityKey]),Ot(ve(e,Z())),r&&He()}if(Be&&Be.addEventListener("click",()=>{Ee(b),b.items.push({id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1}),Ye(Yt,b,()=>q(),ke),q()}),Ke&&Ke.addEventListener("click",()=>{Ee(b),b.items.push({id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1,type:"misc"}),Ye(Yt,b,()=>q(),ke),q()}),W&&(W.addEventListener("blur",()=>Ln(!0)),W.addEventListener("input",()=>{bt&&(bt.textContent="")})),T&&T.addEventListener("change",()=>{Un(T.value),q()}),Wt&&T&&Wt.addEventListener("click",()=>{T.showPicker?T.showPicker():T.focus()}),pt&&pt.addEventListener("change",()=>{$n(),q()}),yt.addEventListener("input",q),yt.addEventListener("blur",()=>{yt.value=tt(yt.value),q()}),rt&&(rt.addEventListener("input",()=>{nt=!0,q()}),rt.addEventListener("blur",()=>{rt.value=tt(rt.value),q()})),xt&&xt.addEventListener("click",()=>{nt=!1;const i=kt((L==null?void 0:L.value)||b.sku||"");Vt(i,{force:!0}),q()}),Nt.addEventListener("input",q),Nt.addEventListener("blur",()=>{const i=ct(Nt.value);Nt.value=vt(i),q()}),me.addEventListener("change",q),zt.addEventListener("input",q),zt.addEventListener("blur",()=>{const i=ct(zt.value);zt.value=vt(i),q()}),Rt.addEventListener("input",q),Rt.addEventListener("blur",()=>{const i=ct(Rt.value);Rt.value=vt(i),q()}),ut&&(ut.addEventListener("input",()=>{q();const i=kt((L==null?void 0:L.value)||b.sku||"");Vt(i)}),ut.addEventListener("blur",()=>{const i=H(ut.value);ut.value=i>0?We(i):"",q();const d=kt((L==null?void 0:L.value)||b.sku||"");Vt(d)})),De.addEventListener("input",q),ae.addEventListener("change",q),ie.addEventListener("change",q),Mt&&Mt.addEventListener("change",q),Ut&&Ut.addEventListener("change",q),re&&re.addEventListener("click",()=>{Mt&&(Mt.value=""),b.etdManual=null,q()}),Ht&&Ht.addEventListener("click",()=>{Ut&&(Ut.value=""),b.etaManual=null,q()}),se.addEventListener("input",i=>{b.prodDays=Number(i.target.value||0),q()}),Bt.addEventListener("change",i=>{b.transport=i.target.value,b.transport==="air"&&(b.transitDays=10),b.transport==="rail"&&(b.transitDays=30),b.transport==="sea"&&(b.transitDays=60),Kt.value=String(b.transitDays),q()}),Kt.addEventListener("input",i=>{b.transitDays=Number(i.target.value||0),q()}),l&&L){const i=()=>{const d=kt(L.value);if(d){jt(d),b.sku=d.sku,Ce(d.sku);const o=In(d,{state:xe()}),f=en(o);if(o.status==="blocked"){Dt(f,"Produkt blockiert"),Vt(d),ce();return}Dt(f,"Prefill verwendet Defaults");const g=dn(d);if(nt=!1,Vt(d),g)return}else b.sku=L.value.trim(),Vt(null);ht(""),Jt(),ce()};L.addEventListener("input",i),L.addEventListener("blur",()=>{L.value=L.value.trim(),i()})}if(l&&y){const i=()=>{b.supplier=y.value.trim();const d=kt((L==null?void 0:L.value)||b.sku||"");d&&dn(d),Jt()};y.addEventListener("input",i),y.addEventListener("blur",()=>{y.value=y.value.trim(),i()})}if(l&&$&&($.checked=St,$.addEventListener("change",()=>{St=$.checked,Jt()})),l&&c&&c.addEventListener("click",i=>{var N;i.preventDefault(),i.stopPropagation();const d=mt((L==null?void 0:L.value)||b.sku||"");if(!d){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const o=((N=y==null?void 0:y.value)==null?void 0:N.trim())||"",f=yn(d,o);if(f){const O=vn([f])[0];qe(O,`Werte aus ${e.entityLabel} ${f[e.numberField]||""} Ã¼bernommen. Du kannst alles anpassen.`);return}const g=Ve(d,o);if(!g.length){window.alert("Keine Produktvorlage oder VorgÃ¤nger-POs fÃ¼r diese SKU gefunden.");return}const v=g[0],U=v.template.fields?JSON.parse(JSON.stringify(v.template.fields)):JSON.parse(JSON.stringify(v.template));qe(U,`Werte aus ${v.name} Ã¼bernommen. Du kannst alles anpassen.`)}),l&&P&&P.addEventListener("click",ms),A&&A.addEventListener("click",gs),I&&I.addEventListener("click",vs),z&&z.addEventListener("click",hs),k&&k.addEventListener("input",()=>{X&&(X.searchTerm=k.value,de())}),F&&F.addEventListener("change",()=>{X&&(X.showArchived=F.checked,de())}),x&&x.addEventListener("click",()=>{Ot(ve(e,Z())),an()}),j&&j.addEventListener("click",()=>je({reset:!0})),V&&V.addEventListener("click",un),h){let i=!1;h.addEventListener("mousedown",d=>{i=d.target===h}),h.addEventListener("mouseup",d=>{if(i&&d.target===h){if(Je)return;je({reset:!0})}i=!1})}et.addEventListener("input",q),W&&W.addEventListener("input",q),le.addEventListener("click",un),ue&&ue.addEventListener("click",()=>{je({reset:!0})}),Te.addEventListener("click",()=>Ot(ve(e,Z()))),tn.addEventListener("click",()=>Tn(b)),It&&It.addEventListener("click",()=>Ss());const xn=i=>{(i.ctrlKey||i.metaKey)&&i.key.toLowerCase()==="s"&&(i.preventDefault(),un()),i.key==="Escape"&&r&&(h!=null&&h.classList.contains("is-open"))&&(i.preventDefault(),je({reset:!0}))};window.addEventListener("keydown",xn),de(s[e.entityKey]),Jt(),Ot(ve(e,Z()));function ks(i){const d=Z();Ft();const o=ve(e,d),f=[],g=String(i.sku||"").trim();g&&(o.sku=g,Array.isArray(o.items)&&o.items[0]&&(o.items[0].sku=g,o.items[0].units=""));const v=g?ft.find(M=>{var K;return((K=M==null?void 0:M.sku)==null?void 0:K.trim().toLowerCase())===g.toLowerCase()}):null;v!=null&&v.supplierId?o.supplier=v.supplierId:g&&f.push("Supplier fehlt in Produktdaten.");const U=String(i.anchorMode||"order").toLowerCase(),N=i.orderDate||i.anchorDate||"",O=ee(N);if(O)if(U==="arrival"){o.etaManual=Ie(O);const M=ga(O,o,d);M&&(o.orderDate=Ie(M)),f.push(`Order Date wurde rÃ¼ckwÃ¤rts bestimmt fÃ¼r ETA-Anker ${it(O)}.`)}else o.orderDate=Ie(O);Number.isFinite(H(d.fxRate))||f.push("FX-Kurs fehlt in Settings.");const st=i.anchorMonth||(O?Hn(O):null);return{record:o,messages:f,anchorMonth:st,anchorMode:U,anchorDate:O,product:v}}function Ds(i){if(!i||!r)return;const d=String(i).split(":")[1]||"";if(!d)return;const o=t.querySelector(".po-payments-table");if(!o)return;const f=Array.from(o.querySelectorAll("tbody tr"));f.forEach(U=>U.classList.remove("is-focus"));const g=d.toLowerCase(),v=f.find(U=>{const N=String(U.dataset.paymentType||"").toLowerCase(),O=String(U.dataset.paymentEventType||"").toLowerCase();return N.includes(g)||O.includes(g)});v&&(v.classList.add("is-focus"),v.scrollIntoView({block:"center",behavior:"smooth"}))}function $s(){var g;const i=window.__routeQuery||{};if(i.create==="1"||i.mode==="create"){const{record:v,messages:U,anchorMonth:N,anchorMode:O,product:st}=ks(i);Ot(v),st&&l&&(dn(st),nt=!1,Vt(st,{force:!0}));const M=O!=="arrival"?Hn((g=te(b,Z()))==null?void 0:g.eta):null;N&&M&&M>N&&U.push(`Mit aktuellen Lead Times liegt ETA voraussichtlich in ${ta(M)} (Stockout-Risiko mÃ¶glich).`),Dt(U),r&&an(),window.__routeQuery={};return}if(!i.open)return;const o=String(i.open||"").trim().toLowerCase();if(!o)return;const f=rn().find(v=>{if(!v)return!1;const U=String(v.id||"").trim().toLowerCase()===o,N=String(v[e.numberField]||"").trim().toLowerCase()===o;return U||N});f&&(Pn(f),i.focus&&setTimeout(()=>Ds(i.focus),150),window.__routeQuery={})}$s(),t._orderStateListener&&window.removeEventListener("state:changed",t._orderStateListener);const Nn=()=>{const i=wt(),d=Z();de(i[e.entityKey]),oe&&ln(d)};return t._orderStateListener=Nn,window.addEventListener("state:changed",Nn),{cleanup:()=>{t._orderStateListener&&window.removeEventListener("state:changed",t._orderStateListener),R.unregister(),R.detachBeforeUnload(),window.removeEventListener("keydown",xn)}}}const Ta={normaliseGoodsFields:Pt};export{Jn as b,Z as g,Ta as o,Pa as r};
