import{p as Rt,I as Pt,t as g,k as e,J as Ft,K as Z,T as xe,L as m,S as le,M as Se,R as it,N as ge,O as It,P as lt}from"./index-CAzQztwo.js";import{b as Et,E as Kt}from"./dashboardMaturity-DDWpVPL_.js";import{c as $t}from"./cashflow-rmBKYUQ9.js";import{T as Bt}from"./TanStackGrid-DGGNjv9D.js";import{b as dt}from"./abcClassification-D8Ca84qt.js";import{c as ht}from"./inventoryProjection-BZ_5NrPh.js";import{e as Ot}from"./productCompletenessV2-CJLSMhtL.js";import{m as zt,c as Ge,a as Lt,n as _t,b as we,f as te}from"./months-DiLwPhVv.js";import{u as Tt,C as F}from"./workspace-xr5uOuIo.js";import{C as J}from"./Collapse-mRNqWjAX.js";import{S as _e}from"./index-C15xyCf_.js";import{S as re}from"./index-Dm5lp8KC.js";import{R as mt}from"./InfoCircleOutlined-COYE5d9y.js";import{F as Ut}from"./Table-v8LS_Cg4.js";import{T as Gt}from"./index-Dab_0RQN.js";import"./planProducts-CfB8BW_g.js";import"./Dropdown-CZlZd-6U.js";import"./index-5SR9pC2K.js";import"./useBubbleLock-Cjjrx1CM.js";import"./index-BZ5evjDG.js";import"./Pagination-B0SkKhC9.js";function Ee(t){return String(t||"").trim()}function ue(t){return Ee(t).toLowerCase()}function Vt(t){if(typeof t.active=="boolean")return t.active;const n=String(t.status||"").trim().toLowerCase();return n?n==="active"||n==="aktiv":!0}function Ht(t){return/^\d{4}-\d{2}$/.test(String(t||""))}function ft(t){return t!=null&&String(t).trim()!==""}function Ne(t){const n=Rt(t);return Number.isFinite(n)?Number(n):null}function gt(t,n){const r=t.get(n),l=t.get(ue(n)),i=String((r==null?void 0:r.abcClass)||(l==null?void 0:l.abcClass)||"C").toUpperCase();return i==="A"||i==="B"||i==="C"?i:"C"}function Zt(t,n){const l=(Array.isArray(t.incomings)?t.incomings:[]).find(v=>String(v.month||"")===n);if(l){const v=Ne(l.revenueEur),f=Ne(l.payoutPct);if(Number.isFinite(v)||Number.isFinite(f))return!0}const a=(t.monthlyActuals&&typeof t.monthlyActuals=="object"?t.monthlyActuals:{})[n];return a?Number.isFinite(Ne(a.realRevenueEUR))||Number.isFinite(Ne(a.realPayoutRatePct)):!1}function Wt(t){const n=t.settings&&typeof t.settings=="object"?t.settings:{},r=n.vatPreview&&typeof n.vatPreview=="object"?n.vatPreview:{},l=t.vatPreviewMonths&&typeof t.vatPreviewMonths=="object"?t.vatPreviewMonths:{};return{active:[r.deShareDefault,r.feeRateDefault,r.fixInputDefault,r.feeRateOfGrossDefault,r.fixInputVatDefault].some(ft),defaults:r,monthOverrides:l}}function qt(t,n){if(!t.active)return!0;const r=t.monthOverrides[n]&&typeof t.monthOverrides[n]=="object"?t.monthOverrides[n]:{};return[t.defaults.deShareDefault,t.defaults.feeRateDefault,t.defaults.fixInputDefault,t.defaults.feeRateOfGrossDefault,t.defaults.fixInputVatDefault,r.deShare,r.feeRateOfGross,r.fixInputVat].some(ft)}function Qt(t,n){const r=dt(t).bySku,l=[],i=[];return n.forEach(a=>{const v=Ee(a.sku);if(!v)return;const f=String(a.alias||v),c=gt(r,v),S={sku:v,alias:f,abcClass:c},M=Ne(a.avgSellingPriceGrossEUR);(!Number.isFinite(M)||Number(M)<=0)&&l.push(S);const O=Ot({product:a,state:t});(O==null?void 0:O.status)==="blocked"&&i.push(S)}),{missingPrice:l,blockedCompleteness:i}}function Xt(t){const n=t.months.reduce((f,c)=>f+c.coverage.missingForecastSkus.length,0),r=t.months.reduce((f,c)=>f+c.coverage.safetyRiskSkus.length,0),l=t.months.filter(f=>{const c=f.checks.find(S=>S.key==="cash_in");return c&&!c.passed}).length,i=t.months.filter(f=>{const c=f.checks.find(S=>S.key==="vat");return c&&!c.passed}).length,a=[];n>0&&a.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${n} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:n,impact:"Kontostand nicht belastbar"}),r>0&&a.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${r} SKU-Monat(e) unter Safety.`,severity:"error",route:"/v2/inventory/projektion",count:r,impact:"Stockout-Risiko in A/B möglich"}),l>0&&a.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${l} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:l,impact:"Kontostand-Projektion instabil"}),t.hasFixcostBasis||a.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:t.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),t.vatActive&&i>0&&a.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${i} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:i,impact:"Outflow-Bild unvollständig"}),t.revenueIssueSkus>0&&a.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${t.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:t.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const v=f=>f==="error"?2:1;return a.sort((f,c)=>{const S=v(c.severity)-v(f.severity);if(S!==0)return S;const M=c.count-f.count;return M!==0?M:f.title.localeCompare(c.title)}),a.slice(0,5)}function bt(t){const n=Array.from(new Set((Array.isArray(t.months)?t.months:[]).filter(Ht))).sort(),r=t.state||{},i=(Array.isArray(r.products)?r.products:[]).map(u=>u||{}).filter(u=>Ee(u.sku)).filter(Vt),a=i.length,v=Array.isArray(r.fixcosts)&&r.fixcosts.length>0,f=Wt(r),c=Qt(r,i),S=new Set(c.missingPrice.map(u=>ue(u.sku))),M=ht({state:r,months:n,products:i,snapshot:null,snapshotMonth:n[0]||void 0,projectionMode:"units"}),O=dt(r).bySku,C=n.map(u=>{const P=[],I=[];let $=0;i.forEach(o=>{const p=Ee(o.sku);if(!p)return;const y=String(o.alias||p),D=gt(O,p),de=M.perSkuMonth.get(p)||M.perSkuMonth.get(ue(p)),X=de==null?void 0:de.get(u),Me=!!(X!=null&&X.hasForecast);if(Me&&!!(X!=null&&X.isCovered)){$+=1;return}const ye={sku:p,alias:y,abcClass:D};if(!Me){P.push(ye);return}I.push(ye)});const ne=a>0&&P.length===0&&I.length===0&&$===a,w=Zt(r,u),z=v,U=qt(f,u),q=c.missingPrice.length===0&&c.blockedCompleteness.length===0,B=[],x=o=>{B.push({id:`${o.checkKey}:${o.month}:${B.length}`,...o})};ne||(a===0&&x({month:u,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"}),P.slice(0,20).forEach(o=>{x({month:u,checkKey:"sku_coverage",severity:"error",message:`${o.sku} (${o.alias}): Forecast fehlt.`,sku:o.sku,alias:o.alias,route:"/v2/forecast"})}),P.length>20&&x({month:u,checkKey:"sku_coverage",severity:"error",message:`+ ${P.length-20} weitere SKU(s) ohne Forecast.`,route:"/v2/forecast"}),I.slice(0,20).forEach(o=>{x({month:u,checkKey:"sku_coverage",severity:"error",message:`${o.sku} (${o.alias}): unter Safety (${o.abcClass}).`,sku:o.sku,alias:o.alias,route:"/v2/inventory/projektion"})}),I.length>20&&x({month:u,checkKey:"sku_coverage",severity:"error",message:`+ ${I.length-20} weitere SKU(s) unter Safety.`,route:"/v2/inventory/projektion"})),w||x({month:u,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),z||x({month:u,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),U||x({month:u,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),q||(c.missingPrice.slice(0,20).forEach(p=>{x({month:u,checkKey:"revenue_inputs",severity:"error",message:`${p.sku} (${p.alias}): Ø VK-Preis fehlt.`,sku:p.sku,alias:p.alias,route:"/v2/products"})}),c.blockedCompleteness.filter(p=>!S.has(ue(p.sku))).slice(0,20).forEach(p=>{x({month:u,checkKey:"revenue_inputs",severity:"error",message:`${p.sku} (${p.alias}): Stammdaten unvollständig.`,sku:p.sku,alias:p.alias,route:"/v2/products"})}));const ae=[{key:"sku_coverage",label:"SKU-Coverage 100%",status:ne?"ok":"error",passed:ne,detail:`${$}/${a} abgedeckt · Forecast fehlt ${P.length} · Safety ${I.length}`,blockerCount:P.length+I.length+(a===0?1:0),route:P.length>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:w?"ok":"error",passed:w,detail:w?"vorhanden":"fehlend",blockerCount:w?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:z?"ok":"error",passed:z,detail:z?"vorhanden":"fehlend",blockerCount:z?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:U?"ok":"error",passed:U,detail:f.active?U?"vorhanden":"fehlend":"nicht aktiv",blockerCount:U?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:q?"ok":"error",passed:q,detail:q?"vollständig":`${c.missingPrice.length} ohne Preis · ${c.blockedCompleteness.length} unvollständig`,blockerCount:q?0:c.missingPrice.length+c.blockedCompleteness.length,route:"/v2/products"}],R=ae.every(o=>o.passed),Ke=new Set(I.filter(o=>o.abcClass==="A"||o.abcClass==="B").map(o=>ue(o.sku)));return{month:u,robust:R,checks:ae,blockers:B,blockerCount:B.length,coverage:{activeSkus:a,coveredSkus:$,ratio:a?$/a:0,missingForecastSkus:P.map(o=>o.sku),safetyRiskSkus:I.map(o=>o.sku),abRiskSkuCount:Ke.size}}}),se=new Map;C.forEach(u=>se.set(u.month,u));const W=C.filter(u=>u.robust).length;let _=null;for(let u=0;u<C.length&&C[u].robust;u+=1)_=C[u].month;const T=new Set([...c.missingPrice.map(u=>ue(u.sku)),...c.blockedCompleteness.map(u=>ue(u.sku))]).size;return{months:C,monthMap:se,actions:Xt({months:C,hasFixcostBasis:v,vatActive:f.active,revenueIssueSkus:T}),robustUntilMonth:_,robustMonthsCount:W,totalMonths:C.length,activeSkuCount:a}}function Fe(t){if(!t)return null;const n=new Date(String(t));return Number.isNaN(n.getTime())?null:n}function Jt(t){if(typeof t.active=="boolean")return t.active;const n=String(t.status||"").trim().toLowerCase();return n?n==="active"||n==="aktiv"||n==="prelaunch"||n==="not_launched"||n==="planned":!0}function Ve(t){return String(t||"").trim()}function Yt(t){return(Array.isArray(t.products)?t.products:[]).filter(r=>Ve(r.sku)?Jt(r):!1).map(r=>({sku:Ve(r.sku),alias:String(r.alias||r.sku||""),status:String(r.status||"active"),safetyStockDohOverride:r.safetyStockDohOverride,foCoverageDohOverride:r.foCoverageDohOverride}))}function es(t){const n=t.lastDriftSummary&&typeof t.lastDriftSummary=="object"?t.lastDriftSummary:{},r=typeof n.comparedAt=="string"?n.comparedAt:null;return r&&Fe(r)?r:null}function ts(t){return{id:`gate:${t.key}`,key:t.key,severity:"error",label:t.label,message:t.detail,route:t.route}}function ss(t){const n=t.state||{},r=Number.isFinite(t.horizonMonths)?Math.max(1,Math.round(Number(t.horizonMonths))):12,l=zt(Ge(),r),i=bt({state:n,months:l}),a=i.robustMonthsCount>=l.length&&l.length>0,v=Yt(n),f=ht({state:n,months:l,products:v,snapshot:null,snapshotMonth:Lt(Ge(),-1),projectionMode:"units"}),c=Array.isArray(f.anchorSkuMissingHistory)?f.anchorSkuMissingHistory.map(B=>Ve(B)).filter(Boolean).sort((B,x)=>B.localeCompare(x,"de-DE")):[],S=c.length===0,M=n.forecast&&typeof n.forecast=="object"?n.forecast:{},O=typeof M.lastImportAt=="string"?M.lastImportAt:null,C=Fe(O),se=new Date,W=24*60*60*1e3,_=C?Math.floor((se.getTime()-C.getTime())/W):null,T=_!=null&&_<=35,u=es(M),P=typeof M.lastDriftReviewedComparedAt=="string"?M.lastDriftReviewedComparedAt:null,I=typeof M.lastDriftReviewedAt=="string"?M.lastDriftReviewedAt:null,$=!!(u&&P&&_t(String(u).slice(0,7))&&P===u&&Fe(I)),ne=t.runtimeErrorAt&&Fe(t.runtimeErrorAt)?String(t.runtimeErrorAt):null,w=!ne,z=[{key:"runtime_stable",label:"Runtime stabil",passed:w,status:w?"ok":"error",detail:w?"Keine offenen Tab-Ladefehler.":`Offener Tab-Ladefehler seit ${new Date(ne).toLocaleString("de-DE")}${t.runtimeErrorRoute?` (${t.runtimeErrorRoute})`:""}.`,route:"/v2/dashboard",blockerCount:w?0:1},{key:"robust_12m",label:"Robustheit 12M",passed:a,status:a?"ok":"error",detail:a?`${i.robustMonthsCount}/${l.length} Monate robust.`:`${i.robustMonthsCount}/${l.length} Monate robust (erforderlich: ${l.length}).`,route:"/v2/dashboard",blockerCount:a?0:Math.max(0,l.length-i.robustMonthsCount)},{key:"anchor_history_complete",label:"Anchor-Historie vollständig",passed:S,status:S?"ok":"error",detail:S?"Alle aktiven/prelaunch SKUs haben Snapshot-Historie.":`${c.length} SKU(s) ohne Snapshot-Historie (Anker=0).`,route:"/v2/inventory/projektion?source=dashboard&risk=under_safety&abc=ab&expand=all",blockerCount:c.length},{key:"forecast_fresh",label:"Forecast aktuell",passed:T,status:T?"ok":"error",detail:T?`${_} Tage seit Import.`:_==null?"Kein Forecast-Import vorhanden.":`${_} Tage seit Import (erlaubt <= 35).`,route:"/v2/forecast",blockerCount:T?0:1},{key:"forecast_drift_reviewed",label:"Drift geprüft",passed:$,status:$?"ok":"error",detail:$?`Drift-Stand vom ${new Date(u).toLocaleDateString("de-DE")} geprüft.`:u?"Aktueller Drift-Stand ist noch nicht als geprüft markiert.":"Noch kein Driftvergleich verfügbar.",route:"/v2/forecast",blockerCount:$?0:1}],U=z.filter(B=>!B.passed).map(B=>ts(B)),q=U.length===0;return{ready:q,status:q?"ready":"not_ready",horizonMonths:r,checks:z,blockers:U,robustMonthsCount:i.robustMonthsCount,robustRequiredCount:l.length,anchorMissingHistoryCount:c.length,anchorMissingHistorySkus:c,forecastDaysSinceImport:_,driftComparedAt:u,driftReviewedAt:I,driftReviewedForComparedAt:P}}const{Paragraph:ce,Text:k,Title:oe}=Ft,ns="v2:last-route-error";function rs(){return new Date().toISOString()}const ct=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],os=[{key:"inflow",label:"Einzahlungen"},{key:"po_fo",label:"PO/FO Zahlungen"},{key:"fixcost",label:"Fixkosten"},{key:"tax",label:"Steuern & Importkosten"},{key:"outflow",label:"Sonstige Auszahlungen"},{key:"other",label:"Sonstige"}];function j(t){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function be(t){return Number.isFinite(t)?t<0?`−${j(Math.abs(t))}`:j(t):"-"}function ve(t,n=0){const r=Number(t);return Number.isFinite(r)?r.toLocaleString("de-DE",{minimumFractionDigits:n,maximumFractionDigits:n}):"-"}function Te(t){const n=Number(t);return Number.isFinite(n)?`${n.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"-"}function Re(t){if(!t)return"-";const n=new Date(t);return Number.isNaN(n.getTime())?t:n.toLocaleDateString("de-DE")}function as(t){return t==="ok"?e.jsx(m,{color:"green",children:"OK"}):e.jsx(m,{color:"red",children:"Offen"})}function pe(t){return t.reduce((n,r)=>n+Number(r.amount||0),0)}function is(t,n){const r=new Date(t.getTime());return r.setDate(r.getDate()+n),r}function Ie(t){return t==="dividend"?"Dividende (Simulation)":"CAPEX (Simulation)"}function Pe(t,n){return e.jsxs("span",{className:"v2-dashboard-signal-title",children:[t,e.jsx(xe,{title:n,children:e.jsx(mt,{})})]})}function vt(t,n){const[r,l=""]=String(t||"").split("?"),i=new URLSearchParams(l);Object.entries(n).forEach(([v,f])=>{if(f==null||f===""){i.delete(v);return}i.set(v,f)});const a=i.toString();return a?`${r}?${a}`:r}function ls(t){return vt("/v2/inventory/projektion",{source:"dashboard",risk:t.risk,abc:t.abc,month:t.month||null,sku:t.sku||null,expand:"all"})}function cs(t){return vt("/v2/products",{source:"dashboard",issues:t.issues,sku:t.sku||null,expand:"all"})}function Ue(t){const n=String(t.route||"");if(n.startsWith("/v2/inventory/projektion")){const r=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"under_safety":"all",l=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"ab":"all";return ls({risk:r,abc:l,month:t.month||null,sku:t.sku||null})}if(n.startsWith("/v2/products")){const r=t.actionId==="revenue_inputs"||t.checkKey==="revenue_inputs"?"revenue":"needs_fix";return cs({issues:r,sku:t.sku||null})}return n}function us(t){const n=t.map(r=>(Array.isArray(r.entries)?r.entries:[]).filter(a=>String(a.direction||"").toLowerCase()==="out"&&String(a.group||"")==="Fixkosten").reduce((a,v)=>a+Math.abs(Number(v.amount||0)),0)).filter(r=>r>0);return n.length?n.reduce((r,l)=>r+l,0)/n.length:0}function ds(t,n){var l;if(!n||!Number.isFinite(n.amount)||n.amount<=0)return t.map(i=>({...i}));let r=Number(((l=t[0])==null?void 0:l.opening)||0);return t.map((i,a)=>{const v=a===0?Number(i.opening||0):r,f=i.month===n.month,c=f?Math.abs(Number(n.amount||0)):0,S=Number(i.inflow||0),M=Number(i.outflow||0)+c,O=S-M,C=v+O;r=C;const se=f?[{id:`sim-${n.type}-${n.month}`,direction:"out",amount:c,label:n.label||Ie(n.type),month:n.month,kind:n.type==="dividend"?"dividend":"capex",group:n.type==="dividend"?"Dividende & KapESt":"Extras (Out)",source:"simulation"}]:[];return{...i,opening:v,inflow:S,outflow:M,net:O,closing:C,entries:[...Array.isArray(i.entries)?i.entries:[],...se],simApplied:f}})}function hs(t,n){var r;for(let l=0;l<t.length;l+=1){const i=t[l].month;if((r=n.get(i))!=null&&r.robust&&Number(t[l].closing||0)<0)return i}return null}function ms(t){if(!t||typeof t!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0,topItems:[]};const n=t,r=Array.isArray(n.topItems)?n.topItems:[];return{comparedAt:typeof n.comparedAt=="string"?n.comparedAt:null,thresholdProfile:String(n.thresholdProfile||"medium"),flaggedSkuCount:Number(n.flaggedSkuCount||0),flaggedABCount:Number(n.flaggedABCount||0),flaggedMonthCount:Number(n.flaggedMonthCount||0),topItems:r.map(l=>{const i=l;return{sku:String(i.sku||""),month:String(i.month||""),abcClass:String(i.abcClass||"C"),deltaPct:Number(i.deltaPct||0),deltaUnits:Number(i.deltaUnits||0),deltaRevenue:Number(i.deltaRevenue||0)}}).filter(l=>l.sku&&l.month)}}function ut(){if(typeof window>"u"||!window.sessionStorage)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};try{const t=window.sessionStorage.getItem(ns);if(!t)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};const n=JSON.parse(t);return{errorAt:typeof n.errorAt=="string"?n.errorAt:null,routeKey:typeof n.routeKey=="string"?n.routeKey:null,routePath:typeof n.routePath=="string"?n.routePath:null,routeLabel:typeof n.routeLabel=="string"?n.routeLabel:null,message:typeof n.message=="string"?n.message:null}}catch{return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null}}}function Os(){var et,tt,st,nt;const{state:t,loading:n,error:r,saving:l,saveWith:i}=Tt(),a=Pt(),[v,f]=g.useState("next12"),[c,S]=g.useState(""),[M,O]=g.useState([]),[C,se]=g.useState("dividend"),[W,_]=g.useState(""),[T,u]=g.useState(null),[P,I]=g.useState(""),[$,ne]=g.useState(()=>ut()),w=t,z=g.useMemo(()=>$t(w),[t]),U=z.months||[],q=z.breakdown||[],B=z.actualComparisons||[],x=g.useMemo(()=>{const s=ct.find(d=>d.value===v);return!s||s.count==null?U:U.slice(0,s.count)},[U,v]),ae=g.useMemo(()=>new Set(x),[x]),R=g.useMemo(()=>q.filter(s=>ae.has(s.month)),[q,ae]),Ke=g.useMemo(()=>B.filter(s=>ae.has(s.month)),[B,ae]),o=g.useMemo(()=>bt({state:w,months:x}),[w,x]),p=g.useMemo(()=>ss({state:w,horizonMonths:12,runtimeErrorAt:$.errorAt,runtimeErrorRoute:$.routePath}),[$.errorAt,$.routePath,w]);g.useEffect(()=>{var s;if(!o.months.length){S("");return}if(!c||!o.monthMap.has(c)){const d=((s=o.months.find(b=>!b.robust))==null?void 0:s.month)||o.months[0].month;S(d)}},[o,c]),g.useEffect(()=>{if(!R.length){O([]);return}O(s=>{const d=new Set(R.map(E=>E.month)),b=s.filter(E=>d.has(E));return b.length?b:[R[0].month]})},[R]),g.useEffect(()=>{if(!x.length){_("");return}(!W||!x.includes(W))&&_(x[0])},[W,x]);const y=g.useMemo(()=>!W||!Number.isFinite(T)||Number(T)<=0?null:{month:W,amount:Math.abs(Number(T)),type:C,label:P.trim()||Ie(C)},[T,P,W,C]),D=g.useMemo(()=>ds(R,y),[y,R]),de=g.useMemo(()=>{const s=new Map;return D.forEach(d=>s.set(d.month,d)),s},[D]),X=D[D.length-1]||null,Me=D.reduce((s,d)=>s+Number(d.inflow||0),0),He=D.reduce((s,d)=>s+Number(d.outflow||0),0),ye=D.reduce((s,d)=>s+Number(d.net||0),0),G=g.useMemo(()=>us(R),[R])*2,$e=g.useMemo(()=>D.filter(s=>{var d;return(d=o.monthMap.get(s.month))==null?void 0:d.robust}).map(s=>Number(s.closing||0)),[o.monthMap,D]),Ze=g.useMemo(()=>!$e.length||G<=0?null:Math.min(...$e)-G,[G,$e]),We=g.useMemo(()=>hs(D,o.monthMap),[o.monthMap,D]),Be=g.useMemo(()=>{var s;return!y||G<=0?null:((s=D.find(d=>{const b=we(d.month),E=we(y.month);return b==null||E==null||b<E?!1:Number(d.closing||0)<G}))==null?void 0:s.month)||null},[G,D,y]),qe=!!y&&G>0&&!Be,ie=t.forecast&&typeof t.forecast=="object"?t.forecast:{},Oe=typeof ie.lastImportAt=="string"?ie.lastImportAt:null,V=ms(ie.lastDriftSummary),Qe=typeof ie.lastDriftReviewedComparedAt=="string"?ie.lastDriftReviewedComparedAt:null,ze=typeof ie.lastDriftReviewedAt=="string"?ie.lastDriftReviewedAt:null,Le=!!(V.comparedAt&&Qe&&Qe===V.comparedAt&&ze),he=Oe?new Date(Oe):null,pt=new Date,xt=24*60*60*1e3,ke=he?Math.floor((pt.getTime()-he.getTime())/xt):null,me=he?ke!=null&&ke<=35?"fresh":ke!=null&&ke<=45?"aging":"stale":"none",yt=he?`${ke} Tage seit Import`:"Kein Forecast-Import",Xe=he?is(he,30):null,L=c&&o.monthMap.get(c)||null,kt=Ge(),Je=we(kt),jt=g.useMemo(()=>{var s;return((s=o.months.find(d=>!d.robust))==null?void 0:s.month)||c||x[0]||null},[o.months,c,x]);g.useEffect(()=>{const s=()=>ne(ut());return s(),window.addEventListener("v2:route-load-state",s),window.addEventListener("storage",s),()=>{window.removeEventListener("v2:route-load-state",s),window.removeEventListener("storage",s)}},[]);const Ye=g.useMemo(()=>Et({breakdown:R,state:w}),[w,R]),St=g.useMemo(()=>{const s=x.map(h=>te(h)),d=R.map(h=>Number(h.closing||0)),b=R.map(h=>{var A;return!!((A=o.monthMap.get(h.month))!=null&&A.robust)}),E=d.map((h,A)=>b[A]&&h>=0?h:null),Y=d.map((h,A)=>b[A]&&h<0?h:null),Ce=d.map((h,A)=>!b[A]&&h>=0?h:null),Ae=d.map((h,A)=>!b[A]&&h<0?h:null),N=y?R.map(h=>{var A;return Number(((A=de.get(h.month))==null?void 0:A.closing)||0)}):[];return{tooltip:{trigger:"axis",formatter:h=>{const A=Array.isArray(h)?h:[h],H=A[0],ee=[`<div><strong>${(H==null?void 0:H.axisValueLabel)||""}</strong></div>`];return A.forEach(fe=>{const Q=fe,je=Number(Q==null?void 0:Q.value);Number.isFinite(je)&&ee.push(`<div>${(Q==null?void 0:Q.marker)||""}${(Q==null?void 0:Q.seriesName)||""}: ${j(je)}</div>`)}),ee.join("")}},legend:{top:0},grid:{left:56,right:70,top:44,bottom:32},xAxis:{type:"category",data:s},yAxis:[{type:"value",name:"Cashflow",axisLabel:{formatter:h=>be(h)}},{type:"value",name:"Kontostand",position:"right",axisLabel:{formatter:h=>j(h)}}],series:[{name:"Einzahlungen",type:"bar",stack:"cash",data:D.map(h=>Number(h.inflow||0)),itemStyle:{color:"#27ae60"}},{name:"Auszahlungen",type:"bar",stack:"cash",data:D.map(h=>-Number(h.outflow||0)),itemStyle:{color:"#e74c3c"}},{name:"Netto",type:"line",smooth:!0,data:D.map(h=>Number(h.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:E,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:Y,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend (nicht robust)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:Ce,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:Ae,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}},...y?[{name:"Simulation",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:N,lineStyle:{width:2,type:"dashed",color:"#f59e0b"},itemStyle:{color:"#f59e0b"}}]:[]]}},[o.monthMap,D,de,y,R,x]),Nt=g.useMemo(()=>[{header:"Monat",accessorKey:"month"},{header:"Plan Umsatz",cell:({row:s})=>j(s.original.plannedRevenue)},{header:"Ist Umsatz",cell:({row:s})=>j(s.original.actualRevenue)},{header:"Delta Umsatz",cell:({row:s})=>e.jsx("span",{className:Number(s.original.revenueDelta||0)<0?"v2-negative":void 0,children:j(s.original.revenueDelta)})},{header:"Delta Umsatz %",cell:({row:s})=>Te(s.original.revenueDeltaPct)},{header:"Plan Kontostand",cell:({row:s})=>j(s.original.plannedClosing)},{header:"Ist Kontostand",cell:({row:s})=>j(s.original.actualClosing)},{header:"Delta Kontostand",cell:({row:s})=>e.jsx("span",{className:Number(s.original.closingDelta||0)<0?"v2-negative":void 0,children:j(s.original.closingDelta)})}],[]),Mt=g.useMemo(()=>[{title:"Check",dataIndex:"label",key:"label"},{title:"Status",dataIndex:"status",key:"status",width:130,render:s=>as(s)},{title:"Detail",dataIndex:"detail",key:"detail",width:320,render:s=>e.jsx(k,{type:"secondary",children:s})},{title:"",key:"route",width:132,render:(s,d)=>e.jsx(Z,{size:"small",onClick:()=>a(Ue({route:d.route,checkKey:d.key,month:(L==null?void 0:L.month)||null})),children:"Öffnen"})}],[a,L==null?void 0:L.month]),Ct=g.useMemo(()=>R.map(s=>{var Ae;const d=Ye.get(s.month)||[],b=os.map(N=>({...N,rows:d.filter(h=>h.group===N.key)})).filter(N=>N.rows.length>0),E=d.filter(N=>N.group==="inflow"),Y=d.filter(N=>N.amount<0),Ce=((Ae=o.monthMap.get(s.month))==null?void 0:Ae.robust)||!1;return{key:s.month,label:e.jsxs("div",{className:"v2-dashboard-pnl-header",children:[e.jsx(k,{strong:!0,children:te(s.month)}),e.jsxs(le,{wrap:!0,children:[e.jsxs(m,{color:"green",children:["Einzahlungen: ",j(pe(E))]}),e.jsxs(m,{color:"red",children:["Auszahlungen: ",j(Math.abs(pe(Y)))]}),e.jsxs(m,{color:s.net>=0?"green":"red",children:["Netto: ",j(s.net)]}),e.jsxs(m,{color:Ce?"green":"red",children:["Robust: ",Ce?"ja":"nein"]})]})]}),children:e.jsx("div",{className:"v2-dashboard-pnl-month",children:b.map(N=>{if(N.key==="po_fo"){const h=new Map;N.rows.forEach(H=>{const ee=`${H.source}:${H.sourceNumber||H.label}`,fe=h.get(ee)||[];fe.push(H),h.set(ee,fe)});const A=Array.from(h.entries()).map(([H,ee])=>{var rt;const[fe,Q]=H.split(":"),je=pe(ee),De=(rt=ee.find(K=>K.tooltipMeta))==null?void 0:rt.tooltipMeta;return{key:H,label:e.jsxs("div",{className:"v2-dashboard-pnl-order-row",children:[e.jsxs(k,{strong:!0,children:[String(fe).toUpperCase()," ",Q||"—"]}),e.jsxs(le,{size:6,children:[e.jsx(m,{color:je<0?"red":"green",children:be(je)}),(De==null?void 0:De.units)!=null?e.jsxs(m,{children:["Stück: ",ve(De.units,0)]}):null]})]}),children:e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:ee.map((K,wt)=>{var at;const ot=K.tooltipMeta?e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("strong",{children:[String(K.source).toUpperCase()," ",K.sourceNumber||"—"]})}),e.jsxs("div",{children:["Alias: ",K.tooltipMeta.aliases.join(", ")||"-"]}),e.jsxs("div",{children:["Stückzahl: ",K.tooltipMeta.units!=null?ve(K.tooltipMeta.units,0):"-"]}),e.jsxs("div",{children:["Fälligkeit: ",Re(K.tooltipMeta.dueDate)]})]}):null;return e.jsxs("tr",{children:[e.jsx("td",{children:ot?e.jsx(xe,{title:ot,children:K.label}):K.label}),e.jsx("td",{className:K.amount<0?"v2-negative":void 0,children:be(K.amount)}),e.jsx("td",{children:Re((at=K.tooltipMeta)==null?void 0:at.dueDate)}),e.jsx("td",{children:K.paid==null?e.jsx(m,{children:"—"}):K.paid?e.jsx(m,{color:"green",children:"Bezahlt"}):e.jsx(m,{color:"gold",children:"Offen"})})]},`${H}-${wt}`)})})]})})}});return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(k,{strong:!0,children:N.label}),e.jsx(m,{color:"blue",children:be(pe(N.rows))})]}),e.jsx(J,{size:"small",items:A})]},`${s.month}-${N.key}`)}return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(k,{strong:!0,children:N.label}),e.jsx(m,{color:pe(N.rows)<0?"red":"green",children:be(pe(N.rows))})]}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:N.rows.map((h,A)=>e.jsxs("tr",{children:[e.jsx("td",{children:h.label}),e.jsx("td",{className:h.amount<0?"v2-negative":void 0,children:be(h.amount)}),e.jsx("td",{children:h.paid==null?e.jsx(m,{children:"—"}):h.paid?e.jsx(m,{color:"green",children:"Bezahlt"}):e.jsx(m,{color:"gold",children:"Offen"})})]},`${s.month}-${N.key}-${A}`))})]})})]},`${s.month}-${N.key}`)})})}}),[Ye,o.monthMap,R]);async function At(){y&&(await i(s=>{const d=lt(s),b=d,E=y.label||Ie(y.type);if(y.type==="dividend"){const Y=Array.isArray(b.dividends)?[...b.dividends]:[];Y.push({id:`div-${Date.now()}`,month:y.month,label:E,amountEur:Math.abs(y.amount)}),b.dividends=Y}else{const Y=Array.isArray(b.extras)?[...b.extras]:[];Y.push({id:`extra-${Date.now()}`,month:y.month,label:E,amountEur:-Math.abs(y.amount)}),b.extras=Y}return d},`v2:dashboard:simulation-commit:${y.type}`),u(null),I(""))}async function Dt(){V.comparedAt&&await i(s=>{const d=lt(s),b=d;(!b.forecast||typeof b.forecast!="object")&&(b.forecast={});const E=b.forecast;return E.lastDriftReviewedAt=rs(),E.lastDriftReviewedComparedAt=V.comparedAt,d},"v2:dashboard:forecast-drift-reviewed")}return((tt=(et=t.settings)==null?void 0:et.featureFlags)==null?void 0:tt.executiveDashboardV2)!==!1?e.jsxs("div",{className:"v2-page",children:[e.jsxs(F,{className:"v2-intro-card",children:[e.jsxs("div",{className:"v2-page-head",children:[e.jsxs("div",{children:[e.jsx(oe,{level:3,children:"Dashboard"}),e.jsx(ce,{children:"Executive-Cockpit für Kontostand, Robustheit und Maßnahmenpriorisierung. Nicht robuste Monate sind klar markiert."})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(k,{children:"Zeitraum"}),e.jsx(_e,{value:v,onChange:s=>f(s),options:ct.map(s=>({value:s.value,label:s.label})),style:{width:220,maxWidth:"100%"}})]})]}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(Z,{onClick:()=>a("/v2/forecast"),children:"Zur Absatzprognose"}),e.jsx(Z,{onClick:()=>a("/v2/inventory/projektion"),children:"Zur Bestandsprojektion"}),e.jsx(Z,{onClick:()=>a("/v2/orders/po"),children:"Zu Bestellungen"}),e.jsx(Z,{onClick:()=>a("/v2/abschluss/eingaben"),children:"Zum Abschluss"})]}),e.jsxs(k,{type:"secondary",children:["Aktueller Betrachtungszeitraum: ",x.length," Monat(e)."]})]})]}),r?e.jsx(Se,{type:"error",showIcon:!0,message:r}):null,n?e.jsx(Se,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"signals",label:"Executive Signals",children:e.jsxs("div",{className:"v2-dashboard-signal-grid",children:[e.jsxs(F,{className:"v2-dashboard-signal-card v2-dashboard-readiness-card",children:[e.jsx(re,{title:Pe("Readiness Gate","Go/No-Go vor großer Datenpflege. Alle Checks müssen grün sein."),value:p.ready?"Bereit":"Nicht bereit"}),e.jsxs(le,{wrap:!0,children:[e.jsx(m,{color:p.ready?"green":"red",children:p.ready?"Go":"No-Go"}),e.jsxs(m,{color:p.ready?"green":"gold",children:[p.robustMonthsCount,"/",p.robustRequiredCount," robuste Monate"]})]}),!p.ready&&p.blockers.length?e.jsx("div",{className:"v2-dashboard-readiness-blockers",children:p.blockers.slice(0,2).map(s=>e.jsxs("div",{className:"v2-dashboard-readiness-blocker-item",children:[e.jsxs(k,{type:"secondary",children:[s.label,": ",s.message]}),e.jsx(Z,{size:"small",onClick:()=>a(s.route),children:"Öffnen"})]},s.id))}):e.jsx(k,{type:"secondary",children:"Alle Gate-Checks erfüllt."})]}),e.jsxs(F,{className:"v2-dashboard-signal-card",children:[e.jsx(re,{title:Pe("Robust bis","Letzter Monat, in dem alle Hard-Checks erfüllt sind. Danach ist der Kontostand nur Orientierung."),value:o.robustUntilMonth?te(o.robustUntilMonth):"—"}),e.jsxs(k,{type:"secondary",children:[o.robustMonthsCount,"/",o.totalMonths," Monate robust"]})]}),e.jsxs(F,{className:"v2-dashboard-signal-card",children:[e.jsx(re,{title:Pe("Erster negativer Monat (robust)","Erster belastbarer Monat mit negativem Kontostand. Nicht robuste Monate werden dafür ignoriert."),value:We?te(We):"Keiner"}),e.jsx(k,{type:"secondary",children:"Simulation wird berücksichtigt"})]}),e.jsxs(F,{className:"v2-dashboard-signal-card",children:[e.jsx(re,{title:Pe("Freier Cash nach Buffer","Minimaler belastbarer Kontostand minus Sicherheitsreserve aus 2 Monaten Fixkosten."),value:Ze!=null?j(Ze):"—"}),e.jsxs(k,{type:"secondary",children:["Buffer (2M Fixkosten): ",j(G)]})]}),e.jsxs(F,{className:"v2-dashboard-signal-card",children:[e.jsxs("div",{className:"v2-dashboard-forecast-status-head",children:[e.jsxs(k,{strong:!0,children:["Forecast Freshness",e.jsx(xe,{title:"Ampel nach Importalter: Grün <=35 Tage, Gelb 36-45 Tage, Rot >45 Tage.",children:e.jsx(mt,{className:"v2-dashboard-inline-info"})})]}),e.jsx(m,{color:me==="fresh"?"green":me==="aging"?"gold":me==="stale"?"red":"default",children:me==="fresh"?"Grün":me==="aging"?"Gelb":me==="stale"?"Rot":"Keine Daten"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-status-meta",children:[e.jsx("div",{children:yt}),e.jsxs("div",{children:["Letzter Import: ",Re(Oe)]}),e.jsxs("div",{children:["Nächster Import empfohlen: ",Xe?Xe.toLocaleDateString("de-DE"):"—"]})]})]})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"cashflow",label:"Kontostand & Cashflow",children:e.jsxs(F,{className:"v2-dashboard-chart-card",children:[e.jsx(oe,{level:4,children:"Kontostand & Cashflow"}),e.jsxs(le,{wrap:!0,children:[e.jsxs(m,{color:"green",children:["Einzahlungen: ",j(Me)]}),e.jsxs(m,{color:"red",children:["Auszahlungen: ",j(He)]}),e.jsxs(m,{color:ye>=0?"green":"red",children:["Netto: ",j(ye)]}),e.jsxs(m,{color:y?"gold":"default",children:["Simulation: ",y?"aktiv":"aus"]})]}),e.jsxs("div",{className:"v2-dashboard-legend-help",children:[e.jsx(xe,{title:"Durchgezogene Linie: belastbarer Kontostand (alle Hard-Checks bestanden).",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Linie solid = belastbar"})}),e.jsx(xe,{title:"Gestrichelte Linie: orientierend, weil mindestens ein Hard-Check fehlt.",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Linie gestrichelt = orientierend"})}),e.jsx(xe,{title:"Rot markiert: Kontostand liegt unter 0 im jeweiligen Zustand.",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Rot = unter 0"})})]}),e.jsx(Kt,{style:{height:380},option:St})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"actions",label:"Action Center & Forecast Ops",children:e.jsxs(it,{gutter:[12,12],children:[e.jsx(ge,{xs:24,xl:14,children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Action Center"}),e.jsx(ce,{type:"secondary",children:"Priorisierte Maßnahmen, damit der Kontostand wieder belastbar wird."}),o.actions.length?e.jsx("div",{className:"v2-dashboard-actions",children:o.actions.map(s=>e.jsxs("div",{className:`v2-dashboard-action-card is-${s.severity}`,children:[e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:s.title}),e.jsx("div",{className:"v2-dashboard-action-detail",children:s.detail}),e.jsxs("div",{className:"v2-dashboard-action-impact",children:["Impact: ",s.impact]})]}),e.jsxs("div",{className:"v2-dashboard-action-meta",children:[e.jsx(m,{color:s.severity==="error"?"red":"gold",children:s.count}),e.jsx(Z,{size:"small",onClick:()=>a(Ue({route:s.route,actionId:s.id,month:jt})),children:"Öffnen"})]})]},s.id))}):e.jsx(Se,{type:"success",showIcon:!0,message:"Keine offenen Hard-Blocker im gewählten Zeitraum."})]})}),e.jsx(ge,{xs:24,xl:10,children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Forecast Ops"}),e.jsxs(ce,{type:"secondary",children:["Monatlicher Import mit Drift-Alarm (A/B Fokus, Profil: ",V.thresholdProfile,")."]}),e.jsxs(le,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(m,{color:Le?"green":"gold",children:["Drift-Review: ",Le?"geprüft":"offen"]}),ze?e.jsxs(m,{children:["Geprüft am: ",new Date(ze).toLocaleDateString("de-DE")]}):null,e.jsx(Z,{size:"small",onClick:()=>{Dt()},disabled:!V.comparedAt||Le||l,children:"Drift geprüft"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-ops",children:[e.jsxs("div",{children:["Flagged SKUs: ",e.jsx("strong",{children:ve(V.flaggedSkuCount,0)})]}),e.jsxs("div",{children:["Flagged A/B: ",e.jsx("strong",{children:ve(V.flaggedABCount,0)})]}),e.jsxs("div",{children:["Flagged SKU-Monate: ",e.jsx("strong",{children:ve(V.flaggedMonthCount,0)})]}),e.jsxs("div",{children:["Verglichen am: ",e.jsx("strong",{children:Re(V.comparedAt)})]})]}),V.topItems.length?e.jsxs("div",{className:"v2-dashboard-drift-list",children:[V.topItems.slice(0,5).map((s,d)=>e.jsxs("div",{className:"v2-dashboard-drift-item",children:[e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:s.sku}),e.jsxs(k,{type:"secondary",children:[" · ",te(s.month)," · ",s.abcClass]})]}),e.jsxs("div",{children:["ΔUnits ",ve(s.deltaUnits,0)," · ΔUmsatz ",j(s.deltaRevenue)," · Δ% ",Te(s.deltaPct)]})]},`${s.sku}-${s.month}-${d}`)),e.jsx(Z,{size:"small",onClick:()=>a("/v2/forecast"),children:"Zur Forecast-Prüfung"})]}):e.jsx(Se,{type:"success",showIcon:!0,message:"Keine kritischen Drift-Abweichungen im letzten Vergleich."})]})})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"robustness",label:"Robustheits-Matrix",children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Robustheits-Matrix"}),e.jsx(ce,{type:"secondary",children:"Ein Monat ist nur robust, wenn alle Hard-Checks erfüllt sind (Coverage 100 %, Cash-In, Fixkosten, VAT und Revenue-Basis)."}),e.jsx("div",{className:"v2-dashboard-robust-grid",children:o.months.map(s=>{const d=we(s.month),b=d!=null&&Je!=null&&d<Je;return e.jsxs("button",{type:"button",className:["v2-dashboard-robust-item",c===s.month?"is-selected":"",s.robust?"is-robust":"is-open",b?"is-past":""].filter(Boolean).join(" "),onClick:()=>S(s.month),children:[e.jsxs("div",{className:"v2-dashboard-robust-item-head",children:[e.jsx("span",{children:te(s.month)}),e.jsx(m,{color:b?"default":s.robust?"green":"red",children:b?"Vergangen (Info)":s.robust?"Robust":"Offen"})]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Coverage: ",Te(s.coverage.ratio*100)," (",s.coverage.coveredSkus,"/",s.coverage.activeSkus,")"]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Blocker: ",s.blockerCount]})]},s.month)})}),L?e.jsxs("div",{className:"v2-dashboard-robust-detail",children:[e.jsxs("div",{className:"v2-dashboard-robust-detail-head",children:[e.jsx(k,{strong:!0,children:te(L.month)}),e.jsxs(le,{children:[e.jsx(m,{color:L.robust?"green":"red",children:L.robust?"Robust":"Nicht robust"}),e.jsxs(m,{children:["A/B Risiko: ",L.coverage.abRiskSkuCount]})]})]}),e.jsx(Ut,{size:"small",pagination:!1,rowKey:"key",columns:Mt,dataSource:L.checks}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsx(k,{strong:!0,children:"Blocker"}),L.blockers.length?e.jsx("div",{className:"v2-dashboard-blocker-list",children:L.blockers.map(s=>e.jsxs("div",{className:"v2-dashboard-blocker-item",children:[e.jsxs("div",{children:[e.jsx(k,{children:s.message}),s.sku?e.jsxs(k,{type:"secondary",children:[" · ",s.sku]}):null]}),e.jsx(Z,{size:"small",onClick:()=>a(Ue({route:s.route,checkKey:s.checkKey,month:s.month,sku:s.sku||null})),children:"Öffnen"})]},s.id))}):e.jsx(k,{type:"secondary",children:"Keine Blocker in diesem Monat."})]})]}):null]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"simulation",label:"Payout Planner (Simulation)",children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Payout Planner (Simulation)"}),e.jsx(ce,{type:"secondary",children:"Einmalige Dividenden oder CAPEX simulieren und optional als echten Eintrag übernehmen."}),e.jsxs("div",{className:"v2-dashboard-sim-grid",children:[e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(k,{children:"Typ"}),e.jsx(_e,{value:C,onChange:s=>se(s),options:[{value:"dividend",label:"Dividende"},{value:"capex",label:"CAPEX"}]})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(k,{children:"Monat"}),e.jsx(_e,{value:W,onChange:s=>_(s),options:x.map(s=>({value:s,label:te(s)}))})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(k,{children:"Betrag (EUR)"}),e.jsx(Gt,{value:Number.isFinite(T)?T:null,onChange:s=>u(typeof s=="number"?s:null),min:0,controls:!1,placeholder:"0"})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(k,{children:"Label"}),e.jsx(It,{value:P,onChange:s=>I(s.target.value),placeholder:Ie(C)})]})]}),e.jsxs("div",{className:"v2-dashboard-sim-status",children:[e.jsx(m,{color:y?"gold":"default",children:y?"Simulation aktiv":"Keine Simulation"}),e.jsxs(m,{color:G>0?"blue":"red",children:["Buffer-Ziel: ",j(G)]}),y&&G<=0?e.jsx(m,{color:"red",children:"Fixkostenbasis fehlt"}):null,y&&G>0?e.jsx(m,{color:qe?"green":"red",children:qe?"Sicher":`Kritisch ab ${Be?te(Be):"sofort"}`}):null]}),e.jsxs(le,{children:[e.jsx(Z,{onClick:()=>{u(null),I("")},children:"Simulation zurücksetzen"}),e.jsx(Z,{type:"primary",onClick:()=>{At()},disabled:!y,loading:l,children:"Als echten Eintrag übernehmen"})]})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"pnl",label:"Monatliche PnL (Drilldown)",children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Monatliche PnL (Drilldown)"}),e.jsx(ce,{type:"secondary",children:"Einzahlungen, PO/FO-Zahlungen, Fixkosten und Steuern je Monat. PO/FO-Positionen sind bis auf Milestone-Ebene aufklappbar."}),e.jsx(J,{className:"v2-dashboard-pnl-collapse",activeKey:M,onChange:s=>O(Array.isArray(s)?s.map(String):[String(s)]),items:Ct})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"actuals",label:"Plan/Ist Drilldown",children:e.jsxs(F,{children:[e.jsx(oe,{level:4,children:"Plan/Ist Drilldown"}),e.jsx(ce,{type:"secondary",children:"Monatsvergleich zwischen geplantem und erfasstem Istwert aus den Monats-Ist-Daten."}),e.jsx(Bt,{data:Ke,columns:Nt,minTableWidth:980,tableLayout:"auto"})]})}]}),e.jsx(J,{className:"v2-dashboard-module-collapse",items:[{key:"kpis",label:"KPI-Übersicht",children:e.jsxs(it,{gutter:[12,12],children:[e.jsx(ge,{xs:24,md:12,xl:6,children:e.jsx(F,{children:e.jsx(re,{title:"Opening Balance",value:Number(((st=z.kpis)==null?void 0:st.opening)||0),formatter:s=>j(s)})})}),e.jsx(ge,{xs:24,md:12,xl:6,children:e.jsx(F,{children:e.jsx(re,{title:"Sales Payout Ø",value:Number(((nt=z.kpis)==null?void 0:nt.salesPayoutAvg)||0),formatter:s=>j(s)})})}),e.jsx(ge,{xs:24,md:12,xl:6,children:e.jsx(F,{children:e.jsx(re,{title:"Robuste Monate",value:`${o.robustMonthsCount}/${o.totalMonths}`})})}),e.jsx(ge,{xs:24,md:12,xl:6,children:e.jsx(F,{children:e.jsx(re,{title:"Letzter Kontostand",value:Number((X==null?void 0:X.closing)||0),formatter:s=>j(s)})})})]})}]})]}):e.jsx("div",{className:"v2-page",children:e.jsx(Se,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{Os as default};
