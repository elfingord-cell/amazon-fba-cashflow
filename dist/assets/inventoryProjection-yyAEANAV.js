import{p as v}from"./index-DZx8ouWC.js";function b(n){if(!n)return null;const t=String(n);if(/^\d{4}-\d{2}$/.test(t))return t;const r=t.match(/^(\d{2})-(\d{4})$/);return r?`${r[2]}-${r[1]}`:t}function C(n){return String(n||"").trim()}function mn(n){if(!n)return!1;if(typeof n.active=="boolean")return n.active;const t=String(n.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function an(n){if(!/^\d{4}-\d{2}$/.test(n||""))return 30;const[t,r]=n.split("-").map(Number);return new Date(t,r,0).getDate()}function H(n){if(!/^\d{4}-\d{2}$/.test(n||""))return null;const[t,r]=n.split("-").map(Number);return!t||!r?null:{year:t,monthIndex:r-1}}function P(n,t){const r=H(n),e=H(t);if(!r||!e)return String(n||"").localeCompare(String(t||""));const c=r.year*12+r.monthIndex,o=e.year*12+e.monthIndex;return c-o}function Y(n,t){const r=H(n);if(!r)return null;const e=new Date(r.year,r.monthIndex,1);return e.setMonth(e.getMonth()+Number(t||0)),`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function cn(n,t){if(!n||!t)return[];if(P(n,t)>=0)return[];const r=[];let e=Y(n,1);for(;e&&P(e,t)<=0;)r.push(e),e=Y(e,1);return r}function $(n){if(!n)return null;const t=new Date(n);return Number.isNaN(t.getTime())?null:t}function ln(n){return!(n instanceof Date)||Number.isNaN(n.getTime())?null:`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function Nn(n){const t=$((n==null?void 0:n.etaManual)||(n==null?void 0:n.etaDate)||(n==null?void 0:n.eta));if(t)return t;const r=$(n==null?void 0:n.etaComputed);if(r)return r;const e=$(n==null?void 0:n.orderDate);if(!e)return null;const c=Number((n==null?void 0:n.prodDays)||0),o=Number((n==null?void 0:n.transitDays)||0),a=new Date(e.getTime());return a.setDate(a.getDate()+Math.max(0,c+o)),a}function Dn(n){return $((n==null?void 0:n.targetDeliveryDate)||(n==null?void 0:n.deliveryDate)||(n==null?void 0:n.etaDate))}function kn(n){const t=String(n||"").trim().toUpperCase();return t?t==="PLANNED"?"ACTIVE":t==="CANCELLED"?"ARCHIVED":t:"DRAFT"}function Fn(n){const t=kn(n==null?void 0:n.status);return t==="DRAFT"||t==="ACTIVE"}function fn(n,t,r){var l,f,M,h,i,d,y;const e=b(r);if(!e)return null;const c=(M=(f=(l=n==null?void 0:n.forecast)==null?void 0:l.forecastManual)==null?void 0:f[t])==null?void 0:M[e],o=v(c);if(Number.isFinite(o))return o;const a=(y=(d=(i=(h=n==null?void 0:n.forecast)==null?void 0:h.forecastImport)==null?void 0:i[t])==null?void 0:d[e])==null?void 0:y.units,s=v(a);return Number.isFinite(s)?s:null}function vn(n,t,r){n.has(t)||n.set(t,new Map);const e=n.get(t);return e.has(r)||e.set(r,{totalUnits:0,poUnits:0,foUnits:0,poItems:[],foItems:[]}),e.get(r)}function An(n,t){const r=new Set(t),e=new Map,c=new Map;let o=0;const a=({sku:s,month:l,units:f,source:M,recordId:h,recordNo:i,arrivalDate:d,arrivalSource:y})=>{if(!s||!r.has(l)||!f)return;e.has(s)||e.set(s,new Map);const m=e.get(s);m.set(l,(m.get(l)||0)+f);const g=vn(c,s,l),R={id:String(h||""),ref:String(i||"â€”"),units:f,arrivalDate:d||null,arrivalSource:y||null};M==="fo"?(g.foUnits+=f,g.foItems.push(R)):(g.poUnits+=f,g.poItems.push(R)),g.totalUnits+=f};return((n==null?void 0:n.pos)||[]).forEach(s=>{if(!s||s.archived||String(s.status||"").toUpperCase()==="CANCELLED")return;const l=Nn(s),f=l?ln(l):null;if(!f){o+=1;return}const M=l.toISOString().slice(0,10);(Array.isArray(s.items)&&s.items.length?s.items:[{sku:s.sku,units:s.units}]).forEach(i=>{const d=C((i==null?void 0:i.sku)||(s==null?void 0:s.sku));if(!d)return;const y=(i==null?void 0:i.units)??(i==null?void 0:i.qty)??(i==null?void 0:i.quantity)??(s==null?void 0:s.units),m=v(y),g=Number.isFinite(m)?Math.round(m):0;g&&a({sku:d,month:f,units:g,source:"po",recordId:s.id,recordNo:s.poNo||s.id,arrivalDate:M,arrivalSource:"ETA"})})}),((n==null?void 0:n.fos)||[]).forEach(s=>{if(!s||!Fn(s))return;const l=Dn(s),f=l?ln(l):null;if(!f){o+=1;return}const M=l.toISOString().slice(0,10);(Array.isArray(s.items)&&s.items.length?s.items:[{sku:s.sku,units:s.units}]).forEach(i=>{const d=C((i==null?void 0:i.sku)||(s==null?void 0:s.sku));if(!d)return;const y=(i==null?void 0:i.units)??(i==null?void 0:i.qty)??(i==null?void 0:i.quantity)??(s==null?void 0:s.units),m=v(y),g=Number.isFinite(m)?Math.round(m):0;g&&a({sku:d,month:f,units:g,source:"fo",recordId:s.id,recordNo:s.foNo||s.id,arrivalDate:M,arrivalSource:"DELIVERY"})})}),{inboundUnitsMap:e,inboundDetailsMap:c,inboundMissingDateCount:o}}function wn(n,t=null){var c;const r=(((c=n==null?void 0:n.inventory)==null?void 0:c.snapshots)||[]).filter(o=>(o==null?void 0:o.month)&&b(o.month)).slice().sort((o,a)=>b(o.month).localeCompare(b(a.month)));if(!r.length)return null;const e=b(t);if(!e)return r[r.length-1];for(let o=r.length-1;o>=0;o-=1){const a=r[o],s=b(a==null?void 0:a.month);if(s&&P(s,e)<=0)return a}return null}function Un(n){var t;return(((t=n==null?void 0:n.inventory)==null?void 0:t.snapshots)||[]).filter(r=>(r==null?void 0:r.month)&&b(r.month)).slice().sort((r,e)=>b(r.month).localeCompare(b(e.month)))}function hn(n){const t=v(n==null?void 0:n.amazonUnits),r=v(n==null?void 0:n.threePLUnits),e=v(n==null?void 0:n.units);return Number.isFinite(t)||Number.isFinite(r)?(Number.isFinite(t)?Number(t):0)+(Number.isFinite(r)?Number(r):0):Number.isFinite(e)?Number(e):0}function Cn(n,t=null){const r=b(t),e=Un(n),c=new Map;return e.forEach(o=>{const a=b(o==null?void 0:o.month);if(!a||r&&P(a,r)>0)return;(Array.isArray(o==null?void 0:o.items)?o.items:[]).forEach(l=>{const f=C(l==null?void 0:l.sku);f&&c.set(f,{month:a,units:hn(l)})})}),c}function z(n){const t=v(n);return!Number.isFinite(t)||t<=0?null:Math.round(t)}function In(n,t){var c,o,a;const r=z(n==null?void 0:n.safetyStockDohOverride);return r??z(((c=t==null?void 0:t.settings)==null?void 0:c.safetyStockDohDefault)??((a=(o=t==null?void 0:t.inventory)==null?void 0:o.settings)==null?void 0:a.safetyDays))}function Bn(n,t){var c;const r=z(n==null?void 0:n.foCoverageDohOverride);return r??z((c=t==null?void 0:t.settings)==null?void 0:c.foCoverageDohDefault)}function Ln({endAvailable:n,safetyUnits:t,doh:r,safetyDays:e,projectionMode:c="units"}){return(c==="doh"?"doh":"units")==="doh"?Number.isFinite(r)?r<=0?"safety-negative":Number.isFinite(e)&&r<e?"safety-low":"":"":Number.isFinite(n)?n<=0?"safety-negative":Number.isFinite(t)&&n<t?"safety-low":"":""}function Pn({state:n,months:t,products:r,snapshot:e,snapshotMonth:c,projectionMode:o="units"}){const a=(Array.isArray(t)?t:[]).map(S=>b(S)).filter(Boolean),s=Array.isArray(r)?r:(n==null?void 0:n.products)||[],l=a[0]||null,f=b(c||(e==null?void 0:e.month)),M=l?Y(l,-1):null;let h=f||M;h&&l&&P(h,l)>=0&&M&&(h=M);const d=(e&&Array.isArray(e.items)?e:null)||wn(n,h),y=b(d==null?void 0:d.month),m=!!(f&&y&&f!==y);h=h||y||M||null;const g=new Map;d&&Array.isArray(d.items)&&d.items.forEach(S=>{const u=C(S==null?void 0:S.sku);u&&g.set(u,hn(S))});const R=Cn(n,h),I=new Map,E=new Map,V=new Set,G=new Set,p=new Map,J=new Set(a);s.forEach(S=>{var x;const u=C(S==null?void 0:S.sku);if(!u)return;if(g.has(u)&&y)I.set(u,{type:"anchor_snapshot",month:y}),E.set(u,g.get(u));else{const k=R.get(u)||null;k?(I.set(u,{type:"sku_fallback",month:k.month}),E.set(u,k.units),V.add(u)):(I.set(u,{type:"missing_history",month:null}),E.set(u,0),G.add(u))}const T=((x=I.get(u))==null?void 0:x.month)||null,A=cn(T,h);p.set(u,A),A.forEach(k=>J.add(k))});const dn=Array.from(J),{inboundUnitsMap:O,inboundDetailsMap:Q,inboundMissingDateCount:yn}=An(n,dn),W=new Map,X=new Set,Z=o==="doh"?"doh":"units",nn=new Set,tn=new Map;s.forEach(S=>{const u=C(S==null?void 0:S.sku);if(!u)return;mn(S)&&X.add(u);const T=E.has(u)?E.get(u):0;let A=Number.isFinite(T)?T:0;(p.get(u)||[]).forEach(N=>{var L;const D=((L=O.get(u))==null?void 0:L.get(N))||0,F=fn(n,u,N);Number.isFinite(F)||nn.add(u);const U=Number.isFinite(F)?Number(F):0;A=A+D-U});let k=A,j=!1;const rn=new Map,B=In(S,n);a.forEach(N=>{var on,un;const D=fn(n,u,N),F=Number.isFinite(D),U=((on=Q.get(u))==null?void 0:on.get(N))||null,L=(U==null?void 0:U.totalUnits)||((un=O.get(u))==null?void 0:un.get(N))||0;let w=null;!j&&F?(w=k+L-D,k=w):j=!0;const bn=!F||j,q=F&&D>0?D/an(N):null,K=Number.isFinite(w)&&Number.isFinite(q)&&q>0?Math.max(0,Math.round(w/q)):null,_=Number.isFinite(D)&&Number.isFinite(B)?Math.round(D/an(N)*B):null,en=Number.isFinite(K)&&Number.isFinite(B)&&K>=B,sn=Number.isFinite(w)&&Number.isFinite(_)&&w>=_,Mn=Z==="doh"?en:sn;rn.set(N,{forecastUnits:D,hasForecast:F,inboundUnits:L,inboundDetails:U,endAvailable:w,safetyDays:B,safetyUnits:_,doh:K,passesDoh:en,passesUnits:sn,isCovered:Mn,forecastMissing:bn})}),W.set(u,rn),tn.set(u,A)});const Sn=cn(y,h),gn=y?Sn.length?"rollforward":"snapshot":"no_snapshot";return{months:a,perSkuMonth:W,inboundUnitsMap:O,inboundDetailsMap:Q,snapshot:d,resolvedSnapshotMonth:y,snapshotFallbackUsed:m,inboundMissingDateCount:yn,startAvailableBySku:tn,projectionMode:Z,activeSkus:X,anchorMonth:h,anchorTargetMonth:h,anchorSourceMonth:y,anchorMode:gn,anchorSourceBySku:I,anchorSkuFallbackCount:V.size,anchorSkuFallbackSkus:Array.from(V).sort(),anchorSkuMissingHistory:Array.from(G).sort(),anchorForecastGapSkus:Array.from(nn).sort()}}export{Bn as a,Pn as c,Ln as g,In as r};
