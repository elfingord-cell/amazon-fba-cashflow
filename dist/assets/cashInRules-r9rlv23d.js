const B=[3,6,12],b=40,f=60,ee=51;function S(e){if(e==null||typeof e=="string"&&e.trim()==="")return null;const t=Number(e);return Number.isFinite(t)?t:null}function h(e){return/^\d{4}-\d{2}$/.test(String(e||"").trim())}function w(e){if(!h(e))return null;const[t,n]=String(e).split("-").map(Number);return t*12+(n-1)}function te(e,t=6){const n=Math.round(Number(e||0));return B.includes(n)?n:B.includes(Math.round(Number(t||0)))?Math.round(Number(t||0)):6}function ne(e,t,n){const r=Number(e);if(!(Number.isFinite(r)&&r>0))return 1;const s=Math.max(1,Math.round(Number(t||1))),a=Math.max(0,Math.round(Number(n||0)));if(s<=1)return a===0?r:1;if(a>=s)return 1;const u=a/(s-1),l=r+(1-r)*u;return Number.isFinite(l)&&l>0?l:1}function N(e,t=b,n=f){const r=Number(e);return Number.isFinite(r)?Math.min(n,Math.max(t,r)):t}function C(e){if(e==null||String(e).trim()==="")return null;let t=Number(String(e).replace(",","."));return Number.isFinite(t)?(t>0&&t<=1&&(t*=100),t):null}function H(e){const t=(Array.isArray(e)?e:[]).map(r=>Number(r)).filter(r=>Number.isFinite(r)).sort((r,s)=>r-s);if(!t.length)return null;const n=Math.floor(t.length/2);return t.length%2===1?t[n]:(t[n-1]+t[n])/2}function G(e){const t=(Array.isArray(e)?e:[]).map(n=>Number(n)).filter(n=>Number.isFinite(n));return t.length?t.reduce((n,r)=>n+r,0)/t.length:null}function D(e){if(!h(e))return!1;const t=Number(String(e).slice(5,7));return t>=10&&t<=12}function re(e){if(!h(e))return null;const[t,n]=String(e).split("-").map(Number);return new Date(t,n,0).getDate()}function oe(e){if(!/^\d{4}-\d{2}-\d{2}$/.test(String(e||"").trim()))return null;const[t,n,r]=String(e).split("-").map(Number),s=new Date(t,n-1,r);return Number.isNaN(s.getTime())||s.getFullYear()!==t||s.getMonth()+1!==n||s.getDate()!==r?null:r}function se(e,t){return String(e||"").slice(0,7)===String(t||"")}function ae(e){const t=e&&typeof e=="object"?e:{},n=S(t.realRevenueEUR),r=C(t.realPayoutRatePct);if(Number.isFinite(n)&&n>0&&Number.isFinite(r))return Number(r);const s=S(t.realPayoutEUR??t.realPayoutEur);return Number.isFinite(n)&&n>0&&Number.isFinite(s)&&s>=0?Number(s)/Number(n)*100:null}function ie(e={}){const t=new Set;(Array.isArray(e.months)?e.months:[]).forEach(a=>{h(a)&&t.add(String(a))}),(Array.isArray(e.incomings)?e.incomings:[]).forEach(a=>{if(!a||typeof a!="object")return;const u=String(a.month||"").trim();h(u)&&t.add(u)});const s=e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{};return Object.keys(s).forEach(a=>{h(a)&&t.add(a)}),Array.from(t).sort((a,u)=>a.localeCompare(u))}function le(e={}){const t=e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{},n=Array.isArray(e.incomings)?e.incomings:[],r=e.ignoreQ4===!0,s=h(e.maxMonth)?e.maxMonth:h(e.currentMonth)?e.currentMonth:null,a=h(e.currentMonth)?e.currentMonth:s,u=Math.max(1,Math.round(Number(e.minSamples||4))),l=C(e.baselineNormalPct),i=N(Number.isFinite(l)?Number(l):ee,b,f),c=Object.entries(t).map(([o,d])=>{if(!h(o)||s&&o>s)return null;const A=d&&typeof d=="object"?d:{},_=ae(A);return Number.isFinite(_)?{month:o,quotePct:N(Number(_),b,f),realRevenueEUR:S(A.realRevenueEUR),realPayoutRatePct:C(A.realPayoutRatePct)}:null}).filter(Boolean).sort((o,d)=>String(o.month).localeCompare(String(d.month))),P=new Map(c.map(o=>[String(o.month),o])),m=c.filter(o=>!D(o.month)),y=H(m.map(o=>o.quotePct)),F=G(m.map(o=>o.quotePct)),v=c.filter(o=>String(o.month).slice(5,7)==="12").sort((o,d)=>String(o.month).localeCompare(String(d.month))),M=v.length?v[v.length-1]:null,g=Number.isFinite(M==null?void 0:M.quotePct)?N(Number(M.quotePct),b,f):null,E=Number.isFinite(g)?i+.5*(Number(g)-i):i,z=N(E,b,f),I=C(e.baselineQ4Pct),q=N(Number.isFinite(I)?Number(I):z,b,f),$=Number.isFinite(I)?"manual":"suggested",R=a&&n.find(o=>String((o==null?void 0:o.month)||"")===a)||null,x=S(R==null?void 0:R.calibrationSellerboardMonthEndEur),Q=S(R==null?void 0:R.calibrationPayoutRateToDatePct),U=Number.isFinite(x)&&x>0&&Number.isFinite(Q)&&Q>=0?Number(Q)/Number(x)*100:null,p=Number.isFinite(U)?N(U,b,f):null,j=!!(a&&Number.isFinite(p)&&(!D(a)||r)),T=j?[...m.map(o=>o.quotePct),Number(p)]:m.map(o=>o.quotePct),W=H(T),L=G(T),k=ie({months:e.months,incomings:n,monthlyActuals:t}),O={};k.forEach(o=>{const d=P.get(o);if(d){O[o]={month:o,quotePct:N(d.quotePct,b,f),sourceTag:"IST",explanation:"IST: Auszahlungsquote aus Monats-Istwerten."};return}if(a&&o===a&&Number.isFinite(p)){O[o]={month:o,quotePct:Number(p),sourceTag:"PROGNOSE",explanation:"PROGNOSE: Auszahlung Monatsende / Umsatzprognose Monatsende."};return}const A=D(o)&&!r,_=A?q:i,J=A?"BASELINE_Q4":"BASELINE_NORMAL",V=A?"Baseline Q4: Q4 = Normal + 0,5 * (Dez - Normal) (manuell ueberschreibbar).":"Baseline Normal: manuell gesetzter Referenzwert.";O[o]={month:o,quotePct:_,sourceTag:J,explanation:V}});const K=Number.isFinite(y)?N(y,b,f):null,X=Number.isFinite(F)?N(F,b,f):null,Y=Number.isFinite(W)?N(W,b,f):null,Z=Number.isFinite(L)?N(L,b,f):null;return{medianPct:i,sampleCount:c.length,usedMonths:c.map(o=>o.month),uncertain:c.length<u,ignoreQ4:r,minSamples:u,points:c,byMonth:O,baselineNormalPct:i,baselineQ4Pct:q,baselineQ4SuggestedPct:z,baselineQ4Source:$,decemberQuotePct:g,currentMonth:a,currentMonthForecastQuotePct:p,currentMonthForecastPointUsed:j,observedNormalMedianPct:K,observedNormalAveragePct:X,observedNormalSampleCount:m.length,observedNormalUsedMonths:m.map(o=>o.month),observedNormalWithForecastMedianPct:Y,observedNormalWithForecastAveragePct:Z,observedNormalWithForecastSampleCount:T.length}}function ue(e){return Array.isArray(e)?e.map(t=>{const n=t&&typeof t=="object"?t:{},r=h(n.month)?String(n.month):null;if(!r)return null;const s=n.calibrationCutoffDate?String(n.calibrationCutoffDate):"",a=S(n.calibrationRevenueToDateEur),u=S(n.calibrationSellerboardMonthEndEur);return{month:r,cutoffDate:s,revenueToDate:a,sellerboardMonthEnd:u}}).filter(Boolean).sort((t,n)=>t.month.localeCompare(n.month)):[]}function ce(e,t){const n=e.month,r=e.cutoffDate,s=e.revenueToDate,a=e.sellerboardMonthEnd,u=Number((t==null?void 0:t[n])||0);if(!(u>0))return{month:n,active:!1,reason:"missing_forecast_revenue",rawForecastRevenue:u};let l=null,i=null;if(Number.isFinite(a)&&a>=0)l=Number(a),i="sellerboard";else{if(!Number.isFinite(s))return{month:n,active:!1,reason:"missing_inputs",rawForecastRevenue:u};const P=!!r,m=Number.isFinite(s)&&s>=0;if(!P||!m)return{month:n,active:!1,reason:"missing_inputs",rawForecastRevenue:u};const y=oe(r),F=re(n);if(!y||!F||!se(r,n))return{month:n,active:!1,reason:"invalid_cutoff_date",rawForecastRevenue:u};l=Number(s)*(F/y),i="linear"}if(!(Number.isFinite(l)&&l>=0))return{month:n,active:!1,reason:"invalid_expected_revenue",rawForecastRevenue:u};const c=l/u;return!Number.isFinite(c)||c<=0?{month:n,active:!1,reason:"invalid_factor",rawForecastRevenue:u}:{month:n,active:!0,reason:"ok",method:i,rawFactor:c,rawForecastRevenue:u,expectedRevenue:l}}function me(e={}){const n=(Array.isArray(e.months)?e.months.filter(h):[]).slice().sort((i,c)=>i.localeCompare(c)),r=e.forecastRevenueByMonth&&typeof e.forecastRevenueByMonth=="object"?e.forecastRevenueByMonth:{},s=te(e.horizonMonths,6),u=ue(e.incomings).map(i=>ce(i,r)).filter(i=>i.active).sort((i,c)=>i.month.localeCompare(c.month)),l={};return n.forEach(i=>{const c=w(i);if(c==null){l[i]={month:i,active:!1,factor:1,sourceMonth:null,method:null,rawFactor:null,rawForecastRevenue:Number((r==null?void 0:r[i])||0),expectedRevenue:null,horizonOffset:null};return}const P=u.filter(M=>{const g=w(M.month);if(g==null||g>c)return!1;const E=c-g;return s<=1?E===0:E<s}).sort((M,g)=>M.month.localeCompare(g.month)),m=P.length?P[P.length-1]:null;if(!m){l[i]={month:i,active:!1,factor:1,sourceMonth:null,method:null,rawFactor:null,rawForecastRevenue:Number((r==null?void 0:r[i])||0),expectedRevenue:null,horizonOffset:null};return}const y=w(m.month),F=c-y,v=ne(m.rawFactor,s,F);l[i]={month:i,active:!0,factor:Number.isFinite(v)&&v>0?v:1,sourceMonth:m.month,method:m.method||null,rawFactor:Number(m.rawFactor),rawForecastRevenue:Number((r==null?void 0:r[i])||0),expectedRevenue:Number(m.expectedRevenue),horizonOffset:F}}),{horizonMonths:s,candidates:u,byMonth:l}}export{ee as C,f as a,b,N as c,le as d,me as e,ne as f,te as n,C as p};
