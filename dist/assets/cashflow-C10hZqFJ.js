import{g as se}from"./planProducts-Cw71DzXi.js";import{bx as re,P as mt,aa as Dt,a9 as Yt,by as Nt,K as Kt,bz as It,O as X}from"./index-BX0hCHd9.js";function ie(e){return Number.isFinite(e)?e:0}function P(e){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim().replace(/\./g,"").replace(",","."),o=Number(n);return Number.isFinite(o)?o:0}function q(e){if(e===""||e===null||e===void 0)return 0;const n=Number(String(e).replace(",","."));return Number.isFinite(n)?n:0}function Et(e,n=P){if(e==null)return null;if(typeof e=="number")return Number.isFinite(e)?e:null;const o=String(e).trim();if(!o)return null;const l=n(o);return Number.isFinite(l)?l:null}function ce(e){const n=(Array.isArray(e)?e:[]).filter(l=>Number.isFinite(l)).slice().sort((l,s)=>l-s);if(!n.length)return null;const o=Math.floor(n.length/2);return n.length%2===1?n[o]:(n[o-1]+n[o])/2}function Zt(e,n=35,o=75){const l=Number(e);return Number.isFinite(l)?Math.min(o,Math.max(n,l)):n}function le(e){return String(e||"").trim().toLowerCase()==="basis"?"basis":"conservative"}function fe(e){const n=Math.max(0,Math.round(Number(e||0)));return n<=0?0:n===1?1:n<=3?2:n<=6?3:n<=12?4:5}function St(e,n=1){const o=Number(e);return Number.isFinite(o)?o.toLocaleString("de-DE",{minimumFractionDigits:n,maximumFractionDigits:n}):"0"}function Bt({revenue:e,payoutPct:n,payoutAmount:o,mode:l,isFuture:s,basisQuotePct:f,marginPct:d,horizonMonths:p,fallbackUsed:r,componentLabel:b}){const i=l==="basis"?"Basis":"Konservativ",E=[`Plan-Umsatz${b?` (${b})`:""}: ${Vt(e)}`,`Quote: ${St(n)}% (${i})`,`Auszahlung: ${Vt(o)}`];if(s){if(E.push(`BasisQuote: ${St(f)}%`),d>0&&E.push(`Sicherheitsmarge: -${St(d)}pp (Horizont +${p})`),r&&r!=="none"){const B=r==="last_plan_quote"?"letzte Plan-Quote":"50%-Fallback";E.push(`Basisquelle: ${B}`)}}else E.push("Historischer/aktueller Monat: Monatsquote aus Eingaben");return E.join(" · ")}function de(e){const n=e||{},o=new Map,l=n!=null&&n.monthlyActuals&&typeof n.monthlyActuals=="object"?n.monthlyActuals:{};return Object.entries(l).forEach(([f,d])=>{if(!f)return;const p=Et(d==null?void 0:d.realRevenueEUR,P),r=Et(d==null?void 0:d.realPayoutRatePct,q),b=Et(d==null?void 0:d.realClosingBalanceEUR,P),i={};Number.isFinite(p)&&(i.revenue=p),Number.isFinite(r)&&(i.payoutRatePct=r),Number.isFinite(p)&&Number.isFinite(r)&&(i.payout=p*(r/100)),Number.isFinite(b)&&(i.closing=b),Object.keys(i).length&&o.set(f,i)}),(Array.isArray(n.actuals)?n.actuals:[]).forEach(f=>{if(!f||!f.month)return;const d=f.month,p=Et(f.revenueEur,P),r=Et(f.payoutEur,P),b=Et(f.closingBalanceEur,P),i=o.get(d)||{};!Number.isFinite(i.revenue)&&Number.isFinite(p)&&(i.revenue=p),!Number.isFinite(i.payout)&&Number.isFinite(r)&&(i.payout=r),!Number.isFinite(i.closing)&&Number.isFinite(b)&&(i.closing=b),!Number.isFinite(i.payoutRatePct)&&Number.isFinite(p)&&p!==0&&Number.isFinite(r)&&(i.payoutRatePct=r/p*100),Object.keys(i).length&&o.set(d,i)}),o}function Vt(e){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format(ie(Number(e)))}function pe(e,n){const[o,l]=e.split("-").map(Number),s=new Date(o,l-1+n,1);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`}function Jt(e,n){const o=[];for(let l=0;l<n;l++)o.push(pe(e,l));return o}function tt(e){const n=new Date(e);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function K(e,n){const o=new Date(e.getTime());return o.setDate(o.getDate()+(n||0)),o}function lt(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?null:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function bt(e){if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n}function Rt(e){const[n,o]=e.split("-").map(Number);return new Date(n,o,0)}function he(e,n){var d;const o=e==null?void 0:e.cny;if(o!=null&&o.start&&(o!=null&&o.end)){const p=bt(o.start),r=bt(o.end);if(p&&r&&r>=p)return{start:p,end:r}}const l=(d=e==null?void 0:e.cnyBlackoutByYear)==null?void 0:d[String(n)];if(!l)return null;const s=bt(l.start),f=bt(l.end);return!s||!f||f<s?null:{start:s,end:f}}function me(e,n,o){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return{prodDone:e,adjustmentDays:0};const l=Math.max(0,Number(n||0)),s=K(e,l);if(!o||l===0)return{prodDone:s,adjustmentDays:0};let f=0;const d=e.getUTCFullYear(),p=s.getUTCFullYear();for(let b=d;b<=p;b+=1){const i=he(o,b);if(!i)continue;const E=i.start>e?i.start:e,B=i.end<s?i.end:s;if(B<E)continue;const x=Math.round((B.getTime()-E.getTime())/(24*60*60*1e3))+1;f+=Math.max(0,x)}return{prodDone:f?K(s,f):s,adjustmentDays:f}}function Ht(e,n){const o=bt(e.orderDate)||new Date,l=Number(e.productionLeadTimeDays??e.prodDays??0),s=Number(e.logisticsLeadTimeDays??e.transitDays??0),d=me(o,l,n).prodDone??K(o,l),p=d,r=K(p,s),b=bt(e.etdManual),i=bt(e.etaManual);return{ORDER_DATE:o,PROD_DONE:d,PRODUCTION_END:d,ETD:b||p,ETA:i||r}}function be(e,n){const o=new Date(e.getTime());return o.setMonth(o.getMonth()+n),o}function ge(e){return new Date(e.getFullYear(),e.getMonth()+1,0)}function nt(e){if(!/^\d{4}-\d{2}$/.test(e||""))return null;const[n,o]=e.split("-").map(Number);return n*12+(o-1)}function ye(e,n){const o=Array.isArray(e==null?void 0:e.items)?e.items:[];let l=0,s=0;if(o.length)o.forEach(b=>{const i=P((b==null?void 0:b.units)??0),E=P((b==null?void 0:b.unitCostUsd)??0),B=P((b==null?void 0:b.unitExtraUsd)??0),x=P((b==null?void 0:b.extraFlatUsd)??0),R=(E+B)*i+x,N=Math.max(0,Math.round(R*100)/100);Number.isFinite(N)&&(l+=N),Number.isFinite(i)&&(s+=i)});else{const b=P((e==null?void 0:e.units)??0),i=P((e==null?void 0:e.unitCostUsd)??0),E=P((e==null?void 0:e.unitExtraUsd)??0),B=P((e==null?void 0:e.extraFlatUsd)??0),x=(i+E)*b+B;l=Math.max(0,Math.round(x*100)/100),Number.isFinite(b)&&(s=b)}const f=P((e==null?void 0:e.fxOverride)??0),d=Number.isFinite(f)&&f>0?f:P((n==null?void 0:n.fxRate)??0)||0,p=d>0?Math.round(l/d*100)/100:0,r=P((e==null?void 0:e.goodsEur)??0);return{usd:l,eur:p>0?p:r,units:s}}function Wt(e,n){if(((e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const l=P((e==null?void 0:e.freightPerUnitEur)??0),s=Number((n==null?void 0:n.units)??0)||0,f=l*s;return Math.round(f*100)/100}return P((e==null?void 0:e.freightEur)??0)}function De(e){if(Array.isArray(e==null?void 0:e.items)&&e.items.length)return e.items.map(s=>{const f=String((s==null?void 0:s.sku)||"").trim();if(!f)return null;const d=(s==null?void 0:s.units)??(s==null?void 0:s.qty)??(s==null?void 0:s.quantity)??0,p=Math.max(0,P(d));return{...s,sku:f,units:p}}).filter(Boolean);const n=String((e==null?void 0:e.sku)||"").trim();if(!n)return[];const o=(e==null?void 0:e.units)??0,l=Math.max(0,P(o));return[{sku:n,units:l,unitCostUsd:e==null?void 0:e.unitCostUsd,unitExtraUsd:e==null?void 0:e.unitExtraUsd,extraFlatUsd:e==null?void 0:e.extraFlatUsd,prodDays:e==null?void 0:e.prodDays,transitDays:e==null?void 0:e.transitDays,freightEur:e==null?void 0:e.freightEur}]}function Gt(e){const n=(e==null?void 0:e.order)||{},o=(e==null?void 0:e.profileBySku)instanceof Map?e.profileBySku:new Map,l=(e==null?void 0:e.poSkuSet)instanceof Set?e.poSkuSet:new Set,s=(e==null?void 0:e.fallbackBucket)||X.CORE,f=De(n);if(!f.length)return[{bucket:s,share:1,row:{...n,payments:Array.isArray(n==null?void 0:n.payments)?n.payments.filter(Boolean).map(r=>({...r})):n==null?void 0:n.payments}}];const d=new Map;let p=0;return f.forEach(r=>{const b=String((r==null?void 0:r.sku)||"").trim();if(!b)return;const i=Nt(b),E=o.get(i);if(!(E?E.includeInForecast:Kt(void 0,!0)))return;const x=E?E.effectivePortfolioBucket:It({sku:b,poSkuSet:l,fallbackBucket:s}),R=P((r==null?void 0:r.units)??0),N=Number.isFinite(R)&&R>0?R:1;p+=N,d.has(x)||d.set(x,{bucket:x,items:[],weight:0});const O=d.get(x);O.items.push(r),O.weight+=N}),d.size?Array.from(d.values()).map((r,b,i)=>{const E=p>0?r.weight/p:i.length?1/i.length:1,B=Array.isArray(n==null?void 0:n.payments)?n.payments.filter(Boolean).map(O=>{const j=Number(O==null?void 0:O.amount);return Number.isFinite(j)?{...O,amount:Math.round(j*E*100)/100}:{...O}}):void 0,x=(n==null?void 0:n.freightMode)==="per_unit"?"per_unit":"total",R=P((n==null?void 0:n.freightEur)??0),N={...n,items:r.items.map(O=>({...O})),payments:B,freightMode:x,freightEur:x==="total"?Math.round(R*E*100)/100:n==null?void 0:n.freightEur};return{bucket:r.bucket,share:E,row:N}}):[]}function Ee(e,n,o){const l=new Date(e,n+1,0).getDate(),s=Math.min(Math.max(1,o),l);return new Date(e,n,s)}function wt(e,n){const o=nt(e);if(o==null)return null;const l=Math.floor(o/12),s=o%12;if(!n||n==="LAST"||n==="Letzter Tag"||n==="EOM")return new Date(l,s+1,0);const f=Number(n);return Number.isFinite(f)?Ee(l,s,f):new Date(l,s+1,0)}function Ne(e){const n=String(e||"").trim().toUpperCase();return n?n==="PLANNED"?"ACTIVE":n==="CANCELLED"?"ARCHIVED":n:"DRAFT"}function Me(e){const n=Ne(e);return n==="DRAFT"||n==="ACTIVE"}function ke(e,n,o,l){if(!n||!n.proration||n.proration.enabled!==!0)return{amount:e,applied:!1};if(n.proration.method!=="daily")return{amount:e,applied:!1};const s=nt(o);if(s==null)return{amount:e,applied:!1};const f=Math.floor(s/12),d=s%12,p=new Date(f,d+1,0).getDate(),r=l instanceof Date&&!Number.isNaN(l.getTime())?l:wt(o,n.anchor),b=r instanceof Date?r.getDate():p;let i=1;n.startMonth&&n.startMonth===o&&(i*=Math.max(0,p-b+1)/p),n.endMonth&&n.endMonth===o&&(i*=Math.max(0,b)/p);const E=Math.round(e*i*100)/100;return!Number.isFinite(E)||E===e?{amount:e,applied:!1}:{amount:E,applied:!0}}function te({statusRecord:e,autoEligible:n,autoManualCheck:o,entryTime:l,todayTime:s,defaultPaid:f}){const d=typeof(e==null?void 0:e.manual)=="boolean"?e.manual:void 0;let p=!1,r=!1;typeof d=="boolean"?p=d:n&&!o&&l!=null&&l<=s?(p=!0,r=!0):p=!!f;const b=n&&o&&!r;let i=null;return n&&(r?i="Automatisch bezahlt am Fälligkeitstag":o?i="Automatische Zahlung – manuelle Prüfung aktiv":i="Automatische Zahlung"),{paid:p,autoApplied:r,manualOverride:typeof d=="boolean",autoSuppressed:b,autoTooltip:i}}function Pe(e,n={}){const o=e||{},l=n.startMonth||o.settings&&o.settings.startMonth||"2025-01",s=Number(n.horizon||o.settings&&o.settings.horizonMonths||12),f=Array.isArray(n.months)&&n.months.length?n.months:Jt(l,s),d=Array.isArray(o.fixcosts)?o.fixcosts:[],p=o.fixcostOverrides&&typeof o.fixcostOverrides=="object"?o.fixcostOverrides:{},r=n.status&&typeof n.status=="object"?n.status:o.status||{},b=n.statusEvents&&typeof n.statusEvents=="object"?n.statusEvents:r.events||{},i=n.autoManualCheck!=null?n.autoManualCheck===!0:r.autoManualCheck===!0,E=n.today?new Date(n.today):new Date;E.setHours(0,0,0,0);const B=E.getTime(),x=[],R=new Set(f);return d.forEach((N,O)=>{if(!N)return;const j=N.id||`fix-${O}`,Y=N.startMonth||l,J=nt(Y);if(J==null)return;const Z=N.endMonth||null,V=Z?nt(Z):null,h=(N.frequency||"monthly").toLowerCase();let M=1;h==="quarterly"?M=3:h==="semiannual"||h==="halbjährlich"?M=6:h==="annual"||h==="jährlich"||h==="yearly"?M=12:(h==="custom"||h==="benutzerdefiniert")&&(M=Number(N.intervalMonths||N.everyMonths||1)||1),M<1&&(M=1);const C=N.anchor,A=!C||C==="Letzter Tag"?"LAST":String(C),$=p[j]&&typeof p[j]=="object"?p[j]:{},S=N.name||"Fixkosten",v=N.category||"Sonstiges",L=Math.abs(P(N.amount)),G=N.notes||"",H=N.autoPaid===!0;f.forEach(W=>{if(!R.has(W))return;const ft=nt(W);if(ft==null||ft<J||V!=null&&ft>V||(ft-J)%M!==0)return;const gt=wt(W,A),z=$[W]&&typeof $[W]=="object"?$[W]:{};let Q=gt;if(z.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(z.dueDate)){const it=new Date(z.dueDate);Number.isNaN(it.getTime())||(Q=it)}let at=L,dt=!1;z.amount!=null&&String(z.amount).trim()!==""&&(at=Math.abs(P(z.amount)),dt=!0);let ut=!1;if(!dt){const it=ke(L,N,W,Q);at=it.amount,ut=it.applied}const pt=`fix-${j}-${W}`,Mt=Q instanceof Date&&!Number.isNaN(Q.getTime())?Q.getTime():null,kt=b[pt],st=te({statusRecord:kt,autoEligible:H,autoManualCheck:i,entryTime:Mt,todayTime:B,defaultPaid:!1}),Pt=Q instanceof Date&&!Number.isNaN(Q.getTime())?lt(Q):null,yt=z.note||"",rt=[S];dt&&rt.push("Override aktiv"),ut&&rt.push("Proratiert");const Ft=rt.length>1?rt.join(" · "):null;x.push({id:pt,month:W,amount:at,baseAmount:L,label:S,category:v,dueDate:Q,dueDateIso:Pt,fixedCostId:j,autoPaid:H,notes:G,override:{amount:z.amount||"",dueDate:z.dueDate||"",note:yt},overrideActive:dt||!!z.dueDate||!!yt,prorationApplied:ut,paid:st.paid,autoApplied:st.autoApplied,manualOverride:st.manualOverride,autoTooltip:st.autoTooltip,autoSuppressed:st.autoSuppressed,anchor:A,frequency:h,tooltip:Ft})})}),x.sort((N,O)=>{if(N.month===O.month){const j=N.dueDate instanceof Date?N.dueDate.getTime():0,Y=O.dueDate instanceof Date?O.dueDate.getTime():0;return j-Y}return nt(N.month)-nt(O.month)}),x}function Fe(e){const n=e||{};return{dutyRatePct:q(n.dutyRatePct??0),dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:q(n.eustRatePct??0),vatRefundLagMonths:Number(n.vatRefundLagMonths??0)||0,vatRefundEnabled:n.vatRefundEnabled!==!1,freightLagDays:Number(n.freightLagDays??0)||0,fxFeePct:q(n.fxFeePct??0)}}function Ae(e,n,o){const l=["freight","duty","eust","vat_refund","fx_fee"],s=Array.isArray(e.autoEvents)?e.autoEvents.filter(Boolean).map(r=>({...r})):[],f=new Map;for(const r of s)!r||!r.type||(r.id||(r.id=`auto-${r.type}`),f.set(r.type,r));const d=(o||[])[0]||null;function p(r,b){if(!f.has(r)){const E={id:`auto-${r}`,type:r,...b};return s.push(E),f.set(r,E),E}const i=f.get(r);i.id||(i.id=`auto-${r}`);for(const[E,B]of Object.entries(b))i[E]===void 0&&(i[E]=B);return i}if(p("freight",{label:"Fracht",anchor:"ETA",lagDays:n.freightLagDays,enabled:!0}),p("duty",{label:"Zoll",percent:n.dutyRatePct,anchor:"ETA",lagDays:n.freightLagDays}),p("eust",{label:"EUSt",percent:n.eustRatePct,anchor:"ETA",lagDays:n.freightLagDays}),p("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:n.vatRefundLagMonths,enabled:n.vatRefundEnabled}),p("fx_fee",{label:"FX-Gebühr",percent:n.fxFeePct,anchor:d&&d.anchor||"ORDER_DATE",lagDays:d&&Number(d.lagDays||0)||0}),s.sort((r,b)=>l.indexOf(r.type)-l.indexOf(b.type)),e.ddp)for(const r of s)(r.type==="freight"||r.type==="duty"||r.type==="eust"||r.type==="vat_refund")&&(r.enabled=!1);return s}function Xt(e,n,o,l){var V;if(!e)return[];const s=o||"PO",f=e[l],d=f?`${s} ${f}`:s;if(Array.isArray(e.payments)&&e.payments.length){const h=Ht(e,n);return e.payments.filter(Boolean).map((M,C)=>{const A=M.triggerEvent||"ORDER_DATE",$=A==="PROD_DONE"?"PROD_DONE":A,S=h[$]||h.ORDER_DATE,v=M.dueDate?new Date(M.dueDate):K(S,Number(M.offsetDays||0)),L=Number(M.amount||0),G=L>=0?"out":"in",H=Math.abs(L);return{label:`${d}${M.label?` – ${M.label}`:""}`,amount:H,due:v,month:tt(v),direction:G,type:"manual",anchor:$,lagDays:Number(M.offsetDays||0)||0,percent:Number(M.percent||0),sourceType:s,sourceNumber:f,sourceId:e.id,id:M.id||`${e.id||s}-pay-${C}`,tooltip:`Fälligkeit: ${$} + ${Number(M.offsetDays||0)} Tage`}})}const p=ye(e,n),r=p.eur,b=Wt(e,p),i=Ht(e,n),E=Array.isArray(e.milestones)?e.milestones:[],B=Ae(e,n,E),x=[];for(const[h,M]of E.entries()){const C=q(M.percent),A=i[M.anchor||"ORDER_DATE"]||i.ORDER_DATE,$=K(A,Number(M.lagDays||0)),S=M.id||`${e.id||s}-${h}-${M.id||"manual"}`;x.push({label:`${d}${M.label?` – ${M.label}`:""}`,amount:r*(C/100),due:$,month:tt($),direction:"out",type:"manual",anchor:M.anchor||"ORDER_DATE",lagDays:Number(M.lagDays||0)||0,percent:C,sourceType:s,sourceNumber:f,sourceId:e.id,id:S,tooltip:`Fälligkeit: ${M.anchor||"ORDER_DATE"} + ${Number(M.lagDays||0)} Tage`})}const R=e.dutyIncludeFreight!==!1,N=q(e.dutyRatePct??n.dutyRatePct??0),O=q(e.eustRatePct??n.eustRatePct??0),j=q(e.fxFeePct??n.fxFeePct??0),Y=Number(e.vatRefundLagMonths??n.vatRefundLagMonths??0),J=e.vatRefundEnabled!==!1,Z={};for(const h of B){if(!h||h.enabled===!1)continue;const M=h.anchor||"ETA",C=i[M]||i.ETA;if(!(!(C instanceof Date)||Number.isNaN(C.getTime()))){if(h.type==="freight"){const A=Wt(e,p);if(!A)continue;const $=h.id||`${e.id||s}-auto-freight`,S=K(C,Number(h.lagDays||0));x.push({label:`${d} – ${h.label||"Fracht"}`,amount:A,due:S,month:tt(S),direction:"out",type:"freight",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,sourceType:s,sourceNumber:f,sourceId:e.id,id:$,tooltip:"Frachtkosten laut Eingabe"});continue}if(h.type==="duty"){const A=q(h.percent??N),$=K(C,Number(h.lagDays||0)),v=(r+(R?b:0))*(A/100),L=h.id||`${e.id||s}-auto-duty`;Z.duty={amount:v,due:$},x.push({label:`${d} – ${h.label||"Zoll"}`,amount:v,due:$,month:tt($),direction:"out",type:"duty",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,percent:A,sourceType:s,sourceNumber:f,sourceId:e.id,id:L,tooltip:`Zoll = ${A}% × (Warenwert${R?" + Fracht":""})`});continue}if(h.type==="eust"){const A=q(h.percent??O),$=Math.abs(((V=Z.duty)==null?void 0:V.amount)||0),S=r+b+$,v=K(C,Number(h.lagDays||0)),L=S*(A/100),G=h.id||`${e.id||s}-auto-eust`;Z.eust={amount:L,due:v},x.push({label:`${d} – ${h.label||"EUSt"}`,amount:L,due:v,month:tt(v),direction:"out",type:"eust",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,percent:A,sourceType:s,sourceNumber:f,sourceId:e.id,id:G,tooltip:`EUSt = ${A}% × (Warenwert + Fracht + Zoll)`});continue}if(h.type==="vat_refund"){const A=Z.eust;if(!J||!A||A.amount===0)continue;const $=q(h.percent??100),S=Number((h.lagMonths??Y)||0),v=K(A.due||C,Number(h.lagDays||0)),L=ge(be(v,S)),G=Math.abs(A.amount)*($/100),H=h.id||`${e.id||s}-auto-vat`;x.push({label:`${d} – ${h.label||"EUSt-Erstattung"}`,amount:G,due:L,month:tt(L),direction:"in",type:"vat_refund",anchor:h.anchor||"ETA",lagMonths:S,percent:$,sourceType:s,sourceNumber:f,sourceId:e.id,id:H,tooltip:`Erstattung am Monatsende nach ${S} Monaten`});continue}if(h.type==="fx_fee"){const A=q(h.percent??j);if(!A)continue;const $=K(C,Number(h.lagDays||0)),S=r*(A/100),v=h.id||`${e.id||s}-auto-fx`;x.push({label:`${d} – ${h.label||"FX-Gebühr"}`,amount:S,due:$,month:tt($),direction:"out",type:"fx_fee",anchor:h.anchor||"ORDER_DATE",lagDays:Number(h.lagDays||0)||0,percent:A,sourceType:s,sourceNumber:f,sourceId:e.id,id:v,tooltip:`FX-Gebühr = ${A}% × Warenwert`})}}}return x}function Te(e){var vt,Ut,Lt,_t,jt;const n=e||{},o=n.settings&&n.settings.startMonth||"2025-01",l=Number(n.settings&&n.settings.horizonMonths||12),s=Jt(o,l),f=n.status&&typeof n.status=="object"?n.status:{},d=f.events&&typeof f.events=="object"?f.events:{},p=f.autoManualCheck===!0,r=new Date;r.setHours(0,0,0,0);const b=r.getTime(),i={};s.forEach(t=>{i[t]={entries:[]}});const{map:E,poSkuSet:B}=re(n);function x(t){const a=Nt(t);return a?E.get(a)||{includeInForecast:!0,effectivePortfolioBucket:It({sku:t,poSkuSet:B,fallbackBucket:X.CORE})}:{includeInForecast:!0,effectivePortfolioBucket:X.CORE}}function R(t,a){i[t]&&i[t].entries.push(a)}function N(t,a={}){const c=t.id||`${t.month||""}-${t.label||""}-${t.date||""}`,g=d[c],u=t.date?new Date(t.date):null,y=u&&Number.isFinite(u.getTime())?new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime():null,D=a.auto===!0,F=D&&a.autoEligible!==!1,U=typeof t.paid=="boolean"?t.paid:!!a.defaultPaid,k=te({statusRecord:g,autoEligible:F,autoManualCheck:p,entryTime:y,todayTime:b,defaultPaid:U}),I={...t.meta&&typeof t.meta=="object"?t.meta:{}},T=t.portfolioBucket?Dt(t.portfolioBucket,X.CORE):null;return T&&(I.portfolioBucket=T),{id:c,direction:t.direction||"in",amount:Math.abs(t.amount||0),label:t.label||"",month:t.month,date:t.date,kind:t.kind,group:t.group,paid:k.paid,source:t.source||null,anchor:t.anchor,lagDays:t.lagDays,lagMonths:t.lagMonths,percent:t.percent,scenarioDelta:t.scenarioDelta||0,scenarioAmount:t.scenarioAmount||t.amount||0,meta:I,portfolioBucket:T,tooltip:t.tooltip,sourceTab:t.sourceTab,sourceNumber:t.sourceNumber,sourceId:t.sourceId,statusId:c,auto:D,autoEligible:F,autoApplied:k.autoApplied,autoManualCheck:p,manualOverride:k.manualOverride,autoSuppressed:k.autoSuppressed,autoTooltip:k.autoTooltip}}Pe(n,{months:s,statusEvents:d,autoManualCheck:p,today:r}).map(t=>({id:t.id,direction:"out",amount:t.amount,label:t.label,month:t.month,date:t.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:t.fixedCostId,category:t.category,override:t.overrideActive,overrideAmount:t.override.amount,overrideDueDate:t.override.dueDate,overrideNote:t.override.note,notes:t.notes,baseAmount:t.baseAmount,prorationApplied:t.prorationApplied},tooltip:t.tooltip,auto:t.autoPaid,autoEligible:t.autoPaid})).forEach(t=>{R(t.month,N(t,{auto:t.auto,autoEligible:t.autoEligible}))});const j=!!((Ut=(vt=n==null?void 0:n.forecast)==null?void 0:vt.settings)!=null&&Ut.useForecast),Y={},J={},Z={},V=mt.reduce((t,a)=>(t[a]={},t),{}),h=mt.reduce((t,a)=>(t[a]={},t),{});if(s.forEach(t=>{Y[t]=0,J[t]=0,Z[t]=0,mt.forEach(a=>{V[a][t]=0,h[a][t]=0})}),j){(Lt=n==null?void 0:n.forecast)!=null&&Lt.forecastImport&&typeof n.forecast.forecastImport=="object"?Object.entries(n.forecast.forecastImport).forEach(([a,c])=>{const g=x(a);if(!g.includeInForecast)return;const u=Dt(g.effectivePortfolioBucket,X.CORE);Object.entries(c||{}).forEach(([y,D])=>{if(!y||!i[y])return;const F=P((D==null?void 0:D.revenueEur)??(D==null?void 0:D.revenue)??null);Number.isFinite(F)&&(Y[y]=(Y[y]||0)+F,V[u][y]=(V[u][y]||0)+F)})}):Array.isArray((_t=n==null?void 0:n.forecast)==null?void 0:_t.items)&&n.forecast.items.forEach(a=>{if(!a||!a.month||!a.sku)return;const c=x(a.sku);if(!c.includeInForecast)return;const g=Dt(c.effectivePortfolioBucket,X.CORE),u=a.month;if(!i[u])return;const y=Number(a.qty??a.quantity??0)||0,D=P(a.priceEur??a.price??0),F=y*D;Y[u]=(Y[u]||0)+F,V[g][u]=(V[g][u]||0)+F});const t=se({state:n,months:s});Object.entries((t==null?void 0:t.byBucket)||{}).forEach(([a,c])=>{const g=Dt(a,X.PLAN);Object.entries(c||{}).forEach(([u,y])=>{if(!i[u])return;const D=P(y);Number.isFinite(D)&&(J[u]=(J[u]||0)+D,h[g][u]=(h[g][u]||0)+D)})}),Object.keys(i).forEach(a=>{Z[a]=(Y[a]||0)+(J[a]||0)})}const M={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(M[t.month]=t.payoutPct)});const C={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(C[t.month]=P(t.revenueEur))});const A=tt(r),$=nt(A),S=le((jt=n==null?void 0:n.settings)==null?void 0:jt.cashInMode),v=35,L=75,G=de(n),H=[];G.forEach((t,a)=>{if(!a||a>=A)return;let c=Number(t==null?void 0:t.payoutRatePct);if(!Number.isFinite(c)){const g=Number(t==null?void 0:t.revenue),u=Number(t==null?void 0:t.payout);Number.isFinite(g)&&g!==0&&Number.isFinite(u)&&(c=u/g*100)}Number.isFinite(c)&&H.push({month:a,quotePct:Number(c)})}),H.sort((t,a)=>String(t.month||"").localeCompare(String(a.month||"")));const W=Object.entries(M).filter(([,t])=>t!=null&&String(t).trim()!=="").sort((t,a)=>String(t[0]||"").localeCompare(String(a[0]||""))).pop(),ft=W?q(W[1]):null;let ot="none",gt=ce(H.map(t=>t.quotePct));Number.isFinite(gt)||(Number.isFinite(ft)?(gt=Number(ft),ot="last_plan_quote"):(gt=50,ot="hardcoded_50"));const z=Zt(gt,v,L),Q={},at={};Object.keys(i).forEach(t=>{const a=j?Z[t]||0:C[t];if(typeof a>"u")return;const c=q(M[t]||0),g=nt(t),u=g!=null&&$!=null?g-$:0,y=u>0,D=y&&S==="conservative"?fe(u):0,F=y?Zt(z-D,v,L):c;Q[t]=F,at[t]={mode:S,isFutureMonth:y,horizonFromCurrentMonth:u,marginPct:D,basisQuotePct:z,payoutPct:F,manualPayoutPct:c,fallbackUsed:ot,quoteMinPct:v,quoteMaxPct:L};const U=Rt(t);if(!j){const k=a*(F/100),I=Bt({revenue:a,payoutPct:F,payoutAmount:k,mode:S,isFuture:y,basisQuotePct:z,marginPct:D,horizonMonths:u,fallbackUsed:ot});R(t,N({id:`sales-${t}`,direction:k>=0?"in":"out",amount:Math.abs(k),label:"Amazon Payout",month:t,date:lt(U),kind:"sales-payout",group:k>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#eingaben",tooltip:I,portfolioBucket:null,meta:{cashIn:{...at[t],revenue:a,payoutAmount:k}}},{auto:!1}));return}mt.forEach(k=>{var et;const I=((et=V[k])==null?void 0:et[t])||0,T=I*(F/100);if(Math.abs(T)>1e-6){const ht=Bt({revenue:I,payoutPct:F,payoutAmount:T,mode:S,isFuture:y,basisQuotePct:z,marginPct:D,horizonMonths:u,fallbackUsed:ot,componentLabel:`Prognose - Live/CSV · ${k}`});R(t,N({id:`sales-live-${k}-${t}`,direction:T>=0?"in":"out",amount:Math.abs(T),label:`Amazon Payout (Prognose - Live/CSV · ${k})`,month:t,date:lt(U),kind:"sales-payout",group:T>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#forecast",tooltip:ht,portfolioBucket:k,meta:{cashIn:{...at[t],revenue:I,payoutAmount:T,component:"live",portfolioBucket:k}}},{auto:!1}))}}),mt.forEach(k=>{var et;const I=((et=h[k])==null?void 0:et[t])||0,T=I*(F/100);if(Math.abs(T)>1e-6){const ht=Bt({revenue:I,payoutPct:F,payoutAmount:T,mode:S,isFuture:y,basisQuotePct:z,marginPct:D,horizonMonths:u,fallbackUsed:ot,componentLabel:`Prognose - Plan · ${k}`});R(t,N({id:`sales-plan-${k}-${t}`,direction:T>=0?"in":"out",amount:Math.abs(T),label:`Amazon Payout (Prognose - Plan · ${k})`,month:t,date:lt(U),kind:"sales-payout",group:T>=0?"Sales × Payout":"Extras (Out)",source:"sales-plan",sourceTab:"#forecast",tooltip:ht,portfolioBucket:k,meta:{cashIn:{...at[t],revenue:I,payoutAmount:T,component:"plan",portfolioBucket:k}}},{auto:!1}))}})}),(Array.isArray(n.extras)?n.extras:[]).forEach(t=>{const a=t.month||(t.date?tt(t.date):null);if(!a||!i[a])return;const c=P(t.amountEur),g=c>=0?"in":"out",u=a,y=t.date?new Date(t.date):Rt(u);R(u,N({id:`extra-${t.id||t.label||u}-${t.date||""}`,direction:g,amount:Math.abs(c),label:t.label||"Extra",month:u,date:lt(y),kind:"extra",group:g==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:t.autoPaid===!0,autoEligible:t.autoPaid===!0}))}),(Array.isArray(n.dividends)?n.dividends:[]).forEach(t=>{const a=t.month||(t.date?tt(t.date):null);if(!a||!i[a])return;const c=P(t.amountEur),g=t.date?new Date(t.date):Rt(a);R(a,N({id:`div-${t.id||t.label||a}`,direction:c>=0?"out":"in",amount:Math.abs(c),label:t.label||"Dividende",month:a,date:lt(g),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))}),(Array.isArray(n.products)?n.products:[]).forEach((t,a)=>{const c=t&&typeof t=="object"?t:{},g=String(c.sku||"").trim();if(!g)return;const u=x(g);if(!u.includeInForecast)return;const y=Dt(u.effectivePortfolioBucket,X.CORE),D=String(c.alias||g).trim()||g;Yt(c.launchCosts,`prod-${a+1}-lc`).forEach((U,k)=>{const I=String(U.date||"").slice(0,7);!I||!i[I]||R(I,N({id:`launch-product-${Nt(g)}-${U.id||k+1}`,direction:"out",amount:Math.abs(P(U.amountEur)),label:`${D} · Launch-Kosten (${U.type||"Sonstiges"})`,month:I,date:U.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#products",portfolioBucket:y,meta:{sku:g,alias:D,type:U.type||"Sonstiges",note:U.note||"",currency:U.currency||"EUR"}},{auto:!1}))})}),(Array.isArray(n.planProducts)?n.planProducts:[]).forEach((t,a)=>{const c=t&&typeof t=="object"?t:{};if(String(c.status||"active").trim().toLowerCase()!=="active"||!Kt(c.includeInForecast,!0))return;const y=String(c.plannedSku||c.mappedSku||"").trim(),D=It({product:c,sku:y,poSkuSet:B,fallbackBucket:X.PLAN}),F=String(c.alias||y||`Planprodukt ${a+1}`).trim();Yt(c.launchCosts,`plan-${a+1}-lc`).forEach((k,I)=>{const T=String(k.date||"").slice(0,7);!T||!i[T]||R(T,N({id:`launch-plan-${Nt(y||F)}-${k.id||I+1}`,direction:"out",amount:Math.abs(P(k.amountEur)),label:`${F} · Launch-Kosten (${k.type||"Sonstiges"})`,month:T,date:k.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#plan-products",portfolioBucket:D,meta:{sku:y||null,alias:F,type:k.type||"Sonstiges",note:k.note||"",currency:k.currency||"EUR",source:"plan-product"}},{auto:!1}))})});const dt=Fe(n.settings);(Array.isArray(n.pos)?n.pos:[]).forEach(t=>{const a=Gt({order:t,profileBySku:E,poSkuSet:B,fallbackBucket:X.CORE}),c=a.length>1;a.forEach(g=>{Xt(g.row,dt,"PO","poNo").forEach(u=>{const y=u.month;if(!i[y])return;const D=u.type==="manual"?"po":u.type==="vat_refund"?"po-refund":"po-import",F=D==="po"?"PO/FO-Zahlungen":"Importkosten";R(y,N({id:c?`${u.id||`po-${t.id||""}-${u.type}-${u.month}`}-${Nt(g.bucket)}`:u.id||`po-${t.id||""}-${u.type}-${u.month}`,direction:u.direction==="in"?"in":"out",amount:Math.abs(u.amount||0),label:u.label,month:y,date:lt(u.due),kind:D,group:F,source:"po",sourceTab:"#po",anchor:u.anchor,lagDays:u.lagDays,lagMonths:u.lagMonths,percent:u.percent,sourceNumber:u.sourceNumber||t.poNo||t.id,sourceId:t.id||t.poNo||null,tooltip:u.tooltip,portfolioBucket:g.bucket,meta:{skuBucketShare:g.share}},{auto:u.type!=="manual",autoEligible:u.type!=="manual"}))})})}),(Array.isArray(n.fos)?n.fos:[]).forEach(t=>{if(!Me(t==null?void 0:t.status))return;const a=Gt({order:t,profileBySku:E,poSkuSet:B,fallbackBucket:X.CORE}),c=a.length>1;a.forEach(g=>{Xt(g.row,dt,"FO","foNo").forEach(u=>{const y=u.month;if(!i[y])return;const D=u.type==="manual"?"fo":u.type==="vat_refund"?"fo-refund":"fo-import",F=D==="fo"?"PO/FO-Zahlungen":"Importkosten";R(y,N({id:c?`${u.id||`fo-${t.id||""}-${u.type}-${u.month}`}-${Nt(g.bucket)}`:u.id||`fo-${t.id||""}-${u.type}-${u.month}`,direction:u.direction==="in"?"in":"out",amount:Math.abs(u.amount||0),label:u.label,month:y,date:lt(u.due),kind:D,group:F,source:"fo",sourceTab:"#fo",anchor:u.anchor,lagDays:u.lagDays,lagMonths:u.lagMonths,percent:u.percent,sourceNumber:u.sourceNumber||t.foNo||t.foNumber||t.id,sourceId:t.id||t.foNo||t.foNumber||null,tooltip:u.tooltip,portfolioBucket:g.bucket,meta:{skuBucketShare:g.share}},{auto:!1,autoEligible:!1,defaultPaid:!1}))})})});const ut=s.map(t=>{const c=i[t].entries||[],g=c.filter(m=>m.direction==="in"),u=c.filter(m=>m.direction==="out"),y=u.filter(m=>m.group==="Fixkosten"),D=y.reduce((m,_)=>m+(_.amount||0),0),F=y.filter(m=>m.paid).reduce((m,_)=>m+(_.amount||0),0),U=Math.max(0,D-F),k=y.slice().sort((m,_)=>(_.amount||0)-(m.amount||0)).slice(0,3).map(m=>({label:m.label,amount:m.amount,paid:m.paid,category:m.meta&&m.meta.category?m.meta.category:null})),I=g.reduce((m,_)=>m+(_.amount||0),0),T=u.reduce((m,_)=>m+(_.amount||0),0),et=g.filter(m=>m.paid).reduce((m,_)=>m+(_.amount||0),0),ht=u.filter(m=>m.paid).reduce((m,_)=>m+(_.amount||0),0),oe=Math.max(0,I-et),ae=Math.max(0,T-ht),$t={},Tt={};mt.forEach(m=>{$t[m]=0,Tt[m]=0}),c.forEach(m=>{var Qt;const _=Dt((m==null?void 0:m.portfolioBucket)||((Qt=m==null?void 0:m.meta)==null?void 0:Qt.portfolioBucket),"");!_||!mt.includes(_)||(m.direction==="in"?$t[_]+=Math.abs(Number(m.amount||0)):m.direction==="out"&&(Tt[_]+=Math.abs(Number(m.amount||0))))});const zt=I-T,qt=et-ht,ue=zt-qt;return{month:t,inflow:{total:I,paid:et,open:oe},outflow:{total:T,paid:ht,open:ae},bucketBreakdown:{inflow:$t,outflow:Tt},net:{total:zt,paid:qt,open:ue},fixcost:{total:D,paid:F,open:U,top:k},itemsIn:g.map(m=>({kind:m.kind,label:m.label,amount:m.amount})),itemsOut:u.map(m=>({kind:m.kind,label:m.label,amount:m.amount})),entries:c}}),pt=P(n.settings&&n.settings.openingBalance),Mt=ut.map(t=>t.itemsIn.filter(a=>a.kind==="sales-payout").reduce((a,c)=>a+c.amount,0)),kt=Mt.length?Mt.reduce((t,a)=>t+a,0)/(Mt.filter(t=>t>0).length||1):0,st={},Pt={};Object.keys(i).forEach(t=>{const a=j?Z[t]||0:C[t],c=Number.isFinite(Q[t])?Number(Q[t]):q(M[t]||0);st[t]=a,Pt[t]=a*(c/100)});const yt={opening:pt,openingToday:pt,salesPayoutAvg:kt,avgSalesPayout:kt,firstNegativeMonth:null,actuals:{},cashIn:{mode:S,basisMethod:"median",basisQuotePct:z,istMonthsCount:H.length,hasIstData:H.length>0,fallbackUsed:ot,quoteMinPct:v,quoteMaxPct:L,marginBucketsPct:{plus1:1,plus2to3:2,plus4to6:3,plus7to12:4,plus13plus:5}}};let rt=pt;const Ft=s.map((t,a)=>{const c=ut[a],g=rt;return rt+=c.net.total,{month:t,opening:g,closing:rt,inflow:c.inflow.total,outflow:c.outflow.total,net:c.net.total,entries:c.entries}});let it=pt;const Ot=s.map((t,a)=>{var U;const c=ut[a],g=it,u=g+c.net.total,y=(U=G.get(t))==null?void 0:U.closing,D=Number.isFinite(y),F=D?Number(y):u;return it=F,{month:t,opening:g,closing:F,inflow:c.inflow.total,outflow:c.outflow.total,net:c.net.total,entries:c.entries,plannedClosing:u,actualClosing:D?Number(y):null}}),Ct=Ot.find(t=>Number(t.closing||0)<0);yt.firstNegativeMonth=Ct?Ct.month:null;const ct=[];G.forEach((t,a)=>{const c=s.indexOf(a);if(c===-1)return;const g=c>=0&&c<Ft.length?Ft[c]:null,u=g?g.closing:null,y=st[a]??null,D=Pt[a]??null;ct.push({month:a,plannedRevenue:y,actualRevenue:t.revenue,revenueDelta:(t.revenue??0)-(y??0),revenueDeltaPct:y?((t.revenue??0)-y)/y*100:null,plannedPayout:D,actualPayout:t.payout,payoutDelta:(t.payout??0)-(D??0),payoutDeltaPct:D?((t.payout??0)-D)/D*100:null,plannedClosing:u,actualClosing:t.closing,closingDelta:(t.closing??0)-(u??0)})}),ct.sort((t,a)=>(t.month||"").localeCompare(a.month||""));const w=ct[ct.length-1]||null,At=ct.map(t=>t.revenueDeltaPct).filter(t=>Number.isFinite(t)),xt=ct.map(t=>t.payoutDeltaPct).filter(t=>Number.isFinite(t)),ee=At.length?At.reduce((t,a)=>t+a,0)/At.length:null,ne=xt.length?xt.reduce((t,a)=>t+a,0)/xt.length:null;return yt.actuals={count:ct.length,lastMonth:w?w.month:null,lastClosing:w?w.actualClosing:null,closingDelta:w?w.closingDelta:null,revenueDeltaPct:w?w.revenueDeltaPct:null,payoutDeltaPct:w?w.payoutDeltaPct:null,avgRevenueDeltaPct:ee,avgPayoutDeltaPct:ne},{startMonth:o,horizon:l,months:s,series:ut,kpis:yt,breakdown:Ot,actualComparisons:ct}}export{Te as c,Pe as e,Vt as f,P as p};
