import{I as Lt,t as m,k as e,K as Ht,L as h,S as D,N as U,M as ht,T as q,a7 as me,p as Kt,V as _t}from"./index-DTYN3TOH.js";import{C as Ne,n as Ye,d as Wt,e as Gt,c as $e,a as Ee,b as Re,p as Vt,f as qt}from"./cashInRules-oX83SMz9.js";import{c as Q,b as gt,f as G,a as Oe}from"./months-BTPgK-LH.js";import{c as Xt,d as Jt,n as Yt,e as Zt}from"./tableModels-0NqjM7xl.js";import{u as wt,C as X}from"./workspace-DfgJwqS9.js";import{u as Y}from"./orderUtils-E5P-a9Gg.js";import{D as T}from"./DeNumberInput-BS07c6SS.js";import{S as Ue}from"./StatsTableShell-XQSwlsBO.js";import"./productCompletenessV2-BGriKYEd.js";import"./planProducts-CtaNMQfi.js";import"./Dropdown-BicCSbDJ.js";import"./foSuggestion-Ck1952gl.js";import"./index-DBQM2_X8.js";import"./DownOutlined-C6NvF-xp.js";const{Paragraph:mt,Text:x,Title:J}=Ht,en=3;function tn(a){return a instanceof HTMLElement?!!(a.matches("input:not([type='hidden']), textarea, [contenteditable='true']")||a.closest(".ant-select, .ant-picker, .ant-input-number")):!1}function bt(a){return/^\d{4}-\d{2}$/.test(String(a||"").trim())}function r(a){if(a==null||a==="")return null;if(typeof a=="number")return Number.isFinite(a)?a:null;const u=Kt(a);return Number.isFinite(u)?Number(u):null}function te(a,u=Q()){const f=String(a||"").trim();return/^\d{4}-\d{2}$/.test(f)?f:u}function nn(a,u){const f=String(a.calibrationCutoffDate||"").trim(),o=/^\d{4}-\d{2}-\d{2}$/.test(f)?f:null;return{id:String(a.id||Y("inc")),month:te(a.month,u),revenueEur:r(a.revenueEur),payoutPct:r(a.payoutPct),source:String(a.source||"manual")==="forecast"?"forecast":"manual",calibrationCutoffDate:o,calibrationRevenueToDateEur:r(a.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(a.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(a.calibrationSellerboardMonthEndEur)}}function $(a){return a.slice().sort((u,f)=>u.month===f.month?u.id.localeCompare(f.id):u.month.localeCompare(f.month))}function Te(a,u,f){const o=gt(u,Math.max(1,Math.round(f||1))),R=new Set(o),L=new Map;return $(a).forEach(M=>{R.has(M.month)&&L.set(M.month,{...M,id:M.id||Y("inc"),source:M.source==="forecast"?"forecast":"manual",revenueEur:r(M.revenueEur),payoutPct:r(M.payoutPct),calibrationCutoffDate:M.calibrationCutoffDate?String(M.calibrationCutoffDate):null,calibrationRevenueToDateEur:r(M.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(M.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(M.calibrationSellerboardMonthEndEur)})}),$(Array.from(L.values()))}function b(a,u=2){const f=Number(a);return Number.isFinite(f)?f.toLocaleString("de-DE",{minimumFractionDigits:u,maximumFractionDigits:u}):"—"}function ne(a){const u=Number(a);return Number.isFinite(u)?u.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function j(a){const u=Vt(a);return Number.isFinite(u)?$e(Number(u),Re,Ee):null}function Qe(a){const u=r(a);return Number.isFinite(u)?Math.max(0,Number(u)):null}function an(a,u,f){const o=Math.max(1,Math.round(Number(f||1))),R=[];for(let L=0;L<o;L+=1){const M=Oe(a,L),ae=qt(u,o,L);R.push(`${G(M)}: ${ne(ae)}`)}return R.push(`ab ${G(Oe(a,o))}: 1,00`),R.join(" · ")}function sn(a){return Number.isFinite(a)?`${a>0?"+":""}${a.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}`:""}function xt(a){return Number.isFinite(a)?`${a>0?"+":""}${b(a,2)} EUR`:"0,00 EUR"}function Je(a){const u=j(a.cashInRecommendationBaselineNormalPct)??Ne,f=j(a.cashInRecommendationBaselineQ4Pct);return JSON.stringify({openingBalance:Number(a.openingBalance||0),startMonth:String(a.startMonth||""),horizonMonths:Math.max(1,Math.round(Number(a.horizonMonths||1))),cashInCalibrationEnabled:a.cashInCalibrationEnabled!==!1,cashInCalibrationHorizonMonths:Ye(a.cashInCalibrationHorizonMonths,6),cashInRecommendationIgnoreQ4:a.cashInRecommendationIgnoreQ4===!0,cashInRecommendationBaselineNormalPct:u,cashInRecommendationBaselineQ4Pct:f,incomings:$(a.incomings).map(o=>({id:String(o.id||""),month:String(o.month||""),revenueEur:r(o.revenueEur),payoutPct:r(o.payoutPct),source:o.source==="forecast"?"forecast":"manual",calibrationCutoffDate:o.calibrationCutoffDate?String(o.calibrationCutoffDate):null,calibrationRevenueToDateEur:r(o.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(o.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(o.calibrationSellerboardMonthEndEur)})),extras:a.extras.slice().sort((o,R)=>o.id.localeCompare(R.id)).map(o=>({id:String(o.id||""),date:String(o.date||""),label:String(o.label||""),amountEur:r(o.amountEur)})),dividends:a.dividends.slice().sort((o,R)=>o.month===R.month?o.id.localeCompare(R.id):o.month.localeCompare(R.month)).map(o=>({id:String(o.id||""),month:String(o.month||""),label:String(o.label||""),amountEur:r(o.amountEur)})),monthlyActuals:a.monthlyActuals.slice().sort((o,R)=>o.month.localeCompare(R.month)).map(o=>({month:String(o.month||""),realRevenueEUR:r(o.realRevenueEUR),realPayoutRatePct:r(o.realPayoutRatePct),realClosingBalanceEUR:r(o.realClosingBalanceEUR)}))})}function yn(){var ot,lt;const{state:a,loading:u,saving:f,error:o,lastSavedAt:R,saveWith:L}=wt(),M=Lt(),[ae,Ze]=m.useState(0),[B,we]=m.useState(Q()),[O,Le]=m.useState(18),[v,jt]=m.useState(!0),[H,ft]=m.useState(6),[K,pt]=m.useState(!1),[ie,vt]=m.useState(Ne),[se,yt]=m.useState(null),[A,V]=m.useState([]),[Pe,re]=m.useState([]),[Ce,oe]=m.useState([]),[le,Z]=m.useState([]),[He,Se]=m.useState(!1),[et,Ke]=m.useState(""),ce=m.useRef(null),Ie=m.useRef(""),_e=m.useRef(!0),_=m.useMemo(()=>gt(B,Math.max(1,Math.round(O||1))),[O,B]),Mt=a.settings&&typeof a.settings=="object"?a.settings:{},We=a.forecast&&typeof a.forecast=="object"?a.forecast:{},Nt=(We.settings&&typeof We.settings=="object"?We.settings:{}).useForecast===!0,Et=String(Mt.cashInMode||"").trim().toLowerCase()==="basis"?"basis":"conservative",ue=m.useMemo(()=>{const t=a,n=Xt(t),i=Jt(t,n),s=a.forecast||{},c=s.forecastImport||{},d=Yt(s.forecastManual||{});return Zt({allMonths:_,products:i,manualDraft:d,forecastImport:c})},[_,a]);m.useEffect(()=>{const t=a.settings||{},n=Number(r(t.openingBalance)||0),i=te(t.startMonth,Q()),s=Math.max(1,Math.round(Number(t.horizonMonths||18)||18)),c=t.cashInCalibrationEnabled!==!1,d=Ye(t.cashInCalibrationHorizonMonths,6),y=t.cashInRecommendationIgnoreQ4===!0,S=j(t.cashInRecommendationBaselineNormalPct)??Ne,l=j(t.cashInRecommendationBaselineQ4Pct),p=(Array.isArray(a.incomings)?a.incomings:[]).map(F=>nn(F,i)),I=Te(p,i,s),z=(Array.isArray(a.extras)?a.extras:[]).map(F=>{const g=F;return{id:String(g.id||Y("extra")),date:String(g.date||""),label:String(g.label||"Extra"),amountEur:r(g.amountEur)}}),W=(Array.isArray(a.dividends)?a.dividends:[]).map(F=>{const g=F;return{id:String(g.id||Y("div")),month:te(g.month,i),label:String(g.label||"Dividende"),amountEur:r(g.amountEur)}}),k=a.monthlyActuals&&typeof a.monthlyActuals=="object"?a.monthlyActuals:{},P=Object.entries(k).map(([F,g])=>({month:te(F,Q()),realRevenueEUR:r(g.realRevenueEUR),realPayoutRatePct:r(g.realPayoutRatePct),realClosingBalanceEUR:r(g.realClosingBalanceEUR)})).sort((F,g)=>F.month.localeCompare(g.month));_e.current=!0,Ze(n),we(i),Le(s),jt(c),ft(d),pt(y),vt(S),yt(l),V(I),re(z),oe(W),Z(P),Ie.current=Je({openingBalance:n,startMonth:i,horizonMonths:s,cashInCalibrationEnabled:c,cashInCalibrationHorizonMonths:d,cashInRecommendationIgnoreQ4:y,cashInRecommendationBaselineNormalPct:S,cashInRecommendationBaselineQ4Pct:l,incomings:I,extras:z,dividends:W,monthlyActuals:P}),Se(!1),Ke("")},[a.dividends,a.extras,a.incomings,a.monthlyActuals,a.settings]),m.useEffect(()=>()=>{ce.current!=null&&window.clearTimeout(ce.current)},[]);const tt=m.useMemo(()=>{const t={};return _.forEach(n=>{t[n]=Number(ue.get(n)||0)}),t},[ue,_]),N=m.useMemo(()=>{const t={};return le.forEach(n=>{if(!bt(n.month))return;const i=r(n.realRevenueEUR),s=r(n.realPayoutRatePct),c={};Number.isFinite(i)&&(c.realRevenueEUR=Number(i)),Number.isFinite(s)&&(c.realPayoutRatePct=Number(s)),Object.keys(c).length&&(t[n.month]=c)}),Wt({months:_,incomings:A,monthlyActuals:t,currentMonth:Q(),ignoreQ4:K,maxMonth:Q(),baselineNormalPct:ie,baselineQ4Pct:se,minSamples:4})},[ie,se,K,A,le,_]),be=m.useMemo(()=>{const t=new Map;return A.forEach(n=>{var s;const i=(s=N.byMonth)==null?void 0:s[n.month];!i||!Number.isFinite(Number(i.quotePct))||t.set(n.month,i)}),t},[A,N.byMonth]),xe=j(N.baselineNormalPct)??Ne,Fe=j(N.baselineQ4Pct)??xe,Ge=j(N.baselineQ4SuggestedPct)??xe,ke=j(N.currentMonthForecastQuotePct),Rt=Math.max(0,Math.round(Number(N.observedNormalSampleCount||0))),Pt=j(N.observedNormalMedianPct),Ct=j(N.observedNormalAveragePct),St=Math.max(0,Math.round(Number(N.observedNormalWithForecastSampleCount||0))),It=j(N.observedNormalWithForecastMedianPct),Ft=j(N.observedNormalWithForecastAveragePct),nt=Array.isArray(N.usedMonths)?N.usedMonths:[],kt=nt.length?nt.map(t=>G(t)).join(", "):"keine",Dt=[`Normal Baseline (manuell): ${b(xe,1)}%`,`Q4 Baseline (aktiv): ${b(Fe,1)}%`,`Q4 Vorschlag: ${b(Ge,1)}%`,`Observed IST normal (n=${Rt}): Median ${b(Pt,1)}%, Ø ${b(Ct,1)}%`,`Observed normal inkl. Prognose (n=${St}): Median ${b(It,1)}%, Ø ${b(Ft,1)}%`,`Genutzte IST-Monate: ${kt}`,`Q4 ignorieren: ${K?"ja":"nein"}`].join(" | "),E=Q(),De=_.includes(E),ge=Number(ue.get(E)||0),C=m.useMemo(()=>$(A).find(t=>t.month===E)||null,[E,A]),At=r(C==null?void 0:C.calibrationSellerboardMonthEndEur),at=r(C==null?void 0:C.calibrationPayoutRateToDatePct),je=m.useMemo(()=>Gt({incomings:v&&C?[C]:[],months:_,forecastRevenueByMonth:tt,horizonMonths:H}),[v,H,C,tt,_]),Ve=je.candidates.find(t=>t.month===E)||null,w=Number(Ve==null?void 0:Ve.rawFactor),Ae=Number(((lt=(ot=je.byMonth)==null?void 0:ot[E])==null?void 0:lt.factor)||1),it=ge*(Number.isFinite(Ae)?Ae:1),st=m.useMemo(()=>{const t=j(C==null?void 0:C.payoutPct);if(Number.isFinite(t))return Number(t);const n=be.get(E),i=Number(n==null?void 0:n.quotePct);return Number.isFinite(i)?$e(i,Re,Ee):null},[C==null?void 0:C.payoutPct,E,be]),zt=Number.isFinite(st)?it*(Number(st)/100):null,Bt=Number.isFinite(w)&&(w>1.25||w<.5),Ut=Number.isFinite(w)&&v?["Kalibrierung ueber Umsatzprognose Monatsende.",`Startfaktor ${E}: ${ne(w)}`,`Fade-Out über ${H} Monate: ${an(E,w,H)}`].join(" | "):v?"Kalibrierfaktor wird berechnet, sobald die Umsatzprognose Monatsende im aktuellen Monat gesetzt ist und Forecast-Umsatz > 0 ist.":"Kalibrierung ist deaktiviert.",fe=m.useMemo(()=>{let t=0,n=0,i=0,s=0,c=0;$(A).forEach(S=>{var pe,Be;const l=String(S.month||""),p=Number(ue.get(l)||0),I=v?Number(((Be=(pe=je.byMonth)==null?void 0:pe[l])==null?void 0:Be.factor)||1):1,z=Number.isFinite(I)?I:1,W=r(S.revenueEur),k=S.source==="manual"&&Number.isFinite(p)&&p>0,P=k?Number(W||0):p,F=k?P:p*z;t+=Number(P||0),n+=Number(F||0),!k&&Math.abs(z-1)>1e-6&&(c+=1);const g=j(S.payoutPct),de=be.get(l),ze=Number(de==null?void 0:de.quotePct),he=Number.isFinite(g)?Number(g):Number.isFinite(ze)?$e(ze,Re,Ee):null;Number.isFinite(he)&&(i+=Number(P||0)*(Number(he)/100),s+=Number(F||0)*(Number(he)/100))});const d=v?n-t:0,y=v?s-i:0;return{revenueDelta:d,payoutDelta:y,affectedMonths:c}},[v,je.byMonth,ue,A,be]);function rt(t){V(n=>{var c,d;const i=n.findIndex(y=>y.month===E);if(i>=0){const y=[...n];return y[i]={...y[i],...t},$(y)}if(!De)return n;const s={id:Y("inc"),month:E,revenueEur:Number.isFinite(ge)?ge:0,payoutPct:j((d=(c=N.byMonth)==null?void 0:c[E])==null?void 0:d.quotePct),source:ge>0?"forecast":"manual",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null,...t};return $([...n,s])})}async function Tt(t){const n=Te(A,B,O),i={openingBalance:ae,startMonth:B,horizonMonths:O,cashInCalibrationEnabled:v,cashInCalibrationHorizonMonths:H,cashInRecommendationIgnoreQ4:K,cashInRecommendationBaselineNormalPct:ie,cashInRecommendationBaselineQ4Pct:se,incomings:n,extras:Pe,dividends:Ce,monthlyActuals:le},s=Je(i);if(s===Ie.current){Se(!1);return}await L(c=>{const d=_t(c),y=d.settings||{};d.settings={...y,openingBalance:Number(i.openingBalance||0),startMonth:i.startMonth,horizonMonths:Math.max(1,Math.round(i.horizonMonths||1)),cashInCalibrationEnabled:i.cashInCalibrationEnabled!==!1,cashInCalibrationHorizonMonths:Ye(i.cashInCalibrationHorizonMonths,6),cashInRecommendationIgnoreQ4:i.cashInRecommendationIgnoreQ4===!0,cashInRecommendationBaselineNormalPct:j(i.cashInRecommendationBaselineNormalPct)??Ne,cashInRecommendationBaselineQ4Pct:j(i.cashInRecommendationBaselineQ4Pct),lastUpdatedAt:new Date().toISOString()},d.incomings=$(i.incomings).map(l=>({id:l.id,month:l.month,revenueEur:r(l.revenueEur),payoutPct:j(l.payoutPct),source:l.source,calibrationCutoffDate:l.calibrationCutoffDate||null,calibrationRevenueToDateEur:r(l.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:Qe(l.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:Qe(l.calibrationSellerboardMonthEndEur)})),d.extras=i.extras.map(l=>({id:l.id,date:l.date||null,month:l.date?l.date.slice(0,7):null,label:l.label,amountEur:Number(l.amountEur||0)})),d.dividends=i.dividends.map(l=>({id:l.id,month:l.month,date:`${l.month}-28`,label:l.label,amountEur:Number(l.amountEur||0)}));const S={};return i.monthlyActuals.forEach(l=>{if(!bt(l.month))return;const p={},I=r(l.realRevenueEUR),z=r(l.realPayoutRatePct),W=r(l.realClosingBalanceEUR);Number.isFinite(I)&&(p.realRevenueEUR=Number(I)),Number.isFinite(z)&&(p.realPayoutRatePct=Number(z)),Number.isFinite(W)&&(p.realClosingBalanceEUR=Number(W)),Object.keys(p).length&&(S[l.month]=p)}),d.monthlyActuals=S,d},t),Ie.current=s,Se(!1),Ke(`Gespeichert: ${new Date().toLocaleTimeString("de-DE")}`)}function qe(t=380){ce.current!=null&&window.clearTimeout(ce.current),ce.current=window.setTimeout(()=>{if(ce.current=null,f){qe(220);return}Tt("v2:inputs:auto")},Math.max(80,Number(t)||380))}return m.useEffect(()=>{if(_e.current){_e.current=!1;return}const n=Je({openingBalance:ae,startMonth:B,horizonMonths:O,cashInCalibrationEnabled:v,cashInCalibrationHorizonMonths:H,cashInRecommendationIgnoreQ4:K,cashInRecommendationBaselineNormalPct:ie,cashInRecommendationBaselineQ4Pct:se,incomings:A,extras:Pe,dividends:Ce,monthlyActuals:le})!==Ie.current;Se(n),n&&(Ke("Ungespeicherte Aenderungen"),qe(380))},[ae,B,O,v,H,K,ie,se,A,Pe,Ce,le]),e.jsxs("div",{className:"v2-page",onBlurCapture:t=>{tn(t.target)&&He&&qe(120)},children:[e.jsxs(X,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(J,{level:3,children:"Eingaben"}),e.jsx(mt,{children:"Opening Balance, Monats-Horizont, Umsaetze, Extras, Dividenden und Monats-Istwerte."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[f?e.jsx(h,{color:"processing",children:"Speichern..."}):null,He?e.jsx(h,{color:"gold",children:"Ungespeicherte Aenderungen"}):e.jsx(h,{color:"green",children:"Synchron"}),R?e.jsxs(h,{color:"green",children:["Gespeichert: ",new Date(R).toLocaleTimeString("de-DE")]}):null,et?e.jsx(h,{color:He?"gold":"blue",children:et}):null]})})]}),e.jsx(X,{children:e.jsxs(D,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsxs(D,{wrap:!0,children:[e.jsx(x,{strong:!0,children:"Methodik (global)"}),e.jsx(h,{color:"blue",children:"GLOBAL"})]}),e.jsxs(D,{wrap:!0,children:[e.jsxs(h,{children:["Forecast im Cashflow: ",Nt?"Ja":"Nein"]}),e.jsxs(h,{children:["Cash-In Modus: ",Et==="basis"?"Basis":"Konservativ"]}),e.jsxs(h,{children:["Kalibrierung: ",v?`An (${H} Monate)`:"Aus"]}),e.jsxs(h,{children:["Q4 ignorieren: ",K?"An":"Aus"]})]}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"In Methodik & Regeln bearbeiten"})]})}),o?e.jsx(ht,{type:"error",showIcon:!0,message:o}):null,u?e.jsx(ht,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(X,{children:[e.jsx(J,{level:5,children:"Umsatz-Kalibrierung"}),e.jsxs("div",{style:{padding:12,border:"1px solid #d9d9d9",borderRadius:8,background:"#fafafa"},children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between",marginBottom:8},wrap:!0,children:[e.jsxs(J,{level:5,style:{margin:0},children:["Aktueller Monat: ",G(E)]}),De?null:e.jsx(h,{color:"orange",children:"Aktueller Monat liegt ausserhalb des Planungshorizonts"})]}),e.jsxs(D,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(h,{color:v?"green":"default",children:["Umsatzkalibrierung ",v?"aktiv":"aus"]}),e.jsxs(h,{children:["Wirkt über: ",H," Monate"]}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"Methodik (global) ändern"}),e.jsx(q,{title:"Faktor wird aus Sellerboard-Umsatzprognose Monatsende / Forecast-Umsatz berechnet und läuft linear bis 1,00 aus.",children:e.jsx(h,{children:"Info"})})]}),e.jsx(x,{type:"secondary",children:"Faktor läuft linear auf 1,00 aus."}),e.jsxs(D,{wrap:!0,align:"start",style:{marginTop:8},children:[e.jsxs("div",{children:[e.jsx(x,{children:"Umsatzprognose bis Monatsende (EUR)"}),e.jsx(T,{value:At??void 0,mode:"decimal",min:0,step:100,style:{width:240},onChange:t=>{const n=Qe(t);n==null&&t!=null&&String(t).trim()!==""||rt({calibrationSellerboardMonthEndEur:n})},disabled:!De})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Auszahlung bis Monatsende Prognose (EUR)"}),e.jsx(T,{value:at??void 0,mode:"decimal",min:0,step:100,style:{width:260},onChange:t=>{const n=Qe(t);n==null&&t!=null&&String(t).trim()!==""||rt({calibrationPayoutRateToDatePct:n})},disabled:!De})]}),e.jsxs("div",{children:[e.jsxs(x,{children:["Kalibrierfaktor ",G(E)]}),e.jsx("div",{style:{minWidth:180,paddingTop:6},children:e.jsx(q,{title:Ut,children:e.jsx(x,{strong:!0,children:ne(Ae)})})})]})]}),e.jsxs("div",{style:{marginTop:8},children:[e.jsxs(x,{children:["Kalibrierfaktor aktueller Monat (",G(E),"):"," ",e.jsx(x,{strong:!0,children:ne(Ae)})]}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast Umsatz (",G(E),"): ",b(ge,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Kalibrierter Umsatz: ",b(it,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Kalibrierter Payout (aus Quote): ",b(zt,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Auszahlung Monatsende Prognose (manuell): ",b(at,2)," EUR"]})}),Number.isFinite(ke)?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Prognose-Quote aktueller Monat: ",b(ke,1),"%"," ","(wird als Datenpunkt fuer Baseline-Info genutzt)"]})}):null,Bt?e.jsxs(h,{color:"warning",style:{marginTop:6},children:["Ungewoehnlicher Faktor (",ne(w),")"]}):null]})]})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(J,{level:5,style:{margin:0},children:"Umsaetze x Payout"}),e.jsxs(D,{wrap:!0,children:[e.jsxs(h,{children:["Baseline Normal: ",b(ie,1),"%"]}),e.jsxs(h,{children:["Baseline Q4: ",b(se??Fe,1),"%"]}),e.jsxs(h,{children:["Q4 ignorieren: ",K?"Ja":"Nein"]}),e.jsx(q,{title:"Q4 Vorschlag: Normal + 0,5 * (Dez - Normal).",children:e.jsxs(h,{children:["Auto-Vorschlag: ",b(Ge,1),"%"]})}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"Methodik (global) ändern"}),e.jsx(U,{onClick:()=>{V(t=>{var y,S,l;const n=$(t),i=n.length?n[n.length-1].month:Oe(B||Q(),Math.max(0,Math.round(O||1)-1)),s=Oe(i,1);if(n.some(p=>p.month===s))return n;const c=(y=n.slice().reverse().find(p=>Number.isFinite(j(p.payoutPct))))==null?void 0:y.payoutPct,d=j((l=(S=N.byMonth)==null?void 0:S[s])==null?void 0:l.quotePct);return $([...n,{id:Y("inc"),month:s,revenueEur:0,payoutPct:Number.isFinite(d)?d:j(c)??null,source:"manual",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null}])}),Le(t=>Math.max(1,Math.round(Number(t||1)))+1)},children:"Naechsten Monat anhaengen"})]})]}),e.jsxs(D,{style:{marginBottom:8},wrap:!0,children:[e.jsxs(x,{type:"secondary",children:["Die Umsatzzeilen sind strikt auf den Planungszeitraum (",B," + ",O," Monate) synchronisiert."]}),e.jsx(h,{color:v?"green":"default",children:v?"Umsatzkalibrierung aktiv":"Umsatzkalibrierung aus"}),e.jsx(q,{title:"Vergleich über den gesamten Planungshorizont: Kalibrierung aktiv vs. neutral (Faktor 1,00).",children:e.jsxs(h,{color:fe.revenueDelta<=0?"orange":"green",children:["Impact Umsatz: ",xt(fe.revenueDelta)]})}),e.jsx(q,{title:"Vergleich über den gesamten Planungshorizont: Kalibrierung aktiv vs. neutral (Faktor 1,00).",children:e.jsxs(h,{color:fe.payoutDelta<=0?"orange":"green",children:["Impact Auszahlung: ",xt(fe.payoutDelta)]})}),e.jsx(q,{title:Dt,children:e.jsxs(h,{children:["Baseline N/Q4: ",b(xe,1),"% / ",b(Fe,1),"%"]})}),Number.isFinite(ke)?e.jsxs(h,{color:"blue",children:["Prognose-Quote aktuell: ",b(ke,1),"%"]}):null,e.jsxs(h,{children:["Aktive Kalibrier-Monate: ",fe.affectedMonths]}),N.uncertain?e.jsxs(h,{color:"orange",children:["Empfehlung unsicher (",N.sampleCount," Ist-Monate)"]}):null]}),e.jsx(Ue,{children:e.jsxs("table",{className:"v2-stats-table","data-layout":"fixed",style:{minWidth:1720},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:130},children:"Monat"}),e.jsx("th",{style:{width:200},children:"Umsatz EUR"}),e.jsx("th",{style:{width:90},children:"Faktor"}),e.jsx("th",{style:{width:180},children:"Umsatz kalibriert (EUR)"}),e.jsx("th",{style:{width:180},children:"Auszahlungsquote (manuell) %"}),e.jsx("th",{style:{width:170},children:"Empfehlung %"}),e.jsx("th",{style:{width:190},children:"Payout EUR (aktiv)"}),e.jsx("th",{style:{width:190},children:"Payout kalibriert (EUR)"}),e.jsx("th",{style:{width:240},children:"Status"}),e.jsx("th",{style:{width:60}})]})}),e.jsx("tbody",{children:$(A).map(t=>{var dt;const n=be.get(t.month)||null,i=String((n==null?void 0:n.sourceTag)||"BASELINE_NORMAL"),s=Number(n==null?void 0:n.quotePct),c=Number.isFinite(s)?$e(s,Re,Ee):null,d=i==="IST"?"IST":i==="PROGNOSE"?"PROGNOSE":i==="BASELINE_Q4"?"BASELINE Q4":"BASELINE",y=i==="IST"?"green":i==="PROGNOSE"?"purple":"blue",S=i==="BASELINE_Q4"?`Q4 Baseline: ${b(Fe,1)}% (Vorschlag ${b(Ge,1)}%)`:i==="BASELINE_NORMAL"?`Normal Baseline: ${b(xe,1)}%`:i==="PROGNOSE"?"PROGNOSE = Auszahlung Monatsende / Umsatzprognose Monatsende":"IST = Monats-Istwerte",l=[`Quelle: ${d}`,n!=null&&n.explanation?String(n.explanation):null,S,`Q4 ignorieren: ${K?"ja":"nein"}`].filter(Boolean).join(" | "),p=j(t.payoutPct),I=Number.isFinite(p)?Number(p):Number.isFinite(c)?Number(c):null,z=Number.isFinite(c)&&Number.isFinite(p)?Number(p)-Number(c):null,W=Number.isFinite(z)&&Math.abs(Number(z))>=en,k=Number(ue.get(t.month)||0),P=((dt=je.byMonth)==null?void 0:dt[t.month])||null,F=Number((P==null?void 0:P.factor)||1),g=Number.isFinite(F)?F:1,de=k*g,ze=String((P==null?void 0:P.method)||"").toLowerCase(),he=String((P==null?void 0:P.sourceMonth)||"").trim(),pe=v&&Math.abs(g-1)>1e-6,Be=t.source==="forecast"&&(!Number.isFinite(k)||k<=0),ct=r(t.revenueEur),ve=t.source==="manual"&&Number.isFinite(k)&&k>0,Qt=Number.isFinite(I)&&Number.isFinite(ct)?Number(ct)*(Number(I)/100):null,ut=Number.isFinite(I)?k*(Number(I)/100):null,Xe=Number.isFinite(I)?de*(Number(I)/100):null,$t=ve?Qt:v?Xe:ut,Ot=v?pe?[he?`Quelle: ${G(he)}`:null,ze==="linear"?"Methode: lineare Hochrechnung":null,`Angewendet: ${ne(g)}`].filter(Boolean).join(" | "):"Keine aktive Kalibrierung in diesem Monat (Faktor 1,00).":"Kalibrierung ist deaktiviert. Faktor = 1,00.";return e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx(x,{strong:!0,children:G(t.month)}),e.jsx("div",{children:e.jsx(x,{type:"secondary",children:t.month})})]}),e.jsx("td",{children:e.jsxs("div",{"data-field-key":`inputs.incomings.${t.id}.revenueEur`,style:ve?{border:"1px solid #faad14",borderRadius:8,padding:6}:void 0,children:[e.jsx(T,{value:t.revenueEur??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:ye=>{V(Me=>Me.map(ee=>ee.id!==t.id?ee:{...ee,revenueEur:r(ye),source:"manual"}))}}),ve?e.jsx(x,{type:"warning",children:"manuell ueberschrieben"}):null,e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast: ",b(k,2)," EUR"]})})]})}),e.jsx("td",{children:e.jsx(q,{title:Ot,children:e.jsx(x,{strong:!0,children:ne(g)})})}),e.jsx("td",{children:b(de,2)}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.incomings.${t.id}.payoutPct`,children:e.jsx(T,{value:t.payoutPct??void 0,mode:"percent",min:Re,max:Ee,step:.1,style:{width:"100%"},onChange:ye=>{V(Me=>Me.map(ee=>ee.id===t.id?{...ee,payoutPct:j(ye)}:ee))}})})}),e.jsx("td",{children:Number.isFinite(c)?e.jsxs("div",{children:[e.jsx(q,{title:l,children:e.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[e.jsx("span",{children:b(c,2)}),e.jsx(h,{color:y,style:{marginRight:0},children:d})]})}),W?e.jsxs(h,{color:"orange",children:["Delta ",sn(Number(z))]}):null]}):e.jsx(x,{type:"secondary",children:"—"})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx(x,{strong:!0,children:b($t,2)}),ve?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast kalibriert: ",b(Xe,2)," EUR"]})}):v?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast: ",b(ut,2)," EUR"]})}):null]})}),e.jsx("td",{children:b(Xe,2)}),e.jsx("td",{children:e.jsxs("div",{style:{minWidth:170},children:[t.source==="forecast"?e.jsx(h,{color:"blue",children:"Forecast übertragen"}):null,ve?e.jsx(h,{color:"orange",children:"Manuell ueberschrieben"}):null,pe?e.jsx(h,{color:"orange",children:"Kalibriert"}):null,Be?e.jsx("div",{children:e.jsx(x,{type:"warning",children:"Kein Forecast-Umsatz vorhanden"})}):null]})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{V(ye=>ye.filter(Me=>Me.id!==t.id))},children:"X"})})]},t.id)})})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Extras"}),e.jsx(U,{onClick:()=>{re(t=>[...t,{id:Y("extra"),date:`${Q()}-15`,label:"Extra",amountEur:0}])},children:"Extra"})]}),e.jsx(Ue,{children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Datum"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:Pe.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.date`,children:e.jsx(me,{type:"date",value:t.date,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,date:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.label`,children:e.jsx(me,{value:t.label,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,label:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.amountEur`,children:e.jsx(T,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,amountEur:r(n)}:s))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{re(n=>n.filter(i=>i.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Dividenden"}),e.jsx(U,{onClick:()=>{oe(t=>[...t,{id:Y("div"),month:Q(),label:"Dividende",amountEur:0}])},children:"Dividende"})]}),e.jsx(Ue,{children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:Ce.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.month`,children:e.jsx(me,{type:"month",value:t.month,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,month:te(n.target.value,t.month)}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.label`,children:e.jsx(me,{value:t.label,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,label:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.amountEur`,children:e.jsx(T,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,amountEur:r(n)}:s))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{oe(n=>n.filter(i=>i.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Monats-Istwerte (Monatsende)"}),e.jsx(U,{onClick:()=>{Z(t=>[...t,{month:Q(),realRevenueEUR:0,realPayoutRatePct:0,realClosingBalanceEUR:0}])},children:"Ist-Monat"})]}),e.jsx(mt,{type:"secondary",style:{marginTop:8,marginBottom:12},children:"Diese Werte gelten je Monat zum Monatsende und setzen den Kontostand ab diesem Monat als neue Baseline."}),e.jsx(Ue,{children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Realer Umsatz EUR"}),e.jsx("th",{children:"Reale Auszahlungsquote %"}),e.jsx("th",{children:"Realer Kontostand Monatsende EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:le.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.month`,children:e.jsx(me,{type:"month",value:t.month,onChange:i=>{const s=te(i.target.value,t.month);Z(c=>c.map((d,y)=>y===n?{...d,month:s}:d))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realRevenueEUR`,children:e.jsx(T,{value:t.realRevenueEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realRevenueEUR:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realPayoutRatePct`,children:e.jsx(T,{value:t.realPayoutRatePct??void 0,mode:"percent",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realPayoutRatePct:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realClosingBalanceEUR`,children:e.jsx(T,{value:t.realClosingBalanceEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realClosingBalanceEUR:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{Z(i=>i.filter((s,c)=>c!==n))},children:"X"})})]},`${t.month}-${n}`))})]})})]}),e.jsxs(X,{children:[e.jsx(J,{level:5,children:"Basis-Parameter"}),e.jsxs(D,{wrap:!0,align:"start",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Opening Balance (EUR)"}),e.jsx("div",{"data-field-key":"inputs.openingBalance",children:e.jsx(T,{value:ae,onChange:t=>{Ze(Number(r(t)||0))},style:{width:190},mode:"decimal",min:0,step:100})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Startmonat"}),e.jsx("div",{"data-field-key":"inputs.startMonth",children:e.jsx(me,{type:"month",value:B,onChange:t=>{const n=te(t.target.value,B);we(n),V(i=>Te(i,n,O))},style:{width:170}})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Horizont (Monate)"}),e.jsx("div",{"data-field-key":"inputs.horizonMonths",children:e.jsx(T,{value:O,onChange:t=>{const n=Math.max(1,Number(r(t)||1));Le(n),V(i=>Te(i,B,n))},mode:"int",min:1,max:48,style:{width:160}})})]})]})]})]})}export{yn as default};
