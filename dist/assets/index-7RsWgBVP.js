import{t as y,k as e,J as Z,T as q,M as K,I as D,S as P}from"./index-Bu80Uwbp.js";import{E as J}from"./index-BstOMiNp.js";import{b as Q}from"./abcClassification-C8wZea93.js";import{T as X}from"./TanStackGrid-X7-aza4k.js";import{u as Y,C as E}from"./workspace-CCwvBxSI.js";import"./Dropdown-Dn3rrflu.js";const{Paragraph:ee,Text:s,Title:I}=Z,T={A:.8,B:.95};function S(r,c=0){return Number.isFinite(r)?Number(r).toLocaleString("de-DE",{minimumFractionDigits:c,maximumFractionDigits:c}):"—"}function B(r,c=1){return Number.isFinite(r)?`${Number(r).toLocaleString("de-DE",{minimumFractionDigits:c,maximumFractionDigits:c})} %`:"Keine Daten"}function te(r){return r==="revenue_6m"?"Umsatz 6M":r==="units_6m_fallback"?"Units 6M (Fallback)":"Keine Forecast-Daten"}function se(r){return r==="revenue_6m"?"Basis aus Umsatz der naechsten 6 Monate.":r==="units_6m_fallback"?"Fallback: Kein belastbarer VK-Preis, Einordnung ueber Units 6M (mit Durchschnittspreis gewichtet).":"Keine ausreichenden Forecast-Daten fuer die naechsten 6 Monate."}function re(r){return r==="A"?e.jsx(K,{color:"green",children:"A"}):r==="B"?e.jsx(K,{color:"gold",children:"B"}):e.jsx(K,{children:"C"})}function G(r){return String(r).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}function z(r){return r==="revenue_6m"?"Umsatz 6M":"Units 6M"}function U(r,c){return c==="revenue_6m"?Number.isFinite(r.revenueRankingMetric)?Number(r.revenueRankingMetric):null:Number.isFinite(r.units6m)?Number(r.units6m):null}function ne(r,c,N){const w=U(r,N),l=U(c,N),j=w==null?2:w<=0?1:0,b=l==null?2:l<=0?1:0;if(j!==b)return j-b;if(j===0){const u=Number(l||0)-Number(w||0);if(Math.abs(u)>1e-9)return u}return r.alias.localeCompare(c.alias,"de-DE",{sensitivity:"base"})}function ie(r,c){const N=r.slice().sort((u,m)=>ne(u,m,c)),l=N.filter(u=>Number(U(u,c)||0)>0).reduce((u,m)=>u+Number(U(m,c)||0),0),j=new Map;if(c==="units_6m"&&l>0){let u=0;N.forEach(m=>{const C=Number(U(m,c)||0);if(C<=0){j.set(m.sku.toLowerCase(),"C");return}u+=C;const k=u/l;k<=T.A?j.set(m.sku.toLowerCase(),"A"):k<=T.B?j.set(m.sku.toLowerCase(),"B"):j.set(m.sku.toLowerCase(),"C")})}let b=0;return N.map((u,m)=>{const C=U(u,c),k=Number(C||0)>0?Number(C||0):0;k>0&&(b+=k);const $=l>0?k/l:0,R=l>0?b/l:0,F=j.get(u.sku.toLowerCase());return{...u,rank:m+1,metricValue:C,basisShare:$,cumulativeShare:R,viewAbcClass:c==="revenue_6m"?u.abcClass:F||"C"}})}function de(){const{state:r,loading:c,error:N}=Y(),w=r,[l,j]=y.useState("revenue_6m"),[b,u]=y.useState("all"),[m,C]=y.useState("active"),k=y.useMemo(()=>{const t=Q(w),d=Array.isArray(r.products)?r.products:[],f=new Map;d.forEach(n=>{const a=n||{},x=String(a.sku||"").trim();x&&f.set(x.toLowerCase(),String(a.alias||x))});const h=new Map;t.bySku.forEach(n=>{const a=n||{},x=String(a.sku||"").trim();if(!x)return;const i=x.toLowerCase();if(h.has(i))return;const g=String(a.abcClass||"C").toUpperCase(),H=g==="A"||g==="B"?g:"C",L=String(a.abcBasis||"no_data"),O=L==="revenue_6m"||L==="units_6m_fallback"?L:"no_data";h.set(i,{sku:x,alias:f.get(i)||x,abcClass:H,abcBasis:O,revenue6m:Number.isFinite(Number(a.revenue6m))?Number(a.revenue6m):null,units6m:Number.isFinite(Number(a.units6m))?Number(a.units6m):null,vkPriceGross:Number.isFinite(Number(a.vkPriceGross))?Number(a.vkPriceGross):null,active:a.active!==!1,revenueRankingMetric:null})});const p=Array.from(h.values());let o=0,M=0;p.forEach(n=>{const a=Number(n.revenue6m||0),x=Number(n.units6m||0);n.abcBasis==="revenue_6m"&&n.active&&a>0&&x>0&&(o+=a,M+=x)});const _=o>0&&M>0?o/M:1;return p.map(n=>{let a=null;return n.abcBasis==="revenue_6m"&&Number(n.revenue6m||0)>0?a=Number(n.revenue6m||0):n.abcBasis==="units_6m_fallback"&&Number(n.units6m||0)>0?a=Number(n.units6m||0)*_:Number.isFinite(n.revenue6m)&&Number(n.revenue6m)===0&&(a=0),{...n,revenueRankingMetric:a}}).sort((n,a)=>n.alias.localeCompare(a.alias,"de-DE",{sensitivity:"base"}))},[r.products,w]),$=y.useMemo(()=>k.filter(t=>m==="active"?t.active:m==="inactive"?!t.active:!0),[k,m]),R=y.useMemo(()=>ie($,l),[$,l]),F=y.useMemo(()=>R.reduce((t,d)=>(t[d.viewAbcClass]+=1,t),{A:0,B:0,C:0}),[R]),A=y.useMemo(()=>b==="all"?R:R.filter(t=>t.viewAbcClass===b),[b,R]),v=y.useMemo(()=>{const t=A,d=t.reduce((i,g)=>i+Number(g.revenue6m||0),0),f=t.some(i=>Number.isFinite(i.revenue6m)),h=t.reduce((i,g)=>i+Math.max(0,Number(g.metricValue||0)),0),p={A:{count:0,revenue:0},B:{count:0,revenue:0},C:{count:0,revenue:0}};t.forEach(i=>{p[i.viewAbcClass].count+=1,p[i.viewAbcClass].revenue+=Math.max(0,Number(i.revenue6m||0))});const o=t.filter(i=>Number(i.metricValue||0)>0).slice(0,5),M=o.slice(0,1).reduce((i,g)=>i+Number(g.metricValue||0),0),_=o.slice(0,3).reduce((i,g)=>i+Number(g.metricValue||0),0),n=o.reduce((i,g)=>i+Number(g.metricValue||0),0),a=t.filter(i=>i.abcBasis==="no_data").length,x=t.filter(i=>Number.isFinite(i.revenue6m)&&Number(i.revenue6m)===0).length;return{totalSkus:t.length,totalRevenue:f?d:null,byClass:p,top1Share:h>0?M/h*100:null,top3Share:h>0?_/h*100:null,top5Share:h>0?n/h*100:null,classRevenueShare:{A:d>0?p.A.revenue/d*100:null,B:d>0?p.B.revenue/d*100:null,C:d>0?p.C.revenue/d*100:null},noDataCount:a,zeroRevenueCount:x}},[A]),V=y.useMemo(()=>{if(!A.length)return null;const t=A.map(o=>String(o.rank)),d=A.map(o=>Number((o.cumulativeShare*100).toFixed(2)));let f=null,h=null;A.forEach(o=>{Number(o.metricValue||0)<=0||(o.viewAbcClass==="A"&&(f=o.rank),o.viewAbcClass==="B"&&(h=o.rank))});const p=[{yAxis:T.A*100,name:"A-Schwelle 80 %"},{yAxis:T.B*100,name:"B-Schwelle 95 %"}];return f!=null&&p.push({xAxis:String(f),name:`Ende A (Rank ${f})`}),h!=null&&p.push({xAxis:String(h),name:`Ende B (Rank ${h})`}),{tooltip:{trigger:"axis",axisPointer:{type:"line"},formatter:o=>{const M=Array.isArray(o)?o[0]:o,_=Number((M==null?void 0:M.dataIndex)??-1),n=A[_];return n?`
            <div style="min-width:220px">
              <div><strong>${G(n.alias)}</strong></div>
              <div>${G(n.sku)}</div>
              <div style="margin-top:6px">ABC: <strong>${n.viewAbcClass}</strong></div>
              <div>Basiswert: <strong>${S(n.metricValue,l==="revenue_6m"?2:0)}</strong></div>
              <div>Umsatz 6M: <strong>${S(n.revenue6m,2)} EUR</strong></div>
              <div>Basis-Anteil: <strong>${B(n.basisShare*100,2)}</strong></div>
              <div>Kumuliert: <strong>${B(n.cumulativeShare*100,2)}</strong></div>
            </div>
          `:"Keine Daten"}},grid:{left:48,right:26,top:26,bottom:44},xAxis:{type:"category",name:"SKU-Rank",nameGap:28,data:t},yAxis:{type:"value",name:"Kumuliert %",min:0,max:100,axisLabel:{formatter:"{value} %"}},series:[{name:"Pareto-Kurve",type:"line",smooth:!0,symbol:"circle",symbolSize:5,data:d,lineStyle:{width:2,color:"#2563eb"},itemStyle:{color:"#2563eb"},areaStyle:{color:"rgba(37, 99, 235, 0.12)"},markLine:{symbol:"none",lineStyle:{type:"dashed",color:"rgba(15, 27, 45, 0.42)"},label:{formatter:"{b}"},data:p}}]}},[l,A]),W=y.useMemo(()=>[{header:"Rank",meta:{width:68,align:"right"},cell:({row:t})=>t.original.rank},{header:"Alias",accessorKey:"alias",meta:{minWidth:260,width:280},cell:({row:t})=>e.jsxs("div",{className:"v2-proj-alias",children:[e.jsx(s,{className:"v2-proj-alias-main",children:t.original.alias}),e.jsx(s,{className:"v2-proj-sku-secondary",type:"secondary",children:t.original.sku})]})},{header:`% vom Gesamt (${z(l)})`,meta:{width:190,align:"right"},cell:({row:t})=>{const d=t.original.basisShare*100;if(Number(t.original.metricValue||0)<=0)return e.jsx(s,{type:"secondary",children:"Keine Daten"});const f=Math.max(3,Math.min(100,d));return e.jsxs("div",{className:"v2-abc-share-cell",children:[e.jsx(s,{children:B(d,2)}),e.jsx("div",{className:"v2-abc-share-bar",children:e.jsx("span",{style:{width:`${f}%`}})})]})}},{header:"Kumuliert %",meta:{width:124,align:"right"},cell:({row:t})=>B(t.original.cumulativeShare*100,2)},{header:"ABC",meta:{width:88,align:"center"},cell:({row:t})=>re(t.original.viewAbcClass)},{header:"Basis",meta:{width:196},cell:({row:t})=>e.jsx(q,{title:se(t.original.abcBasis),children:e.jsxs("div",{className:"v2-abc-basis-cell",children:[e.jsx(s,{children:te(t.original.abcBasis)}),e.jsx(s,{type:"secondary",children:l==="revenue_6m"?`${S(t.original.metricValue,2)} EUR`:`${S(t.original.metricValue,0)} Units`})]})})},{header:"Units (6M)",meta:{width:120,align:"right"},cell:({row:t})=>S(t.original.units6m,0)},{header:"Ø VK (EUR)",meta:{width:120,align:"right"},cell:({row:t})=>S(t.original.vkPriceGross,2)},{header:"Umsatz (6M EUR)",meta:{width:172,align:"right"},cell:({row:t})=>t.original.revenue6m==null?e.jsx(s,{type:"secondary",children:"Keine Daten"}):Number(t.original.revenue6m)===0?e.jsxs("div",{className:"v2-abc-revenue-cell",children:[e.jsx(s,{children:"0,00"}),e.jsx(s,{type:"secondary",children:"0 Umsatz im Zeitraum"})]}):S(t.original.revenue6m,2)},{header:"Status",meta:{width:100},cell:({row:t})=>t.original.active?e.jsx(K,{color:"green",children:"Aktiv"}):e.jsx(K,{children:"Inaktiv"})}],[l]);return e.jsxs("div",{className:"v2-page",children:[e.jsxs(E,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(I,{level:3,children:"ABC Insights"}),e.jsx(ee,{children:"ABC ordnet SKUs nach Beitrag zur gewaehlten Basis. Die Pareto-Kurve zeigt die kumulierte Verteilung."})]})}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(s,{type:"secondary",children:"Klassifizierung nach"}),e.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[e.jsx("button",{type:"button",className:`v2-proj-filter-btn ${l==="revenue_6m"?"is-active":""}`,onClick:()=>j("revenue_6m"),children:"Umsatz 6M"}),e.jsx("button",{type:"button",className:`v2-proj-filter-btn ${l==="units_6m"?"is-active":""}`,onClick:()=>j("units_6m"),children:"Units 6M"})]}),e.jsx(K,{color:"blue",children:"Zeitraum: 6 Monate"})]}),e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(s,{type:"secondary",children:"ABC-Filter"}),e.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[e.jsxs("button",{type:"button",className:`v2-proj-filter-btn ${b==="all"?"is-active":""}`,onClick:()=>u("all"),children:["Alle (",R.length,")"]}),e.jsxs("button",{type:"button",className:`v2-proj-filter-btn ${b==="A"?"is-active":""}`,onClick:()=>u("A"),children:["A (",F.A,")"]}),e.jsxs("button",{type:"button",className:`v2-proj-filter-btn ${b==="B"?"is-active":""}`,onClick:()=>u("B"),children:["B (",F.B,")"]}),e.jsxs("button",{type:"button",className:`v2-proj-filter-btn ${b==="C"?"is-active":""}`,onClick:()=>u("C"),children:["C (",F.C,")"]})]}),e.jsx(s,{type:"secondary",children:"Status"}),e.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[e.jsx("button",{type:"button",className:`v2-proj-filter-btn ${m==="all"?"is-active":""}`,onClick:()=>C("all"),children:"Alle"}),e.jsx("button",{type:"button",className:`v2-proj-filter-btn ${m==="active"?"is-active":""}`,onClick:()=>C("active"),children:"Aktiv"}),e.jsx("button",{type:"button",className:`v2-proj-filter-btn ${m==="inactive"?"is-active":""}`,onClick:()=>C("inactive"),children:"Inaktiv"})]})]})]})]}),N?e.jsx(D,{type:"error",showIcon:!0,message:N}):null,c?e.jsx(D,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,!c&&!N&&k.length===0?e.jsx(D,{type:"warning",showIcon:!0,message:"Keine Daten",description:"Fuer diesen Workspace liegen aktuell keine auswertbaren ABC-Daten vor."}):null,e.jsx(E,{children:e.jsxs("div",{className:"v2-abc-summary-grid",children:[e.jsxs("div",{className:"v2-abc-summary-card",children:[e.jsx(s,{type:"secondary",children:"ABC-Verteilung"}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsxs(s,{children:["A: ",v.byClass.A.count," SKUs"]}),e.jsx(s,{strong:!0,children:B(v.classRevenueShare.A,1)})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsxs(s,{children:["B: ",v.byClass.B.count," SKUs"]}),e.jsx(s,{strong:!0,children:B(v.classRevenueShare.B,1)})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsxs(s,{children:["C: ",v.byClass.C.count," SKUs"]}),e.jsx(s,{strong:!0,children:B(v.classRevenueShare.C,1)})]})]}),e.jsxs("div",{className:"v2-abc-summary-card",children:[e.jsxs(s,{type:"secondary",children:["Konzentration (",z(l),")"]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"Top 1 SKU"}),e.jsx(s,{strong:!0,children:B(v.top1Share,1)})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"Top 3 SKUs"}),e.jsx(s,{strong:!0,children:B(v.top3Share,1)})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"Top 5 SKUs"}),e.jsx(s,{strong:!0,children:B(v.top5Share,1)})]})]}),e.jsxs("div",{className:"v2-abc-summary-card",children:[e.jsx(s,{type:"secondary",children:"Umfang"}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"SKUs gesamt"}),e.jsx(s,{strong:!0,children:S(v.totalSkus,0)})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"Umsatz gesamt (6M)"}),e.jsx(s,{strong:!0,children:v.totalRevenue==null?"Keine Daten":`${S(v.totalRevenue,2)} EUR`})]}),e.jsxs("div",{className:"v2-abc-summary-line",children:[e.jsx(s,{children:"Ohne Forecast-Daten"}),e.jsx(s,{strong:!0,children:S(v.noDataCount,0)})]})]})]})}),e.jsx(E,{children:e.jsxs(P,{direction:"vertical",size:6,style:{width:"100%"},children:[e.jsx(I,{level:4,style:{margin:0},children:"Pareto / ABC-Kurve"}),e.jsxs(s,{type:"secondary",children:["Sortierung nach ",z(l),". Schwellen: A bis 80 %, B bis 95 %, danach C."]}),V?e.jsx(J,{style:{height:340},option:V}):e.jsx(D,{type:"info",showIcon:!0,message:"Keine Daten fuer die Pareto-Kurve im aktuellen Filter."})]})}),e.jsx(E,{children:e.jsxs(P,{direction:"vertical",size:6,style:{width:"100%"},children:[e.jsxs(s,{type:"secondary",children:["Tabelle nach ",z(l)," sortiert. Bei Umsatzbasis gilt weiterhin Units-Fallback, wenn kein belastbarer VK-Preis vorliegt."]}),v.zeroRevenueCount>0?e.jsxs(s,{type:"secondary",children:[v.zeroRevenueCount," SKU(s) mit 0 Umsatz im Zeitraum werden ans Tabellenende sortiert."]}):null,A.length?e.jsx(X,{data:A,columns:W,minTableWidth:1420,tableLayout:"fixed"}):e.jsx(D,{type:"info",showIcon:!0,message:"Keine Treffer fuer die aktuellen Filter",description:"Bitte ABC-Filter oder Status-Filter anpassen."})]})})]})}export{de as default};
