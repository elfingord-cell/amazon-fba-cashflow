import{an as $t,I as It,t as c,k as t,T as de,J as Rt,L as j,O as Kt,K as P,M as Me,S as Be,P as Tt}from"./index-CAzQztwo.js";import{b as Ht}from"./abcClassification-D8Ca84qt.js";import{r as _t,a as Wt,c as qt,g as Y}from"./inventoryProjection-BZ_5NrPh.js";import{T as ft}from"./TanStackGrid-DGGNjv9D.js";import{c as ee,n as N,a as Gt,m as Qt,f as q,d as te}from"./months-DiLwPhVv.js";import{h as pt,g as gt,b as Vt,c as Zt,a as yt,s as Jt}from"./uiPrefs-DA4RgD3f.js";import{b as Xt,r as Yt,c as es}from"./orderUtils-B3NFjWvV.js";import{u as ts,C as Le}from"./workspace-xr5uOuIo.js";import{T as jt}from"./index-Dab_0RQN.js";import{a as vt}from"./index-CrruayEm.js";import{S as bt}from"./index-C15xyCf_.js";import{C as ss}from"./index-5SR9pC2K.js";import{R as Ae}from"./index-BZ5evjDG.js";import{R as ns}from"./InfoCircleOutlined-COYE5d9y.js";import{C as xt}from"./Collapse-mRNqWjAX.js";const{Paragraph:rs,Text:m,Title:$e}=Rt,At=[6,12,18];function as(o){(!o.inventory||typeof o.inventory!="object")&&(o.inventory={snapshots:[],settings:{projectionMonths:12,safetyDays:60}});const a=o.inventory;Array.isArray(a.snapshots)||(a.snapshots=[]),(!a.settings||typeof a.settings!="object")&&(a.settings={projectionMonths:12,safetyDays:60})}function se(o){const a=Number(o);return Number.isFinite(a)?Math.max(0,Math.round(a)):0}function M(o){return Number.isFinite(o)?Math.round(Number(o)).toLocaleString("de-DE"):"—"}function ne(o){if(!o)return"—";const[a,h,l]=String(o).split("-").map(Number);if(!a||!h||!l)return"—";const x=new Date(Date.UTC(a,h-1,l));return Number.isNaN(x.getTime())?"—":x.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ie(o){const a={};return Array.isArray(o)&&o.forEach(h=>{const l=h||{},x=String(l.sku||"").trim();x&&(a[x]={amazonUnits:se(l.amazonUnits),threePLUnits:se(l.threePLUnits),note:String(l.note||"")})}),a}function os(){return new Date().toISOString()}function is(o,a){var A;const h=((A=o.inventory)==null?void 0:A.snapshots)||[],l=N(a);return l&&h.find(k=>N(k.month)===l)||null}function kt(o,a){var A;const h=N(a);if(!h)return null;const l=(((A=o.inventory)==null?void 0:A.snapshots)||[]).map(k=>k).filter(k=>N(k.month)).sort((k,D)=>String(N(k.month)).localeCompare(String(N(D.month))));let x=null;return l.forEach(k=>{const D=N(k.month);D&&D<h&&(x=k)}),x}function ls(o){var h;const a=(((h=o.inventory)==null?void 0:h.snapshots)||[]).map(l=>N(l.month)).filter(Boolean);return a.length?(a.sort((l,x)=>l.localeCompare(x)),a[a.length-1]||null):null}function St(o,a){const h=new Map;o.forEach(x=>{var k;const A=x.categoryLabel||"Ohne Kategorie";h.has(A)||h.set(A,[]),(k=h.get(A))==null||k.push(x)});const l=Array.from(h.entries()).map(([x,A])=>({key:x,label:x,rows:A.sort((k,D)=>{const T=k.alias.localeCompare(D.alias,"de-DE",{sensitivity:"base"});return T!==0?T:k.sku.localeCompare(D.sku,"de-DE",{sensitivity:"base"})})}));return Jt(l,a)}function cs(o){return/^\d{4}-\d{2}$/.test(o)?`${o}-01`:null}function Ce(o){const a=Number(o);return!Number.isFinite(a)||a<=0?null:a}function ds(o,a){var T;const h=Ce(o==null?void 0:o.productionLeadTimeDaysDefault)??Ce(a.defaultProductionLeadTimeDays)??45,l=(T=o==null?void 0:o.template)==null?void 0:T.fields,x=String((l==null?void 0:l.transportMode)??(o==null?void 0:o.transportMode)??"sea").toLowerCase(),A=a.transportLeadTimesDays||{},k=Ce(A[x])??Ce(A.sea)??45,D=Number(a.defaultBufferDays??0);return Math.max(0,Math.round(h+k+(Number.isFinite(D)?D:0)))}function us(o){return o==="doh"?"DOH zeigt die Reichweite des projizierten Monatsendbestands in Tagen.":o==="plan"?"Plan zeigt den geplanten Monatsabsatz (Forecast) je SKU.":"Units zeigt den projizierten Monatsendbestand je SKU inklusive Inbound-Wirkung."}function Mt(o){return o==="revenue_6m"?"ABC-Basis: Umsatz (6 Monate)":o==="units_6m_fallback"?"ABC-Basis: Units-Fallback (6 Monate)":"ABC-Basis: keine Forecast-Daten"}function hs(o,a){const h=String(o||"C").toUpperCase();return a==="safety-negative"?h==="A"?6:h==="B"?4:2:a==="safety-low"?h==="A"?3:h==="B"?2:1:0}function ms(o){const a=String(o||"").trim().toLowerCase();return a==="oos"?"oos":a==="under_safety"?"under_safety":"all"}function fs(o){const a=String(o||"").trim().toLowerCase();return a==="a"?"a":a==="b"?"b":a==="ab"?"ab":a==="abc"?"abc":"all"}function Re(o){const a=Number(o);if(!Number.isFinite(a))return 12;const h=Math.round(a);return At.includes(h)?h:h<9?6:h<15?12:18}function Ke(o){const a=String(o||"").trim().toUpperCase();return a==="A"||a==="B"||a==="C"?a:null}function ps(o){const a=Ke(o);return a==="A"?0:a==="B"?1:a==="C"?2:3}function gs(o,a){if(a==="all")return!0;const h=Ke(o);return a==="a"?h==="A":a==="b"?h==="B":a==="ab"?h==="A"||h==="B":h!=null}function ys(o){if(!o)return t.jsx(m,{type:"secondary",children:"Kein Inbound in diesem Monat."});const a=Array.isArray(o.poItems)?o.poItems:[],h=Array.isArray(o.foItems)?o.foItems:[];return t.jsxs("div",{style:{minWidth:260,maxWidth:340},children:[t.jsxs("div",{style:{marginBottom:8},children:[t.jsx(m,{strong:!0,children:"PO Inbound"}),a.length?t.jsx("div",{children:a.map(l=>t.jsx("div",{children:t.jsxs(m,{children:[l.ref," · +",M(l.units)," · ",ne(l.arrivalDate)]})},`po-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(m,{type:"secondary",children:" Keine PO-Ankunft"})]}),t.jsxs("div",{children:[t.jsx(m,{strong:!0,children:"FO Inbound"}),h.length?t.jsx("div",{children:h.map(l=>t.jsx("div",{children:t.jsxs(m,{children:[l.ref," · +",M(l.units)," · ",ne(l.arrivalDate)]})},`fo-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(m,{type:"secondary",children:" Keine FO-Ankunft"})]})]})}function Ps({view:o="both"}={}){const a=$t(),h=It(),{state:l,loading:x,saving:A,error:k,lastSavedAt:D,saveWith:T}=ts(),Te=pt("inventory_snapshot"),He=pt("inventory_projection"),_e=c.useRef(!1),[C,Ue]=c.useState(()=>ee()),[We,qe]=c.useState(!1),[Ne,ue]=c.useState({}),[Ge,re]=c.useState(!1),[v,Ct]=c.useState("units"),[we,Qe]=c.useState(""),[De,Ut]=c.useState(!0),[G,he]=c.useState("all"),[H,Q]=c.useState("all"),[_,Ve]=c.useState(12),[me,fe]=c.useState(()=>gt("inventory_snapshot")),[pe,ae]=c.useState(()=>gt("inventory_projection")),[F,ge]=c.useState(null),[ye,Ze]=c.useState(null),[Je,Xe]=c.useState(!1),[V,Oe]=c.useState(null),L=o!=="projection",z=o!=="snapshot",w=l,je=l.inventory||{},Ye=je.settings||{},Fe=l.settings||{};c.useEffect(()=>{if(_e.current)return;const e=new URLSearchParams(a.search);if(e.get("source")!=="dashboard")return;_e.current=!0;const s=String(e.get("sku")||"").trim();s&&Qe(s);const n=N(e.get("month"));n&&Ze(n),he(ms(e.get("risk"))),Q(fs(e.get("abc"))),e.get("expand")==="all"&&Xe(!0)},[a.search]);const I=c.useMemo(()=>{const e=new Set;return e.add(ee()),(Array.isArray(je.snapshots)?je.snapshots:[]).forEach(s=>{const r=N(s.month);r&&e.add(r)}),Array.from(e).sort()},[je.snapshots]),ve=c.useMemo(()=>ls(w),[l.inventory]);c.useEffect(()=>{I.includes(C)||(Ue(ve||I[I.length-1]||ee()),qe(!1))},[ve,I,C]),c.useEffect(()=>{if(We)return;const e=ve||I[I.length-1]||ee();e&&e!==C&&Ue(e)},[ve,I,C,We]),c.useEffect(()=>{const e=is(w,C),s=Ie((e==null?void 0:e.items)||[]);ue(s),re(!1)},[C,w]),c.useEffect(()=>{const e=Number(Ye.projectionMonths);Number.isFinite(e)&&e>0&&Ve(Re(e))},[Ye.projectionMonths]);const et=c.useMemo(()=>{const e=new Map;return(Array.isArray(l.productCategories)?l.productCategories:[]).forEach(s=>{const n=s,r=String(n.id||"");r&&e.set(r,String(n.name||"Ohne Kategorie"))}),e},[l.productCategories]),Z=c.useMemo(()=>Vt(w),[l.productCategories]),Pe=c.useMemo(()=>Ht(w).bySku,[l]),tt=c.useMemo(()=>(Array.isArray(l.products)?l.products:[]).map(e=>e).map(e=>({sku:String(e.sku||"").trim(),raw:e})).filter(e=>e.sku),[l.products]);c.useMemo(()=>new Map(tt.map(e=>[e.sku,e.raw])),[tt]);const J=c.useMemo(()=>kt(w,C),[C,w]),st=c.useMemo(()=>Ie((J==null?void 0:J.items)||[]),[J==null?void 0:J.items]),nt=c.useMemo(()=>(Array.isArray(l.products)?l.products:[]).map(s=>{const n=s,r=String(n.sku||"").trim();if(!r)return null;const i=String(n.alias||r),d=String(n.status||"").trim().toLowerCase(),u=!d||d==="active"||d==="aktiv",f=et.get(String(n.categoryId||""))||"Ohne Kategorie",g=Ne[r]||{amazonUnits:0,threePLUnits:0},y=st[r]||{amazonUnits:0,threePLUnits:0},S=g.amazonUnits+g.threePLUnits,E=y.amazonUnits+y.threePLUnits,W=_t(n,w),B=Wt(n,w),X=Pe.get(r.toLowerCase())||Pe.get(r)||null,Bt=(X==null?void 0:X.abcClass)??null,Lt=(X==null?void 0:X.abcBasis)||"no_data";return{sku:r,alias:i,categoryLabel:f,abcClass:Bt,abcBasis:Lt,isActive:u,amazonUnits:g.amazonUnits,threePLUnits:g.threePLUnits,totalUnits:S,delta:S-E,safetyDays:Number.isFinite(W)?Number(W):null,coverageDays:Number.isFinite(B)?Number(B):null}}).filter(Boolean),[Pe,et,st,Ne,l.products,w]),U=c.useMemo(()=>{const e=we.trim().toLowerCase();return nt.filter(s=>De&&!s.isActive||!gs(s.abcClass,H)?!1:e?[s.sku,s.alias,s.categoryLabel,s.abcClass||""].join(" ").toLowerCase().includes(e):!0).sort((s,n)=>{const r=Zt(s.categoryLabel,n.categoryLabel,Z);if(r!==0)return r;const i=s.alias.localeCompare(n.alias,"de-DE",{sensitivity:"base"});return i!==0?i:s.sku.localeCompare(n.sku,"de-DE",{sensitivity:"base"})})},[H,nt,Z,De,we]),$=c.useMemo(()=>St(U,Z),[Z,U]);c.useEffect(()=>{L&&fe(e=>{if(!$.length)return[];const s=new Set($.map(r=>r.key)),n=e.filter(r=>s.has(r));return n.length||Te?n:$.map(r=>r.key)})},[$,Te,L]),c.useEffect(()=>{yt("inventory_snapshot",me)},[me]),c.useEffect(()=>{yt("inventory_projection",pe)},[pe]);const oe=ee(),rt=c.useMemo(()=>Gt(oe,-1),[oe]),b=c.useMemo(()=>Qt(oe,_),[oe,_]),p=c.useMemo(()=>qt({state:w,months:b,products:U.map(e=>({sku:e.sku,alias:e.alias,status:e.isActive?"active":"inactive",safetyStockDohOverride:e.safetyDays,foCoverageDohOverride:e.coverageDays})),snapshot:null,snapshotMonth:rt,projectionMode:v}),[U,rt,v,b,w]),at=c.useMemo(()=>Xt(w),[l.forecast,l.inventory,l.pos,l.fos]),R=c.useMemo(()=>{const e=new Set,s=new Set;let n=null,r=null;return U.forEach(i=>{b.forEach(d=>{var g;const u=(g=p.perSkuMonth.get(i.sku))==null?void 0:g.get(d);if(!u)return;const f=Y({projectionMode:v,endAvailable:u.endAvailable,safetyUnits:u.safetyUnits,doh:u.doh,safetyDays:u.safetyDays});f&&(e.add(i.sku),(!n||d<n)&&(n=d),f==="safety-negative"&&(s.add(i.sku),(!r||d<r)&&(r=d)))})}),{underSafetySkus:e.size,oosSkus:s.size,criticalMonth:r||n,missingEta:Number(p.inboundMissingDateCount||0)}},[U,p,v,b]),ie=c.useMemo(()=>{const e=new Map;return b.forEach(s=>{e.set(s,{month:s,score:0,oosCount:0,underSafetyCount:0,criticalSkus:new Set})}),U.forEach(s=>{b.forEach(n=>{var u;const r=(u=p.perSkuMonth.get(s.sku))==null?void 0:u.get(n);if(!r)return;const i=Y({projectionMode:v,endAvailable:r.endAvailable,safetyUnits:r.safetyUnits,doh:r.doh,safetyDays:r.safetyDays});if(!i)return;const d=e.get(n);d&&(d.score+=hs(s.abcClass,i),d.underSafetyCount+=1,i==="safety-negative"&&(d.oosCount+=1),d.criticalSkus.add(s.sku))})}),e},[U,p,v,b]),ot=c.useMemo(()=>{const e=Array.from(ie.values()).map(s=>Number(s.score||0));return e.length?Math.max(...e,0):0},[ie]),it=c.useMemo(()=>{const e=new Map;return U.forEach(s=>{let n=!1,r=!1;b.forEach(i=>{var f;const d=(f=p.perSkuMonth.get(s.sku))==null?void 0:f.get(i);if(!d)return;const u=Y({projectionMode:v,endAvailable:d.endAvailable,safetyUnits:d.safetyUnits,doh:d.doh,safetyDays:d.safetyDays});u&&(r=!0,u==="safety-negative"&&(n=!0))}),e.set(s.sku,{hasOos:n,hasUnderSafety:r})}),e},[U,p,v,b]),le=c.useMemo(()=>G==="all"?U:U.filter(e=>{const s=it.get(e.sku);return s?G==="oos"?s.hasOos:s.hasUnderSafety:!1}),[U,it,G]),be=c.useMemo(()=>St(le,Z),[Z,le]),xe=c.useMemo(()=>{var e;return F?((e=ie.get(F))==null?void 0:e.criticalSkus)||new Set:null},[F,ie]),O=c.useMemo(()=>!F||!xe||!xe.size?be:be.map(e=>({...e,rows:e.rows.filter(s=>xe.has(s.sku))})).filter(e=>e.rows.length>0),[be,xe,F]);function lt(e,s,n,r){const i=Yt(Array.isArray(l.products)?l.products:[],e.sku),d=ds(i,Fe),u=es({context:at,sku:e.sku,leadTimeDays:d,product:i,settings:Fe,horizonMonths:Math.max(6,_),requiredArrivalMonth:s}),f=String((u==null?void 0:u.status)||""),g=Number((u==null?void 0:u.recommendedUnits)||0),y=Math.max(0,Math.ceil(Number(n.safetyUnits||0)-Number(n.endAvailable||0))),S=Math.max(0,Math.round(Number.isFinite(g)&&g>0?g:y)),E=String((u==null?void 0:u.requiredArrivalDate)||cs(s)||"")||null,W=String((u==null?void 0:u.orderDateAdjusted)||(u==null?void 0:u.orderDate)||"")||null;return{cellKey:r,row:e,month:s,data:n,recommendedUnits:S,requiredArrivalDate:E,recommendedOrderDate:W,recommendation:u,recommendationStatus:f}}const ke=c.useMemo(()=>{if(v==="plan")return new Map;const e=new Map;return le.forEach(s=>{var u,f;let n=null;for(const g of b){const y=(u=p.perSkuMonth.get(s.sku))==null?void 0:u.get(g);if(!y)continue;const S=Y({projectionMode:v,endAvailable:y.endAvailable,safetyUnits:y.safetyUnits,doh:y.doh,safetyDays:y.safetyDays});if(S==="safety-negative"||S==="safety-low"){n=g;break}}if(!n)return;const r=(f=p.perSkuMonth.get(s.sku))==null?void 0:f.get(n);if(!r)return;const i=`${s.sku}|${n}`,d=lt(s,n,r,i);d.recommendationStatus!=="ok"||d.recommendedUnits<=0||e.set(i,d)}),e},[p,v,b,le,_,at,Fe,l.products]),K=c.useMemo(()=>{const e=Array.from(ke.values()).map(s=>{const n=Y({projectionMode:v,endAvailable:s.data.endAvailable,safetyUnits:s.data.safetyUnits,doh:s.data.doh,safetyDays:s.data.safetyDays});if(n!=="safety-negative"&&n!=="safety-low")return null;const r=Ke(s.row.abcClass),i=s.month,d=Number(String(i||"").replace("-","")),u=n==="safety-negative"?-.5:0,f=ps(r)*1e3+(Number.isFinite(d)?d:999999)+u;return{key:`${s.row.sku}|${s.month}`,sku:s.row.sku,alias:s.row.alias,abcClass:r,month:i,riskClass:n,recommendedUnits:s.recommendedUnits,requiredArrivalDate:s.requiredArrivalDate,recommendedOrderDate:s.recommendedOrderDate,priority:f,intent:s}}).filter(Boolean);return e.sort((s,n)=>{if(s.priority!==n.priority)return s.priority-n.priority;if(s.month!==n.month)return s.month.localeCompare(n.month);const r=Number(n.recommendedUnits||0)-Number(s.recommendedUnits||0);return r!==0?r:s.sku.localeCompare(n.sku,"de-DE",{sensitivity:"base"})}),e},[ke,v]);c.useEffect(()=>{F&&!b.includes(F)&&ge(null)},[b,F]),c.useEffect(()=>{ye&&b.length&&(b.includes(ye)&&ge(ye),Ze(null))},[ye,b]),c.useEffect(()=>{z&&ae(e=>{if(!O.length)return[];const s=new Set(O.map(r=>r.key)),n=e.filter(r=>s.has(r));return n.length||He?n:O.map(r=>r.key)})},[He,O,z]),c.useEffect(()=>{!z||!Je||O.length&&(ae(O.map(e=>e.key)),Xe(!1))},[Je,O,z]);function ct(e,s,n,r){Oe(lt(e,s,n,r))}function Se(e,s){if(!e)return;const n=new URLSearchParams;n.set("source","inventory_projection"),n.set("sku",e.row.sku),n.set("month",e.month),n.set("suggestedUnits",String(e.recommendedUnits||0)),n.set("projectedEnd",String(Math.round(Number(e.data.endAvailable||0)))),n.set("mode",v),e.requiredArrivalDate&&n.set("requiredArrivalDate",e.requiredArrivalDate),e.recommendedOrderDate&&n.set("recommendedOrderDate",e.recommendedOrderDate),n.set("returnTo","/v2/inventory/projektion");const r=(s==null?void 0:s.nextIntent)||null;r&&(n.set("nextSku",r.row.sku),n.set("nextMonth",r.month),n.set("nextSuggestedUnits",String(r.recommendedUnits||0)),r.requiredArrivalDate&&n.set("nextRequiredArrivalDate",r.requiredArrivalDate),r.recommendedOrderDate&&n.set("nextRecommendedOrderDate",r.recommendedOrderDate)),h(`/v2/orders/fo?${n.toString()}`),Oe(null)}function Nt(e){var s,n,r,i,d,u;return t.jsxs("div",{className:"v2-proj-action-menu",children:[t.jsx(m,{strong:!0,children:e.row.alias}),t.jsx(m,{type:"secondary",children:e.row.sku}),t.jsx(m,{type:"secondary",children:q(e.month)}),t.jsxs(m,{children:["Bestand EOM: ",t.jsx("strong",{children:M(e.data.endAvailable)})]}),t.jsxs(m,{children:["Safety: ",t.jsx("strong",{children:M(e.data.safetyUnits)})]}),t.jsxs(m,{children:["Ankunft: ",t.jsx("strong",{children:ne(e.requiredArrivalDate)})]}),t.jsxs(m,{children:["Bestellen bis: ",t.jsx("strong",{children:ne(e.recommendedOrderDate)})]}),t.jsxs(m,{children:["Vorschlag: ",t.jsx("strong",{children:M(e.recommendedUnits)})]}),e.recommendationStatus!=="ok"?t.jsx(m,{type:"warning",children:"Hinweis: Empfehlung ist nicht vollständig belastbar."}):null,Number(((s=e.recommendation)==null?void 0:s.coverageDaysForOrder)||0)>0?t.jsxs(m,{type:"secondary",children:["Bedarf (",M(Number(((n=e.recommendation)==null?void 0:n.coverageDaysForOrder)||0))," Tage): ",M(Number(((r=e.recommendation)==null?void 0:r.coverageDemandUnits)||0))]}):null,(i=e.recommendation)!=null&&i.moqApplied?t.jsxs(m,{type:"warning",children:["MOQ angewendet: kalkulatorisch ",M(Number(((d=e.recommendation)==null?void 0:d.recommendedUnitsRaw)||0))," → MOQ ",M(Number(((u=e.recommendation)==null?void 0:u.recommendedUnits)||0))]}):null,t.jsx("div",{className:"v2-actions-inline",children:t.jsx(P,{size:"small",type:"primary",onClick:()=>Se(e),children:"FO erstellen"})})]})}const wt=c.useMemo(()=>[{header:"SKU",accessorKey:"sku",meta:{width:158,minWidth:158}},{header:"Alias",accessorKey:"alias",meta:{width:230,minWidth:220}},{header:"ABC",meta:{width:72,align:"center"},cell:({row:e})=>t.jsx(de,{title:Mt(e.original.abcBasis),children:t.jsx("span",{children:e.original.abcClass||"—"})})},{header:"Amazon",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(jt,{className:"v2-grid-input",value:e.original.amazonUnits,min:0,style:{width:"100%"},controls:!1,onChange:s=>{const n=se(s);ue(r=>({...r,[e.original.sku]:{...r[e.original.sku]||{amazonUnits:0,threePLUnits:0,note:""},amazonUnits:n}})),re(!0)}})},{header:"3PL",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(jt,{className:"v2-grid-input",value:e.original.threePLUnits,min:0,style:{width:"100%"},controls:!1,onChange:s=>{const n=se(s);ue(r=>({...r,[e.original.sku]:{...r[e.original.sku]||{amazonUnits:0,threePLUnits:0,note:""},threePLUnits:n}})),re(!0)}})},{header:"Total",meta:{width:92,align:"right"},cell:({row:e})=>M(e.original.totalUnits)},{header:"Delta",meta:{width:92,align:"right"},cell:({row:e})=>t.jsx("span",{className:e.original.delta<0?"v2-negative":"",children:M(e.original.delta)})},{header:"Safety DOH",meta:{width:96,align:"right"},cell:({row:e})=>M(e.original.safetyDays)},{header:"Coverage DOH",meta:{width:108,align:"right"},cell:({row:e})=>M(e.original.coverageDays)}],[]),dt=Array.isArray(p.anchorForecastGapSkus)?p.anchorForecastGapSkus:[],ut=Array.isArray(p.anchorSkuFallbackSkus)?p.anchorSkuFallbackSkus:[],ce=Array.isArray(p.anchorSkuMissingHistory)?p.anchorSkuMissingHistory:[],ht=c.useMemo(()=>new Set(ut.map(e=>String(e||"").trim())),[ut]),mt=c.useMemo(()=>new Set(ce.map(e=>String(e||"").trim())),[ce]),Dt=c.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:270,minWidth:250},cell:({row:n})=>t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx("div",{className:"v2-proj-alias-main",title:n.original.alias,children:n.original.alias}),t.jsx(m,{className:"v2-proj-sku-secondary",type:"secondary",title:n.original.sku,children:n.original.sku})]})},{header:"ABC",meta:{width:68,align:"center"},cell:({row:n})=>t.jsx(de,{title:Mt(n.original.abcBasis),children:t.jsx("span",{children:n.original.abcClass||"—"})})},{header:"Safety DOH",meta:{width:96,align:"right"},cell:({row:n})=>M(n.original.safetyDays)},{header:"Coverage DOH",meta:{width:110,align:"right"},cell:({row:n})=>M(n.original.coverageDays)},{header:"Ankerbestand",meta:{width:118,align:"right"},cell:({row:n})=>{var S,E;const r=String(n.original.sku||"").trim(),i=p.startAvailableBySku.get(r),d=ht.has(r),u=mt.has(r),f=((E=(S=p.anchorSourceBySku)==null?void 0:S.get)==null?void 0:E.call(S,r))||null,g=f!=null&&f.month?te(String(f.month),"long"):"—",y=u?"Keine Snapshot-Historie für diese SKU. Startwert = 0.":d?`SKU-Fallback: letzter verfügbarer Snapshot (${g}).`:`Anchor-Snapshot (${g}).`;return t.jsx(de,{title:y,children:t.jsx("span",{children:M(Number.isFinite(i)?Number(i):0)})})}}],s=b.map(n=>({id:n,header:q(n),meta:{minWidth:106,width:106,align:"right"},cell:({row:r})=>{var W;const i=(W=p.perSkuMonth.get(r.original.sku))==null?void 0:W.get(n);if(!i)return"—";let d=null;v==="plan"?d=Number.isFinite(i.forecastUnits)?Number(i.forecastUnits):null:v==="doh"?d=Number.isFinite(i.doh)?Number(i.doh):null:d=Number.isFinite(i.endAvailable)?Number(i.endAvailable):null;const u=Y({projectionMode:v,endAvailable:i.endAvailable,safetyUnits:i.safetyUnits,doh:i.doh,safetyDays:i.safetyDays}),f=v!=="plan",g=i.inboundDetails,y=`${r.original.sku}|${n}`,S=ke.get(y)||null,E=(V==null?void 0:V.cellKey)===y;return t.jsx(vt,{trigger:f?"click":"hover",placement:"rightTop",open:f?E:void 0,onOpenChange:B=>{f&&!B&&E&&Oe(null)},content:E&&V?Nt(V):null,children:t.jsxs("div",{className:["v2-proj-cell",u?`v2-proj-cell--${u}`:"",f?"v2-proj-cell--actionable":""].filter(Boolean).join(" "),role:f?"button":void 0,tabIndex:f?0:void 0,onClick:f?()=>ct(r.original,n,i,y):void 0,onKeyDown:f?B=>{(B.key==="Enter"||B.key===" ")&&(B.preventDefault(),ct(r.original,n,i,y))}:void 0,children:[t.jsx("div",{className:"v2-proj-cell-main",children:M(d)}),v!=="plan"&&Number.isFinite(i.safetyUnits)?t.jsxs(m,{type:"secondary",style:{fontSize:11},children:["SB: ",M(i.safetyUnits)]}):null,S?t.jsx("button",{type:"button",className:"v2-proj-fo-badge",onClick:B=>{B.stopPropagation(),Se(S)},children:"FO empfohlen"}):null,g&&g.totalUnits>0?t.jsx(vt,{content:ys(g),trigger:"hover",placement:"topLeft",children:t.jsxs("div",{className:"v2-proj-inbound-row",children:[g.poUnits>0?t.jsxs(j,{className:"v2-proj-inbound v2-proj-inbound--po",children:["PO +",M(g.poUnits)]}):null,g.foUnits>0?t.jsxs(j,{className:"v2-proj-inbound v2-proj-inbound--fo",children:["FO +",M(g.foUnits)]}):null]})}):null]})})}}));return[...e,...s]},[V,mt,ht,ke,p,v,b]);async function Ot(){await T(e=>{const s=Tt(e),n=s;as(n);const r=n.inventory,i=Array.isArray(r.snapshots)?[...r.snapshots]:[],d=Object.entries(Ne).map(([y,S])=>({sku:y,amazonUnits:se(S.amazonUnits),threePLUnits:se(S.threePLUnits),note:String(S.note||"")})).filter(y=>y.amazonUnits>0||y.threePLUnits>0||y.note),u=N(C)||ee(),f=i.findIndex(y=>N(y.month)===u),g={month:u,items:d,updatedAt:os()};return f>=0?i[f]={...i[f]||{},...g}:i.push(g),i.sort((y,S)=>String(N(y.month)).localeCompare(String(N(S.month)))),r.snapshots=i,r.settings={...r.settings||{},projectionMonths:Re(_)},s},"v2:inventory:save-snapshot"),re(!1)}async function Ft(){const e=kt(w,C);e&&(ue(Ie(e.items||[])),re(!0))}function Pt(){const s=[["SKU","Alias","Kategorie","AmazonUnits","ThreePLUnits","TotalUnits"],...U.map(d=>[d.sku,d.alias,d.categoryLabel,String(d.amazonUnits),String(d.threePLUnits),String(d.totalUnits)])].map(d=>d.map(u=>`"${String(u).replace(/"/g,'""')}"`).join(";")).join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=`inventory-snapshot-${C}.csv`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}const ze=String(p.anchorMode||"no_snapshot"),Ee=N(p.anchorTargetMonth||p.anchorMonth),zt=oe,Et=ze==="rollforward"?`Anker: ${p.anchorSourceMonth||"—"} Snapshot → Rollforward bis ${Ee||"—"}`:ze==="snapshot"?`Anker: Snapshot ${Ee||p.anchorSourceMonth||"—"}`:"Anker: kein Snapshot (Start bei 0)";return t.jsxs("div",{className:"v2-page",children:[t.jsxs(Le,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx($e,{level:3,children:L&&!z?"Bestandsaufnahme":z&&!L?"Bestandsprojektion":"Inventory"}),t.jsx(rs,{children:L&&!z?"Monatliche Snapshot-Erfassung mit Kategoriegruppen, Copy-Forward, Speicherung und CSV-Export.":z&&!L?"Bestandsprojektion mit Risikoampel, PO/FO-Inbound-Sicht und direkter Bestellbrücke.":"Snapshot-Erfassung und Projektion (Units / DOH / Plan) in einem Arbeitsbereich."})]})}),t.jsxs("div",{className:"v2-toolbar",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[L?t.jsx(bt,{value:C,onChange:e=>{Ue(e),qe(!0)},options:I.map(e=>({value:e,label:`${e} · ${te(e,"long")}`})),style:{width:260,maxWidth:"100%"}}):null,t.jsx(Kt,{value:we,onChange:e=>Qe(e.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),t.jsx(ss,{checked:De,onChange:e=>Ut(e.target.checked),children:"Nur aktive Produkte"}),z?t.jsxs(t.Fragment,{children:[t.jsxs(Ae.Group,{value:v,onChange:e=>Ct(e.target.value),children:[t.jsx(Ae.Button,{value:"units",children:"Units"}),t.jsx(Ae.Button,{value:"doh",children:"DOH"}),t.jsx(Ae.Button,{value:"plan",children:"Plan"})]}),t.jsx(de,{title:us(v),children:t.jsx(ns,{style:{color:"#64748b",fontSize:16}})}),t.jsx(bt,{value:_,onChange:e=>Ve(Re(e)),style:{width:160,maxWidth:"100%"},options:At.map(e=>({value:e,label:`Horizont ${e} Monate`}))})]}):null]}),L?t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(P,{onClick:()=>{Ft()},children:"Vorherigen Monat kopieren"}),t.jsx(P,{type:"primary",onClick:()=>{Ot()},disabled:!Ge,loading:A,children:"Snapshot speichern"}),t.jsx(P,{onClick:Pt,children:"Snapshot CSV"}),Ge?t.jsx(j,{color:"orange",children:"Ungespeicherte Änderungen"}):t.jsx(j,{color:"green",children:"Synchron"}),t.jsx(j,{color:"blue",children:te(C,"long")}),D?t.jsxs(j,{color:"green",children:["Gespeichert: ",new Date(D).toLocaleTimeString("de-DE")]}):null]}):null]})]}),k?t.jsx(Me,{type:"error",showIcon:!0,message:k}):null,x?t.jsx(Me,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,L?t.jsxs(Le,{children:[t.jsxs($e,{level:4,children:["Snapshot zum Stichtag ",te(C,"long")]}),t.jsxs(m,{type:"secondary",children:["Monatsschlüssel: ",C]}),t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(m,{type:"secondary",children:[U.length," Produkte in ",$.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(P,{size:"small",onClick:()=>fe($.map(e=>e.key)),disabled:!$.length,children:"Alles auf"}),t.jsx(P,{size:"small",onClick:()=>fe([]),disabled:!me.length,children:"Alles zu"})]})]}),$.length?t.jsx(xt,{className:"v2-category-collapse",activeKey:me,onChange:e=>fe((Array.isArray(e)?e:[e]).map(String)),items:$.map(e=>({key:e.key,label:t.jsxs(Be,{children:[t.jsx(m,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(ft,{data:e.rows,columns:wt,minTableWidth:1120,tableLayout:"fixed"})}))}):t.jsx(m,{type:"secondary",children:"Keine Snapshot-Zeilen für den aktuellen Filter."})]}):null,z?t.jsxs(Le,{children:[t.jsxs($e,{level:4,children:["Projektion (",v.toUpperCase(),")"]}),t.jsxs("div",{className:"v2-proj-cluster-grid",children:[t.jsxs("div",{className:"v2-proj-context-cluster",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{color:"blue",children:["Heute: ",te(zt,"long")]}),t.jsx(j,{color:ze==="no_snapshot"?"red":"blue",children:Et}),t.jsxs(j,{color:"default",children:["Zeitraum: ",b[0]||"—"," bis ",b[b.length-1]||"—"]}),t.jsxs(j,{color:"default",children:["Horizont: ",_," Monate"]})]}),t.jsxs("div",{className:"v2-toolbar-row",children:[p.snapshotFallbackUsed?t.jsx(j,{color:"gold",children:"Fallback auf letzten Snapshot ≤ Ankermonat"}):null,p.resolvedSnapshotMonth?t.jsxs(j,{color:"blue",children:["Stichtag Anchor: ",te(String(p.resolvedSnapshotMonth||Ee||""),"long")]}):null,Number(p.anchorSkuFallbackCount||0)>0?t.jsxs(j,{color:"gold",children:["SKU-Fallback aktiv: ",Number(p.anchorSkuFallbackCount||0)]}):null,R.missingEta>0?t.jsxs(j,{color:"orange",children:["Fehlende ETA: ",R.missingEta]}):t.jsx(j,{color:"green",children:"Fehlende ETA: 0"}),t.jsx(de,{title:"Units = projizierter Monatsendbestand · DOH = Reichweite in Tagen · Plan = Forecast-Absatz · Safety = Vergleich gegen Safety-Schwelle je SKU/Monat",children:t.jsx(j,{color:"default",children:"Modus-Hilfe"})})]}),dt.length>0?t.jsx(Me,{className:"v2-proj-anchor-warning",type:"warning",showIcon:!0,message:`Anker-Rollforward mit Forecast-Lücken bei ${dt.length} SKU(s) – diese Monate wurden mit 0 Units gerechnet.`}):null,ce.length>0?t.jsx(Me,{className:"v2-proj-anchor-warning",type:"error",showIcon:!0,message:`Keine Snapshot-Historie für ${ce.length} SKU(s) – Anker startet dort mit 0.`,description:ce.slice(0,8).join(", ")}):null]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(m,{type:"secondary",children:"Risiko-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${G==="all"?"is-active":""}`,onClick:()=>he("all"),children:"Alle Risiken"}),t.jsxs("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--negative ${G==="oos"?"is-active":""}`,onClick:()=>he("oos"),children:["OOS / ","<="," 0"]}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--low ${G==="under_safety"?"is-active":""}`,onClick:()=>he("under_safety"),children:"Unter Safety"})]})]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(m,{type:"secondary",children:"ABC-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="all"?"is-active":""}`,onClick:()=>Q("all"),children:"Alle"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="a"?"is-active":""}`,onClick:()=>Q("a"),children:"A"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="b"?"is-active":""}`,onClick:()=>Q("b"),children:"B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="ab"?"is-active":""}`,onClick:()=>Q("ab"),children:"A+B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="abc"?"is-active":""}`,onClick:()=>Q("abc"),children:"ABC"})]})]})]}),t.jsxs("div",{className:"v2-proj-score-strip",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{color:R.underSafetySkus>0?"gold":"green",children:["SKUs unter Safety: ",R.underSafetySkus]}),t.jsxs(j,{color:R.oosSkus>0?"red":"green",children:["OOS: ",R.oosSkus]}),t.jsxs(j,{color:"blue",children:["Kritischster Monat: ",R.criticalMonth?q(R.criticalMonth):"—"]})]}),t.jsxs("div",{className:"v2-proj-heatmap",children:[b.map(e=>{const s=ie.get(e),n=Number((s==null?void 0:s.score)||0),r=ot>0?Math.min(1,n/ot):0,i=F===e;return t.jsxs("button",{type:"button",className:`v2-proj-heatmap-item${i?" is-active":""}`,style:{background:`rgba(220, 38, 38, ${.08+r*.3})`,borderColor:i?"rgba(220, 38, 38, 0.8)":"rgba(15, 27, 45, 0.12)"},onClick:()=>ge(d=>d===e?null:e),title:`${q(e)} · ABC-gewichteter Risikoscore ${n} · OOS ${Number((s==null?void 0:s.oosCount)||0)} · Unter Safety ${Number((s==null?void 0:s.underSafetyCount)||0)}`,children:[t.jsx("span",{children:q(e)}),t.jsxs("strong",{children:["Score ",n]})]},e)}),F?t.jsx(P,{size:"small",onClick:()=>ge(null),children:"Filter löschen"}):null]}),t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{className:"v2-proj-legend v2-proj-legend--negative",children:["Rot = OOS / ","<="," 0"]}),t.jsx(j,{className:"v2-proj-legend v2-proj-legend--low",children:"Orange = Unter Safety"}),t.jsx(j,{className:"v2-proj-legend",children:"Inbound Marker: PO / FO"}),t.jsx(m,{type:"secondary",children:"`FO empfohlen` im ersten Risikomonat anklicken oder Zelle öffnen für FO-Anlage."})]})]}),t.jsxs("div",{className:"v2-proj-worklist",children:[t.jsxs("div",{className:"v2-proj-worklist-head",children:[t.jsxs(Be,{wrap:!0,children:[t.jsx(m,{strong:!0,children:"FO-Arbeitsliste"}),t.jsxs(j,{color:K.length?"gold":"green",children:[K.length," SKU(s)"]}),t.jsx(j,{color:"blue",children:"Sortierung: A/B zuerst, frühester Risikomonat"})]}),K.length?t.jsx(P,{size:"small",type:"primary",onClick:()=>{var e,s;return Se(((e=K[0])==null?void 0:e.intent)||null,{nextIntent:((s=K[1])==null?void 0:s.intent)||null})},children:"Erste SKU öffnen"}):null]}),K.length?t.jsx("div",{className:"v2-table-shell v2-scroll-host",children:t.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"SKU"}),t.jsx("th",{children:"ABC"}),t.jsx("th",{children:"Risikomonat"}),t.jsx("th",{children:"Risiko"}),t.jsx("th",{children:"Empfohlen"}),t.jsx("th",{children:"ETA-Ziel"}),t.jsx("th",{children:"Bestellen bis"}),t.jsx("th",{children:"Aktion"})]})}),t.jsx("tbody",{children:K.map((e,s)=>{var r;const n=((r=K[s+1])==null?void 0:r.intent)||null;return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx(m,{className:"v2-proj-alias-main",children:e.alias||e.sku}),t.jsx(m,{className:"v2-proj-sku-secondary",type:"secondary",children:e.sku})]})}),t.jsx("td",{children:e.abcClass||"—"}),t.jsx("td",{children:q(e.month)}),t.jsx("td",{children:e.riskClass==="safety-negative"?t.jsx(j,{color:"red",children:"OOS / ≤ 0"}):t.jsx(j,{color:"gold",children:"Unter Safety"})}),t.jsx("td",{children:M(e.recommendedUnits)}),t.jsx("td",{children:ne(e.requiredArrivalDate)}),t.jsx("td",{children:ne(e.recommendedOrderDate)}),t.jsx("td",{children:t.jsx(P,{size:"small",type:"primary",onClick:()=>Se(e.intent,{nextIntent:n}),children:"FO öffnen"})})]},e.key)})})]})}):t.jsx(m,{type:"secondary",children:"Keine FO-Empfehlungen im aktuellen Filterumfang."})]}),t.jsxs("div",{className:"v2-category-tools",style:{marginTop:10},children:[t.jsx(m,{type:"secondary",children:F?`${O.reduce((e,s)=>e+s.rows.length,0)} kritische Produkte in ${O.length} Kategorien (${q(F)})`:`${le.length} Produkte in ${be.length} Kategorien`}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(P,{size:"small",onClick:()=>ae(O.map(e=>e.key)),disabled:!O.length,children:"Alles auf"}),t.jsx(P,{size:"small",onClick:()=>ae([]),disabled:!pe.length,children:"Alles zu"})]})]}),O.length?t.jsx(xt,{className:"v2-category-collapse",activeKey:pe,onChange:e=>ae((Array.isArray(e)?e:[e]).map(String)),items:O.map(e=>({key:e.key,label:t.jsxs(Be,{children:[t.jsx(m,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(ft,{data:e.rows,columns:Dt,minTableWidth:Math.max(1080,760+b.length*118),tableLayout:"fixed",crosshair:"matrix"})}))}):t.jsx(m,{type:"secondary",children:"Keine Projektion für den aktuellen Filter."})]}):null]})}export{Ps as I};
