import{K as we,p as $e}from"./index-BAXFY6Sx.js";import{e as Xe,r as Ee}from"./productCompletenessV2-Bz422Iqg.js";import{c as Be,a as Ze,n as re,m as Je}from"./months-DiLwPhVv.js";import{e as Qe,f as et,b as tt,h as st,k as rt}from"./orderUtils-ClVESXIm.js";import{b as _e}from"./abcClassification-C5M4RBpy.js";import{c as Te,g as je}from"./inventoryProjection-Bk1BjfRg.js";const Ue={wide:.95,partial:.8},ot=90,nt=35,it={full:{label:"Vollständig",detail:"Coverage 100% und keine Blocker."},wide:{label:"Weitgehend",detail:"Coverage ≥95% und keine A/B-Blocker."},partial:{label:"Teilweise",detail:"Coverage ≥80%."},insufficient:{label:"Unzureichend",detail:"Coverage <80% oder A/B-Blocker."}};function H(e){return String(e||"").trim()}function O(e){return H(e).toLowerCase()}function at(e){if(!we(e.includeInForecast,!0))return!1;if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function Ke(e){return/^\d{4}-\d{2}$/.test(String(e||""))}function Le(e){return e!=null&&String(e).trim()!==""}function E(e){const t=$e(e);return Number.isFinite(t)?Number(t):null}function F(e){const t=E(e);return!Number.isFinite(t)||Number(t)<=0?null:Math.round(Number(t))}function ze(e){if(!Ke(e))return null;const[t,s]=e.split("-").map(Number);return!t||!s?null:new Date(Date.UTC(t,s-1,1))}function ct(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function ut(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`}function lt(e,t){const s=new Date(e.getTime());return s.setUTCDate(s.getUTCDate()+t),s}function dt(e){const t=ze(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return 30;const s=t.getUTCFullYear(),r=t.getUTCMonth();return new Date(Date.UTC(s,r+1,0)).getUTCDate()}function ft(e){if(e.ddp===!0||String(e.incoterm||"").trim().toUpperCase()==="DDP")return!0;const s=e.template&&typeof e.template=="object"?e.template:{};return s.ddp===!0?!0:(s.fields&&typeof s.fields=="object"?s.fields:{}).ddp===!0}function ht(e,t){const s=e.settings&&typeof e.settings=="object"?e.settings:{},r=F(s.robustnessLookaheadDaysNonDdp)??ot,o=F(s.robustnessLookaheadDaysDdp)??nt;return ft(t)?o:r}function mt(e){const t=Math.max(1,Math.round(Number(e.lookaheadDays||0))),s=`${e.month}:${t}`,r=e.cache.get(s);if(r)return r;const o=e.months.indexOf(e.month);if(o<0)return e.cache.set(s,[e.month]),[e.month];let n=0;const l=[];for(let c=o;c<e.months.length;c+=1){const u=e.months[c];if(l.push(u),n+=dt(u),n>=t)break}const i=l.length?l:[e.month];return e.cache.set(s,i),i}function gt(e){const t=e.month<e.nowMonth?e.pastProjection:e.futureProjection,s=t.perSkuMonth.get(e.sku)||t.perSkuMonth.get(e.skuKey);return s==null?void 0:s.get(e.month)}function Ve(e,t){const s=e.get(t),r=e.get(O(t)),o=String((s==null?void 0:s.abcClass)||(r==null?void 0:r.abcClass)||"C").toUpperCase();return o==="A"||o==="B"||o==="C"?o:"C"}function kt(e){const t=e.inventory&&typeof e.inventory=="object"?e.inventory:{},s=t.settings&&typeof t.settings=="object"?t.settings:{};return String(s.projectionMode||"").toLowerCase()==="doh"?"doh":"units"}function yt(e){return Number.isFinite(e)?`${Math.max(0,Math.min(100,e*100)).toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}%`:"0.0%"}function pt(e,t){return!e||!e.hasForecast?"":je({projectionMode:t,endAvailable:e.endAvailable,safetyUnits:e.safetyUnits,doh:e.doh,safetyDays:e.safetyDays})}function vt(e){return!e||!e.hasForecast?"":je({projectionMode:"doh",doh:e.doh,safetyDays:e.safetyDays})}function bt(e,t){return e!=null&&e.hasForecast?t==="safety-negative"?"stock_oos":"stock_under_safety":"forecast_missing"}function Dt(e){return e==="forecast_missing"?"Forecast fehlt":e==="stock_oos"?"Out-of-Stock":"Unter Safety"}function Fe(e){return e==="A"||e==="B"}function se(e){return e==="A"?0:e==="B"?1:2}function Ie(e){return e==="stock_oos"?0:e==="stock_under_safety"?1:2}function Oe(e){return e.slice().sort((t,s)=>{const r=se(t.abcClass)-se(s.abcClass);if(r!==0)return r;const o=Ie(t.issueType)-Ie(s.issueType);return o!==0?o:t.sku.localeCompare(s.sku,"de-DE")})}function Ne(e){return e.slice().sort((t,s)=>{const r=Number(s.overdue)-Number(t.overdue);if(r!==0)return r;const o=se(t.abcClass)-se(s.abcClass);if(o!==0)return o;const n=t.orderMonth.localeCompare(s.orderMonth);return n!==0?n:t.sku.localeCompare(s.sku,"de-DE")})}function St(e){const{coverageRatio:t,blockerCount:s,blockerAbCount:r,hasOrderDutyBlocker:o,hasOverdueOrderDutyBlocker:n}=e;return t>=.999999&&s===0?"full":r>0?"insufficient":t>=Ue.wide?o||n?"partial":"wide":t>=Ue.partial?"partial":"insufficient"}function Mt(e,t){const r=(Array.isArray(e.incomings)?e.incomings:[]).find(l=>String(l.month||"")===t);if(r){const l=E(r.revenueEur),i=E(r.payoutPct);if(Number.isFinite(l)||Number.isFinite(i))return!0}const n=(e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{})[t];return n?Number.isFinite(E(n.realRevenueEUR))||Number.isFinite(E(n.realPayoutRatePct)):!1}function Ct(e){const t=e.settings&&typeof e.settings=="object"?e.settings:{},s=t.vatPreview&&typeof t.vatPreview=="object"?t.vatPreview:{},r=e.vatPreviewMonths&&typeof e.vatPreviewMonths=="object"?e.vatPreviewMonths:{};return{active:[s.deShareDefault,s.feeRateDefault,s.fixInputDefault,s.feeRateOfGrossDefault,s.fixInputVatDefault].some(Le),defaults:s,monthOverrides:r}}function Pt(e,t){if(!e.active)return!0;const s=e.monthOverrides[t]&&typeof e.monthOverrides[t]=="object"?e.monthOverrides[t]:{};return[e.defaults.deShareDefault,e.defaults.feeRateDefault,e.defaults.fixInputDefault,e.defaults.feeRateOfGrossDefault,e.defaults.fixInputVatDefault,s.deShare,s.feeRateOfGross,s.fixInputVat].some(Le)}function At(e,t){const s=_e(e).bySku,r=[],o=[];return t.forEach(n=>{const l=H(n.sku);if(!l)return;const i=String(n.alias||l),c=Ve(s,l),u={sku:l,alias:i,abcClass:c},a=E(n.avgSellingPriceGrossEUR);(!Number.isFinite(a)||Number(a)<=0)&&r.push(u);const h=Xe({product:n,state:e});(h==null?void 0:h.status)==="blocked"&&o.push(u)}),{missingPrice:r,blockedCompleteness:o}}function Rt(e){const{state:t,product:s}=e,r=Ee({state:t,product:s,sku:String(s.sku||""),supplierId:String(s.supplierId||""),orderContext:"product"}),o=r.fields&&typeof r.fields=="object"?r.fields:{},n=P=>{const v=o[P];return!v||typeof v!="object"?null:v.value??null},l=String(n("transportMode")||"").toUpperCase(),i=String((s.template&&typeof s.template=="object"?s.template.transportMode:null)||"SEA").toUpperCase(),c=l||i||"SEA",u=n("ddp")===!0||String(s.incoterm||"").toUpperCase()==="DDP"||!!(s.template&&typeof s.template=="object"&&s.template.ddp===!0),a=u||c==="AIR",h=a?14:45,k=a?21:45,m=F(n("productionLeadTimeDays"))??F(s.productionLeadTimeDaysDefault)??F(s.template&&typeof s.template=="object"?s.template.productionDays:null)??h,p=F(n("transitDays"))??F(s.template&&typeof s.template=="object"?s.template.transitDays:null)??F(s.transitDays)??k;return{productionDays:m,transitDays:p,totalDays:Math.max(1,m+p),transportMode:c,ddp:u}}function Tt(e){const t=new Map,s=e.months.filter(r=>r>=e.nowMonth).sort((r,o)=>r.localeCompare(o));return s.length&&e.products.forEach(r=>{const o=H(r.sku);if(!o)return;const n=O(o),l=e.projection.perSkuMonth.get(o)||e.projection.perSkuMonth.get(n);if(!l)return;let i=null,c=null;for(let S=0;S<s.length;S+=1){const b=s[S],M=l.get(b),j=pt(M,e.projectionMode);if(j==="safety-negative"||j==="safety-low"){i=b,c=M||null;break}}if(!i)return;const u=ze(i);if(!(u instanceof Date)||Number.isNaN(u.getTime()))return;const a=Rt({state:e.state,product:r}),h=lt(u,-a.totalDays),k=ct(h),m=ut(h),p=m<e.nowMonth,P=Number(c==null?void 0:c.safetyUnits),v=Number(c==null?void 0:c.endAvailable),D=Number.isFinite(P)&&Number.isFinite(v)?Math.max(0,Math.ceil(P-v)):null;t.set(n,{sku:o,firstRiskMonth:i,latestOrderDate:k,orderMonth:m,leadTimeDays:a.totalDays,overdue:p,requiredArrivalDate:`${i}-01`,recommendedOrderDate:k,shortageUnits:D})}),t}function Ut(e){const t=e.months.reduce((u,a)=>{const h=a.coverage.stockIssues.filter(k=>k.issueType==="forecast_missing").length;return u+h},0),s=e.months.reduce((u,a)=>u+a.coverage.safetyRiskSkus.length,0),r=e.months.reduce((u,a)=>u+a.coverage.orderDutyRiskSkus.length,0),o=e.months.reduce((u,a)=>u+a.coverage.overdueOrderDutySkuCount,0),n=e.months.filter(u=>{const a=u.checks.find(h=>h.key==="cash_in");return a&&!a.passed}).length,l=e.months.filter(u=>{const a=u.checks.find(h=>h.key==="vat");return a&&!a.passed}).length,i=[];if(t>0&&i.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${t} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:t,impact:"Kontostand nicht belastbar"}),s>0||r>0){const u=s+r,a=o>0?` · Überfällig ${o}`:"";i.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${u} SKU-Monat(e) mit Safety-/Bestellpflicht-Risiko${a}.`,severity:"error",route:"/v2/inventory/projektion",count:u,impact:"Stockout-Risiko in A/B möglich"})}n>0&&i.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${n} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:n,impact:"Kontostand-Projektion instabil"}),e.hasFixcostBasis||i.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:e.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),e.vatActive&&l>0&&i.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${l} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:l,impact:"Outflow-Bild unvollständig"}),e.revenueIssueSkus>0&&i.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${e.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:e.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const c=u=>u==="error"?2:1;return i.sort((u,a)=>{const h=c(a.severity)-c(u.severity);if(h!==0)return h;const k=a.count-u.count;return k!==0?k:u.title.localeCompare(a.title)}),i.slice(0,5)}function Ft(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).filter(Ke))).sort(),s=e.state||{},o=(Array.isArray(s.products)?s.products:[]).map(f=>f||{}).filter(f=>H(f.sku)).filter(at),n=o.length,l=Array.isArray(s.fixcosts)&&s.fixcosts.length>0,i=Ct(s),c=At(s,o),u=new Set(c.missingPrice.map(f=>O(f.sku))),a=Be(),h=kt(s),k=t.filter(f=>f<a),m=t.filter(f=>f>=a),p={perSkuMonth:new Map},P=k.length?Te({state:s,months:k,products:o,snapshot:null,snapshotMonth:k[0]||void 0,projectionMode:h}):p,v=m.length?Te({state:s,months:m,products:o,snapshot:null,snapshotMonth:Ze(a,-1),projectionMode:h}):p,D=_e(s).bySku,S=Tt({state:s,products:o,months:t,projection:v,projectionMode:h,nowMonth:a}),b=new Map,M=t.map(f=>{const ne=new Set,ye=new Set,pe=new Set,ie=new Set,ae=new Set,ce=new Set,ue=new Set;let q=0;const G=[],K=[];o.forEach(y=>{const g=H(y.sku);if(!g)return;const d=O(g),N=String(y.alias||g),x=Ve(D,g),Q=ht(s,y),Me=mt({month:f,months:t,lookaheadDays:Q,cache:b});let ee=null,C,Ce="",te=null;Me.forEach(w=>{if(ee)return;const T=gt({month:w,nowMonth:a,pastProjection:P,futureProjection:v,sku:g,skuKey:d}),$=Number(T==null?void 0:T.doh);Number.isFinite($)&&(te=te==null?$:Math.min(te,$));const Re=vt(T);(!(T!=null&&T.hasForecast)||Re)&&(ee=w,C=T,Ce=Re)});const Pe=ee==null;if(!Pe){const w=bt(C,Ce),T=Number.isFinite(Number(C==null?void 0:C.doh))?Number(C==null?void 0:C.doh):null,$=Number.isFinite(Number(C==null?void 0:C.safetyDays))?Number(C==null?void 0:C.safetyDays):null;G.push({sku:g,alias:N,abcClass:x,issueType:w,issueLabel:Dt(w),value:T,safetyValue:$,projectionMode:"doh",safetyThresholdDoh:$,minDohInWindow:te,firstBreachMonth:ee,lookaheadDays:Q,lookaheadMonths:Me}),ie.add(d),Fe(x)?ae.add(d):ce.add(d),w==="forecast_missing"?ne.add(g):ye.add(g)}const A=S.get(d)||null,Ae=!!(A&&A.orderMonth<=f);A&&Ae&&(K.push({sku:g,alias:N,abcClass:x,firstRiskMonth:A.firstRiskMonth,latestOrderDate:A.latestOrderDate,orderMonth:A.orderMonth,leadTimeDays:A.leadTimeDays,overdue:A.overdue,requiredArrivalDate:A.requiredArrivalDate,recommendedOrderDate:A.recommendedOrderDate,shortageUnits:A.shortageUnits,reason:"Keine FO/PO vorhanden, die die Lücke schließt."}),pe.add(g),ie.add(d),Fe(x)?ae.add(d):ce.add(d),A.overdue&&ue.add(d)),Pe&&!Ae&&(q+=1)});const le=n?q/n:0,Y=ie.size,X=ae.size,ve=ce.size,qe=K.length>0,Ge=ue.size>0,Z=St({coverageRatio:le,blockerCount:Y,blockerAbCount:X,hasOrderDutyBlocker:qe,hasOverdueOrderDutyBlocker:Ge}),de=it[Z],fe=Z==="full"||Z==="wide",L=Mt(s,f),z=l,V=Pt(i,f),W=c.missingPrice.length===0&&c.blockedCompleteness.length===0,J=[],R=y=>{J.push({id:`${y.checkKey}:${y.month}:${J.length}`,...y})};if(!fe){n===0&&R({month:f,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"});const y=Oe(G);y.slice(0,20).forEach(d=>{const N=d.issueType==="forecast_missing"?"/v2/forecast":"/v2/inventory/projektion",x=d.issueType==="forecast_missing"?"Forecast fehlt":d.issueType==="stock_oos"?"Out-of-Stock":"unter Safety",Q=d.firstBreachMonth?` (erster Verstoß ${d.firstBreachMonth})`:"";R({month:f,checkKey:"sku_coverage",severity:"error",message:`${d.sku} (${d.alias}): ${x}${Q} (${d.abcClass}).`,sku:d.sku,alias:d.alias,abcClass:d.abcClass,issueType:d.issueType,firstRiskMonth:d.firstBreachMonth||void 0,route:N})}),y.length>20&&R({month:f,checkKey:"sku_coverage",severity:"error",message:`+ ${y.length-20} weitere SKU(s) mit Bestandsproblemen.`,route:"/v2/inventory/projektion"});const g=Ne(K);g.slice(0,20).forEach(d=>{const N=d.overdue?"überfällig":"fällig";R({month:f,checkKey:"sku_coverage",severity:"error",message:`${d.sku} (${d.alias}): Bestellpflicht ${N} bis ${d.latestOrderDate} (Risikomonat ${d.firstRiskMonth}).`,sku:d.sku,alias:d.alias,abcClass:d.abcClass,issueType:"order_duty",firstRiskMonth:d.firstRiskMonth,latestOrderDate:d.latestOrderDate,orderMonth:d.orderMonth,leadTimeDays:d.leadTimeDays,overdue:d.overdue,requiredArrivalDate:d.requiredArrivalDate,recommendedOrderDate:d.recommendedOrderDate,suggestedUnits:d.shortageUnits,route:"/v2/orders/fo"})}),g.length>20&&R({month:f,checkKey:"sku_coverage",severity:"error",message:`+ ${g.length-20} weitere SKU(s) mit Bestellpflicht.`,route:"/v2/orders/fo"})}L||R({month:f,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),z||R({month:f,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),V||R({month:f,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),W||(c.missingPrice.slice(0,20).forEach(g=>{R({month:f,checkKey:"revenue_inputs",severity:"error",message:`${g.sku} (${g.alias}): Ø VK-Preis fehlt.`,sku:g.sku,alias:g.alias,abcClass:g.abcClass,route:"/v2/products"})}),c.blockedCompleteness.filter(g=>!u.has(O(g.sku))).slice(0,20).forEach(g=>{R({month:f,checkKey:"revenue_inputs",severity:"error",message:`${g.sku} (${g.alias}): Stammdaten unvollständig.`,sku:g.sku,alias:g.alias,abcClass:g.abcClass,route:"/v2/products"})}));const be=[{key:"sku_coverage",label:"Bestands- & Bestellpflicht-Coverage",status:fe?"ok":"error",passed:fe,detail:`${de.label}: ${yt(le)} (${q}/${n}) · Blocker ${Y} (A/B ${X}, C ${ve}) · Bestand (Lookahead) ${G.length} · Bestellpflicht ${K.length}`,blockerCount:Y+(n===0?1:0),route:ne.size>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:L?"ok":"error",passed:L,detail:L?"vorhanden":"fehlend",blockerCount:L?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:z?"ok":"error",passed:z,detail:z?"vorhanden":"fehlend",blockerCount:z?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:V?"ok":"error",passed:V,detail:i.active?V?"vorhanden":"fehlend":"nicht aktiv",blockerCount:V?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:W?"ok":"error",passed:W,detail:W?"vollständig":`${c.missingPrice.length} ohne Preis · ${c.blockedCompleteness.length} unvollständig`,blockerCount:W?0:c.missingPrice.length+c.blockedCompleteness.length,route:"/v2/products"}],Ye=be.every(y=>y.passed),De=Oe(G),Se=Ne(K);return{month:f,robust:Ye,checks:be,blockers:J,blockerCount:J.length,coverage:{statusKey:Z,statusLabel:de.label,statusDetail:de.detail,projectionMode:h,activeSkus:n,coveredSkus:q,ratio:le,blockerCount:Y,blockerAbCount:X,blockerCCount:ve,stockIssueCount:De.length,orderDutyIssueCount:Se.length,overdueOrderDutySkuCount:ue.size,missingForecastSkus:Array.from(ne).sort((y,g)=>y.localeCompare(g,"de-DE")),safetyRiskSkus:Array.from(ye).sort((y,g)=>y.localeCompare(g,"de-DE")),orderDutyRiskSkus:Array.from(pe).sort((y,g)=>y.localeCompare(g,"de-DE")),stockIssues:De,orderDutyIssues:Se,abRiskSkuCount:X}}}),j=new Map;M.forEach(f=>j.set(f.month,f));const We=M.filter(f=>f.robust).length;let ke=null;for(let f=0;f<M.length&&M[f].robust;f+=1)ke=M[f].month;const He=new Set([...c.missingPrice.map(f=>O(f.sku)),...c.blockedCompleteness.map(f=>O(f.sku))]).size;return{months:M,monthMap:j,actions:Ut({months:M,hasFixcostBasis:l,vatActive:i.active,revenueIssueSkus:He}),robustUntilMonth:ke,robustMonthsCount:We,totalMonths:M.length,activeSkuCount:n}}const It="robustness_order_duty_v2";function oe(e){return String(e||"").trim()}function me(e){return oe(e).toLowerCase()}function he(e){const t=String(e||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const s=new Date(`${t}T00:00:00Z`);return Number.isNaN(s.getTime())?null:t}function Ot(e){const t=re(e);return t?`${t}-01`:null}function B(e,t=0){const s=$e(e);return Number.isFinite(s)?Number(s):t}function U(e){const t=B(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function I(e){const t=B(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:t}function Nt(e){return Number.isFinite(e)?Math.round(e*100)/100:0}function xt(e){if(!we(e.includeInForecast,!0))return!1;if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function _(e,t="PH"){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"")||t}function wt(e){const t=_(e.sku,"SKU").slice(0,14),s=_(e.orderMonth,"OM"),r=_(e.firstRiskMonth,"RM");return`phantom-fo-${t}-${s}-${r}`}function $t(e){const t=_(e.orderMonth,"000000").slice(0,6),s=_(e.sku,"SKU").slice(0,6),r=_(e.firstRiskMonth,"000000").slice(0,6);return`PH-${t}-${s}-${r}`}function Et(e){const t=new Map;return e.forEach(s=>{const r=oe(s.sku);if(!r)return;const o=me(r);t.has(o)||t.set(o,s)}),t}function Bt(e,t){const s=Ft({state:e,months:t}),r=new Map;return s.months.forEach(o=>{Et(o.coverage.orderDutyIssues).forEach((l,i)=>{r.has(i)||r.set(i,l)})}),Array.from(r.values())}function ge(e){const t=e!=null&&e.template&&typeof e.template=="object"?e.template:{};return(t.fields&&typeof t.fields=="object"?t.fields:t)||{}}function _t(e){const t=ge(e);return I(t.unitPriceUsd)??I(e==null?void 0:e.unitPriceUsd)??I(e==null?void 0:e.unitPrice)??0}function jt(e){const t=ge(e);return I(e==null?void 0:e.logisticsPerUnitEur)??I(e==null?void 0:e.freightPerUnitEur)??I(t.logisticsPerUnitEur)??I(t.freightEur)??0}function Kt(e){const t=e.product||{},s=e.settings||{},r=ge(t),o=Ee({state:e.state,product:t||void 0,sku:String(t.sku||""),supplierId:e.supplierId||String(t.supplierId||""),orderContext:"fo"}),n=o.fields&&typeof o.fields=="object"?o.fields:{},l=v=>{const D=n[v];return!D||typeof D!="object"?null:D.value??null},i=String(l("transportMode")||r.transportMode||t.transportMode||"SEA").trim().toUpperCase(),c=i==="AIR"||i==="SEA"||i==="RAIL"?i:"SEA",u=l("ddp")===!0||String(t.incoterm||"").toUpperCase()==="DDP",a=u||c==="AIR",h=U(l("productionLeadTimeDays"))??U(t.productionLeadTimeDaysDefault)??U(r.productionDays)??U(s.defaultProductionLeadTimeDays)??(a?14:45),k=U(l("transitDays"))??U(r.transitDays)??U(t.transitDays)??(a?21:45),m=B(l("dutyRatePct"),B(s.dutyRatePct,0)),p=B(l("eustRatePct"),B(s.eustRatePct,0)),P=String(l("incoterm")||t.incoterm||(u?"DDP":"EXW")).trim().toUpperCase()||"EXW";return{productionDays:h,transitDays:k,totalDays:Math.max(1,h+k),transportMode:c,incoterm:P,dutyRatePct:Math.max(0,m),eustRatePct:Math.max(0,p)}}function Lt(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).map(s=>String(s||"").trim()))).filter(s=>/^\d{4}-\d{2}$/.test(s)).sort((s,r)=>s.localeCompare(r));return t.length?t:qt(e.state)}function zt(e){return rt([],e||void 0)}function xe(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function Vt(e,t){const s=Number(t.overdue)-Number(e.overdue);if(s!==0)return s;const r=i=>i==="A"?0:i==="B"?1:2,o=r(e.abcClass)-r(t.abcClass);if(o!==0)return o;const n=e.orderMonth.localeCompare(t.orderMonth);if(n!==0)return n;const l=e.firstRiskMonth.localeCompare(t.firstRiskMonth);return l!==0?l:e.sku.localeCompare(t.sku,"de-DE")}function Wt(e,t){if(!e.length)return null;const s=re(t);if(!s)return e[e.length-1];let r=null;return e.forEach(o=>{o<=s&&(r=o)}),r||e[0]}function Ht(e){const t=e.issue,s=oe(t.sku);if(!s)return null;const r=me(s),o=e.productBySkuKey.get(r)||null,n=String((o==null?void 0:o.supplierId)||"").trim(),l=e.supplierById.get(n)||null,i=Kt({state:e.state,product:o,supplierId:n,settings:e.settings}),c=he(t.requiredArrivalDate)||Ot(t.firstRiskMonth);if(!c)return null;const u=et({context:e.recommendationContext,sku:s,leadTimeDays:i.totalDays,product:o,settings:e.settings,horizonMonths:Math.max(6,Math.round(Number(e.horizonMonths)||6)),requiredArrivalMonth:t.firstRiskMonth}),a=xe(u==null?void 0:u.recommendedUnits),h=xe(t.shortageUnits),k=Math.max(a||0,h||0);if(!(k>0))return null;const m=tt({targetDeliveryDate:c,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0}),p=_t(o),P=jt(o),v=Nt(P*k),D=I(e.settings.fxRate)??0,S=st({supplierTerms:zt(l),schedule:m,unitPrice:p,units:k,currency:"USD",freight:v,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:D,incoterm:i.incoterm,vatRefundLagMonths:e.settings.vatRefundLagMonths,paymentDueDefaults:e.settings.paymentDueDefaults,existingPayments:[]}),b=wt(t),M=$t(t);return{id:b,sku:s,alias:String(t.alias||(o==null?void 0:o.alias)||s),abcClass:t.abcClass,supplierId:n,orderMonth:String(t.orderMonth||"").trim(),firstRiskMonth:String(t.firstRiskMonth||"").trim(),latestOrderDate:he(t.latestOrderDate)||m.orderDate||"",requiredArrivalDate:c,recommendedOrderDate:he(t.recommendedOrderDate)||m.orderDate||"",leadTimeDays:i.totalDays,overdue:t.overdue===!0,suggestedUnits:k,shortageUnits:h??null,recommendationStatus:u?String(u.status||""):null,recommendationUnits:a??null,foRecord:{id:b,foNo:M,foNumber:M,sku:s,supplierId:n,targetDeliveryDate:c,units:k,transportMode:i.transportMode,incoterm:i.incoterm,unitPrice:p,currency:"USD",freight:v,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:D,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0,orderDate:m.orderDate||null,productionEndDate:m.productionEndDate||null,etdDate:m.etdDate||null,etaDate:m.etaDate||c,deliveryDate:m.deliveryDate||c,payments:S,status:"ACTIVE",phantom:!0,phantomSource:It,phantomStatus:"suggested",phantomGeneratedAt:new Date().toISOString(),phantomMeta:{firstRiskMonth:t.firstRiskMonth,orderMonth:t.orderMonth,latestOrderDate:t.latestOrderDate,recommendedOrderDate:t.recommendedOrderDate,leadTimeDays:i.totalDays,abcClass:t.abcClass,shortageUnits:t.shortageUnits,reason:t.reason}}}}function qt(e,t=18){const s=e.settings&&typeof e.settings=="object"?e.settings:{},r=re(s.startMonth)||Be(),o=U(s.horizonMonths)??Math.max(6,Math.round(Number(t)||18));return Je(r,o)}function rs(e){const t=e.state||{},s=Lt({state:t,months:e.months});if(!s.length)return[];const r=Wt(s,e.targetMonth);if(!r)return[];const o=(Array.isArray(t.products)?t.products:[]).map(m=>m).filter(m=>oe(m.sku)).filter(xt),n=new Map;o.forEach(m=>{n.set(me(m.sku),m)});const l=new Map;(Array.isArray(t.suppliers)?t.suppliers:[]).map(m=>m).forEach(m=>{const p=String(m.id||"").trim();p&&l.set(p,m)});const i=t.settings&&typeof t.settings=="object"?t.settings:{},c=[],u=new Set;let a=t;const h=U(e.maxSuggestions),k=Math.max(1,s.length*2);for(let m=0;m<k;m+=1){const p=Qe(a),P=Bt(a,s).filter(S=>{const b=re(S.orderMonth);return b?b<=r:!1});if(!P.length)break;const v=new Set((Array.isArray(a.fos)?a.fos:[]).map(S=>String((S==null?void 0:S.id)||"").trim()).filter(Boolean)),D=[];if(P.forEach(S=>{const b=Ht({state:a,issue:S,productBySkuKey:n,supplierById:l,settings:i,recommendationContext:p,horizonMonths:s.length});b&&(u.has(b.id)||v.has(b.id)||(u.add(b.id),D.push(b)))}),!D.length||(c.push(...D),h!=null&&c.length>=h))break;a=Gt({state:a,suggestions:D})}return c.sort(Vt),h!=null?c.slice(0,h):c}function Gt(e){const t=e.state||{},s=Array.isArray(t.fos)?t.fos:[],r=new Set(s.map(n=>String(n.id||"").trim()).filter(Boolean)),o=e.suggestions.map(n=>n.foRecord).filter(n=>{const l=String(n.id||"").trim();return l?!r.has(l):!1});return{...t,fos:[...s,...o]}}export{rs as a,Ft as b,Gt as c,qt as r};
