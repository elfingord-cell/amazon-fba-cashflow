import{t as h,k as e,J as fe,K as x,L as p,M as Z,S as f,O as v,a3 as _,P as ge}from"./index-DrOkdIyL.js";import{e as je}from"./cashflow-LLmd6-JE.js";import{t as H}from"./orderUtils-CdSgcPrO.js";import{u as pe,C as W}from"./workspace-hSJpURcw.js";import{C as L}from"./index-CwWsayj4.js";import{S as R}from"./index-Bs0NWQOM.js";import{T as ve}from"./index-D1FgTqkK.js";import{C as ye}from"./Collapse-BrChyUuB.js";import"./planProducts-CpwZ2WgY.js";import"./foSuggestion-Ck1952gl.js";import"./Dropdown-QmF6_rIx.js";import"./useBubbleLock-BNNYgWjU.js";const{Paragraph:be,Text:y,Title:G}=fe,Ce=["Lizenz","Steuerberatung","Versicherung","Miete","Tools","Sonstiges"],Se=[{value:"monthly",label:"monatlich"},{value:"quarterly",label:"vierteljaehrlich"},{value:"semiannual",label:"halbjaehrlich"},{value:"annual",label:"jaehrlich"},{value:"custom",label:"benutzerdefiniert"}],Me=[{value:"1",label:"1."},{value:"15",label:"15."},{value:"LAST",label:"Letzter Tag"}],ke=[{value:"daily",label:"tagesgenau"},{value:"none",label:"keine Proration"}];function J(s){if(s==null)return 0;const o=String(s).trim().replace(/€/g,"").replace(/\s+/g,"").replace(/\./g,"").replace(",","."),l=Number(o);return Number.isFinite(l)?l:0}function P(s){return J(s).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function B(s){const o=Number(s);return Number.isFinite(o)?o.toLocaleString("de-DE",{style:"currency",currency:"EUR"}):"—"}function De(s){if(!s)return"—";const[o,l,i]=String(s).split("-").map(Number);if(!o||!l||!i)return"—";const m=new Date(Date.UTC(o,l-1,i));return Number.isNaN(m.getTime())?"—":m.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ne(s){if(!/^\d{4}-\d{2}$/.test(String(s||"")))return s;const[o,l]=s.split("-").map(Number),i=new Date(Date.UTC(o,l-1,1));return new Intl.DateTimeFormat("de-DE",{month:"long",year:"numeric"}).format(i)}function b(s){const o=String(s||"").trim();return/^\d{4}-\d{2}$/.test(o)?o:""}function w(s){const o=String(s||"").trim();if(!o)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(o))return o;const l=o.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);if(!l)return"";const i=String(Number(l[1])).padStart(2,"0"),m=String(Number(l[2])).padStart(2,"0");return`${l[3]}-${m}-${i}`}function ee(s,o){return(Array.isArray(s)?s:[]).map(l=>{const i=l||{};return{id:String(i.id||H("fix")),name:String(i.name||"Neue Fixkosten"),category:String(i.category||"Sonstiges"),amount:P(i.amount||0),frequency:String(i.frequency||"monthly"),intervalMonths:Math.max(1,Number(i.intervalMonths||1)),anchor:String(i.anchor||"LAST"),startMonth:b(i.startMonth)||o,endMonth:b(i.endMonth),proration:{enabled:i!=null&&i.proration&&typeof i.proration=="object"?i.proration.enabled===!0:!1,method:i!=null&&i.proration&&typeof i.proration=="object"?String(i.proration.method||"none"):"none"},autoPaid:i.autoPaid===!0,notes:String(i.notes||"")}})}function te(s){const o=[];return s.name.trim()||o.push("name"),J(s.amount)>0||o.push("amount"),s.startMonth&&s.endMonth&&s.startMonth>s.endMonth&&o.push("range"),s.anchor&&s.anchor!=="LAST"&&!/^\d+$/.test(String(s.anchor))&&o.push("anchor"),o}function ne(s){return!s||typeof s!="object"?{}:Object.entries(s).reduce((o,[l,i])=>(!i||typeof i!="object"||(o[l]={...i}),o),{})}function q(s){return!s||typeof s!="object"?{}:Object.entries(s).reduce((o,[l,i])=>(!i||typeof i!="object"||(o[l]=Object.entries(i).reduce((m,[$,g])=>(!g||typeof g!="object"||(m[$]={...g}),m),{})),o),{})}function $e(){const{state:s,loading:o,saving:l,error:i,lastSavedAt:m,saveWith:$}=pe(),[g,C]=h.useState([]),[U,D]=h.useState({}),[z,I]=h.useState({}),[S,Y]=h.useState(!1),[V,u]=h.useState(!1),[d,M]=h.useState(null),[Q,E]=h.useState([]),N=s,re=s.settings||{},O=b(re.startMonth)||new Date().toISOString().slice(0,7);h.useEffect(()=>{C(ee(Array.isArray(s.fixcosts)?s.fixcosts:[],O)),D(q(s.fixcostOverrides));const t=s.status&&typeof s.status=="object"?s.status:{};Y(t.autoManualCheck===!0),I(ne(t.events)),u(!1)},[O,s.fixcostOverrides,s.fixcosts,s.status]);const X=h.useMemo(()=>{const t={...N,fixcosts:g.map(n=>({id:n.id,name:n.name,category:n.category,amount:n.amount,frequency:n.frequency,intervalMonths:n.intervalMonths,anchor:n.anchor,startMonth:n.startMonth,endMonth:n.endMonth||"",proration:{...n.proration},autoPaid:n.autoPaid,notes:n.notes})),fixcostOverrides:U,status:{...N.status&&typeof N.status=="object"?N.status:{},autoManualCheck:S,events:z}};return je(t,{statusEvents:z,autoManualCheck:S,today:new Date})},[S,z,U,g,N]),k=h.useMemo(()=>{const t=new Map;return X.forEach(n=>{var r;t.has(n.month)||t.set(n.month,[]),(r=t.get(n.month))==null||r.push(n)}),Array.from(t.entries()).sort((n,r)=>n[0].localeCompare(r[0])).map(([n,r])=>{const a=r.reduce((A,F)=>A+Number(F.amount||0),0),j=r.reduce((A,F)=>A+(F.paid?Number(F.amount||0):0),0);return{month:n,items:r,total:a,paid:j,open:Math.max(0,a-j)}})},[X]);h.useEffect(()=>{E(t=>t.filter(n=>k.some(r=>r.month===n)))},[k]);const T=h.useMemo(()=>g.some(t=>te(t).length>0),[g]),ae=T?"Validierungsfehler":V?"Ungespeicherte Aenderungen":"Synchron",se=T?"red":V?"gold":"green";async function ie(){T||(await $(t=>{const n=ge(t);n.fixcosts=g.map(a=>({id:a.id,name:a.name.trim()||"Fixkosten",category:a.category,amount:P(a.amount),frequency:a.frequency,intervalMonths:Math.max(1,Number(a.intervalMonths||1)),anchor:a.anchor||"LAST",startMonth:b(a.startMonth)||O,endMonth:b(a.endMonth),proration:{enabled:a.proration.enabled===!0,method:a.proration.enabled?a.proration.method:"none"},autoPaid:a.autoPaid===!0,notes:a.notes})),n.fixcostOverrides=U,(!n.status||typeof n.status!="object")&&(n.status={autoManualCheck:!1,events:{}});const r=n.status;return r.autoManualCheck=S,r.events=z,n.status=r,n},"v2:fixcosts:save"),u(!1))}function c(t,n){C(r=>r.map(a=>a.id===t?n(a):a)),u(!0)}function oe(t){C(n=>{const r=n.findIndex(A=>A.id===t);if(r<0)return n;const a=n[r],j={...a,id:H("fix"),name:`${a.name||"Fixkosten"} (Kopie)`};return[...n.slice(0,r+1),j,...n.slice(r+1)]}),u(!0)}function le(t){C(n=>n.filter(r=>r.id!==t)),D(n=>{const r={...n};return r[t]&&delete r[t],r}),u(!0)}function de(){C(t=>[...t,{id:H("fix"),name:"Neue Fixkosten",category:"Sonstiges",amount:"1.000,00",frequency:"monthly",intervalMonths:1,anchor:"LAST",startMonth:O,endMonth:"",proration:{enabled:!1,method:"none"},autoPaid:!1,notes:""}]),u(!0)}function K(t,n){t.length&&(I(r=>{const a={...r};return t.forEach(j=>{a[j]||(a[j]={}),a[j]={...a[j]||{},manual:n}}),a}),u(!0))}function ce(t){I(n=>{const r={...n};if(!r[t])return n;const a={...r[t]};return delete a.manual,Object.keys(a).length?r[t]=a:delete r[t],r}),u(!0)}function ue(t,n){const r=t.dueDateIso?new Date(`${t.dueDateIso}T00:00:00Z`).getTime()<=Date.now():!1,a=t.autoPaid===!0&&!S;if(a&&n===(a&&r)){ce(t.id);return}K([t.id],n)}function he(t){var n,r,a;M({instanceId:t.id,fixedCostId:t.fixedCostId,month:t.month,amount:(n=t.override)!=null&&n.amount&&String(t.override.amount).trim()?String(t.override.amount):P(t.amount),dueDate:w(((r=t.override)==null?void 0:r.dueDate)||t.dueDateIso||""),note:String(((a=t.override)==null?void 0:a.note)||"")})}function me(t){D(n=>{var a;const r=q(n);return(a=r[t.fixedCostId])!=null&&a[t.month]?(delete r[t.fixedCostId][t.month],Object.keys(r[t.fixedCostId]).length||delete r[t.fixedCostId],r):n}),u(!0)}function xe(){if(!d)return;const t=J(d.amount);if(!(t>0)){_.error({title:"Override ungueltig",content:"Bitte Betrag > 0 eingeben."});return}const n=d.dueDate?w(d.dueDate):"";if(d.dueDate&&!n){_.error({title:"Override ungueltig",content:"Bitte ein gueltiges Datum eingeben."});return}D(r=>{const a=q(r);return a[d.fixedCostId]||(a[d.fixedCostId]={}),a[d.fixedCostId][d.month]={amount:P(t),dueDate:n||"",note:d.note.trim()},a}),u(!0),M(null)}return e.jsxs("div",{className:"v2-page",children:[e.jsxs(W,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(G,{level:3,children:"Fixkosten"}),e.jsx(be,{children:"Stammdaten, monatliche Instanzen, Overrides und Paid-Logik für den Monatsabschluss."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(x,{type:"primary",onClick:()=>{ie()},disabled:!V||T,loading:l,children:"Fixkosten speichern"}),e.jsx(x,{onClick:()=>{C(ee(Array.isArray(s.fixcosts)?s.fixcosts:[],O)),D(q(s.fixcostOverrides));const t=s.status&&typeof s.status=="object"?s.status:{};Y(t.autoManualCheck===!0),I(ne(t.events)),u(!1)},children:"Verwerfen"}),e.jsx(p,{color:se,children:ae}),m?e.jsxs(p,{color:"green",children:["Gespeichert: ",new Date(m).toLocaleTimeString("de-DE")]}):null]})})]}),i?e.jsx(Z,{type:"error",showIcon:!0,message:i}):null,o?e.jsx(Z,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(W,{children:[e.jsxs(f,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsxs(f,{children:[e.jsx(G,{level:5,style:{margin:0},children:"Fixkosten Stammdaten"}),e.jsx(L,{checked:S,onChange:t=>{Y(t.target.checked),u(!0)},children:"Manuelle Pruefung fuer Auto-Paid"})]}),e.jsx(x,{onClick:de,children:"Position hinzufuegen"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table v2-fixcost-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Kategorie"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Frequenz"}),e.jsx("th",{children:"Anker"}),e.jsx("th",{children:"Start"}),e.jsx("th",{children:"Ende"}),e.jsx("th",{children:"Proration"}),e.jsx("th",{children:"Auto Paid"}),e.jsx("th",{children:"Notiz"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:g.map(t=>{const n=te(t);return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(v,{status:n.includes("name")?"error":"",value:t.name,onChange:r=>c(t.id,a=>({...a,name:r.target.value}))})}),e.jsx("td",{children:e.jsx(R,{value:t.category,options:Ce.map(r=>({value:r,label:r})),onChange:r=>c(t.id,a=>({...a,category:r})),style:{width:"100%"}})}),e.jsx("td",{children:e.jsx(v,{status:n.includes("amount")?"error":"",value:t.amount,onChange:r=>c(t.id,a=>({...a,amount:r.target.value})),onBlur:()=>c(t.id,r=>({...r,amount:P(r.amount)}))})}),e.jsx("td",{children:e.jsxs(f,{direction:"vertical",size:4,children:[e.jsx(R,{value:t.frequency,options:Se,onChange:r=>c(t.id,a=>({...a,frequency:r})),style:{width:"100%"}}),t.frequency==="custom"?e.jsx(ve,{value:t.intervalMonths,min:1,onChange:r=>c(t.id,a=>({...a,intervalMonths:Math.max(1,Number(r||1))})),style:{width:"100%"}}):null]})}),e.jsx("td",{children:e.jsx(R,{value:t.anchor,options:Me,onChange:r=>c(t.id,a=>({...a,anchor:r})),status:n.includes("anchor")?"error":"",style:{width:"100%"}})}),e.jsx("td",{children:e.jsx(v,{type:"month",value:t.startMonth,onChange:r=>c(t.id,a=>({...a,startMonth:b(r.target.value)}))})}),e.jsx("td",{children:e.jsx(v,{type:"month",value:t.endMonth,status:n.includes("range")?"error":"",onChange:r=>c(t.id,a=>({...a,endMonth:b(r.target.value)}))})}),e.jsx("td",{children:e.jsxs(f,{direction:"vertical",size:4,children:[e.jsx(L,{checked:t.proration.enabled,onChange:r=>c(t.id,a=>({...a,proration:{enabled:r.target.checked,method:r.target.checked?a.proration.method:"none"}})),children:"anteilig"}),t.proration.enabled?e.jsx(R,{value:t.proration.method,options:ke,onChange:r=>c(t.id,a=>({...a,proration:{...a.proration,method:r}})),style:{width:"100%"}}):null]})}),e.jsx("td",{children:e.jsx(L,{checked:t.autoPaid,onChange:r=>c(t.id,a=>({...a,autoPaid:r.target.checked}))})}),e.jsx("td",{children:e.jsx(v,{value:t.notes,onChange:r=>c(t.id,a=>({...a,notes:r.target.value}))})}),e.jsx("td",{children:e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(x,{size:"small",onClick:()=>oe(t.id),children:"Duplizieren"}),e.jsx(x,{size:"small",danger:!0,onClick:()=>le(t.id),children:"X"})]})})]},t.id)})})]})})]}),e.jsxs(W,{children:[e.jsxs(f,{style:{width:"100%",justifyContent:"space-between",marginBottom:8},wrap:!0,children:[e.jsx(G,{level:5,style:{margin:0},children:"Fixkosten je Monat"}),e.jsxs("div",{className:"v2-actions-inline",children:[e.jsx(x,{size:"small",onClick:()=>E(k.map(t=>t.month)),disabled:!k.length,children:"Alles auf"}),e.jsx(x,{size:"small",onClick:()=>E([]),disabled:!Q.length,children:"Alles zu"})]})]}),k.length?e.jsx(ye,{activeKey:Q,onChange:t=>E((Array.isArray(t)?t:[t]).map(String)),items:k.map(t=>({key:t.month,label:e.jsxs(f,{children:[e.jsx(y,{strong:!0,children:Ne(t.month)}),e.jsxs(p,{color:"default",children:["Total: ",B(t.total)]}),e.jsxs(p,{color:"green",children:["Bezahlt: ",B(t.paid)]}),e.jsxs(p,{color:"orange",children:["Offen: ",B(t.open)]})]}),children:e.jsxs(f,{direction:"vertical",style:{width:"100%"},children:[e.jsxs(f,{children:[e.jsx(x,{size:"small",onClick:()=>{const n=t.items.filter(r=>!r.paid).map(r=>r.id);K(n,!0)},children:"Alle offenen bestaetigen"}),e.jsx(x,{size:"small",onClick:()=>{const n=t.items.filter(r=>r.autoPaid).map(r=>r.id);K(n,!1)},children:"Auto-Markierung ignorieren"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Kategorie"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Faelligkeit"}),e.jsx("th",{children:"Bezahlt"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:t.items.map(n=>{var r;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs(f,{direction:"vertical",size:0,children:[e.jsxs(f,{children:[e.jsx(y,{children:n.label}),n.autoPaid?e.jsx(p,{color:"cyan",children:"Auto"}):null,n.overrideActive?e.jsx(p,{color:"purple",children:"Override"}):null,n.autoSuppressed?e.jsx(p,{color:"gold",children:"Manuelle Pruefung"}):null]}),(r=n.override)!=null&&r.note?e.jsx(y,{type:"secondary",children:String(n.override.note)}):null]})}),e.jsx("td",{children:n.category||"Sonstiges"}),e.jsx("td",{children:B(n.amount)}),e.jsx("td",{children:De(n.dueDateIso)}),e.jsx("td",{children:e.jsx(L,{checked:n.paid,onChange:a=>ue(n,a.target.checked)})}),e.jsx("td",{children:e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(x,{size:"small",onClick:()=>he(n),children:"Override"}),n.overrideActive?e.jsx(x,{size:"small",onClick:()=>me(n),children:"Reset"}):null]})})]},n.id)})})]})})]})}))}):e.jsx(y,{type:"secondary",children:"Keine Instanzen im Planungshorizont."})]}),e.jsx(_,{title:"Override bearbeiten",open:!!d,onCancel:()=>M(null),onOk:xe,children:d?e.jsxs(f,{direction:"vertical",style:{width:"100%"},children:[e.jsx(y,{children:"Betrag (EUR)"}),e.jsx(v,{value:d.amount,onChange:t=>M(n=>n&&{...n,amount:t.target.value})}),e.jsx(y,{children:"Faelligkeit (YYYY-MM-DD)"}),e.jsx(v,{type:"date",value:d.dueDate,onChange:t=>M(n=>n&&{...n,dueDate:t.target.value})}),e.jsx(y,{children:"Notiz"}),e.jsx(v,{value:d.note,onChange:t=>M(n=>n&&{...n,note:t.target.value})})]}):null})]})}export{$e as default};
