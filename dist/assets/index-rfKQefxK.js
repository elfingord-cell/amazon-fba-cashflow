import{t as c,k as e,J as W,N as f,M as g,I as F,S as C,a8 as G,W as Z}from"./index-BAXFY6Sx.js";import{c as J}from"./vatPreview-BWbxw0N-.js";import{u as q,C as E}from"./workspace-U3XTpCZs.js";import{T as M}from"./index-LhnJNxo3.js";import{F as x}from"./Table-Duo5ddtA.js";import"./cashflow-IGITWurX.js";import"./planProducts-CGSHsSOQ.js";import"./cashInRules-r9rlv23d.js";import"./Dropdown-BBd0NFNE.js";import"./DownOutlined-BlEEEBb_.js";import"./index-JSAUgCOY.js";import"./index-CMZUhGsA.js";import"./useBubbleLock-BgZAw-8N.js";import"./index-DJcsQHAB.js";import"./Pagination-CQKn-8_x.js";const{Paragraph:H,Text:j,Title:U}=W,K={deBrutto:"DE-Brutto",outputUst:"Output-USt",vstFees:"VSt Fees",fixkostenVst:"Fixkosten-VSt",eustErstattung:"EUSt-Erstattung",zahllast:"Zahllast"};function h(r,n=0){const y=Number(r);return Number.isFinite(y)?y:n}function i(r){const n=Number(r);return Number.isFinite(n)?n.toLocaleString("de-DE",{style:"currency",currency:"EUR"}):"—"}function A(r){return`${(r*100).toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2})} %`}function B(r){const n=r!=null&&r.settings&&typeof r.settings=="object"?r.settings.vatPreview:void 0;return{eustLagMonths:Math.max(0,h(n==null?void 0:n.eustLagMonths,2)),deShareDefault:Math.min(1,Math.max(0,h(n==null?void 0:n.deShareDefault,.8))),feeRateDefault:Math.min(1,Math.max(0,h(n==null?void 0:n.feeRateDefault,.38))),fixInputDefault:Math.max(0,h(n==null?void 0:n.fixInputDefault,0))}}function Q(r){return!r||typeof r!="object"?{}:Object.entries(r).reduce((n,[y,V])=>{if(!/^\d{4}-\d{2}$/.test(y)||!V||typeof V!="object")return n;const p=V;return n[y]={deShare:p.deShare==null?void 0:Math.min(1,Math.max(0,h(p.deShare,0))),feeRateOfGross:p.feeRateOfGross==null?void 0:Math.min(1,Math.max(0,h(p.feeRateOfGross,0))),fixInputVat:p.fixInputVat==null?void 0:Math.max(0,h(p.fixInputVat,0))},n},{})}function ce(){const{state:r,loading:n,saving:y,error:V,lastSavedAt:p,saveWith:_}=q(),[s,I]=c.useState(()=>B(r)),[m,O]=c.useState({}),[L,S]=c.useState(!1),[u,D]=c.useState(null),[o,b]=c.useState(null),k=r;c.useEffect(()=>{I(B(k)),O(Q(k.vatPreviewMonths)),S(!1)},[r.settings,r.vatPreviewMonths]);const l=c.useMemo(()=>{const a=structuredClone(k);return(!a.settings||typeof a.settings!="object")&&(a.settings={}),a.settings.vatPreview={eustLagMonths:s.eustLagMonths,deShareDefault:s.deShareDefault,feeRateDefault:s.feeRateDefault,fixInputDefault:s.fixInputDefault},a.vatPreviewMonths=m,J(a)},[m,s,k]),z=c.useMemo(()=>new Map(l.rows.map(a=>[a.month,a])),[l.rows]),T=c.useMemo(()=>l.rows.map(a=>{var t,d;return{key:a.month,month:a.month,monthLabel:a.monthLabel||a.month,grossDe:a.grossDe,outVat:a.outVat,feeInputVat:a.feeInputVat,fixInputVat:a.fixInputVat,eustRefund:a.eustRefund,payable:a.payable,deShare:((t=m[a.month])==null?void 0:t.deShare)??s.deShareDefault,feeRate:((d=m[a.month])==null?void 0:d.feeRateOfGross)??s.feeRateDefault}}),[m,l.rows,s.deShareDefault,s.feeRateDefault]);async function $(){await _(a=>{const t=Z(a),d=t.settings||{};return t.settings={...d,vatPreview:{eustLagMonths:s.eustLagMonths,deShareDefault:s.deShareDefault,feeRateDefault:s.feeRateDefault,fixInputDefault:s.fixInputDefault}},t.vatPreviewMonths=m,t},"v2:vat:save"),S(!1)}function P(a){var t,d,R;D({month:a,values:{deShare:((t=m[a])==null?void 0:t.deShare)??s.deShareDefault,feeRateOfGross:((d=m[a])==null?void 0:d.feeRateOfGross)??s.feeRateDefault,fixInputVat:((R=m[a])==null?void 0:R.fixInputVat)??s.fixInputDefault}})}function w(a){const t=l.months.indexOf(a);if(t<=0)return;const d=l.months[t-1],R=m[d]||{deShare:s.deShareDefault,feeRateOfGross:s.feeRateDefault,fixInputVat:s.fixInputDefault};D(N=>N&&N.month===a?{...N,values:{...R}}:N)}const v=c.useMemo(()=>{var d;if(!o)return null;const a=z.get(o.month);if(!a)return null;const t=(d=a.details)==null?void 0:d[o.key];return t?{row:a,detail:t}:null},[o,z]);return e.jsxs("div",{className:"v2-page",children:[e.jsxs(E,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(U,{level:3,children:"USt Vorschau"}),e.jsx(H,{children:"DE-USt-Vorschau mit Detaildrilldown und Monats-Overrides fuer DE-Anteil, Gebuehrensatz und Fixkosten-VSt."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(f,{type:"primary",onClick:()=>{$()},disabled:!L,loading:y,children:"USt-Einstellungen speichern"}),e.jsx(f,{onClick:()=>{O({}),S(!0)},children:"Monats-Overrides zuruecksetzen"}),L?e.jsx(g,{color:"gold",children:"Ungespeicherte Aenderungen"}):e.jsx(g,{color:"green",children:"Synchron"}),p?e.jsxs(g,{color:"green",children:["Gespeichert: ",new Date(p).toLocaleTimeString("de-DE")]}):null]})})]}),V?e.jsx(F,{type:"error",showIcon:!0,message:V}):null,n?e.jsx(F,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(E,{children:[e.jsx(U,{level:5,children:"Standardwerte"}),e.jsxs(C,{wrap:!0,align:"start",children:[e.jsxs("div",{children:[e.jsx(j,{children:"EUSt Lag (Monate)"}),e.jsx(M,{value:s.eustLagMonths,min:0,onChange:a=>{I(t=>({...t,eustLagMonths:Math.max(0,Number(a||0))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"DE Anteil"}),e.jsx(M,{value:s.deShareDefault,min:0,max:1,step:.01,onChange:a=>{I(t=>({...t,deShareDefault:Math.min(1,Math.max(0,Number(a||0)))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Gebuehrensatz"}),e.jsx(M,{value:s.feeRateDefault,min:0,max:1,step:.01,onChange:a=>{I(t=>({...t,feeRateDefault:Math.min(1,Math.max(0,Number(a||0)))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Fixkosten-VSt pauschal (EUR)"}),e.jsx(M,{value:s.fixInputDefault,min:0,step:10,onChange:a=>{I(t=>({...t,fixInputDefault:Math.max(0,Number(a||0))})),S(!0)}})]})]})]}),e.jsx(E,{children:e.jsxs(C,{wrap:!0,children:[e.jsxs(g,{color:"default",children:["Output-USt gesamt: ",i(l.totals.outVat)]}),e.jsxs(g,{color:"blue",children:["VSt Fees gesamt: ",i(l.totals.feeInputVat)]}),e.jsxs(g,{color:"purple",children:["Fixkosten-VSt gesamt: ",i(l.totals.fixInputVat)]}),e.jsxs(g,{color:l.totals.payable<0?"red":"green",children:["Zahllast gesamt: ",i(l.totals.payable)]})]})}),e.jsx(E,{children:e.jsx(x,{size:"small",pagination:!1,dataSource:T,columns:[{title:"Monat",dataIndex:"monthLabel",key:"monthLabel",sorter:(a,t)=>String(a.month||"").localeCompare(String(t.month||""))},{title:"DE Anteil",key:"deShare",sorter:(a,t)=>Number(a.deShare||0)-Number(t.deShare||0),render:(a,t)=>A(t.deShare)},{title:"Gebuehrensatz",key:"feeRate",sorter:(a,t)=>Number(a.feeRate||0)-Number(t.feeRate||0),render:(a,t)=>A(t.feeRate)},{title:"DE-Brutto",key:"grossDe",sorter:(a,t)=>Number(a.grossDe||0)-Number(t.grossDe||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",onClick:()=>b({month:t.month,key:"deBrutto"}),children:i(t.grossDe)})},{title:"Output-USt",key:"outVat",sorter:(a,t)=>Number(a.outVat||0)-Number(t.outVat||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",onClick:()=>b({month:t.month,key:"outputUst"}),children:i(t.outVat)})},{title:"VSt Fees",key:"feeInputVat",sorter:(a,t)=>Number(a.feeInputVat||0)-Number(t.feeInputVat||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",onClick:()=>b({month:t.month,key:"vstFees"}),children:i(t.feeInputVat)})},{title:"Fixkosten-VSt",key:"fixInputVat",sorter:(a,t)=>Number(a.fixInputVat||0)-Number(t.fixInputVat||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",onClick:()=>b({month:t.month,key:"fixkostenVst"}),children:i(t.fixInputVat)})},{title:"EUSt-Erstattung",key:"eustRefund",sorter:(a,t)=>Number(a.eustRefund||0)-Number(t.eustRefund||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",onClick:()=>b({month:t.month,key:"eustErstattung"}),children:i(t.eustRefund)})},{title:"Zahllast",key:"payable",sorter:(a,t)=>Number(a.payable||0)-Number(t.payable||0),render:(a,t)=>e.jsx(f,{size:"small",type:"text",danger:t.payable<0,onClick:()=>b({month:t.month,key:"zahllast"}),children:i(t.payable)})},{title:"Aktionen",key:"actions",render:(a,t)=>e.jsx(f,{size:"small",onClick:()=>P(t.month),children:"Monat bearbeiten"})}],summary:()=>e.jsxs(x.Summary.Row,{children:[e.jsx(x.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Summe"})}),e.jsx(x.Summary.Cell,{index:3,children:e.jsx("strong",{children:i(l.totals.grossDe)})}),e.jsx(x.Summary.Cell,{index:4,children:e.jsx("strong",{children:i(l.totals.outVat)})}),e.jsx(x.Summary.Cell,{index:5,children:e.jsx("strong",{children:i(l.totals.feeInputVat)})}),e.jsx(x.Summary.Cell,{index:6,children:e.jsx("strong",{children:i(l.totals.fixInputVat)})}),e.jsx(x.Summary.Cell,{index:7,children:e.jsx("strong",{children:i(l.totals.eustRefund)})}),e.jsx(x.Summary.Cell,{index:8,children:e.jsx("strong",{children:i(l.totals.payable)})}),e.jsx(x.Summary.Cell,{index:9})]})})}),e.jsx(G,{title:u?`Monats-Override ${u.month}`:"Monats-Override",open:!!u,onCancel:()=>D(null),onOk:()=>{u&&(O(a=>({...a,[u.month]:{deShare:Math.min(1,Math.max(0,h(u.values.deShare,s.deShareDefault))),feeRateOfGross:Math.min(1,Math.max(0,h(u.values.feeRateOfGross,s.feeRateDefault))),fixInputVat:Math.max(0,h(u.values.fixInputVat,s.fixInputDefault))}})),S(!0),D(null))},children:u?e.jsxs(C,{direction:"vertical",style:{width:"100%"},children:[e.jsx(f,{onClick:()=>w(u.month),disabled:l.months.indexOf(u.month)<=0,children:"Vormonat uebernehmen"}),e.jsx(j,{children:"DE Anteil"}),e.jsx(M,{value:u.values.deShare,min:0,max:1,step:.01,onChange:a=>D(t=>t&&{...t,values:{...t.values,deShare:h(a,t.values.deShare??s.deShareDefault)}})}),e.jsx(j,{children:"Gebuehrensatz"}),e.jsx(M,{value:u.values.feeRateOfGross,min:0,max:1,step:.01,onChange:a=>D(t=>t&&{...t,values:{...t.values,feeRateOfGross:h(a,t.values.feeRateOfGross??s.feeRateDefault)}})}),e.jsx(j,{children:"Fixkosten-VSt (EUR)"}),e.jsx(M,{value:u.values.fixInputVat,min:0,step:10,onChange:a=>D(t=>t&&{...t,values:{...t.values,fixInputVat:h(a,t.values.fixInputVat??s.fixInputDefault)}})})]}):null}),e.jsx(G,{title:o?`${K[o.key]||o.key} – ${o.month}`:"Details",open:!!o,onCancel:()=>b(null),footer:null,width:900,children:v?e.jsxs(C,{direction:"vertical",style:{width:"100%"},children:[v.detail.formula?e.jsx(j,{type:"secondary",children:v.detail.formula}):null,v.detail.notes?e.jsx(j,{type:"secondary",children:v.detail.notes}):null,e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Posten"}),e.jsx("th",{children:"Info"}),e.jsx("th",{children:"Datum"}),e.jsx("th",{children:"Betrag"})]})}),e.jsx("tbody",{children:(v.detail.items||[]).map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.label||"—"}),e.jsx("td",{children:a.sublabel||"—"}),e.jsx("td",{children:a.date||"—"}),e.jsx("td",{children:i(a.amount||0)})]},`${o==null?void 0:o.month}-${o==null?void 0:o.key}-${t}`))})]})}),e.jsxs(g,{color:"blue",children:["Summe: ",i(v.detail.total||0)]})]}):null})]})}export{ce as default};
