import{am as G,t as u,af as s,ao as Y,ap as H,k as e,a0 as h,ag as C,a3 as z,W as J,X as N,Y as A,ah as j,V as b}from"./index-Dsq1NbgA.js";import{D as Q}from"./DataTable-BVxiVDsF.js";import{u as Z,C as $}from"./workspace-DYbhLcOY.js";import{u as ee}from"./modalCollaboration-BdUVkeTK.js";import{T as O}from"./index-D5X-3Wzd.js";import{S as M}from"./index-D7DbeJV5.js";import"./Dropdown-BjfOTMXt.js";import"./DownOutlined-QrMw0MBW.js";const{Paragraph:ae,Text:te,Title:B}=J,re=["EXW","FOB","DDP","FCA"],ne=["EUR","USD","CNY"],U=["ORDER_DATE","PRODUCTION_END","ETD","ETA"];function se(){return new Date().toISOString()}function ie(i){return`${i}-${Math.random().toString(36).slice(2,9)}`}function le(){return[{label:"Deposit",percent:30,triggerEvent:"ORDER_DATE",offsetDays:0},{label:"Balance",percent:70,triggerEvent:"ETD",offsetDays:0}]}function F(i){return(Array.isArray(i)?i:[]).map(T=>{const m=T||{};return{label:String(m.label||"Milestone"),percent:Math.min(100,Math.max(0,Number(m.percent)||0)),triggerEvent:U.includes(String(m.triggerEvent||""))?String(m.triggerEvent):"ORDER_DATE",offsetDays:Number(m.offsetDays)||0}})}function oe(i){return i.length?i.map(o=>`${o.percent}% @ ${o.triggerEvent}${o.offsetDays?` ${o.offsetDays>=0?"+":""}${o.offsetDays}`:""}`).join(", "):"—"}function xe(){const{state:i,loading:o,saving:T,error:m,lastSavedAt:k,saveWith:E}=Z(),d=G(),[g,D]=u.useState(!1),[x,S]=u.useState(null),[c]=s.useForm(),R=i.settings||{},w=u.useMemo(()=>Y(R),[R]),V=u.useMemo(()=>H({userId:d.userId,userEmail:d.email},w),[w,d.email,d.userId]),W=u.useMemo(()=>`suppliers:edit:${String(x||"new")}`,[x]),t=ee({workspaceId:d.workspaceId,modalScope:W,isOpen:g,userId:d.userId,userEmail:d.email,userDisplayName:V,displayNames:w}),K=u.useMemo(()=>(Array.isArray(i.suppliers)?i.suppliers:[]).map(l=>{const r=l;return{id:String(r.id||""),name:String(r.name||""),company_name:String(r.company_name||""),productionLeadTimeDaysDefault:Number(r.productionLeadTimeDaysDefault)||0,incotermDefault:String(r.incotermDefault||"EXW"),currencyDefault:String(r.currencyDefault||"EUR"),paymentTermsDefault:F(r.paymentTermsDefault),updatedAt:r.updatedAt?String(r.updatedAt):null}}).sort((l,r)=>l.name.localeCompare(r.name)),[i.suppliers]),X=u.useMemo(()=>[{header:"Name",accessorKey:"name",meta:{width:190}},{header:"Company",accessorKey:"company_name",meta:{width:240}},{header:"Prod. Lead (Tage)",accessorKey:"productionLeadTimeDaysDefault",meta:{width:118,align:"right"}},{header:"Incoterm",accessorKey:"incotermDefault",meta:{width:96}},{header:"Currency",accessorKey:"currencyDefault",meta:{width:96}},{header:"Payment Terms",meta:{width:260},cell:({row:a})=>oe(a.original.paymentTermsDefault)},{header:"Aktualisiert",meta:{width:108},cell:({row:a})=>a.original.updatedAt?new Date(a.original.updatedAt).toLocaleDateString("de-DE"):"—"},{header:"Aktionen",meta:{width:190,minWidth:190},cell:({row:a})=>e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(h,{size:"small",onClick:()=>{S(a.original.id),c.setFieldsValue({id:a.original.id,name:a.original.name,company_name:a.original.company_name,productionLeadTimeDaysDefault:a.original.productionLeadTimeDaysDefault,incotermDefault:a.original.incotermDefault,currencyDefault:a.original.currencyDefault,paymentTermsDefault:a.original.paymentTermsDefault}),D(!0)},children:"Bearbeiten"}),e.jsx(h,{size:"small",danger:!0,onClick:()=>{C.confirm({title:`Lieferant "${a.original.name}" loeschen?`,onOk:async()=>{await E(l=>{const r=z(l);return r.suppliers=(Array.isArray(r.suppliers)?r.suppliers:[]).filter(n=>String(n.id||"")!==a.original.id),r},"v2:suppliers:delete")}})},children:"Loeschen"})]})}],[c,E]);u.useEffect(()=>{!g||!t.readOnly||!t.remoteDraftPatch||c.setFieldsValue(t.remoteDraftPatch)},[c,t.readOnly,t.remoteDraftPatch,t.remoteDraftVersion,g]);async function q(a){if(t.readOnly)throw new Error("Dieser Lieferant wird gerade von einem anderen Nutzer bearbeitet.");const l=F(a.paymentTermsDefault),r=l.reduce((p,y)=>p+y.percent,0);if(Math.round(r)!==100)throw new Error("Payment Terms muessen insgesamt 100% ergeben.");const n=a.name.trim().toLowerCase();await E(p=>{const y=z(p),f=Array.isArray(y.suppliers)?[...y.suppliers]:[];if(f.some(L=>{const _=L;return String(_.name||"").trim().toLowerCase()===n&&String(_.id||"")!==String(a.id||"")}))throw new Error("Supplier-Name muss eindeutig sein.");const P=se(),v={id:a.id||ie("sup"),name:a.name.trim(),company_name:a.company_name.trim(),productionLeadTimeDaysDefault:Math.max(0,Math.round(a.productionLeadTimeDaysDefault||0)),incotermDefault:a.incotermDefault,currencyDefault:a.currencyDefault,paymentTermsDefault:l,updatedAt:P},I=f.findIndex(L=>String(L.id||"")===v.id);return I>=0?f[I]={...f[I],...v}:f.push({...v,createdAt:P,skuOverrides:{}}),y.suppliers=f,y},x?"v2:suppliers:update":"v2:suppliers:create"),t.clearDraft(),D(!1),S(null),c.resetFields()}return e.jsxs("div",{className:"v2-page",children:[e.jsxs($,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(B,{level:3,children:"Suppliers"}),e.jsx(ae,{children:"Lieferantenverwaltung inkl. Payment Terms mit Triggern fuer PO-Events."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(h,{type:"primary",onClick:()=>{S(null),c.setFieldsValue({id:void 0,name:"",company_name:"",productionLeadTimeDaysDefault:30,incotermDefault:"EXW",currencyDefault:"EUR",paymentTermsDefault:le()}),D(!0)},children:"Lieferant hinzufuegen"}),T?e.jsx(N,{color:"processing",children:"Speichern..."}):null,k?e.jsxs(N,{color:"green",children:["Gespeichert: ",new Date(k).toLocaleTimeString("de-DE")]}):null]})})]}),m?e.jsx(A,{type:"error",showIcon:!0,message:m}):null,o?e.jsx(A,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsx($,{children:e.jsx(Q,{data:K,columns:X,minTableWidth:1320,tableLayout:"auto"})}),e.jsxs(C,{title:x?"Lieferant bearbeiten":"Lieferant hinzufuegen",open:g,onCancel:()=>{t.clearDraft(),D(!1)},onOk:()=>{if(t.readOnly){C.warning({title:"Nur Lesemodus",content:`${t.remoteUserLabel||"Kollege"} bearbeitet diesen Lieferanten. Bitte Bearbeitung übernehmen oder warten.`});return}c.validateFields().then(a=>q(a)).catch(()=>{})},width:980,children:[t.banner?e.jsx(A,{style:{marginBottom:10},type:t.banner.tone,showIcon:!0,message:t.banner.text,action:t.readOnly?e.jsx(h,{size:"small",onClick:t.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,t.readOnly&&t.remoteDraftVersion>0?e.jsxs(N,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",t.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,e.jsxs(s,{name:"v2-suppliers-modal",form:c,layout:"vertical",disabled:t.readOnly,onValuesChange:a=>{t.readOnly||t.publishDraftPatch(a)},children:[e.jsx(s.Item,{name:"id",hidden:!0,children:e.jsx(j,{})}),e.jsxs(b,{style:{width:"100%"},align:"start",children:[e.jsx(s.Item,{name:"name",label:"Name",style:{flex:1},rules:[{required:!0,message:"Name ist erforderlich."}],children:e.jsx(j,{})}),e.jsx(s.Item,{name:"company_name",label:"Company",style:{flex:1},children:e.jsx(j,{})})]}),e.jsxs(b,{style:{width:"100%"},align:"start",children:[e.jsx(s.Item,{name:"productionLeadTimeDaysDefault",label:"Production Lead Time (Tage)",style:{flex:1},children:e.jsx(O,{style:{width:"100%"},min:0})}),e.jsx(s.Item,{name:"incotermDefault",label:"Incoterm",style:{flex:1},children:e.jsx(M,{options:re.map(a=>({value:a,label:a}))})}),e.jsx(s.Item,{name:"currencyDefault",label:"Currency",style:{flex:1},children:e.jsx(M,{options:ne.map(a=>({value:a,label:a}))})})]}),e.jsx(B,{level:5,children:"Payment Terms"}),e.jsx(s.List,{name:"paymentTermsDefault",children:(a,{add:l,remove:r})=>e.jsxs(b,{direction:"vertical",style:{width:"100%"},size:8,children:[a.map(n=>e.jsxs(b,{align:"start",style:{width:"100%"},children:[e.jsx(s.Item,{...n,name:[n.name,"label"],style:{flex:2},rules:[{required:!0,message:"Label fehlt."}],children:e.jsx(j,{placeholder:"Label"})}),e.jsx(s.Item,{...n,name:[n.name,"percent"],style:{flex:1},rules:[{required:!0,message:"%"}],children:e.jsx(O,{min:0,max:100,style:{width:"100%"}})}),e.jsx(s.Item,{...n,name:[n.name,"triggerEvent"],style:{flex:1},rules:[{required:!0,message:"Trigger fehlt."}],children:e.jsx(M,{options:U.map(p=>({value:p,label:p}))})}),e.jsx(s.Item,{...n,name:[n.name,"offsetDays"],style:{flex:1},children:e.jsx(O,{style:{width:"100%"}})}),e.jsx(h,{danger:!0,onClick:()=>r(n.name),children:"X"})]},n.key)),e.jsx(h,{onClick:()=>l({label:"Milestone",percent:0,triggerEvent:"ORDER_DATE",offsetDays:0}),children:"Milestone hinzufuegen"}),e.jsx(te,{type:"secondary",children:"Summe muss 100% ergeben."})]})})]})]})]})}export{xe as default};
