import{g as _e}from"./planProducts-CtaNMQfi.js";import{bv as je,J as Et,Q as Rt,a9 as Ae,bw as xt,af as Te,bx as oe,P as w}from"./index-DTYN3TOH.js";import{d as ze,p as Ct,n as Qe,e as qe,a as We,b as He,c as St}from"./cashInRules-oX83SMz9.js";function Ye(t){return Number.isFinite(t)?t:0}function P(t){if(typeof t=="number")return t;if(!t)return 0;const e=String(t).trim().replace(/\./g,"").replace(",","."),o=Number(e);return Number.isFinite(o)?o:0}function G(t){if(t===""||t===null||t===void 0)return 0;const e=Number(String(t).replace(",","."));return Number.isFinite(e)?e:0}function vt(t,e=P){if(t==null)return null;if(typeof t=="number")return Number.isFinite(t)?t:null;const o=String(t).trim();if(!o)return null;const p=e(o);return Number.isFinite(p)?p:null}function Ze(t){return String(t||"").trim().toLowerCase()==="basis"?"basis":"conservative"}function Ve(t){const e=Math.max(0,Math.round(Number(t||0)));return e<=0?0:Math.min(5,e)}function ee(t){const e=Number(t);return Number.isFinite(e)?e.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}):"0 €"}function Re(t,e=0){const o=Number(t);return Number.isFinite(o)?o.toLocaleString("de-DE",{minimumFractionDigits:e,maximumFractionDigits:e}):"0"}function ne({forecastRevenue:t,calibrationFactorApplied:e,planRevenue:o,payoutPct:p,payoutAmount:s,quoteSource:i,recommendationSourceTag:d,mode:m,marginPct:c}){const b=m==="basis"?"Basis":"Konservativ",r=i==="manual"?"manuell":"Empfehlung",N=d==="IST"?"IST":d==="PROGNOSE"?"PROGNOSE":d==="BASELINE_Q4"?"BASELINE Q4":d==="BASELINE_NORMAL"?"BASELINE NORMAL":null,T=Number.isFinite(e)&&Math.abs(Number(e)-1)>1e-6?Number(e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):null,k=[`Forecast-Umsatz: ${ee(t)}`,`Kalibrierfaktor: ${T||"1,00"}`,`Plan-Umsatz: ${ee(o)}`,`Quote: ${Re(p)}% (${r}${N&&i!=="manual"?`, ${N}`:""}${c>0?`, ${b}`:""})`,`Auszahlung: ${ee(s)}`];return c>0&&k.push(`Sicherheitsmarge: -${Re(c)}pp`),k.join(" · ")}function Ge(t){const e=t||{},o=new Map,p=e!=null&&e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{};return Object.entries(p).forEach(([i,d])=>{if(!i)return;const m=vt(d==null?void 0:d.realRevenueEUR,P),c=vt(d==null?void 0:d.realPayoutRatePct,G),b=vt(d==null?void 0:d.realClosingBalanceEUR,P),r={};Number.isFinite(m)&&(r.revenue=m),Number.isFinite(c)&&(r.payoutRatePct=c),Number.isFinite(m)&&Number.isFinite(c)&&(r.payout=m*(c/100)),Number.isFinite(b)&&(r.closing=b),Object.keys(r).length&&o.set(i,r)}),(Array.isArray(e.actuals)?e.actuals:[]).forEach(i=>{if(!i||!i.month)return;const d=i.month,m=vt(i.revenueEur,P),c=vt(i.payoutEur,P),b=vt(i.closingBalanceEur,P),r=o.get(d)||{};!Number.isFinite(r.revenue)&&Number.isFinite(m)&&(r.revenue=m),!Number.isFinite(r.payout)&&Number.isFinite(c)&&(r.payout=c),!Number.isFinite(r.closing)&&Number.isFinite(b)&&(r.closing=b),!Number.isFinite(r.payoutRatePct)&&Number.isFinite(m)&&m!==0&&Number.isFinite(c)&&(r.payoutRatePct=c/m*100),Object.keys(r).length&&o.set(d,r)}),o}function pn(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format(Ye(Number(t)))}function Xe(t,e){const[o,p]=t.split("-").map(Number),s=new Date(o,p-1+e,1);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`}function $e(t,e){const o=[];for(let p=0;p<e;p++)o.push(Xe(t,p));return o}function ut(t){const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function tt(t,e){const o=new Date(t.getTime());return o.setDate(o.getDate()+(e||0)),o}function pt(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function Nt(t){if(!t)return null;const e=new Date(t);return Number.isNaN(e.getTime())?null:e}function ae(t){const[e,o]=t.split("-").map(Number);return new Date(e,o,0)}function Ke(t,e){var d;const o=t==null?void 0:t.cny;if(o!=null&&o.start&&(o!=null&&o.end)){const m=Nt(o.start),c=Nt(o.end);if(m&&c&&c>=m)return{start:m,end:c}}const p=(d=t==null?void 0:t.cnyBlackoutByYear)==null?void 0:d[String(e)];if(!p)return null;const s=Nt(p.start),i=Nt(p.end);return!s||!i||i<s?null:{start:s,end:i}}function Je(t,e,o){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return{prodDone:t,adjustmentDays:0};const p=Math.max(0,Number(e||0)),s=tt(t,p);if(!o||p===0)return{prodDone:s,adjustmentDays:0};let i=0;const d=t.getUTCFullYear(),m=s.getUTCFullYear();for(let b=d;b<=m;b+=1){const r=Ke(o,b);if(!r)continue;const N=r.start>t?r.start:t,T=r.end<s?r.end:s;if(T<N)continue;const k=Math.round((T.getTime()-N.getTime())/(24*60*60*1e3))+1;i+=Math.max(0,k)}return{prodDone:i?tt(s,i):s,adjustmentDays:i}}function Se(t,e){const o=Nt(t.orderDate)||new Date,p=Number(t.productionLeadTimeDays??t.prodDays??0),s=Number(t.logisticsLeadTimeDays??t.transitDays??0),d=Je(o,p,e).prodDone??tt(o,p),m=d,c=tt(m,s),b=Nt(t.etdManual),r=Nt(t.etaManual);return{ORDER_DATE:o,PROD_DONE:d,PRODUCTION_END:d,ETD:b||m,ETA:r||c}}function we(t,e){const o=new Date(t.getTime());return o.setMonth(o.getMonth()+e),o}function tn(t){return new Date(t.getFullYear(),t.getMonth()+1,0)}function lt(t){if(!/^\d{4}-\d{2}$/.test(t||""))return null;const[e,o]=t.split("-").map(Number);return e*12+(o-1)}function en(t,e){const o=Array.isArray(t==null?void 0:t.items)?t.items:[];let p=0,s=0;if(o.length)o.forEach(b=>{const r=P((b==null?void 0:b.units)??0),N=P((b==null?void 0:b.unitCostUsd)??0),T=P((b==null?void 0:b.unitExtraUsd)??0),k=P((b==null?void 0:b.extraFlatUsd)??0),$=(N+T)*r+k,D=Math.max(0,Math.round($*100)/100);Number.isFinite(D)&&(p+=D),Number.isFinite(r)&&(s+=r)});else{const b=P((t==null?void 0:t.units)??0),r=P((t==null?void 0:t.unitCostUsd)??0),N=P((t==null?void 0:t.unitExtraUsd)??0),T=P((t==null?void 0:t.extraFlatUsd)??0),k=(r+N)*b+T;p=Math.max(0,Math.round(k*100)/100),Number.isFinite(b)&&(s=b)}const i=P((t==null?void 0:t.fxOverride)??0),d=Number.isFinite(i)&&i>0?i:P((e==null?void 0:e.fxRate)??0)||0,m=d>0?Math.round(p/d*100)/100:0,c=P((t==null?void 0:t.goodsEur)??0);return{usd:p,eur:m>0?m:c,units:s}}function ve(t,e){if(((t==null?void 0:t.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const p=P((t==null?void 0:t.freightPerUnitEur)??0),s=Number((e==null?void 0:e.units)??0)||0,i=p*s;return Math.round(i*100)/100}return P((t==null?void 0:t.freightEur)??0)}function nn(t){if(Array.isArray(t==null?void 0:t.items)&&t.items.length)return t.items.map(s=>{const i=String((s==null?void 0:s.sku)||"").trim();if(!i)return null;const d=(s==null?void 0:s.units)??(s==null?void 0:s.qty)??(s==null?void 0:s.quantity)??0,m=Math.max(0,P(d));return{...s,sku:i,units:m}}).filter(Boolean);const e=String((t==null?void 0:t.sku)||"").trim();if(!e)return[];const o=(t==null?void 0:t.units)??0,p=Math.max(0,P(o));return[{sku:e,units:p,unitCostUsd:t==null?void 0:t.unitCostUsd,unitExtraUsd:t==null?void 0:t.unitExtraUsd,extraFlatUsd:t==null?void 0:t.extraFlatUsd,prodDays:t==null?void 0:t.prodDays,transitDays:t==null?void 0:t.transitDays,freightEur:t==null?void 0:t.freightEur}]}function xe(t){const e=(t==null?void 0:t.order)||{},o=(t==null?void 0:t.profileBySku)instanceof Map?t.profileBySku:new Map,p=(t==null?void 0:t.poSkuSet)instanceof Set?t.poSkuSet:new Set,s=(t==null?void 0:t.fallbackBucket)||w.CORE,i=nn(e);if(!i.length)return[{bucket:s,share:1,row:{...e,payments:Array.isArray(e==null?void 0:e.payments)?e.payments.filter(Boolean).map(c=>({...c})):e==null?void 0:e.payments}}];const d=new Map;let m=0;return i.forEach(c=>{const b=String((c==null?void 0:c.sku)||"").trim();if(!b)return;const r=xt(b),N=o.get(r);if(!(N?N.includeInForecast:Te(void 0,!0)))return;const k=N?N.effectivePortfolioBucket:oe({sku:b,poSkuSet:p,fallbackBucket:s}),$=P((c==null?void 0:c.units)??0),D=Number.isFinite($)&&$>0?$:1;m+=D,d.has(k)||d.set(k,{bucket:k,items:[],weight:0});const U=d.get(k);U.items.push(c),U.weight+=D}),d.size?Array.from(d.values()).map((c,b,r)=>{const N=m>0?c.weight/m:r.length?1/r.length:1,T=Array.isArray(e==null?void 0:e.payments)?e.payments.filter(Boolean).map(U=>{const L=Number(U==null?void 0:U.amount);return Number.isFinite(L)?{...U,amount:Math.round(L*N*100)/100}:{...U}}):void 0,k=(e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total",$=P((e==null?void 0:e.freightEur)??0),D={...e,items:c.items.map(U=>({...U})),payments:T,freightMode:k,freightEur:k==="total"?Math.round($*N*100)/100:e==null?void 0:e.freightEur};return{bucket:c.bucket,share:N,row:D}}):[]}function an(t,e,o){const p=new Date(t,e+1,0).getDate(),s=Math.min(Math.max(1,o),p);return new Date(t,e,s)}function Oe(t,e){const o=lt(t);if(o==null)return null;const p=Math.floor(o/12),s=o%12;if(!e||e==="LAST"||e==="Letzter Tag"||e==="EOM")return new Date(p,s+1,0);const i=Number(e);return Number.isFinite(i)?an(p,s,i):new Date(p,s+1,0)}function on(t){const e=String(t||"").trim().toUpperCase();return e?e==="PLANNED"?"ACTIVE":e==="CANCELLED"?"ARCHIVED":e:"DRAFT"}function sn(t){const e=on(t);return e==="DRAFT"||e==="ACTIVE"}function un(t,e,o,p){if(!e||!e.proration||e.proration.enabled!==!0)return{amount:t,applied:!1};if(e.proration.method!=="daily")return{amount:t,applied:!1};const s=lt(o);if(s==null)return{amount:t,applied:!1};const i=Math.floor(s/12),d=s%12,m=new Date(i,d+1,0).getDate(),c=p instanceof Date&&!Number.isNaN(p.getTime())?p:Oe(o,e.anchor),b=c instanceof Date?c.getDate():m;let r=1;e.startMonth&&e.startMonth===o&&(r*=Math.max(0,m-b+1)/m),e.endMonth&&e.endMonth===o&&(r*=Math.max(0,b)/m);const N=Math.round(t*r*100)/100;return!Number.isFinite(N)||N===t?{amount:t,applied:!1}:{amount:N,applied:!0}}function Be({statusRecord:t,autoEligible:e,autoManualCheck:o,entryTime:p,todayTime:s,defaultPaid:i}){const d=typeof(t==null?void 0:t.manual)=="boolean"?t.manual:void 0;let m=!1,c=!1;typeof d=="boolean"?m=d:e&&!o&&p!=null&&p<=s?(m=!0,c=!0):m=!!i;const b=e&&o&&!c;let r=null;return e&&(c?r="Automatisch bezahlt am Fälligkeitstag":o?r="Automatische Zahlung – manuelle Prüfung aktiv":r="Automatische Zahlung"),{paid:m,autoApplied:c,manualOverride:typeof d=="boolean",autoSuppressed:b,autoTooltip:r}}function cn(t,e={}){const o=t||{},p=e.startMonth||o.settings&&o.settings.startMonth||"2025-01",s=Number(e.horizon||o.settings&&o.settings.horizonMonths||12),i=Array.isArray(e.months)&&e.months.length?e.months:$e(p,s),d=Array.isArray(o.fixcosts)?o.fixcosts:[],m=o.fixcostOverrides&&typeof o.fixcostOverrides=="object"?o.fixcostOverrides:{},c=e.status&&typeof e.status=="object"?e.status:o.status||{},b=e.statusEvents&&typeof e.statusEvents=="object"?e.statusEvents:c.events||{},r=e.autoManualCheck!=null?e.autoManualCheck===!0:c.autoManualCheck===!0,N=e.today?new Date(e.today):new Date;N.setHours(0,0,0,0);const T=N.getTime(),k=[],$=new Set(i);return d.forEach((D,U)=>{if(!D)return;const L=D.id||`fix-${U}`,H=D.startMonth||p,et=lt(H);if(et==null)return;const Y=D.endMonth||null,Z=Y?lt(Y):null,h=(D.frequency||"monthly").toLowerCase();let M=1;h==="quarterly"?M=3:h==="semiannual"||h==="halbjährlich"?M=6:h==="annual"||h==="jährlich"||h==="yearly"?M=12:(h==="custom"||h==="benutzerdefiniert")&&(M=Number(D.intervalMonths||D.everyMonths||1)||1),M<1&&(M=1);const _=D.anchor,F=!_||_==="Letzter Tag"?"LAST":String(_),A=m[L]&&typeof m[L]=="object"?m[L]:{},x=D.name||"Fixkosten",I=D.category||"Sonstiges",O=Math.abs(P(D.amount)),nt=D.notes||"",S=D.autoPaid===!0;i.forEach(V=>{if(!$.has(V))return;const Dt=lt(V);if(Dt==null||Dt<et||Z!=null&&Dt>Z||(Dt-et)%M!==0)return;const ht=Oe(V,F),q=A[V]&&typeof A[V]=="object"?A[V]:{};let X=ht;if(q.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(q.dueDate)){const it=new Date(q.dueDate);Number.isNaN(it.getTime())||(X=it)}let Mt=O,ct=!1;q.amount!=null&&String(q.amount).trim()!==""&&(Mt=Math.abs(P(q.amount)),ct=!0);let Pt=!1;if(!ct){const it=un(O,D,V,X);Mt=it.amount,Pt=it.applied}const qt=`fix-${L}-${V}`,rt=X instanceof Date&&!Number.isNaN(X.getTime())?X.getTime():null,Wt=b[qt],at=Be({statusRecord:Wt,autoEligible:S,autoManualCheck:r,entryTime:rt,todayTime:T,defaultPaid:!1}),K=X instanceof Date&&!Number.isNaN(X.getTime())?pt(X):null,Ut=q.note||"",kt=[x];ct&&kt.push("Override aktiv"),Pt&&kt.push("Proratiert");const Ht=kt.length>1?kt.join(" · "):null;k.push({id:qt,month:V,amount:Mt,baseAmount:O,label:x,category:I,dueDate:X,dueDateIso:K,fixedCostId:L,autoPaid:S,notes:nt,override:{amount:q.amount||"",dueDate:q.dueDate||"",note:Ut},overrideActive:ct||!!q.dueDate||!!Ut,prorationApplied:Pt,paid:at.paid,autoApplied:at.autoApplied,manualOverride:at.manualOverride,autoTooltip:at.autoTooltip,autoSuppressed:at.autoSuppressed,anchor:F,frequency:h,tooltip:Ht})})}),k.sort((D,U)=>{if(D.month===U.month){const L=D.dueDate instanceof Date?D.dueDate.getTime():0,H=U.dueDate instanceof Date?U.dueDate.getTime():0;return L-H}return lt(D.month)-lt(U.month)}),k}function rn(t){const e=t||{};return{dutyRatePct:G(e.dutyRatePct??0),dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:G(e.eustRatePct??0),vatRefundLagMonths:Number(e.vatRefundLagMonths??0)||0,vatRefundEnabled:e.vatRefundEnabled!==!1,freightLagDays:Number(e.freightLagDays??0)||0,fxFeePct:G(e.fxFeePct??0)}}function ln(t,e,o){const p=["freight","duty","eust","vat_refund","fx_fee"],s=Array.isArray(t.autoEvents)?t.autoEvents.filter(Boolean).map(c=>({...c})):[],i=new Map;for(const c of s)!c||!c.type||(c.id||(c.id=`auto-${c.type}`),i.set(c.type,c));const d=(o||[])[0]||null;function m(c,b){if(!i.has(c)){const N={id:`auto-${c}`,type:c,...b};return s.push(N),i.set(c,N),N}const r=i.get(c);r.id||(r.id=`auto-${c}`);for(const[N,T]of Object.entries(b))r[N]===void 0&&(r[N]=T);return r}if(m("freight",{label:"Fracht",anchor:"ETA",lagDays:e.freightLagDays,enabled:!0}),m("duty",{label:"Zoll",percent:e.dutyRatePct,anchor:"ETA",lagDays:e.freightLagDays}),m("eust",{label:"EUSt",percent:e.eustRatePct,anchor:"ETA",lagDays:e.freightLagDays}),m("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:e.vatRefundLagMonths,enabled:e.vatRefundEnabled}),m("fx_fee",{label:"FX-Gebühr",percent:e.fxFeePct,anchor:d&&d.anchor||"ORDER_DATE",lagDays:d&&Number(d.lagDays||0)||0}),s.sort((c,b)=>p.indexOf(c.type)-p.indexOf(b.type)),t.ddp)for(const c of s)(c.type==="freight"||c.type==="duty"||c.type==="eust"||c.type==="vat_refund")&&(c.enabled=!1);return s}function Ie(t,e,o,p){var Z;if(!t)return[];const s=o||"PO",i=t[p],d=i?`${s} ${i}`:s;if(Array.isArray(t.payments)&&t.payments.length){const h=Se(t,e);return t.payments.filter(Boolean).map((M,_)=>{const F=M.triggerEvent||"ORDER_DATE",A=F==="PROD_DONE"?"PROD_DONE":F,x=h[A]||h.ORDER_DATE,I=M.dueDate?new Date(M.dueDate):tt(x,Number(M.offsetDays||0)),O=Number(M.amount||0),nt=O>=0?"out":"in",S=Math.abs(O);return{label:`${d}${M.label?` – ${M.label}`:""}`,amount:S,due:I,month:ut(I),direction:nt,type:"manual",anchor:A,lagDays:Number(M.offsetDays||0)||0,percent:Number(M.percent||0),sourceType:s,sourceNumber:i,sourceId:t.id,id:M.id||`${t.id||s}-pay-${_}`,tooltip:`Fälligkeit: ${A} + ${Number(M.offsetDays||0)} Tage`}})}const m=en(t,e),c=m.eur,b=ve(t,m),r=Se(t,e),N=Array.isArray(t.milestones)?t.milestones:[],T=ln(t,e,N),k=[];for(const[h,M]of N.entries()){const _=G(M.percent),F=r[M.anchor||"ORDER_DATE"]||r.ORDER_DATE,A=tt(F,Number(M.lagDays||0)),x=M.id||`${t.id||s}-${h}-${M.id||"manual"}`;k.push({label:`${d}${M.label?` – ${M.label}`:""}`,amount:c*(_/100),due:A,month:ut(A),direction:"out",type:"manual",anchor:M.anchor||"ORDER_DATE",lagDays:Number(M.lagDays||0)||0,percent:_,sourceType:s,sourceNumber:i,sourceId:t.id,id:x,tooltip:`Fälligkeit: ${M.anchor||"ORDER_DATE"} + ${Number(M.lagDays||0)} Tage`})}const $=t.dutyIncludeFreight!==!1,D=G(t.dutyRatePct??e.dutyRatePct??0),U=G(t.eustRatePct??e.eustRatePct??0),L=G(t.fxFeePct??e.fxFeePct??0),H=Number(t.vatRefundLagMonths??e.vatRefundLagMonths??0),et=t.vatRefundEnabled!==!1,Y={};for(const h of T){if(!h||h.enabled===!1)continue;const M=h.anchor||"ETA",_=r[M]||r.ETA;if(!(!(_ instanceof Date)||Number.isNaN(_.getTime()))){if(h.type==="freight"){const F=ve(t,m);if(!F)continue;const A=h.id||`${t.id||s}-auto-freight`,x=tt(_,Number(h.lagDays||0));k.push({label:`${d} – ${h.label||"Fracht"}`,amount:F,due:x,month:ut(x),direction:"out",type:"freight",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,sourceType:s,sourceNumber:i,sourceId:t.id,id:A,tooltip:"Frachtkosten laut Eingabe"});continue}if(h.type==="duty"){const F=G(h.percent??D),A=tt(_,Number(h.lagDays||0)),I=(c+($?b:0))*(F/100),O=h.id||`${t.id||s}-auto-duty`;Y.duty={amount:I,due:A},k.push({label:`${d} – ${h.label||"Zoll"}`,amount:I,due:A,month:ut(A),direction:"out",type:"duty",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,percent:F,sourceType:s,sourceNumber:i,sourceId:t.id,id:O,tooltip:`Zoll = ${F}% × (Warenwert${$?" + Fracht":""})`});continue}if(h.type==="eust"){const F=G(h.percent??U),A=Math.abs(((Z=Y.duty)==null?void 0:Z.amount)||0),x=c+b+A,I=tt(_,Number(h.lagDays||0)),O=x*(F/100),nt=h.id||`${t.id||s}-auto-eust`;Y.eust={amount:O,due:I},k.push({label:`${d} – ${h.label||"EUSt"}`,amount:O,due:I,month:ut(I),direction:"out",type:"eust",anchor:h.anchor||"ETA",lagDays:Number(h.lagDays||0)||0,percent:F,sourceType:s,sourceNumber:i,sourceId:t.id,id:nt,tooltip:`EUSt = ${F}% × (Warenwert + Fracht + Zoll)`});continue}if(h.type==="vat_refund"){const F=Y.eust;if(!et||!F||F.amount===0)continue;const A=G(h.percent??100),x=Number((h.lagMonths??H)||0),I=tt(F.due||_,Number(h.lagDays||0)),O=tn(we(I,x)),nt=Math.abs(F.amount)*(A/100),S=h.id||`${t.id||s}-auto-vat`;k.push({label:`${d} – ${h.label||"EUSt-Erstattung"}`,amount:nt,due:O,month:ut(O),direction:"in",type:"vat_refund",anchor:h.anchor||"ETA",lagMonths:x,percent:A,sourceType:s,sourceNumber:i,sourceId:t.id,id:S,tooltip:`Erstattung am Monatsende nach ${x} Monaten`});continue}if(h.type==="fx_fee"){const F=G(h.percent??L);if(!F)continue;const A=tt(_,Number(h.lagDays||0)),x=c*(F/100),I=h.id||`${t.id||s}-auto-fx`;k.push({label:`${d} – ${h.label||"FX-Gebühr"}`,amount:x,due:A,month:ut(A),direction:"out",type:"fx_fee",anchor:h.anchor||"ORDER_DATE",lagDays:Number(h.lagDays||0)||0,percent:F,sourceType:s,sourceNumber:i,sourceId:t.id,id:I,tooltip:`FX-Gebühr = ${F}% × Warenwert`})}}}return k}function hn(t){var me,pe,he,be,ge,ye,Ee,Ne,De,Me;const e=t||{},o=e.settings&&e.settings.startMonth||"2025-01",p=Number(e.settings&&e.settings.horizonMonths||12),s=$e(o,p),i=e.status&&typeof e.status=="object"?e.status:{},d=i.events&&typeof i.events=="object"?i.events:{},m=i.autoManualCheck===!0,c=new Date;c.setHours(0,0,0,0);const b=c.getTime(),r={};s.forEach(n=>{r[n]={entries:[]}});const{map:N,poSkuSet:T}=je(e);function k(n){const a=xt(n);return a?N.get(a)||{includeInForecast:!0,effectivePortfolioBucket:oe({sku:n,poSkuSet:T,fallbackBucket:w.CORE})}:{includeInForecast:!0,effectivePortfolioBucket:w.CORE}}function $(n,a){r[n]&&r[n].entries.push(a)}function D(n,a={}){const l=n.id||`${n.month||""}-${n.label||""}-${n.date||""}`,g=d[l],u=n.date?new Date(n.date):null,y=u&&Number.isFinite(u.getTime())?new Date(u.getFullYear(),u.getMonth(),u.getDate()).getTime():null,E=a.auto===!0,R=E&&a.autoEligible!==!1,v=typeof n.paid=="boolean"?n.paid:!!a.defaultPaid,B=Be({statusRecord:g,autoEligible:R,autoManualCheck:m,entryTime:y,todayTime:b,defaultPaid:v}),z={...n.meta&&typeof n.meta=="object"?n.meta:{}},Q=n.portfolioBucket?Rt(n.portfolioBucket,w.CORE):null;return Q&&(z.portfolioBucket=Q),{id:l,direction:n.direction||"in",amount:Math.abs(n.amount||0),label:n.label||"",month:n.month,date:n.date,kind:n.kind,group:n.group,paid:B.paid,source:n.source||null,anchor:n.anchor,lagDays:n.lagDays,lagMonths:n.lagMonths,percent:n.percent,scenarioDelta:n.scenarioDelta||0,scenarioAmount:n.scenarioAmount||n.amount||0,meta:z,portfolioBucket:Q,tooltip:n.tooltip,sourceTab:n.sourceTab,sourceNumber:n.sourceNumber,sourceId:n.sourceId,statusId:l,auto:E,autoEligible:R,autoApplied:B.autoApplied,autoManualCheck:m,manualOverride:B.manualOverride,autoSuppressed:B.autoSuppressed,autoTooltip:B.autoTooltip}}cn(e,{months:s,statusEvents:d,autoManualCheck:m,today:c}).map(n=>({id:n.id,direction:"out",amount:n.amount,label:n.label,month:n.month,date:n.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:n.fixedCostId,category:n.category,override:n.overrideActive,overrideAmount:n.override.amount,overrideDueDate:n.override.dueDate,overrideNote:n.override.note,notes:n.notes,baseAmount:n.baseAmount,prorationApplied:n.prorationApplied},tooltip:n.tooltip,auto:n.autoPaid,autoEligible:n.autoPaid})).forEach(n=>{$(n.month,D(n,{auto:n.auto,autoEligible:n.autoEligible}))});const L=!!((pe=(me=e==null?void 0:e.forecast)==null?void 0:me.settings)!=null&&pe.useForecast),H={},et={},Y={},Z=Et.reduce((n,a)=>(n[a]={},n),{}),h=Et.reduce((n,a)=>(n[a]={},n),{});if(s.forEach(n=>{H[n]=0,et[n]=0,Y[n]=0,Et.forEach(a=>{Z[a][n]=0,h[a][n]=0})}),L){(he=e==null?void 0:e.forecast)!=null&&he.forecastImport&&typeof e.forecast.forecastImport=="object"?Object.entries(e.forecast.forecastImport).forEach(([a,l])=>{const g=k(a);if(!g.includeInForecast)return;const u=Rt(g.effectivePortfolioBucket,w.CORE);Object.entries(l||{}).forEach(([y,E])=>{if(!y||!r[y])return;const R=P((E==null?void 0:E.revenueEur)??(E==null?void 0:E.revenue)??null);Number.isFinite(R)&&(H[y]=(H[y]||0)+R,Z[u][y]=(Z[u][y]||0)+R)})}):Array.isArray((be=e==null?void 0:e.forecast)==null?void 0:be.items)&&e.forecast.items.forEach(a=>{if(!a||!a.month||!a.sku)return;const l=k(a.sku);if(!l.includeInForecast)return;const g=Rt(l.effectivePortfolioBucket,w.CORE),u=a.month;if(!r[u])return;const y=Number(a.qty??a.quantity??0)||0,E=P(a.priceEur??a.price??0),R=y*E;H[u]=(H[u]||0)+R,Z[g][u]=(Z[g][u]||0)+R});const n=_e({state:e,months:s});Object.entries((n==null?void 0:n.byBucket)||{}).forEach(([a,l])=>{const g=Rt(a,w.PLAN);Object.entries(l||{}).forEach(([u,y])=>{if(!r[u])return;const E=P(y);Number.isFinite(E)&&(et[u]=(et[u]||0)+E,h[g][u]=(h[g][u]||0)+E)})}),Object.keys(r).forEach(a=>{Y[a]=(H[a]||0)+(et[a]||0)})}const M=Array.isArray(e.incomings)?e.incomings:[],_=new Map;M.forEach(n=>{if(!n||!n.month)return;const a=String(n.month||"").trim();a&&_.set(a,n)});const F=ut(c),A=lt(F),x=Ze((ge=e==null?void 0:e.settings)==null?void 0:ge.cashInMode),I=He,O=We,nt=Ge(e),S=ze({months:Object.keys(r),incomings:M,monthlyActuals:e==null?void 0:e.monthlyActuals,currentMonth:F,ignoreQ4:((ye=e==null?void 0:e.settings)==null?void 0:ye.cashInRecommendationIgnoreQ4)===!0,maxMonth:F,baselineNormalPct:(Ee=e==null?void 0:e.settings)==null?void 0:Ee.cashInRecommendationBaselineNormalPct,baselineQ4Pct:(Ne=e==null?void 0:e.settings)==null?void 0:Ne.cashInRecommendationBaselineQ4Pct,minSamples:4}),V=Ct(S.observedNormalMedianPct),Dt=Number.isFinite(V)?St(V,I,O):null,Qt=Ct(S.baselineNormalPct),ht=Number.isFinite(Qt)?St(Qt,I,O):51,q=Ct(S.baselineQ4Pct),X=Number.isFinite(q)?St(q,I,O):ht,Mt="baseline_manual",ct=((De=e==null?void 0:e.settings)==null?void 0:De.cashInCalibrationEnabled)!==!1,Pt=Qe((Me=e==null?void 0:e.settings)==null?void 0:Me.cashInCalibrationHorizonMonths,6),rt=qe({incomings:ct?M:[],months:Object.keys(r),forecastRevenueByMonth:Y,horizonMonths:Pt}),Wt=Array.isArray(rt.evaluations)?rt.evaluations:[],at=Array.isArray(rt.candidates)?rt.candidates:[],K=at.length?at[at.length-1]:null,Ut=Wt.reduce((n,a)=>{if(!a||typeof a!="object")return n;const l=String(a.reason||"").trim()||"unknown";return n[l]=Number(n[l]||0)+1,n},{}),kt=Object.values(rt.byMonth||{}).filter(n=>{const a=Number((n==null?void 0:n.factor)||1);return Number.isFinite(a)&&Math.abs(a-1)>1e-6}).length,Ht=ct&&Object.values(rt.byMonth||{}).some(n=>{const a=Number((n==null?void 0:n.factor)||1);return Number.isFinite(a)&&Math.abs(a-1)>1e-6}),it={},It={};Object.keys(r).forEach(n=>{var ke,Fe;const a=_.get(n)||null,l=String((a==null?void 0:a.source)||"").trim().toLowerCase(),u=(a==null?void 0:a.revenueEur)!=null&&String(a.revenueEur).trim()!==""?P(a.revenueEur):null,y=L&&l==="manual"&&Number.isFinite(u),E=(a==null?void 0:a.payoutPct)!=null&&String(a.payoutPct).trim()!=="",R=E?Ct(a.payoutPct):null,v=((ke=S.byMonth)==null?void 0:ke[n])||null,B=String((v==null?void 0:v.sourceTag)||"BASELINE_NORMAL"),z=String((v==null?void 0:v.explanation)||"").trim()||null,Q=Ct(v==null?void 0:v.quotePct),Ft=Number.isFinite(Q)?St(Q,I,O):ht,ft=E?"manual":"recommendation",jt=St(E?R:Ft,I,O),bt=((Fe=rt.byMonth)==null?void 0:Fe[n])||{factor:1,sourceMonth:null,method:null},gt=Number(Y[n]||0),st=Number(bt.factor||1),Tt=gt*st;let J=null,f=null;if(L)y?(J=Number(u),f="manual_override"):(J=Number(Tt||0),f="forecast_calibrated");else{if(!Number.isFinite(u))return;J=Number(u),f="manual_no_forecast"}if(!Number.isFinite(J))return;const C=lt(n),At=C!=null&&A!=null?C-A:0,Kt=At>0,$t=Kt&&x==="conservative"?Ve(At):0,Le=Kt?jt-$t:jt,mt=St(Le,I,O),zt=L?Tt:J,Jt=L?gt:J;it[n]=mt,It[n]={mode:x,calibrationEnabled:ct,isFutureMonth:Kt,horizonFromCurrentMonth:At,marginPct:$t,recommendationQuotePct:Ft,recommendationSourceTag:B,recommendationExplanation:z,payoutPct:mt,manualPayoutPct:R,quoteSource:ft,revenueSource:f,appliedRevenue:J,forecastRevenueRaw:gt,calibrationFactorApplied:st,calibrationSourceMonth:bt.sourceMonth||null,calibrationMethod:bt.method||null,planRevenueAfterCalibration:zt,fallbackUsed:Mt,quoteMinPct:I,quoteMaxPct:O};const wt=ae(n);if(!L||y){const j=J*(mt/100),yt=ne({forecastRevenue:Jt,calibrationFactorApplied:st,planRevenue:zt,payoutPct:mt,payoutAmount:j,quoteSource:ft,recommendationSourceTag:B,mode:x,marginPct:$t});$(n,D({id:`sales-${n}`,direction:j>=0?"in":"out",amount:Math.abs(j),label:"Amazon Payout",month:n,date:pt(wt),kind:"sales-payout",group:j>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#eingaben",tooltip:yt,portfolioBucket:null,meta:{cashIn:{...It[n],revenue:J,payoutAmount:j}}},{auto:!1}));return}Et.forEach(j=>{var Bt;const yt=((Bt=Z[j])==null?void 0:Bt[n])||0,Ot=yt*st,W=Ot*(mt/100);if(Math.abs(W)>1e-6){const te=ne({forecastRevenue:Jt,calibrationFactorApplied:st,planRevenue:zt,payoutPct:mt,payoutAmount:W,quoteSource:ft,recommendationSourceTag:B,mode:x,marginPct:$t});$(n,D({id:`sales-live-${j}-${n}`,direction:W>=0?"in":"out",amount:Math.abs(W),label:`Amazon Payout (Prognose - Live/CSV · ${j})`,month:n,date:pt(wt),kind:"sales-payout",group:W>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#forecast",tooltip:te,portfolioBucket:j,meta:{cashIn:{...It[n],revenue:Ot,payoutAmount:W,component:"live",componentRevenueRaw:yt,portfolioBucket:j}}},{auto:!1}))}}),Et.forEach(j=>{var Bt;const yt=((Bt=h[j])==null?void 0:Bt[n])||0,Ot=yt*st,W=Ot*(mt/100);if(Math.abs(W)>1e-6){const te=ne({forecastRevenue:Jt,calibrationFactorApplied:st,planRevenue:zt,payoutPct:mt,payoutAmount:W,quoteSource:ft,recommendationSourceTag:B,mode:x,marginPct:$t});$(n,D({id:`sales-plan-${j}-${n}`,direction:W>=0?"in":"out",amount:Math.abs(W),label:`Amazon Payout (Prognose - Plan · ${j})`,month:n,date:pt(wt),kind:"sales-payout",group:W>=0?"Sales × Payout":"Extras (Out)",source:"sales-plan",sourceTab:"#forecast",tooltip:te,portfolioBucket:j,meta:{cashIn:{...It[n],revenue:Ot,payoutAmount:W,component:"plan",componentRevenueRaw:yt,portfolioBucket:j}}},{auto:!1}))}})}),(Array.isArray(e.extras)?e.extras:[]).forEach(n=>{const a=n.month||(n.date?ut(n.date):null);if(!a||!r[a])return;const l=P(n.amountEur),g=l>=0?"in":"out",u=a,y=n.date?new Date(n.date):ae(u);$(u,D({id:`extra-${n.id||n.label||u}-${n.date||""}`,direction:g,amount:Math.abs(l),label:n.label||"Extra",month:u,date:pt(y),kind:"extra",group:g==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:n.autoPaid===!0,autoEligible:n.autoPaid===!0}))}),(Array.isArray(e.dividends)?e.dividends:[]).forEach(n=>{const a=n.month||(n.date?ut(n.date):null);if(!a||!r[a])return;const l=P(n.amountEur),g=n.date?new Date(n.date):ae(a);$(a,D({id:`div-${n.id||n.label||a}`,direction:l>=0?"out":"in",amount:Math.abs(l),label:n.label||"Dividende",month:a,date:pt(g),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))}),(Array.isArray(e.products)?e.products:[]).forEach((n,a)=>{const l=n&&typeof n=="object"?n:{},g=String(l.sku||"").trim();if(!g)return;const u=k(g);if(!u.includeInForecast)return;const y=Rt(u.effectivePortfolioBucket,w.CORE),E=String(l.alias||g).trim()||g;Ae(l.launchCosts,`prod-${a+1}-lc`).forEach((v,B)=>{const z=String(v.date||"").slice(0,7);!z||!r[z]||$(z,D({id:`launch-product-${xt(g)}-${v.id||B+1}`,direction:"out",amount:Math.abs(P(v.amountEur)),label:`${E} · Launch-Kosten (${v.type||"Sonstiges"})`,month:z,date:v.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#products",portfolioBucket:y,meta:{sku:g,alias:E,type:v.type||"Sonstiges",note:v.note||"",currency:v.currency||"EUR"}},{auto:!1}))})}),(Array.isArray(e.planProducts)?e.planProducts:[]).forEach((n,a)=>{const l=n&&typeof n=="object"?n:{};if(String(l.status||"active").trim().toLowerCase()!=="active"||!Te(l.includeInForecast,!0))return;const y=String(l.plannedSku||l.mappedSku||"").trim(),E=oe({product:l,sku:y,poSkuSet:T,fallbackBucket:w.PLAN}),R=String(l.alias||y||`Planprodukt ${a+1}`).trim();Ae(l.launchCosts,`plan-${a+1}-lc`).forEach((B,z)=>{const Q=String(B.date||"").slice(0,7);!Q||!r[Q]||$(Q,D({id:`launch-plan-${xt(y||R)}-${B.id||z+1}`,direction:"out",amount:Math.abs(P(B.amountEur)),label:`${R} · Launch-Kosten (${B.type||"Sonstiges"})`,month:Q,date:B.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#plan-products",portfolioBucket:E,meta:{sku:y||null,alias:R,type:B.type||"Sonstiges",note:B.note||"",currency:B.currency||"EUR",source:"plan-product"}},{auto:!1}))})});const se=rn(e.settings);(Array.isArray(e.pos)?e.pos:[]).forEach(n=>{const a=xe({order:n,profileBySku:N,poSkuSet:T,fallbackBucket:w.CORE}),l=a.length>1;a.forEach(g=>{Ie(g.row,se,"PO","poNo").forEach(u=>{const y=u.month;if(!r[y])return;const E=u.type==="manual"?"po":u.type==="vat_refund"?"po-refund":"po-import",R=E==="po"?"PO/FO-Zahlungen":"Importkosten";$(y,D({id:l?`${u.id||`po-${n.id||""}-${u.type}-${u.month}`}-${xt(g.bucket)}`:u.id||`po-${n.id||""}-${u.type}-${u.month}`,direction:u.direction==="in"?"in":"out",amount:Math.abs(u.amount||0),label:u.label,month:y,date:pt(u.due),kind:E,group:R,source:"po",sourceTab:"#po",anchor:u.anchor,lagDays:u.lagDays,lagMonths:u.lagMonths,percent:u.percent,sourceNumber:u.sourceNumber||n.poNo||n.id,sourceId:n.id||n.poNo||null,tooltip:u.tooltip,portfolioBucket:g.bucket,meta:{skuBucketShare:g.share}},{auto:u.type!=="manual",autoEligible:u.type!=="manual"}))})})}),(Array.isArray(e.fos)?e.fos:[]).forEach(n=>{if(!sn(n==null?void 0:n.status))return;const a=xe({order:n,profileBySku:N,poSkuSet:T,fallbackBucket:w.CORE}),l=a.length>1;a.forEach(g=>{Ie(g.row,se,"FO","foNo").forEach(u=>{const y=u.month;if(!r[y])return;const E=u.type==="manual"?"fo":u.type==="vat_refund"?"fo-refund":"fo-import",R=E==="fo"?"PO/FO-Zahlungen":"Importkosten";$(y,D({id:l?`${u.id||`fo-${n.id||""}-${u.type}-${u.month}`}-${xt(g.bucket)}`:u.id||`fo-${n.id||""}-${u.type}-${u.month}`,direction:u.direction==="in"?"in":"out",amount:Math.abs(u.amount||0),label:u.label,month:y,date:pt(u.due),kind:E,group:R,source:"fo",sourceTab:"#fo",anchor:u.anchor,lagDays:u.lagDays,lagMonths:u.lagMonths,percent:u.percent,sourceNumber:u.sourceNumber||n.foNo||n.foNumber||n.id,sourceId:n.id||n.foNo||n.foNumber||null,tooltip:u.tooltip,portfolioBucket:g.bucket,meta:{skuBucketShare:g.share}},{auto:!1,autoEligible:!1,defaultPaid:!1}))})})});const Lt=s.map(n=>{const l=r[n].entries||[],g=l.filter(f=>f.direction==="in"),u=l.filter(f=>f.direction==="out"),y=u.filter(f=>f.group==="Fixkosten"),E=y.reduce((f,C)=>f+(C.amount||0),0),R=y.filter(f=>f.paid).reduce((f,C)=>f+(C.amount||0),0),v=Math.max(0,E-R),B=y.slice().sort((f,C)=>(C.amount||0)-(f.amount||0)).slice(0,3).map(f=>({label:f.label,amount:f.amount,paid:f.paid,category:f.meta&&f.meta.category?f.meta.category:null})),z=g.reduce((f,C)=>f+(C.amount||0),0),Q=u.reduce((f,C)=>f+(C.amount||0),0),Ft=g.filter(f=>f.paid).reduce((f,C)=>f+(C.amount||0),0),ft=u.filter(f=>f.paid).reduce((f,C)=>f+(C.amount||0),0),Pe=Math.max(0,z-Ft),jt=Math.max(0,Q-ft),bt={},gt={};Et.forEach(f=>{bt[f]=0,gt[f]=0}),l.forEach(f=>{var At;const C=Rt((f==null?void 0:f.portfolioBucket)||((At=f==null?void 0:f.meta)==null?void 0:At.portfolioBucket),"");!C||!Et.includes(C)||(f.direction==="in"?bt[C]+=Math.abs(Number(f.amount||0)):f.direction==="out"&&(gt[C]+=Math.abs(Number(f.amount||0))))});const st=z-Q,Tt=Ft-ft,J=st-Tt;return{month:n,inflow:{total:z,paid:Ft,open:Pe},outflow:{total:Q,paid:ft,open:jt},bucketBreakdown:{inflow:bt,outflow:gt},net:{total:st,paid:Tt,open:J},fixcost:{total:E,paid:R,open:v,top:B},itemsIn:g.map(f=>({kind:f.kind,label:f.label,amount:f.amount})),itemsOut:u.map(f=>({kind:f.kind,label:f.label,amount:f.amount})),entries:l}}),_t=P(e.settings&&e.settings.openingBalance),Yt=Lt.map(n=>n.itemsIn.filter(a=>a.kind==="sales-payout").reduce((a,l)=>a+l.amount,0)),ue=Yt.length?Yt.reduce((n,a)=>n+a,0)/(Yt.filter(n=>n>0).length||1):0,ce={},re={};Object.keys(r).forEach(n=>{const a=It[n];if(!a)return;const l=Number(a.appliedRevenue||0),g=Number.isFinite(it[n])?Number(it[n]):ht;ce[n]=l,re[n]=l*(g/100)});const Zt={opening:_t,openingToday:_t,salesPayoutAvg:ue,avgSalesPayout:ue,firstNegativeMonth:null,actuals:{},cashIn:{mode:x,basisMethod:"baseline",basisQuotePct:ht,istMonthsCount:S.sampleCount,hasIstData:S.sampleCount>0,fallbackUsed:Mt,quoteMinPct:I,quoteMaxPct:O,recommendationMedianPct:Dt,recommendationSampleCount:S.sampleCount,recommendationUsedMonths:S.usedMonths,recommendationUncertain:S.uncertain,recommendationIgnoreQ4:S.ignoreQ4,recommendationBaselineNormalPct:ht,recommendationBaselineQ4Pct:X,recommendationBaselineQ4SuggestedPct:S.baselineQ4SuggestedPct,recommendationObservedNormalMedianPct:S.observedNormalMedianPct,recommendationObservedNormalAveragePct:S.observedNormalAveragePct,recommendationObservedNormalSampleCount:S.observedNormalSampleCount,recommendationObservedNormalWithForecastMedianPct:S.observedNormalWithForecastMedianPct,recommendationObservedNormalWithForecastAveragePct:S.observedNormalWithForecastAveragePct,recommendationObservedNormalWithForecastSampleCount:S.observedNormalWithForecastSampleCount,recommendationCurrentMonthForecastQuotePct:S.currentMonthForecastQuotePct,recommendationCurrentMonth:S.currentMonth,calibrationEnabled:ct,calibrationApplied:Ht,calibrationHorizonMonths:Pt,calibrationCandidateCount:at.length,calibrationLatestCandidateMonth:(K==null?void 0:K.month)||null,calibrationLatestRawFactor:Number.isFinite(Number(K==null?void 0:K.rawFactor))?Number(K==null?void 0:K.rawFactor):null,calibrationNonDefaultFactorMonthCount:kt,calibrationReasonCounts:Ut,marginBucketsPct:{plus1:1,plus2:2,plus3:3,plus4:4,plus5plus:5}}};let Vt=_t;const ie=s.map((n,a)=>{const l=Lt[a],g=Vt;return Vt+=l.net.total,{month:n,opening:g,closing:Vt,inflow:l.inflow.total,outflow:l.outflow.total,net:l.net.total,entries:l.entries}});let le=_t;const de=s.map((n,a)=>{var v;const l=Lt[a],g=le,u=g+l.net.total,y=(v=nt.get(n))==null?void 0:v.closing,E=Number.isFinite(y),R=E?Number(y):u;return le=R,{month:n,opening:g,closing:R,inflow:l.inflow.total,outflow:l.outflow.total,net:l.net.total,entries:l.entries,plannedClosing:u,actualClosing:E?Number(y):null}}),fe=de.find(n=>Number(n.closing||0)<0);Zt.firstNegativeMonth=fe?fe.month:null;const dt=[];nt.forEach((n,a)=>{const l=s.indexOf(a);if(l===-1)return;const g=l>=0&&l<ie.length?ie[l]:null,u=g?g.closing:null,y=ce[a]??null,E=re[a]??null;dt.push({month:a,plannedRevenue:y,actualRevenue:n.revenue,revenueDelta:(n.revenue??0)-(y??0),revenueDeltaPct:y?((n.revenue??0)-y)/y*100:null,plannedPayout:E,actualPayout:n.payout,payoutDelta:(n.payout??0)-(E??0),payoutDeltaPct:E?((n.payout??0)-E)/E*100:null,plannedClosing:u,actualClosing:n.closing,closingDelta:(n.closing??0)-(u??0)})}),dt.sort((n,a)=>(n.month||"").localeCompare(a.month||""));const ot=dt[dt.length-1]||null,Gt=dt.map(n=>n.revenueDeltaPct).filter(n=>Number.isFinite(n)),Xt=dt.map(n=>n.payoutDeltaPct).filter(n=>Number.isFinite(n)),Ce=Gt.length?Gt.reduce((n,a)=>n+a,0)/Gt.length:null,Ue=Xt.length?Xt.reduce((n,a)=>n+a,0)/Xt.length:null;return Zt.actuals={count:dt.length,lastMonth:ot?ot.month:null,lastClosing:ot?ot.actualClosing:null,closingDelta:ot?ot.closingDelta:null,revenueDeltaPct:ot?ot.revenueDeltaPct:null,payoutDeltaPct:ot?ot.payoutDeltaPct:null,avgRevenueDeltaPct:Ce,avgPayoutDeltaPct:Ue},{startMonth:o,horizon:p,months:s,series:Lt,kpis:Zt,breakdown:de,actualComparisons:dt}}export{hn as c,cn as e,pn as f,P as p};
