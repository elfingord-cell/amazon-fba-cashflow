import{p as pt}from"./index-Coy5uI_5.js";import{b as nt}from"./orderEditorFactory-ySK-WoVs.js";const et=20,rt=new TextEncoder;let j=null;function mt(){if(j)return j;j=new Uint32Array(256);for(let t=0;t<256;t+=1){let e=t;for(let n=0;n<8;n+=1)(e&1)===1?e=3988292384^e>>>1:e>>>=1;j[t]=e>>>0}return j}function gt(t){const e=mt();let n=4294967295;for(let s=0;s<t.length;s+=1)n=n>>>8^e[(n^t[s])&255];return(n^4294967295)>>>0}function dt(t){const e=t instanceof Date?t:new Date(t||Date.now()),n=Number.isNaN(e.getTime())?new Date:e,s=Math.max(1980,n.getFullYear()),a=Math.max(1,n.getMonth()+1),l=Math.max(1,n.getDate()),c=n.getHours(),r=n.getMinutes(),o=Math.floor(n.getSeconds()/2),u=(c&31)<<11|(r&63)<<5|o&31,h=(s-1980&127)<<9|(a&15)<<5|l&31;return{dosTime:u,dosDate:h}}function bt(t){const e=t.reduce((a,l)=>a+l.length,0),n=new Uint8Array(e);let s=0;return t.forEach(a=>{n.set(a,s),s+=a.length}),n}function b(t,e,n){t.setUint16(e,n&65535,!0)}function N(t,e,n){t.setUint32(e,n>>>0,!0)}function Dt(t){const e=new Uint8Array(30+t.nameBytes.length),n=new DataView(e.buffer);return N(n,0,67324752),b(n,4,et),b(n,6,0),b(n,8,0),b(n,10,t.dosTime),b(n,12,t.dosDate),N(n,14,t.crc32),N(n,18,t.data.length),N(n,22,t.data.length),b(n,26,t.nameBytes.length),b(n,28,0),e.set(t.nameBytes,30),e}function yt(t){const e=new Uint8Array(46+t.nameBytes.length),n=new DataView(e.buffer);return N(n,0,33639248),b(n,4,et),b(n,6,et),b(n,8,0),b(n,10,0),b(n,12,t.dosTime),b(n,14,t.dosDate),N(n,16,t.crc32),N(n,20,t.data.length),N(n,24,t.data.length),b(n,28,t.nameBytes.length),b(n,30,0),b(n,32,0),b(n,34,0),b(n,36,0),N(n,38,0),N(n,42,t.localHeaderOffset),e.set(t.nameBytes,46),e}function vt(t,e,n){const s=new Uint8Array(22),a=new DataView(s.buffer);return N(a,0,101010256),b(a,4,0),b(a,6,0),b(a,8,t),b(a,10,t),N(a,12,e),N(a,16,n),b(a,20,0),s}async function At(t){if(t==null)return new Uint8Array;if(t instanceof Uint8Array)return t;if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);if(t instanceof ArrayBuffer)return new Uint8Array(t);if(typeof Blob<"u"&&t instanceof Blob){const e=await t.arrayBuffer();return new Uint8Array(e)}return rt.encode(String(t))}function kt(t){const e=String(t||"").replace(/^\/+/,"").trim();return e?e.replace(/\\/g,"/"):null}function Et(t){return rt.encode(String(t??""))}async function St(t=[]){const e=[];for(const o of t){const u=kt(o==null?void 0:o.name);if(!u)continue;const h=await At(o==null?void 0:o.data),f=Et(u),{dosDate:g,dosTime:i}=dt(o==null?void 0:o.lastModified);e.push({name:u,nameBytes:f,data:h,crc32:gt(h),dosDate:g,dosTime:i,localHeaderOffset:0})}const n=[],s=[];let a=0;e.forEach(o=>{o.localHeaderOffset=a;const u=Dt(o);n.push(u,o.data),a+=u.length+o.data.length,s.push(yt(o))});const l=a,c=s.reduce((o,u)=>o+u.length,0),r=vt(e.length,c,l);return bt([...n,...s,r])}async function lt(t=[],e="application/zip"){const n=await St(t);return new Blob([n],{type:e})}async function le(t,e){const n=String(e||"download.bin").trim()||"download.bin",s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=n,document.body.append(a),a.click(),a.remove(),URL.revokeObjectURL(s)}function Nt(t){if(/^\d{4}-\d{2}$/.test(String(t||"")))return String(t);const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}const V='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';function ct(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function Ut(t){let e=t+1,n="";for(;e>0;){const s=(e-1)%26;n=String.fromCharCode(65+s)+n,e=Math.floor((e-1)/26)}return n}function $t(t,e){return`${Ut(t)}${e}`}function xt(t){const e=Number(t);return Number.isFinite(e)?e:null}function It(t,e,n){const s=$t(n,e);if(t==null||t==="")return`<c r="${s}" t="inlineStr"><is><t></t></is></c>`;const a=xt(t);return a!=null&&typeof t!="string"?`<c r="${s}"><v>${a}</v></c>`:a!=null&&/^-?\d+(?:[.,]\d+)?$/.test(String(t).trim())?`<c r="${s}"><v>${String(t).replace(",",".")}</v></c>`:`<c r="${s}" t="inlineStr"><is><t xml:space="preserve">${ct(t)}</t></is></c>`}function Tt(t){const e=t.map((n,s)=>{const a=s+1,l=n.map((c,r)=>It(c,a,r)).join("");return`<row r="${a}">${l}</row>`}).join("");return`${V}<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>${e}</sheetData></worksheet>`}function Rt(t){const e=t.map((n,s)=>`<sheet name="${ct(n.name)}" sheetId="${s+1}" r:id="rId${s+1}"/>`).join("");return`${V}<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets>${e}</sheets></workbook>`}function Pt(t){const e=t.map((n,s)=>`<Relationship Id="rId${s+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet${s+1}.xml"/>`).join("");return`${V}<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">${e}</Relationships>`}function Mt(t){const e=t.map((n,s)=>`<Override PartName="/xl/worksheets/sheet${s+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`).join("");return`${V}<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>${e}</Types>`}function _t(){return`${V}<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>`}function Ct(t){const e=[["code","severity","message","entityType","entityId"]];return(t||[]).forEach(n=>{e.push([n.code||"",n.severity||"",n.message||"",n.entityType||"",n.entityId||""])}),e}function wt(t){var g;const e=t.inventory||{},n=t.inventoryRows||[],s=t.deposits||[],a=t.arrivals||[],l=t.poLedger||[],c=[["Monat",((g=t.request)==null?void 0:g.month)||""],["Snapshot As Of",e.snapshotAsOf||""],["Warenwert EUR",e.totalValueEur],["Amazon Units",e.totalAmazonUnits],["3PL Units",e.total3plUnits],["In Transit Units",e.totalInTransitUnits],["Anzahlungen PO",s.length],["Wareneingaenge PO",a.length],["Anzahlungen+Ankunft PO",l.length],["Manual Override Used",e.manualOverrideUsed?"yes":"no"],["Quality Issues",(t.quality||[]).length]],r=[["SKU","Alias","Kategorie","Amazon Units","3PL Units","In Transit Units","Total Units","EK EUR","Warenwert EUR","Notiz"]];n.forEach(i=>{r.push([i.sku||"",i.alias||"",i.category||"",i.amazonUnits,i.threePLUnits,i.inTransitUnits,i.totalUnits,i.ekEur,i.rowValueEur,i.note||""])});const o=[["PO Number","Supplier","SKU Aliases","Payment Type","Planned EUR","Actual EUR","Paid Date","Due Date","Amount USD","ETD Date","ETA Date","Arrival Date","Invoice URL","Folder URL","Issues"]];s.forEach(i=>{o.push([i.poNumber||"",i.supplier||"",i.skuAliases||"",i.paymentType||"",i.plannedEur,i.actualEur,i.paidDate||"",i.dueDate||"",i.amountUsd,i.etdDate||"",i.etaDate||"",i.arrivalDate||"",i.invoiceUrl||"",i.folderUrl||"",(i.issues||[]).join(" | ")])});const u=[["PO Number","Supplier","SKU Aliases","Units","Goods USD","Goods EUR","ETD Date","ETA Date","Arrival Date","Transport","Issues"]];a.forEach(i=>{u.push([i.poNumber||"",i.supplier||"",i.skuAliases||"",i.units,i.goodsUsd,i.goodsEur,i.etdDate||"",i.etaDate||"",i.arrivalDate||"",i.transport||"",(i.issues||[]).join(" | ")])});const h=[["Month Marker","Month Marker Reason","PO Number","Supplier","SKU Aliases","Units","Deposit Actual EUR (Month)","Deposit Amount USD (Month)","ETD Date","ETA Date","Arrival Date","Arrival Source","Issues"]];l.forEach(i=>{h.push([i.monthMarker?"yes":"no",i.monthMarkerReason||"",i.poNumber||"",i.supplier||"",i.skuAliases||"",i.units,i.depositActualEurMonth,i.depositAmountUsdMonth,i.etdDate||"",i.etaDate||"",i.arrivalDate||"",i.arrivalSource||"",(i.issues||[]).join(" | ")])});const f=[{name:"Summary",rows:c},{name:"Warenbestand",rows:r},{name:"Anzahlungen_PO",rows:o},{name:"Wareneingang_PO",rows:u},{name:"Anzahlungen_Ankunft_PO",rows:h},{name:"Quality",rows:Ct(t.quality||[])}];if(Array.isArray(t.journalRows)&&t.journalRows.length){const i=[["month","entityType","poNumber","supplierName","skuAliases","paymentType","status","dueDate","paidDate","amountPlannedEur","amountActualEur","issues","paymentId"]];t.journalRows.forEach(m=>{i.push([m.month||"",m.entityType||"",m.poNumber||"",m.supplierName||"",m.skuAliases||"",m.paymentType||"",m.status||"",m.dueDate||"",m.paidDate||"",m.amountPlannedEur,m.amountActualEur,Array.isArray(m.issues)?m.issues.join(" | "):"",m.paymentId||""])}),f.push({name:"Zahlungsjournal",rows:i})}return f}async function Ot(t){const e=wt(t),n=[{name:"[Content_Types].xml",data:Mt(e)},{name:"_rels/.rels",data:_t()},{name:"xl/workbook.xml",data:Rt(e)},{name:"xl/_rels/workbook.xml.rels",data:Pt(e)}];return e.forEach((s,a)=>{n.push({name:`xl/worksheets/sheet${a+1}.xml`,data:Tt(s.rows||[])})}),lt(n,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")}function Lt(t){return String(t??"").replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}function Ft(t,e=110){const n=String(t||"").trim();if(!n)return[""];if(n.length<=e)return[n];const s=n.split(/\s+/),a=[];let l="";return s.forEach(c=>{const r=l?`${l} ${c}`:c;if(r.length<=e){l=r;return}if(l&&a.push(l),c.length>e){let o=0;for(;o<c.length;)a.push(c.slice(o,o+e)),o+=e;l="";return}l=c}),l&&a.push(l),a}function Bt(t){var h;const e=((h=t==null?void 0:t.request)==null?void 0:h.month)||"",n=(t==null?void 0:t.inventory)||{},s=Array.isArray(t==null?void 0:t.deposits)?t.deposits:[],a=Array.isArray(t==null?void 0:t.arrivals)?t.arrivals:[],l=Array.isArray(t==null?void 0:t.poLedger)?t.poLedger:[],c=Array.isArray(t==null?void 0:t.quality)?t.quality:[],r=[`Buchhaltungsbericht ${e}`,"","Warenbestand",`- Snapshot As Of: ${n.snapshotAsOf||"n/a"}`,`- Warenwert EUR: ${Number.isFinite(Number(n.totalValueEur))?Number(n.totalValueEur).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"n/a"}`,`- Amazon Units: ${Number(n.totalAmazonUnits||0).toLocaleString("de-DE")}`,`- 3PL Units: ${Number(n.total3plUnits||0).toLocaleString("de-DE")}`,`- In Transit Units: ${Number(n.totalInTransitUnits||0).toLocaleString("de-DE")}`,"","Anzahlungen (PO)",`- Anzahl Zeilen im Monat: ${s.length}`],o=s.reduce((f,g)=>f+(Number(g.actualEur)||0),0);r.push(`- Summe Ist EUR: ${o.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}`),r.push("-"),s.slice(0,12).forEach(f=>{r.push(`  ${f.poNumber||"PO"} | ${f.supplier||"-"} | paid ${f.paidDate||"n/a"} | EUR ${Number(f.actualEur||f.plannedEur||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}),s.length>12&&r.push(`  ... ${s.length-12} weitere Zeilen in XLSX/CSV`),r.push(""),r.push("Wareneingang (PO)"),r.push(`- Anzahl Zeilen im Monat: ${a.length}`);const u=a.reduce((f,g)=>f+(Number(g.units)||0),0);return r.push(`- Summe Units: ${u.toLocaleString("de-DE")}`),r.push("-"),a.slice(0,12).forEach(f=>{r.push(`  ${f.poNumber||"PO"} | ${f.supplier||"-"} | arrival ${f.arrivalDate||"n/a"} | units ${Number(f.units||0).toLocaleString("de-DE")}`)}),a.length>12&&r.push(`  ... ${a.length-12} weitere Zeilen in XLSX/CSV`),r.push(""),r.push("Anzahlungen + Wareneingang (PO)"),r.push(`- Anzahl Zeilen gesamt: ${l.length}`),r.push(`- Relevante Zeilen fÃ¼r ${e}: ${l.filter(f=>f.monthMarker).length}`),r.push("-"),l.slice(0,50).forEach(f=>{const g=f.monthMarker?"[MONAT]":"[     ]",i=Number(f.depositActualEurMonth||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),m=Number(f.depositAmountUsdMonth||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}),D=f.arrivalDate||f.etaDate||"n/a";r.push(`  ${g} ${f.poNumber||"PO"} | ${f.supplier||"-"} | EUR ${i} | USD ${m} | ETD ${f.etdDate||"n/a"} | ETA ${f.etaDate||"n/a"} | Arrival ${D}`)}),l.length>50&&r.push(`  ... ${l.length-50} weitere Zeilen in XLSX/CSV`),r.push(""),r.push("Datenqualitaet"),r.push(`- Hinweise gesamt: ${c.length}`),c.slice(0,20).forEach(f=>{r.push(`  [${f.severity||"info"}] ${f.code||"ISSUE"}: ${f.message||""}`)}),c.length>20&&r.push(`  ... ${c.length-20} weitere Hinweise`),r.flatMap(f=>Ft(f,110))}function jt(t){const c=Math.floor(53.57142857142857),r=[];for(let p=0;p<t.length;p+=c)r.push(t.slice(p,p+c));r.length||r.push([""]);const o=[];function u(p){return o.push(p),o.length}const h=u("<< /Type /Pages /Kids [] /Count 0 >>"),f=u(`<< /Type /Catalog /Pages ${h} 0 R >>`),g=u("<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>"),i=[];r.forEach(p=>{const E=["BT","/F1 11 Tf","1 0 0 1 40 800 Tm"];p.forEach((d,x)=>{x>0&&E.push("0 -14 Td"),E.push(`(${Lt(d)}) Tj`)}),E.push("ET");const k=E.join(`
`),$=`<< /Length ${k.length} >>
stream
${k}
endstream`,S=u($),M=`<< /Type /Page /Parent ${h} 0 R /MediaBox [0 0 595 842] /Resources << /Font << /F1 ${g} 0 R >> >> /Contents ${S} 0 R >>`,P=u(M);i.push(P)});const m=i.map(p=>`${p} 0 R`).join(" ");o[h-1]=`<< /Type /Pages /Kids [${m}] /Count ${i.length} >>`;let D=0;const y=[],A=[0],v=p=>{y.push(p),D+=p.length};v(`%PDF-1.4
`),o.forEach((p,E)=>{const k=E+1;A[k]=D,v(`${k} 0 obj
${p}
endobj
`)});const U=D;v(`xref
0 ${o.length+1}
`),v(`0000000000 65535 f 
`);for(let p=1;p<=o.length;p+=1)v(`${String(A[p]).padStart(10,"0")} 00000 n 
`);return v(`trailer
<< /Size ${o.length+1} /Root ${f} 0 R >>
startxref
${U}
%%EOF`),new TextEncoder().encode(y.join(""))}function zt(t){const e=Bt(t),n=jt(e);return new Blob([n],{type:"application/pdf"})}const st={entityLabel:"PO",numberField:"poNo"};function ft(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function at(t){const e=String(t||"").trim();return/^\d{4}-\d{2}$/.test(e)?e:ft()}function w(t){const e=pt(t);return Number.isFinite(e)?Number(e):null}function _(t){if(!t)return null;if(t instanceof Date&&!Number.isNaN(t.getTime()))return t;const e=String(t).trim();if(!e)return null;const n=e.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);if(n){const l=Number(n[1]),c=Number(n[2]),r=Number(n[3]),o=new Date(r,c-1,l);return Number.isNaN(o.getTime())?null:o}const s=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(s){const l=Number(s[1]),c=Number(s[2]),r=Number(s[3]),o=new Date(l,c-1,r);return Number.isNaN(o.getTime())?null:o}const a=new Date(e);return Number.isNaN(a.getTime())?null:a}function R(t){const e=_(t);if(!e)return null;const n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${n}-${s}-${a}`}function K(t){const e=_(t);return e?`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`:null}function Vt(t){const e=at(t),[n,s]=e.split("-").map(Number),a=new Date(n,s,0);return R(a)}function W(t){const e=(t==null?void 0:t.settings)||{};return{fxRate:w(e.fxRate)||1,fxFeePct:w(e.fxFeePct)||0,eurUsdRate:w(e.eurUsdRate)||0,dutyRatePct:w(e.dutyRatePct)||0,dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:w(e.eustRatePct)||0,vatRefundEnabled:e.vatRefundEnabled!==!1,vatRefundLagMonths:Number(e.vatRefundLagMonths||0)||0,freightLagDays:Number(e.freightLagDays||0)||0,defaultCurrency:String(e.defaultCurrency||"EUR").toUpperCase(),cny:e.cny&&typeof e.cny=="object"?{start:String(e.cny.start||""),end:String(e.cny.end||"")}:{start:"",end:""},cnyBlackoutByYear:e.cnyBlackoutByYear&&typeof e.cnyBlackoutByYear=="object"?structuredClone(e.cnyBlackoutByYear):{}}}function L(t){return String(t||"").trim().toLowerCase()}function H(t,e){const n=L((t==null?void 0:t.supplierId)||(t==null?void 0:t.supplier)||(t==null?void 0:t.supplierName));if(n&&e.has(n))return e.get(n);const s=(t==null?void 0:t.supplierName)||(t==null?void 0:t.supplier)||"";return s?String(s):"-"}function Wt(t){const e=new Map;return(Array.isArray(t==null?void 0:t.suppliers)?t.suppliers:[]).forEach(n=>{const s=n||{},a=String(s.name||"").trim();if(!a)return;const l=L(s.id),c=L(a);l&&e.set(l,a),c&&e.set(c,a)}),e}function Gt(t){const e=new Map,n=new Map,s=new Map;return(Array.isArray(t==null?void 0:t.productCategories)?t.productCategories:[]).forEach(a=>{const l=a||{},c=String(l.id||"").trim();c&&s.set(c,String(l.name||"Ohne Kategorie"))}),(Array.isArray(t==null?void 0:t.products)?t.products:[]).forEach(a=>{const l=a||{},c=String(l.sku||"").trim();if(!c)return;const r=L(c),o=String(l.alias||c).trim();e.set(r,l),n.set(r,o||c)}),{productBySku:e,aliasBySku:n,categoryMap:s}}function X(t,e){const n=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[],s=n.length?n.map(l=>String((l==null?void 0:l.sku)||"").trim()).filter(Boolean):[String((t==null?void 0:t.sku)||"").trim()].filter(Boolean);return Array.from(new Set(s.map(l=>e.get(L(l))||l))).join(", ")||"-"}function O(t){const e=w(t);return Number.isFinite(e)?Math.max(0,Math.round(Number(e))):0}function T(t){const e=w(t);return Number.isFinite(e)?Number(e):null}function q(t){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];return e.length?e:t!=null&&t.sku?[{sku:t.sku,units:t.units||0}]:[]}function it(t){const e=T((t==null?void 0:t.goodsUsd)||(t==null?void 0:t.goodsAmountUsd));if(Number.isFinite(e))return e;const n=q(t);if(!n.length)return null;let s=0,a=!1;return n.forEach(l=>{const c=O(l.units),r=T(l.unitCostUsd||l.unitPriceUsd||(t==null?void 0:t.unitCostUsd)),o=T(l.unitExtraUsd),u=T(l.extraFlatUsd),h=Number.isFinite(r)?r:null;if(!Number.isFinite(h))return;const f=Number.isFinite(o)?o:0,g=Number.isFinite(u)?u:0,i=c*(h+f)+g;Number.isFinite(i)&&(s+=i,a=!0)}),a?s:null}function Kt(t,e,n){const s=T((t==null?void 0:t.goodsEur)||(t==null?void 0:t.goodsAmountEur));if(Number.isFinite(s))return s;if(!Number.isFinite(n))return null;const a=T(t==null?void 0:t.fxOverride)||T(e==null?void 0:e.fxRate);return!Number.isFinite(a)||a<=0?null:n/a}function Y(t){const e=R((t==null?void 0:t.etdManual)||(t==null?void 0:t.etdDate));if(e)return e;const n=_(t==null?void 0:t.orderDate);if(!n)return null;const s=Math.max(0,Number((t==null?void 0:t.prodDays)||0)),a=new Date(n.getTime());return a.setDate(a.getDate()+s),R(a)}function Z(t){const e=R((t==null?void 0:t.etaManual)||(t==null?void 0:t.etaDate)||(t==null?void 0:t.eta));if(e)return e;const n=R(t==null?void 0:t.etaComputed);if(n)return n;const s=_(Y(t));if(!s)return null;const a=Math.max(0,Number((t==null?void 0:t.transitDays)||0)),l=new Date(s.getTime());return l.setDate(l.getDate()+a),R(l)}function J(t){const e=[{key:"arrivalDateDe",mode:"de"},{key:"arrivalDate",mode:"auto"},{key:"etaManual",mode:"auto"},{key:"etaDate",mode:"auto"},{key:"eta",mode:"auto"}];for(const s of e){const a=t==null?void 0:t[s.key];if(!a)continue;const l=s.mode==="de"?_(String(a).replace(/\s+/g,"")):_(a),c=R(l);if(c)return{date:c,source:s.key}}const n=Z(t);return n?{date:n,source:"etaComputed"}:{date:null,source:"missing"}}function Ht(t,e){var s;return(Array.isArray((s=t==null?void 0:t.inventory)==null?void 0:s.snapshots)?t.inventory.snapshots:[]).find(a=>String((a==null?void 0:a.month)||"")===e)||null}function Xt(t,e){var l;const n=((l=t==null?void 0:t.template)==null?void 0:l.fields)||(t==null?void 0:t.template)||{},s=T((n==null?void 0:n.unitPriceUsd)??(t==null?void 0:t.unitPriceUsd));if(!Number.isFinite(s))return null;const a=String((n==null?void 0:n.currency)||(e==null?void 0:e.defaultCurrency)||"EUR").toUpperCase();if(a==="EUR")return s;if(a==="USD"){const c=T(e==null?void 0:e.fxRate);return!Number.isFinite(c)||c<=0?null:s/c}return null}function qt(t){const[e,n]=at(t).split("-").map(Number),s=new Date(e,n,0);return s.setHours(23,59,59,999),s}function Yt(t){const e=J(t);return _(e.date)}function Zt(t,e){const n=qt(e),s=new Map;return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(a=>{if(!a||a.archived||String(a.status||"").toUpperCase()==="CANCELLED")return;const l=_(a.orderDate);if(l&&l>n)return;const c=Yt(a);c&&c<=n||q(a).forEach(r=>{const o=String((r==null?void 0:r.sku)||"").trim();if(!o)return;const u=L(o),h=O(r==null?void 0:r.units);h&&s.set(u,(s.get(u)||0)+h)})}),s}function C(t,e,n){const s=`${n.code||"ISSUE"}|${n.entityType||""}|${n.entityId||""}|${n.message||""}`;e.has(s)||(e.add(s),t.push(n))}function Jt(t,e,n,s,a,l){const c=e.month,r=W(t),o=Ht(t,c),u=Array.isArray(o==null?void 0:o.items)?o.items:[],h=(o==null?void 0:o.asOfDate)||Vt(c),f=Zt(t,c),g=[];let i=0,m=0,D=0,y=0,A=!1;u.forEach(p=>{const E=String((p==null?void 0:p.sku)||"").trim();if(!E)return;const k=L(E),$=s.productBySku.get(k)||{},S=String($.alias||E),M=s.categoryMap.get(String($.categoryId||""))||"Ohne Kategorie",P=O(p==null?void 0:p.amazonUnits),d=O(p==null?void 0:p.threePLUnits),x=O(p==null?void 0:p.inTransitUnits)||f.get(k)||0,G=P+d+x,B=Xt($,r),F=Number.isFinite(B)?G*B:null;Number.isFinite(B)||C(a,l,{code:"MISSING_EK_PRICE",severity:"warning",message:`Kein EK-Preis fuer SKU ${E} vorhanden.`,entityType:"INVENTORY",entityId:E}),i+=P,m+=d,D+=x,Number.isFinite(F)&&(y+=F,A=!0),g.push({sku:E,alias:S,category:M,amazonUnits:P,threePLUnits:d,inTransitUnits:x,totalUnits:G,ekEur:B,rowValueEur:F,note:String((p==null?void 0:p.note)||"")})}),o||C(a,l,{code:"MISSING_SNAPSHOT",severity:"warning",message:`Kein Inventory-Snapshot fuer ${c} gefunden.`,entityType:"INVENTORY",entityId:c});let v=!1;return(!A||!o)&&Number.isFinite(Number(n==null?void 0:n.inventoryValueOverrideEur))&&(y=Number(n.inventoryValueOverrideEur),v=!0),{summary:{month:c,snapshotAsOf:h,totalValueEur:A||v?y:null,totalAmazonUnits:i,total3plUnits:m,totalInTransitUnits:D,manualOverrideUsed:v,issues:a.filter(p=>p.entityType==="INVENTORY").map(p=>p.code)},rows:g}}function Qt(t,e,n,s,a,l){const c=W(t),r=e.month,o=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(u=>{if(!u||u.archived||String(u.status||"").toUpperCase()==="CANCELLED")return;const h=structuredClone(u),f=nt(h,st,c,(t==null?void 0:t.payments)||[]),g=it(u);f.forEach(i=>{const m=String((i==null?void 0:i.status)||"").toUpperCase(),D=String((i==null?void 0:i.typeLabel)||"");if(!/deposit|anzahlung/i.test(D)||(m==="PAID"&&!(i!=null&&i.paidDate)&&C(a,l,{code:"PAID_WITHOUT_DATE",severity:"warning",message:`PO ${u.poNo||u.id||"-"}: Deposit ist bezahlt, aber paidDate fehlt.`,entityType:"PO",entityId:String(u.id||u.poNo||"")}),m!=="PAID")||K(i==null?void 0:i.paidDate)!==r)return;const A=(Array.isArray(u==null?void 0:u.milestones)?u.milestones:[]).find(S=>(S==null?void 0:S.id)===(i==null?void 0:i.id)),v=T(A==null?void 0:A.percent),U=Number.isFinite(g)&&Number.isFinite(v)?g*v/100:null,p=Number.isFinite(Number(i==null?void 0:i.paidEurActual))?Number(i.paidEurActual):null,E=Number.isFinite(Number(i==null?void 0:i.plannedEur))?Number(i.plannedEur):null,k=[];Number.isFinite(U)||k.push("MISSING_USD"),Number.isFinite(p)||k.push("MISSING_ACTUAL_EUR"),!(i!=null&&i.invoiceDriveUrl)&&!(i!=null&&i.invoiceFolderDriveUrl)&&k.push("MISSING_INVOICE_LINK"),k.forEach(S=>{C(a,l,{code:S,severity:S==="MISSING_ACTUAL_EUR"?"warning":"info",message:`PO ${u.poNo||u.id||"-"}: ${S}`,entityType:"PO",entityId:String(u.id||u.poNo||"")})});const $=J(u);o.push({poNumber:String(u.poNo||u.id||""),supplier:H(u,s),skuAliases:X(u,n.aliasBySku),paymentType:"Deposit",plannedEur:E,actualEur:p,paidDate:R(i==null?void 0:i.paidDate),dueDate:R(i==null?void 0:i.dueDate),amountUsd:U,etdDate:Y(u),etaDate:Z(u),arrivalDate:$.date,invoiceUrl:(i==null?void 0:i.invoiceDriveUrl)||"",folderUrl:(i==null?void 0:i.invoiceFolderDriveUrl)||"",issues:k})})}),o.sort((u,h)=>String(u.paidDate||"").localeCompare(String(h.paidDate||"")))}function te(t,e,n,s,a,l){const c=W(t),r=e.month,o=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(u=>{if(!u||u.archived||String(u.status||"").toUpperCase()==="CANCELLED")return;const h=J(u);if(!h.date){C(a,l,{code:"MISSING_ARRIVAL_DATE",severity:"warning",message:`PO ${u.poNo||u.id||"-"}: kein Arrival/ETA Datum vorhanden.`,entityType:"PO",entityId:String(u.id||u.poNo||"")});return}if(K(h.date)!==r)return;const g=q(u).reduce((y,A)=>y+O(A==null?void 0:A.units),0),i=it(u),m=Kt(u,c,i),D=[];Number.isFinite(i)||D.push("MISSING_GOODS_USD"),Number.isFinite(m)||D.push("MISSING_GOODS_EUR"),h.source!=="arrivalDate"&&h.source!=="arrivalDateDe"&&D.push("ARRIVAL_FROM_ETA"),D.forEach(y=>{C(a,l,{code:y,severity:y.startsWith("MISSING")?"warning":"info",message:`PO ${u.poNo||u.id||"-"}: ${y}`,entityType:"PO",entityId:String(u.id||u.poNo||"")})}),o.push({poNumber:String(u.poNo||u.id||""),supplier:H(u,s),skuAliases:X(u,n.aliasBySku),units:g,goodsUsd:i,goodsEur:m,etdDate:Y(u),etaDate:Z(u),arrivalDate:h.date,transport:String(u.transport||""),issues:D})}),o.sort((u,h)=>String(u.arrivalDate||"").localeCompare(String(h.arrivalDate||"")))}function ee(t,e,n,s,a,l){const c=W(t),r=e.month,o=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(u=>{if(!u||u.archived||String(u.status||"").toUpperCase()==="CANCELLED")return;const h=structuredClone(u),f=nt(h,st,c,(t==null?void 0:t.payments)||[]),g=it(u),i=J(u),m=q(u).reduce((d,x)=>d+O(x==null?void 0:x.units),0);let D=0,y=!1,A=0,v=!1;f.forEach(d=>{const x=String((d==null?void 0:d.status)||"").toUpperCase(),G=String((d==null?void 0:d.typeLabel)||"");if(!/deposit|anzahlung/i.test(G)||x!=="PAID"||K(d==null?void 0:d.paidDate)!==r)return;const F=Number(d==null?void 0:d.paidEurActual);Number.isFinite(F)&&(D+=F,y=!0);const Q=(Array.isArray(u==null?void 0:u.milestones)?u.milestones:[]).find(tt=>(tt==null?void 0:tt.id)===(d==null?void 0:d.id)),ut=T(Q==null?void 0:Q.percent);Number.isFinite(g)&&Number.isFinite(ut)&&(A+=g*ut/100,v=!0)});const U=i.source==="arrivalDate"||i.source==="arrivalDateDe",p=i.date,E=K(p),k=y||v,$=E===r,S=k||$;let M="none";k&&$?M="deposit+arrival":k?M="deposit":$&&(M="arrival");const P=[];p?U||P.push("ARRIVAL_FROM_ETA"):(P.push("MISSING_ARRIVAL_DATE"),C(a,l,{code:"MISSING_ARRIVAL_DATE",severity:"warning",message:`PO ${u.poNo||u.id||"-"}: kein Arrival/ETA Datum vorhanden.`,entityType:"PO",entityId:String(u.id||u.poNo||"")})),o.push({poNumber:String(u.poNo||u.id||""),supplier:H(u,s),skuAliases:X(u,n.aliasBySku),units:m,depositActualEurMonth:y?D:null,depositAmountUsdMonth:v?A:null,etdDate:Y(u),etaDate:Z(u),arrivalDate:p,arrivalSource:U?"actual":p?"eta":"missing",monthMarker:S,monthMarkerReason:M,issues:P})}),o.sort((u,h)=>{if(u.monthMarker!==h.monthMarker)return u.monthMarker?-1:1;const f=String(u.arrivalDate||u.etaDate||"9999-12-31"),g=String(h.arrivalDate||h.etaDate||"9999-12-31"),i=f.localeCompare(g);return i!==0?i:String(u.poNumber||"").localeCompare(String(h.poNumber||""))})}function ne(t,e){const n=String(t||"").toLowerCase();return e==="fx_fee"||n.includes("fx")?null:e==="freight"||n.includes("shipping")||n.includes("fracht")?"Fracht":e==="eust"||n.includes("eust")?"EUSt":n.includes("balance2")||n.includes("balance 2")||n.includes("second balance")?"Balance2":n.includes("balance")||n.includes("rest")?"Balance":n.includes("deposit")||n.includes("anzahlung")?"Deposit":"Other"}function se(t,e,n,s){const a=W(t),l=e.month,c=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(r=>{if(!r||r.archived||String(r.status||"").toUpperCase()==="CANCELLED")return;const o=H(r,n),u=X(r,s.aliasBySku);nt(structuredClone(r),st,a,(t==null?void 0:t.payments)||[]).forEach(f=>{const g=ne((f==null?void 0:f.typeLabel)||(f==null?void 0:f.label),f==null?void 0:f.eventType);if(!g)return;const i=String((f==null?void 0:f.status)||"").toUpperCase()==="PAID"?"PAID":"OPEN",m=R(f==null?void 0:f.paidDate),D=R(f==null?void 0:f.dueDate),y=i==="PAID"?String(m||"").slice(0,7):String(D||"").slice(0,7);if(l&&y!==l)return;const A=Number.isFinite(Number(f==null?void 0:f.plannedEur))?Number(f.plannedEur):null,v=Number.isFinite(Number(f==null?void 0:f.paidEurActual))?Number(f.paidEurActual):null,U=[];i==="PAID"&&v==null&&U.push("MISSING_ACTUAL_AMOUNT"),c.push({month:y,entityType:"PO",poNumber:String(r.poNo||r.id||""),supplierName:o,skuAliases:u,paymentType:g,status:i,dueDate:D,paidDate:m,amountPlannedEur:A,amountActualEur:v,issues:U,paymentId:String((f==null?void 0:f.paymentId)||"")})})}),c.sort((r,o)=>{const u=r.dueDate||r.paidDate||"",h=o.dueDate||o.paidDate||"";return u.localeCompare(h)})}function I(t){if(t==null||t==="")return"";const e=Number(t);return Number.isFinite(e)?e.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2,useGrouping:!1}):""}function ot(t,e=";"){const n=String(t??"");return n?!n.includes(e)&&!n.includes('"')&&!n.includes(`
`)?n:`"${n.replace(/\"/g,'""')}"`:""}function z(t,e,n=";"){const s=e.map(l=>ot(l.label,n)).join(n),a=t.map(l=>e.map(c=>{const r=c.format?c.format(l[c.key],l):l[c.key];return ot(r,n)}).join(n));return[s,...a].join(`
`)}function ae(t,e={}){const n=t.request.month,s=String(e.workspaceName||t.workspaceName||"Workspace"),a=[`buchhaltung_${n}_bericht.pdf`,`buchhaltung_${n}.xlsx`,`buchhaltung_${n}_warenbestand.csv`,`buchhaltung_${n}_anzahlungen_po.csv`,`buchhaltung_${n}_wareneingang_po.csv`,`buchhaltung_${n}_anzahlung_wareneingang_po.csv`];t.request.scope==="core_plus_journal"&&a.push(`buchhaltung_${n}_zahlungsjournal.csv`),a.push(`buchhaltung_${n}_email.txt`);const l=`Unterlagen Buchhaltung ${n} - Mandant ${s}`,c=[`Betreff: ${l}`,"","Hallo,","",`anbei das Buchhalter-Paket fuer ${n}.`,"","Kurzstatus:",`- Warenbestand zum Monatsende (${t.inventory.snapshotAsOf||"n/a"}): ${Number.isFinite(Number(t.inventory.totalValueEur))?`${Number(t.inventory.totalValueEur).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} EUR`:"kein Wert verfuegbar"}`,`- Lieferanzahlungen (PO, paidDate im Monat): ${t.deposits.length} Zeilen`,`- Wareneingaenge (PO, Arrival/ETA im Monat): ${t.arrivals.length} Zeilen`,`- Kombiliste Anzahlungen + Wareneingang (PO): ${(t.poLedger||[]).length} Zeilen`,`- Datenqualitaetshinweise: ${(t.quality||[]).length}`,"","Anlagen:",...a.map(r=>`- ${r}`),"","Viele Gruesse"];return{subject:l,text:c.join(`
`),attachments:a}}function ht(t={}){return{month:at(t.month),scope:t.scope==="core_plus_journal"?"core_plus_journal":"core",includeCsv:t.includeCsv!==!1,includeXlsx:t.includeXlsx!==!1,includePdf:t.includePdf!==!1,includeEmailDraft:t.includeEmailDraft!==!1,poOnly:!0,mode:"paid_and_arrival"}}function ie(t,e={},n={}){const s=ht(e),a=t&&typeof t=="object"?t:{},l=Wt(a),c=Gt(a),r=[],o=new Set,u=Jt(a,s,n,c,r,o),h=Qt(a,s,c,l,r,o),f=te(a,s,c,l,r,o),g=ee(a,s,c,l,r,o);let i=[];return s.scope==="core_plus_journal"&&(i=se(a,s,l,c)),!(u.summary.totalValueEur!=null)&&!Number.isFinite(Number(n.inventoryValueOverrideEur))&&C(r,o,{code:"MISSING_INVENTORY_VALUE",severity:"warning",message:"Warenwert konnte nicht vollstaendig aus Snapshot/EK ermittelt werden.",entityType:"INVENTORY",entityId:s.month}),{request:s,inventory:u.summary,inventoryRows:u.rows,deposits:h,arrivals:f,poLedger:g,journalRows:i,quality:r}}function ue(t){const e=z(t.inventoryRows||[],[{key:"sku",label:"sku"},{key:"alias",label:"alias"},{key:"category",label:"category"},{key:"amazonUnits",label:"amazonUnits"},{key:"threePLUnits",label:"threePLUnits"},{key:"inTransitUnits",label:"inTransitUnits"},{key:"totalUnits",label:"totalUnits"},{key:"ekEur",label:"ekEur",format:I},{key:"rowValueEur",label:"rowValueEur",format:I},{key:"note",label:"note"}]),n=z(t.deposits||[],[{key:"poNumber",label:"poNumber"},{key:"supplier",label:"supplier"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"plannedEur",label:"plannedEur",format:I},{key:"actualEur",label:"actualEur",format:I},{key:"paidDate",label:"paidDate"},{key:"dueDate",label:"dueDate"},{key:"amountUsd",label:"amountUsd",format:I},{key:"etdDate",label:"etdDate"},{key:"etaDate",label:"etaDate"},{key:"arrivalDate",label:"arrivalDate"},{key:"invoiceUrl",label:"invoiceUrl"},{key:"folderUrl",label:"folderUrl"},{key:"issues",label:"issues",format:c=>Array.isArray(c)?c.join("|"):""}]),s=z(t.arrivals||[],[{key:"poNumber",label:"poNumber"},{key:"supplier",label:"supplier"},{key:"skuAliases",label:"skuAliases"},{key:"units",label:"units"},{key:"goodsUsd",label:"goodsUsd",format:I},{key:"goodsEur",label:"goodsEur",format:I},{key:"etdDate",label:"etdDate"},{key:"etaDate",label:"etaDate"},{key:"arrivalDate",label:"arrivalDate"},{key:"transport",label:"transport"},{key:"issues",label:"issues",format:c=>Array.isArray(c)?c.join("|"):""}]),a=z(t.poLedger||[],[{key:"monthMarker",label:"monthMarker",format:c=>c?"yes":"no"},{key:"monthMarkerReason",label:"monthMarkerReason"},{key:"poNumber",label:"poNumber"},{key:"supplier",label:"supplier"},{key:"skuAliases",label:"skuAliases"},{key:"units",label:"units"},{key:"depositActualEurMonth",label:"depositActualEurMonth",format:I},{key:"depositAmountUsdMonth",label:"depositAmountUsdMonth",format:I},{key:"etdDate",label:"etdDate"},{key:"etaDate",label:"etaDate"},{key:"arrivalDate",label:"arrivalDate"},{key:"arrivalSource",label:"arrivalSource"},{key:"issues",label:"issues",format:c=>Array.isArray(c)?c.join("|"):""}]);let l=null;return Array.isArray(t.journalRows)&&t.journalRows.length&&(l=z(t.journalRows,[{key:"month",label:"month"},{key:"entityType",label:"entityType"},{key:"poNumber",label:"poNumber"},{key:"supplierName",label:"supplierName"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"status",label:"status"},{key:"dueDate",label:"dueDate"},{key:"paidDate",label:"paidDate"},{key:"amountPlannedEur",label:"amountPlannedEur",format:I},{key:"amountActualEur",label:"amountActualEur",format:I},{key:"issues",label:"issues",format:c=>Array.isArray(c)?c.join("|"):""},{key:"paymentId",label:"paymentId"}])),{inventoryCsv:e,depositsCsv:n,arrivalsCsv:s,poLedgerCsv:a,journalCsv:l}}async function ce(t,e={},n={}){const s=ie(t,e,n),a=Nt(s.request.month),l=ae(s,n),c=ue(s),r={pdf:`buchhaltung_${a}_bericht.pdf`,xlsx:`buchhaltung_${a}.xlsx`,csvInventory:`buchhaltung_${a}_warenbestand.csv`,csvDeposits:`buchhaltung_${a}_anzahlungen_po.csv`,csvArrivals:`buchhaltung_${a}_wareneingang_po.csv`,csvPoLedger:`buchhaltung_${a}_anzahlung_wareneingang_po.csv`,csvJournal:`buchhaltung_${a}_zahlungsjournal.csv`,emailTxt:`buchhaltung_${a}_email.txt`,zip:`buchhaltung_${a}_paket.zip`},o={};s.request.includePdf&&(o.pdfReport=zt(s)),s.request.includeXlsx&&(o.xlsxWorkbook=await Ot(s)),s.request.includeCsv&&(o.csvInventory=new Blob([c.inventoryCsv],{type:"text/csv;charset=utf-8"}),o.csvDeposits=new Blob([c.depositsCsv],{type:"text/csv;charset=utf-8"}),o.csvArrivals=new Blob([c.arrivalsCsv],{type:"text/csv;charset=utf-8"}),o.csvPoLedger=new Blob([c.poLedgerCsv],{type:"text/csv;charset=utf-8"}),c.journalCsv&&(o.csvJournal=new Blob([c.journalCsv],{type:"text/csv;charset=utf-8"}))),s.request.includeEmailDraft&&(o.emailDraftTxt=new Blob([l.text],{type:"text/plain;charset=utf-8"}));const u=[];o.pdfReport&&u.push({name:r.pdf,data:o.pdfReport}),o.xlsxWorkbook&&u.push({name:r.xlsx,data:o.xlsxWorkbook}),o.csvInventory&&u.push({name:r.csvInventory,data:o.csvInventory}),o.csvDeposits&&u.push({name:r.csvDeposits,data:o.csvDeposits}),o.csvArrivals&&u.push({name:r.csvArrivals,data:o.csvArrivals}),o.csvPoLedger&&u.push({name:r.csvPoLedger,data:o.csvPoLedger}),o.csvJournal&&u.push({name:r.csvJournal,data:o.csvJournal}),o.emailDraftTxt&&u.push({name:r.emailTxt,data:o.emailDraftTxt});const h=await lt(u,"application/zip");return{...s,emailDraft:l,fileNames:r,files:o,zipBlob:h,zipFileName:r.zip}}function fe(t=ft()){return ht({month:t})}export{ce as a,ie as b,fe as c,le as t};
