import{ab as _t,L as Vt,t as c,K as Wt,k as t,T as ce,J as qt,N as j,U as Gt,M as O,I as Ce,S as Ee,V as Qt}from"./index-BX0hCHd9.js";import{b as Zt}from"./abcClassification-CppDRep4.js";import{r as Jt,a as Xt,c as Yt,g as Y}from"./inventoryProjection-_R2jh3XS.js";import{T as bt}from"./TanStackGrid-BGkv20_p.js";import{S as es}from"./SkuAliasCell-DitLq2As.js";import{c as ee,n as N,a as ts,m as ss,f as W,d as te}from"./months-DiLwPhVv.js";import{b as ns,c as rs,s as os}from"./categoryOrder-C77cYWrY.js";import{e as as,g as is}from"./forecastVersioning-DR49vPk8.js";import{e as ls,r as cs,f as us}from"./orderUtils-BRCvVsAW.js";import{h as kt,g as xt,s as St}from"./uiPrefs-CxTlE9qM.js";import{u as ds,C as Ke}from"./workspace-C5RCXX1l.js";import{T as Mt}from"./index-DVmxEQnU.js";import{a as Ct}from"./index-BZ9rJQ5G.js";import{S as At}from"./index-DzJjwXuy.js";import{C as hs}from"./index-D7NwOxsn.js";import{R as Ae}from"./index-J71TIXUx.js";import{R as ms}from"./InfoCircleOutlined-DtNRuN3d.js";import{C as Ut}from"./Collapse-DF_Cuh80.js";const{Paragraph:fs,Text:m,Title:$e}=qt,Ft=[6,12,18];function ps(a){if(!a||typeof a!="object")return{toVersionId:null,foConflictsOpen:0};const o=a;return{toVersionId:o.toVersionId==null?null:String(o.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(o.foConflictsOpen||0)))}}function gs(a){(!a.inventory||typeof a.inventory!="object")&&(a.inventory={snapshots:[],settings:{projectionMonths:12,safetyDays:60}});const o=a.inventory;Array.isArray(o.snapshots)||(o.snapshots=[]),(!o.settings||typeof o.settings!="object")&&(o.settings={projectionMonths:12,safetyDays:60})}function se(a){const o=Number(a);return Number.isFinite(o)?Math.max(0,Math.round(o)):0}function M(a){return Number.isFinite(a)?Math.round(Number(a)).toLocaleString("de-DE"):"—"}function ne(a){if(!a)return"—";const[o,h,l]=String(a).split("-").map(Number);if(!o||!h||!l)return"—";const k=new Date(Date.UTC(o,h-1,l));return Number.isNaN(k.getTime())?"—":k.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Re(a){const o={};return Array.isArray(a)&&a.forEach(h=>{const l=h||{},k=String(l.sku||"").trim();k&&(o[k]={amazonUnits:se(l.amazonUnits),threePLUnits:se(l.threePLUnits),note:String(l.note||"")})}),o}function ys(){return new Date().toISOString()}function js(a,o){var C;const h=((C=a.inventory)==null?void 0:C.snapshots)||[],l=N(o);return l&&h.find(x=>N(x.month)===l)||null}function Nt(a,o){var C;const h=N(o);if(!h)return null;const l=(((C=a.inventory)==null?void 0:C.snapshots)||[]).map(x=>x).filter(x=>N(x.month)).sort((x,w)=>String(N(x.month)).localeCompare(String(N(w.month))));let k=null;return l.forEach(x=>{const w=N(x.month);w&&w<h&&(k=x)}),k}function vs(a){var h;const o=(((h=a.inventory)==null?void 0:h.snapshots)||[]).map(l=>N(l.month)).filter(Boolean);return o.length?(o.sort((l,k)=>l.localeCompare(k)),o[o.length-1]||null):null}function Dt(a,o){const h=new Map;a.forEach(k=>{var x;const C=k.categoryLabel||"Ohne Kategorie";h.has(C)||h.set(C,[]),(x=h.get(C))==null||x.push(k)});const l=Array.from(h.entries()).map(([k,C])=>({key:k,label:k,rows:C.sort((x,w)=>{const T=x.alias.localeCompare(w.alias,"de-DE",{sensitivity:"base"});return T!==0?T:x.sku.localeCompare(w.sku,"de-DE",{sensitivity:"base"})})}));return os(l,o)}function bs(a){return/^\d{4}-\d{2}$/.test(a)?`${a}-01`:null}function Ue(a){const o=Number(a);return!Number.isFinite(o)||o<=0?null:o}function ks(a,o){var T;const h=Ue(a==null?void 0:a.productionLeadTimeDaysDefault)??Ue(o.defaultProductionLeadTimeDays)??45,l=(T=a==null?void 0:a.template)==null?void 0:T.fields,k=String((l==null?void 0:l.transportMode)??(a==null?void 0:a.transportMode)??"sea").toLowerCase(),C=o.transportLeadTimesDays||{},x=Ue(C[k])??Ue(C.sea)??45,w=Number(o.defaultBufferDays??0);return Math.max(0,Math.round(h+x+(Number.isFinite(w)?w:0)))}function xs(a){return a==="doh"?"DOH zeigt die Reichweite des projizierten Monatsendbestands in Tagen.":a==="plan"?"Plan zeigt den geplanten Monatsabsatz (Forecast) je SKU.":"Units zeigt den projizierten Monatsendbestand je SKU inklusive Inbound-Wirkung."}function wt(a){return a==="revenue_6m"?"ABC-Basis: Umsatz (6 Monate)":a==="units_6m_fallback"?"ABC-Basis: Units-Fallback (6 Monate)":"ABC-Basis: keine Forecast-Daten"}function Ss(a,o){const h=String(a||"C").toUpperCase();return o==="safety-negative"?h==="A"?6:h==="B"?4:2:o==="safety-low"?h==="A"?3:h==="B"?2:1:0}function Ms(a){const o=String(a||"").trim().toLowerCase();return o==="oos"?"oos":o==="under_safety"?"under_safety":"all"}function Cs(a){const o=String(a||"").trim().toLowerCase();return o==="a"?"a":o==="b"?"b":o==="ab"?"ab":o==="abc"?"abc":"all"}function Te(a){const o=Number(a);if(!Number.isFinite(o))return 12;const h=Math.round(o);return Ft.includes(h)?h:h<9?6:h<15?12:18}function As(a){const o=String(a||"").trim().toLowerCase();return o==="doh"?"doh":o==="plan"?"plan":"units"}function He(a){const o=String(a||"").trim().toUpperCase();return o==="A"||o==="B"||o==="C"?o:null}function Us(a){const o=He(a);return o==="A"?0:o==="B"?1:o==="C"?2:3}function Ns(a,o){if(o==="all")return!0;const h=He(a);return o==="a"?h==="A":o==="b"?h==="B":o==="ab"?h==="A"||h==="B":h!=null}function Ds(a){if(!a)return t.jsx(m,{type:"secondary",children:"Kein Inbound in diesem Monat."});const o=Array.isArray(a.poItems)?a.poItems:[],h=Array.isArray(a.foItems)?a.foItems:[];return t.jsxs("div",{style:{minWidth:260,maxWidth:340},children:[t.jsxs("div",{style:{marginBottom:8},children:[t.jsx(m,{strong:!0,children:"PO Inbound"}),o.length?t.jsx("div",{children:o.map(l=>t.jsx("div",{children:t.jsxs(m,{children:[l.ref," · +",M(l.units)," · ",ne(l.arrivalDate)]})},`po-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(m,{type:"secondary",children:" Keine PO-Ankunft"})]}),t.jsxs("div",{children:[t.jsx(m,{strong:!0,children:"FO Inbound"}),h.length?t.jsx("div",{children:h.map(l=>t.jsx("div",{children:t.jsxs(m,{children:[l.ref," · +",M(l.units)," · ",ne(l.arrivalDate)]})},`fo-${l.id}-${l.ref}-${l.units}-${l.arrivalDate}`))}):t.jsx(m,{type:"secondary",children:" Keine FO-Ankunft"})]})]})}function Gs({view:a="both"}={}){const o=_t(),h=Vt(),{state:l,loading:k,saving:C,error:x,lastSavedAt:w,saveWith:T}=ds(),_e=kt("inventory_snapshot"),Ve=kt("inventory_projection"),We=c.useRef(!1),[A,Ne]=c.useState(()=>ee()),[qe,Ge]=c.useState(!1),[De,ue]=c.useState({}),[Qe,re]=c.useState(!1),[v,Ze]=c.useState("units"),[we,Je]=c.useState(""),[Fe,Ot]=c.useState(!0),[q,de]=c.useState("all"),[H,G]=c.useState("all"),[_,Xe]=c.useState(12),[he,me]=c.useState(()=>xt("inventory_snapshot")),[fe,oe]=c.useState(()=>xt("inventory_projection")),[P,pe]=c.useState(null),[ge,Ye]=c.useState(null),[et,tt]=c.useState(!1),[Q,Oe]=c.useState(null),B=a!=="projection",z=a!=="snapshot",D=l,ye=l.inventory||{},st=ye.settings||{},Pe=l.settings||{},nt=l.forecast&&typeof l.forecast=="object"?l.forecast:{},je=c.useMemo(()=>{const e=structuredClone(nt||{});return as(e),e},[nt]),Pt=c.useMemo(()=>is(je),[je]),ze=ps(je.lastImpactSummary),rt=String(je.activeVersionId||"").trim()||null,ve=ze.toVersionId&&rt&&ze.toVersionId===rt?ze.foConflictsOpen:0;c.useEffect(()=>{if(We.current)return;const e=new URLSearchParams(o.search);if(e.get("source")!=="dashboard")return;We.current=!0;const n=String(e.get("sku")||"").trim();n&&Je(n);const s=N(e.get("month"));s&&Ye(s),de(Ms(e.get("risk"))),G(Cs(e.get("abc"))),e.has("mode")&&Ze(As(e.get("mode"))),e.get("expand")==="all"&&tt(!0)},[o.search]);const K=c.useMemo(()=>{const e=new Set;return e.add(ee()),(Array.isArray(ye.snapshots)?ye.snapshots:[]).forEach(n=>{const r=N(n.month);r&&e.add(r)}),Array.from(e).sort()},[ye.snapshots]),be=c.useMemo(()=>vs(D),[l.inventory]);c.useEffect(()=>{K.includes(A)||(Ne(be||K[K.length-1]||ee()),Ge(!1))},[be,K,A]),c.useEffect(()=>{if(qe)return;const e=be||K[K.length-1]||ee();e&&e!==A&&Ne(e)},[be,K,A,qe]),c.useEffect(()=>{const e=js(D,A),n=Re((e==null?void 0:e.items)||[]);ue(n),re(!1)},[A,D]),c.useEffect(()=>{const e=Number(st.projectionMonths);Number.isFinite(e)&&e>0&&Xe(Te(e))},[st.projectionMonths]);const ot=c.useMemo(()=>{const e=new Map;return(Array.isArray(l.productCategories)?l.productCategories:[]).forEach(n=>{const s=n,r=String(s.id||"");r&&e.set(r,String(s.name||"Ohne Kategorie"))}),e},[l.productCategories]),Z=c.useMemo(()=>ns(D),[l.productCategories]),Le=c.useMemo(()=>Zt(D).bySku,[l]),at=c.useMemo(()=>(Array.isArray(l.products)?l.products:[]).map(e=>e).map(e=>({sku:String(e.sku||"").trim(),raw:e})).filter(e=>e.sku),[l.products]);c.useMemo(()=>new Map(at.map(e=>[e.sku,e.raw])),[at]);const J=c.useMemo(()=>Nt(D,A),[A,D]),it=c.useMemo(()=>Re((J==null?void 0:J.items)||[]),[J==null?void 0:J.items]),lt=c.useMemo(()=>(Array.isArray(l.products)?l.products:[]).map(n=>{const s=n,r=String(s.sku||"").trim();if(!r)return null;const i=String(s.alias||r),u=String(s.status||"").trim().toLowerCase(),d=Wt(s.includeInForecast,!0)&&(!u||u==="active"||u==="aktiv"),p=ot.get(String(s.categoryId||""))||"Ohne Kategorie",g=De[r]||{amazonUnits:0,threePLUnits:0},y=it[r]||{amazonUnits:0,threePLUnits:0},S=g.amazonUnits+g.threePLUnits,L=y.amazonUnits+y.threePLUnits,V=Jt(s,D),I=Xt(s,D),X=Le.get(r.toLowerCase())||Le.get(r)||null,Tt=(X==null?void 0:X.abcClass)??null,Ht=(X==null?void 0:X.abcBasis)||"no_data";return{sku:r,alias:i,categoryLabel:p,abcClass:Tt,abcBasis:Ht,isActive:d,amazonUnits:g.amazonUnits,threePLUnits:g.threePLUnits,totalUnits:S,delta:S-L,safetyDays:Number.isFinite(V)?Number(V):null,coverageDays:Number.isFinite(I)?Number(I):null}}).filter(Boolean),[Le,ot,it,De,l.products,D]),U=c.useMemo(()=>{const e=we.trim().toLowerCase();return lt.filter(n=>Fe&&!n.isActive||!Ns(n.abcClass,H)?!1:e?[n.sku,n.alias,n.categoryLabel,n.abcClass||""].join(" ").toLowerCase().includes(e):!0).sort((n,s)=>{const r=rs(n.categoryLabel,s.categoryLabel,Z);if(r!==0)return r;const i=n.alias.localeCompare(s.alias,"de-DE",{sensitivity:"base"});return i!==0?i:n.sku.localeCompare(s.sku,"de-DE",{sensitivity:"base"})})},[H,lt,Z,Fe,we]),E=c.useMemo(()=>Dt(U,Z),[Z,U]);c.useEffect(()=>{B&&me(e=>{if(!E.length)return[];const n=new Set(E.map(r=>r.key)),s=e.filter(r=>n.has(r));return s.length||_e?s:E.map(r=>r.key)})},[E,_e,B]),c.useEffect(()=>{St("inventory_snapshot",he)},[he]),c.useEffect(()=>{St("inventory_projection",fe)},[fe]);const ae=ee(),ct=c.useMemo(()=>ts(ae,-1),[ae]),b=c.useMemo(()=>ss(ae,_),[ae,_]),f=c.useMemo(()=>Yt({state:D,months:b,products:U.map(e=>({sku:e.sku,alias:e.alias,status:e.isActive?"active":"inactive",safetyStockDohOverride:e.safetyDays,foCoverageDohOverride:e.coverageDays})),snapshot:null,snapshotMonth:ct,projectionMode:v}),[U,ct,v,b,D]),ut=c.useMemo(()=>ls(D),[l.forecast,l.inventory,l.pos,l.fos]),$=c.useMemo(()=>{const e=new Set,n=new Set;let s=null,r=null;return U.forEach(i=>{b.forEach(u=>{var g;const d=(g=f.perSkuMonth.get(i.sku))==null?void 0:g.get(u);if(!d)return;const p=Y({projectionMode:v,endAvailable:d.endAvailable,safetyUnits:d.safetyUnits,doh:d.doh,safetyDays:d.safetyDays});p&&(e.add(i.sku),(!s||u<s)&&(s=u),p==="safety-negative"&&(n.add(i.sku),(!r||u<r)&&(r=u)))})}),{underSafetySkus:e.size,oosSkus:n.size,criticalMonth:r||s,missingEta:Number(f.inboundMissingDateCount||0)}},[U,f,v,b]),ie=c.useMemo(()=>{const e=new Map;return b.forEach(n=>{e.set(n,{month:n,score:0,oosCount:0,underSafetyCount:0,criticalSkus:new Set})}),U.forEach(n=>{b.forEach(s=>{var d;const r=(d=f.perSkuMonth.get(n.sku))==null?void 0:d.get(s);if(!r)return;const i=Y({projectionMode:v,endAvailable:r.endAvailable,safetyUnits:r.safetyUnits,doh:r.doh,safetyDays:r.safetyDays});if(!i)return;const u=e.get(s);u&&(u.score+=Ss(n.abcClass,i),u.underSafetyCount+=1,i==="safety-negative"&&(u.oosCount+=1),u.criticalSkus.add(n.sku))})}),e},[U,f,v,b]),dt=c.useMemo(()=>{const e=Array.from(ie.values()).map(n=>Number(n.score||0));return e.length?Math.max(...e,0):0},[ie]),ht=c.useMemo(()=>{const e=new Map;return U.forEach(n=>{let s=!1,r=!1;b.forEach(i=>{var p;const u=(p=f.perSkuMonth.get(n.sku))==null?void 0:p.get(i);if(!u)return;const d=Y({projectionMode:v,endAvailable:u.endAvailable,safetyUnits:u.safetyUnits,doh:u.doh,safetyDays:u.safetyDays});d&&(r=!0,d==="safety-negative"&&(s=!0))}),e.set(n.sku,{hasOos:s,hasUnderSafety:r})}),e},[U,f,v,b]),le=c.useMemo(()=>q==="all"?U:U.filter(e=>{const n=ht.get(e.sku);return n?q==="oos"?n.hasOos:n.hasUnderSafety:!1}),[U,ht,q]),ke=c.useMemo(()=>Dt(le,Z),[Z,le]),xe=c.useMemo(()=>{var e;return P?((e=ie.get(P))==null?void 0:e.criticalSkus)||new Set:null},[P,ie]),F=c.useMemo(()=>!P||!xe||!xe.size?ke:ke.map(e=>({...e,rows:e.rows.filter(n=>xe.has(n.sku))})).filter(e=>e.rows.length>0),[ke,xe,P]);function mt(e,n,s,r){const i=cs(Array.isArray(l.products)?l.products:[],e.sku),u=ks(i,Pe),d=us({context:ut,sku:e.sku,leadTimeDays:u,product:i,settings:Pe,horizonMonths:Math.max(6,_),requiredArrivalMonth:n}),p=String((d==null?void 0:d.status)||""),g=Number((d==null?void 0:d.recommendedUnits)||0),y=Math.max(0,Math.ceil(Number(s.safetyUnits||0)-Number(s.endAvailable||0))),S=Math.max(0,Math.round(Number.isFinite(g)&&g>0?g:y)),L=String((d==null?void 0:d.requiredArrivalDate)||bs(n)||"")||null,V=String((d==null?void 0:d.orderDateAdjusted)||(d==null?void 0:d.orderDate)||"")||null;return{cellKey:r,row:e,month:n,data:s,recommendedUnits:S,requiredArrivalDate:L,recommendedOrderDate:V,recommendation:d,recommendationStatus:p}}const Se=c.useMemo(()=>{if(v==="plan")return new Map;const e=new Map;return le.forEach(n=>{var d,p;let s=null;for(const g of b){const y=(d=f.perSkuMonth.get(n.sku))==null?void 0:d.get(g);if(!y)continue;const S=Y({projectionMode:v,endAvailable:y.endAvailable,safetyUnits:y.safetyUnits,doh:y.doh,safetyDays:y.safetyDays});if(S==="safety-negative"||S==="safety-low"){s=g;break}}if(!s)return;const r=(p=f.perSkuMonth.get(n.sku))==null?void 0:p.get(s);if(!r)return;const i=`${n.sku}|${s}`,u=mt(n,s,r,i);u.recommendationStatus!=="ok"||u.recommendedUnits<=0||e.set(i,u)}),e},[f,v,b,le,_,ut,Pe,l.products]),R=c.useMemo(()=>{const e=Array.from(Se.values()).map(n=>{const s=Y({projectionMode:v,endAvailable:n.data.endAvailable,safetyUnits:n.data.safetyUnits,doh:n.data.doh,safetyDays:n.data.safetyDays});if(s!=="safety-negative"&&s!=="safety-low")return null;const r=He(n.row.abcClass),i=n.month,u=Number(String(i||"").replace("-","")),d=s==="safety-negative"?-.5:0,p=Us(r)*1e3+(Number.isFinite(u)?u:999999)+d;return{key:`${n.row.sku}|${n.month}`,sku:n.row.sku,alias:n.row.alias,abcClass:r,month:i,riskClass:s,recommendedUnits:n.recommendedUnits,requiredArrivalDate:n.requiredArrivalDate,recommendedOrderDate:n.recommendedOrderDate,priority:p,intent:n}}).filter(Boolean);return e.sort((n,s)=>{if(n.priority!==s.priority)return n.priority-s.priority;if(n.month!==s.month)return n.month.localeCompare(s.month);const r=Number(s.recommendedUnits||0)-Number(n.recommendedUnits||0);return r!==0?r:n.sku.localeCompare(s.sku,"de-DE",{sensitivity:"base"})}),e},[Se,v]);c.useEffect(()=>{P&&!b.includes(P)&&pe(null)},[b,P]),c.useEffect(()=>{ge&&b.length&&(b.includes(ge)&&pe(ge),Ye(null))},[ge,b]),c.useEffect(()=>{z&&oe(e=>{if(!F.length)return[];const n=new Set(F.map(r=>r.key)),s=e.filter(r=>n.has(r));return s.length||Ve?s:F.map(r=>r.key)})},[Ve,F,z]),c.useEffect(()=>{!z||!et||F.length&&(oe(F.map(e=>e.key)),tt(!1))},[et,F,z]);function ft(e,n,s,r){Oe(mt(e,n,s,r))}function Me(e,n){if(!e)return;const s=new URLSearchParams;s.set("source","inventory_projection"),s.set("sku",e.row.sku),s.set("month",e.month),s.set("suggestedUnits",String(e.recommendedUnits||0)),s.set("projectedEnd",String(Math.round(Number(e.data.endAvailable||0)))),s.set("mode",v),e.requiredArrivalDate&&s.set("requiredArrivalDate",e.requiredArrivalDate),e.recommendedOrderDate&&s.set("recommendedOrderDate",e.recommendedOrderDate),s.set("returnTo","/v2/inventory/projektion");const r=(n==null?void 0:n.nextIntent)||null;r&&(s.set("nextSku",r.row.sku),s.set("nextMonth",r.month),s.set("nextSuggestedUnits",String(r.recommendedUnits||0)),r.requiredArrivalDate&&s.set("nextRequiredArrivalDate",r.requiredArrivalDate),r.recommendedOrderDate&&s.set("nextRecommendedOrderDate",r.recommendedOrderDate)),h(`/v2/orders/fo?${s.toString()}`),Oe(null)}function zt(e){var n,s,r,i,u,d;return t.jsxs("div",{className:"v2-proj-action-menu",children:[t.jsx(m,{strong:!0,children:e.row.alias}),t.jsx(m,{type:"secondary",children:e.row.sku}),t.jsx(m,{type:"secondary",children:W(e.month)}),t.jsxs(m,{children:["Bestand EOM: ",t.jsx("strong",{children:M(e.data.endAvailable)})]}),t.jsxs(m,{children:["Safety: ",t.jsx("strong",{children:M(e.data.safetyUnits)})]}),t.jsxs(m,{children:["Ankunft: ",t.jsx("strong",{children:ne(e.requiredArrivalDate)})]}),t.jsxs(m,{children:["Bestellen bis: ",t.jsx("strong",{children:ne(e.recommendedOrderDate)})]}),t.jsxs(m,{children:["Vorschlag: ",t.jsx("strong",{children:M(e.recommendedUnits)})]}),e.recommendationStatus!=="ok"?t.jsx(m,{type:"warning",children:"Hinweis: Empfehlung ist nicht vollständig belastbar."}):null,Number(((n=e.recommendation)==null?void 0:n.coverageDaysForOrder)||0)>0?t.jsxs(m,{type:"secondary",children:["Bedarf (",M(Number(((s=e.recommendation)==null?void 0:s.coverageDaysForOrder)||0))," Tage): ",M(Number(((r=e.recommendation)==null?void 0:r.coverageDemandUnits)||0))]}):null,(i=e.recommendation)!=null&&i.moqApplied?t.jsxs(m,{type:"warning",children:["MOQ angewendet: kalkulatorisch ",M(Number(((u=e.recommendation)==null?void 0:u.recommendedUnitsRaw)||0))," → MOQ ",M(Number(((d=e.recommendation)==null?void 0:d.recommendedUnits)||0))]}):null,t.jsx("div",{className:"v2-actions-inline",children:t.jsx(O,{size:"small",type:"primary",onClick:()=>Me(e),children:"FO erstellen"})})]})}const Lt=c.useMemo(()=>[{header:"Alias",accessorKey:"alias",meta:{width:270,minWidth:250},cell:({row:e})=>t.jsx(es,{alias:e.original.alias,sku:e.original.sku})},{header:"ABC",accessorKey:"abcClass",meta:{width:72,align:"center"},cell:({row:e})=>t.jsx(ce,{title:wt(e.original.abcBasis),children:t.jsx("span",{children:e.original.abcClass||"—"})})},{header:"Amazon",accessorKey:"amazonUnits",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(Mt,{className:"v2-grid-input",value:e.original.amazonUnits,min:0,style:{width:"100%"},controls:!1,onChange:n=>{const s=se(n);ue(r=>({...r,[e.original.sku]:{...r[e.original.sku]||{amazonUnits:0,threePLUnits:0,note:""},amazonUnits:s}})),re(!0)}})},{header:"3PL",accessorKey:"threePLUnits",meta:{width:116,align:"right"},cell:({row:e})=>t.jsx(Mt,{className:"v2-grid-input",value:e.original.threePLUnits,min:0,style:{width:"100%"},controls:!1,onChange:n=>{const s=se(n);ue(r=>({...r,[e.original.sku]:{...r[e.original.sku]||{amazonUnits:0,threePLUnits:0,note:""},threePLUnits:s}})),re(!0)}})},{header:"Total",accessorKey:"totalUnits",meta:{width:92,align:"right"},cell:({row:e})=>M(e.original.totalUnits)},{header:"Delta",accessorKey:"delta",meta:{width:92,align:"right"},cell:({row:e})=>t.jsx("span",{className:e.original.delta<0?"v2-negative":"",children:M(e.original.delta)})},{header:"Safety DOH",accessorKey:"safetyDays",meta:{width:96,align:"right"},cell:({row:e})=>M(e.original.safetyDays)},{header:"Coverage DOH",accessorKey:"coverageDays",meta:{width:108,align:"right"},cell:({row:e})=>M(e.original.coverageDays)}],[]),pt=Array.isArray(f.anchorForecastGapSkus)?f.anchorForecastGapSkus:[],gt=Array.isArray(f.anchorSkuFallbackSkus)?f.anchorSkuFallbackSkus:[],yt=Array.isArray(f.anchorSkuMissingHistory)?f.anchorSkuMissingHistory:[],jt=c.useMemo(()=>new Set(gt.map(e=>String(e||"").trim())),[gt]),vt=c.useMemo(()=>new Set(yt.map(e=>String(e||"").trim())),[yt]),It=c.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:270,minWidth:250},cell:({row:s})=>t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx("div",{className:"v2-proj-alias-main",title:s.original.alias,children:s.original.alias}),t.jsx(m,{className:"v2-proj-sku-secondary",type:"secondary",title:s.original.sku,children:s.original.sku})]})},{header:"ABC",accessorKey:"abcClass",meta:{width:68,align:"center"},cell:({row:s})=>t.jsx(ce,{title:wt(s.original.abcBasis),children:t.jsx("span",{children:s.original.abcClass||"—"})})},{header:"Safety DOH",accessorKey:"safetyDays",meta:{width:96,align:"right"},cell:({row:s})=>M(s.original.safetyDays)},{header:"Coverage DOH",accessorKey:"coverageDays",meta:{width:110,align:"right"},cell:({row:s})=>M(s.original.coverageDays)},{header:"Ankerbestand",meta:{width:118,align:"right",sortAccessor:s=>{const r=String(s.sku||"").trim(),i=f.startAvailableBySku.get(r);return Number.isFinite(i)?Number(i):0}},cell:({row:s})=>{var S,L;const r=String(s.original.sku||"").trim(),i=f.startAvailableBySku.get(r),u=jt.has(r),d=vt.has(r),p=((L=(S=f.anchorSourceBySku)==null?void 0:S.get)==null?void 0:L.call(S,r))||null,g=p!=null&&p.month?te(String(p.month),"long"):"—",y=d?"Keine Snapshot-Historie für diese SKU. Startwert = 0.":u?`SKU-Fallback: letzter verfügbarer Snapshot (${g}).`:`Anchor-Snapshot (${g}).`;return t.jsx(ce,{title:y,children:t.jsx("span",{children:M(Number.isFinite(i)?Number(i):0)})})}}],n=b.map(s=>({id:s,header:W(s),meta:{minWidth:106,width:106,align:"right",sortAccessor:r=>{var u;const i=(u=f.perSkuMonth.get(r.sku))==null?void 0:u.get(s);return i?v==="plan"?Number.isFinite(i.forecastUnits)?Number(i.forecastUnits):null:v==="doh"?Number.isFinite(i.doh)?Number(i.doh):null:Number.isFinite(i.endAvailable)?Number(i.endAvailable):null:null}},cell:({row:r})=>{var V;const i=(V=f.perSkuMonth.get(r.original.sku))==null?void 0:V.get(s);if(!i)return"—";let u=null;v==="plan"?u=Number.isFinite(i.forecastUnits)?Number(i.forecastUnits):null:v==="doh"?u=Number.isFinite(i.doh)?Number(i.doh):null:u=Number.isFinite(i.endAvailable)?Number(i.endAvailable):null;const d=Y({projectionMode:v,endAvailable:i.endAvailable,safetyUnits:i.safetyUnits,doh:i.doh,safetyDays:i.safetyDays}),p=v!=="plan",g=i.inboundDetails,y=`${r.original.sku}|${s}`,S=Se.get(y)||null,L=(Q==null?void 0:Q.cellKey)===y;return t.jsx(Ct,{trigger:p?"click":"hover",placement:"rightTop",open:p?L:void 0,onOpenChange:I=>{p&&!I&&L&&Oe(null)},content:L&&Q?zt(Q):null,children:t.jsxs("div",{className:["v2-proj-cell",d?`v2-proj-cell--${d}`:"",p?"v2-proj-cell--actionable":""].filter(Boolean).join(" "),role:p?"button":void 0,tabIndex:p?0:void 0,onClick:p?()=>ft(r.original,s,i,y):void 0,onKeyDown:p?I=>{(I.key==="Enter"||I.key===" ")&&(I.preventDefault(),ft(r.original,s,i,y))}:void 0,children:[t.jsx("div",{className:"v2-proj-cell-main",children:M(u)}),v!=="plan"&&Number.isFinite(i.safetyUnits)?t.jsxs(m,{type:"secondary",style:{fontSize:11},children:["SB: ",M(i.safetyUnits)]}):null,S?t.jsx("button",{type:"button",className:"v2-proj-fo-badge",onClick:I=>{I.stopPropagation(),Me(S)},children:"FO empfohlen"}):null,g&&g.totalUnits>0?t.jsx(Ct,{content:Ds(g),trigger:"hover",placement:"topLeft",children:t.jsxs("div",{className:"v2-proj-inbound-row",children:[g.poUnits>0?t.jsxs(j,{className:"v2-proj-inbound v2-proj-inbound--po",children:["PO +",M(g.poUnits)]}):null,g.foUnits>0?t.jsxs(j,{className:"v2-proj-inbound v2-proj-inbound--fo",children:["FO +",M(g.foUnits)]}):null]})}):null]})})}}));return[...e,...n]},[Q,vt,jt,Se,f,v,b]);async function Bt(){await T(e=>{const n=Qt(e),s=n;gs(s);const r=s.inventory,i=Array.isArray(r.snapshots)?[...r.snapshots]:[],u=Object.entries(De).map(([y,S])=>({sku:y,amazonUnits:se(S.amazonUnits),threePLUnits:se(S.threePLUnits),note:String(S.note||"")})).filter(y=>y.amazonUnits>0||y.threePLUnits>0||y.note),d=N(A)||ee(),p=i.findIndex(y=>N(y.month)===d),g={month:d,items:u,updatedAt:ys()};return p>=0?i[p]={...i[p]||{},...g}:i.push(g),i.sort((y,S)=>String(N(y.month)).localeCompare(String(N(S.month)))),r.snapshots=i,r.settings={...r.settings||{},projectionMonths:Te(_)},n},"v2:inventory:save-snapshot"),re(!1)}async function Et(){const e=Nt(D,A);e&&(ue(Re(e.items||[])),re(!0))}function Kt(){const n=[["SKU","Alias","Kategorie","AmazonUnits","ThreePLUnits","TotalUnits"],...U.map(u=>[u.sku,u.alias,u.categoryLabel,String(u.amazonUnits),String(u.threePLUnits),String(u.totalUnits)])].map(u=>u.map(d=>`"${String(d).replace(/"/g,'""')}"`).join(";")).join(`
`),s=new Blob([n],{type:"text/csv;charset=utf-8"}),r=URL.createObjectURL(s),i=document.createElement("a");i.href=r,i.download=`inventory-snapshot-${A}.csv`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}const Ie=String(f.anchorMode||"no_snapshot"),Be=N(f.anchorTargetMonth||f.anchorMonth),$t=ae,Rt=Ie==="rollforward"?`Anker: ${f.anchorSourceMonth||"—"} Snapshot → Rollforward bis ${Be||"—"}`:Ie==="snapshot"?`Anker: Snapshot ${Be||f.anchorSourceMonth||"—"}`:"Anker: kein Snapshot (Start bei 0)";return t.jsxs("div",{className:"v2-page",children:[t.jsxs(Ke,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx($e,{level:3,children:B&&!z?"Bestandsaufnahme":z&&!B?"Bestandsprojektion":"Inventory"}),t.jsx(fs,{children:B&&!z?"Monatliche Snapshot-Erfassung mit Kategoriegruppen, Copy-Forward, Speicherung und CSV-Export.":z&&!B?"Bestandsprojektion mit Risikoampel, PO/FO-Inbound-Sicht und direkter Bestellbrücke.":"Snapshot-Erfassung und Projektion (Units / DOH / Plan) in einem Arbeitsbereich."})]})}),t.jsxs("div",{className:"v2-toolbar",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[B?t.jsx(At,{value:A,onChange:e=>{Ne(e),Ge(!0)},options:K.map(e=>({value:e,label:`${e} · ${te(e,"long")}`})),style:{width:260,maxWidth:"100%"}}):null,t.jsx(Gt,{value:we,onChange:e=>Je(e.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),t.jsx(hs,{checked:Fe,onChange:e=>Ot(e.target.checked),children:"Nur aktive Produkte"}),z?t.jsxs(t.Fragment,{children:[t.jsxs(Ae.Group,{value:v,onChange:e=>Ze(e.target.value),children:[t.jsx(Ae.Button,{value:"units",children:"Units"}),t.jsx(Ae.Button,{value:"doh",children:"DOH"}),t.jsx(Ae.Button,{value:"plan",children:"Plan"})]}),t.jsx(ce,{title:xs(v),children:t.jsx(ms,{style:{color:"#64748b",fontSize:16}})}),t.jsx(At,{value:_,onChange:e=>Xe(Te(e)),style:{width:160,maxWidth:"100%"},options:Ft.map(e=>({value:e,label:`Horizont ${e} Monate`}))})]}):null,t.jsxs(j,{color:"blue",children:["Baseline Forecast: ",Pt]}),ve>0?t.jsxs(O,{size:"small",onClick:()=>h("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",ve," FOs prüfen"]}):null]}),B?t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(O,{onClick:()=>{Et()},children:"Vorherigen Monat kopieren"}),t.jsx(O,{type:"primary",onClick:()=>{Bt()},disabled:!Qe,loading:C,children:"Snapshot speichern"}),t.jsx(O,{onClick:Kt,children:"Snapshot CSV"}),Qe?t.jsx(j,{color:"orange",children:"Ungespeicherte Änderungen"}):t.jsx(j,{color:"green",children:"Synchron"}),t.jsx(j,{color:"blue",children:te(A,"long")}),w?t.jsxs(j,{color:"green",children:["Gespeichert: ",new Date(w).toLocaleTimeString("de-DE")]}):null]}):null]})]}),x?t.jsx(Ce,{type:"error",showIcon:!0,message:x}):null,k?t.jsx(Ce,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,ve>0?t.jsx(Ce,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${ve} FOs prüfen`,description:t.jsx(O,{size:"small",onClick:()=>h("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,B?t.jsxs(Ke,{children:[t.jsxs($e,{level:4,children:["Snapshot zum Stichtag ",te(A,"long")]}),t.jsxs(m,{type:"secondary",children:["Monatsschlüssel: ",A]}),t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(m,{type:"secondary",children:[U.length," Produkte in ",E.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(O,{size:"small",onClick:()=>me(E.map(e=>e.key)),disabled:!E.length,children:"Alles auf"}),t.jsx(O,{size:"small",onClick:()=>me([]),disabled:!he.length,children:"Alles zu"})]})]}),E.length?t.jsx(Ut,{className:"v2-category-collapse",activeKey:he,onChange:e=>me((Array.isArray(e)?e:[e]).map(String)),items:E.map(e=>({key:e.key,label:t.jsxs(Ee,{children:[t.jsx(m,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(bt,{data:e.rows,columns:Lt,minTableWidth:1e3,tableLayout:"fixed"})}))}):t.jsx(m,{type:"secondary",children:"Keine Snapshot-Zeilen für den aktuellen Filter."})]}):null,z?t.jsxs(Ke,{children:[t.jsxs($e,{level:4,children:["Projektion (",v.toUpperCase(),")"]}),t.jsxs("div",{className:"v2-proj-cluster-grid",children:[t.jsxs("div",{className:"v2-proj-context-cluster",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{color:"blue",children:["Heute: ",te($t,"long")]}),t.jsx(j,{color:Ie==="no_snapshot"?"red":"blue",children:Rt}),t.jsxs(j,{color:"default",children:["Zeitraum: ",b[0]||"—"," bis ",b[b.length-1]||"—"]}),t.jsxs(j,{color:"default",children:["Horizont: ",_," Monate"]})]}),t.jsxs("div",{className:"v2-toolbar-row",children:[f.snapshotFallbackUsed?t.jsx(j,{color:"gold",children:"Fallback auf letzten Snapshot ≤ Ankermonat"}):null,f.resolvedSnapshotMonth?t.jsxs(j,{color:"blue",children:["Stichtag Anchor: ",te(String(f.resolvedSnapshotMonth||Be||""),"long")]}):null,Number(f.anchorSkuFallbackCount||0)>0?t.jsxs(j,{color:"gold",children:["SKU-Fallback aktiv: ",Number(f.anchorSkuFallbackCount||0)]}):null,$.missingEta>0?t.jsxs(j,{color:"orange",children:["Fehlende ETA: ",$.missingEta]}):t.jsx(j,{color:"green",children:"Fehlende ETA: 0"}),t.jsx(ce,{title:"Units = projizierter Monatsendbestand · DOH = Reichweite in Tagen · Plan = Forecast-Absatz · Safety = Vergleich gegen Safety-Schwelle je SKU/Monat",children:t.jsx(j,{color:"default",children:"Modus-Hilfe"})})]}),pt.length>0?t.jsx(Ce,{className:"v2-proj-anchor-warning",type:"warning",showIcon:!0,message:`Anker-Rollforward mit Forecast-Lücken bei ${pt.length} SKU(s) – diese Monate wurden mit 0 Units gerechnet.`}):null]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(m,{type:"secondary",children:"Risiko-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${q==="all"?"is-active":""}`,onClick:()=>de("all"),children:"Alle Risiken"}),t.jsxs("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--negative ${q==="oos"?"is-active":""}`,onClick:()=>de("oos"),children:["OOS / ","<="," 0"]}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn v2-proj-filter-btn--low ${q==="under_safety"?"is-active":""}`,onClick:()=>de("under_safety"),children:"Unter Safety"})]})]}),t.jsxs("div",{className:"v2-proj-filter-cluster",children:[t.jsx(m,{type:"secondary",children:"ABC-Filter"}),t.jsxs("div",{className:"v2-toolbar-row v2-proj-filter-row",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="all"?"is-active":""}`,onClick:()=>G("all"),children:"Alle"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="a"?"is-active":""}`,onClick:()=>G("a"),children:"A"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="b"?"is-active":""}`,onClick:()=>G("b"),children:"B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="ab"?"is-active":""}`,onClick:()=>G("ab"),children:"A+B"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${H==="abc"?"is-active":""}`,onClick:()=>G("abc"),children:"ABC"})]})]})]}),t.jsxs("div",{className:"v2-proj-score-strip",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{color:$.underSafetySkus>0?"gold":"green",children:["SKUs unter Safety: ",$.underSafetySkus]}),t.jsxs(j,{color:$.oosSkus>0?"red":"green",children:["OOS: ",$.oosSkus]}),t.jsxs(j,{color:"blue",children:["Kritischster Monat: ",$.criticalMonth?W($.criticalMonth):"—"]})]}),t.jsxs("div",{className:"v2-proj-heatmap",children:[b.map(e=>{const n=ie.get(e),s=Number((n==null?void 0:n.score)||0),r=dt>0?Math.min(1,s/dt):0,i=P===e;return t.jsxs("button",{type:"button",className:`v2-proj-heatmap-item${i?" is-active":""}`,style:{background:`rgba(220, 38, 38, ${.08+r*.3})`,borderColor:i?"rgba(220, 38, 38, 0.8)":"rgba(15, 27, 45, 0.12)"},onClick:()=>pe(u=>u===e?null:e),title:`${W(e)} · ABC-gewichteter Risikoscore ${s} · OOS ${Number((n==null?void 0:n.oosCount)||0)} · Unter Safety ${Number((n==null?void 0:n.underSafetyCount)||0)}`,children:[t.jsx("span",{children:W(e)}),t.jsxs("strong",{children:["Score ",s]})]},e)}),P?t.jsx(O,{size:"small",onClick:()=>pe(null),children:"Filter löschen"}):null]}),t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(j,{className:"v2-proj-legend v2-proj-legend--negative",children:["Rot = OOS / ","<="," 0"]}),t.jsx(j,{className:"v2-proj-legend v2-proj-legend--low",children:"Orange = Unter Safety"}),t.jsx(j,{className:"v2-proj-legend",children:"Inbound Marker: PO / FO"}),t.jsx(m,{type:"secondary",children:"`FO empfohlen` im ersten Risikomonat anklicken oder Zelle öffnen für FO-Anlage."})]})]}),t.jsxs("div",{className:"v2-proj-worklist",children:[t.jsxs("div",{className:"v2-proj-worklist-head",children:[t.jsxs(Ee,{wrap:!0,children:[t.jsx(m,{strong:!0,children:"FO-Arbeitsliste"}),t.jsxs(j,{color:R.length?"gold":"green",children:[R.length," SKU(s)"]}),t.jsx(j,{color:"blue",children:"Sortierung: A/B zuerst, frühester Risikomonat"})]}),R.length?t.jsx(O,{size:"small",type:"primary",onClick:()=>{var e,n;return Me(((e=R[0])==null?void 0:e.intent)||null,{nextIntent:((n=R[1])==null?void 0:n.intent)||null})},children:"Erste SKU öffnen"}):null]}),R.length?t.jsx("div",{className:"v2-table-shell v2-scroll-host",children:t.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"SKU"}),t.jsx("th",{children:"ABC"}),t.jsx("th",{children:"Risikomonat"}),t.jsx("th",{children:"Risiko"}),t.jsx("th",{children:"Empfohlen"}),t.jsx("th",{children:"ETA-Ziel"}),t.jsx("th",{children:"Bestellen bis"}),t.jsx("th",{children:"Aktion"})]})}),t.jsx("tbody",{children:R.map((e,n)=>{var r;const s=((r=R[n+1])==null?void 0:r.intent)||null;return t.jsxs("tr",{children:[t.jsx("td",{children:t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx(m,{className:"v2-proj-alias-main",children:e.alias||e.sku}),t.jsx(m,{className:"v2-proj-sku-secondary",type:"secondary",children:e.sku})]})}),t.jsx("td",{children:e.abcClass||"—"}),t.jsx("td",{children:W(e.month)}),t.jsx("td",{children:e.riskClass==="safety-negative"?t.jsx(j,{color:"red",children:"OOS / ≤ 0"}):t.jsx(j,{color:"gold",children:"Unter Safety"})}),t.jsx("td",{children:M(e.recommendedUnits)}),t.jsx("td",{children:ne(e.requiredArrivalDate)}),t.jsx("td",{children:ne(e.recommendedOrderDate)}),t.jsx("td",{children:t.jsx(O,{size:"small",type:"primary",onClick:()=>Me(e.intent,{nextIntent:s}),children:"FO öffnen"})})]},e.key)})})]})}):t.jsx(m,{type:"secondary",children:"Keine FO-Empfehlungen im aktuellen Filterumfang."})]}),t.jsxs("div",{className:"v2-category-tools",style:{marginTop:10},children:[t.jsx(m,{type:"secondary",children:P?`${F.reduce((e,n)=>e+n.rows.length,0)} kritische Produkte in ${F.length} Kategorien (${W(P)})`:`${le.length} Produkte in ${ke.length} Kategorien`}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(O,{size:"small",onClick:()=>oe(F.map(e=>e.key)),disabled:!F.length,children:"Alles auf"}),t.jsx(O,{size:"small",onClick:()=>oe([]),disabled:!fe.length,children:"Alles zu"})]})]}),F.length?t.jsx(Ut,{className:"v2-category-collapse",activeKey:fe,onChange:e=>oe((Array.isArray(e)?e:[e]).map(String)),items:F.map(e=>({key:e.key,label:t.jsxs(Ee,{children:[t.jsx(m,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx(bt,{data:e.rows,columns:It,minTableWidth:Math.max(1080,760+b.length*118),tableLayout:"fixed",crosshair:"matrix"})}))}):t.jsx(m,{type:"secondary",children:"Keine Projektion für den aktuellen Filter."})]}):null]})}export{Gs as I};
