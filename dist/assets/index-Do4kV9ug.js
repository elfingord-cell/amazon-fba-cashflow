import{t as o,ar as gn,a3 as nn,as as Sn,a1 as tn,at as Xe,au as bn,aq as Qe,W as yn,ag as kn,ai as Mn,av as J,aw as xn,ax as Cn,Y as vn,ay as jn,az as In,aA as $n,aB as wn,I as Dn,aa as Pn,k as s,K as Nn,L as $,M as Ge,R as En,U as Ye,a7 as An,S as W,N as V,a6 as Je,af as Un}from"./index-o-D_rC2a.js";import{E as zn}from"./index-C05ks0Wm.js";import{b as On}from"./abcClassification-Czyc8_9u.js";import{c as Fn,g as Tn}from"./inventoryProjection-B9saLoLy.js";import{b as Bn}from"./phantomFo-fuJ3NSBN.js";import{c as Ln,b as Hn,a as Rn,n as B,f as _}from"./months-BTPgK-LH.js";import{a as Kn}from"./forecastVersioning-Bk55l2iS.js";import{u as qn,C as ue}from"./workspace-CYYiY6ES.js";import{F as Wn}from"./Table-d3PPswou.js";import{E as Vn,S as _n}from"./index-CPjrUd6P.js";import{S as Xn}from"./index-C5SGBOij.js";import{T as Qn}from"./index-CyWWOfYr.js";import"./productCompletenessV2-4tJuiHUR.js";import"./orderUtils-DW9cnzFm.js";import"./foSuggestion-DyBAXRuI.js";import"./Dropdown-BL05MYkh.js";import"./DownOutlined-CXkcgpir.js";import"./index-DS8YiSJw.js";import"./useBubbleLock-Bq7y8b-t.js";import"./index-D3_9UGQr.js";import"./Pagination-C10cTOg8.js";var Gn=["prefixCls","className","checked","defaultChecked","disabled","loadingIcon","checkedChildren","unCheckedChildren","onClick","onChange","onKeyDown"],an=o.forwardRef(function(n,t){var l,g=n.prefixCls,b=g===void 0?"rc-switch":g,y=n.className,j=n.checked,c=n.defaultChecked,p=n.disabled,k=n.loadingIcon,N=n.checkedChildren,u=n.unCheckedChildren,R=n.onClick,M=n.onChange,Z=n.onKeyDown,E=gn(n,Gn),ee=nn(!1,{value:j,defaultValue:c}),ne=Sn(ee,2),w=ne[0],A=ne[1];function K(U,L){var q=w;return p||(q=U,A(q),M==null||M(q,L)),q}function se(U){U.which===Qe.LEFT?K(!1,U):U.which===Qe.RIGHT&&K(!0,U),Z==null||Z(U)}function O(U){var L=K(!w,U);R==null||R(L,U)}var X=tn(b,y,(l={},Xe(l,"".concat(b,"-checked"),w),Xe(l,"".concat(b,"-disabled"),p),l));return o.createElement("button",bn({},E,{type:"button",role:"switch","aria-checked":w,disabled:p,className:X,ref:t,onKeyDown:se,onClick:O}),k,o.createElement("span",{className:"".concat(b,"-inner")},o.createElement("span",{className:"".concat(b,"-inner-checked")},N),o.createElement("span",{className:"".concat(b,"-inner-unchecked")},u)))});an.displayName="Switch";const Yn=n=>{const{componentCls:t,trackHeightSM:l,trackPadding:g,trackMinWidthSM:b,innerMinMarginSM:y,innerMaxMarginSM:j,handleSizeSM:c,calc:p}=n,k=`${t}-inner`,N=J(p(c).add(p(g).mul(2)).equal()),u=J(p(j).mul(2).equal());return{[t]:{[`&${t}-small`]:{minWidth:b,height:l,lineHeight:J(l),[`${t}-inner`]:{paddingInlineStart:j,paddingInlineEnd:y,[`${k}-checked, ${k}-unchecked`]:{minHeight:l},[`${k}-checked`]:{marginInlineStart:`calc(-100% + ${N} - ${u})`,marginInlineEnd:`calc(100% - ${N} + ${u})`},[`${k}-unchecked`]:{marginTop:p(l).mul(-1).equal(),marginInlineStart:0,marginInlineEnd:0}},[`${t}-handle`]:{width:c,height:c},[`${t}-loading-icon`]:{top:p(p(c).sub(n.switchLoadingIconSize)).div(2).equal(),fontSize:n.switchLoadingIconSize},[`&${t}-checked`]:{[`${t}-inner`]:{paddingInlineStart:y,paddingInlineEnd:j,[`${k}-checked`]:{marginInlineStart:0,marginInlineEnd:0},[`${k}-unchecked`]:{marginInlineStart:`calc(100% - ${N} + ${u})`,marginInlineEnd:`calc(-100% + ${N} - ${u})`}},[`${t}-handle`]:{insetInlineStart:`calc(100% - ${J(p(c).add(g).equal())})`}},[`&:not(${t}-disabled):active`]:{[`&:not(${t}-checked) ${k}`]:{[`${k}-unchecked`]:{marginInlineStart:p(n.marginXXS).div(2).equal(),marginInlineEnd:p(n.marginXXS).mul(-1).div(2).equal()}},[`&${t}-checked ${k}`]:{[`${k}-checked`]:{marginInlineStart:p(n.marginXXS).mul(-1).div(2).equal(),marginInlineEnd:p(n.marginXXS).div(2).equal()}}}}}}},Jn=n=>{const{componentCls:t,handleSize:l,calc:g}=n;return{[t]:{[`${t}-loading-icon${n.iconCls}`]:{position:"relative",top:g(g(l).sub(n.fontSize)).div(2).equal(),color:n.switchLoadingIconColor,verticalAlign:"top"},[`&${t}-checked ${t}-loading-icon`]:{color:n.switchColor}}}},Zn=n=>{const{componentCls:t,trackPadding:l,handleBg:g,handleShadow:b,handleSize:y,calc:j}=n,c=`${t}-handle`;return{[t]:{[c]:{position:"absolute",top:l,insetInlineStart:l,width:y,height:y,transition:`all ${n.switchDuration} ease-in-out`,"&::before":{position:"absolute",top:0,insetInlineEnd:0,bottom:0,insetInlineStart:0,backgroundColor:g,borderRadius:j(y).div(2).equal(),boxShadow:b,transition:`all ${n.switchDuration} ease-in-out`,content:'""'}},[`&${t}-checked ${c}`]:{insetInlineStart:`calc(100% - ${J(j(y).add(l).equal())})`},[`&:not(${t}-disabled):active`]:{[`${c}::before`]:{insetInlineEnd:n.switchHandleActiveInset,insetInlineStart:0},[`&${t}-checked ${c}::before`]:{insetInlineEnd:0,insetInlineStart:n.switchHandleActiveInset}}}}},et=n=>{const{componentCls:t,trackHeight:l,trackPadding:g,innerMinMargin:b,innerMaxMargin:y,handleSize:j,calc:c}=n,p=`${t}-inner`,k=J(c(j).add(c(g).mul(2)).equal()),N=J(c(y).mul(2).equal());return{[t]:{[p]:{display:"block",overflow:"hidden",borderRadius:100,height:"100%",paddingInlineStart:y,paddingInlineEnd:b,transition:`padding-inline-start ${n.switchDuration} ease-in-out, padding-inline-end ${n.switchDuration} ease-in-out`,[`${p}-checked, ${p}-unchecked`]:{display:"block",color:n.colorTextLightSolid,fontSize:n.fontSizeSM,transition:`margin-inline-start ${n.switchDuration} ease-in-out, margin-inline-end ${n.switchDuration} ease-in-out`,pointerEvents:"none",minHeight:l},[`${p}-checked`]:{marginInlineStart:`calc(-100% + ${k} - ${N})`,marginInlineEnd:`calc(100% - ${k} + ${N})`},[`${p}-unchecked`]:{marginTop:c(l).mul(-1).equal(),marginInlineStart:0,marginInlineEnd:0}},[`&${t}-checked ${p}`]:{paddingInlineStart:b,paddingInlineEnd:y,[`${p}-checked`]:{marginInlineStart:0,marginInlineEnd:0},[`${p}-unchecked`]:{marginInlineStart:`calc(100% - ${k} + ${N})`,marginInlineEnd:`calc(-100% + ${k} - ${N})`}},[`&:not(${t}-disabled):active`]:{[`&:not(${t}-checked) ${p}`]:{[`${p}-unchecked`]:{marginInlineStart:c(g).mul(2).equal(),marginInlineEnd:c(g).mul(-1).mul(2).equal()}},[`&${t}-checked ${p}`]:{[`${p}-checked`]:{marginInlineStart:c(g).mul(-1).mul(2).equal(),marginInlineEnd:c(g).mul(2).equal()}}}}}},nt=n=>{const{componentCls:t,trackHeight:l,trackMinWidth:g}=n;return{[t]:Object.assign(Object.assign(Object.assign(Object.assign({},Mn(n)),{position:"relative",display:"inline-block",boxSizing:"border-box",minWidth:g,height:l,lineHeight:J(l),verticalAlign:"middle",background:n.colorTextQuaternary,border:"0",borderRadius:100,cursor:"pointer",transition:`all ${n.motionDurationMid}`,userSelect:"none",[`&:hover:not(${t}-disabled)`]:{background:n.colorTextTertiary}}),xn(n)),{[`&${t}-checked`]:{background:n.switchColor,[`&:hover:not(${t}-disabled)`]:{background:n.colorPrimaryHover}},[`&${t}-loading, &${t}-disabled`]:{cursor:"not-allowed",opacity:n.switchDisabledOpacity,"*":{boxShadow:"none",cursor:"not-allowed"}},[`&${t}-rtl`]:{direction:"rtl"}})}},tt=n=>{const{fontSize:t,lineHeight:l,controlHeight:g,colorWhite:b}=n,y=t*l,j=g/2,c=2,p=y-c*2,k=j-c*2;return{trackHeight:y,trackHeightSM:j,trackMinWidth:p*2+c*4,trackMinWidthSM:k*2+c*2,trackPadding:c,handleBg:b,handleSize:p,handleSizeSM:k,handleShadow:`0 2px 4px 0 ${new Cn("#00230b").setA(.2).toRgbString()}`,innerMinMargin:p/2,innerMaxMargin:p+c+c*2,innerMinMarginSM:k/2,innerMaxMarginSM:k+c+c*2}},at=yn("Switch",n=>{const t=kn(n,{switchDuration:n.motionDurationMid,switchColor:n.colorPrimary,switchDisabledOpacity:n.opacityLoading,switchLoadingIconSize:n.calc(n.fontSizeIcon).mul(.75).equal(),switchLoadingIconColor:`rgba(0, 0, 0, ${n.opacityLoading})`,switchHandleActiveInset:"-30%"});return[nt(t),et(t),Zn(t),Jn(t),Yn(t)]},tt);var st=function(n,t){var l={};for(var g in n)Object.prototype.hasOwnProperty.call(n,g)&&t.indexOf(g)<0&&(l[g]=n[g]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var b=0,g=Object.getOwnPropertySymbols(n);b<g.length;b++)t.indexOf(g[b])<0&&Object.prototype.propertyIsEnumerable.call(n,g[b])&&(l[g[b]]=n[g[b]]);return l};const it=o.forwardRef((n,t)=>{const{prefixCls:l,size:g,disabled:b,loading:y,className:j,rootClassName:c,style:p,checked:k,value:N,defaultChecked:u,defaultValue:R,onChange:M}=n,Z=st(n,["prefixCls","size","disabled","loading","className","rootClassName","style","checked","value","defaultChecked","defaultValue","onChange"]),[E,ee]=nn(!1,{value:k??N,defaultValue:u??R}),{getPrefixCls:ne,direction:w,switch:A}=o.useContext(vn),K=o.useContext(jn),se=(b??K)||y,O=ne("switch",l),X=o.createElement("div",{className:`${O}-handle`},y&&o.createElement(wn,{className:`${O}-loading-icon`})),[U,L,q]=at(O),fe=In(g),ve=tn(A==null?void 0:A.className,{[`${O}-small`]:fe==="small",[`${O}-loading`]:y,[`${O}-rtl`]:w==="rtl"},j,c,L,q),ge=Object.assign(Object.assign({},A==null?void 0:A.style),p),je=(...de)=>{ee(de[0]),M==null||M.apply(void 0,de)};return U(o.createElement($n,{component:"Switch",disabled:se},o.createElement(an,Object.assign({},Z,{checked:E,onChange:je,prefixCls:O,className:ve,style:ge,disabled:se,ref:t,loadingIcon:X}))))}),sn=it;sn.__ANT_SWITCH=!0;const{Paragraph:ot,Text:v,Title:me}=Nn;function xe(n){return String(n||"").trim()}function on(n){const t=String(n||"").trim().toUpperCase();return t==="A"||t==="B"||t==="C"?t:"C"}function Ze(n,t){return t==="a"?n==="A":t==="ab"?n==="A"||n==="B":!0}function rt(n){const t=Math.round(Number(n.skuPlanningHorizonMonths||0)),l=t===6||t===18?t:12,g=String(n.skuPlanningAbcFilter||"abc").trim().toLowerCase(),b=g==="a"||g==="ab"?g:"abc",y=Math.round(Number(n.skuPlanningMaxPhantomSuggestionsPerSku||0)),j=Number.isFinite(y)&&y>0?y:3;return{horizonMonths:l,abcScope:b,maxPhantomSuggestionsPerSku:j,showSimulationDefault:n.skuPlanningShowSimulationByDefault!==!1}}function lt(n){if(!Un(n.includeInForecast,!0))return!1;if(typeof n.active=="boolean")return n.active;const t=String(n.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function ct(n){const t=String(n||"").trim();return/^\d{4}-\d{2}-\d{2}$/.test(t)?t.slice(0,7):null}function pe(n){const t=B(n);return t?`${t}-01`:null}function ae(n){const t=Number(n);return Number.isFinite(t)?Math.round(t).toLocaleString("de-DE"):"—"}function Ne(n){if(!n)return"—";const t=new Date(n);return Number.isNaN(t.getTime())?n:t.toLocaleDateString("de-DE")}function ut(n){if(!/^\d{4}-\d{2}$/.test(n||""))return 30;const[t,l]=n.split("-").map(Number);return new Date(t,l,0).getDate()}function P(n){const t=Number(n);return Number.isFinite(t)?t:null}function Ce(n,t=0){const l=Math.round(Number(n));return!Number.isFinite(l)||l<=0?t:l}function dt(n){return`${n}-${Math.random().toString(36).slice(2,10)}`}function ht(n){const t=Tn({projectionMode:"units",endAvailable:n.endAvailable,safetyUnits:n.safetyUnits,doh:n.doh,safetyDays:n.safetyDays});return t==="safety-negative"?"oos":t==="safety-low"?"under_safety":"ok"}function en(n){return n==="oos"?s.jsx($,{color:"red",children:"OOS Risiko"}):n==="under_safety"?s.jsx($,{color:"gold",children:"Unter Safety"}):s.jsx($,{color:"green",children:"Stabil"})}function mt(n){const t=ct(n.requiredArrivalDate)||B(n.firstRiskMonth)||B(n.orderMonth);return t?{id:n.id,sku:xe(n.sku),alias:String(n.alias||n.sku||""),abcClass:on(n.abcClass),arrivalMonth:t,arrivalDate:n.requiredArrivalDate||pe(t),suggestedUnits:Math.max(1,Ce(n.suggestedUnits,1)),recommendedOrderDate:n.recommendedOrderDate||n.latestOrderDate||null,firstRiskMonth:B(n.firstRiskMonth),orderMonth:B(n.orderMonth),leadTimeDays:Ce(n.leadTimeDays,0)||null,source:"auto",note:"Automatischer Vorschlag"}:null}function Ee(n){const t=String(n||"").trim();return t.startsWith("/v2/")?t:"/v2/sku-planung"}function zt(){const n=Dn(),t=Pn(),{state:l,loading:g,error:b}=qn(),y=l,j=l.settings||{},c=o.useMemo(()=>rt(j),[j]),[p]=o.useState(()=>Ln()),[k,N]=o.useState(""),[u,R]=o.useState(""),[M,Z]=o.useState("units"),[E,ee]=o.useState(!0),ne=o.useRef(!1),[w,A]=o.useState(""),K=o.useRef(""),[se,O]=o.useState(!1),[X,U]=o.useState(""),[L,q]=o.useState(0),[fe,ve]=o.useState([]),[ge,je]=o.useState([]),[de,Ae]=o.useState({}),[T,Se]=o.useState(null);o.useEffect(()=>{ne.current||(ne.current=!0,ee(c.showSimulationDefault))},[c.showSimulationDefault]),o.useEffect(()=>{K.current=w},[w]);const S=o.useMemo(()=>Hn(p,c.horizonMonths),[c.horizonMonths,p]),Ue=o.useMemo(()=>Rn(p,-1),[p]),Ie=o.useMemo(()=>On(y).bySku,[l.forecast,l.products,y]),rn=o.useMemo(()=>{const e=l.forecast||{};return Kn(e)},[l.forecast]),te=o.useMemo(()=>(Array.isArray(l.products)?l.products:[]).map(e=>e).map(e=>{const a=xe(e.sku),i=String(e.alias||a),r=Ie.get(a.toLowerCase())||Ie.get(a);return{sku:a,alias:i,abcClass:on(r==null?void 0:r.abcClass),isActive:lt(e)}}).filter(e=>e.sku&&e.isActive).filter(e=>Ze(e.abcClass,c.abcScope)).sort((e,a)=>{const i=e.alias.localeCompare(a.alias,"de-DE",{sensitivity:"base"});return i!==0?i:e.sku.localeCompare(a.sku,"de-DE",{sensitivity:"base"})}),[Ie,c.abcScope,l.products]),Q=o.useMemo(()=>Fn({state:y,months:S,products:te.map(e=>({sku:e.sku,alias:e.alias,status:"active"})),snapshot:null,snapshotMonth:Ue,projectionMode:"units"}),[S,te,Ue,y]),F=o.useMemo(()=>{const e=k.trim().toLowerCase();return te.map(a=>{const i=Q.perSkuMonth.get(a.sku);let r=null,m="ok";for(const d of S){const h=i==null?void 0:i.get(d);if(!h)continue;const C=ht({endAvailable:P(h.endAvailable),safetyUnits:P(h.safetyUnits),doh:P(h.doh),safetyDays:P(h.safetyDays)});if(C!=="ok"){r=d,m=C;break}}return{key:a.sku,sku:a.sku,alias:a.alias,abcClass:a.abcClass,status:m,nextCriticalMonth:r}}).filter(a=>e?`${a.alias} ${a.sku}`.toLowerCase().includes(e):!0).sort((a,i)=>{const r=C=>C==="oos"?0:C==="under_safety"?1:2,m=r(a.status)-r(i.status);if(m!==0)return m;const d=String(a.nextCriticalMonth||"9999-12").localeCompare(String(i.nextCriticalMonth||"9999-12"));if(d!==0)return d;const h=a.alias.localeCompare(i.alias,"de-DE",{sensitivity:"base"});return h!==0?h:a.sku.localeCompare(i.sku,"de-DE",{sensitivity:"base"})})},[S,te,Q.perSkuMonth,k]),x=o.useMemo(()=>F.find(e=>e.sku===u)||null,[F,u]);o.useEffect(()=>{var i;const e=new URLSearchParams(t.search),a=xe(e.get("sku"));if(a&&F.some(r=>r.sku===a)){u!==a&&R(a);return}(!u||!F.some(r=>r.sku===u))&&R(((i=F[0])==null?void 0:i.sku)||"")},[t.search,F,u]),o.useEffect(()=>{if(!S.length){A("");return}A(e=>e&&S.includes(e)?e:x!=null&&x.nextCriticalMonth&&S.includes(x.nextCriticalMonth)?x.nextCriticalMonth:S[0])},[S,x==null?void 0:x.nextCriticalMonth,u]);const ze=o.useMemo(()=>{const e=new Map;return(Array.isArray(l.pos)?l.pos:[]).map(a=>a).forEach(a=>{const i=String(a.id||"").trim();if(!i)return;const r=String(a.poNo||i).trim();e.set(i,r||i)}),e},[l.pos]),Oe=o.useMemo(()=>{const e=new Map;return(Array.isArray(l.fos)?l.fos:[]).map(a=>a).forEach(a=>{const i=String(a.id||"").trim();if(!i)return;const r=String(a.foNo||a.foNumber||i.slice(-6).toUpperCase()||i);e.set(i,r)}),e},[l.fos]),Fe=o.useMemo(()=>!S.length||!te.length?[]:Bn({state:y,months:S,targetMonth:S[S.length-1]||null,maxSuggestions:Math.max(20,te.length*c.maxPhantomSuggestionsPerSku*2)}),[S,c.maxPhantomSuggestionsPerSku,te.length,l.fos,l.forecast,l.pos,l.products,l.settings,y]),be=o.useMemo(()=>new Set(ge),[ge]),Te=o.useMemo(()=>new Set(fe),[fe]),ie=o.useMemo(()=>u?Fe.map(e=>mt(e)).filter(e=>!!e).filter(e=>e.sku===u).filter(e=>Ze(e.abcClass,c.abcScope)).filter(e=>!Te.has(e.id)&&!be.has(e.id)).slice(0,c.maxPhantomSuggestionsPerSku):[],[be,Fe,Te,c.abcScope,c.maxPhantomSuggestionsPerSku,u]),oe=o.useMemo(()=>u?(de[u]||[]).filter(e=>!be.has(e.id)):[],[be,de,u]),ye=o.useMemo(()=>E?[...ie,...oe]:[],[ie,oe,E]),Be=o.useMemo(()=>{const e=new Map;return[...ie,...oe].forEach(a=>{e.set(a.id,a)}),e},[ie,oe]),H=o.useMemo(()=>{if(!u||!S.length)return[];const e=Q.perSkuMonth.get(u),a=new Map;ye.forEach(m=>{const d=B(m.arrivalMonth);d&&a.set(d,(a.get(d)||0)+Math.max(0,Number(m.suggestedUnits||0)))});let i=Number(Q.startAvailableBySku.get(u)||0),r=!1;return S.map(m=>{const d=e==null?void 0:e.get(m),h=P(d==null?void 0:d.forecastUnits),C=P(d==null?void 0:d.endAvailable),D=P(d==null?void 0:d.doh),le=P(d==null?void 0:d.safetyUnits),f=P(d==null?void 0:d.safetyDays),Y=Math.max(0,Number((d==null?void 0:d.inboundUnits)||0)),z=Math.max(0,Number(a.get(m)||0));let I=C;E&&(r||!Number.isFinite(h)?(I=null,r=!0):(I=i+Y+z-Number(h||0),i=I));const ce=Number.isFinite(I)&&Number.isFinite(h)&&Number(h)>0?Math.max(0,Math.round(Number(I)/(Number(h)/ut(m)))):null;return{month:m,forecastUnits:h,baseUnits:C,baseDoh:D,simulatedUnits:I,simulatedDoh:ce,safetyUnits:le,safetyDoh:f,realInboundUnits:Y,phantomInboundUnits:z}})},[ye,S,Q.perSkuMonth,Q.startAvailableBySku,u,E]),ke=o.useMemo(()=>new Map(H.map(e=>[e.month,e])),[H]),G=o.useMemo(()=>{const e=new Map;if(S.forEach(r=>e.set(r,[])),!u)return e;const a=Q.inboundDetailsMap.get(u);a==null||a.forEach((r,m)=>{if(!e.has(m))return;const d=e.get(m);(Array.isArray(r.poItems)?r.poItems:[]).forEach((h,C)=>{const D=ze.get(String(h.id||""))||String(h.ref||"");d.push({id:`po-${m}-${C}-${String(h.id||"")}`,type:"po",label:D||"PO",units:Math.max(0,Math.round(Number(h.units||0))),month:m,date:h.arrivalDate||pe(m),poNo:D||null,foId:null,phantomEntryId:null})}),(Array.isArray(r.foItems)?r.foItems:[]).forEach((h,C)=>{const D=String(h.id||"").trim();d.push({id:`fo-${m}-${C}-${D}`,type:"fo",label:Oe.get(D)||String(h.ref||D||"FO"),units:Math.max(0,Math.round(Number(h.units||0))),month:m,date:h.arrivalDate||pe(m),poNo:null,foId:D||null,phantomEntryId:null})})}),E&&ye.forEach(r=>{if(!e.has(r.arrivalMonth))return;e.get(r.arrivalMonth).push({id:`phantom-${r.id}`,type:"phantom",label:`${r.source==="manual"?"Manuell":"Vorschlag"} ${r.id.slice(-6).toUpperCase()}`,units:Math.max(0,Math.round(Number(r.suggestedUnits||0))),month:r.arrivalMonth,date:r.arrivalDate||pe(r.arrivalMonth),poNo:null,foId:null,phantomEntryId:r.id})});const i=r=>r==="po"?0:r==="fo"?1:2;return e.forEach(r=>{r.sort((m,d)=>{const h=i(m.type)-i(d.type);if(h!==0)return h;const C=Number(d.units||0)-Number(m.units||0);return C!==0?C:m.label.localeCompare(d.label,"de-DE",{sensitivity:"base"})})}),e},[ye,Oe,S,ze,Q.inboundDetailsMap,u,E]),Le=o.useMemo(()=>G.get(w)||[],[w,G]),ln=o.useCallback(e=>{const a=xe(e);if(!a)return;R(a);const i=new URLSearchParams(t.search);i.set("sku",a);const r=i.toString();n({pathname:t.pathname,search:r?`?${r}`:""},{replace:!0})},[t.pathname,t.search,n]),He=o.useCallback(e=>{if(!u||!S.length)return;const a=B(e||w||S[0])||S[0];U(a),q(0),O(!0)},[w,S,u]),cn=o.useCallback(()=>{if(!u)return;const e=B(X),a=Ce(L,0);if(!e||!S.includes(e)||a<=0)return;const i=F.find(m=>m.sku===u)||null,r={id:dt("manual-phantom"),sku:u,alias:(i==null?void 0:i.alias)||u,abcClass:(i==null?void 0:i.abcClass)||"C",arrivalMonth:e,arrivalDate:pe(e),suggestedUnits:a,recommendedOrderDate:null,firstRiskMonth:e,orderMonth:e,leadTimeDays:null,source:"manual",note:"Manuell hinzugefuegt"};Ae(m=>({...m,[u]:[...m[u]||[],r]})),ee(!0),O(!1),A(e)},[X,L,F,S,u]),$e=o.useCallback(e=>{if(e.source==="auto"){ve(a=>a.includes(e.id)?a:[...a,e.id]);return}Ae(a=>{const i={...a};return i[e.sku]=(i[e.sku]||[]).filter(r=>r.id!==e.id),i})},[]),Re=o.useCallback(e=>{if(!e)return;const a=new URLSearchParams;a.set("source","fo_convert"),a.set("poNo",e),a.set("returnTo",Ee(t.pathname)),u&&a.set("returnSku",u),n(`/v2/orders/po?${a.toString()}`)},[t.pathname,n,u]),Ke=o.useCallback(e=>{if(!e)return;const a=new URLSearchParams;a.set("source","orders_sku"),a.set("foId",e),a.set("returnTo",Ee(t.pathname)),u&&a.set("returnSku",u),n(`/v2/orders/fo?${a.toString()}`)},[t.pathname,n,u]),we=o.useCallback(e=>{je(i=>i.includes(e.id)?i:[...i,e.id]);const a=new URLSearchParams;a.set("source","phantom_fo"),a.set("phantomId",e.id),a.set("sku",e.sku),a.set("month",e.arrivalMonth),a.set("suggestedUnits",String(Math.max(1,Math.round(Number(e.suggestedUnits||0))))),e.arrivalDate&&a.set("requiredArrivalDate",e.arrivalDate),e.recommendedOrderDate&&a.set("recommendedOrderDate",e.recommendedOrderDate),e.firstRiskMonth&&a.set("firstRiskMonth",e.firstRiskMonth),e.orderMonth&&a.set("orderMonth",e.orderMonth),Number.isFinite(Number(e.leadTimeDays))&&a.set("leadTimeDays",String(Math.max(1,Math.round(Number(e.leadTimeDays||0))))),a.set("returnTo",Ee(t.pathname)),a.set("returnSku",e.sku),n(`/v2/orders/fo?${a.toString()}`)},[t.pathname,n]),De=o.useCallback(e=>{if(e.type==="po"){Re(e.poNo);return}if(e.type==="fo"){Ke(e.foId);return}const a=e.phantomEntryId&&Be.get(e.phantomEntryId)||null;a&&Se(a)},[Ke,Re,Be]),re=o.useMemo(()=>{const e=[],a=[],i=[];return S.forEach(r=>{const m=G.get(r)||[],d={po:[],fo:[],phantom:[]};m.forEach(h=>{d[h.type].push(h)}),["po","fo","phantom"].forEach(h=>{d[h].forEach((D,le)=>{const f=ke.get(r),Y=h==="phantom"?M==="doh"?f==null?void 0:f.simulatedDoh:f==null?void 0:f.simulatedUnits:M==="doh"?f==null?void 0:f.baseDoh:f==null?void 0:f.baseUnits,z=M==="doh"?f==null?void 0:f.safetyDoh:f==null?void 0:f.safetyUnits,I=Number.isFinite(Y)?Number(Y):Number.isFinite(z)?Number(z):0,ce=(M==="doh"?1.2:30)*le,he={value:[r,Math.max(0,I+ce)],month:r,eventType:D.type,eventId:D.id,label:D.label,units:D.units};h==="po"?e.push(he):h==="fo"?a.push(he):i.push(he)})})}),{po:e,fo:a,phantom:i}},[ke,G,S,M]),un=o.useMemo(()=>{const e=H.map(f=>P(f.baseUnits)),a=H.map(f=>P(f.simulatedUnits)),i=H.map(f=>P(f.baseDoh)),r=H.map(f=>P(f.simulatedDoh)),m=H.map(f=>P(f.safetyUnits)),d=H.map(f=>P(f.safetyDoh)),h=H.map(f=>P(f.forecastUnits)),C=M==="doh"?i:e,D=M==="doh"?r:a,le=M==="doh"?d:m;return{animation:!1,grid:{left:56,right:62,top:42,bottom:58},legend:{top:8},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:f=>{var Ve,_e;const Y=Array.isArray(f)?f:[f],z=B(((Ve=Y[0])==null?void 0:Ve.axisValue)||((_e=Y[0])==null?void 0:_e.name)||"");z&&z!==K.current&&A(z);const I=z&&ke.get(z)||null,ce=z?G.get(z)||[]:[],he=M==="doh"?I==null?void 0:I.simulatedDoh:I==null?void 0:I.simulatedUnits,pn=M==="doh"?"Bestand (DOH)":"Bestand (Units)",fn=ce.length?ce.map(Pe=>`${String(Pe.type||"").toUpperCase()} ${Pe.label}: ${ae(Pe.units)}`).join("<br/>"):"Keine Events";return[`<div><strong>${z?_(z):"—"}</strong></div>`,`<div>${pn}: ${ae(he)}</div>`,`<div>Plan-Absatz: ${ae(I==null?void 0:I.forecastUnits)}</div>`,"<div>Events:</div>",`<div>${fn}</div>`].join("")}},xAxis:{type:"category",data:S,axisLabel:{formatter:f=>_(String(f||""))}},yAxis:[{type:"value",min:0,name:M==="doh"?"DOH":"Units"},{type:"value",min:0,name:"Plan",splitLine:{show:!1}}],series:[{name:"Plan-Absatz",type:"bar",yAxisIndex:1,itemStyle:{color:"#64748b",opacity:.26},emphasis:{itemStyle:{opacity:.35}},data:h},{name:"Safety Bereich",type:"line",smooth:!1,symbol:"none",lineStyle:{opacity:0},areaStyle:{color:"rgba(245, 158, 11, 0.12)"},data:le},{name:"Safety",type:"line",smooth:!1,symbol:"none",lineStyle:{width:1,type:"dashed",color:"#f59e0b"},data:le},{name:"Bestand Basis",type:"line",smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:"#2563eb"},itemStyle:{color:"#2563eb"},markLine:{symbol:"none",lineStyle:{type:"dotted",color:"#ef4444"},data:[{yAxis:0,name:"OOS"}]},data:C},...E?[{name:"Bestand Simulation",type:"line",smooth:!0,symbol:"diamond",symbolSize:6,lineStyle:{width:2,color:"#ea580c"},itemStyle:{color:"#ea580c"},data:D}]:[],{name:"PO Ankunft",type:"scatter",symbol:"circle",symbolSize:11,itemStyle:{color:"#0f766e",borderColor:"#134e4a",borderWidth:1},tooltip:{show:!1},data:re.po},{name:"FO Ankunft",type:"scatter",symbol:"diamond",symbolSize:11,itemStyle:{color:"#16a34a",borderColor:"#166534",borderWidth:1},tooltip:{show:!1},data:re.fo},...E?[{name:"Phantom Ankunft",type:"scatter",symbol:"triangle",symbolSize:13,itemStyle:{color:"#f97316",borderColor:"#9a3412",borderWidth:1},tooltip:{show:!1},data:re.phantom}]:[]]}},[ke,H,re.fo,re.phantom,re.po,G,S,E,M]),dn=o.useMemo(()=>({click:e=>{var d;const a=e!=null&&e.data&&typeof e.data=="object"?e.data:{},i=String(a.eventType||""),r=String(a.eventId||""),m=B(a.month||(e==null?void 0:e.name)||((d=e==null?void 0:e.value)==null?void 0:d[0])||"");if(m&&A(m),i&&r&&m){const h=(G.get(m)||[]).find(C=>C.id===r&&C.type===i);h&&De(h)}},updateAxisPointer:e=>{const a=Array.isArray(e==null?void 0:e.axesInfo)?e.axesInfo[0]:null;if(!a)return;let i=null;typeof a.value=="number"?i=S[a.value]||null:i=B(a.value),i&&i!==K.current&&A(i)}}),[G,De,S]),hn=o.useMemo(()=>[{title:"ABC",dataIndex:"abcClass",width:74,align:"center"},{title:"Alias",dataIndex:"alias",ellipsis:!0},{title:"SKU",dataIndex:"sku",width:180,ellipsis:!0},{title:"Status",dataIndex:"status",width:150,render:e=>en(e)},{title:"Naechster kritischer Monat",dataIndex:"nextCriticalMonth",width:190,render:e=>e?_(e):"—"}],[]),Me=o.useMemo(()=>{const e=F.filter(i=>i.status==="oos").length,a=F.filter(i=>i.status==="under_safety").length;return{oosCount:e,underSafetyCount:a}},[F]),mn=o.useCallback(e=>e.type==="po"?`PO ${e.label}`:e.type==="fo"?`FO ${e.label}`:`Phantom ${e.label}`,[]),qe=(x==null?void 0:x.alias)||(x==null?void 0:x.sku)||"",We=(x==null?void 0:x.nextCriticalMonth)||null;return s.jsxs("div",{className:"v2-page v2-sku-plan-page",children:[s.jsxs(ue,{className:"v2-intro-card",children:[s.jsx("div",{className:"v2-page-head",children:s.jsxs("div",{children:[s.jsx(me,{level:3,children:"SKU Planung"}),s.jsx(ot,{children:"Interaktive SKU-Planung mit Bestandsverlauf, PO/FO-Ankuenften und Phantom-FO Simulation als reines Overlay."})]})}),s.jsx("div",{className:"v2-toolbar",children:s.jsxs("div",{className:"v2-toolbar-row",children:[s.jsxs($,{color:"blue",children:["Horizont: ",c.horizonMonths," Monate"]}),s.jsxs($,{color:"default",children:["ABC Scope: ",c.abcScope.toUpperCase()]}),s.jsxs($,{color:"default",children:["Max Phantom je SKU: ",c.maxPhantomSuggestionsPerSku]}),s.jsxs($,{color:"green",children:["Forecast: ",rn]}),s.jsxs($,{color:Me.oosCount>0?"red":"green",children:["OOS Risiko: ",Me.oosCount]}),s.jsxs($,{color:Me.underSafetyCount>0?"gold":"green",children:["Unter Safety: ",Me.underSafetyCount]})]})})]}),b?s.jsx(Ge,{type:"error",showIcon:!0,message:b}):null,g?s.jsx(Ge,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,s.jsxs(En,{gutter:[12,12],children:[s.jsx(Ye,{xs:24,xl:10,children:s.jsxs(ue,{children:[s.jsx("div",{className:"v2-toolbar-row",style:{marginBottom:10},children:s.jsx(An,{placeholder:"Suche Alias oder SKU",value:k,onChange:e=>N(e.target.value)})}),s.jsx(Wn,{className:"v2-ant-table v2-sku-planning-overview",rowKey:"key",size:"small",pagination:!1,columns:hn,dataSource:F,locale:{emptyText:"Keine SKU im aktuellen Filter."},rowClassName:e=>e.sku===u?"v2-sku-plan-row-active":"",onRow:e=>({onClick:()=>ln(e.sku)}),scroll:{y:560}})]})}),s.jsx(Ye,{xs:24,xl:14,children:s.jsx(ue,{children:x?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"v2-page-head",style:{marginBottom:10},children:[s.jsxs("div",{children:[s.jsx(me,{level:4,style:{marginBottom:2},children:qe}),s.jsxs(v,{type:"secondary",children:[x.sku," · ABC ",x.abcClass]})]}),s.jsxs(W,{wrap:!0,children:[en(x.status),We?s.jsxs($,{color:"gold",children:["Kritisch ab ",_(We)]}):s.jsx($,{color:"green",children:"Kein kritischer Monat"})]})]}),s.jsxs("div",{className:"v2-toolbar-row v2-sku-planning-controls",style:{marginBottom:8},children:[s.jsx(Xn,{value:M,options:[{value:"units",label:"Units"},{value:"doh",label:"DOH"}],onChange:e=>Z(String(e)==="doh"?"doh":"units")}),s.jsxs(W,{size:8,children:[s.jsx(v,{type:"secondary",children:"Simulation"}),s.jsx(sn,{checked:E,onChange:ee})]}),s.jsx(V,{onClick:()=>He(w||null),children:"+ Phantom-FO manuell"})]}),s.jsx(zn,{style:{height:420},option:un,onEvents:dn}),s.jsxs("div",{className:"v2-sku-planning-hints",children:[s.jsx($,{children:"PO Marker: Kreis"}),s.jsx($,{color:"green",children:"FO Marker: Diamant"}),E?s.jsx($,{color:"orange",children:"Phantom Marker: Dreieck (Simulation)"}):s.jsx($,{color:"default",children:"Simulation aus"}),s.jsx(v,{type:"secondary",children:"Marker anklicken oeffnet PO/FO/Phantom-Detail."})]}),s.jsxs(ue,{size:"small",style:{marginTop:10},children:[s.jsxs(W,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[s.jsxs(me,{level:5,style:{margin:0},children:["Monat im Fokus: ",w?_(w):"—"]}),s.jsx(V,{size:"small",onClick:()=>He(w||null),children:"Phantom fuer Monat hinzufuegen"})]}),Le.length?s.jsx("div",{className:"v2-sku-planning-focus-list",children:Le.map(e=>s.jsx("div",{className:"v2-sku-planning-focus-item",children:s.jsxs(W,{wrap:!0,children:[s.jsx($,{color:e.type==="po"?"blue":e.type==="fo"?"green":"orange",children:e.type.toUpperCase()}),s.jsx(v,{strong:!0,children:mn(e)}),s.jsxs(v,{type:"secondary",children:["Menge: ",ae(e.units)]}),s.jsxs(v,{type:"secondary",children:["Datum: ",Ne(e.date)]}),s.jsx(V,{size:"small",onClick:()=>De(e),children:"Oeffnen"})]})},e.id))}):s.jsx(v,{type:"secondary",children:"Keine Events in diesem Monat."})]}),s.jsxs(ue,{size:"small",style:{marginTop:10},children:[s.jsx(me,{level:5,style:{marginTop:0},children:"Automatische Phantom-FO Vorschlaege"}),ie.length?s.jsx("div",{className:"v2-sku-planning-focus-list",children:ie.map(e=>s.jsx("div",{className:"v2-sku-planning-focus-item",children:s.jsxs(W,{wrap:!0,children:[s.jsx($,{color:"orange",children:"Vorschlag"}),s.jsxs(v,{strong:!0,children:["Ankunft ",_(e.arrivalMonth)]}),s.jsxs(v,{children:["Menge ",ae(e.suggestedUnits)]}),s.jsxs(v,{type:"secondary",children:["Bestellen bis: ",Ne(e.recommendedOrderDate)]}),s.jsx(V,{size:"small",type:"primary",onClick:()=>we(e),children:"Als echte FO anlegen"}),s.jsx(V,{size:"small",onClick:()=>$e(e),children:"Verwerfen"})]})},e.id))}):s.jsx(v,{type:"secondary",children:"Keine Vorschlaege fuer diese SKU im aktuellen Horizont."})]}),s.jsxs(ue,{size:"small",style:{marginTop:10},children:[s.jsx(me,{level:5,style:{marginTop:0},children:"Manuelle Phantom-FOs"}),oe.length?s.jsx("div",{className:"v2-sku-planning-focus-list",children:oe.map(e=>s.jsx("div",{className:"v2-sku-planning-focus-item",children:s.jsxs(W,{wrap:!0,children:[s.jsx($,{children:"Manuell"}),s.jsxs(v,{strong:!0,children:["Ankunft ",_(e.arrivalMonth)]}),s.jsxs(v,{children:["Menge ",ae(e.suggestedUnits)]}),s.jsx(V,{size:"small",type:"primary",onClick:()=>we(e),children:"Als echte FO anlegen"}),s.jsx(V,{size:"small",onClick:()=>$e(e),children:"Entfernen"})]})},e.id))}):s.jsx(v,{type:"secondary",children:"Noch keine manuellen Phantom-FOs."})]})]}):s.jsx(Vn,{description:"Bitte eine SKU aus der Liste waehlen."})})})]}),s.jsx(Je,{title:"Phantom-FO manuell hinzufügen",open:se,onCancel:()=>O(!1),onOk:cn,okButtonProps:{disabled:!X||L<=0},children:s.jsxs(W,{direction:"vertical",style:{width:"100%"},children:[s.jsxs(v,{type:"secondary",children:["SKU: ",qe||u||"—"]}),s.jsx(_n,{value:X||void 0,onChange:e=>U(String(e||"")),options:S.map(e=>({value:e,label:_(e)}))}),s.jsx(Qn,{value:L,min:1,style:{width:"100%"},controls:!1,onChange:e=>q(Ce(e,0)),placeholder:"Menge (Units)"})]})}),s.jsx(Je,{title:"Phantom-FO Detail",open:!!T,onCancel:()=>Se(null),footer:T?s.jsxs(W,{children:[s.jsx(V,{onClick:()=>{$e(T),Se(null)},children:"Verwerfen"}),s.jsx(V,{type:"primary",onClick:()=>{we(T),Se(null)},children:"Als echte FO anlegen"})]}):null,children:T?s.jsxs(W,{direction:"vertical",children:[s.jsxs(v,{children:["SKU: ",s.jsxs("strong",{children:[T.alias," (",T.sku,")"]})]}),s.jsxs(v,{children:["ABC: ",T.abcClass]}),s.jsxs(v,{children:["Ankunft: ",_(T.arrivalMonth)]}),s.jsxs(v,{children:["Menge: ",ae(T.suggestedUnits)]}),s.jsxs(v,{children:["Bestellen bis: ",Ne(T.recommendedOrderDate)]}),s.jsx(v,{type:"secondary",children:"Hinweis: Phantom-FOs werden nur in der SKU Planung als Simulation angezeigt und nicht in P&L/Cashflow verbucht."})]}):null})]})}export{zt as default};
