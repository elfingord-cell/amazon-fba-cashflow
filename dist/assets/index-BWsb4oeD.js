import{t as f,k as e,J as W,K as x,L as g,M as G,S as E,a5 as N,P as Z}from"./index-CAzQztwo.js";import{c as J}from"./vatPreview-DzvrCVGo.js";import{u as K,C as O}from"./workspace-xr5uOuIo.js";import{T as b}from"./index-Dab_0RQN.js";import{F as m}from"./Table-v8LS_Cg4.js";import"./cashflow-rmBKYUQ9.js";import"./planProducts-CfB8BW_g.js";import"./Dropdown-CZlZd-6U.js";import"./index-C15xyCf_.js";import"./index-5SR9pC2K.js";import"./useBubbleLock-Cjjrx1CM.js";import"./index-BZ5evjDG.js";import"./Pagination-B0SkKhC9.js";const{Paragraph:q,Text:j,Title:U}=W,H={deBrutto:"DE-Brutto",outputUst:"Output-USt",vstFees:"VSt Fees",fixkostenVst:"Fixkosten-VSt",eustErstattung:"EUSt-Erstattung",zahllast:"Zahllast"};function h(l,s=0){const y=Number(l);return Number.isFinite(y)?y:s}function i(l){const s=Number(l);return Number.isFinite(s)?s.toLocaleString("de-DE",{style:"currency",currency:"EUR"}):"—"}function A(l){return`${(l*100).toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2})} %`}function B(l){const s=l!=null&&l.settings&&typeof l.settings=="object"?l.settings.vatPreview:void 0;return{eustLagMonths:Math.max(0,h(s==null?void 0:s.eustLagMonths,2)),deShareDefault:Math.min(1,Math.max(0,h(s==null?void 0:s.deShareDefault,.8))),feeRateDefault:Math.min(1,Math.max(0,h(s==null?void 0:s.feeRateDefault,.38))),fixInputDefault:Math.max(0,h(s==null?void 0:s.fixInputDefault,0))}}function Q(l){return!l||typeof l!="object"?{}:Object.entries(l).reduce((s,[y,V])=>{if(!/^\d{4}-\d{2}$/.test(y)||!V||typeof V!="object")return s;const p=V;return s[y]={deShare:p.deShare==null?void 0:Math.min(1,Math.max(0,h(p.deShare,0))),feeRateOfGross:p.feeRateOfGross==null?void 0:Math.min(1,Math.max(0,h(p.feeRateOfGross,0))),fixInputVat:p.fixInputVat==null?void 0:Math.max(0,h(p.fixInputVat,0))},s},{})}function de(){const{state:l,loading:s,saving:y,error:V,lastSavedAt:p,saveWith:_}=K(),[n,k]=f.useState(()=>B(l)),[c,L]=f.useState({}),[z,S]=f.useState(!1),[u,D]=f.useState(null),[o,v]=f.useState(null),I=l;f.useEffect(()=>{k(B(I)),L(Q(I.vatPreviewMonths)),S(!1)},[l.settings,l.vatPreviewMonths]);const r=f.useMemo(()=>{const a=structuredClone(I);return(!a.settings||typeof a.settings!="object")&&(a.settings={}),a.settings.vatPreview={eustLagMonths:n.eustLagMonths,deShareDefault:n.deShareDefault,feeRateDefault:n.feeRateDefault,fixInputDefault:n.fixInputDefault},a.vatPreviewMonths=c,J(a)},[c,n,I]),F=f.useMemo(()=>new Map(r.rows.map(a=>[a.month,a])),[r.rows]),T=f.useMemo(()=>r.rows.map(a=>{var t,d;return{key:a.month,month:a.month,monthLabel:a.monthLabel||a.month,grossDe:a.grossDe,outVat:a.outVat,feeInputVat:a.feeInputVat,fixInputVat:a.fixInputVat,eustRefund:a.eustRefund,payable:a.payable,deShare:((t=c[a.month])==null?void 0:t.deShare)??n.deShareDefault,feeRate:((d=c[a.month])==null?void 0:d.feeRateOfGross)??n.feeRateDefault}}),[c,r.rows,n.deShareDefault,n.feeRateDefault]);async function $(){await _(a=>{const t=Z(a),d=t.settings||{};return t.settings={...d,vatPreview:{eustLagMonths:n.eustLagMonths,deShareDefault:n.deShareDefault,feeRateDefault:n.feeRateDefault,fixInputDefault:n.fixInputDefault}},t.vatPreviewMonths=c,t},"v2:vat:save"),S(!1)}function P(a){var t,d,R;D({month:a,values:{deShare:((t=c[a])==null?void 0:t.deShare)??n.deShareDefault,feeRateOfGross:((d=c[a])==null?void 0:d.feeRateOfGross)??n.feeRateDefault,fixInputVat:((R=c[a])==null?void 0:R.fixInputVat)??n.fixInputDefault}})}function w(a){const t=r.months.indexOf(a);if(t<=0)return;const d=r.months[t-1],R=c[d]||{deShare:n.deShareDefault,feeRateOfGross:n.feeRateDefault,fixInputVat:n.fixInputDefault};D(C=>C&&C.month===a?{...C,values:{...R}}:C)}const M=f.useMemo(()=>{var d;if(!o)return null;const a=F.get(o.month);if(!a)return null;const t=(d=a.details)==null?void 0:d[o.key];return t?{row:a,detail:t}:null},[o,F]);return e.jsxs("div",{className:"v2-page",children:[e.jsxs(O,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(U,{level:3,children:"USt Vorschau"}),e.jsx(q,{children:"DE-USt-Vorschau mit Detaildrilldown und Monats-Overrides fuer DE-Anteil, Gebuehrensatz und Fixkosten-VSt."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(x,{type:"primary",onClick:()=>{$()},disabled:!z,loading:y,children:"USt-Einstellungen speichern"}),e.jsx(x,{onClick:()=>{L({}),S(!0)},children:"Monats-Overrides zuruecksetzen"}),z?e.jsx(g,{color:"gold",children:"Ungespeicherte Aenderungen"}):e.jsx(g,{color:"green",children:"Synchron"}),p?e.jsxs(g,{color:"green",children:["Gespeichert: ",new Date(p).toLocaleTimeString("de-DE")]}):null]})})]}),V?e.jsx(G,{type:"error",showIcon:!0,message:V}):null,s?e.jsx(G,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(O,{children:[e.jsx(U,{level:5,children:"Standardwerte"}),e.jsxs(E,{wrap:!0,align:"start",children:[e.jsxs("div",{children:[e.jsx(j,{children:"EUSt Lag (Monate)"}),e.jsx(b,{value:n.eustLagMonths,min:0,onChange:a=>{k(t=>({...t,eustLagMonths:Math.max(0,Number(a||0))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"DE Anteil"}),e.jsx(b,{value:n.deShareDefault,min:0,max:1,step:.01,onChange:a=>{k(t=>({...t,deShareDefault:Math.min(1,Math.max(0,Number(a||0)))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Gebuehrensatz"}),e.jsx(b,{value:n.feeRateDefault,min:0,max:1,step:.01,onChange:a=>{k(t=>({...t,feeRateDefault:Math.min(1,Math.max(0,Number(a||0)))})),S(!0)}})]}),e.jsxs("div",{children:[e.jsx(j,{children:"Fixkosten-VSt pauschal (EUR)"}),e.jsx(b,{value:n.fixInputDefault,min:0,step:10,onChange:a=>{k(t=>({...t,fixInputDefault:Math.max(0,Number(a||0))})),S(!0)}})]})]})]}),e.jsx(O,{children:e.jsxs(E,{wrap:!0,children:[e.jsxs(g,{color:"default",children:["Output-USt gesamt: ",i(r.totals.outVat)]}),e.jsxs(g,{color:"blue",children:["VSt Fees gesamt: ",i(r.totals.feeInputVat)]}),e.jsxs(g,{color:"purple",children:["Fixkosten-VSt gesamt: ",i(r.totals.fixInputVat)]}),e.jsxs(g,{color:r.totals.payable<0?"red":"green",children:["Zahllast gesamt: ",i(r.totals.payable)]})]})}),e.jsx(O,{children:e.jsx(m,{size:"small",pagination:!1,dataSource:T,columns:[{title:"Monat",dataIndex:"monthLabel",key:"monthLabel"},{title:"DE Anteil",key:"deShare",render:(a,t)=>A(t.deShare)},{title:"Gebuehrensatz",key:"feeRate",render:(a,t)=>A(t.feeRate)},{title:"DE-Brutto",key:"grossDe",render:(a,t)=>e.jsx(x,{size:"small",type:"text",onClick:()=>v({month:t.month,key:"deBrutto"}),children:i(t.grossDe)})},{title:"Output-USt",key:"outVat",render:(a,t)=>e.jsx(x,{size:"small",type:"text",onClick:()=>v({month:t.month,key:"outputUst"}),children:i(t.outVat)})},{title:"VSt Fees",key:"feeInputVat",render:(a,t)=>e.jsx(x,{size:"small",type:"text",onClick:()=>v({month:t.month,key:"vstFees"}),children:i(t.feeInputVat)})},{title:"Fixkosten-VSt",key:"fixInputVat",render:(a,t)=>e.jsx(x,{size:"small",type:"text",onClick:()=>v({month:t.month,key:"fixkostenVst"}),children:i(t.fixInputVat)})},{title:"EUSt-Erstattung",key:"eustRefund",render:(a,t)=>e.jsx(x,{size:"small",type:"text",onClick:()=>v({month:t.month,key:"eustErstattung"}),children:i(t.eustRefund)})},{title:"Zahllast",key:"payable",render:(a,t)=>e.jsx(x,{size:"small",type:"text",danger:t.payable<0,onClick:()=>v({month:t.month,key:"zahllast"}),children:i(t.payable)})},{title:"Aktionen",key:"actions",render:(a,t)=>e.jsx(x,{size:"small",onClick:()=>P(t.month),children:"Monat bearbeiten"})}],summary:()=>e.jsxs(m.Summary.Row,{children:[e.jsx(m.Summary.Cell,{index:0,colSpan:3,children:e.jsx("strong",{children:"Summe"})}),e.jsx(m.Summary.Cell,{index:3,children:e.jsx("strong",{children:i(r.totals.grossDe)})}),e.jsx(m.Summary.Cell,{index:4,children:e.jsx("strong",{children:i(r.totals.outVat)})}),e.jsx(m.Summary.Cell,{index:5,children:e.jsx("strong",{children:i(r.totals.feeInputVat)})}),e.jsx(m.Summary.Cell,{index:6,children:e.jsx("strong",{children:i(r.totals.fixInputVat)})}),e.jsx(m.Summary.Cell,{index:7,children:e.jsx("strong",{children:i(r.totals.eustRefund)})}),e.jsx(m.Summary.Cell,{index:8,children:e.jsx("strong",{children:i(r.totals.payable)})}),e.jsx(m.Summary.Cell,{index:9})]})})}),e.jsx(N,{title:u?`Monats-Override ${u.month}`:"Monats-Override",open:!!u,onCancel:()=>D(null),onOk:()=>{u&&(L(a=>({...a,[u.month]:{deShare:Math.min(1,Math.max(0,h(u.values.deShare,n.deShareDefault))),feeRateOfGross:Math.min(1,Math.max(0,h(u.values.feeRateOfGross,n.feeRateDefault))),fixInputVat:Math.max(0,h(u.values.fixInputVat,n.fixInputDefault))}})),S(!0),D(null))},children:u?e.jsxs(E,{direction:"vertical",style:{width:"100%"},children:[e.jsx(x,{onClick:()=>w(u.month),disabled:r.months.indexOf(u.month)<=0,children:"Vormonat uebernehmen"}),e.jsx(j,{children:"DE Anteil"}),e.jsx(b,{value:u.values.deShare,min:0,max:1,step:.01,onChange:a=>D(t=>t&&{...t,values:{...t.values,deShare:h(a,t.values.deShare??n.deShareDefault)}})}),e.jsx(j,{children:"Gebuehrensatz"}),e.jsx(b,{value:u.values.feeRateOfGross,min:0,max:1,step:.01,onChange:a=>D(t=>t&&{...t,values:{...t.values,feeRateOfGross:h(a,t.values.feeRateOfGross??n.feeRateDefault)}})}),e.jsx(j,{children:"Fixkosten-VSt (EUR)"}),e.jsx(b,{value:u.values.fixInputVat,min:0,step:10,onChange:a=>D(t=>t&&{...t,values:{...t.values,fixInputVat:h(a,t.values.fixInputVat??n.fixInputDefault)}})})]}):null}),e.jsx(N,{title:o?`${H[o.key]||o.key} – ${o.month}`:"Details",open:!!o,onCancel:()=>v(null),footer:null,width:900,children:M?e.jsxs(E,{direction:"vertical",style:{width:"100%"},children:[M.detail.formula?e.jsx(j,{type:"secondary",children:M.detail.formula}):null,M.detail.notes?e.jsx(j,{type:"secondary",children:M.detail.notes}):null,e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Posten"}),e.jsx("th",{children:"Info"}),e.jsx("th",{children:"Datum"}),e.jsx("th",{children:"Betrag"})]})}),e.jsx("tbody",{children:(M.detail.items||[]).map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.label||"—"}),e.jsx("td",{children:a.sublabel||"—"}),e.jsx("td",{children:a.date||"—"}),e.jsx("td",{children:i(a.amount||0)})]},`${o==null?void 0:o.month}-${o==null?void 0:o.key}-${t}`))})]})}),e.jsxs(g,{color:"blue",children:["Summe: ",i(M.detail.total||0)]})]}):null})]})}export{de as default};
