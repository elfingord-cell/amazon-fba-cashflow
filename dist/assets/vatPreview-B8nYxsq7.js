import{c as U,p as h}from"./cashflow-BIZjDysg.js";const x=new Intl.DateTimeFormat("de-DE",{month:"long",year:"numeric"});function O(n){const[s,e]=n.split("-").map(Number),a=new Date(s,e-1,1);return x.format(a)}function V(n,s=0){if(n==null||n==="")return s;const e=Number(String(n).replace(",","."));return Number.isFinite(e)?e:s}function k(n,s){var S,u;const e=((S=s==null?void 0:s.settings)==null?void 0:S.vatPreview)||{},a=((u=s==null?void 0:s.vatPreviewMonths)==null?void 0:u[n])||{};return{deShare:V(a.deShare,e.deShareDefault??.8),feeRateOfGross:V(a.feeRateOfGross,e.feeRateDefault??.38),fixInputVat:h(a.fixInputVat??e.fixInputDefault??0)}}function D(n){return n.filter(s=>s&&(s.type==="vat_refund"||(s.label||"").toLowerCase().includes("eust-erstatt"))).reduce((s,e)=>s+(Number(e.amount)||0),0)}function M(n,s,e){const a=(n==null?void 0:n.forecast)||{},u=(a.forecastManual||{})[s];if(u&&Object.prototype.hasOwnProperty.call(u,e)){const f=Number(u[e]);return Number.isFinite(f)?{units:f}:null}const i=(a.forecastImport||{})[s];if(!i||!Object.prototype.hasOwnProperty.call(i,e))return null;const l=i[e];if(l&&typeof l=="object"){const f=Number(l.units),t=h(l.revenueEur??l.revenue??0);return{units:Number.isFinite(f)?f:null,revenueEur:Number.isFinite(t)&&t>0?t:null}}const c=Number(l);return Number.isFinite(c)?{units:c}:null}function R(n,s,e){const a=Array.isArray(n==null?void 0:n.products)?n.products:[],S=Array.isArray(n==null?void 0:n.productCategories)?n.productCategories:[],u=new Map(S.map(t=>[String(t.id),t.name])),o=[];if(a.forEach(t=>{const r=String((t==null?void 0:t.sku)||"").trim();if(!r)return;const m=M(n,r,s);if(!m)return;const b=Number(m.units),g=h((t==null?void 0:t.avgSellingPriceGrossEUR)??0);let p=Number(m.revenueEur);(!Number.isFinite(p)||p<=0)&&Number.isFinite(b)&&Number.isFinite(g)&&(p=b*g),!(!Number.isFinite(p)||p<=0)&&o.push({sku:r,alias:(t==null?void 0:t.alias)||"",category:u.get(String((t==null?void 0:t.categoryId)||""))||"Ohne Kategorie",units:Number.isFinite(b)?b:null,price:Number.isFinite(g)?g:null,revenue:p})}),!o.length)return{items:[{label:"Umsatz (Eingaben)",amount:e}],notes:"Keine SKU-Aufschlüsselung verfügbar."};let i=o,l="";if(o.length>50){const t=new Map;o.forEach(r=>{const m=r.category||"Ohne Kategorie",b=t.get(m)||{label:m,units:0,revenue:0};b.units+=r.units||0,b.revenue+=r.revenue||0,t.set(m,b)}),i=Array.from(t.values()).map(r=>({sku:r.label,alias:"Kategorie",units:r.units||null,price:r.units?r.revenue/r.units:null,revenue:r.revenue})),l="Zu viele SKUs – Aggregation je Kategorie."}const c=i.reduce((t,r)=>t+(r.revenue||0),0);return c?{items:i.map(t=>({label:t.sku,sublabel:t.alias||"",amount:e*(t.revenue/c),meta:{units:t.units,price:t.price,revenueBase:t.revenue}})),notes:l}:{items:[{label:"Umsatz (Eingaben)",amount:e}],notes:"Keine SKU-Aufschlüsselung verfügbar."}}function B(n){return n.filter(e=>{const a=String((e==null?void 0:e.label)||"").toLowerCase();return(e==null?void 0:e.kind)==="po-refund"||(e==null?void 0:e.kind)==="fo-refund"||a.includes("eust-erstatt")}).map(e=>({label:e.sourceNumber?`PO ${e.sourceNumber}`:e.source||"PO/FO",sublabel:e.label||"EUSt-Erstattung",date:e.date||null,amount:Number(e.amount||0),meta:{sourceTab:e.sourceTab,lagMonths:e.lagMonths}}))}function A(n){const s=U(n||{}),e=s.months,a=e.map((u,o)=>{var v;const i=k(u,n),l=((n==null?void 0:n.incomings)||[]).find(I=>I.month===u),c=h(l==null?void 0:l.revenueEur),f=c*i.deShare,t=f/1.19*.19,r=c*i.feeRateOfGross/1.19*.19,m=i.fixInputVat||0,b=((v=s.breakdown[o])==null?void 0:v.entries)||[],g=D(b),p=t-r-m-g,d=B(b),E=R(n,u,f),F=c*i.feeRateOfGross,N={deBrutto:{formula:`DE-Brutto = Umsatz × DE-Anteil (${(i.deShare*100).toFixed(0)} %)`,items:E.items,notes:E.notes||"",total:f},outputUst:{formula:"Output-USt = DE-Brutto × 19/119",items:[{label:"DE-Brutto",amount:f},{label:"Nettoanteil (Brutto/1,19)",amount:f/1.19},{label:"Output-USt (19 %)",amount:t}],notes:"DE-Anteil ist bereits im DE-Brutto berücksichtigt.",total:t},vstFees:{formula:"VSt Fees = Gebührenbasis × 19/119",items:[{label:"Gebührenbasis",sublabel:`DE-Brutto × ${(i.feeRateOfGross*100).toFixed(1)} %`,amount:F},{label:"VSt aus Gebühren",sublabel:"19/119 der Gebührenbasis",amount:r}],notes:"Gebührensatz basiert auf der Einstellungen der USt-Vorschau.",total:r},fixkostenVst:{formula:"Fixkosten-VSt = pauschaler VSt-Wert",items:[{label:"Fixkosten-VSt pauschal",amount:m}],notes:"Pauschale Fixkosten-VSt gemäß Monats-/Standardwert.",total:m},eustErstattung:{formula:"EUSt-Erstattung = Summe der EUSt-Erstattungs-Events im Monat",items:d,notes:d.length?"":"Keine EUSt-Erstattungs-Events für diesen Monat gefunden.",total:g},zahllast:{formula:"Zahllast = Output-USt – VSt Fees – Fixkosten-VSt – EUSt-Erstattung",items:[{label:"Output-USt",amount:t},{label:"- VSt Fees",amount:-r},{label:"- Fixkosten-VSt",amount:-m},{label:"- EUSt-Erstattung",amount:-g}],notes:"",total:p}};return{month:u,monthLabel:O(u),grossTotal:c,grossDe:f,outVat:t,feeInputVat:r,fixInputVat:m,eustRefund:g,payable:p,details:N}}),S=a.reduce((u,o)=>(u.grossTotal+=o.grossTotal,u.grossDe+=o.grossDe,u.outVat+=o.outVat,u.feeInputVat+=o.feeInputVat,u.fixInputVat+=o.fixInputVat,u.eustRefund+=o.eustRefund,u.payable+=o.payable,u),{grossTotal:0,grossDe:0,outVat:0,feeInputVat:0,fixInputVat:0,eustRefund:0,payable:0});return{months:e,rows:a,totals:S}}export{A as c};
