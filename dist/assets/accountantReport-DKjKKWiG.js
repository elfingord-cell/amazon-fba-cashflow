import{p as ct}from"./index-CAzQztwo.js";import{b as nt}from"./orderEditorFactory-3AxbAuwW.js";const G=20,et=new TextEncoder;let M=null;function ft(){if(M)return M;M=new Uint32Array(256);for(let t=0;t<256;t+=1){let n=t;for(let e=0;e<8;e+=1)(n&1)===1?n=3988292384^n>>>1:n>>>=1;M[t]=n>>>0}return M}function ht(t){const n=ft();let e=4294967295;for(let s=0;s<t.length;s+=1)e=e>>>8^n[(e^t[s])&255];return(e^4294967295)>>>0}function mt(t){const n=t instanceof Date?t:new Date(t||Date.now()),e=Number.isNaN(n.getTime())?new Date:n,s=Math.max(1980,e.getFullYear()),a=Math.max(1,e.getMonth()+1),i=Math.max(1,e.getDate()),r=e.getHours(),c=e.getMinutes(),u=Math.floor(e.getSeconds()/2),o=(r&31)<<11|(c&63)<<5|u&31,h=(s-1980&127)<<9|(a&15)<<5|i&31;return{dosTime:o,dosDate:h}}function pt(t){const n=t.reduce((a,i)=>a+i.length,0),e=new Uint8Array(n);let s=0;return t.forEach(a=>{e.set(a,s),s+=a.length}),e}function g(t,n,e){t.setUint16(n,e&65535,!0)}function S(t,n,e){t.setUint32(n,e>>>0,!0)}function gt(t){const n=new Uint8Array(30+t.nameBytes.length),e=new DataView(n.buffer);return S(e,0,67324752),g(e,4,G),g(e,6,0),g(e,8,0),g(e,10,t.dosTime),g(e,12,t.dosDate),S(e,14,t.crc32),S(e,18,t.data.length),S(e,22,t.data.length),g(e,26,t.nameBytes.length),g(e,28,0),n.set(t.nameBytes,30),n}function bt(t){const n=new Uint8Array(46+t.nameBytes.length),e=new DataView(n.buffer);return S(e,0,33639248),g(e,4,G),g(e,6,G),g(e,8,0),g(e,10,0),g(e,12,t.dosTime),g(e,14,t.dosDate),S(e,16,t.crc32),S(e,20,t.data.length),S(e,24,t.data.length),g(e,28,t.nameBytes.length),g(e,30,0),g(e,32,0),g(e,34,0),g(e,36,0),S(e,38,0),S(e,42,t.localHeaderOffset),n.set(t.nameBytes,46),n}function dt(t,n,e){const s=new Uint8Array(22),a=new DataView(s.buffer);return S(a,0,101010256),g(a,4,0),g(a,6,0),g(a,8,t),g(a,10,t),S(a,12,n),S(a,16,e),g(a,20,0),s}async function yt(t){if(t==null)return new Uint8Array;if(t instanceof Uint8Array)return t;if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);if(t instanceof ArrayBuffer)return new Uint8Array(t);if(typeof Blob<"u"&&t instanceof Blob){const n=await t.arrayBuffer();return new Uint8Array(n)}return et.encode(String(t))}function Dt(t){const n=String(t||"").replace(/^\/+/,"").trim();return n?n.replace(/\\/g,"/"):null}function vt(t){return et.encode(String(t??""))}async function Nt(t=[]){const n=[];for(const u of t){const o=Dt(u==null?void 0:u.name);if(!o)continue;const h=await yt(u==null?void 0:u.data),l=vt(o),{dosDate:p,dosTime:f}=mt(u==null?void 0:u.lastModified);n.push({name:o,nameBytes:l,data:h,crc32:ht(h),dosDate:p,dosTime:f,localHeaderOffset:0})}const e=[],s=[];let a=0;n.forEach(u=>{u.localHeaderOffset=a;const o=gt(u);e.push(o,u.data),a+=o.length+u.data.length,s.push(bt(u))});const i=a,r=s.reduce((u,o)=>u+o.length,0),c=dt(n.length,r,i);return pt([...e,...s,c])}async function st(t=[],n="application/zip"){const e=await Nt(t);return new Blob([e],{type:n})}async function un(t,n){const e=String(n||"download.bin").trim()||"download.bin",s=URL.createObjectURL(t),a=document.createElement("a");a.href=s,a.download=e,document.body.append(a),a.click(),a.remove(),URL.revokeObjectURL(s)}function Et(t){if(/^\d{4}-\d{2}$/.test(String(t||"")))return String(t);const n=new Date;return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}const B='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';function at(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;")}function St(t){let n=t+1,e="";for(;n>0;){const s=(n-1)%26;e=String.fromCharCode(65+s)+e,n=Math.floor((n-1)/26)}return e}function kt(t,n){return`${St(t)}${n}`}function At(t){const n=Number(t);return Number.isFinite(n)?n:null}function Ut(t,n,e){const s=kt(e,n);if(t==null||t==="")return`<c r="${s}" t="inlineStr"><is><t></t></is></c>`;const a=At(t);return a!=null&&typeof t!="string"?`<c r="${s}"><v>${a}</v></c>`:a!=null&&/^-?\d+(?:[.,]\d+)?$/.test(String(t).trim())?`<c r="${s}"><v>${String(t).replace(",",".")}</v></c>`:`<c r="${s}" t="inlineStr"><is><t xml:space="preserve">${at(t)}</t></is></c>`}function $t(t){const n=t.map((e,s)=>{const a=s+1,i=e.map((r,c)=>Ut(r,a,c)).join("");return`<row r="${a}">${i}</row>`}).join("");return`${B}<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><sheetData>${n}</sheetData></worksheet>`}function xt(t){const n=t.map((e,s)=>`<sheet name="${at(e.name)}" sheetId="${s+1}" r:id="rId${s+1}"/>`).join("");return`${B}<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets>${n}</sheets></workbook>`}function It(t){const n=t.map((e,s)=>`<Relationship Id="rId${s+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet${s+1}.xml"/>`).join("");return`${B}<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">${n}</Relationships>`}function Tt(t){const n=t.map((e,s)=>`<Override PartName="/xl/worksheets/sheet${s+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`).join("");return`${B}<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>${n}</Types>`}function Rt(){return`${B}<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>`}function wt(t){const n=[["code","severity","message","entityType","entityId"]];return(t||[]).forEach(e=>{n.push([e.code||"",e.severity||"",e.message||"",e.entityType||"",e.entityId||""])}),n}function Pt(t){var h;const n=t.inventory||{},e=t.inventoryRows||[],s=t.deposits||[],a=t.arrivals||[],i=[["Monat",((h=t.request)==null?void 0:h.month)||""],["Snapshot As Of",n.snapshotAsOf||""],["Warenwert EUR",n.totalValueEur],["Amazon Units",n.totalAmazonUnits],["3PL Units",n.total3plUnits],["In Transit Units",n.totalInTransitUnits],["Anzahlungen PO",s.length],["Wareneingaenge PO",a.length],["Manual Override Used",n.manualOverrideUsed?"yes":"no"],["Quality Issues",(t.quality||[]).length]],r=[["SKU","Alias","Kategorie","Amazon Units","3PL Units","In Transit Units","Total Units","EK EUR","Warenwert EUR","Notiz"]];e.forEach(l=>{r.push([l.sku||"",l.alias||"",l.category||"",l.amazonUnits,l.threePLUnits,l.inTransitUnits,l.totalUnits,l.ekEur,l.rowValueEur,l.note||""])});const c=[["PO Number","Supplier","SKU Aliases","Payment Type","Planned EUR","Actual EUR","Paid Date","Due Date","Amount USD","ETD Date","ETA Date","Arrival Date","Invoice URL","Folder URL","Issues"]];s.forEach(l=>{c.push([l.poNumber||"",l.supplier||"",l.skuAliases||"",l.paymentType||"",l.plannedEur,l.actualEur,l.paidDate||"",l.dueDate||"",l.amountUsd,l.etdDate||"",l.etaDate||"",l.arrivalDate||"",l.invoiceUrl||"",l.folderUrl||"",(l.issues||[]).join(" | ")])});const u=[["PO Number","Supplier","SKU Aliases","Units","Goods USD","Goods EUR","ETD Date","ETA Date","Arrival Date","Transport","Issues"]];a.forEach(l=>{u.push([l.poNumber||"",l.supplier||"",l.skuAliases||"",l.units,l.goodsUsd,l.goodsEur,l.etdDate||"",l.etaDate||"",l.arrivalDate||"",l.transport||"",(l.issues||[]).join(" | ")])});const o=[{name:"Summary",rows:i},{name:"Warenbestand",rows:r},{name:"Anzahlungen_PO",rows:c},{name:"Wareneingang_PO",rows:u},{name:"Quality",rows:wt(t.quality||[])}];if(Array.isArray(t.journalRows)&&t.journalRows.length){const l=[["month","entityType","poNumber","supplierName","skuAliases","paymentType","status","dueDate","paidDate","amountPlannedEur","amountActualEur","issues","paymentId"]];t.journalRows.forEach(p=>{l.push([p.month||"",p.entityType||"",p.poNumber||"",p.supplierName||"",p.skuAliases||"",p.paymentType||"",p.status||"",p.dueDate||"",p.paidDate||"",p.amountPlannedEur,p.amountActualEur,Array.isArray(p.issues)?p.issues.join(" | "):"",p.paymentId||""])}),o.push({name:"Zahlungsjournal",rows:l})}return o}async function Ct(t){const n=Pt(t),e=[{name:"[Content_Types].xml",data:Tt(n)},{name:"_rels/.rels",data:Rt()},{name:"xl/workbook.xml",data:xt(n)},{name:"xl/_rels/workbook.xml.rels",data:It(n)}];return n.forEach((s,a)=>{e.push({name:`xl/worksheets/sheet${a+1}.xml`,data:$t(s.rows||[])})}),st(e,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")}function Ot(t){return String(t??"").replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}function _t(t,n=110){const e=String(t||"").trim();if(!e)return[""];if(e.length<=n)return[e];const s=e.split(/\s+/),a=[];let i="";return s.forEach(r=>{const c=i?`${i} ${r}`:r;if(c.length<=n){i=c;return}if(i&&a.push(i),r.length>n){let u=0;for(;u<r.length;)a.push(r.slice(u,u+n)),u+=n;i="";return}i=r}),i&&a.push(i),a}function Ft(t){var o;const n=((o=t==null?void 0:t.request)==null?void 0:o.month)||"",e=(t==null?void 0:t.inventory)||{},s=Array.isArray(t==null?void 0:t.deposits)?t.deposits:[],a=Array.isArray(t==null?void 0:t.arrivals)?t.arrivals:[],i=Array.isArray(t==null?void 0:t.quality)?t.quality:[],r=[`Buchhaltungsbericht ${n}`,"","Warenbestand",`- Snapshot As Of: ${e.snapshotAsOf||"n/a"}`,`- Warenwert EUR: ${Number.isFinite(Number(e.totalValueEur))?Number(e.totalValueEur).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"n/a"}`,`- Amazon Units: ${Number(e.totalAmazonUnits||0).toLocaleString("de-DE")}`,`- 3PL Units: ${Number(e.total3plUnits||0).toLocaleString("de-DE")}`,`- In Transit Units: ${Number(e.totalInTransitUnits||0).toLocaleString("de-DE")}`,"","Anzahlungen (PO)",`- Anzahl Zeilen im Monat: ${s.length}`],c=s.reduce((h,l)=>h+(Number(l.actualEur)||0),0);r.push(`- Summe Ist EUR: ${c.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}`),r.push("-"),s.slice(0,12).forEach(h=>{r.push(`  ${h.poNumber||"PO"} | ${h.supplier||"-"} | paid ${h.paidDate||"n/a"} | EUR ${Number(h.actualEur||h.plannedEur||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}),s.length>12&&r.push(`  ... ${s.length-12} weitere Zeilen in XLSX/CSV`),r.push(""),r.push("Wareneingang (PO)"),r.push(`- Anzahl Zeilen im Monat: ${a.length}`);const u=a.reduce((h,l)=>h+(Number(l.units)||0),0);return r.push(`- Summe Units: ${u.toLocaleString("de-DE")}`),r.push("-"),a.slice(0,12).forEach(h=>{r.push(`  ${h.poNumber||"PO"} | ${h.supplier||"-"} | arrival ${h.arrivalDate||"n/a"} | units ${Number(h.units||0).toLocaleString("de-DE")}`)}),a.length>12&&r.push(`  ... ${a.length-12} weitere Zeilen in XLSX/CSV`),r.push(""),r.push("Datenqualitaet"),r.push(`- Hinweise gesamt: ${i.length}`),i.slice(0,20).forEach(h=>{r.push(`  [${h.severity||"info"}] ${h.code||"ISSUE"}: ${h.message||""}`)}),i.length>20&&r.push(`  ... ${i.length-20} weitere Hinweise`),r.flatMap(h=>_t(h,110))}function Mt(t){const r=Math.floor(53.57142857142857),c=[];for(let m=0;m<t.length;m+=r)c.push(t.slice(m,m+r));c.length||c.push([""]);const u=[];function o(m){return u.push(m),u.length}const h=o("<< /Type /Pages /Kids [] /Count 0 >>"),l=o(`<< /Type /Catalog /Pages ${h} 0 R >>`),p=o("<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>"),f=[];c.forEach(m=>{const v=["BT","/F1 11 Tf","1 0 0 1 40 800 Tm"];m.forEach((_,F)=>{F>0&&v.push("0 -14 Td"),v.push(`(${Ot(_)}) Tj`)}),v.push("ET");const N=v.join(`
`),T=`<< /Length ${N.length} >>
stream
${N}
endstream`,k=o(T),V=`<< /Type /Page /Parent ${h} 0 R /MediaBox [0 0 595 842] /Resources << /Font << /F1 ${p} 0 R >> >> /Contents ${k} 0 R >>`,O=o(V);f.push(O)});const E=f.map(m=>`${m} 0 R`).join(" ");u[h-1]=`<< /Type /Pages /Kids [${E}] /Count ${f.length} >>`;let b=0;const d=[],y=[0],D=m=>{d.push(m),b+=m.length};D(`%PDF-1.4
`),u.forEach((m,v)=>{const N=v+1;y[N]=b,D(`${N} 0 obj
${m}
endobj
`)});const x=b;D(`xref
0 ${u.length+1}
`),D(`0000000000 65535 f 
`);for(let m=1;m<=u.length;m+=1)D(`${String(y[m]).padStart(10,"0")} 00000 n 
`);return D(`trailer
<< /Size ${u.length+1} /Root ${l} 0 R >>
startxref
${x}
%%EOF`),new TextEncoder().encode(d.join(""))}function Bt(t){const n=Ft(t),e=Mt(n);return new Blob([e],{type:"application/pdf"})}const it={entityLabel:"PO",numberField:"poNo"};function ut(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function H(t){const n=String(t||"").trim();return/^\d{4}-\d{2}$/.test(n)?n:ut()}function R(t){const n=ct(t);return Number.isFinite(n)?Number(n):null}function I(t){if(!t)return null;if(t instanceof Date&&!Number.isNaN(t.getTime()))return t;const n=String(t).trim();if(!n)return null;const e=n.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);if(e){const i=Number(e[1]),r=Number(e[2]),c=Number(e[3]),u=new Date(c,r-1,i);return Number.isNaN(u.getTime())?null:u}const s=n.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(s){const i=Number(s[1]),r=Number(s[2]),c=Number(s[3]),u=new Date(i,r-1,c);return Number.isNaN(u.getTime())?null:u}const a=new Date(n);return Number.isNaN(a.getTime())?null:a}function A(t){const n=I(t);if(!n)return null;const e=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,"0"),a=String(n.getDate()).padStart(2,"0");return`${e}-${s}-${a}`}function ot(t){const n=I(t);return n?`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`:null}function Lt(t){const n=H(t),[e,s]=n.split("-").map(Number),a=new Date(e,s,0);return A(a)}function z(t){const n=(t==null?void 0:t.settings)||{};return{fxRate:R(n.fxRate)||1,fxFeePct:R(n.fxFeePct)||0,eurUsdRate:R(n.eurUsdRate)||0,dutyRatePct:R(n.dutyRatePct)||0,dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:R(n.eustRatePct)||0,vatRefundEnabled:n.vatRefundEnabled!==!1,vatRefundLagMonths:Number(n.vatRefundLagMonths||0)||0,freightLagDays:Number(n.freightLagDays||0)||0,defaultCurrency:String(n.defaultCurrency||"EUR").toUpperCase(),cny:n.cny&&typeof n.cny=="object"?{start:String(n.cny.start||""),end:String(n.cny.end||"")}:{start:"",end:""},cnyBlackoutByYear:n.cnyBlackoutByYear&&typeof n.cnyBlackoutByYear=="object"?structuredClone(n.cnyBlackoutByYear):{}}}function w(t){return String(t||"").trim().toLowerCase()}function K(t,n){const e=w((t==null?void 0:t.supplierId)||(t==null?void 0:t.supplier)||(t==null?void 0:t.supplierName));if(e&&n.has(e))return n.get(e);const s=(t==null?void 0:t.supplierName)||(t==null?void 0:t.supplier)||"";return s?String(s):"-"}function jt(t){const n=new Map;return(Array.isArray(t==null?void 0:t.suppliers)?t.suppliers:[]).forEach(e=>{const s=e||{},a=String(s.name||"").trim();if(!a)return;const i=w(s.id),r=w(a);i&&n.set(i,a),r&&n.set(r,a)}),n}function zt(t){const n=new Map,e=new Map,s=new Map;return(Array.isArray(t==null?void 0:t.productCategories)?t.productCategories:[]).forEach(a=>{const i=a||{},r=String(i.id||"").trim();r&&s.set(r,String(i.name||"Ohne Kategorie"))}),(Array.isArray(t==null?void 0:t.products)?t.products:[]).forEach(a=>{const i=a||{},r=String(i.sku||"").trim();if(!r)return;const c=w(r),u=String(i.alias||r).trim();n.set(c,i),e.set(c,u||r)}),{productBySku:n,aliasBySku:e,categoryMap:s}}function X(t,n){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[],s=e.length?e.map(i=>String((i==null?void 0:i.sku)||"").trim()).filter(Boolean):[String((t==null?void 0:t.sku)||"").trim()].filter(Boolean);return Array.from(new Set(s.map(i=>n.get(w(i))||i))).join(", ")||"-"}function C(t){const n=R(t);return Number.isFinite(n)?Math.max(0,Math.round(Number(n))):0}function U(t){const n=R(t);return Number.isFinite(n)?Number(n):null}function q(t){const n=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];return n.length?n:t!=null&&t.sku?[{sku:t.sku,units:t.units||0}]:[]}function rt(t){const n=U((t==null?void 0:t.goodsUsd)||(t==null?void 0:t.goodsAmountUsd));if(Number.isFinite(n))return n;const e=q(t);if(!e.length)return null;let s=0,a=!1;return e.forEach(i=>{const r=C(i.units),c=U(i.unitCostUsd||i.unitPriceUsd||(t==null?void 0:t.unitCostUsd)),u=U(i.unitExtraUsd),o=U(i.extraFlatUsd),h=Number.isFinite(c)?c:null;if(!Number.isFinite(h))return;const l=Number.isFinite(u)?u:0,p=Number.isFinite(o)?o:0,f=r*(h+l)+p;Number.isFinite(f)&&(s+=f,a=!0)}),a?s:null}function Vt(t,n,e){const s=U((t==null?void 0:t.goodsEur)||(t==null?void 0:t.goodsAmountEur));if(Number.isFinite(s))return s;if(!Number.isFinite(e))return null;const a=U(t==null?void 0:t.fxOverride)||U(n==null?void 0:n.fxRate);return!Number.isFinite(a)||a<=0?null:e/a}function Y(t){const n=A((t==null?void 0:t.etdManual)||(t==null?void 0:t.etdDate));if(n)return n;const e=I(t==null?void 0:t.orderDate);if(!e)return null;const s=Math.max(0,Number((t==null?void 0:t.prodDays)||0)),a=new Date(e.getTime());return a.setDate(a.getDate()+s),A(a)}function Z(t){const n=A((t==null?void 0:t.etaManual)||(t==null?void 0:t.etaDate)||(t==null?void 0:t.eta));if(n)return n;const e=A(t==null?void 0:t.etaComputed);if(e)return e;const s=I(Y(t));if(!s)return null;const a=Math.max(0,Number((t==null?void 0:t.transitDays)||0)),i=new Date(s.getTime());return i.setDate(i.getDate()+a),A(i)}function J(t){const n=[{key:"arrivalDateDe",mode:"de"},{key:"arrivalDate",mode:"auto"},{key:"etaManual",mode:"auto"},{key:"etaDate",mode:"auto"},{key:"eta",mode:"auto"}];for(const s of n){const a=t==null?void 0:t[s.key];if(!a)continue;const i=s.mode==="de"?I(String(a).replace(/\s+/g,"")):I(a),r=A(i);if(r)return{date:r,source:s.key}}const e=Z(t);return e?{date:e,source:"etaComputed"}:{date:null,source:"missing"}}function Wt(t,n){var s;return(Array.isArray((s=t==null?void 0:t.inventory)==null?void 0:s.snapshots)?t.inventory.snapshots:[]).find(a=>String((a==null?void 0:a.month)||"")===n)||null}function Gt(t,n){var i;const e=((i=t==null?void 0:t.template)==null?void 0:i.fields)||(t==null?void 0:t.template)||{},s=U((e==null?void 0:e.unitPriceUsd)??(t==null?void 0:t.unitPriceUsd));if(!Number.isFinite(s))return null;const a=String((e==null?void 0:e.currency)||(n==null?void 0:n.defaultCurrency)||"EUR").toUpperCase();if(a==="EUR")return s;if(a==="USD"){const r=U(n==null?void 0:n.fxRate);return!Number.isFinite(r)||r<=0?null:s/r}return null}function Ht(t){const[n,e]=H(t).split("-").map(Number),s=new Date(n,e,0);return s.setHours(23,59,59,999),s}function Kt(t){const n=J(t);return I(n.date)}function Xt(t,n){const e=Ht(n),s=new Map;return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(a=>{if(!a||a.archived||String(a.status||"").toUpperCase()==="CANCELLED")return;const i=I(a.orderDate);if(i&&i>e)return;const r=Kt(a);r&&r<=e||q(a).forEach(c=>{const u=String((c==null?void 0:c.sku)||"").trim();if(!u)return;const o=w(u),h=C(c==null?void 0:c.units);h&&s.set(o,(s.get(o)||0)+h)})}),s}function P(t,n,e){const s=`${e.code||"ISSUE"}|${e.entityType||""}|${e.entityId||""}|${e.message||""}`;n.has(s)||(n.add(s),t.push(e))}function qt(t,n,e,s,a,i){const r=n.month,c=z(t),u=Wt(t,r),o=Array.isArray(u==null?void 0:u.items)?u.items:[],h=(u==null?void 0:u.asOfDate)||Lt(r),l=Xt(t,r),p=[];let f=0,E=0,b=0,d=0,y=!1;o.forEach(m=>{const v=String((m==null?void 0:m.sku)||"").trim();if(!v)return;const N=w(v),T=s.productBySku.get(N)||{},k=String(T.alias||v),V=s.categoryMap.get(String(T.categoryId||""))||"Ohne Kategorie",O=C(m==null?void 0:m.amazonUnits),_=C(m==null?void 0:m.threePLUnits),F=C(m==null?void 0:m.inTransitUnits)||l.get(N)||0,Q=O+_+F,L=Gt(T,c),W=Number.isFinite(L)?Q*L:null;Number.isFinite(L)||P(a,i,{code:"MISSING_EK_PRICE",severity:"warning",message:`Kein EK-Preis fuer SKU ${v} vorhanden.`,entityType:"INVENTORY",entityId:v}),f+=O,E+=_,b+=F,Number.isFinite(W)&&(d+=W,y=!0),p.push({sku:v,alias:k,category:V,amazonUnits:O,threePLUnits:_,inTransitUnits:F,totalUnits:Q,ekEur:L,rowValueEur:W,note:String((m==null?void 0:m.note)||"")})}),u||P(a,i,{code:"MISSING_SNAPSHOT",severity:"warning",message:`Kein Inventory-Snapshot fuer ${r} gefunden.`,entityType:"INVENTORY",entityId:r});let D=!1;return(!y||!u)&&Number.isFinite(Number(e==null?void 0:e.inventoryValueOverrideEur))&&(d=Number(e.inventoryValueOverrideEur),D=!0),{summary:{month:r,snapshotAsOf:h,totalValueEur:y||D?d:null,totalAmazonUnits:f,total3plUnits:E,totalInTransitUnits:b,manualOverrideUsed:D,issues:a.filter(m=>m.entityType==="INVENTORY").map(m=>m.code)},rows:p}}function Yt(t,n,e,s,a,i){const r=z(t),c=n.month,u=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(o=>{if(!o||o.archived||String(o.status||"").toUpperCase()==="CANCELLED")return;const h=structuredClone(o),l=nt(h,it,r,(t==null?void 0:t.payments)||[]),p=rt(o);l.forEach(f=>{const E=String((f==null?void 0:f.status)||"").toUpperCase(),b=String((f==null?void 0:f.typeLabel)||"");if(!/deposit|anzahlung/i.test(b)||(E==="PAID"&&!(f!=null&&f.paidDate)&&P(a,i,{code:"PAID_WITHOUT_DATE",severity:"warning",message:`PO ${o.poNo||o.id||"-"}: Deposit ist bezahlt, aber paidDate fehlt.`,entityType:"PO",entityId:String(o.id||o.poNo||"")}),E!=="PAID")||ot(f==null?void 0:f.paidDate)!==c)return;const y=(Array.isArray(o==null?void 0:o.milestones)?o.milestones:[]).find(k=>(k==null?void 0:k.id)===(f==null?void 0:f.id)),D=U(y==null?void 0:y.percent),x=Number.isFinite(p)&&Number.isFinite(D)?p*D/100:null,m=Number.isFinite(Number(f==null?void 0:f.paidEurActual))?Number(f.paidEurActual):null,v=Number.isFinite(Number(f==null?void 0:f.plannedEur))?Number(f.plannedEur):null,N=[];Number.isFinite(x)||N.push("MISSING_USD"),Number.isFinite(m)||N.push("MISSING_ACTUAL_EUR"),!(f!=null&&f.invoiceDriveUrl)&&!(f!=null&&f.invoiceFolderDriveUrl)&&N.push("MISSING_INVOICE_LINK"),N.forEach(k=>{P(a,i,{code:k,severity:k==="MISSING_ACTUAL_EUR"?"warning":"info",message:`PO ${o.poNo||o.id||"-"}: ${k}`,entityType:"PO",entityId:String(o.id||o.poNo||"")})});const T=J(o);u.push({poNumber:String(o.poNo||o.id||""),supplier:K(o,s),skuAliases:X(o,e.aliasBySku),paymentType:"Deposit",plannedEur:v,actualEur:m,paidDate:A(f==null?void 0:f.paidDate),dueDate:A(f==null?void 0:f.dueDate),amountUsd:x,etdDate:Y(o),etaDate:Z(o),arrivalDate:T.date,invoiceUrl:(f==null?void 0:f.invoiceDriveUrl)||"",folderUrl:(f==null?void 0:f.invoiceFolderDriveUrl)||"",issues:N})})}),u.sort((o,h)=>String(o.paidDate||"").localeCompare(String(h.paidDate||"")))}function Zt(t,n,e,s,a,i){const r=z(t),c=n.month,u=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(o=>{if(!o||o.archived||String(o.status||"").toUpperCase()==="CANCELLED")return;const h=J(o);if(!h.date){P(a,i,{code:"MISSING_ARRIVAL_DATE",severity:"warning",message:`PO ${o.poNo||o.id||"-"}: kein Arrival/ETA Datum vorhanden.`,entityType:"PO",entityId:String(o.id||o.poNo||"")});return}if(ot(h.date)!==c)return;const p=q(o).reduce((d,y)=>d+C(y==null?void 0:y.units),0),f=rt(o),E=Vt(o,r,f),b=[];Number.isFinite(f)||b.push("MISSING_GOODS_USD"),Number.isFinite(E)||b.push("MISSING_GOODS_EUR"),h.source!=="arrivalDate"&&h.source!=="arrivalDateDe"&&b.push("ARRIVAL_FROM_ETA"),b.forEach(d=>{P(a,i,{code:d,severity:d.startsWith("MISSING")?"warning":"info",message:`PO ${o.poNo||o.id||"-"}: ${d}`,entityType:"PO",entityId:String(o.id||o.poNo||"")})}),u.push({poNumber:String(o.poNo||o.id||""),supplier:K(o,s),skuAliases:X(o,e.aliasBySku),units:p,goodsUsd:f,goodsEur:E,etdDate:Y(o),etaDate:Z(o),arrivalDate:h.date,transport:String(o.transport||""),issues:b})}),u.sort((o,h)=>String(o.arrivalDate||"").localeCompare(String(h.arrivalDate||"")))}function Jt(t,n){const e=String(t||"").toLowerCase();return n==="fx_fee"||e.includes("fx")?null:n==="freight"||e.includes("shipping")||e.includes("fracht")?"Fracht":n==="eust"||e.includes("eust")?"EUSt":e.includes("balance2")||e.includes("balance 2")||e.includes("second balance")?"Balance2":e.includes("balance")||e.includes("rest")?"Balance":e.includes("deposit")||e.includes("anzahlung")?"Deposit":"Other"}function Qt(t,n,e,s){const a=z(t),i=n.month,r=[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(c=>{if(!c||c.archived||String(c.status||"").toUpperCase()==="CANCELLED")return;const u=K(c,e),o=X(c,s.aliasBySku);nt(structuredClone(c),it,a,(t==null?void 0:t.payments)||[]).forEach(l=>{const p=Jt((l==null?void 0:l.typeLabel)||(l==null?void 0:l.label),l==null?void 0:l.eventType);if(!p)return;const f=String((l==null?void 0:l.status)||"").toUpperCase()==="PAID"?"PAID":"OPEN",E=A(l==null?void 0:l.paidDate),b=A(l==null?void 0:l.dueDate),d=f==="PAID"?String(E||"").slice(0,7):String(b||"").slice(0,7);if(i&&d!==i)return;const y=Number.isFinite(Number(l==null?void 0:l.plannedEur))?Number(l.plannedEur):null,D=Number.isFinite(Number(l==null?void 0:l.paidEurActual))?Number(l.paidEurActual):null,x=[];f==="PAID"&&D==null&&x.push("MISSING_ACTUAL_AMOUNT"),r.push({month:d,entityType:"PO",poNumber:String(c.poNo||c.id||""),supplierName:u,skuAliases:o,paymentType:p,status:f,dueDate:b,paidDate:E,amountPlannedEur:y,amountActualEur:D,issues:x,paymentId:String((l==null?void 0:l.paymentId)||"")})})}),r.sort((c,u)=>{const o=c.dueDate||c.paidDate||"",h=u.dueDate||u.paidDate||"";return o.localeCompare(h)})}function $(t){if(t==null||t==="")return"";const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2,useGrouping:!1}):""}function tt(t,n=";"){const e=String(t??"");return e?!e.includes(n)&&!e.includes('"')&&!e.includes(`
`)?e:`"${e.replace(/\"/g,'""')}"`:""}function j(t,n,e=";"){const s=n.map(i=>tt(i.label,e)).join(e),a=t.map(i=>n.map(r=>{const c=r.format?r.format(i[r.key],i):i[r.key];return tt(c,e)}).join(e));return[s,...a].join(`
`)}function tn(t,n={}){const e=t.request.month,s=String(n.workspaceName||t.workspaceName||"Workspace"),a=[`buchhaltung_${e}_bericht.pdf`,`buchhaltung_${e}.xlsx`,`buchhaltung_${e}_warenbestand.csv`,`buchhaltung_${e}_anzahlungen_po.csv`,`buchhaltung_${e}_wareneingang_po.csv`];t.request.scope==="core_plus_journal"&&a.push(`buchhaltung_${e}_zahlungsjournal.csv`),a.push(`buchhaltung_${e}_email.txt`);const i=`Unterlagen Buchhaltung ${e} - Mandant ${s}`,r=[`Betreff: ${i}`,"","Hallo,","",`anbei das Buchhalter-Paket fuer ${e}.`,"","Kurzstatus:",`- Warenbestand zum Monatsende (${t.inventory.snapshotAsOf||"n/a"}): ${Number.isFinite(Number(t.inventory.totalValueEur))?`${Number(t.inventory.totalValueEur).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})} EUR`:"kein Wert verfuegbar"}`,`- Lieferanzahlungen (PO, paidDate im Monat): ${t.deposits.length} Zeilen`,`- Wareneingaenge (PO, Arrival/ETA im Monat): ${t.arrivals.length} Zeilen`,`- Datenqualitaetshinweise: ${(t.quality||[]).length}`,"","Anlagen:",...a.map(c=>`- ${c}`),"","Viele Gruesse"];return{subject:i,text:r.join(`
`),attachments:a}}function lt(t={}){return{month:H(t.month),scope:t.scope==="core_plus_journal"?"core_plus_journal":"core",includeCsv:t.includeCsv!==!1,includeXlsx:t.includeXlsx!==!1,includePdf:t.includePdf!==!1,includeEmailDraft:t.includeEmailDraft!==!1,poOnly:!0,mode:"paid_and_arrival"}}function nn(t,n={},e={}){const s=lt(n),a=t&&typeof t=="object"?t:{},i=jt(a),r=zt(a),c=[],u=new Set,o=qt(a,s,e,r,c,u),h=Yt(a,s,r,i,c,u),l=Zt(a,s,r,i,c,u);let p=[];return s.scope==="core_plus_journal"&&(p=Qt(a,s,i,r)),!(o.summary.totalValueEur!=null)&&!Number.isFinite(Number(e.inventoryValueOverrideEur))&&P(c,u,{code:"MISSING_INVENTORY_VALUE",severity:"warning",message:"Warenwert konnte nicht vollstaendig aus Snapshot/EK ermittelt werden.",entityType:"INVENTORY",entityId:s.month}),{request:s,inventory:o.summary,inventoryRows:o.rows,deposits:h,arrivals:l,journalRows:p,quality:c}}function en(t){const n=j(t.inventoryRows||[],[{key:"sku",label:"sku"},{key:"alias",label:"alias"},{key:"category",label:"category"},{key:"amazonUnits",label:"amazonUnits"},{key:"threePLUnits",label:"threePLUnits"},{key:"inTransitUnits",label:"inTransitUnits"},{key:"totalUnits",label:"totalUnits"},{key:"ekEur",label:"ekEur",format:$},{key:"rowValueEur",label:"rowValueEur",format:$},{key:"note",label:"note"}]),e=j(t.deposits||[],[{key:"poNumber",label:"poNumber"},{key:"supplier",label:"supplier"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"plannedEur",label:"plannedEur",format:$},{key:"actualEur",label:"actualEur",format:$},{key:"paidDate",label:"paidDate"},{key:"dueDate",label:"dueDate"},{key:"amountUsd",label:"amountUsd",format:$},{key:"etdDate",label:"etdDate"},{key:"etaDate",label:"etaDate"},{key:"arrivalDate",label:"arrivalDate"},{key:"invoiceUrl",label:"invoiceUrl"},{key:"folderUrl",label:"folderUrl"},{key:"issues",label:"issues",format:i=>Array.isArray(i)?i.join("|"):""}]),s=j(t.arrivals||[],[{key:"poNumber",label:"poNumber"},{key:"supplier",label:"supplier"},{key:"skuAliases",label:"skuAliases"},{key:"units",label:"units"},{key:"goodsUsd",label:"goodsUsd",format:$},{key:"goodsEur",label:"goodsEur",format:$},{key:"etdDate",label:"etdDate"},{key:"etaDate",label:"etaDate"},{key:"arrivalDate",label:"arrivalDate"},{key:"transport",label:"transport"},{key:"issues",label:"issues",format:i=>Array.isArray(i)?i.join("|"):""}]);let a=null;return Array.isArray(t.journalRows)&&t.journalRows.length&&(a=j(t.journalRows,[{key:"month",label:"month"},{key:"entityType",label:"entityType"},{key:"poNumber",label:"poNumber"},{key:"supplierName",label:"supplierName"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"status",label:"status"},{key:"dueDate",label:"dueDate"},{key:"paidDate",label:"paidDate"},{key:"amountPlannedEur",label:"amountPlannedEur",format:$},{key:"amountActualEur",label:"amountActualEur",format:$},{key:"issues",label:"issues",format:i=>Array.isArray(i)?i.join("|"):""},{key:"paymentId",label:"paymentId"}])),{inventoryCsv:n,depositsCsv:e,arrivalsCsv:s,journalCsv:a}}async function on(t,n={},e={}){const s=nn(t,n,e),a=Et(s.request.month),i=tn(s,e),r=en(s),c={pdf:`buchhaltung_${a}_bericht.pdf`,xlsx:`buchhaltung_${a}.xlsx`,csvInventory:`buchhaltung_${a}_warenbestand.csv`,csvDeposits:`buchhaltung_${a}_anzahlungen_po.csv`,csvArrivals:`buchhaltung_${a}_wareneingang_po.csv`,csvJournal:`buchhaltung_${a}_zahlungsjournal.csv`,emailTxt:`buchhaltung_${a}_email.txt`,zip:`buchhaltung_${a}_paket.zip`},u={};s.request.includePdf&&(u.pdfReport=Bt(s)),s.request.includeXlsx&&(u.xlsxWorkbook=await Ct(s)),s.request.includeCsv&&(u.csvInventory=new Blob([r.inventoryCsv],{type:"text/csv;charset=utf-8"}),u.csvDeposits=new Blob([r.depositsCsv],{type:"text/csv;charset=utf-8"}),u.csvArrivals=new Blob([r.arrivalsCsv],{type:"text/csv;charset=utf-8"}),r.journalCsv&&(u.csvJournal=new Blob([r.journalCsv],{type:"text/csv;charset=utf-8"}))),s.request.includeEmailDraft&&(u.emailDraftTxt=new Blob([i.text],{type:"text/plain;charset=utf-8"}));const o=[];u.pdfReport&&o.push({name:c.pdf,data:u.pdfReport}),u.xlsxWorkbook&&o.push({name:c.xlsx,data:u.xlsxWorkbook}),u.csvInventory&&o.push({name:c.csvInventory,data:u.csvInventory}),u.csvDeposits&&o.push({name:c.csvDeposits,data:u.csvDeposits}),u.csvArrivals&&o.push({name:c.csvArrivals,data:u.csvArrivals}),u.csvJournal&&o.push({name:c.csvJournal,data:u.csvJournal}),u.emailDraftTxt&&o.push({name:c.emailTxt,data:u.emailDraftTxt});const h=await st(o,"application/zip");return{...s,emailDraft:i,fileNames:c,files:u,zipBlob:h,zipFileName:c.zip}}function rn(t=ut()){return lt({month:t})}export{on as a,nn as b,rn as c,un as t};
