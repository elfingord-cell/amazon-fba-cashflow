import{t as m,Y as be,X as Le,bs as ke,bt as bn,bu as fn,a1 as Se,k as t,L as gn,M as N,N as at,S as _,T as Te,Q as Be,Z as fe,$ as ge,ae as pn,p as vn,W as It,a0 as Nn}from"./index-D6pMtF0j.js";import{b as xn}from"./cashflow-C2VWmt4k.js";import{c as ee,b as Ft,f as Oe}from"./months-BTPgK-LH.js";import{c as Rn,d as Mn,n as En,e as Pn}from"./tableModels-BBlqNR-D.js";import{u as jn,C as ot}from"./workspace-CPdCVGI9.js";import{u as pe}from"./orderUtils-DfdZPrUm.js";import{D as Qe}from"./DeNumberInput-CX2Y0IgS.js";import{S as Sn}from"./StatsTableShell-BNejfc6s.js";import{S as yn}from"./index-I3B8JoUt.js";import"./planProducts-C4xIiO35.js";import"./productCompletenessV2-Barv506d.js";import"./Dropdown-CGxjL3l8.js";import"./foSuggestion-DyBAXRuI.js";import"./index-IqeLlo-_.js";import"./DownOutlined-BAIni2KE.js";const{Paragraph:Cn,Text:b,Title:it}=gn;function In(e){return e instanceof HTMLElement?!!(e.matches("input:not([type='hidden']), textarea, [contenteditable='true']")||e.closest(".ant-select, .ant-picker, .ant-input-number")):!1}function rt(e){return/^\d{4}-\d{2}$/.test(String(e||"").trim())}function i(e){if(e==null||e==="")return null;if(typeof e=="number")return Number.isFinite(e)?e:null;const d=vn(e);return Number.isFinite(d)?Number(d):null}function $e(e,d=ee()){const g=String(e||"").trim();return/^\d{4}-\d{2}$/.test(g)?g:d}function Fn(e,d){const g=String(e.calibrationCutoffDate||"").trim(),s=/^\d{4}-\d{2}-\d{2}$/.test(g)?g:null;return{id:String(e.id||pe("inc")),month:$e(e.month,d),revenueEur:i(e.revenueEur),payoutPct:i(e.payoutPct),source:String(e.source||"manual")==="forecast"?"forecast":"manual",calibrationCutoffDate:s,calibrationRevenueToDateEur:i(e.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:i(e.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:i(e.calibrationSellerboardMonthEndEur)}}function zt(e){return{id:pe("inc"),month:e,revenueEur:null,payoutPct:null,source:"forecast",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null}}function O(e){return e.slice().sort((d,g)=>d.month===g.month?d.id.localeCompare(g.id):d.month.localeCompare(g.month))}function me(e,d,g){const s=Ft(d,Math.max(1,Math.round(g||1))),I=new Set(s),Z=new Map;O(e).forEach(x=>{I.has(x.month)&&Z.set(x.month,{...x,id:x.id||pe("inc"),source:x.source==="forecast"?"forecast":"manual",revenueEur:i(x.revenueEur),payoutPct:i(x.payoutPct),calibrationCutoffDate:x.calibrationCutoffDate?String(x.calibrationCutoffDate):null,calibrationRevenueToDateEur:i(x.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:i(x.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:i(x.calibrationSellerboardMonthEndEur)})});const V=s.map(x=>Z.get(x)||zt(x));return O(V)}function v(e,d=2){const g=Number(e);return Number.isFinite(g)?g.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d}):"—"}function A(e){const d=Number(e);return Number.isFinite(d)?d.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function C(e){const d=It(e);return Number.isFinite(d)?Se(Number(d),ge,fe):null}function de(e){const d=It(e);return!Number.isFinite(d)||Number(d)<=0?null:Se(Number(d),ge,fe)}function zn(e){return String(e||"").trim().toLowerCase()==="recommendation"?"recommendation":"manual"}function Dn(e){return String(e||"").trim().toLowerCase()==="forecast_direct"?"forecast_direct":"hybrid"}function An(e){return e==="IST"?"IST":e==="RECOMMENDED_PLAN"||e==="RECOMMENDED_BASIS"||e==="RECOMMENDED_CONSERVATIVE"?"Empfohlen (Plan)":e==="PROGNOSE"?"Signal":"Empfehlung"}function Un(e){return e==="manual_override"||e==="manual_no_forecast"?"MANUELL":e==="forecast_calibrated"?"KALIBRIERT":e==="forecast_raw"?"FORECAST":"—"}function yt(e){return e==="manual"?"MANUELL":e==="recommendation"?"EMPFOHLEN":"—"}function he(e){const d=i(e);return Number.isFinite(d)?Math.max(0,Number(d)):null}function Tn(e,d){const g=String((e==null?void 0:e.month)||""),s=Math.max(0,Math.round(Number((e==null?void 0:e.horizonOffset)||0))),I=Math.max(1,Math.round(Number((e==null?void 0:e.dayOfMonth)||1))),Z=Number((e==null?void 0:e.wEff)||0),V=(e==null?void 0:e.liveAnchorEnabled)===!0&&Z>0?`Kalibrierung mit Tagesgewicht aktiv (Tag ${I}, h=${s}, Gewicht ${A(Z)}).`:"Kalibrierung nutzt aktuell nur das gelernte Profil.",x=Number(d==="conservative"?(e==null?void 0:e.factorConservative)||1:(e==null?void 0:e.factorBasis)||1);return[g?`Monat: ${Oe(g)}`:null,`F_h: ${v(e==null?void 0:e.rawForecastRevenue,2)} EUR`,`K (${d==="conservative"?"Konservativ":"Basis"}): ${A(x)}`,`K_basis: ${A(e==null?void 0:e.factorBasis)}`,`K_cons: ${A(e==null?void 0:e.factorConservative)}`,`B: ${A(e==null?void 0:e.biasB)}`,`R: ${A(e==null?void 0:e.riskR)}`,`C_live: ${A(e==null?void 0:e.cLive)}`,`W_time: ${A(e==null?void 0:e.wTime)}`,`W_h: ${A(e==null?void 0:e.wH)}`,`W_eff: ${A(Z)}`,`d: ${I}`,V].filter(Boolean).join(" | ")}function Bn(e){return Number.isFinite(e)?`${e>0?"+":""}${e.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}`:""}function Ct(e){return Number.isFinite(e)?`${e>0?"+":""}${v(e,2)} EUR`:"0,00 EUR"}function je(e){return!e||typeof e!="object"?null:JSON.parse(JSON.stringify(e))}function st(e){const d=C(e.cashInRecommendationBaselineNormalPct)??be,g=C(e.cashInRecommendationBaselineQ4Pct);return JSON.stringify({openingBalance:Number(e.openingBalance||0),startMonth:String(e.startMonth||""),horizonMonths:Math.max(1,Math.round(Number(e.horizonMonths||1))),cashInCalibrationEnabled:e.cashInCalibrationEnabled!==!1,cashInCalibrationHorizonMonths:Le(e.cashInCalibrationHorizonMonths,6),cashInCalibrationMode:ke(e.cashInCalibrationMode),cashInRecommendationIgnoreQ4:e.cashInRecommendationIgnoreQ4===!0,cashInRecommendationBaselineNormalPct:d,cashInRecommendationBaselineQ4Pct:g,cashInLearning:je(e.cashInLearning),incomings:O(e.incomings).map(s=>({id:String(s.id||""),month:String(s.month||""),revenueEur:i(s.revenueEur),payoutPct:i(s.payoutPct),source:s.source==="forecast"?"forecast":"manual",calibrationCutoffDate:s.calibrationCutoffDate?String(s.calibrationCutoffDate):null,calibrationRevenueToDateEur:i(s.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:i(s.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:i(s.calibrationSellerboardMonthEndEur)})),extras:e.extras.slice().sort((s,I)=>s.id.localeCompare(I.id)).map(s=>({id:String(s.id||""),date:String(s.date||""),label:String(s.label||""),amountEur:i(s.amountEur)})),dividends:e.dividends.slice().sort((s,I)=>s.month===I.month?s.id.localeCompare(I.id):s.month.localeCompare(I.month)).map(s=>({id:String(s.id||""),month:String(s.month||""),label:String(s.label||""),amountEur:i(s.amountEur)})),monthlyActuals:e.monthlyActuals.slice().sort((s,I)=>s.month.localeCompare(I.month)).map(s=>({month:String(s.month||""),realRevenueEUR:i(s.realRevenueEUR),realPayoutRatePct:i(s.realPayoutRatePct),realClosingBalanceEUR:i(s.realClosingBalanceEUR)}))})}function sa(){var xt,Rt,Mt;const{state:e,loading:d,saving:g,error:s,lastSavedAt:I,saveWith:Z}=jn(),[V,x]=m.useState(0),[Q,Dt]=m.useState(ee()),[L,At]=m.useState(18),[_e,Ut]=m.useState(!0),[ve,Tt]=m.useState(6),[q,Bt]=m.useState("basis"),[H,Qt]=m.useState(!1),[te,Lt]=m.useState(be),[se,kt]=m.useState(null),[k,lt]=m.useState(null),[F,Ne]=m.useState([]),[He,Ot]=m.useState([]),[Ke,$t]=m.useState([]),[ne,_t]=m.useState([]),[We,ye]=m.useState(!1),[ct,xe]=m.useState(""),[Qn,Ln]=m.useState(!1),[kn,Ht]=m.useState(ee()),[On,$n]=m.useState(""),[_n,Hn]=m.useState(null),[Re,Kt]=m.useState("revenue"),le=m.useRef(null),Ce=m.useRef(""),Ve=m.useRef(!0),J=m.useMemo(()=>Ft(Q,Math.max(1,Math.round(L||1))),[L,Q]),Y=e.settings&&typeof e.settings=="object"?e.settings:{},Ie=zn(Y.cashInQuoteMode),Fe=Dn(Y.cashInRevenueBasisMode),U=Y.cashInCalibrationEnabled!==!1,ut=e.forecast&&typeof e.forecast=="object"?e.forecast:{},ae=m.useMemo(()=>{const n=e,a=Rn(n),o=Mn(n,a),h=e.forecast||{},l=h.forecastImport||{},P=En(h.forecastManual||{});return Pn({allMonths:J,products:o,manualDraft:P,forecastImport:l})},[J,e]);m.useEffect(()=>{const n=e.settings||{},a=Number(i(n.openingBalance)||0),o=$e(n.startMonth,ee()),h=Math.max(1,Math.round(Number(n.horizonMonths||18)||18)),l=n.cashInCalibrationEnabled!==!1,P=Le(n.cashInCalibrationHorizonMonths,6),r=ke(n.cashInCalibrationMode),z=!(n.cashInRecommendationSeasonalityEnabled==null?n.cashInRecommendationIgnoreQ4!==!0:n.cashInRecommendationSeasonalityEnabled!==!1),R=C(n.cashInRecommendationBaselineNormalPct)??be,T=C(n.cashInRecommendationBaselineQ4Pct),c=je(n.cashInLearning),D=(Array.isArray(e.incomings)?e.incomings:[]).map(y=>Fn(y,o)),B=me(D,o,h),S=(Array.isArray(e.extras)?e.extras:[]).map(y=>{const p=y;return{id:String(p.id||pe("extra")),date:String(p.date||""),label:String(p.label||"Extra"),amountEur:i(p.amountEur)}}),W=(Array.isArray(e.dividends)?e.dividends:[]).map(y=>{const p=y;return{id:String(p.id||pe("div")),month:$e(p.month,o),label:String(p.label||"Dividende"),amountEur:i(p.amountEur)}}),ue=e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{},X=Object.entries(ue).map(([y,p])=>({month:$e(y,ee()),realRevenueEUR:i(p.realRevenueEUR),realPayoutRatePct:i(p.realPayoutRatePct),realClosingBalanceEUR:i(p.realClosingBalanceEUR)})).sort((y,p)=>y.month.localeCompare(p.month));Ve.current=!0,x(a),Dt(o),At(h),Ut(l),Tt(P),Bt(r),Qt(z),Lt(R),kt(T),lt(c),Ne(B),Ot(S),$t(W),_t(X),Ht(o),Ce.current=st({openingBalance:a,startMonth:o,horizonMonths:h,cashInCalibrationEnabled:l,cashInCalibrationHorizonMonths:P,cashInCalibrationMode:r,cashInRecommendationIgnoreQ4:z,cashInRecommendationBaselineNormalPct:R,cashInRecommendationBaselineQ4Pct:T,cashInLearning:c,incomings:B,extras:S,dividends:W,monthlyActuals:X}),ye(!1),xe("")},[e.dividends,e.extras,e.incomings,e.monthlyActuals,e.settings]),m.useEffect(()=>()=>{le.current!=null&&window.clearTimeout(le.current)},[]);const mt=m.useMemo(()=>{const n={};return J.forEach(a=>{n[a]=Number(ae.get(a)||0)}),n},[ae,J]),ze=m.useMemo(()=>{const n={};return ne.forEach(a=>{if(!rt(a.month))return;const o=i(a.realRevenueEUR),h=i(a.realPayoutRatePct),l={};Number.isFinite(o)&&(l.realRevenueEUR=Number(o)),Number.isFinite(h)&&(l.realPayoutRatePct=Number(h)),Object.keys(l).length&&(n[a.month]=l)}),n},[ne]),M=m.useMemo(()=>bn({months:J,incomings:F,monthlyActuals:ze,currentMonth:ee(),seasonalityEnabled:!H,ignoreQ4:H,maxMonth:ee(),baselineNormalPct:te,learningState:k,now:new Date,minSamples:4}),[te,se,H,k,F,ze,J]),ce=m.useMemo(()=>{const n=new Map;return F.forEach(a=>{var h;const o=(h=M.byMonth)==null?void 0:h[a.month];!o||!Number.isFinite(Number(o.quotePct))||n.set(a.month,o)}),n},[F,M.byMonth]),Wt=C(M.baselineNormalPct)??be,Vt=C(M.levelPct)??Wt,qt=Number.isFinite(Number(M.riskBasePct))?Number(M.riskBasePct):0;C(M.currentMonthForecastQuotePct);const Jt=Math.max(0,Math.round(Number(M.observedNormalSampleCount||0))),Gt=C(M.observedNormalMedianPct),Xt=C(M.observedNormalAveragePct),Zt=Math.max(0,Math.round(Number(M.observedNormalWithForecastSampleCount||0))),Yt=C(M.observedNormalWithForecastMedianPct),wt=C(M.observedNormalWithForecastAveragePct),dt=Array.isArray(M.usedMonths)?M.usedMonths:[],en=dt.length?dt.map(n=>Oe(n)).join(", "):"keine";[`Level L: ${v(Vt,1)}%`,`RiskBase: ${v(qt,2)}pp`,`Observed IST (n=${Jt}): Median ${v(Gt,1)}%, Ø ${v(Xt,1)}%`,`Modellpunkte (n=${Zt}): Median ${v(Yt,1)}%, Ø ${v(wt,1)}%`,`Genutzte IST-Monate: ${en}`,`Saisonalität: ${H?"aus":"an"}`].join(" | "),k&&typeof k=="object"&&k.historicalImport&&typeof k.historicalImport=="object"&&Math.max(0,Math.round(Number(k.historicalImport.sampleCount||0)));const j=ee(),ht=J.includes(j),G=Number(ae.get(j)||0),E=m.useMemo(()=>O(F).find(n=>n.month===j)||null,[j,F]),Me=i(E==null?void 0:E.calibrationSellerboardMonthEndEur),Ee=i(E==null?void 0:E.calibrationPayoutRateToDatePct),K=m.useMemo(()=>fn({incomings:F,months:J,forecastRevenueByMonth:mt,mode:q,currentMonth:j,now:new Date,monthlyActuals:ze,learningState:Y.revenueCalibration,sourceForecastVersionId:ut.activeVersionId}),[q,j,mt,ut.activeVersionId,F,ze,J,Y.revenueCalibration]),qe=K.candidates.find(n=>n.month===j)||null,Je=Number((qe==null?void 0:qe.rawFactor)??((Rt=(xt=K.byMonth)==null?void 0:xt[j])==null?void 0:Rt.cLiveRaw)),$=(Mt=K.byMonth)==null?void 0:Mt[j],Ge=U?Number(($==null?void 0:$.factor)||1):1,tn=Number(($==null?void 0:$.factorBasis)||1),nn=Number(($==null?void 0:$.factorConservative)||1),bt=G*(Number.isFinite(Ge)?Ge:1),ft=m.useMemo(()=>{const n=de(E==null?void 0:E.payoutPct);if(Number.isFinite(n))return Number(n);const a=ce.get(j),o=Number(a==null?void 0:a.quotePct);return Number.isFinite(o)?Se(o,ge,fe):null},[E==null?void 0:E.payoutPct,j,ce]),gt=Number.isFinite(ft)?bt*(Number(ft)/100):null,an=Number.isFinite(Je)&&(Je>1.25||Je<.5),on=$&&U?Tn($,q):U?"Kalibrierfaktor wird berechnet, sobald die Umsatzprognose bis Monatsende im aktuellen Monat gesetzt ist und Forecast-Umsatz > 0 ist.":"Kalibrierung ist deaktiviert.",pt=m.useMemo(()=>{const n=Number(Me),a=Number(Ee);return!(Number.isFinite(n)&&n>0)||!(Number.isFinite(a)&&a>=0)?null:a/n*100},[Ee,Me]),Xe=Number.isFinite(Me)?Number(Me)-Number(G||0):null,vt=Number.isFinite(Xe)&&Number.isFinite(G)&&Number(G)>0?Number(Xe)/Number(G)*100:null,Nt=Number.isFinite(Ee)&&Number.isFinite(gt)?Number(Ee)-Number(gt):null;m.useMemo(()=>{let n=0,a=0,o=0,h=0,l=0;O(F).forEach(u=>{var oe,ie;const z=String(u.month||""),R=Number(ae.get(z)||0),T=U?Number(((ie=(oe=K.byMonth)==null?void 0:oe[z])==null?void 0:ie.factor)||1):1,c=Number.isFinite(T)?T:1,D=i(u.revenueEur),B=u.source==="manual"&&Number.isFinite(R)&&R>0,S=B?Number(D||0):R,W=B?S:R*c;n+=Number(S||0),a+=Number(W||0),!B&&Math.abs(c-1)>1e-6&&(l+=1);const ue=de(u.payoutPct),X=ce.get(z),y=Number(X==null?void 0:X.quotePct),p=Number.isFinite(ue)?Number(ue):Number.isFinite(y)?Se(y,ge,fe):null;Number.isFinite(p)&&(o+=Number(S||0)*(Number(p)/100),h+=Number(W||0)*(Number(p)/100))});const P=U?a-n:0,r=U?h-o:0;return{revenueDelta:P,payoutDelta:r,affectedMonths:l}},[U,K.byMonth,ae,F,ce]);function Ze(n){Ne(a=>{var l,P;const o=a.findIndex(r=>r.month===j);if(o>=0){const r=[...a];return r[o]={...r[o],...n},O(r)}if(!ht)return a;const h={id:pe("inc"),month:j,revenueEur:Number.isFinite(G)?G:0,payoutPct:C((P=(l=M.byMonth)==null?void 0:l[j])==null?void 0:P.quotePct),source:G>0?"forecast":"manual",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null,...n};return O([...a,h])})}async function rn(n){const a=me(F,Q,L),o=je(M.learningStateNext||M.learningState||k),h=K.learningStateNext&&typeof K.learningStateNext=="object"?JSON.parse(JSON.stringify(K.learningStateNext)):Y.revenueCalibration&&typeof Y.revenueCalibration=="object"?JSON.parse(JSON.stringify(Y.revenueCalibration)):null,l={openingBalance:V,startMonth:Q,horizonMonths:L,cashInCalibrationEnabled:_e,cashInCalibrationHorizonMonths:ve,cashInCalibrationMode:q,cashInRecommendationIgnoreQ4:H,cashInRecommendationBaselineNormalPct:te,cashInRecommendationBaselineQ4Pct:se,cashInLearning:o,incomings:a,extras:He,dividends:Ke,monthlyActuals:ne},P=st(l);if(P===Ce.current){ye(!1);return}await Z(r=>{const u=Nn(r),z=u.settings||{};u.settings={...z,openingBalance:Number(l.openingBalance||0),startMonth:l.startMonth,horizonMonths:Math.max(1,Math.round(l.horizonMonths||1)),cashInCalibrationHorizonMonths:Le(l.cashInCalibrationHorizonMonths,6),cashInCalibrationMode:ke(l.cashInCalibrationMode),cashInRecommendationIgnoreQ4:l.cashInRecommendationIgnoreQ4===!0,cashInRecommendationSeasonalityEnabled:l.cashInRecommendationIgnoreQ4!==!0,cashInRecommendationBaselineNormalPct:C(l.cashInRecommendationBaselineNormalPct)??be,cashInRecommendationBaselineQ4Pct:C(l.cashInRecommendationBaselineQ4Pct),cashInLearning:je(l.cashInLearning),revenueCalibration:h,lastUpdatedAt:new Date().toISOString()},u.incomings=O(l.incomings).map(c=>({id:c.id,month:c.month,revenueEur:i(c.revenueEur),payoutPct:de(c.payoutPct),source:c.source,calibrationCutoffDate:c.calibrationCutoffDate||null,calibrationRevenueToDateEur:i(c.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:he(c.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:he(c.calibrationSellerboardMonthEndEur)})),u.extras=l.extras.map(c=>({id:c.id,date:c.date||null,month:c.date?c.date.slice(0,7):null,label:c.label,amountEur:Number(c.amountEur||0)})),u.dividends=l.dividends.map(c=>({id:c.id,month:c.month,date:`${c.month}-28`,label:c.label,amountEur:Number(c.amountEur||0)}));const R=u.monthlyActuals&&typeof u.monthlyActuals=="object"?u.monthlyActuals:{},T={};return l.monthlyActuals.forEach(c=>{if(!rt(c.month))return;const D=R[c.month]&&typeof R[c.month]=="object"?{...R[c.month]}:{},B=i(c.realRevenueEUR),S=i(c.realPayoutRatePct),W=i(c.realClosingBalanceEUR);Number.isFinite(B)?D.realRevenueEUR=Number(B):delete D.realRevenueEUR,Number.isFinite(S)?D.realPayoutRatePct=Number(S):delete D.realPayoutRatePct,Number.isFinite(W)?D.realClosingBalanceEUR=Number(W):delete D.realClosingBalanceEUR,Object.keys(D).length&&(T[c.month]=D)}),u.monthlyActuals=T,u},n),lt(o),Ce.current=P,ye(!1),xe(`Gespeichert: ${new Date().toLocaleTimeString("de-DE")}`)}function Ye(n=380){le.current!=null&&window.clearTimeout(le.current),le.current=window.setTimeout(()=>{if(le.current=null,g){Ye(220);return}rn("v2:inputs:auto")},Math.max(80,Number(n)||380))}m.useEffect(()=>{if(Ve.current){Ve.current=!1;return}const a=st({openingBalance:V,startMonth:Q,horizonMonths:L,cashInCalibrationEnabled:_e,cashInCalibrationHorizonMonths:ve,cashInCalibrationMode:q,cashInRecommendationIgnoreQ4:H,cashInRecommendationBaselineNormalPct:te,cashInRecommendationBaselineQ4Pct:se,cashInLearning:k,incomings:F,extras:He,dividends:Ke,monthlyActuals:ne})!==Ce.current;ye(a),a&&(xe("Ungespeicherte Aenderungen"),Ye(380))},[V,Q,L,_e,ve,q,H,te,se,k,F,He,Ke,ne]);const sn=m.useMemo(()=>{const n=me(F,Q,L),a=structuredClone(e);(!a.settings||typeof a.settings!="object")&&(a.settings={});const o=a.settings;o.openingBalance=Number(V||0),o.startMonth=Q,o.horizonMonths=Math.max(1,Math.round(L||1)),o.cashInCalibrationHorizonMonths=Le(ve,6),o.cashInCalibrationMode=ke(q),o.cashInRecommendationIgnoreQ4=H===!0,o.cashInRecommendationSeasonalityEnabled=H!==!0,o.cashInRecommendationBaselineNormalPct=C(te)??be,o.cashInRecommendationBaselineQ4Pct=C(se),o.cashInLearning=je(k),a.incomings=O(n).map(r=>({id:r.id,month:r.month,revenueEur:i(r.revenueEur),payoutPct:de(r.payoutPct),source:r.source,calibrationCutoffDate:r.calibrationCutoffDate||null,calibrationRevenueToDateEur:i(r.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:he(r.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:he(r.calibrationSellerboardMonthEndEur)}));const h=a.monthlyActuals&&typeof a.monthlyActuals=="object"?a.monthlyActuals:{},l={};ne.forEach(r=>{if(!rt(r.month))return;const u=h[r.month]&&typeof h[r.month]=="object"?{...h[r.month]}:{},z=i(r.realRevenueEUR),R=i(r.realPayoutRatePct),T=i(r.realClosingBalanceEUR);Number.isFinite(z)?u.realRevenueEUR=Number(z):delete u.realRevenueEUR,Number.isFinite(R)?u.realPayoutRatePct=Number(R):delete u.realPayoutRatePct,Number.isFinite(T)?u.realClosingBalanceEUR=Number(T):delete u.realClosingBalanceEUR,Object.keys(u).length&&(l[r.month]=u)}),a.monthlyActuals=l;const P=xn(n.map(r=>r.month),a,null);return n.map(r=>{var St;const u=ce.get(r.month)||null,z=Number(u==null?void 0:u.quotePct),R=Number.isFinite(z)?Se(z,ge,fe):null,T=String((u==null?void 0:u.sourceTag)||"RECOMMENDED_PLAN"),c=An(T),D=[`Quelle: ${c}`,u!=null&&u.explanation?String(u.explanation):null,`Saisonalität: ${(u==null?void 0:u.seasonalityEnabled)===!1?"aus":"an"}`].filter(Boolean).join(" | "),B=Number(ae.get(r.month)||0),S=((St=K.byMonth)==null?void 0:St[r.month])||null,W=Number((S==null?void 0:S.factorBasis)||1),ue=Number((S==null?void 0:S.factorConservative)||1),X=q==="conservative"?ue:W,y=U&&Number.isFinite(X)?X:1,p=B*y,oe=i(r.revenueEur),ie=r.source==="manual"&&Number.isFinite(oe)&&Number(oe)>0,De=de(r.payoutPct),f=P&&typeof P=="object"?P[r.month]:void 0;let w=Number.isFinite(Number(f==null?void 0:f.revenueUsedEUR))?Number(f==null?void 0:f.revenueUsedEUR):null,et=f!=null&&f.revenueSource?String(f.revenueSource):null,re=Number.isFinite(Number(f==null?void 0:f.payoutPctUsed))?Number(f==null?void 0:f.payoutPctUsed):null,tt=f!=null&&f.payoutSource?String(f.payoutSource):null;const Ae=Number.isFinite(Number(f==null?void 0:f.payoutEUR))?Number(f==null?void 0:f.payoutEUR):null,dn=U?p:B,hn=U?"forecast_calibrated":"forecast_raw",Ue=Fe==="hybrid"&&ie?Number(oe):dn,Et=Fe==="hybrid"&&ie?"manual_override":hn;(!Number.isFinite(w)||et!==Et||Number.isFinite(Ue)&&Number(Ue)>0&&Number.isFinite(w)&&Number(w)<=0)&&(w=Number.isFinite(Ue)?Number(Ue):null,et=w!=null?Et:null);const nt=Ie==="manual"&&Number.isFinite(De)?"manual":"recommendation",Pt=nt==="manual"?Number(De):Number.isFinite(R)?Number(R):null;(!Number.isFinite(re)||Number(re)<=0||tt!==nt)&&(re=Number.isFinite(Pt)?Number(Pt):null,tt=re!=null?nt:null);const Pe=Number.isFinite(w)&&Number.isFinite(re)?Number(w)*(Number(re)/100):null;let jt=Number.isFinite(Pe)?Number(Pe):Number.isFinite(Ae)?Number(Ae):0;return Number.isFinite(Pe)&&Number(Pe)>0&&(!Number.isFinite(Ae)||Number(Ae)<=0)&&(jt=Number(Pe)),{rowId:r.id,month:r.month,monthLabel:Oe(r.month),forecastRevenue:B,calibrationFactor:Number.isFinite(y)?Number(y):1,calibratedRevenue:p,manualRevenue:ie?Number(oe):null,hasManualRevenue:ie,manualQuote:Number.isFinite(De)?Number(De):null,recommendedQuote:Number.isFinite(R)?Number(R):null,recommendationSourceLabel:c,recommendationTooltip:D,usedRevenue:w,usedRevenueSource:et,usedQuote:re,usedQuoteSource:tt,usedPayout:Number(jt||0)}})},[ve,q,k,te,se,H,ae,U,Ie,Fe,L,F,ne,V,ce,K.byMonth,Q,e]);function ln(n){const a=i(n.revenueEur);return n.source==="manual"&&Number.isFinite(a)&&Number(a)>0}function we(n,a){Ne(o=>{const h=me(o,Q,L),l=h.findIndex(P=>P.month===n);return l>=0?h[l]=a({...h[l]}):h.push(a(zt(n))),O(h)})}function cn(n){we(n,a=>({...a,source:"forecast",revenueEur:null}))}function un(){Ne(n=>{const a=me(n,Q,L);return O(a.map(o=>ln(o)?o:{...o,source:"forecast",revenueEur:null}))}),xe("Forecast in AUTO-Monate übernommen")}function mn(){pn.confirm({title:"Alle Umsatz-Overrides zurücksetzen?",content:"Bist du sicher? Alle MANUELL-Monate werden auf AUTO zurückgesetzt.",okText:"Zurücksetzen",cancelText:"Abbrechen",onOk:()=>{Ne(n=>{const a=me(n,Q,L);return O(a.map(o=>({...o,source:"forecast",revenueEur:null})))}),xe("Alle Umsatz-Overrides zurückgesetzt")}})}return t.jsxs("div",{className:"v2-page",onBlurCapture:n=>{In(n.target)&&We&&Ye(120)},children:[t.jsxs(ot,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(it,{level:3,children:"Cash-in Setup"}),t.jsx(Cn,{children:"Transparenz für Forecast, manuelle Eingaben und die global verwendeten Cash-in-Werte aus dem Dashboard."})]})}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs("div",{className:"v2-toolbar-row",children:[g?t.jsx(N,{color:"processing",children:"Speichern..."}):null,We?t.jsx(N,{color:"gold",children:"Ungespeicherte Aenderungen"}):t.jsx(N,{color:"green",children:"Synchron"}),I?t.jsxs(N,{color:"green",children:["Gespeichert: ",new Date(I).toLocaleTimeString("de-DE")]}):null,ct?t.jsx(N,{color:We?"gold":"blue",children:ct}):null]})})]}),s?t.jsx(at,{type:"error",showIcon:!0,message:s}):null,d?t.jsx(at,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,t.jsxs(ot,{children:[t.jsxs(_,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsx(it,{level:5,style:{margin:0},children:"Monatsende-Projektion (aktueller Monat)"}),t.jsxs(N,{color:"blue",children:[Oe(j)," (",j,")"]})]}),ht?t.jsxs(_,{direction:"vertical",size:10,style:{width:"100%",marginTop:10},children:[t.jsx(b,{type:"secondary",children:"Diese Werte kannst du täglich aktualisieren. Sie helfen bei der Kalibrierung (Umsatz) und als Signal für die Quote."}),t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(240px, 1fr))",gap:10},children:[t.jsxs("div",{children:[t.jsx(b,{type:"secondary",children:"Prognose Umsatz zum Monatsende (EUR)"}),t.jsx("div",{"data-field-key":`inputs.incomings.${(E==null?void 0:E.id)||"current"}.calibrationSellerboardMonthEndEur`,children:t.jsx(Qe,{value:Me??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:n=>{Ze({calibrationSellerboardMonthEndEur:he(n)})}})}),t.jsxs(b,{type:"secondary",children:["Forecast roh: ",v(G,2)," EUR"]})]}),t.jsxs("div",{children:[t.jsx(b,{type:"secondary",children:"Prognose Auszahlung zum Monatsende (EUR)"}),t.jsx("div",{"data-field-key":`inputs.incomings.${(E==null?void 0:E.id)||"current"}.calibrationPayoutRateToDatePct`,children:t.jsx(Qe,{value:Ee??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:n=>{Ze({calibrationPayoutRateToDatePct:he(n)})}})}),t.jsxs(b,{type:"secondary",children:["Abgeleitete Quote: ",Number.isFinite(pt)?`${v(pt,2)} %`:"—"]})]}),t.jsxs("div",{children:[t.jsx(b,{type:"secondary",children:"Kalibrierfaktor (Preview)"}),t.jsx("div",{children:t.jsxs(b,{strong:!0,children:["Angewendet: ",A(Ge)]})}),t.jsx("div",{children:t.jsxs(b,{type:"secondary",children:["Basis: ",A(tn)," · Konservativ: ",A(nn)]})}),t.jsx("div",{children:t.jsxs(b,{type:"secondary",children:["Forecast kalibriert: ",v(bt,2)," EUR"]})})]})]}),t.jsxs(_,{wrap:!0,children:[t.jsxs(N,{color:"default",title:"Differenz Monatsende-Projektion Umsatz minus Forecast-Umsatz",children:["Delta Umsatz: ",Ct(Number(Xe||0))]}),t.jsxs(N,{color:"default",children:["Delta Umsatz (%): ",Number.isFinite(vt)?`${Bn(Number(vt))}%`:"—"]}),t.jsxs(N,{color:"default",title:"Differenz Projektion Auszahlung minus Auszahlung aus kalibriertem Umsatz x verwendeter Quote",children:["Delta Auszahlung: ",Number.isFinite(Nt)?Ct(Number(Nt)):"—"]}),an?t.jsx(N,{color:"warning",children:"Auffälliger Kalibrierfaktor"}):null,t.jsx(Te,{title:on,children:t.jsx(N,{color:"blue",children:"Kalibrier-Details"})}),t.jsx(Be,{size:"small",onClick:()=>{Ze({calibrationSellerboardMonthEndEur:null,calibrationPayoutRateToDatePct:null})},children:"Projektion leeren"})]})]}):t.jsx(at,{style:{marginTop:10},type:"info",showIcon:!0,message:"Aktueller Monat liegt nicht im Planungsfenster.",description:"Bitte Startmonat/Horizon anpassen, damit die Monatsende-Projektion gepflegt werden kann."})]}),t.jsxs(ot,{children:[t.jsxs(_,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsx(it,{level:5,style:{margin:0},children:"Monatstabelle: Umsatz / Auszahlung / Quote"}),t.jsxs(_,{wrap:!0,children:[t.jsx(Te,{title:"Füllt nur Monate ohne Umsatz-Override (AUTO).",children:t.jsx(Be,{size:"small",onClick:un,children:"Forecast in leere Monate übernehmen"})}),t.jsx(Be,{size:"small",danger:!0,onClick:mn,children:"Alle Monats-Overrides zurücksetzen"})]})]}),t.jsxs(_,{style:{marginTop:10,marginBottom:8},wrap:!0,children:[t.jsx(b,{strong:!0,children:"Globale Steuerung (Dashboard)"}),t.jsxs(N,{color:"blue",children:["Umsatzbasis: ",Fe==="forecast_direct"?"Forecast-Umsatz (direkt)":"Plan-Umsatz (Hybrid)"]}),t.jsxs(N,{color:U?"green":"default",children:["Kalibrierung: ",U?"AN":"AUS"]}),t.jsxs(N,{color:Ie==="recommendation"?"green":"orange",children:["Auszahlungsquote: ",Ie==="recommendation"?"Empfohlen (Plan)":"Manuell"]}),t.jsx(b,{type:"secondary",children:"Read-only in Cash-in. Ändern im Dashboard."})]}),t.jsx(yn,{style:{marginBottom:12},value:Re,onChange:n=>{Kt(String(n)==="payout"?"payout":"revenue")},options:[{label:"Umsatz",value:"revenue"},{label:"Auszahlungsquote",value:"payout"}]}),t.jsx(Sn,{children:t.jsxs("table",{className:"v2-stats-table","data-layout":"fixed",style:{minWidth:Re==="revenue"?1750:1320},children:[t.jsx("thead",{children:Re==="revenue"?t.jsxs("tr",{children:[t.jsx("th",{style:{width:130},children:"Monat"}),t.jsx("th",{style:{width:190},children:"Umsatz Forecast (EUR)"}),t.jsx("th",{style:{width:168},children:"Umsatz Manuell (EUR)"}),t.jsx("th",{style:{width:170},children:"Kalibrierungsfaktor"}),t.jsx("th",{style:{width:190},children:"Umsatz Kalibriert (EUR)"}),t.jsx("th",{style:{width:250},children:"Umsatz verwendet (EUR)"}),t.jsx("th",{style:{width:260},children:"Auszahlungsquote verwendet (%)"}),t.jsx("th",{style:{width:210},children:"Einzahlungen (EUR)"}),t.jsx("th",{style:{width:130},children:"Aktion"})]}):t.jsxs("tr",{children:[t.jsx("th",{style:{width:130},children:"Monat"}),t.jsx("th",{style:{width:280},children:"Manuelle Quote (%)"}),t.jsx("th",{style:{width:250},children:"Empfohlene Quote (%)"}),t.jsx("th",{style:{width:260},children:"Auszahlungsquote verwendet (%)"}),t.jsx("th",{style:{width:220},children:"Einzahlungen (EUR)"})]})}),t.jsx("tbody",{children:sn.map(n=>t.jsxs("tr",{children:[t.jsx("td",{children:Re==="revenue"?t.jsx(Te,{placement:"right",title:t.jsxs(_,{direction:"vertical",size:0,children:[t.jsxs(b,{style:{color:"white"},children:["Umsatz (Absatzprognose): ",v(n.forecastRevenue,2)," EUR"]}),t.jsxs(b,{style:{color:"white"},children:["Einzahlung (Dashboard): ",v(n.usedPayout,2)," EUR"]})]}),children:t.jsxs("div",{style:{display:"inline-block",cursor:"help"},children:[t.jsx(b,{strong:!0,children:n.monthLabel}),t.jsx("div",{children:t.jsx(b,{type:"secondary",children:n.month})})]})}):t.jsxs(t.Fragment,{children:[t.jsx(b,{strong:!0,children:n.monthLabel}),t.jsx("div",{children:t.jsx(b,{type:"secondary",children:n.month})})]})}),Re==="revenue"?t.jsxs(t.Fragment,{children:[t.jsx("td",{children:t.jsx(b,{children:v(n.forecastRevenue,2)})}),t.jsx("td",{children:t.jsxs("div",{"data-field-key":`inputs.incomings.${n.rowId}.revenueEur`,children:[t.jsx(Qe,{value:n.manualRevenue??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:a=>{const o=i(a),h=Number.isFinite(o)&&Number(o)>0;we(n.month,l=>({...l,revenueEur:h?Number(o):null,source:h?"manual":"forecast"}))}}),t.jsx("div",{style:{marginTop:6},children:n.hasManualRevenue?t.jsx(N,{color:"orange",style:{marginRight:0},children:"MANUELL"}):null})]})}),t.jsx("td",{children:t.jsx(b,{children:A(n.calibrationFactor)})}),t.jsx("td",{children:t.jsx(b,{children:v(n.calibratedRevenue,2)})}),t.jsx("td",{children:t.jsxs(_,{direction:"vertical",size:4,children:[t.jsx(b,{strong:!0,children:v(n.usedRevenue,2)}),t.jsx(N,{style:{marginRight:0},children:Un(n.usedRevenueSource)})]})}),t.jsx("td",{children:t.jsxs(_,{direction:"vertical",size:4,children:[t.jsx(b,{strong:!0,children:v(n.usedQuote,2)}),t.jsx(N,{style:{marginRight:0},children:yt(n.usedQuoteSource)})]})}),t.jsx("td",{children:t.jsx(b,{strong:!0,children:v(n.usedPayout,2)})}),t.jsx("td",{children:t.jsx(Be,{size:"small",type:"text",disabled:!n.hasManualRevenue,onClick:()=>cn(n.month),children:"↺ Reset"})})]}):t.jsxs(t.Fragment,{children:[t.jsx("td",{children:t.jsxs("div",{"data-field-key":`inputs.incomings.${n.rowId}.payoutPct`,children:[t.jsx(Qe,{value:n.manualQuote??void 0,mode:"percent",min:ge,max:fe,step:.1,style:{width:"100%"},onChange:a=>{we(n.month,o=>({...o,payoutPct:de(a)}))}}),t.jsx("div",{style:{marginTop:6},children:Number.isFinite(n.manualQuote)?t.jsx(N,{color:"orange",style:{marginRight:0},children:"MANUELL"}):t.jsx(b,{type:"secondary",children:"Leer = Empfehlung"})})]})}),t.jsx("td",{children:t.jsxs(_,{direction:"vertical",size:4,children:[t.jsx(b,{children:v(n.recommendedQuote,2)}),t.jsx(Te,{title:n.recommendationTooltip,children:t.jsx(N,{color:"blue",style:{marginRight:0},children:n.recommendationSourceLabel})})]})}),t.jsx("td",{children:t.jsxs(_,{direction:"vertical",size:4,children:[t.jsx(b,{strong:!0,children:v(n.usedQuote,2)}),t.jsx(N,{style:{marginRight:0},children:yt(n.usedQuoteSource)})]})}),t.jsx("td",{children:t.jsx(b,{strong:!0,children:v(n.usedPayout,2)})})]})]},n.month))})]})})]})]})}export{sa as default};
