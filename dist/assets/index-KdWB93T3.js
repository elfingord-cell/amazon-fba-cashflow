import{an as sr,I as nr,ao as xr,t as m,a4 as D,ap as vr,aq as Sr,k as e,S as T,J as Rt,K as k,a5 as he,P as Ve,L as ae,M as xe,O as se}from"./index-CAzQztwo.js";import{T as Pr}from"./TanStackGrid-DGGNjv9D.js";import{D as V}from"./DeNumberInput-S8NAtNBo.js";import{r as vt,a as Mt,s as Re,b as kr}from"./productCompletenessV2-CJLSMhtL.js";import{u as ir,C as pe,T as wr}from"./workspace-xr5uOuIo.js";import{u as Nr}from"./modalCollaboration-5eCYV3lX.js";import{b as Ir,a as Ht,d as ar,c as or,r as Gt,n as ft,i as Ce,e as Xt,f as Mr,s as lr,F as Ur,T as Cr,I as Rr,P as dr,g as Dt,h as Fr,j as xt,k as Or,l as Ar,m as Ut,o as Lr,p as Zt,q as He,t as fe,u as zr,v as cr}from"./orderUtils-B3NFjWvV.js";import{C as Ge}from"./index-5SR9pC2K.js";import{S as Pe}from"./index-C15xyCf_.js";import{s as et}from"./index-Cs7EqDZh.js";import{b as ur,n as Yt,i as tr,a as Br}from"./orderEditorFactory-3AxbAuwW.js";import"./index-Dab_0RQN.js";import"./Dropdown-CZlZd-6U.js";import"./foSuggestion-Ck1952gl.js";import"./useBubbleLock-Cjjrx1CM.js";import"./store-BzgQ-F5B.js";import"./prefill-BxMihg1A.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-cLNRxzoZ.js";const{Paragraph:$r,Text:O,Title:Wr}=Rt;function Te(n){if(!n)return"—";const[a,j,p]=String(n).split("-").map(Number);if(!a||!j||!p)return"—";const P=new Date(Date.UTC(a,j-1,p));return Number.isNaN(P.getTime())?"—":P.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function me(n,a=0){const j=Number(n);return Number.isFinite(j)?j.toLocaleString("de-DE",{minimumFractionDigits:a,maximumFractionDigits:a}):"—"}function Jt(n){const a=Number(n);return Number.isFinite(a)?a.toLocaleString("de-DE",{style:"currency",currency:"EUR"}):"—"}function Kr(n){return Array.isArray(n)?n.map(a=>a).map(a=>({month:String(a.month||""),daysCovered:Math.max(0,Number(a.daysCovered||0)),forecastMonthUnits:Number.isFinite(Number(a.forecastMonthUnits))?Number(a.forecastMonthUnits):null,demandUnitsInWindow:Number.isFinite(Number(a.demandUnitsInWindow))?Number(a.demandUnitsInWindow):0,usedFallback:!!a.usedFallback})).filter(a=>/^\d{4}-\d{2}$/.test(a.month)):[]}function mr(n){const a=ft(n);return a==="ACTIVE"?e.jsx(ae,{color:"green",children:"Active"}):a==="CONVERTED"?e.jsx(ae,{color:"blue",children:"Converted"}):a==="ARCHIVED"?e.jsx(ae,{color:"default",children:"Archived"}):e.jsx(ae,{color:"gold",children:"Draft"})}function Zr(n){return n==="ACTIVE"?"DRAFT":"ACTIVE"}function qr(n){return n==="supplier"?"Supplier":n==="freight"?"Shipping China -> 3PL":n==="duty"?"Custom Duties":n==="eust"?"Einfuhrumsatzsteuer":"EUSt Erstattung"}function _r(n){if(typeof n.active=="boolean")return n.active;const a=String(n.status||"").trim().toLowerCase();return a?a==="active"||a==="aktiv":!0}function hr(n){let a=0;const j=/(\d+)(?!.*\d)/;return(n||[]).forEach(p=>{const P=p,L=j.exec(String(P.poNo||""));if(!L)return;const N=Number(L[1]);Number.isFinite(N)&&N>a&&(a=N)}),a>0?String(a+1):String((n||[]).length+1)}function Ct(n){const a=String(n||"").trim();if(!a||!/^\d{4}-\d{2}-\d{2}$/.test(a))return null;const j=new Date(`${a}T00:00:00Z`);return Number.isNaN(j.getTime())?null:a}function pr(n,a){return!n&&!a?0:n?a?n.localeCompare(a):-1:1}function Qt(n){return Ct(n.targetDeliveryDate)||Ct(n.deliveryDate)||Ct(n.etaDate)}function Er(n){return Math.round(n*100)/100}function Hr(n){const a=Number(n);return Number.isFinite(a)?a:null}function jt(n){const a=Number(n);return!Number.isFinite(a)||a<=0?null:a}function Tr(n){const a=n!=null&&n.template&&typeof n.template=="object"?n.template:{};return(a.fields&&typeof a.fields=="object"?a.fields:a)||{}}function yr(n){const a=n.product||{},j=n.settings||{},p=Tr(a),P=vt({state:n.state||{},product:a,sku:String(a.sku||""),supplierId:n.supplierId||String(a.supplierId||""),orderContext:"fo"}),L=Number(P.fields.unitPriceUsd.value||0),N=Number(P.fields.fxRate.value||j.fxRate||0),M=Number(P.fields.logisticsPerUnitEur.value||0),ye=Math.max(0,Er(M*Math.max(0,Number(n.units||0)))),ne=String(p.transportMode||"SEA").toUpperCase(),Fe=Number(P.fields.transitDays.value||45),tt=Number(P.fields.productionLeadTimeDays.value||45),Me=P.fields.ddp.value===!0,St=P.fields.incoterm.value||(Me?"DDP":"EXW"),Oe=P.fields.currency.value||String(j.defaultCurrency||"EUR").toUpperCase();return{transportMode:ne,incoterm:String(St).toUpperCase(),unitPrice:L,currency:String(Oe).toUpperCase(),freight:ye,freightCurrency:"EUR",dutyRatePct:Number(P.fields.dutyRatePct.value||0),eustRatePct:Number(P.fields.eustRatePct.value||0),fxRate:N,productionLeadTimeDays:Math.max(0,Math.round(tt)),logisticsLeadTimeDays:Math.max(0,Math.round(Fe)),bufferDays:Math.max(0,Math.round(Hr(j.defaultBufferDays)??0))}}function Gr(n){const a=n.product||{},j=n.settings||{},p=Tr(a),P=String(n.transportMode||p.transportMode||"SEA").toUpperCase(),L=j.transportLeadTimesDays||{};let N="Fallback";jt(a.productionLeadTimeDaysDefault)!=null?N="Produkt-Override":jt(p.productionDays)!=null?N="Beschaffungs-Template":jt(j.defaultProductionLeadTimeDays)!=null&&(N="Settings-Default");let M="Fallback";return jt(p.transitDays)!=null?M="Beschaffungs-Template":jt(L[P.toLowerCase()])!=null?M=`Settings-Default (${P})`:jt(L.sea)!=null&&(M="Settings-Default (SEA)"),{production:N,logistics:M}}function Xr({embedded:n=!1}={}){var Ne;const a=sr(),j=nr(),{state:p,loading:P,saving:L,error:N,lastSavedAt:M,saveWith:ye}=ir(),ne=xr(),[Fe,tt]=m.useState(""),[Me,St]=m.useState("ALL"),[Oe,Xe]=m.useState(!1),[H,ot]=m.useState(null),[Pt,Ae]=m.useState(!1),[ee,Ze]=m.useState(null),[Ft,mt]=m.useState(""),[lt,ht]=m.useState(""),[dt,Ue]=m.useState([]),[Ot,ct]=m.useState(!1),[le,be]=m.useState(""),[Ye,pt]=m.useState(""),[rt,W]=m.useState("earliest"),[ke,qe]=m.useState(""),[kt,st]=m.useState(!1),[B]=D.useForm(),K=p,te=p.settings||{},Nt=m.useMemo(()=>vr(te),[te]),d=m.useMemo(()=>Sr({userId:ne.userId,userEmail:ne.email},Nt),[Nt,ne.email,ne.userId]),Le=m.useMemo(()=>`fo:edit:${String(H||"new")}`,[H]),z=Nr({workspaceId:ne.workspaceId,modalScope:Le,isOpen:Oe,userId:ne.userId,userEmail:ne.email,userDisplayName:d,displayNames:Nt}),Z=m.useMemo(()=>(Array.isArray(p.suppliers)?p.suppliers:[]).map(t=>t).map(t=>({id:String(t.id||""),name:String(t.name||"—"),productionLeadTimeDaysDefault:Number(t.productionLeadTimeDaysDefault)||0,incotermDefault:String(t.incotermDefault||"EXW").toUpperCase(),currencyDefault:String(t.currencyDefault||"EUR").toUpperCase(),raw:t})).filter(t=>t.id),[p.suppliers]),ce=m.useMemo(()=>new Map(Z.map(t=>[t.id,t.raw])),[Z]),g=m.useMemo(()=>(Array.isArray(p.products)?p.products:[]).map(t=>t).map(t=>({sku:String(t.sku||""),alias:String(t.alias||t.sku||""),status:String(t.status||"active"),supplierId:String(t.supplierId||""),productionLeadTimeDaysDefault:Number(t.productionLeadTimeDaysDefault)||0,raw:t})).filter(t=>t.sku),[p.products]),G=m.useMemo(()=>new Map(g.map(t=>[t.sku,t])),[g]),de=m.useMemo(()=>Ir(K),[p.forecast,p.inventory,p.pos,p.fos]),ze=m.useMemo(()=>{const t=(Array.isArray(p.fos)?p.fos:[]).map(h=>{const c=h,x=String(c.sku||""),I=G.get(x),J=Z.find(_=>_.id===String(c.supplierId||"")),b=Ht({targetDeliveryDate:c.targetDeliveryDate,productionLeadTimeDays:c.productionLeadTimeDays,logisticsLeadTimeDays:c.logisticsLeadTimeDays,bufferDays:c.bufferDays}),C={orderDate:String(c.orderDate||b.orderDate||""),etdDate:String(c.etdDate||b.etdDate||""),etaDate:String(c.etaDate||b.etaDate||"")},Q=ar({units:c.units,unitPrice:c.unitPrice,currency:c.currency,freight:c.freight,freightCurrency:c.freightCurrency,dutyRatePct:c.dutyRatePct,eustRatePct:c.eustRatePct,fxRate:c.fxRate}),We=Number(c.productionLeadTimeDays||0)+Number(c.logisticsLeadTimeDays||0)+Number(c.bufferDays||0),Ee=or({context:de,sku:x,leadTimeDays:We,product:Gt(g.map(_=>_.raw),x),settings:te,horizonMonths:12});let Ke="—",_e=null;return Ee&&(Ee.status==="no_fo_needed"?Ke="Keine FO erforderlich":Ee.status==="ok"?(_e=Number(Ee.recommendedUnits||0),Ke=`${me(_e,0)} Units`):Ke="Nicht berechenbar"),{id:String(c.id||""),sku:x,alias:(I==null?void 0:I.alias)||x||"—",supplierId:String(c.supplierId||""),supplierName:(J==null?void 0:J.name)||"—",units:Number(c.units||0),targetDeliveryDate:c.targetDeliveryDate?String(c.targetDeliveryDate):null,orderDate:C.orderDate||null,etdDate:C.etdDate||null,etaDate:C.etaDate||null,landedCostEur:Er(Q.landedCostEur),status:ft(c.status),convertedPoNo:c.convertedPoNo?String(c.convertedPoNo):null,recommendationText:Ke,recommendationUnits:_e,raw:c}}),o=Fe.trim().toLowerCase();return t.filter(h=>Me!=="ALL"&&h.status!==Me?!1:o?[h.alias,h.sku,h.supplierName,h.status].join(" ").toLowerCase().includes(o):!0).sort((h,c)=>(h.targetDeliveryDate||"").localeCompare(c.targetDeliveryDate||""))},[G,g,de,Fe,te,p.fos,Me,Z]),ut=m.useMemo(()=>{const t=new Map;return(Array.isArray(p.fos)?p.fos:[]).forEach(o=>{const h=o,c=String(h.id||"").trim();c&&t.set(c,h)}),t},[p.fos]),re=m.useMemo(()=>dt.map(t=>ut.get(t)||null).filter(t=>!!t).filter(t=>Ce(t.status)),[ut,dt]),Je=m.useMemo(()=>re.map(t=>Qt(t)).filter(t=>!!t).sort((t,o)=>pr(t,o))[0]||"",[re]),nt=m.useMemo(()=>rt==="manual"?Ct(ke)||null:Ct(Je)||null,[Je,ke,rt]),Be=m.useMemo(()=>Array.from(new Set(re.map(t=>String(t.supplierId||"").trim()).filter(Boolean))),[re]).length>1,At=m.useMemo(()=>Array.from(new Set(re.map(t=>String(t.transportMode||"").trim().toUpperCase()).filter(Boolean))),[re]),Lt=m.useMemo(()=>Array.from(new Set(re.map(t=>String(t.incoterm||"").trim().toUpperCase()).filter(Boolean))),[re]),zt=At.length>1||Lt.length>1,Bt=m.useMemo(()=>nt?re.map(t=>{const o=Qt(t),h=pr(o,nt),c=h<0?"Zu spät bei gemeinsamer PO":h>0?"Früher als Ziel":"Passt";return{id:String(t.id||""),sku:String(t.sku||""),targetDate:o,deviation:c,status:h}}):[],[nt,re]);m.useEffect(()=>{Ue(t=>t.filter(o=>{const h=ut.get(o);return!!h&&Ce(h==null?void 0:h.status)}))},[ut]);const ue=m.useMemo(()=>[{header:"Merge",meta:{width:84,minWidth:84},cell:({row:t})=>{const o=Ce(t.original.status);return e.jsx(Ge,{checked:dt.includes(t.original.id),disabled:!o,onChange:h=>{const c=h.target.checked;Ue(x=>c?Array.from(new Set([...x,t.original.id])):x.filter(I=>I!==t.original.id))}})}},{header:"FO",cell:({row:t})=>String(t.original.id||"").slice(-6).toUpperCase()},{header:"Produkt",cell:({row:t})=>e.jsxs(T,{direction:"vertical",size:0,children:[e.jsx(O,{children:t.original.alias}),e.jsx(O,{type:"secondary",children:t.original.sku})]})},{header:"Supplier",accessorKey:"supplierName"},{header:"Units",cell:({row:t})=>me(t.original.units,0)},{header:"Target",cell:({row:t})=>Te(t.original.targetDeliveryDate)},{header:"Order",cell:({row:t})=>Te(t.original.orderDate)},{header:"ETD / ETA",cell:({row:t})=>e.jsxs(T,{direction:"vertical",size:0,children:[e.jsxs(O,{children:["ETD ",Te(t.original.etdDate)]}),e.jsxs(O,{type:"secondary",children:["ETA ",Te(t.original.etaDate)]})]})},{header:"Landed EUR",cell:({row:t})=>Jt(t.original.landedCostEur)},{header:"Empfehlung",cell:({row:t})=>t.original.recommendationText},{header:"Status",cell:({row:t})=>mr(t.original.status)},{header:"Aktionen",meta:{width:250,minWidth:250},cell:({row:t})=>e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(k,{size:"small",onClick:()=>{Y(t.original.raw)},children:Ce(t.original.status)?"Bearbeiten":"Details"}),e.jsx(k,{size:"small",disabled:!Ce(t.original.status),onClick:()=>{Ze(t.original.id),mt(hr(Array.isArray(p.pos)?p.pos:[])),ht(t.original.orderDate||""),Ae(!0)},children:"Convert"}),t.original.convertedPoNo?e.jsx(k,{size:"small",onClick:()=>{const o=new URLSearchParams;o.set("source","fo_convert"),o.set("poNo",String(t.original.convertedPoNo||"")),j(`/v2/orders/po?${o.toString()}`)},children:"PO öffnen"}):null,e.jsx(k,{size:"small",danger:!0,disabled:!Ce(t.original.status),onClick:()=>{he.confirm({title:"FO loeschen?",onOk:async()=>{await ye(o=>{const h=Ve(o);return h.fos=(Array.isArray(h.fos)?h.fos:[]).filter(c=>String(c.id||"")!==t.original.id),h},"v2:fo:delete")}})},children:"Loeschen"})]})}],[dt,j,ye,p.pos]),s=D.useWatch([],B),ge=m.useMemo(()=>H&&ze.find(t=>t.id===H)||null,[H,ze]),it=m.useMemo(()=>ft((s==null?void 0:s.status)||(ge==null?void 0:ge.status)||"DRAFT"),[s==null?void 0:s.status,ge==null?void 0:ge.status]),$t=!Ce(it),ie=z.readOnly||$t,Wt=String((ge==null?void 0:ge.convertedPoNo)||((Ne=ge==null?void 0:ge.raw)==null?void 0:Ne.convertedPoNo)||"").trim(),oe=m.useMemo(()=>{var o;const t=String((s==null?void 0:s.sku)||"").trim();return t&&((o=G.get(t))==null?void 0:o.raw)||null},[s==null?void 0:s.sku,G]),ve=m.useMemo(()=>vt({state:K,product:oe||void 0,sku:String((s==null?void 0:s.sku)||""),supplierId:String((s==null?void 0:s.supplierId)||(oe==null?void 0:oe.supplierId)||""),orderContext:"fo",orderOverrides:{unitPrice:s==null?void 0:s.unitPrice,productionLeadTimeDays:s==null?void 0:s.productionLeadTimeDays,logisticsLeadTimeDays:s==null?void 0:s.logisticsLeadTimeDays,dutyRatePct:s==null?void 0:s.dutyRatePct,eustRatePct:s==null?void 0:s.eustRatePct,incoterm:s==null?void 0:s.incoterm,currency:s==null?void 0:s.currency,fxRate:s==null?void 0:s.fxRate}}),[s==null?void 0:s.currency,s==null?void 0:s.dutyRatePct,s==null?void 0:s.eustRatePct,s==null?void 0:s.fxRate,s==null?void 0:s.incoterm,s==null?void 0:s.logisticsLeadTimeDays,s==null?void 0:s.productionLeadTimeDays,s==null?void 0:s.sku,s==null?void 0:s.supplierId,s==null?void 0:s.unitPrice,oe,K]),$e=m.useMemo(()=>vt({state:K,product:oe||void 0,sku:String((s==null?void 0:s.sku)||""),supplierId:String((s==null?void 0:s.supplierId)||(oe==null?void 0:oe.supplierId)||""),orderContext:"fo"}),[s==null?void 0:s.sku,s==null?void 0:s.supplierId,oe,K]),Et=m.useMemo(()=>Mt({product:oe,state:K,supplierId:String((s==null?void 0:s.supplierId)||(oe==null?void 0:oe.supplierId)||""),orderContext:"fo",orderOverrides:{unitPrice:s==null?void 0:s.unitPrice,productionLeadTimeDays:s==null?void 0:s.productionLeadTimeDays,logisticsLeadTimeDays:s==null?void 0:s.logisticsLeadTimeDays,dutyRatePct:s==null?void 0:s.dutyRatePct,eustRatePct:s==null?void 0:s.eustRatePct,incoterm:s==null?void 0:s.incoterm}}),[s==null?void 0:s.dutyRatePct,s==null?void 0:s.eustRatePct,s==null?void 0:s.incoterm,s==null?void 0:s.logisticsLeadTimeDays,s==null?void 0:s.productionLeadTimeDays,s==null?void 0:s.supplierId,s==null?void 0:s.unitPrice,oe,K]);function Qe(t){if(t==="unitPrice"){B.setFieldValue("unitPrice",Number($e.fields.unitPriceUsd.value||0));return}if(t==="productionLeadTimeDays"){B.setFieldValue("productionLeadTimeDays",Number($e.fields.productionLeadTimeDays.value||0));return}if(t==="logisticsLeadTimeDays"){B.setFieldValue("logisticsLeadTimeDays",Number($e.fields.transitDays.value||0));return}if(t==="dutyRatePct"){B.setFieldValue("dutyRatePct",Number($e.fields.dutyRatePct.value||0));return}if(t==="eustRatePct"){B.setFieldValue("eustRatePct",Number($e.fields.eustRatePct.value||0));return}if(t==="incoterm"){B.setFieldValue("incoterm",String($e.fields.incoterm.value||"EXW"));return}if(t==="currency"){B.setFieldValue("currency",String($e.fields.currency.value||te.defaultCurrency||"EUR"));return}B.setFieldValue("fxRate",Number($e.fields.fxRate.value||te.fxRate||0))}function r(t,o){const h=String((oe==null?void 0:oe.sku)||(s==null?void 0:s.sku)||"").trim();h&&he.confirm({title:"Als neuen Produkt-Stammdatenwert uebernehmen?",content:`SKU ${h}: Wert wird in den Produktstammdaten gespeichert.`,okText:"Uebernehmen",cancelText:"Abbrechen",onOk:()=>{he.confirm({title:"Bist du sicher?",content:"Diese Aenderung beeinflusst zukuenftige FO/PO Prefills.",okText:"Ja, speichern",cancelText:"Nein",onOk:async()=>{await ye(c=>{const x=Ve(c),I=Array.isArray(x.products)?[...x.products]:[],J=I.findIndex(C=>String(C.sku||"").trim().toLowerCase()===h.toLowerCase());if(J<0)return x;const b=I[J];return I[J]={...kr({product:b,field:t,value:o}),updatedAt:xt()},x.products=I,x},"v2:fo:adopt-masterdata"),et.success("Produkt-Stammdaten aktualisiert.")}})}})}const l=m.useMemo(()=>{var h;const t=String((s==null?void 0:s.sku)||"").trim(),o=t&&((h=G.get(t))==null?void 0:h.raw)||null;return Gr({product:o,settings:te,transportMode:(s==null?void 0:s.transportMode)||null})},[s==null?void 0:s.sku,s==null?void 0:s.transportMode,G,te]),i=m.useMemo(()=>Ht({targetDeliveryDate:s==null?void 0:s.targetDeliveryDate,productionLeadTimeDays:s==null?void 0:s.productionLeadTimeDays,logisticsLeadTimeDays:s==null?void 0:s.logisticsLeadTimeDays,bufferDays:s==null?void 0:s.bufferDays}),[s]),u=m.useMemo(()=>ar({units:s==null?void 0:s.units,unitPrice:s==null?void 0:s.unitPrice,currency:s==null?void 0:s.currency,freight:s==null?void 0:s.freight,freightCurrency:s==null?void 0:s.freightCurrency,dutyRatePct:s==null?void 0:s.dutyRatePct,eustRatePct:s==null?void 0:s.eustRatePct,fxRate:s==null?void 0:s.fxRate}),[s]),y=m.useMemo(()=>{const t=(s==null?void 0:s.sku)||"";if(!t)return null;const o=Number((s==null?void 0:s.productionLeadTimeDays)||0)+Number((s==null?void 0:s.logisticsLeadTimeDays)||0)+Number((s==null?void 0:s.bufferDays)||0),h=Gt(g.map(c=>c.raw),t);return or({context:de,sku:t,leadTimeDays:o,product:h,settings:te,horizonMonths:12,requiredArrivalMonth:s!=null&&s.targetDeliveryDate?String(s.targetDeliveryDate).slice(0,7):null})},[s,g,de,te]),v=m.useMemo(()=>Kr(y==null?void 0:y.coverageDemandBreakdown),[y==null?void 0:y.coverageDemandBreakdown]),E=m.useMemo(()=>v.reduce((t,o)=>t+Number(o.demandUnitsInWindow||0),0),[v]),f=m.useMemo(()=>s?Xt({supplierTerms:Array.isArray(s.paymentTerms)?s.paymentTerms:[],schedule:i,unitPrice:s.unitPrice,units:s.units,currency:s.currency,freight:s.freight,freightCurrency:s.freightCurrency,dutyRatePct:s.dutyRatePct,eustRatePct:s.eustRatePct,fxRate:s.fxRate,incoterm:s.incoterm,vatRefundLagMonths:te.vatRefundLagMonths}).map(o=>{const h=o.currency==="EUR"?Number(o.amount||0):Mr(o.amount,o.currency,s.fxRate);return{id:String(o.id||""),label:String(o.label||""),category:o.category,currency:String(o.currency||"EUR"),amount:Number(o.amount||0),plannedEur:Number.isFinite(h)?h:0,dueDate:o.dueDate?String(o.dueDate):null,triggerEvent:String(o.triggerEvent||"ORDER_DATE"),offsetDays:Number(o.offsetDays||0),offsetMonths:Number(o.offsetMonths||0)}}):[],[s,i,te.vatRefundLagMonths]),S=m.useMemo(()=>lr((s==null?void 0:s.paymentTerms)||[]),[s==null?void 0:s.paymentTerms]);m.useEffect(()=>{!Oe||!z.readOnly||!z.remoteDraftPatch||B.setFieldsValue(z.remoteDraftPatch)},[B,z.readOnly,z.remoteDraftPatch,z.remoteDraftVersion,Oe]);function F(t,o){var We;const h=g.find(Ee=>_r(Ee.raw))||g[0]||null,c=String((o==null?void 0:o.sku)||(t==null?void 0:t.sku)||(h==null?void 0:h.sku)||""),x=G.get(c)||h,I=String((o==null?void 0:o.supplierId)||(t==null?void 0:t.supplierId)||(x==null?void 0:x.supplierId)||((We=Z[0])==null?void 0:We.id)||""),J=ce.get(I)||null,b=Number((o==null?void 0:o.units)??(t==null?void 0:t.units)??0),C=yr({state:K,product:(x==null?void 0:x.raw)||null,settings:te,supplierId:I,units:b}),Q=Dt(t==null?void 0:t.payments,J||void 0);return{id:t!=null&&t.id?String(t.id):void 0,sku:c,supplierId:I,status:ft((t==null?void 0:t.status)||(o==null?void 0:o.status)||"DRAFT"),targetDeliveryDate:String((o==null?void 0:o.targetDeliveryDate)||(t==null?void 0:t.targetDeliveryDate)||new Date().toISOString().slice(0,10)),units:b,transportMode:String((t==null?void 0:t.transportMode)||C.transportMode||"SEA").toUpperCase(),incoterm:String((t==null?void 0:t.incoterm)||C.incoterm||"EXW").toUpperCase(),unitPrice:Number((t==null?void 0:t.unitPrice)??C.unitPrice??0),currency:String((t==null?void 0:t.currency)||C.currency||te.defaultCurrency||"EUR").toUpperCase(),freight:Number((t==null?void 0:t.freight)??C.freight??0),freightCurrency:String((t==null?void 0:t.freightCurrency)||C.freightCurrency||"EUR").toUpperCase(),dutyRatePct:Number((t==null?void 0:t.dutyRatePct)??C.dutyRatePct??0),eustRatePct:Number((t==null?void 0:t.eustRatePct)??C.eustRatePct??0),fxRate:Number((t==null?void 0:t.fxRate)??C.fxRate??te.fxRate??0),productionLeadTimeDays:Number((t==null?void 0:t.productionLeadTimeDays)??C.productionLeadTimeDays??45),logisticsLeadTimeDays:Number((t==null?void 0:t.logisticsLeadTimeDays)??C.logisticsLeadTimeDays??45),bufferDays:Number((t==null?void 0:t.bufferDays)??C.bufferDays??te.defaultBufferDays??0),paymentTerms:Q}}function X(t,o){const h=String(t||"").trim();if(!h)return;const c=G.get(h)||null;if(!c)return;const x=B.getFieldsValue(),I=String(c.supplierId||x.supplierId||""),J=ce.get(I)||null,b=yr({state:K,product:c.raw,settings:te,supplierId:I,units:Number(x.units??0)});B.setFieldsValue({supplierId:I||x.supplierId,transportMode:b.transportMode,incoterm:b.incoterm,unitPrice:b.unitPrice,currency:b.currency,freight:b.freight,freightCurrency:b.freightCurrency,dutyRatePct:b.dutyRatePct,eustRatePct:b.eustRatePct,fxRate:b.fxRate,productionLeadTimeDays:b.productionLeadTimeDays,logisticsLeadTimeDays:b.logisticsLeadTimeDays,bufferDays:b.bufferDays,paymentTerms:Dt([],J||void 0)})}function R(t){ot(null);const o=F(null,t);B.setFieldsValue({...o,...t||{}}),Xe(!0)}function Y(t){ot(String(t.id||"")),B.setFieldsValue(F(t)),Xe(!0)}function Se(){if(re.length<2){et.warning("Bitte mindestens 2 aktive FOs fuer den Merge auswaehlen.");return}const o=Je||"";be(hr(Array.isArray(p.pos)?p.pos:[])),pt(""),W("earliest"),qe(o),st(!1),ct(!0)}async function U(t){var $;if(z.readOnly)throw new Error("Dieser FO wird gerade von einem anderen Nutzer bearbeitet.");const o=String(t.sku||"").trim(),h=o?Gt(g.map(De=>De.raw),o):null,c=String((h==null?void 0:h.supplierId)||"").trim(),x=String(c||t.supplierId||"").trim();if(!x)throw new Error("Supplier ist erforderlich.");if(!h&&!t.supplierId)throw new Error("SKU nicht gefunden. Bitte Produkt prüfen.");const I=H&&(($=ze.find(De=>De.id===H))==null?void 0:$.raw)||null,J=ft((I==null?void 0:I.status)||"DRAFT"),b=ft(t.status||J||"DRAFT");let C=b;I&&!Ce(J)?C=J:Ce(b)||(C=I?J:"DRAFT");const Q={...t,supplierId:x,status:C},We=Mt({product:h,state:K,supplierId:x,orderContext:"fo",orderOverrides:{unitPrice:Q.unitPrice,productionLeadTimeDays:Q.productionLeadTimeDays,logisticsLeadTimeDays:Q.logisticsLeadTimeDays,dutyRatePct:Q.dutyRatePct,eustRatePct:Q.eustRatePct,incoterm:Q.incoterm}});if(We.blocked)throw new Error(`Blockierende Stammdaten fehlen: ${We.issues.map(De=>De.label).join(", ")}`);const Ee=(t.paymentTerms||[]).map(De=>({id:De.id,label:String(De.label||"Milestone"),percent:Number(De.percent||0),triggerEvent:String(De.triggerEvent||"ORDER_DATE").toUpperCase(),offsetDays:Number(De.offsetDays||0),offsetMonths:Number(De.offsetMonths||0)})),Ke=lr(Ee);if(Math.abs(Ke-100)>.01)throw new Error("Supplier Payment Terms muessen in Summe 100% ergeben.");const _e=Ht({targetDeliveryDate:Q.targetDeliveryDate,productionLeadTimeDays:Q.productionLeadTimeDays,logisticsLeadTimeDays:Q.logisticsLeadTimeDays,bufferDays:Q.bufferDays}),_=Or({existing:I,supplierTerms:Ee,values:Q,schedule:_e,vatRefundLagMonths:te.vatRefundLagMonths});await ye(De=>{const yt=Ve(De),gt=Array.isArray(yt.fos)?[...yt.fos]:[],Tt=gt.findIndex(_t=>String(_t.id||"")===String(_.id));return Tt>=0?gt[Tt]=_:gt.push(_),yt.fos=gt,yt},H?"v2:fo:update":"v2:fo:create"),z.clearDraft(),Xe(!1),ot(null),B.resetFields()}async function w(){const t=ee;if(!t)return;const o=String(Ft||"").trim();if(!o)throw new Error("PO Nummer ist erforderlich.");await ye(h=>{var _;const c=Ve(h),x=Array.isArray(c.pos)?[...c.pos]:[],I=Array.isArray(c.fos)?[...c.fos]:[];if(x.some($=>String($.poNo||"")===o))throw new Error(`PO Nummer ${o} existiert bereits.`);const J=I.findIndex($=>String($.id||"")===t);if(J<0)throw new Error("FO nicht gefunden.");const b={...I[J]};if(!Ce(b.status))throw new Error("Nur aktive FOs (Draft/Active) koennen konvertiert werden.");const C=Ar({fo:b,poNumber:o,orderDateOverride:lt||String(b.orderDate||"")});x.push(C);const We=new Map((Array.isArray(c.suppliers)?c.suppliers:[]).map($=>$).map($=>[String($.id||""),$])).get(String(b.supplierId||""))||null,Ee=Dt(b.payments,We||void 0),Ke=Ut({orderDate:lt||b.orderDate,productionLeadTimeDays:b.productionLeadTimeDays,logisticsLeadTimeDays:b.logisticsLeadTimeDays,bufferDays:b.bufferDays,deliveryDate:b.targetDeliveryDate}),_e=Xt({supplierTerms:Ee,schedule:Ke,unitPrice:b.unitPrice,units:b.units,currency:b.currency,freight:b.freight,freightCurrency:b.freightCurrency,dutyRatePct:b.dutyRatePct,eustRatePct:b.eustRatePct,fxRate:b.fxRate,incoterm:b.incoterm,vatRefundLagMonths:(_=c.settings)==null?void 0:_.vatRefundLagMonths});return I[J]={...b,...Ke,payments:_e,status:"CONVERTED",convertedPoId:C.id,convertedPoNo:C.poNo,updatedAt:xt()},c.pos=x,c.fos=I,c},"v2:fo:convert"),Ae(!1),Ze(null),Ue(h=>h.filter(c=>c!==t)),et.success(`FO wurde in PO ${o} konvertiert.`)}async function q(){const t=re;if(t.length<2)throw new Error("Bitte mindestens 2 FOs auswaehlen.");if(Be)throw new Error("Merge ist nur mit gleichem Lieferanten erlaubt.");if(zt&&!kt)throw new Error("Bitte gemischte Transport/Incoterm explizit bestaetigen.");const o=String(le||"").trim();if(!o)throw new Error("PO Nummer ist erforderlich.");const h=nt;if(rt==="manual"&&!h)throw new Error("Bitte ein manuelles Ziel-Lieferdatum setzen.");await ye(c=>{var _e;const x=Ve(c),I=Array.isArray(x.pos)?[...x.pos]:[],J=Array.isArray(x.fos)?[...x.fos]:[];if(I.some(_=>String(_.poNo||"")===o))throw new Error(`PO Nummer ${o} existiert bereits.`);const b=t.map(_=>String(_.id||"")),C=J.filter(_=>b.includes(String(_.id||""))).map(_=>({..._}));if(C.length!==t.length)throw new Error("Nicht alle ausgewaehlten FOs konnten geladen werden.");if(C.some(_=>!Ce(_.status)))throw new Error("Enthaelt bereits konvertierte oder archivierte FOs.");const Q=Lr({fos:C,poNumber:o,orderDateOverride:Ye||null,targetDeliveryDate:h});I.push(Q);const We=new Map((Array.isArray(x.suppliers)?x.suppliers:[]).map(_=>_).map(_=>[String(_.id||""),_])),Ee=(_e=x.settings)==null?void 0:_e.vatRefundLagMonths,Ke=J.map(_=>{const $=_,De=String($.id||"");if(!b.includes(De))return $;const yt=We.get(String($.supplierId||""))||null,gt=Dt($.payments,yt||void 0),Tt=Ut({orderDate:Ye||Q.orderDate||$.orderDate,productionLeadTimeDays:$.productionLeadTimeDays,logisticsLeadTimeDays:$.logisticsLeadTimeDays,bufferDays:$.bufferDays,deliveryDate:h||$.targetDeliveryDate}),_t=Xt({supplierTerms:gt,schedule:Tt,unitPrice:$.unitPrice,units:$.units,currency:$.currency,freight:$.freight,freightCurrency:$.freightCurrency,dutyRatePct:$.dutyRatePct,eustRatePct:$.eustRatePct,fxRate:$.fxRate,incoterm:$.incoterm,vatRefundLagMonths:Ee});return{...$,...Tt,payments:_t,status:"CONVERTED",convertedPoId:Q.id,convertedPoNo:Q.poNo,updatedAt:xt()}});return x.pos=I,x.fos=Ke,x},"v2:fo:merge-convert"),ct(!1),Ue([]),st(!1),pt(""),qe(""),be(""),W("earliest"),et.success(`FO-Merge erstellt PO ${o}.`)}return m.useEffect(()=>{const t=new URLSearchParams(a.search);if(t.get("source")!=="inventory_projection")return;const o=String(t.get("sku")||"").trim();if(!o)return;const h=G.get(o)||null,c=Math.max(0,Math.round(Number(t.get("suggestedUnits")||0))),x=String(t.get("requiredArrivalDate")||""),I={sku:o,units:c,status:"ACTIVE"};h!=null&&h.supplierId&&(I.supplierId=String(h.supplierId)),x&&(I.targetDeliveryDate=x),R(I),j(a.pathname,{replace:!0})},[a.pathname,a.search,j,G]),e.jsxs("div",{className:"v2-page",children:[e.jsxs(pe,{className:"v2-intro-card",children:[n?null:e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(Wr,{level:3,children:"Forecast Orders"}),e.jsx($r,{children:"FO ist ein Planobjekt je SKU (inkl. Plan-Meilensteinen). Zahlungen werden erst nach PO-Conversion im PO-Flow bestätigt."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(k,{type:"primary",onClick:()=>R(),children:"Create FO"}),L?e.jsx(ae,{color:"processing",children:"Speichern..."}):null,M?e.jsxs(ae,{color:"green",children:["Gespeichert: ",new Date(M).toLocaleTimeString("de-DE")]}):null]})})]}),N?e.jsx(xe,{type:"error",showIcon:!0,message:N}):null,P?e.jsx(xe,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(pe,{children:[e.jsxs("div",{className:"v2-toolbar-row",style:{marginBottom:10},children:[e.jsx(se,{placeholder:"Alias, SKU, Supplier",value:Fe,onChange:t=>tt(t.target.value),style:{width:280}}),e.jsx(Pe,{value:Me,onChange:t=>St(t),options:[{value:"ALL",label:"Alle Status"},...Ur.map(t=>({value:t,label:t}))],style:{width:190}}),e.jsx(k,{onClick:Se,disabled:re.length<2,children:"Create PO from FOs"}),e.jsxs(ae,{children:[re.length," ausgewählt"]})]}),e.jsx(Pr,{data:ze,columns:ue,minTableWidth:1400,tableLayout:"auto"})]}),e.jsxs(he,{title:H?"FO bearbeiten":"FO anlegen",open:Oe,width:1120,onCancel:()=>{z.clearDraft(),Xe(!1)},onOk:()=>{if(ie){if($t&&!z.readOnly){he.info({title:"Read-only FO",content:"Konvertierte oder archivierte FOs sind schreibgeschuetzt. Bitte ueber PO weiterarbeiten."});return}he.warning({title:"Nur Lesemodus",content:`${z.remoteUserLabel||"Kollege"} bearbeitet diesen FO. Bitte Bearbeitung übernehmen oder warten.`});return}B.validateFields().then(t=>U(t)).catch(()=>{})},children:[z.banner?e.jsx(xe,{style:{marginBottom:10},type:z.banner.tone,showIcon:!0,message:z.banner.text,action:z.readOnly?e.jsx(k,{size:"small",onClick:z.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,z.readOnly&&z.remoteDraftVersion>0?e.jsxs(ae,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",z.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,e.jsxs(T,{style:{width:"100%",marginBottom:10},wrap:!0,children:[e.jsx(O,{type:"secondary",children:"Status:"}),mr(it),Ce(it)?e.jsx(k,{size:"small",disabled:ie,onClick:()=>B.setFieldValue("status",Zr(it)),children:it==="ACTIVE"?"Als Draft markieren":"Als Active markieren"}):e.jsx(ae,{color:"default",children:"Read-only"}),Wt?e.jsx(k,{size:"small",onClick:()=>{const t=new URLSearchParams;t.set("source","fo_convert"),t.set("poNo",Wt),j(`/v2/orders/po?${t.toString()}`)},children:"Zugehoerige PO oeffnen"}):null]}),e.jsxs(D,{name:"v2-fo-modal",form:B,layout:"vertical",disabled:ie,onValuesChange:t=>{ie||z.publishDraftPatch(t)},children:[e.jsx(D.Item,{name:"id",hidden:!0,children:e.jsx(se,{})}),e.jsx(D.Item,{name:"status",hidden:!0,children:e.jsx(se,{})}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"sku",label:"Produkt (SKU)",style:{minWidth:230,flex:1},rules:[{required:!0,message:"SKU ist erforderlich."}],children:e.jsx(Pe,{showSearch:!0,optionFilterProp:"label",options:g.map(t=>({value:t.sku,label:`${t.alias} (${t.sku})`})),onChange:t=>{X(String(t||""))}})}),e.jsx(D.Item,{name:"supplierId",label:"Supplier",style:{minWidth:230,flex:1},rules:[{required:!0,message:"Supplier ist erforderlich."}],children:e.jsx(Pe,{disabled:!0,showSearch:!0,optionFilterProp:"label",options:Z.map(t=>({value:t.id,label:t.name}))})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"units",label:"Units",style:{width:130},rules:[{required:!0,message:"Units sind erforderlich."}],children:e.jsx(V,{mode:"int",min:0})}),e.jsx(D.Item,{name:"targetDeliveryDate",label:"Target Delivery",style:{width:190},rules:[{required:!0,message:"Zieltermin ist erforderlich."}],children:e.jsx(se,{type:"date"})}),e.jsx(D.Item,{name:"transportMode",label:"Transport",style:{width:140},children:e.jsx(Pe,{options:Cr.map(t=>({value:t,label:t}))})}),e.jsx(D.Item,{name:"incoterm",label:"Incoterm",style:{width:130},children:e.jsx(Pe,{options:Rr.map(t=>({value:t,label:t}))})}),e.jsx(D.Item,{name:"currency",label:"Currency",style:{width:130},children:e.jsx(Pe,{options:dr.map(t=>({value:t,label:t}))})}),e.jsx(D.Item,{name:"fxRate",label:"FX Rate",style:{width:140},children:e.jsx(V,{mode:"fx",min:0})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"unitPrice",label:"Unit Price",style:{width:160},children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{name:"freight",label:"Freight",style:{width:160},children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{name:"freightCurrency",label:"Freight Currency",style:{width:170},children:e.jsx(Pe,{options:dr.map(t=>({value:t,label:t}))})}),e.jsx(D.Item,{name:"dutyRatePct",label:"Duty %",style:{width:140},children:e.jsx(V,{mode:"percent",min:0,max:100})}),e.jsx(D.Item,{name:"eustRatePct",label:"EUSt %",style:{width:140},children:e.jsx(V,{mode:"percent",min:0,max:100})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"productionLeadTimeDays",label:"Production Lead Days",style:{width:220},children:e.jsx(V,{mode:"int",min:0})}),e.jsx(D.Item,{name:"logisticsLeadTimeDays",label:"Logistics Lead Days",style:{width:220},children:e.jsx(V,{mode:"int",min:0})}),e.jsx(D.Item,{name:"bufferDays",label:"Buffer Days",style:{width:180},children:e.jsx(V,{mode:"int",min:0})}),e.jsx(k,{disabled:ie,onClick:()=>{const t=B.getFieldsValue(),o=ce.get(String(t.supplierId||"")),h=Dt([],o||void 0);B.setFieldsValue({incoterm:String((o==null?void 0:o.incotermDefault)||t.incoterm||"EXW").toUpperCase(),currency:String((o==null?void 0:o.currencyDefault)||t.currency||te.defaultCurrency||"EUR").toUpperCase(),paymentTerms:h})},children:"Supplier Terms"})]}),e.jsx("div",{style:{marginTop:-2,marginBottom:10},children:e.jsxs(O,{type:"secondary",children:["Quelle Leadtime: Produktion = ",l.production," · Logistik = ",l.logistics]})}),Et.blocked?e.jsx(xe,{type:"error",showIcon:!0,style:{marginBottom:12},message:"Blockierende Stammdaten fehlen",description:Et.issues.map(t=>t.label).join(", ")}):null,e.jsx(pe,{size:"small",style:{marginBottom:12},children:e.jsxs(T,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsx(O,{strong:!0,children:"Stammdaten-Herkunft (FO)"}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Unit Price"}),e.jsx("span",{className:Re(ve.fields.unitPriceUsd.source,!0),children:ve.fields.unitPriceUsd.label}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("unitPrice"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("unitPriceUsd",s==null?void 0:s.unitPrice),children:"Als Produktwert uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Production Lead"}),e.jsx("span",{className:Re(ve.fields.productionLeadTimeDays.source,!0),children:ve.fields.productionLeadTimeDays.label}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("productionLeadTimeDays"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("productionLeadTimeDays",s==null?void 0:s.productionLeadTimeDays),children:"Als Produktwert uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Logistics Lead"}),e.jsx("span",{className:Re(ve.fields.transitDays.source,!1),children:ve.fields.transitDays.label}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("logisticsLeadTimeDays"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("transitDays",s==null?void 0:s.logisticsLeadTimeDays),children:"Als Produktwert uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Duty / EUSt"}),e.jsx("span",{className:Re(ve.fields.dutyRatePct.source,!1),children:ve.fields.dutyRatePct.label}),e.jsx("span",{className:Re(ve.fields.eustRatePct.source,!1),children:ve.fields.eustRatePct.label}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("dutyRatePct"),children:"Duty reset"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("eustRatePct"),children:"EUSt reset"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("dutyRatePct",s==null?void 0:s.dutyRatePct),children:"Duty uebernehmen"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("eustRatePct",s==null?void 0:s.eustRatePct),children:"EUSt uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Incoterm"}),e.jsx("span",{className:Re(ve.fields.incoterm.source,!0),children:ve.fields.incoterm.label}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>Qe("incoterm"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",disabled:ie,onClick:()=>r("ddp",String((s==null?void 0:s.incoterm)||"").toUpperCase()==="DDP"),children:"Als Produktwert uebernehmen"})]})]})}),e.jsx(pe,{size:"small",style:{marginBottom:12},children:e.jsxs(T,{direction:"vertical",size:4,children:[e.jsx(O,{strong:!0,children:"Schedule Preview"}),e.jsxs(O,{children:["Order Date: ",Te(i.orderDate)]}),e.jsxs(O,{children:["Production End: ",Te(i.productionEndDate)]}),e.jsxs(O,{children:["ETD: ",Te(i.etdDate)]}),e.jsxs(O,{children:["ETA: ",Te(i.etaDate)]}),e.jsxs(O,{children:["Landed Cost: ",Jt(u.landedCostEur)]})]})}),e.jsx(pe,{size:"small",style:{marginBottom:12},children:e.jsxs(T,{direction:"vertical",size:4,children:[e.jsx(O,{strong:!0,children:"FO Empfehlung"}),de.baselineMonth?null:e.jsx(O,{type:"secondary",children:"Kein Inventory Snapshot vorhanden."}),y?e.jsxs(e.Fragment,{children:[e.jsxs(O,{children:["Baseline: ",String(y.baselineMonth||"—")]}),e.jsxs(O,{children:["Status: ",String(y.status||"—")]}),e.jsx(O,{type:"secondary",children:"Empfehlung basiert auf Forecast + Coverage DOH + MOQ."}),e.jsxs(O,{children:["Reichweite-Bedarf (",me(y.coverageDaysForOrder,0)," Tage): ",me(y.coverageDemandUnits,0)]}),v.length?e.jsx("div",{className:"v2-fo-breakdown-wrap",children:e.jsxs("table",{className:"v2-fo-breakdown-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Tage im Fenster"}),e.jsx("th",{children:"Forecast Monat"}),e.jsx("th",{children:"Beitrags-Units"})]})}),e.jsxs("tbody",{children:[v.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.month}),e.jsx("td",{children:me(t.daysCovered,0)}),e.jsxs("td",{children:[t.forecastMonthUnits==null?"—":me(t.forecastMonthUnits,0),t.usedFallback?e.jsx("span",{className:"v2-fo-breakdown-flag",children:" (Fallback)"}):null]}),e.jsx("td",{children:me(t.demandUnitsInWindow,0)})]},`${t.month}-${t.daysCovered}`)),e.jsxs("tr",{className:"is-total",children:[e.jsx("td",{children:"Summe"}),e.jsx("td",{children:me(y.coverageDaysForOrder,0)}),e.jsx("td",{children:"—"}),e.jsx("td",{children:me(E,0)})]})]})]})}):null,e.jsxs(O,{children:["Rohwert (aufgerundet): ",me(y.recommendedUnitsRaw,0)]}),e.jsxs(O,{children:["Empfohlene Units: ",me(y.recommendedUnits,0)]}),y.moqApplied?e.jsxs(O,{type:"warning",children:["MOQ-Aufrundung: ",me(y.recommendedUnitsRaw,0)," → ",me(y.recommendedUnits,0)]}):null,e.jsxs(O,{children:["Arrival: ",Te(y.requiredArrivalDate)]}),e.jsxs(O,{children:["Order: ",Te(y.orderDateAdjusted||y.orderDate)]})]}):e.jsx(O,{type:"secondary",children:"Bitte SKU waehlen."})]})}),e.jsxs(pe,{size:"small",children:[e.jsxs(T,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(O,{strong:!0,children:"Supplier Payment Terms"}),e.jsxs(O,{type:Math.abs(S-100)<=.01?"secondary":"danger",children:["Summe: ",me(S,2),"%"]})]}),e.jsx(D.List,{name:"paymentTerms",children:(t,{add:o,remove:h})=>e.jsxs(T,{direction:"vertical",size:8,style:{width:"100%"},children:[t.map(c=>e.jsxs(T,{align:"start",style:{width:"100%"},wrap:!0,children:[e.jsx(D.Item,{...c,name:[c.name,"label"],style:{flex:2,minWidth:220},rules:[{required:!0,message:"Label fehlt."}],children:e.jsx(se,{placeholder:"Label"})}),e.jsx(D.Item,{...c,name:[c.name,"percent"],style:{width:100},rules:[{required:!0,message:"%"}],children:e.jsx(V,{mode:"percent",min:0,max:100})}),e.jsx(D.Item,{...c,name:[c.name,"triggerEvent"],style:{width:170},rules:[{required:!0,message:"Trigger fehlt."}],children:e.jsx(Pe,{options:Fr.map(x=>({value:x,label:x}))})}),e.jsx(D.Item,{...c,name:[c.name,"offsetDays"],style:{width:110},children:e.jsx(V,{mode:"int"})}),e.jsx(k,{danger:!0,disabled:ie,onClick:()=>h(c.name),children:"X"})]},c.key)),e.jsxs(T,{children:[e.jsx(k,{disabled:ie,onClick:()=>o({label:"Milestone",percent:0,triggerEvent:"ORDER_DATE",offsetDays:0,offsetMonths:0}),children:"Milestone"}),e.jsx(k,{disabled:ie,onClick:()=>{const c=String(B.getFieldValue("supplierId")||""),x=ce.get(c)||null;B.setFieldsValue({paymentTerms:Dt([],x||void 0)})},children:"Terms laden"})]})]})}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx(O,{strong:!0,children:"Zahlungsfaelligkeiten (Plan)"}),e.jsx(xe,{type:"info",showIcon:!0,style:{marginTop:8},message:"FOs erzeugen nur Plan-Meilensteine. Zahlungen werden ausschließlich in POs bestätigt."}),e.jsx("div",{className:"v2-stats-table-wrap",style:{marginTop:8},children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Typ"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Soll"}),e.jsx("th",{children:"Waehrung"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Regel"})]})}),e.jsx("tbody",{children:f.length?f.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:qr(t.category)}),e.jsx("td",{children:t.label}),e.jsx("td",{children:Jt(t.plannedEur)}),e.jsx("td",{children:t.currency}),e.jsx("td",{children:Te(t.dueDate)}),e.jsx("td",{children:`${t.triggerEvent} + ${me(t.offsetDays,0)}d + ${me(t.offsetMonths,0)}m`})]},t.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Keine Zahlungszeilen."})})})]})})]})]})]})]}),e.jsx(he,{title:"Einzel-FO in PO konvertieren",open:Pt,onCancel:()=>Ae(!1),onOk:()=>{w().catch(t=>{he.error({title:"Konvertierung fehlgeschlagen",content:t instanceof Error?t.message:String(t)})})},children:e.jsxs(T,{direction:"vertical",style:{width:"100%"},children:[e.jsx(O,{children:"PO Nummer"}),e.jsx(se,{value:Ft,onChange:t=>mt(t.target.value)}),e.jsx(O,{children:"Order Date (optional)"}),e.jsx(se,{type:"date",value:lt,onChange:t=>ht(t.target.value)})]})}),e.jsx(he,{title:"Mehrere FOs zu einer PO bündeln",open:Ot,width:960,onCancel:()=>ct(!1),onOk:()=>{q().catch(t=>{he.error({title:"Merge fehlgeschlagen",content:t instanceof Error?t.message:String(t)})})},children:e.jsxs(T,{direction:"vertical",style:{width:"100%"},size:12,children:[e.jsxs(O,{type:"secondary",children:[re.length," FO(s) ausgewählt. Ergebnis ist eine Multi-SKU-PO mit PO-basierten Zahlungsmeilensteinen."]}),e.jsxs(T,{align:"start",wrap:!0,style:{width:"100%"},children:[e.jsxs("div",{style:{minWidth:220,flex:1},children:[e.jsx(O,{children:"PO Nummer"}),e.jsx(se,{value:le,onChange:t=>be(t.target.value)})]}),e.jsxs("div",{style:{minWidth:220,flex:1},children:[e.jsx(O,{children:"Order Date (optional)"}),e.jsx(se,{type:"date",value:Ye,onChange:t=>pt(t.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(O,{strong:!0,children:"Ziel-Liefertermin der PO"}),e.jsxs(T,{direction:"vertical",style:{marginTop:6,width:"100%"},children:[e.jsxs(Ge,{checked:rt==="earliest",onChange:t=>W(t.target.checked?"earliest":"manual"),children:["Frühester FO-Zieltermin verwenden (",Te(Je||null),")"]}),e.jsx(Ge,{checked:rt==="manual",onChange:t=>W(t.target.checked?"manual":"earliest"),children:"Manuelles Ziel setzen"}),rt==="manual"?e.jsx(se,{type:"date",value:ke,onChange:t=>qe(t.target.value),style:{maxWidth:240}}):null]})]}),Be?e.jsx(xe,{type:"error",showIcon:!0,message:"FO-Merge nur bei gleichem Lieferanten erlaubt."}):null,zt?e.jsx(xe,{type:"warning",showIcon:!0,message:"Gemischte Incoterms/Transportmodi erkannt.",description:e.jsxs("div",{children:[e.jsxs("div",{children:["Incoterms: ",Lt.join(", ")||"—"]}),e.jsxs("div",{children:["Transport: ",At.join(", ")||"—"]}),e.jsx(Ge,{checked:kt,onChange:t=>st(t.target.checked),style:{marginTop:8},children:"Ich habe den Mix geprüft und möchte trotzdem bündeln."})]})}):null,e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"FO"}),e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Units"}),e.jsx("th",{children:"FO Ziel"}),e.jsx("th",{children:"Abweichung zur PO"})]})}),e.jsx("tbody",{children:re.length?re.map(t=>{const o=Qt(t),h=Bt.find(c=>c.id===String(t.id||""));return e.jsxs("tr",{children:[e.jsx("td",{children:String(t.id||"").slice(-6).toUpperCase()}),e.jsx("td",{children:String(t.sku||"—")}),e.jsx("td",{children:me(t.units,0)}),e.jsx("td",{children:Te(o)}),e.jsx("td",{children:h?h.status<0?e.jsx(ae,{color:"red",children:h.deviation}):h.status>0?e.jsx(ae,{color:"gold",children:h.deviation}):e.jsx(ae,{color:"green",children:h.deviation}):"—"})]},String(t.id||""))}):e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Keine FOs gewählt."})})})]})})]})})]})}const{Paragraph:Yr,Text:A,Title:Jr}=Rt,gr={slug:"po",entityLabel:"PO",numberField:"poNo"};function we(n){if(!n)return"—";const[a,j,p]=String(n).split("-").map(Number);if(!a||!j||!p)return"—";const P=new Date(Date.UTC(a,j-1,p));return Number.isNaN(P.getTime())?"—":P.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function wt(n,a=0){const j=Number(n);return Number.isFinite(j)?j.toLocaleString("de-DE",{minimumFractionDigits:a,maximumFractionDigits:a}):"—"}function at(n){const a=Number(n);return Number.isFinite(a)?a.toLocaleString("de-DE",{style:"currency",currency:"EUR"}):"—"}function Qr(n){return String(n||"").slice(-6).toUpperCase()}function Vr(n){return n==="paid_only"?e.jsx(ae,{color:"green",children:"Bezahlt"}):n==="mixed"?e.jsx(ae,{color:"gold",children:"Teilweise bezahlt"}):e.jsx(ae,{color:"blue",children:"Offen"})}function rr(n){return n.eventType==="duty"?"Custom Duties":n.eventType==="eust"?"Einfuhrumsatzsteuer":n.eventType==="freight"?"Shipping China -> 3PL":n.eventType==="fx_fee"?"FX Gebuehr":String(n.typeLabel||n.label||"").trim()||"Payment"}function es(){return[{value:"Alibaba Trade Assurance",label:"Alibaba Trade Assurance"},{value:"Wise Transfer",label:"Wise Transfer"},{value:"PayPal",label:"PayPal"},{value:"SEPA Bank Transfer",label:"SEPA Bank Transfer"},{value:"Kreditkarte",label:"Kreditkarte"}]}function ts(n){const a=new Set;return Object.entries(n.displayNameMap||{}).forEach(([j,p])=>{const P=String(p||j||"").trim();P&&a.add(P)}),n.syncEmail&&a.add(String(n.syncEmail).trim()),a.size?Array.from(a).sort((j,p)=>j.localeCompare(p,"de-DE",{sensitivity:"base"})).map(j=>({value:j,label:j})):[]}function Kt(n){const a=String(n||"").trim();return a.length>0&&tr(a)}function rs(n){const a=String(n.paidDate||"").trim()||"YYYY-MM-DD",j=String(n.poNo||"").trim()||"PO",p=String(n.alias||"").trim().replace(/\s+/g,"-").replace(/[\\/:*?"<>|]/g,"-")||"Alias",P=Number.isFinite(Number(n.units))?Math.max(0,Math.round(Number(n.units))):0,L=Array.from(new Set((n.selectedRows||[]).map(M=>rr(M)))).map(M=>M.replace(/\s+/g,"-").replace(/[\\/:*?"<>|]/g,"-")),N=L.length?L.join("+"):"Payment";return`${a}_PO-${j}_${p}_${P}u_${N}.pdf`.replace(/-+/g,"-")}function Vt(n){const a=Number(n);return Number.isFinite(a)?Math.round(a*100)/100:0}function ss(n){const a=n.settings||{};return{fxRate:Number(a.fxRate||0),fxFeePct:Number(a.fxFeePct||0),dutyRatePct:Number(a.dutyRatePct||0),dutyIncludeFreight:a.dutyIncludeFreight!==!1,eustRatePct:Number(a.eustRatePct||0),vatRefundEnabled:a.vatRefundEnabled!==!1,vatRefundLagMonths:Number(a.vatRefundLagMonths||0),freightLagDays:Number(a.freightLagDays||0),cny:a.cny||{start:"",end:""},cnyBlackoutByYear:a.cnyBlackoutByYear||{}}}function er(){return[{label:"Deposit",percent:30,anchor:"ORDER_DATE",lagDays:0},{label:"Balance",percent:70,anchor:"PROD_DONE",lagDays:0}]}function It(n){return Math.round((n||[]).reduce((a,j)=>a+Number(j.percent||0),0)*100)/100}function je(n){const a=Number(n);return Number.isFinite(a)?a:null}function ns(n){const a=n!=null&&n.template&&typeof n.template=="object"?n.template:{};return(a.fields&&typeof a.fields=="object"?a.fields:a)||{}}function bt(n){const a=n.product||{},j=n.settings||{},p=ns(a),P=vt({state:n.state||{},product:a,sku:String(a.sku||""),supplierId:n.supplierId||String(a.supplierId||""),orderContext:"po"}),L=String(p.transportMode||"SEA").toLowerCase(),N=j.transportLeadTimesDays||{},M=je(P.fields.transitDays.value)??je(p.transitDays)??je(N[L])??45,ye=je(P.fields.productionLeadTimeDays.value)??je(a.productionLeadTimeDaysDefault??p.productionDays)??je(n.supplierDefaultProdDays)??je(j.defaultProductionLeadTimeDays)??60,ne=je(P.fields.unitPriceUsd.value)??je(p.unitPriceUsd)??0,Fe=je(p.fxRate??j.fxRate)??0,tt=je(P.fields.logisticsPerUnitEur.value)??je(a.logisticsPerUnitEur??a.freightPerUnitEur??p.freightEur)??0,Me=Math.max(0,Math.round(tt*Math.max(0,Number(n.units||0))*100)/100);return{transport:L,prodDays:Math.max(0,Math.round(ye)),transitDays:Math.max(0,Math.round(M)),unitCostUsd:ne,unitExtraUsd:0,extraFlatUsd:0,freightEur:Me,dutyRatePct:je(P.fields.dutyRatePct.value)??je(a.dutyRatePct??p.dutyPct??j.dutyRatePct)??0,eustRatePct:je(P.fields.eustRatePct.value)??je(a.eustRatePct??p.vatImportPct??j.eustRatePct)??0,fxOverride:Fe,ddp:P.fields.ddp.value===!0||p.ddp===!0}}function Ie(n,a=""){return{id:String(n.id||fe("poi")),sku:String(n.sku||a||"").trim(),units:Math.max(0,Math.round(Number(n.units||0))),unitCostUsd:Number(n.unitCostUsd||0),unitExtraUsd:Number(n.unitExtraUsd||0),extraFlatUsd:Number(n.extraFlatUsd||0),prodDays:Math.max(0,Math.round(Number(n.prodDays||0))),transitDays:Math.max(0,Math.round(Number(n.transitDays||0))),freightEur:Math.max(0,Number(n.freightEur||0))}}function is(n){const a=n!=null&&n.paymentLog&&typeof n.paymentLog=="object"?n.paymentLog:{};return Object.values(a).filter(j=>String((j==null?void 0:j.status)||"")==="paid").length}function Dr(n,a){const j=Zt({items:n==null?void 0:n.items,orderDate:n==null?void 0:n.orderDate,fxRate:(n==null?void 0:n.fxOverride)??a.fxRate,fallback:n});return{goodsUsd:Vt(j.goodsUsd),goodsEur:Vt(j.goodsEur),freightEur:Vt(j.freightEur),units:Math.round(j.units),prodDays:Math.round(j.prodDays),transitDays:Math.round(j.transitDays)}}function jr(n,a){const j=xt(),p=He(n.items,a).map(M=>({id:String(M.id||fe("poi")),sku:String(M.sku||"").trim(),units:Math.max(0,Math.round(Number(M.units||0))),unitCostUsd:Number(M.unitCostUsd||0),unitExtraUsd:Number(M.unitExtraUsd||0),extraFlatUsd:Number(M.extraFlatUsd||0),prodDays:Math.max(0,Math.round(Number(M.prodDays||0))),transitDays:Math.max(0,Math.round(Number(M.transitDays||0))),freightEur:Math.max(0,Number(M.freightEur||0))})),P=Zt({items:p,orderDate:n.orderDate,fxRate:n.fxOverride,fallback:a}),L=p[0]||null,N=(n.milestones||[]).map(M=>({id:String(M.id||fe("ms")),label:String(M.label||"Milestone"),percent:Number(M.percent||0),anchor:String(M.anchor||"ORDER_DATE"),lagDays:Number(M.lagDays||0)}));return{...a||{},id:String(n.id||(a==null?void 0:a.id)||fe("po")),poNo:String(n.poNo||"").trim(),sku:String((L==null?void 0:L.sku)||(a==null?void 0:a.sku)||"").trim(),supplierId:String(n.supplierId||"").trim(),orderDate:n.orderDate||null,etdManual:n.etdManual||null,etaManual:n.etaManual||null,units:Math.max(0,Math.round(P.units||0)),unitCostUsd:Number((L==null?void 0:L.unitCostUsd)||0),unitExtraUsd:Number((L==null?void 0:L.unitExtraUsd)||0),extraFlatUsd:Number((L==null?void 0:L.extraFlatUsd)||0),prodDays:Number(P.prodDays||0),transitDays:Number(P.transitDays||0),transport:String(n.transport||"sea").toLowerCase(),freightEur:Number(P.freightEur||0),freightMode:"total",freightPerUnitEur:0,dutyRatePct:Number(n.dutyRatePct||0),dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:Number(n.eustRatePct||0),fxOverride:Number(n.fxOverride||0),ddp:n.ddp===!0,items:p,milestones:N,archived:n.archived===!0,createdAt:(a==null?void 0:a.createdAt)||j,updatedAt:j,paymentLog:(a==null?void 0:a.paymentLog)||{},autoEvents:(a==null?void 0:a.autoEvents)||void 0}}function as({embedded:n=!1}={}){const a=sr(),j=nr(),{state:p,loading:P,saving:L,error:N,lastSavedAt:M,saveWith:ye}=ir(),ne=xr(),[Fe,tt]=m.useState(""),[Me,St]=m.useState(!1),[Oe,Xe]=m.useState(!1),[H,ot]=m.useState(null),[Pt,Ae]=m.useState([]),[ee]=D.useForm(),[Ze]=D.useForm(),[Ft,mt]=m.useState(!1),[lt,ht]=m.useState(null),[dt,Ue]=m.useState(null),[Ot,ct]=m.useState([]),le=p,be=p.settings||{},Ye=m.useMemo(()=>vr(be),[be]),pt=m.useMemo(()=>Sr({userId:ne.userId,userEmail:ne.email},Ye),[Ye,ne.email,ne.userId]),rt=m.useMemo(()=>`po:edit:${String(H||"new")}`,[H]),W=Nr({workspaceId:ne.workspaceId,modalScope:rt,isOpen:Oe,userId:ne.userId,userEmail:ne.email,userDisplayName:pt,displayNames:Ye}),ke=m.useMemo(()=>ss(le),[p.settings]),qe=m.useMemo(()=>(Array.isArray(p.suppliers)?p.suppliers:[]).map(r=>r).map(r=>({id:String(r.id||""),name:String(r.name||"—"),productionLeadTimeDaysDefault:Number(r.productionLeadTimeDaysDefault||0),paymentTermsDefault:Array.isArray(r.paymentTermsDefault)?r.paymentTermsDefault:[],raw:r})).filter(r=>r.id),[p.suppliers]),kt=m.useMemo(()=>new Map(qe.map(r=>[r.id,r.name])),[qe]),st=m.useMemo(()=>new Map(qe.map(r=>[r.id,r])),[qe]),B=m.useMemo(()=>(Array.isArray(p.products)?p.products:[]).map(r=>r).map(r=>({sku:String(r.sku||""),alias:String(r.alias||r.sku||""),supplierId:String(r.supplierId||""),raw:r})).filter(r=>r.sku),[p.products]),K=m.useMemo(()=>new Map(B.map(r=>[r.sku,r])),[B]),te=m.useMemo(()=>{const r=Array.isArray(p.payments)?p.payments:[];return(Array.isArray(p.pos)?p.pos:[]).map(l=>{var U;const i=l,u=Zt({items:i.items,orderDate:i.orderDate,fxRate:i.fxOverride??ke.fxRate,fallback:i}),y=String(u.firstSku||i.sku||""),v=Ut({orderDate:i.orderDate,productionLeadTimeDays:u.prodDays||i.prodDays,logisticsLeadTimeDays:u.transitDays||i.transitDays,bufferDays:0}),E=String(i.etdManual||v.etdDate||""),f=String(i.etaManual||v.etaDate||""),S=Number(u.goodsEur||0),F=u.items.length,X=(()=>{try{const w=structuredClone(i);return ur(w,gr,ke,r)}catch{return[]}})(),R=X.filter(w=>w.status==="paid").reduce((w,q)=>w+Number(q.plannedEur||0),0),Y=X.filter(w=>w.status!=="paid").reduce((w,q)=>w+Number(q.plannedEur||0),0),Se=Y<=0&&R>0?"paid_only":Y>0&&R>0?"mixed":"open";return{id:String(i.id||""),poNo:String(i.poNo||""),sku:y,alias:((U=K.get(y))==null?void 0:U.alias)||y||"—",skuCount:F,supplierName:kt.get(String(i.supplierId||""))||"—",orderDate:i.orderDate?String(i.orderDate):null,etdDate:E||null,etaDate:f||null,goodsEur:S,openEur:Y,paidEur:R,statusText:Se,raw:i}}).filter(l=>{if(!Me&&l.raw.archived)return!1;const i=Fe.trim().toLowerCase();if(!i)return!0;const u=Array.isArray(l.raw.items)?l.raw.items.map(y=>String((y==null?void 0:y.sku)||"")).join(" "):"";return[l.poNo,l.sku,l.alias,l.supplierName,u].join(" ").toLowerCase().includes(i)}).sort((l,i)=>String(l.poNo||"").localeCompare(String(i.poNo||"")))},[Me,ke,K,Fe,p.payments,p.pos,kt]),Nt=m.useMemo(()=>[{header:"PO",accessorKey:"poNo",meta:{width:98}},{header:"Produkt",meta:{width:260},cell:({row:r})=>e.jsxs(T,{direction:"vertical",size:0,children:[e.jsxs(T,{size:6,children:[e.jsx(A,{children:r.original.skuCount>1?`${r.original.skuCount} SKUs`:r.original.alias}),r.original.skuCount>1?e.jsx(ae,{className:"v2-po-sku-count-tag",children:"Multi-SKU"}):null]}),e.jsx(A,{type:"secondary",children:r.original.skuCount>1?`Start-SKU: ${r.original.sku}`:r.original.sku})]})},{header:"Supplier",accessorKey:"supplierName",meta:{width:150}},{header:"Order",meta:{width:112},cell:({row:r})=>we(r.original.orderDate)},{header:"ETD / ETA",meta:{width:162},cell:({row:r})=>e.jsxs(T,{direction:"vertical",size:0,children:[e.jsxs(A,{children:["ETD ",we(r.original.etdDate)]}),e.jsxs(A,{type:"secondary",children:["ETA ",we(r.original.etaDate)]})]})},{header:"Warenwert",meta:{width:130,align:"right"},cell:({row:r})=>at(r.original.goodsEur)},{header:"Open / Paid",meta:{width:160,align:"right"},cell:({row:r})=>e.jsxs(T,{direction:"vertical",size:0,children:[e.jsxs(A,{children:["Open: ",at(r.original.openEur)]}),e.jsxs(A,{type:"secondary",children:["Paid: ",at(r.original.paidEur)]})]})},{header:"Status",meta:{width:110},cell:({row:r})=>Vr(r.original.statusText)},{header:"Aktionen",meta:{width:190,minWidth:190},cell:({row:r})=>e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(k,{size:"small",onClick:()=>ve(r.original.raw),children:"Bearbeiten"}),e.jsx(k,{size:"small",danger:!0,onClick:()=>{he.confirm({title:"PO loeschen?",onOk:async()=>{await ye(l=>{const i=Ve(l);return i.pos=(Array.isArray(i.pos)?i.pos:[]).filter(u=>String(u.id||"")!==r.original.id),i},"v2:po:delete")}})},children:"Loeschen"})]})}],[ye]),d=D.useWatch([],ee),Le=D.useWatch("supplierId",ee),z=m.useMemo(()=>He(d==null?void 0:d.items,null).map(r=>Ie(r)),[d==null?void 0:d.items]),Z=m.useMemo(()=>{var l;if(!d)return null;const r=H&&((l=te.find(i=>i.id===H))==null?void 0:l.raw)||null;return jr({...d,items:z},r)},[z,d,H,te]),ce=m.useMemo(()=>Zt({items:z,orderDate:d==null?void 0:d.orderDate,fxRate:(d==null?void 0:d.fxOverride)??ke.fxRate,fallback:Z}),[z,Z,d==null?void 0:d.fxOverride,d==null?void 0:d.orderDate,ke.fxRate]),g=z[0]||null,G=m.useMemo(()=>{var r;return g!=null&&g.sku&&((r=K.get(g.sku))==null?void 0:r.raw)||null},[g==null?void 0:g.sku,K]),de=m.useMemo(()=>vt({state:le,product:G||void 0,sku:String((g==null?void 0:g.sku)||""),supplierId:String((d==null?void 0:d.supplierId)||(G==null?void 0:G.supplierId)||""),orderContext:"po",orderOverrides:{unitCostUsd:g==null?void 0:g.unitCostUsd,prodDays:g==null?void 0:g.prodDays,transitDays:g==null?void 0:g.transitDays,dutyRatePct:d==null?void 0:d.dutyRatePct,eustRatePct:d==null?void 0:d.eustRatePct,ddp:d==null?void 0:d.ddp,incoterm:d!=null&&d.ddp?"DDP":"EXW"}}),[d==null?void 0:d.ddp,d==null?void 0:d.dutyRatePct,d==null?void 0:d.eustRatePct,d==null?void 0:d.supplierId,g==null?void 0:g.prodDays,g==null?void 0:g.sku,g==null?void 0:g.transitDays,g==null?void 0:g.unitCostUsd,G,le]),ze=m.useMemo(()=>vt({state:le,product:G||void 0,sku:String((g==null?void 0:g.sku)||""),supplierId:String((d==null?void 0:d.supplierId)||(G==null?void 0:G.supplierId)||""),orderContext:"po"}),[d==null?void 0:d.supplierId,g==null?void 0:g.sku,G,le]),ut=m.useMemo(()=>Mt({product:G,state:le,supplierId:String((d==null?void 0:d.supplierId)||(G==null?void 0:G.supplierId)||""),orderContext:"po",orderOverrides:{unitCostUsd:g==null?void 0:g.unitCostUsd,prodDays:g==null?void 0:g.prodDays,transitDays:g==null?void 0:g.transitDays,dutyRatePct:d==null?void 0:d.dutyRatePct,eustRatePct:d==null?void 0:d.eustRatePct,ddp:d==null?void 0:d.ddp,incoterm:d!=null&&d.ddp?"DDP":"EXW"}}),[d==null?void 0:d.ddp,d==null?void 0:d.dutyRatePct,d==null?void 0:d.eustRatePct,d==null?void 0:d.supplierId,g==null?void 0:g.prodDays,g==null?void 0:g.transitDays,g==null?void 0:g.unitCostUsd,G,le]);function re(r){if(!g)return;const l=He(ee.getFieldValue("items"),null).map(u=>Ie(u)),i=l.findIndex(u=>u.id===g.id);if(r==="unitCostUsd"&&i>=0){l[i]={...l[i],unitCostUsd:Number(ze.fields.unitPriceUsd.value||0)},ee.setFieldValue("items",l);return}if(r==="prodDays"&&i>=0){l[i]={...l[i],prodDays:Math.round(Number(ze.fields.productionLeadTimeDays.value||0))},ee.setFieldValue("items",l);return}if(r==="transitDays"&&i>=0){l[i]={...l[i],transitDays:Math.round(Number(ze.fields.transitDays.value||0))},ee.setFieldValue("items",l);return}if(r==="dutyRatePct"){ee.setFieldValue("dutyRatePct",Number(ze.fields.dutyRatePct.value||0));return}if(r==="eustRatePct"){ee.setFieldValue("eustRatePct",Number(ze.fields.eustRatePct.value||0));return}ee.setFieldValue("ddp",ze.fields.ddp.value===!0)}function Je(r,l){const i=String((g==null?void 0:g.sku)||"").trim();i&&he.confirm({title:"Als neuen Produkt-Stammdatenwert uebernehmen?",content:`SKU ${i}: Wert wird in den Produktstammdaten gespeichert.`,okText:"Uebernehmen",cancelText:"Abbrechen",onOk:()=>{he.confirm({title:"Bist du sicher?",content:"Diese Aenderung beeinflusst zukuenftige FO/PO Prefills.",okText:"Ja, speichern",cancelText:"Nein",onOk:async()=>{await ye(u=>{const y=Ve(u),v=Array.isArray(y.products)?[...y.products]:[],E=v.findIndex(S=>String(S.sku||"").trim().toLowerCase()===i.toLowerCase());if(E<0)return y;const f=v[E];return v[E]={...kr({product:f,field:r,value:l}),updatedAt:xt()},y.products=v,y},"v2:po:adopt-masterdata"),et.success("Produkt-Stammdaten aktualisiert.")}})}})}const nt=m.useMemo(()=>{const r=String(Le||"");if(!r)return[];const l=new Set(z.map(i=>i.sku));return B.filter(i=>i.supplierId===r).map(i=>({value:i.sku,label:`${i.alias} (${i.sku})`,disabled:l.has(i.sku)}))},[z,B,Le]),qt=m.useMemo(()=>{const r=[];return z.forEach(l=>{const i=[];l.units<=0&&i.push("Units <= 0"),l.unitCostUsd<=0&&i.push("Unit Cost fehlt"),l.prodDays<=0&&i.push("Prod Days fehlen"),l.transitDays<=0&&i.push("Transit Days fehlen"),i.length&&r.push(`${l.sku||"SKU?"}: ${i.join(", ")}`)}),r},[z]),Be=m.useMemo(()=>{if(!Z)return[];try{const r=structuredClone(Z);return ur(r,gr,ke,Array.isArray(p.payments)?p.payments:[]).map(i=>({id:String(i.id||""),typeLabel:String(i.typeLabel||""),label:String(i.label||""),dueDate:i.dueDate?String(i.dueDate):null,plannedEur:Number(i.plannedEur||0),status:i.status==="paid"?"paid":"open",paidDate:i.paidDate?String(i.paidDate):null,paidEurActual:Number.isFinite(Number(i.paidEurActual))?Number(i.paidEurActual):null,paymentId:i.paymentId?String(i.paymentId):null,method:i.method?String(i.method):null,paidBy:i.paidBy?String(i.paidBy):null,note:String(i.note||""),invoiceDriveUrl:String(i.invoiceDriveUrl||""),invoiceFolderDriveUrl:String(i.invoiceFolderDriveUrl||""),eventType:i.eventType?String(i.eventType):null}))}catch{return[]}},[Z,ke,p.payments]),At=m.useMemo(()=>{const r=new Map;return(Array.isArray(p.payments)?p.payments:[]).forEach(l=>{const i=l,u=String(i.id||"").trim();u&&r.set(u,i)}),r},[p.payments]),Lt=m.useMemo(()=>ts({displayNameMap:Ye,syncEmail:ne.email}),[Ye,ne.email]),zt=m.useMemo(()=>es(),[]),Bt=D.useWatch("selectedEventIds",Ze),ue=D.useWatch([],Ze),s=m.useMemo(()=>{const r=new Set((Bt||[]).map(l=>String(l||"")));return Be.filter(l=>r.has(l.id))},[Be,Bt]),ge=m.useMemo(()=>{var y,v;if(!Z||!ue)return"";const r=He(Z.items,Z),l=String(((y=r[0])==null?void 0:y.sku)||Z.sku||""),i=r.length,u=i>1?`Multi-SKU-${i}`:((v=K.get(l))==null?void 0:v.alias)||l||"Alias";return rs({paidDate:ue.paidDate,poNo:String(Z.poNo||""),alias:u,units:Number(Z.units||0),selectedRows:s})},[Z,ue,s,K]);m.useEffect(()=>{!Oe||!W.readOnly||!W.remoteDraftPatch||ee.setFieldsValue(W.remoteDraftPatch)},[ee,W.readOnly,W.remoteDraftPatch,W.remoteDraftVersion,Oe]);function it(r,l){var U,w,q,Ne;const i=String((l==null?void 0:l.sku)||"").trim(),u=Math.max(0,Math.round(Number((l==null?void 0:l.units)||0))),y=i?String(((U=K.get(i))==null?void 0:U.supplierId)||""):"",v=String((l==null?void 0:l.supplierId)||(r==null?void 0:r.supplierId)||y||((w=qe[0])==null?void 0:w.id)||""),E=st.get(v)||null,f=He(r==null?void 0:r.items,r).map(t=>Ie(t)),S=He(l==null?void 0:l.items,null).map(t=>Ie(t));let F=S.length?S:f;if(!F.length&&i){const t=K.get(i)||null,o=bt({state:le,product:(t==null?void 0:t.raw)||null,settings:be,supplierId:v,supplierDefaultProdDays:E==null?void 0:E.productionLeadTimeDaysDefault,units:u});F=[Ie({id:fe("poi"),sku:i,units:u,unitCostUsd:o.unitCostUsd,unitExtraUsd:o.unitExtraUsd,extraFlatUsd:o.extraFlatUsd,prodDays:o.prodDays,transitDays:o.transitDays,freightEur:o.freightEur})]}if(!F.length&&(r!=null&&r.sku)){const t=String(r.sku||"").trim(),o=Math.max(0,Math.round(Number(r.units||0))),h=K.get(t)||null,c=bt({state:le,product:(h==null?void 0:h.raw)||null,settings:be,supplierId:v,supplierDefaultProdDays:E==null?void 0:E.productionLeadTimeDaysDefault,units:o});F=[Ie({id:fe("poi"),sku:t,units:o,unitCostUsd:Number(r.unitCostUsd??c.unitCostUsd??0),unitExtraUsd:Number(r.unitExtraUsd??c.unitExtraUsd??0),extraFlatUsd:Number(r.extraFlatUsd??c.extraFlatUsd??0),prodDays:Number(r.prodDays??c.prodDays??0),transitDays:Number(r.transitDays??c.transitDays??0),freightEur:Number(r.freightEur??c.freightEur??0)})]}const X=F.filter(t=>{var o;return v?String(((o=K.get(t.sku))==null?void 0:o.supplierId)||"")===v:!0}),R=K.get(String(((q=X[0])==null?void 0:q.sku)||i||(r==null?void 0:r.sku)||""))||null,Y=bt({state:le,product:(R==null?void 0:R.raw)||null,settings:be,supplierId:v,supplierDefaultProdDays:E==null?void 0:E.productionLeadTimeDaysDefault,units:((Ne=X[0])==null?void 0:Ne.units)||u}),Se=cr((E==null?void 0:E.raw)||null).map(t=>({id:t.id,label:t.label,percent:t.percent,anchor:t.anchor,lagDays:t.lagDays}));return{id:r!=null&&r.id?String(r.id):void 0,poNo:String((r==null?void 0:r.poNo)||""),supplierId:v,orderDate:String((l==null?void 0:l.orderDate)||(r==null?void 0:r.orderDate)||new Date().toISOString().slice(0,10)),etdManual:String((l==null?void 0:l.etdManual)||(r==null?void 0:r.etdManual)||""),etaManual:String((l==null?void 0:l.etaManual)||(r==null?void 0:r.etaManual)||""),transport:String((r==null?void 0:r.transport)||Y.transport||"sea").toLowerCase(),dutyRatePct:Number((r==null?void 0:r.dutyRatePct)??Y.dutyRatePct??be.dutyRatePct??0),dutyIncludeFreight:(r==null?void 0:r.dutyIncludeFreight)!==!1,eustRatePct:Number((r==null?void 0:r.eustRatePct)??Y.eustRatePct??be.eustRatePct??0),fxOverride:Number((r==null?void 0:r.fxOverride)??Y.fxOverride??be.fxRate??0),ddp:(r==null?void 0:r.ddp)===!0?!0:!!Y.ddp,archived:(r==null?void 0:r.archived)===!0,milestones:Array.isArray(r==null?void 0:r.milestones)?(r==null?void 0:r.milestones).map(t=>({id:String(t.id||fe("ms")),label:String(t.label||"Milestone"),percent:Number(t.percent||0),anchor:String(t.anchor||"ORDER_DATE"),lagDays:Number(t.lagDays||0)})):Se.length?Se:er(),items:X}}function $t(r,l){var F;const i=String(l||"").trim();if(!i)return;const u=K.get(i)||null;if(!u)return;const y=ee.getFieldsValue(),v=He(y.items,null).map(X=>Ie(X));if(r<0||r>=v.length)return;const E=String(y.supplierId||u.supplierId||""),f=st.get(E)||null,S=bt({state:le,product:u.raw,settings:be,supplierId:E,supplierDefaultProdDays:f==null?void 0:f.productionLeadTimeDaysDefault,units:Number(((F=v[r])==null?void 0:F.units)||0)});v[r]=Ie({...v[r],sku:i,unitCostUsd:S.unitCostUsd,unitExtraUsd:S.unitExtraUsd,extraFlatUsd:S.extraFlatUsd,prodDays:S.prodDays,transitDays:S.transitDays,freightEur:S.freightEur}),ee.setFieldsValue({items:v,supplierId:E||y.supplierId,transport:y.transport||S.transport,dutyRatePct:Number(y.dutyRatePct||S.dutyRatePct||0),eustRatePct:Number(y.eustRatePct||S.eustRatePct||0),fxOverride:Number(y.fxOverride||S.fxOverride||0),ddp:y.ddp===!0?!0:S.ddp})}function ie(r){var f;const l=ee.getFieldsValue(),i=He(l.items,null).map(S=>Ie(S)),u=new Set(i.map(S=>S.sku)),y=String(l.supplierId||""),v=st.get(y)||null,E=[];r.forEach(S=>{const F=String(S||"").trim();if(!F||u.has(F))return;const X=K.get(F);if(!X||String(X.supplierId||"")!==y)return;const R=bt({state:le,product:X.raw,settings:be,supplierId:y,supplierDefaultProdDays:v==null?void 0:v.productionLeadTimeDaysDefault,units:0});E.push(Ie({id:fe("poi"),sku:F,units:0,unitCostUsd:R.unitCostUsd,unitExtraUsd:R.unitExtraUsd,extraFlatUsd:R.extraFlatUsd,prodDays:R.prodDays,transitDays:R.transitDays,freightEur:R.freightEur}))}),E.length&&(ee.setFieldsValue({items:[...i,...E],transport:l.transport||bt({state:le,product:((f=K.get(E[0].sku))==null?void 0:f.raw)||null,settings:be,supplierId:y,supplierDefaultProdDays:v==null?void 0:v.productionLeadTimeDaysDefault,units:E[0].units}).transport}),Ae([]))}function Wt(r){const l=String(r||""),i=ee.getFieldsValue(),u=He(i.items,null).map(S=>Ie(S)),y=u.filter(S=>{var F;return String(((F=K.get(S.sku))==null?void 0:F.supplierId)||"")===l});u.length!==y.length&&et.info(`${u.length-y.length} SKU(s) wurden entfernt, da sie nicht zum Lieferanten passen.`);const v=st.get(l)||null,E=cr((v==null?void 0:v.raw)||null).map(S=>({id:S.id,label:S.label,percent:S.percent,anchor:S.anchor,lagDays:S.lagDays})),f=!H&&(!Array.isArray(i.milestones)||It(i.milestones)===It(er()));ee.setFieldsValue({supplierId:l,items:y,milestones:f?E.length?E:er():i.milestones}),Ae([])}function oe(r){ot(null);const l=it(null,r);ee.setFieldsValue({...l,...r||{}}),Ae([]),Xe(!0)}function ve(r){ot(String(r.id||"")),ee.setFieldsValue(it(r)),Ae([]),Xe(!0)}function $e(r){if(!H){et.info("Bitte PO zuerst speichern, danach koennen Zahlungen verbucht werden.");return}const l=new Date().toISOString().slice(0,10),i=r||null,u=(i==null?void 0:i.paymentId)||null,y=u?Be.filter(F=>F.paymentId===u):i?[i]:Be.filter(F=>F.status!=="paid"),v=y.map(F=>F.id),E=y.reduce((F,X)=>F+Number(X.plannedEur||0),0),f=u&&At.get(u)||null,S=String((f==null?void 0:f.id)||u||Yt(fe("pay"))||fe("pay"));Ze.setFieldsValue({selectedEventIds:v,paidDate:String((f==null?void 0:f.paidDate)||(i==null?void 0:i.paidDate)||l),method:String((f==null?void 0:f.method)||(i==null?void 0:i.method)||"Alibaba Trade Assurance"),paidBy:String((f==null?void 0:f.payer)||(i==null?void 0:i.paidBy)||pt||ne.email||""),amountActualEur:Number.isFinite(Number(f==null?void 0:f.amountActualEurTotal))?Number(f==null?void 0:f.amountActualEurTotal):Math.round(E*100)/100,amountActualUsd:Number.isFinite(Number(f==null?void 0:f.amountActualUsdTotal))?Number(f==null?void 0:f.amountActualUsdTotal):null,paymentId:S,invoiceDriveUrl:String((f==null?void 0:f.invoiceDriveUrl)||(i==null?void 0:i.invoiceDriveUrl)||""),invoiceFolderDriveUrl:String((f==null?void 0:f.invoiceFolderDriveUrl)||(i==null?void 0:i.invoiceFolderDriveUrl)||""),note:String((f==null?void 0:f.note)||(i==null?void 0:i.note)||"")}),ct(v),ht(f!=null&&f.id?String(f.id):null),Ue(null),mt(!0)}async function Et(r){if(W.readOnly)throw new Error("Nur Lesemodus: keine Zahlungen speichern.");if(!H)throw new Error("PO muss zuerst gespeichert werden.");const l=Array.from(new Set((r.selectedEventIds||[]).map(R=>String(R||"").trim()).filter(Boolean)));if(!l.length)throw new Error("Bitte mindestens einen Zahlungsbaustein auswaehlen.");if(!r.paidDate)throw new Error("Bitte ein Zahlungsdatum setzen.");if(!r.method.trim())throw new Error("Bitte eine Zahlungsmethode waehlen.");if(!r.paidBy.trim())throw new Error("Bitte angeben, wer gezahlt hat.");const i=Number(r.amountActualEur);if(!Number.isFinite(i)||i<0)throw new Error("Bitte einen gueltigen Ist-Betrag in EUR eingeben.");if(r.invoiceDriveUrl&&!tr(r.invoiceDriveUrl))throw new Error("Invoice-Link muss mit http:// oder https:// beginnen.");if(r.invoiceFolderDriveUrl&&!tr(r.invoiceFolderDriveUrl))throw new Error("Folder-Link muss mit http:// oder https:// beginnen.");const u=String(Yt(r.paymentId)||Yt(fe("pay"))||fe("pay")),y=Be.filter(R=>l.includes(R.id)),v=Br(i,y.map(R=>({id:R.id,plannedEur:R.plannedEur})));if(!v||!v.length)throw new Error("Konnte die Zahlung nicht auf die gewaehlten Bausteine verteilen.");const E=Number(r.amountActualUsd),f=Number.isFinite(E)?E:null,S=y.reduce((R,Y)=>R+Number(Y.plannedEur||0),0),F=f!=null&&S>0?y.map(R=>{const Y=Number(R.plannedEur||0)/S;return{eventId:R.id,actual:Math.round(f*Y*100)/100}}):[],X=new Map(F.map(R=>[R.eventId,R.actual]));await ye(R=>{var x,I,J;const Y=Ve(R),Se=Array.isArray(Y.pos)?[...Y.pos]:[],U=Se.findIndex(b=>String(b.id||"")===H);if(U<0)throw new Error("PO nicht gefunden.");const w={...Se[U]},q=w.paymentLog&&typeof w.paymentLog=="object"?{...w.paymentLog}:{},Ne=lt?String(lt):null;Ot.forEach(b=>{if(l.includes(b))return;const C=q[b]&&typeof q[b]=="object"?{...q[b]}:{};q[b]={...C,status:"open",paidDate:null,paymentId:null,amountActualEur:null,amountActualUsd:null,method:null,payer:null,note:null}}),v.forEach(b=>{var Q;const C=q[b.eventId]&&typeof q[b.eventId]=="object"?{...q[b.eventId]}:{};q[b.eventId]={...C,paymentInternalId:String(C.paymentInternalId||fe("payrow")),status:"paid",paidDate:r.paidDate,paymentId:u,amountActualEur:Number(b.actual||0),amountActualUsd:X.get(b.eventId)??null,method:r.method.trim(),payer:r.paidBy.trim(),note:((Q=r.note)==null?void 0:Q.trim())||null}}),w.paymentLog=q,w.updatedAt=xt(),Se[U]=w,Y.pos=Se;const t=Array.isArray(Y.payments)?[...Y.payments]:[],o=t.findIndex(b=>String(b.id||"")===u);if(o>=0&&(!Ne||String(t[o].id||"")!==Ne)){const b=new Set(t[o].coveredEventIds||[]);if(!l.some(Q=>b.has(Q))&&u!==Ne)throw new Error(`Payment-ID ${u} ist bereits vergeben.`)}const h={id:u,paidDate:r.paidDate,method:r.method.trim(),payer:r.paidBy.trim(),currency:"EUR",amountActualEurTotal:i,amountActualUsdTotal:f,coveredEventIds:l,note:((x=r.note)==null?void 0:x.trim())||null,invoiceDriveUrl:((I=r.invoiceDriveUrl)==null?void 0:I.trim())||"",invoiceFolderDriveUrl:((J=r.invoiceFolderDriveUrl)==null?void 0:J.trim())||""},c=t.findIndex(b=>String(b.id||"")===u);return c>=0?t[c]={...t[c],...h}:t.push(h),Y.payments=t,Y},"v2:po:payment-booking"),mt(!1),ht(null),ct([]),Ue(null),Ze.resetFields(),et.success("Zahlung wurde gespeichert.")}async function Qe(r,l=!1){var Y,Se;if(W.readOnly)throw new Error("Diese PO wird gerade von einem anderen Nutzer bearbeitet.");if(!r.poNo.trim())throw new Error("PO Nummer ist erforderlich.");const i=He(r.items,null).map(U=>Ie(U));if(!i.length)throw new Error("Bitte mindestens eine SKU in der PO erfassen.");const u=String(r.supplierId||"").trim();if(!u)throw new Error("Bitte einen Lieferanten auswaehlen.");const y=i.find(U=>{var w;return String(((w=K.get(U.sku))==null?void 0:w.supplierId)||"")!==u});if(y)throw new Error(`SKU ${y.sku} gehoert nicht zum gewaehlten Lieferanten.`);const v=i.find(U=>U.units<=0||U.unitCostUsd<=0||U.prodDays<=0||U.transitDays<=0);if(v)throw new Error(`SKU ${v.sku} ist unvollstaendig. Bitte Units, Unit Cost, Prod Days und Transit Days pflegen.`);const E=i.find(U=>{var Ne;const w=((Ne=K.get(U.sku))==null?void 0:Ne.raw)||null;return w?Mt({product:w,state:le,supplierId:u,orderContext:"po",orderOverrides:{unitCostUsd:U.unitCostUsd,prodDays:U.prodDays,transitDays:U.transitDays,dutyRatePct:r.dutyRatePct,eustRatePct:r.eustRatePct,ddp:r.ddp,incoterm:r.ddp?"DDP":"EXW"}}).blocked:!1});if(E){const U=((Y=K.get(E.sku))==null?void 0:Y.raw)||null,w=Mt({product:U,state:le,supplierId:u,orderContext:"po",orderOverrides:{unitCostUsd:E.unitCostUsd,prodDays:E.prodDays,transitDays:E.transitDays,dutyRatePct:r.dutyRatePct,eustRatePct:r.eustRatePct,ddp:r.ddp,incoterm:r.ddp?"DDP":"EXW"}});throw new Error(`SKU ${E.sku}: blockierende Stammdaten fehlen (${w.issues.map(q=>q.label).join(", ")}).`)}const f=It(r.milestones||[]);if(Math.abs(f-100)>.01)throw new Error("Milestone Prozentwerte muessen 100% ergeben.");const S=H&&((Se=te.find(U=>U.id===H))==null?void 0:Se.raw)||null,F={...r,supplierId:u,items:i},X=jr(F,S);if(is(S)>0&&!l){const U=Dr(S,ke),w=Dr(X,ke);if(U.goodsUsd!==w.goodsUsd||U.goodsEur!==w.goodsEur||U.freightEur!==w.freightEur||U.units!==w.units||U.prodDays!==w.prodDays||U.transitDays!==w.transitDays){he.confirm({title:"Bereits bezahlte Events vorhanden",content:"Du hast Positionen oder Summen geaendert, obwohl bereits Zahlungen verbucht sind. Bitte bewusst bestaetigen.",okText:"Trotzdem speichern",cancelText:"Abbrechen",onOk:()=>void Qe(F,!0)});return}}await ye(U=>{const w=Ve(U),q=Array.isArray(w.pos)?[...w.pos]:[];if(q.find(o=>String(o.poNo||"")===X.poNo&&String(o.id||"")!==String(X.id||"")))throw new Error(`PO Nummer ${X.poNo} existiert bereits.`);const t=q.findIndex(o=>String(o.id||"")===String(X.id||""));return t>=0?q[t]=X:q.push(X),w.pos=q,w},H?"v2:po:update":"v2:po:create"),W.clearDraft(),Xe(!1),ot(null),Ae([]),ee.resetFields()}return m.useEffect(()=>{const r=new URLSearchParams(a.search),l=r.get("source");if(l==="fo_convert"){const S=String(r.get("poNo")||"").trim();S&&tt(S),j(a.pathname,{replace:!0});return}if(l!=="inventory_projection")return;const i=String(r.get("sku")||"").trim();if(!i)return;const u=B.find(S=>S.sku===i)||null,y=Math.max(0,Math.round(Number(r.get("suggestedUnits")||0))),v=String(r.get("requiredArrivalDate")||""),E=String(r.get("recommendedOrderDate")||""),f={sku:i,units:y};u!=null&&u.supplierId&&(f.supplierId=String(u.supplierId)),v&&(f.etaManual=v),E&&(f.orderDate=E),oe(f),j(a.pathname,{replace:!0})},[a.pathname,a.search,j,B]),e.jsxs("div",{className:"v2-page",children:[e.jsxs(pe,{className:"v2-intro-card",children:[n?null:e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(Jr,{level:3,children:"Purchase Orders"}),e.jsx(Yr,{children:"PO-Stammdaten, Milestones, Auto-Events und Payment-Status in einem konsistenten Arbeitsbereich."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(k,{type:"primary",onClick:()=>oe(),children:"Neue PO"}),e.jsx(Ge,{checked:Me,onChange:r=>St(r.target.checked),children:"Archiv anzeigen"}),L?e.jsx(ae,{color:"processing",children:"Speichern..."}):null,M?e.jsxs(ae,{color:"green",children:["Gespeichert: ",new Date(M).toLocaleTimeString("de-DE")]}):null]})})]}),N?e.jsx(xe,{type:"error",showIcon:!0,message:N}):null,P?e.jsx(xe,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(pe,{children:[e.jsx("div",{className:"v2-toolbar-row",style:{marginBottom:10},children:e.jsx(se,{placeholder:"PO Nummer, SKU, Alias, Supplier",value:Fe,onChange:r=>tt(r.target.value),style:{width:320,maxWidth:"100%"}})}),e.jsx(Pr,{data:te,columns:Nt,minTableWidth:1360,tableLayout:"auto"})]}),e.jsxs(he,{title:H?"PO bearbeiten":"PO anlegen",open:Oe,width:1120,onCancel:()=>{W.clearDraft(),Xe(!1),Ae([])},onOk:()=>{if(W.readOnly){he.warning({title:"Nur Lesemodus",content:`${W.remoteUserLabel||"Kollege"} bearbeitet diese PO. Bitte Bearbeitung übernehmen oder warten.`});return}ee.validateFields().then(r=>Qe(r)).catch(()=>{})},children:[W.banner?e.jsx(xe,{style:{marginBottom:10},type:W.banner.tone,showIcon:!0,message:W.banner.text,action:W.readOnly?e.jsx(k,{size:"small",onClick:W.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,W.readOnly&&W.remoteDraftVersion>0?e.jsxs(ae,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",W.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,e.jsxs(D,{name:"v2-po-modal",form:ee,layout:"vertical",disabled:W.readOnly,onValuesChange:r=>{W.readOnly||W.publishDraftPatch(r)},children:[e.jsx(D.Item,{name:"id",hidden:!0,children:e.jsx(se,{})}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"poNo",label:"PO Nummer",style:{width:190},rules:[{required:!0,message:"PO Nummer ist erforderlich."}],children:e.jsx(se,{})}),e.jsx(D.Item,{name:"supplierId",label:"Supplier",style:{minWidth:260,flex:1},rules:[{required:!0,message:"Supplier ist erforderlich."}],children:e.jsx(Pe,{showSearch:!0,optionFilterProp:"label",options:qe.map(r=>({value:r.id,label:r.name})),onChange:r=>Wt(String(r||""))})}),e.jsx(D.Item,{name:"transport",label:"Transport",style:{width:150},children:e.jsx(Pe,{options:[{value:"sea",label:"SEA"},{value:"rail",label:"RAIL"},{value:"air",label:"AIR"}]})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"orderDate",label:"Order Date",style:{width:190},rules:[{required:!0}],children:e.jsx(se,{type:"date"})}),e.jsx(D.Item,{name:"etdManual",label:"ETD Manual",style:{width:190},children:e.jsx(se,{type:"date"})}),e.jsx(D.Item,{name:"etaManual",label:"ETA Manual",style:{width:190},children:e.jsx(se,{type:"date"})}),e.jsx(D.Item,{name:"fxOverride",label:"FX Override",style:{width:150},children:e.jsx(V,{mode:"fx",min:0})}),e.jsx(D.Item,{name:"dutyRatePct",label:"Duty %",style:{width:140},children:e.jsx(V,{mode:"percent",min:0,max:100})}),e.jsx(D.Item,{name:"eustRatePct",label:"EUSt %",style:{width:140},children:e.jsx(V,{mode:"percent",min:0,max:100})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",wrap:!0,children:[e.jsx(D.Item,{name:"dutyIncludeFreight",valuePropName:"checked",style:{marginTop:31},children:e.jsx(Ge,{children:"Duty inkl. Freight"})}),e.jsx(D.Item,{name:"ddp",valuePropName:"checked",style:{marginTop:31},children:e.jsx(Ge,{children:"DDP"})}),e.jsx(D.Item,{name:"archived",valuePropName:"checked",style:{marginTop:31},children:e.jsx(Ge,{children:"Archiviert"})})]}),e.jsxs(pe,{size:"small",className:"v2-po-items-card",style:{marginBottom:12},children:[e.jsxs(T,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(A,{strong:!0,children:"PO Positionen (Supplier-first)"}),e.jsxs(A,{type:"secondary",children:[z.length," SKU(s)"]})]}),e.jsxs(T,{style:{width:"100%",marginTop:8},align:"start",wrap:!0,children:[e.jsx(Pe,{mode:"multiple",allowClear:!0,placeholder:Le?"SKUs auswaehlen":"Zuerst Supplier waehlen",value:Pt,onChange:r=>Ae((r||[]).map(l=>String(l||""))),options:nt,style:{minWidth:420,flex:1},optionFilterProp:"label",disabled:!Le||!nt.length}),e.jsx(k,{onClick:()=>ie(Pt),disabled:!Le||!Pt.length,children:"SKUs hinzufuegen"})]}),e.jsx(D.List,{name:"items",children:(r,{add:l,remove:i})=>e.jsxs(T,{direction:"vertical",size:8,style:{width:"100%",marginTop:10},children:[r.map(u=>e.jsxs("div",{className:"v2-po-item-row",children:[e.jsxs("div",{className:"v2-po-item-row-main",children:[e.jsx(D.Item,{...u,name:[u.name,"sku"],label:"SKU",className:"v2-po-item-col v2-po-item-col--sku",rules:[{required:!0,message:"SKU fehlt."}],children:e.jsx(Pe,{showSearch:!0,optionFilterProp:"label",options:B.filter(y=>String(y.supplierId||"")===String(Le||"")).map(y=>({value:y.sku,label:`${y.alias} (${y.sku})`})),onChange:y=>$t(Number(u.name),String(y||"")),disabled:!Le})}),e.jsx(D.Item,{...u,name:[u.name,"units"],label:"Units",className:"v2-po-item-col v2-po-item-col--narrow",rules:[{required:!0,message:"Units fehlen."}],children:e.jsx(V,{mode:"int",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"unitCostUsd"],label:"Unit Cost USD",className:"v2-po-item-col",rules:[{required:!0,message:"Preis fehlt."}],children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"unitExtraUsd"],label:"Unit Extra USD",className:"v2-po-item-col",children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"extraFlatUsd"],label:"Extra Flat USD",className:"v2-po-item-col",children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"freightEur"],label:"Shipping EUR",className:"v2-po-item-col",children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"prodDays"],label:"Prod Days",className:"v2-po-item-col v2-po-item-col--narrow",rules:[{required:!0,message:"Prod fehlt."}],children:e.jsx(V,{mode:"int",min:0})}),e.jsx(D.Item,{...u,name:[u.name,"transitDays"],label:"Transit Days",className:"v2-po-item-col v2-po-item-col--narrow",rules:[{required:!0,message:"Transit fehlt."}],children:e.jsx(V,{mode:"int",min:0})})]}),e.jsx(k,{danger:!0,size:"small",style:{marginTop:31},onClick:()=>i(u.name),children:"Entfernen"})]},u.key)),e.jsx(k,{onClick:()=>l(Ie({id:fe("poi"),sku:"",units:0,unitCostUsd:0,unitExtraUsd:0,extraFlatUsd:0,prodDays:0,transitDays:0,freightEur:0})),disabled:!Le,children:"Leere Position"})]})})]}),e.jsxs(pe,{size:"small",className:"v2-po-aggregate-card",style:{marginBottom:12},children:[e.jsxs(T,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(A,{strong:!0,children:"Aggregierte Sicht (kritischer Pfad)"}),e.jsx(ae,{className:"v2-po-critical-path-tag",children:"ETA folgt langsamster SKU"})]}),e.jsxs("div",{className:"v2-po-aggregate-grid",children:[e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Goods USD"}),e.jsx("div",{children:wt(ce.goodsUsd,2)})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Goods EUR"}),e.jsx("div",{children:at(ce.goodsEur)})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Freight EUR"}),e.jsx("div",{children:at(ce.freightEur)})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Units gesamt"}),e.jsx("div",{children:wt(ce.units,0)})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Prod/Transit (kritisch)"}),e.jsxs("div",{children:[wt(ce.prodDays,0)," / ",wt(ce.transitDays,0)," Tage"]})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"ETD / ETA"}),e.jsxs("div",{children:[we(ce.schedule.etdDate)," / ",we(ce.schedule.etaDate)]})]}),e.jsxs("div",{children:[e.jsx(A,{type:"secondary",children:"Ankunftsfenster"}),e.jsx("div",{children:ce.minEtaDate||ce.maxEtaDate?`${we(ce.minEtaDate)} - ${we(ce.maxEtaDate)}`:"—"})]})]})]}),e.jsx(pe,{size:"small",style:{marginBottom:12},children:e.jsxs(T,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsx(A,{strong:!0,children:"Stammdaten-Herkunft (PO)"}),g?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Primary SKU"}),e.jsx(A,{children:g.sku})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Unit Cost USD"}),e.jsx("span",{className:Re(de.fields.unitPriceUsd.source,!0),children:de.fields.unitPriceUsd.label}),e.jsx(k,{size:"small",onClick:()=>re("unitCostUsd"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",onClick:()=>Je("unitPriceUsd",g.unitCostUsd),children:"Als Produktwert uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Prod / Transit"}),e.jsx("span",{className:Re(de.fields.productionLeadTimeDays.source,!0),children:de.fields.productionLeadTimeDays.label}),e.jsx("span",{className:Re(de.fields.transitDays.source,!1),children:de.fields.transitDays.label}),e.jsx(k,{size:"small",onClick:()=>re("prodDays"),children:"Prod reset"}),e.jsx(k,{size:"small",onClick:()=>re("transitDays"),children:"Transit reset"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"Duty / EUSt"}),e.jsx("span",{className:Re(de.fields.dutyRatePct.source,!1),children:de.fields.dutyRatePct.label}),e.jsx("span",{className:Re(de.fields.eustRatePct.source,!1),children:de.fields.eustRatePct.label}),e.jsx(k,{size:"small",onClick:()=>re("dutyRatePct"),children:"Duty reset"}),e.jsx(k,{size:"small",onClick:()=>re("eustRatePct"),children:"EUSt reset"}),e.jsx(k,{size:"small",onClick:()=>Je("dutyRatePct",d==null?void 0:d.dutyRatePct),children:"Duty uebernehmen"}),e.jsx(k,{size:"small",onClick:()=>Je("eustRatePct",d==null?void 0:d.eustRatePct),children:"EUSt uebernehmen"})]}),e.jsxs("div",{className:"v2-source-row",children:[e.jsx("span",{children:"DDP"}),e.jsx("span",{className:Re(de.fields.ddp.source,!0),children:de.fields.ddp.label}),e.jsx(k,{size:"small",onClick:()=>re("ddp"),children:"Zuruecksetzen"}),e.jsx(k,{size:"small",onClick:()=>Je("ddp",(d==null?void 0:d.ddp)===!0),children:"Als Produktwert uebernehmen"})]})]}):e.jsx(A,{type:"secondary",children:"Bitte mindestens eine SKU erfassen."})]})}),ut.blocked?e.jsx(xe,{className:"v2-po-warning",type:"error",showIcon:!0,message:"Blockierende Stammdaten fehlen",description:ut.issues.map(r=>r.label).join(", ")}):null,Le&&!nt.length?e.jsx(xe,{className:"v2-po-warning",type:"warning",showIcon:!0,message:"Dieser Lieferant hat aktuell keine zugeordneten SKUs. Bitte zuerst Stammdaten pflegen."}):null,qt.length?e.jsx(xe,{className:"v2-po-warning",type:"warning",showIcon:!0,message:"Einige Positionen sind unvollstaendig.",description:qt.slice(0,6).join(" | ")}):null,e.jsxs(pe,{size:"small",style:{marginBottom:12},children:[e.jsxs(T,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(A,{strong:!0,children:"Milestones"}),e.jsxs(A,{type:Math.abs(It((d==null?void 0:d.milestones)||[])-100)<=.01?"secondary":"danger",children:["Summe: ",wt(It((d==null?void 0:d.milestones)||[]),2),"%"]})]}),e.jsx(D.List,{name:"milestones",children:(r,{add:l,remove:i})=>e.jsxs(T,{direction:"vertical",size:8,style:{width:"100%"},children:[r.map(u=>e.jsxs(T,{align:"start",style:{width:"100%"},wrap:!0,children:[e.jsx(D.Item,{...u,name:[u.name,"label"],style:{minWidth:240,flex:2},rules:[{required:!0,message:"Label fehlt."}],children:e.jsx(se,{placeholder:"Label"})}),e.jsx(D.Item,{...u,name:[u.name,"percent"],style:{width:100},rules:[{required:!0,message:"%"}],children:e.jsx(V,{mode:"percent",min:0,max:100})}),e.jsx(D.Item,{...u,name:[u.name,"anchor"],style:{width:160},rules:[{required:!0,message:"Anchor fehlt."}],children:e.jsx(Pe,{options:zr.map(y=>({value:y,label:y}))})}),e.jsx(D.Item,{...u,name:[u.name,"lagDays"],style:{width:120},children:e.jsx(V,{mode:"int"})}),e.jsx(k,{danger:!0,onClick:()=>i(u.name),children:"X"})]},u.key)),e.jsx(k,{onClick:()=>l({id:fe("ms"),label:"Milestone",percent:0,anchor:"ORDER_DATE",lagDays:0}),children:"Milestone"})]})})]}),e.jsxs(pe,{size:"small",children:[e.jsxs(T,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(A,{strong:!0,children:"Event / Payment Preview"}),e.jsx(k,{size:"small",onClick:()=>$e(null),disabled:!H||!Be.length||W.readOnly,children:"Sammelzahlung buchen"})]}),Z?e.jsxs(T,{direction:"vertical",size:4,style:{width:"100%",marginTop:8},children:[e.jsxs(A,{children:["Timeline: Order ",we(Z.orderDate)," · ETD ",we(Z.etdManual||Ut({orderDate:Z.orderDate,productionLeadTimeDays:Z.prodDays,logisticsLeadTimeDays:Z.transitDays,bufferDays:0}).etdDate)," · ETA ",we(Z.etaManual||Ut({orderDate:Z.orderDate,productionLeadTimeDays:Z.prodDays,logisticsLeadTimeDays:Z.transitDays,bufferDays:0}).etaDate)]}),H?null:e.jsx(xe,{type:"info",showIcon:!0,message:"PO zuerst speichern, danach koennen Zahlungen (inkl. Sammelzahlung) verbucht werden."}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Typ"}),e.jsx("th",{children:"Due"}),e.jsx("th",{children:"Planned EUR"}),e.jsx("th",{children:"Ist EUR"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Paid Date"}),e.jsx("th",{children:"Methode / Von"}),e.jsx("th",{children:"Invoice / Folder"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Be.map(r=>e.jsxs("tr",{children:[e.jsx("td",{children:Qr(String(r.id||""))}),e.jsx("td",{children:rr(r)}),e.jsx("td",{children:we(r.dueDate)}),e.jsx("td",{children:at(r.plannedEur)}),e.jsx("td",{children:r.paidEurActual!=null?at(r.paidEurActual):"—"}),e.jsx("td",{children:r.status==="paid"?"Bezahlt":"Offen"}),e.jsx("td",{children:we(r.paidDate)}),e.jsx("td",{children:r.method||r.paidBy?e.jsxs(T,{direction:"vertical",size:0,children:[e.jsx(A,{children:r.method||"—"}),e.jsx(A,{type:"secondary",children:r.paidBy||"—"})]}):"—"}),e.jsx("td",{children:e.jsxs(T,{direction:"vertical",size:0,children:[Kt(r.invoiceDriveUrl)?e.jsx("a",{href:String(r.invoiceDriveUrl),target:"_blank",rel:"noreferrer",children:"Invoice"}):e.jsx(A,{type:"secondary",children:"Invoice —"}),Kt(r.invoiceFolderDriveUrl)?e.jsx("a",{href:String(r.invoiceFolderDriveUrl),target:"_blank",rel:"noreferrer",children:"Folder"}):e.jsx(A,{type:"secondary",children:"Folder —"})]})}),e.jsx("td",{children:e.jsx(k,{size:"small",onClick:()=>$e(r),disabled:!H||W.readOnly,children:r.status==="paid"?"Bearbeiten":"Zahlung buchen"})})]},r.id))})]})})]}):e.jsx(A,{type:"secondary",children:"Preview erscheint nach Eingabe."})]})]})]}),e.jsxs(he,{title:"PO Zahlung verbuchen",open:Ft,width:920,onCancel:()=>{mt(!1),ht(null),ct([]),Ue(null),Ze.resetFields()},onOk:()=>{Ue(null),Ze.validateFields().then(r=>Et(r)).catch(r=>{r!=null&&r.errorFields||Ue(String(r instanceof Error?r.message:r))})},children:[dt?e.jsx(xe,{type:"error",showIcon:!0,message:dt,style:{marginBottom:10}}):null,e.jsxs(D,{form:Ze,layout:"vertical",onFinish:r=>{Ue(null),Et(r).catch(l=>{Ue(String(l instanceof Error?l.message:l))})},children:[e.jsx(D.Item,{name:"selectedEventIds",label:"Welche Zahlungsbausteine sind in dieser Zahlung enthalten?",rules:[{required:!0,message:"Bitte mindestens einen Baustein waehlen."}],children:e.jsx(Ge.Group,{style:{width:"100%"},children:e.jsx(T,{direction:"vertical",style:{width:"100%"},children:Be.map(r=>{const l=r.status==="paid"&&r.paymentId&&r.paymentId!==lt&&!Ot.includes(r.id);return e.jsx(pe,{size:"small",style:{width:"100%"},children:e.jsx(Ge,{value:r.id,disabled:l,children:e.jsxs(T,{size:10,wrap:!0,children:[e.jsx(A,{strong:!0,children:rr(r)}),e.jsxs(A,{type:"secondary",children:["Due ",we(r.dueDate)]}),e.jsx(A,{children:at(r.plannedEur)}),r.status==="paid"?e.jsx(ae,{color:"green",children:"Bereits bezahlt"}):e.jsx(ae,{children:"Offen"}),r.paymentId?e.jsxs(A,{type:"secondary",children:["Payment-ID ",r.paymentId]}):null]})})},r.id)})})})}),e.jsxs(T,{align:"start",wrap:!0,style:{width:"100%"},children:[e.jsx(D.Item,{name:"paidDate",label:"Zahlungsdatum",style:{width:170},rules:[{required:!0}],children:e.jsx(se,{type:"date"})}),e.jsx(D.Item,{name:"method",label:"Zahlungsmethode",style:{minWidth:240,flex:1},rules:[{required:!0}],children:e.jsx(Pe,{showSearch:!0,optionFilterProp:"label",options:zt,placeholder:"z. B. Alibaba Trade Assurance"})}),e.jsx(D.Item,{name:"paidBy",label:"Bezahlt durch",style:{minWidth:220,flex:1},rules:[{required:!0}],children:e.jsx(se,{placeholder:Lt.map(r=>r.label).join(" / ")||"Name oder E-Mail"})})]}),e.jsxs(T,{align:"start",wrap:!0,style:{width:"100%"},children:[e.jsx(D.Item,{name:"amountActualEur",label:"Ist-Betrag EUR",style:{width:190},rules:[{required:!0}],children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{name:"amountActualUsd",label:"Ist-Betrag USD (optional)",style:{width:210},children:e.jsx(V,{mode:"decimal",min:0})}),e.jsx(D.Item,{name:"paymentId",label:"Payment-ID (intern)",style:{minWidth:300,flex:1},children:e.jsx(se,{placeholder:"pay-..."})})]}),e.jsxs(T,{align:"start",wrap:!0,style:{width:"100%"},children:[e.jsx(D.Item,{name:"invoiceDriveUrl",label:"Invoice Link (Google Drive)",style:{minWidth:360,flex:1},children:e.jsx(se,{placeholder:"https://..."})}),e.jsx(k,{style:{marginTop:31},disabled:!Kt(String((ue==null?void 0:ue.invoiceDriveUrl)||"")),onClick:()=>window.open(String((ue==null?void 0:ue.invoiceDriveUrl)||""),"_blank","noopener,noreferrer"),children:"Link oeffnen"})]}),e.jsxs(T,{align:"start",wrap:!0,style:{width:"100%"},children:[e.jsx(D.Item,{name:"invoiceFolderDriveUrl",label:"Ordner-Link (Google Drive)",style:{minWidth:360,flex:1},children:e.jsx(se,{placeholder:"https://..."})}),e.jsx(k,{style:{marginTop:31},disabled:!Kt(String((ue==null?void 0:ue.invoiceFolderDriveUrl)||"")),onClick:()=>window.open(String((ue==null?void 0:ue.invoiceFolderDriveUrl)||""),"_blank","noopener,noreferrer"),children:"Ordner oeffnen"})]}),e.jsx(D.Item,{name:"note",label:"Notiz",children:e.jsx(se.TextArea,{rows:2,placeholder:"Optionaler Hinweis"})}),e.jsx(pe,{size:"small",children:e.jsxs(T,{direction:"vertical",style:{width:"100%"},size:6,children:[e.jsx(A,{strong:!0,children:"Dateiname-Vorschlag fuer Rechnung"}),e.jsx(A,{code:!0,children:ge||"—"}),e.jsx("div",{children:e.jsx(k,{size:"small",onClick:()=>{ge&&(navigator.clipboard.writeText(ge),et.success("Dateiname kopiert."))},children:"Dateiname kopieren"})})]})})]})]})]})}const{Paragraph:br,Title:fr}=Rt;function os(n){return n.includes("/orders/fo")?"fo":"po"}function Ms(){const n=sr(),a=nr(),{state:j}=ir(),p=m.useMemo(()=>os(n.pathname),[n.pathname]),P=m.useMemo(()=>(Array.isArray(j.payments)?j.payments:[]).map(N=>N).map(N=>({id:String(N.id||""),paidDate:String(N.paidDate||""),method:String(N.method||"—"),payer:String(N.payer||"—"),amountActualEurTotal:Number(N.amountActualEurTotal||0),coveredCount:Array.isArray(N.coveredEventIds)?N.coveredEventIds.length:0})).filter(N=>N.id).sort((N,M)=>String(M.paidDate||"").localeCompare(String(N.paidDate||""))).slice(0,12),[j.payments]),L=m.useMemo(()=>P.reduce((N,M)=>N+Number(M.amountActualEurTotal||0),0),[P]);return e.jsxs("div",{className:"v2-page",children:[e.jsx(pe,{className:"v2-intro-card",children:e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(fr,{level:3,children:"Bestellungen"}),e.jsx(br,{children:"Gemeinsamer Arbeitsbereich für Forecast Orders und Purchase Orders mit schneller FO-zu-PO Übergabe."})]})})}),e.jsxs(pe,{style:{marginBottom:12},children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(fr,{level:5,children:"Zahlungsprotokoll (PO-Ist)"}),e.jsx(br,{children:"Tatsächlich bestätigte Zahlungen werden nur auf POs gebucht. FOs bleiben Planobjekte."})]})}),e.jsxs("div",{className:"v2-toolbar-row",style:{marginBottom:8},children:[e.jsxs(Rt.Text,{type:"secondary",children:["Eintraege: ",P.length]}),e.jsxs(Rt.Text,{type:"secondary",children:["Summe Ist: ",L.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})," €"]})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Payment-ID"}),e.jsx("th",{children:"Paid Date"}),e.jsx("th",{children:"Methode"}),e.jsx("th",{children:"Durch"}),e.jsx("th",{children:"Ist EUR"}),e.jsx("th",{children:"Abgedeckte Events"})]})}),e.jsx("tbody",{children:P.length?P.map(N=>e.jsxs("tr",{children:[e.jsx("td",{children:N.id}),e.jsx("td",{children:N.paidDate||"—"}),e.jsx("td",{children:N.method}),e.jsx("td",{children:N.payer}),e.jsxs("td",{children:[Number(N.amountActualEurTotal||0).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})," €"]}),e.jsx("td",{children:N.coveredCount})]},N.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Noch keine Zahlungen verbucht."})})})]})})]}),e.jsx(wr,{activeKey:p,onChange:N=>a(`/v2/orders/${N}`),items:[{key:"po",label:"Purchase Orders",children:e.jsx(as,{embedded:!0})},{key:"fo",label:"Forecast Orders",children:e.jsx(Xr,{embedded:!0})}]})]})}export{Ms as default};
