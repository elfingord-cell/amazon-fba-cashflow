import{p as F,aq as Dn}from"./index-Dsq1NbgA.js";function m(n){if(!n)return null;const t=String(n);if(/^\d{4}-\d{2}$/.test(t))return t;const r=t.match(/^(\d{2})-(\d{4})$/);return r?`${r[2]}-${r[1]}`:t}function A(n){return String(n||"").trim()}function Fn(n){if(!n||!Dn(n.includeInForecast,!0))return!1;if(typeof n.active=="boolean")return n.active;const t=String(n.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function ln(n){if(!/^\d{4}-\d{2}$/.test(n||""))return 30;const[t,r]=n.split("-").map(Number);return new Date(t,r,0).getDate()}function Y(n){if(!/^\d{4}-\d{2}$/.test(n||""))return null;const[t,r]=n.split("-").map(Number);return!t||!r?null:{year:t,monthIndex:r-1}}function T(n,t){const r=Y(n),e=Y(t);if(!r||!e)return String(n||"").localeCompare(String(t||""));const a=r.year*12+r.monthIndex,o=e.year*12+e.monthIndex;return a-o}function G(n,t){const r=Y(n);if(!r)return null;const e=new Date(r.year,r.monthIndex,1);return e.setMonth(e.getMonth()+Number(t||0)),`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function fn(n,t){if(!n||!t)return[];if(T(n,t)>=0)return[];const r=[];let e=G(n,1);for(;e&&T(e,t)<=0;)r.push(e),e=G(e,1);return r}function $(n){if(!n)return null;const t=new Date(n);return Number.isNaN(t.getTime())?null:t}function hn(n){return!(n instanceof Date)||Number.isNaN(n.getTime())?null:`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function vn(n){const t=$((n==null?void 0:n.etaManual)||(n==null?void 0:n.etaDate)||(n==null?void 0:n.eta));if(t)return t;const r=$(n==null?void 0:n.etaComputed);if(r)return r;const e=$(n==null?void 0:n.orderDate);if(!e)return null;const a=Number((n==null?void 0:n.prodDays)||0),o=Number((n==null?void 0:n.transitDays)||0),l=new Date(e.getTime());return l.setDate(l.getDate()+Math.max(0,a+o)),l}function wn(n){return $((n==null?void 0:n.targetDeliveryDate)||(n==null?void 0:n.deliveryDate)||(n==null?void 0:n.etaDate))}function An(n){const t=String(n||"").trim().toUpperCase();return t?t==="PLANNED"?"ACTIVE":t==="CANCELLED"?"ARCHIVED":t:"DRAFT"}function Un(n){const t=An(n==null?void 0:n.status);return t==="DRAFT"||t==="ACTIVE"}function dn(n,t,r){var f,M,k,i,S,d,g,h,b;const e=m(r);if(!e)return null;const a=A(t);if(a){const B=((f=n==null?void 0:n.__inventoryForecastOverrideBySku)==null?void 0:f.get(a))||((M=n==null?void 0:n.__inventoryForecastOverrideBySku)==null?void 0:M.get(a.toLowerCase())),C=B==null?void 0:B.get(e);if(Number.isFinite(C))return Number(C)}const o=(S=(i=(k=n==null?void 0:n.forecast)==null?void 0:k.forecastManual)==null?void 0:i[t])==null?void 0:S[e],l=F(o);if(Number.isFinite(l))return l;const s=(b=(h=(g=(d=n==null?void 0:n.forecast)==null?void 0:d.forecastImport)==null?void 0:g[t])==null?void 0:h[e])==null?void 0:b.units,u=F(s);return Number.isFinite(u)?u:null}function In(n){const t=new Map;return!n||typeof n!="object"||Object.entries(n).forEach(([r,e])=>{const a=A(r);if(!a||!e||typeof e!="object")return;const o=new Map;Object.entries(e).forEach(([l,s])=>{const u=m(l),f=F(s);!u||!Number.isFinite(f)||o.set(u,Number(f))}),o.size&&(t.set(a,o),t.set(a.toLowerCase(),o))}),t}function Cn(n,t,r){n.has(t)||n.set(t,new Map);const e=n.get(t);return e.has(r)||e.set(r,{totalUnits:0,poUnits:0,foUnits:0,poItems:[],foItems:[]}),e.get(r)}function En(n,t){const r=new Set(t),e=new Map,a=new Map;let o=0;const l=({sku:s,month:u,units:f,source:M,recordId:k,recordNo:i,arrivalDate:S,arrivalSource:d})=>{if(!s||!r.has(u)||!f)return;e.has(s)||e.set(s,new Map);const g=e.get(s);g.set(u,(g.get(u)||0)+f);const h=Cn(a,s,u),b={id:String(k||""),ref:String(i||"â€”"),units:f,arrivalDate:S||null,arrivalSource:d||null};M==="fo"?(h.foUnits+=f,h.foItems.push(b)):(h.poUnits+=f,h.poItems.push(b)),h.totalUnits+=f};return((n==null?void 0:n.pos)||[]).forEach(s=>{if(!s||s.archived||String(s.status||"").toUpperCase()==="CANCELLED")return;const u=vn(s),f=u?hn(u):null;if(!f){o+=1;return}const M=u.toISOString().slice(0,10);(Array.isArray(s.items)&&s.items.length?s.items:[{sku:s.sku,units:s.units}]).forEach(i=>{const S=A((i==null?void 0:i.sku)||(s==null?void 0:s.sku));if(!S)return;const d=(i==null?void 0:i.units)??(i==null?void 0:i.qty)??(i==null?void 0:i.quantity)??(s==null?void 0:s.units),g=F(d),h=Number.isFinite(g)?Math.round(g):0;h&&l({sku:S,month:f,units:h,source:"po",recordId:s.id,recordNo:s.poNo||s.id,arrivalDate:M,arrivalSource:"ETA"})})}),((n==null?void 0:n.fos)||[]).forEach(s=>{if(!s||!Un(s))return;const u=wn(s),f=u?hn(u):null;if(!f){o+=1;return}const M=u.toISOString().slice(0,10);(Array.isArray(s.items)&&s.items.length?s.items:[{sku:s.sku,units:s.units}]).forEach(i=>{const S=A((i==null?void 0:i.sku)||(s==null?void 0:s.sku));if(!S)return;const d=(i==null?void 0:i.units)??(i==null?void 0:i.qty)??(i==null?void 0:i.quantity)??(s==null?void 0:s.units),g=F(d),h=Number.isFinite(g)?Math.round(g):0;h&&l({sku:S,month:f,units:h,source:"fo",recordId:s.id,recordNo:s.foNo||s.id,arrivalDate:M,arrivalSource:"DELIVERY"})})}),{inboundUnitsMap:e,inboundDetailsMap:a,inboundMissingDateCount:o}}function Bn(n,t=null){var a;const r=(((a=n==null?void 0:n.inventory)==null?void 0:a.snapshots)||[]).filter(o=>(o==null?void 0:o.month)&&m(o.month)).slice().sort((o,l)=>m(o.month).localeCompare(m(l.month)));if(!r.length)return null;const e=m(t);if(!e)return r[r.length-1];for(let o=r.length-1;o>=0;o-=1){const l=r[o],s=m(l==null?void 0:l.month);if(s&&T(s,e)<=0)return l}return null}function Ln(n){var t;return(((t=n==null?void 0:n.inventory)==null?void 0:t.snapshots)||[]).filter(r=>(r==null?void 0:r.month)&&m(r.month)).slice().sort((r,e)=>m(r.month).localeCompare(m(e.month)))}function yn(n){const t=F(n==null?void 0:n.amazonUnits),r=F(n==null?void 0:n.threePLUnits),e=F(n==null?void 0:n.units);return Number.isFinite(t)||Number.isFinite(r)?(Number.isFinite(t)?Number(t):0)+(Number.isFinite(r)?Number(r):0):Number.isFinite(e)?Number(e):0}function On(n,t=null){const r=m(t),e=Ln(n),a=new Map;return e.forEach(o=>{const l=m(o==null?void 0:o.month);if(!l||r&&T(l,r)>0)return;(Array.isArray(o==null?void 0:o.items)?o.items:[]).forEach(u=>{const f=A(u==null?void 0:u.sku);f&&a.set(f,{month:l,units:yn(u)})})}),a}function j(n){const t=F(n);return!Number.isFinite(t)||t<=0?null:Math.round(t)}function zn(n,t){var a,o,l;const r=j(n==null?void 0:n.safetyStockDohOverride);return r??j(((a=t==null?void 0:t.settings)==null?void 0:a.safetyStockDohDefault)??((l=(o=t==null?void 0:t.inventory)==null?void 0:o.settings)==null?void 0:l.safetyDays))}function Tn(n,t){var a;const r=j(n==null?void 0:n.foCoverageDohOverride);return r??j((a=t==null?void 0:t.settings)==null?void 0:a.foCoverageDohDefault)}function _n({endAvailable:n,safetyUnits:t,doh:r,safetyDays:e,projectionMode:a="units"}){return(a==="doh"?"doh":"units")==="doh"?Number.isFinite(r)?r<=0?"safety-negative":Number.isFinite(e)&&r<e?"safety-low":"":"":Number.isFinite(n)?n<=0?"safety-negative":Number.isFinite(t)&&n<t?"safety-low":"":""}function $n({state:n,months:t,products:r,snapshot:e,snapshotMonth:a,forecastUnitsBySkuMonth:o,projectionMode:l="units"}){const s=In(o),u={...n||{},__inventoryForecastOverrideBySku:s},f=(Array.isArray(t)?t:[]).map(y=>m(y)).filter(Boolean),M=Array.isArray(r)?r:(u==null?void 0:u.products)||[],k=f[0]||null,i=m(a||(e==null?void 0:e.month)),S=k?G(k,-1):null;let d=i||S;d&&k&&T(d,k)>=0&&S&&(d=S);const h=(e&&Array.isArray(e.items)?e:null)||Bn(u,d),b=m(h==null?void 0:h.month),B=!!(i&&b&&i!==b);d=d||b||S||null;const C=new Map;h&&Array.isArray(h.items)&&h.items.forEach(y=>{const c=A(y==null?void 0:y.sku);c&&C.set(c,yn(y))});const Sn=On(u,d),L=new Map,O=new Map,R=new Set,J=new Set,Q=new Map,X=new Set(f);M.forEach(y=>{var q;const c=A(y==null?void 0:y.sku);if(!c)return;if(C.has(c)&&b)L.set(c,{type:"anchor_snapshot",month:b}),O.set(c,C.get(c));else{const v=Sn.get(c)||null;v?(L.set(c,{type:"sku_fallback",month:v.month}),O.set(c,v.units),R.add(c)):(L.set(c,{type:"missing_history",month:null}),O.set(c,0),J.add(c))}const _=((q=L.get(c))==null?void 0:q.month)||null,U=fn(_,d);Q.set(c,U),U.forEach(v=>X.add(v))});const bn=Array.from(X),{inboundUnitsMap:V,inboundDetailsMap:Z,inboundMissingDateCount:mn}=En(u,bn),W=new Map,nn=new Set,tn=l==="doh"?"doh":"units",rn=new Set,en=new Map;M.forEach(y=>{const c=A(y==null?void 0:y.sku);if(!c)return;Fn(y)&&nn.add(c);const _=O.has(c)?O.get(c):0;let U=Number.isFinite(_)?_:0;(Q.get(c)||[]).forEach(N=>{var P;const D=((P=V.get(c))==null?void 0:P.get(N))||0,w=dn(u,c,N);Number.isFinite(w)||rn.add(c);const E=Number.isFinite(w)?Number(w):0;U=U+D-E});let v=U,x=!1;const sn=new Map,z=zn(y,u);f.forEach(N=>{var an,cn;const D=dn(u,c,N),w=Number.isFinite(D),E=((an=Z.get(c))==null?void 0:an.get(N))||null,P=(E==null?void 0:E.totalUnits)||((cn=V.get(c))==null?void 0:cn.get(N))||0;let I=null;!x&&w?(I=v+P-D,v=I):x=!0;const kn=!w||x,K=w&&D>0?D/ln(N):null,p=Number.isFinite(I)&&Number.isFinite(K)&&K>0?Math.max(0,Math.round(I/K)):null,H=Number.isFinite(D)&&Number.isFinite(z)?Math.round(D/ln(N)*z):null,on=Number.isFinite(p)&&Number.isFinite(z)&&p>=z,un=Number.isFinite(I)&&Number.isFinite(H)&&I>=H,Nn=tn==="doh"?on:un;sn.set(N,{forecastUnits:D,hasForecast:w,inboundUnits:P,inboundDetails:E,endAvailable:I,safetyDays:z,safetyUnits:H,doh:p,passesDoh:on,passesUnits:un,isCovered:Nn,forecastMissing:kn})}),W.set(c,sn),en.set(c,U)});const gn=fn(b,d),Mn=b?gn.length?"rollforward":"snapshot":"no_snapshot";return{months:f,perSkuMonth:W,inboundUnitsMap:V,inboundDetailsMap:Z,snapshot:h,resolvedSnapshotMonth:b,snapshotFallbackUsed:B,inboundMissingDateCount:mn,startAvailableBySku:en,projectionMode:tn,activeSkus:nn,anchorMonth:d,anchorTargetMonth:d,anchorSourceMonth:b,anchorMode:Mn,anchorSourceBySku:L,anchorSkuFallbackCount:R.size,anchorSkuFallbackSkus:Array.from(R).sort(),anchorSkuMissingHistory:Array.from(J).sort(),anchorForecastGapSkus:Array.from(rn).sort()}}export{Tn as a,$n as c,_n as g,zn as r};
