import{g as Rt}from"./planProducts-BY0Y95Lf.js";function $t(e){return Number.isFinite(e)?e:0}function A(e){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim().replace(/\./g,"").replace(",","."),u=Number(n);return Number.isFinite(u)?u:0}function S(e){if(e===""||e===null||e===void 0)return 0;const n=Number(String(e).replace(",","."));return Number.isFinite(n)?n:0}function qt(e){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format($t(Number(e)))}function Ot(e,n){const[u,d]=e.split("-").map(Number),s=new Date(u,d-1+n,1);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`}function Mt(e,n){const u=[];for(let d=0;d<n;d++)u.push(Ot(e,d));return u}function J(e){const n=new Date(e);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function Y(e,n){const u=new Date(e.getTime());return u.setDate(u.getDate()+(n||0)),u}function w(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?null:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function ot(e){if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n}function gt(e){const[n,u]=e.split("-").map(Number);return new Date(n,u,0)}function vt(e,n){var y;const u=e==null?void 0:e.cny;if(u!=null&&u.start&&(u!=null&&u.end)){const h=ot(u.start),r=ot(u.end);if(h&&r&&r>=h)return{start:h,end:r}}const d=(y=e==null?void 0:e.cnyBlackoutByYear)==null?void 0:y[String(n)];if(!d)return null;const s=ot(d.start),f=ot(d.end);return!s||!f||f<s?null:{start:s,end:f}}function It(e,n,u){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return{prodDone:e,adjustmentDays:0};const d=Math.max(0,Number(n||0)),s=Y(e,d);if(!u||d===0)return{prodDone:s,adjustmentDays:0};let f=0;const y=e.getUTCFullYear(),h=s.getUTCFullYear();for(let m=y;m<=h;m+=1){const l=vt(u,m);if(!l)continue;const D=l.start>e?l.start:e,P=l.end<s?l.end:s;if(P<D)continue;const v=Math.round((P.getTime()-D.getTime())/(24*60*60*1e3))+1;f+=Math.max(0,v)}return{prodDone:f?Y(s,f):s,adjustmentDays:f}}function Dt(e,n){const u=ot(e.orderDate)||new Date,d=Number(e.productionLeadTimeDays??e.prodDays??0),s=Number(e.logisticsLeadTimeDays??e.transitDays??0),y=It(u,d,n).prodDone??Y(u,d),h=y,r=Y(h,s),m=ot(e.etdManual),l=ot(e.etaManual);return{ORDER_DATE:u,PROD_DONE:y,PRODUCTION_END:y,ETD:m||h,ETA:l||r}}function kt(e,n){const u=new Date(e.getTime());return u.setMonth(u.getMonth()+n),u}function St(e){return new Date(e.getFullYear(),e.getMonth()+1,0)}function at(e){if(!/^\d{4}-\d{2}$/.test(e||""))return null;const[n,u]=e.split("-").map(Number);return n*12+(u-1)}function Ct(e,n){const u=Array.isArray(e==null?void 0:e.items)?e.items:[];let d=0,s=0;if(u.length)u.forEach(m=>{const l=A((m==null?void 0:m.units)??0),D=A((m==null?void 0:m.unitCostUsd)??0),P=A((m==null?void 0:m.unitExtraUsd)??0),v=A((m==null?void 0:m.extraFlatUsd)??0),z=(D+P)*l+v,E=Math.max(0,Math.round(z*100)/100);Number.isFinite(E)&&(d+=E),Number.isFinite(l)&&(s+=l)});else{const m=A((e==null?void 0:e.units)??0),l=A((e==null?void 0:e.unitCostUsd)??0),D=A((e==null?void 0:e.unitExtraUsd)??0),P=A((e==null?void 0:e.extraFlatUsd)??0),v=(l+D)*m+P;d=Math.max(0,Math.round(v*100)/100),Number.isFinite(m)&&(s=m)}const f=A((e==null?void 0:e.fxOverride)??0),y=Number.isFinite(f)&&f>0?f:A((n==null?void 0:n.fxRate)??0)||0,h=y>0?Math.round(d/y*100)/100:0,r=A((e==null?void 0:e.goodsEur)??0);return{usd:d,eur:h>0?h:r,units:s}}function Et(e,n){if(((e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const d=A((e==null?void 0:e.freightPerUnitEur)??0),s=Number((n==null?void 0:n.units)??0)||0,f=d*s;return Math.round(f*100)/100}return A((e==null?void 0:e.freightEur)??0)}function Ut(e,n,u){const d=new Date(e,n+1,0).getDate(),s=Math.min(Math.max(1,u),d);return new Date(e,n,s)}function At(e,n){const u=at(e);if(u==null)return null;const d=Math.floor(u/12),s=u%12;if(!n||n==="LAST"||n==="Letzter Tag"||n==="EOM")return new Date(d,s+1,0);const f=Number(n);return Number.isFinite(f)?Ut(d,s,f):new Date(d,s+1,0)}function _t(e){const n=String(e||"").trim().toUpperCase();return n?n==="PLANNED"?"ACTIVE":n==="CANCELLED"?"ARCHIVED":n:"DRAFT"}function jt(e){const n=_t(e);return n==="DRAFT"||n==="ACTIVE"}function Lt(e,n,u,d){if(!n||!n.proration||n.proration.enabled!==!0)return{amount:e,applied:!1};if(n.proration.method!=="daily")return{amount:e,applied:!1};const s=at(u);if(s==null)return{amount:e,applied:!1};const f=Math.floor(s/12),y=s%12,h=new Date(f,y+1,0).getDate(),r=d instanceof Date&&!Number.isNaN(d.getTime())?d:At(u,n.anchor),m=r instanceof Date?r.getDate():h;let l=1;n.startMonth&&n.startMonth===u&&(l*=Math.max(0,h-m+1)/h),n.endMonth&&n.endMonth===u&&(l*=Math.max(0,m)/h);const D=Math.round(e*l*100)/100;return!Number.isFinite(D)||D===e?{amount:e,applied:!1}:{amount:D,applied:!0}}function xt({statusRecord:e,autoEligible:n,autoManualCheck:u,entryTime:d,todayTime:s,defaultPaid:f}){const y=typeof(e==null?void 0:e.manual)=="boolean"?e.manual:void 0;let h=!1,r=!1;typeof y=="boolean"?h=y:n&&!u&&d!=null&&d<=s?(h=!0,r=!0):h=!!f;const m=n&&u&&!r;let l=null;return n&&(r?l="Automatisch bezahlt am Fälligkeitstag":u?l="Automatische Zahlung – manuelle Prüfung aktiv":l="Automatische Zahlung"),{paid:h,autoApplied:r,manualOverride:typeof y=="boolean",autoSuppressed:m,autoTooltip:l}}function Bt(e,n={}){const u=e||{},d=n.startMonth||u.settings&&u.settings.startMonth||"2025-01",s=Number(n.horizon||u.settings&&u.settings.horizonMonths||12),f=Array.isArray(n.months)&&n.months.length?n.months:Mt(d,s),y=Array.isArray(u.fixcosts)?u.fixcosts:[],h=u.fixcostOverrides&&typeof u.fixcostOverrides=="object"?u.fixcostOverrides:{},r=n.status&&typeof n.status=="object"?n.status:u.status||{},m=n.statusEvents&&typeof n.statusEvents=="object"?n.statusEvents:r.events||{},l=n.autoManualCheck!=null?n.autoManualCheck===!0:r.autoManualCheck===!0,D=n.today?new Date(n.today):new Date;D.setHours(0,0,0,0);const P=D.getTime(),v=[],z=new Set(f);return y.forEach((E,C)=>{if(!E)return;const U=E.id||`fix-${C}`,G=E.startMonth||d,W=at(G);if(W==null)return;const Z=E.endMonth||null,q=Z?at(Z):null,i=(E.frequency||"monthly").toLowerCase();let b=1;i==="quarterly"?b=3:i==="semiannual"||i==="halbjährlich"?b=6:i==="annual"||i==="jährlich"||i==="yearly"?b=12:(i==="custom"||i==="benutzerdefiniert")&&(b=Number(E.intervalMonths||E.everyMonths||1)||1),b<1&&(b=1);const $=E.anchor,N=!$||$==="Letzter Tag"?"LAST":String($),x=h[U]&&typeof h[U]=="object"?h[U]:{},F=E.name||"Fixkosten",R=E.category||"Sonstiges",O=Math.abs(A(E.amount)),H=E.notes||"",X=E.autoPaid===!0;f.forEach(_=>{if(!z.has(_))return;const tt=at(_);if(tt==null||tt<W||q!=null&&tt>q||(tt-W)%b!==0)return;const st=At(_,N),j=x[_]&&typeof x[_]=="object"?x[_]:{};let I=st;if(j.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(j.dueDate)){const o=new Date(j.dueDate);Number.isNaN(o.getTime())||(I=o)}let k=O,Q=!1;j.amount!=null&&String(j.amount).trim()!==""&&(k=Math.abs(A(j.amount)),Q=!0);let et=!1;if(!Q){const o=Lt(O,E,_,I);k=o.amount,et=o.applied}const it=`fix-${U}-${_}`,dt=I instanceof Date&&!Number.isNaN(I.getTime())?I.getTime():null,rt=m[it],K=xt({statusRecord:rt,autoEligible:X,autoManualCheck:l,entryTime:dt,todayTime:P,defaultPaid:!1}),ct=I instanceof Date&&!Number.isNaN(I.getTime())?w(I):null,ut=j.note||"",t=[F];Q&&t.push("Override aktiv"),et&&t.push("Proratiert");const a=t.length>1?t.join(" · "):null;v.push({id:it,month:_,amount:k,baseAmount:O,label:F,category:R,dueDate:I,dueDateIso:ct,fixedCostId:U,autoPaid:X,notes:H,override:{amount:j.amount||"",dueDate:j.dueDate||"",note:ut},overrideActive:Q||!!j.dueDate||!!ut,prorationApplied:et,paid:K.paid,autoApplied:K.autoApplied,manualOverride:K.manualOverride,autoTooltip:K.autoTooltip,autoSuppressed:K.autoSuppressed,anchor:N,frequency:i,tooltip:a})})}),v.sort((E,C)=>{if(E.month===C.month){const U=E.dueDate instanceof Date?E.dueDate.getTime():0,G=C.dueDate instanceof Date?C.dueDate.getTime():0;return U-G}return at(E.month)-at(C.month)}),v}function zt(e){const n=e||{};return{dutyRatePct:S(n.dutyRatePct??0),dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:S(n.eustRatePct??0),vatRefundLagMonths:Number(n.vatRefundLagMonths??0)||0,vatRefundEnabled:n.vatRefundEnabled!==!1,freightLagDays:Number(n.freightLagDays??0)||0,fxFeePct:S(n.fxFeePct??0)}}function Yt(e,n,u){const d=["freight","duty","eust","vat_refund","fx_fee"],s=Array.isArray(e.autoEvents)?e.autoEvents.filter(Boolean).map(r=>({...r})):[],f=new Map;for(const r of s)!r||!r.type||(r.id||(r.id=`auto-${r.type}`),f.set(r.type,r));const y=(u||[])[0]||null;function h(r,m){if(!f.has(r)){const D={id:`auto-${r}`,type:r,...m};return s.push(D),f.set(r,D),D}const l=f.get(r);l.id||(l.id=`auto-${r}`);for(const[D,P]of Object.entries(m))l[D]===void 0&&(l[D]=P);return l}if(h("freight",{label:"Fracht",anchor:"ETA",lagDays:n.freightLagDays,enabled:!0}),h("duty",{label:"Zoll",percent:n.dutyRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("eust",{label:"EUSt",percent:n.eustRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:n.vatRefundLagMonths,enabled:n.vatRefundEnabled}),h("fx_fee",{label:"FX-Gebühr",percent:n.fxFeePct,anchor:y&&y.anchor||"ORDER_DATE",lagDays:y&&Number(y.lagDays||0)||0}),s.sort((r,m)=>d.indexOf(r.type)-d.indexOf(m.type)),e.ddp)for(const r of s)(r.type==="freight"||r.type==="duty"||r.type==="eust"||r.type==="vat_refund")&&(r.enabled=!1);return s}function Nt(e,n,u,d){var q;if(!e)return[];const s=u||"PO",f=e[d],y=f?`${s} ${f}`:s;if(Array.isArray(e.payments)&&e.payments.length){const i=Dt(e,n);return e.payments.filter(Boolean).map((b,$)=>{const N=b.triggerEvent||"ORDER_DATE",x=N==="PROD_DONE"?"PROD_DONE":N,F=i[x]||i.ORDER_DATE,R=b.dueDate?new Date(b.dueDate):Y(F,Number(b.offsetDays||0)),O=Number(b.amount||0),H=O>=0?"out":"in",X=Math.abs(O);return{label:`${y}${b.label?` – ${b.label}`:""}`,amount:X,due:R,month:J(R),direction:H,type:"manual",anchor:x,lagDays:Number(b.offsetDays||0)||0,percent:Number(b.percent||0),sourceType:s,sourceNumber:f,sourceId:e.id,id:b.id||`${e.id||s}-pay-${$}`,tooltip:`Fälligkeit: ${x} + ${Number(b.offsetDays||0)} Tage`}})}const h=Ct(e,n),r=h.eur,m=Et(e,h),l=Dt(e,n),D=Array.isArray(e.milestones)?e.milestones:[],P=Yt(e,n,D),v=[];for(const[i,b]of D.entries()){const $=S(b.percent),N=l[b.anchor||"ORDER_DATE"]||l.ORDER_DATE,x=Y(N,Number(b.lagDays||0)),F=b.id||`${e.id||s}-${i}-${b.id||"manual"}`;v.push({label:`${y}${b.label?` – ${b.label}`:""}`,amount:r*($/100),due:x,month:J(x),direction:"out",type:"manual",anchor:b.anchor||"ORDER_DATE",lagDays:Number(b.lagDays||0)||0,percent:$,sourceType:s,sourceNumber:f,sourceId:e.id,id:F,tooltip:`Fälligkeit: ${b.anchor||"ORDER_DATE"} + ${Number(b.lagDays||0)} Tage`})}const z=e.dutyIncludeFreight!==!1,E=S(e.dutyRatePct??n.dutyRatePct??0),C=S(e.eustRatePct??n.eustRatePct??0),U=S(e.fxFeePct??n.fxFeePct??0),G=Number(e.vatRefundLagMonths??n.vatRefundLagMonths??0),W=e.vatRefundEnabled!==!1,Z={};for(const i of P){if(!i||i.enabled===!1)continue;const b=i.anchor||"ETA",$=l[b]||l.ETA;if(!(!($ instanceof Date)||Number.isNaN($.getTime()))){if(i.type==="freight"){const N=Et(e,h);if(!N)continue;const x=i.id||`${e.id||s}-auto-freight`,F=Y($,Number(i.lagDays||0));v.push({label:`${y} – ${i.label||"Fracht"}`,amount:N,due:F,month:J(F),direction:"out",type:"freight",anchor:i.anchor||"ETA",lagDays:Number(i.lagDays||0)||0,sourceType:s,sourceNumber:f,sourceId:e.id,id:x,tooltip:"Frachtkosten laut Eingabe"});continue}if(i.type==="duty"){const N=S(i.percent??E),x=Y($,Number(i.lagDays||0)),R=(r+(z?m:0))*(N/100),O=i.id||`${e.id||s}-auto-duty`;Z.duty={amount:R,due:x},v.push({label:`${y} – ${i.label||"Zoll"}`,amount:R,due:x,month:J(x),direction:"out",type:"duty",anchor:i.anchor||"ETA",lagDays:Number(i.lagDays||0)||0,percent:N,sourceType:s,sourceNumber:f,sourceId:e.id,id:O,tooltip:`Zoll = ${N}% × (Warenwert${z?" + Fracht":""})`});continue}if(i.type==="eust"){const N=S(i.percent??C),x=Math.abs(((q=Z.duty)==null?void 0:q.amount)||0),F=r+m+x,R=Y($,Number(i.lagDays||0)),O=F*(N/100),H=i.id||`${e.id||s}-auto-eust`;Z.eust={amount:O,due:R},v.push({label:`${y} – ${i.label||"EUSt"}`,amount:O,due:R,month:J(R),direction:"out",type:"eust",anchor:i.anchor||"ETA",lagDays:Number(i.lagDays||0)||0,percent:N,sourceType:s,sourceNumber:f,sourceId:e.id,id:H,tooltip:`EUSt = ${N}% × (Warenwert + Fracht + Zoll)`});continue}if(i.type==="vat_refund"){const N=Z.eust;if(!W||!N||N.amount===0)continue;const x=S(i.percent??100),F=Number((i.lagMonths??G)||0),R=Y(N.due||$,Number(i.lagDays||0)),O=St(kt(R,F)),H=Math.abs(N.amount)*(x/100),X=i.id||`${e.id||s}-auto-vat`;v.push({label:`${y} – ${i.label||"EUSt-Erstattung"}`,amount:H,due:O,month:J(O),direction:"in",type:"vat_refund",anchor:i.anchor||"ETA",lagMonths:F,percent:x,sourceType:s,sourceNumber:f,sourceId:e.id,id:X,tooltip:`Erstattung am Monatsende nach ${F} Monaten`});continue}if(i.type==="fx_fee"){const N=S(i.percent??U);if(!N)continue;const x=Y($,Number(i.lagDays||0)),F=r*(N/100),R=i.id||`${e.id||s}-auto-fx`;v.push({label:`${y} – ${i.label||"FX-Gebühr"}`,amount:F,due:x,month:J(x),direction:"out",type:"fx_fee",anchor:i.anchor||"ORDER_DATE",lagDays:Number(i.lagDays||0)||0,percent:N,sourceType:s,sourceNumber:f,sourceId:e.id,id:R,tooltip:`FX-Gebühr = ${N}% × Warenwert`})}}}return v}function Vt(e){var rt,K,ct,ut;const n=e||{},u=n.settings&&n.settings.startMonth||"2025-01",d=Number(n.settings&&n.settings.horizonMonths||12),s=Mt(u,d),f=n.status&&typeof n.status=="object"?n.status:{},y=f.events&&typeof f.events=="object"?f.events:{},h=f.autoManualCheck===!0,r=new Date;r.setHours(0,0,0,0);const m=r.getTime(),l={};s.forEach(t=>{l[t]={entries:[]}});function D(t,a){l[t]&&l[t].entries.push(a)}function P(t,a={}){const o=t.id||`${t.month||""}-${t.label||""}-${t.date||""}`,c=y[o],g=t.date?new Date(t.date):null,M=g&&Number.isFinite(g.getTime())?new Date(g.getFullYear(),g.getMonth(),g.getDate()).getTime():null,T=a.auto===!0,L=T&&a.autoEligible!==!1,V=typeof t.paid=="boolean"?t.paid:!!a.defaultPaid,nt=xt({statusRecord:c,autoEligible:L,autoManualCheck:h,entryTime:M,todayTime:m,defaultPaid:V});return{id:o,direction:t.direction||"in",amount:Math.abs(t.amount||0),label:t.label||"",month:t.month,date:t.date,kind:t.kind,group:t.group,paid:nt.paid,source:t.source||null,anchor:t.anchor,lagDays:t.lagDays,lagMonths:t.lagMonths,percent:t.percent,scenarioDelta:t.scenarioDelta||0,scenarioAmount:t.scenarioAmount||t.amount||0,meta:t.meta||{},tooltip:t.tooltip,sourceTab:t.sourceTab,sourceNumber:t.sourceNumber,sourceId:t.sourceId,statusId:o,auto:T,autoEligible:L,autoApplied:nt.autoApplied,autoManualCheck:h,manualOverride:nt.manualOverride,autoSuppressed:nt.autoSuppressed,autoTooltip:nt.autoTooltip}}Bt(n,{months:s,statusEvents:y,autoManualCheck:h,today:r}).map(t=>({id:t.id,direction:"out",amount:t.amount,label:t.label,month:t.month,date:t.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:t.fixedCostId,category:t.category,override:t.overrideActive,overrideAmount:t.override.amount,overrideDueDate:t.override.dueDate,overrideNote:t.override.note,notes:t.notes,baseAmount:t.baseAmount,prorationApplied:t.prorationApplied},tooltip:t.tooltip,auto:t.autoPaid,autoEligible:t.autoPaid})).forEach(t=>{D(t.month,P(t,{auto:t.auto,autoEligible:t.autoEligible}))});const z=!!((K=(rt=n==null?void 0:n.forecast)==null?void 0:rt.settings)!=null&&K.useForecast),E={},C={},U={};if(z){(ct=n==null?void 0:n.forecast)!=null&&ct.forecastImport&&typeof n.forecast.forecastImport=="object"?Object.values(n.forecast.forecastImport).forEach(a=>{Object.entries(a||{}).forEach(([o,c])=>{if(!o||!l[o])return;const g=A((c==null?void 0:c.revenueEur)??(c==null?void 0:c.revenue)??null);Number.isFinite(g)&&(E[o]=(E[o]||0)+g)})}):Array.isArray((ut=n==null?void 0:n.forecast)==null?void 0:ut.items)&&n.forecast.items.forEach(a=>{if(!a||!a.month||!a.sku)return;const o=a.month;if(!l[o])return;const c=Number(a.qty??a.quantity??0)||0,g=A(a.priceEur??a.price??0),M=c*g;E[o]=(E[o]||0)+M});const t=Rt({state:n,months:s});Object.entries(t||{}).forEach(([a,o])=>{if(!l[a])return;const c=A(o);Number.isFinite(c)&&(C[a]=(C[a]||0)+c)}),Object.keys(l).forEach(a=>{U[a]=(E[a]||0)+(C[a]||0)})}const G={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(G[t.month]=t.payoutPct)});const W={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(W[t.month]=A(t.revenueEur))}),Object.keys(l).forEach(t=>{const a=z?U[t]||0:W[t];if(typeof a>"u")return;const o=S(G[t]||0),c=gt(t);if(!z){const V=a*(o/100);D(t,P({id:`sales-${t}`,direction:V>=0?"in":"out",amount:Math.abs(V),label:"Amazon Payout",month:t,date:w(c),kind:"sales-payout",group:V>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#eingaben"},{auto:!1}));return}const g=E[t]||0,M=C[t]||0,T=g*(o/100),L=M*(o/100);Math.abs(T)>1e-6&&D(t,P({id:`sales-live-${t}`,direction:T>=0?"in":"out",amount:Math.abs(T),label:"Amazon Payout (Prognose - Live/CSV)",month:t,date:w(c),kind:"sales-payout",group:T>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#forecast"},{auto:!1})),Math.abs(L)>1e-6&&D(t,P({id:`sales-plan-${t}`,direction:L>=0?"in":"out",amount:Math.abs(L),label:"Amazon Payout (Prognose - Plan)",month:t,date:w(c),kind:"sales-payout",group:L>=0?"Sales × Payout":"Extras (Out)",source:"sales-plan",sourceTab:"#forecast"},{auto:!1}))}),(Array.isArray(n.extras)?n.extras:[]).forEach(t=>{const a=t.month||(t.date?J(t.date):null);if(!a||!l[a])return;const o=A(t.amountEur),c=o>=0?"in":"out",g=a,M=t.date?new Date(t.date):gt(g);D(g,P({id:`extra-${t.id||t.label||g}-${t.date||""}`,direction:c,amount:Math.abs(o),label:t.label||"Extra",month:g,date:w(M),kind:"extra",group:c==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:t.autoPaid===!0,autoEligible:t.autoPaid===!0}))}),(Array.isArray(n.dividends)?n.dividends:[]).forEach(t=>{const a=t.month||(t.date?J(t.date):null);if(!a||!l[a])return;const o=A(t.amountEur),c=t.date?new Date(t.date):gt(a);D(a,P({id:`div-${t.id||t.label||a}`,direction:o>=0?"out":"in",amount:Math.abs(o),label:t.label||"Dividende",month:a,date:w(c),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))});const Z=zt(n.settings);(Array.isArray(n.pos)?n.pos:[]).forEach(t=>{Nt(t,Z,"PO","poNo").forEach(a=>{const o=a.month;if(!l[o])return;const c=a.type==="manual"?"po":a.type==="vat_refund"?"po-refund":"po-import",g=c==="po"?"PO/FO-Zahlungen":"Importkosten";D(o,P({id:a.id||`po-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:o,date:w(a.due),kind:c,group:g,source:"po",sourceTab:"#po",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.poNo||t.id,sourceId:t.id||t.poNo||null,tooltip:a.tooltip},{auto:a.type!=="manual",autoEligible:a.type!=="manual"}))})}),(Array.isArray(n.fos)?n.fos:[]).forEach(t=>{jt(t==null?void 0:t.status)&&Nt(t,Z,"FO","foNo").forEach(a=>{const o=a.month;if(!l[o])return;const c=a.type==="manual"?"fo":a.type==="vat_refund"?"fo-refund":"fo-import",g=c==="fo"?"PO/FO-Zahlungen":"Importkosten";D(o,P({id:a.id||`fo-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:o,date:w(a.due),kind:c,group:g,source:"fo",sourceTab:"#fo",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.foNo||t.foNumber||t.id,sourceId:t.id||t.foNo||t.foNumber||null,tooltip:a.tooltip},{auto:!1,autoEligible:!1,defaultPaid:!1}))})});const q=s.map(t=>{const o=l[t].entries||[],c=o.filter(p=>p.direction==="in"),g=o.filter(p=>p.direction==="out"),M=g.filter(p=>p.group==="Fixkosten"),T=M.reduce((p,B)=>p+(B.amount||0),0),L=M.filter(p=>p.paid).reduce((p,B)=>p+(B.amount||0),0),V=Math.max(0,T-L),nt=M.slice().sort((p,B)=>(B.amount||0)-(p.amount||0)).slice(0,3).map(p=>({label:p.label,amount:p.amount,paid:p.paid,category:p.meta&&p.meta.category?p.meta.category:null})),ft=c.reduce((p,B)=>p+(B.amount||0),0),pt=g.reduce((p,B)=>p+(B.amount||0),0),ht=c.filter(p=>p.paid).reduce((p,B)=>p+(B.amount||0),0),mt=g.filter(p=>p.paid).reduce((p,B)=>p+(B.amount||0),0),Tt=Math.max(0,ft-ht),Pt=Math.max(0,pt-mt),bt=ft-pt,yt=ht-mt,Ft=bt-yt;return{month:t,inflow:{total:ft,paid:ht,open:Tt},outflow:{total:pt,paid:mt,open:Pt},net:{total:bt,paid:yt,open:Ft},fixcost:{total:T,paid:L,open:V,top:nt},itemsIn:c.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),itemsOut:g.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),entries:o}}),i=A(n.settings&&n.settings.openingBalance),b=q.map(t=>t.itemsIn.filter(a=>a.kind==="sales-payout").reduce((a,o)=>a+o.amount,0)),$=b.length?b.reduce((t,a)=>t+a,0)/(b.filter(t=>t>0).length||1):0,N={},x={};Object.keys(l).forEach(t=>{const a=z?U[t]||0:W[t],o=S(G[t]||0);N[t]=a,x[t]=a*(o/100)});const F={opening:i,openingToday:i,salesPayoutAvg:$,avgSalesPayout:$,firstNegativeMonth:null,actuals:{}},R=(t,a=A)=>{if(t==null)return null;if(typeof t=="number")return Number.isFinite(t)?t:null;const o=String(t).trim();if(!o)return null;const c=a(o);return Number.isFinite(c)?c:null},O=new Map,H=n!=null&&n.monthlyActuals&&typeof n.monthlyActuals=="object"?n.monthlyActuals:{},X=Object.entries(H);X.length?X.forEach(([t,a])=>{if(!t)return;const o=R(a==null?void 0:a.realRevenueEUR,A),c=R(a==null?void 0:a.realPayoutRatePct,S),g=R(a==null?void 0:a.realClosingBalanceEUR,A),M={};Number.isFinite(o)&&(M.revenue=o),Number.isFinite(o)&&Number.isFinite(c)&&(M.payout=o*(c/100)),Number.isFinite(g)&&(M.closing=g),Object.keys(M).length&&O.set(t,M)}):(Array.isArray(n.actuals)?n.actuals:[]).forEach(a=>{if(!a||!a.month)return;const o=a.month,c=R(a.revenueEur,A),g=R(a.payoutEur,A),M=R(a.closingBalanceEur,A),T={};Number.isFinite(c)&&(T.revenue=c),Number.isFinite(g)&&(T.payout=g),Number.isFinite(M)&&(T.closing=M),Object.keys(T).length&&O.set(o,T)});let _=i;const tt=s.map((t,a)=>{const o=q[a],c=_;return _+=o.net.total,{month:t,opening:c,closing:_,inflow:o.inflow.total,outflow:o.outflow.total,net:o.net.total,entries:o.entries}});let lt=i;const st=s.map((t,a)=>{var V;const o=q[a],c=lt,g=c+o.net.total,M=(V=O.get(t))==null?void 0:V.closing,T=Number.isFinite(M),L=T?Number(M):g;return lt=L,{month:t,opening:c,closing:L,inflow:o.inflow.total,outflow:o.outflow.total,net:o.net.total,entries:o.entries,plannedClosing:g,actualClosing:T?Number(M):null}}),j=st.find(t=>Number(t.closing||0)<0);F.firstNegativeMonth=j?j.month:null;const I=[];O.forEach((t,a)=>{const o=s.indexOf(a);if(o===-1)return;const c=o>=0&&o<tt.length?tt[o]:null,g=c?c.closing:null,M=N[a]??null,T=x[a]??null;I.push({month:a,plannedRevenue:M,actualRevenue:t.revenue,revenueDelta:(t.revenue??0)-(M??0),revenueDeltaPct:M?((t.revenue??0)-M)/M*100:null,plannedPayout:T,actualPayout:t.payout,payoutDelta:(t.payout??0)-(T??0),payoutDeltaPct:T?((t.payout??0)-T)/T*100:null,plannedClosing:g,actualClosing:t.closing,closingDelta:(t.closing??0)-(g??0)})}),I.sort((t,a)=>(t.month||"").localeCompare(a.month||""));const k=I[I.length-1]||null,Q=I.map(t=>t.revenueDeltaPct).filter(t=>Number.isFinite(t)),et=I.map(t=>t.payoutDeltaPct).filter(t=>Number.isFinite(t)),it=Q.length?Q.reduce((t,a)=>t+a,0)/Q.length:null,dt=et.length?et.reduce((t,a)=>t+a,0)/et.length:null;return F.actuals={count:I.length,lastMonth:k?k.month:null,lastClosing:k?k.actualClosing:null,closingDelta:k?k.closingDelta:null,revenueDeltaPct:k?k.revenueDeltaPct:null,payoutDeltaPct:k?k.payoutDeltaPct:null,avgRevenueDeltaPct:it,avgPayoutDeltaPct:dt},{startMonth:u,horizon:d,months:s,series:q,kpis:F,breakdown:st,actualComparisons:I}}export{Vt as c,Bt as e,qt as f,A as p};
