import{t as p,k as s,J as $,M as D}from"./index-CAzQztwo.js";import{m as k,f as _,n as F}from"./months-DiLwPhVv.js";import{u as v,C as f}from"./workspace-xr5uOuIo.js";import"./Dropdown-CZlZd-6U.js";const{Paragraph:y,Title:b}=$,w=24*60*60*1e3;function x(e,r){if(!e)return r?new Date(r):null;const t=new Date(String(e));return Number.isNaN(t.getTime())?r?new Date(r):null:t}function N(e,r){const t=new Date(e.getTime());return t.setDate(t.getDate()+Number(r||0)),t}function E(e){if(typeof e=="number")return Number.isFinite(e)?e:0;const r=String(e||"").trim().replace(/€/g,"").replace(/\s+/g,"").replace(/\./g,"").replace(",","."),t=Number(r);return Number.isFinite(t)?t:0}function T(e){if(typeof e=="number")return Number.isFinite(e)?e:0;const r=Number(String(e||"").trim().replace(",","."));return Number.isFinite(r)?r:0}function L(e){return!Number.isFinite(e)||e<0?0:e>100?100:Math.round(e*10)/10}function j(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?"—":e.toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit"})}function O(e){return e.toLocaleString("de-DE",{style:"currency",currency:"EUR"})}function V(e){const r=(Array.isArray(e.pos)?e.pos:[]).map((a,i)=>{const n=a||{};return{id:String(n.id||`po-${i}`),type:"PO",poNo:String(n.poNo||""),foNo:"",orderDate:String(n.orderDate||""),prodDays:Number(n.prodDays||0)||0,transitDays:Number(n.transitDays||0)||0,etdLagDays:Number(n.etdLagDays||0)||0,goodsValue:E(n.goodsEur??n.goodsValueEur??n.goodsValueUsd),milestones:Array.isArray(n.milestones)?n.milestones:[]}}),t=(Array.isArray(e.fos)?e.fos:[]).map((a,i)=>{const n=a||{};return{id:String(n.id||`fo-${i}`),type:"FO",poNo:String(n.convertedPoNo||""),foNo:String(n.foNo||n.foNumber||""),orderDate:String(n.orderDate||""),prodDays:Number(n.prodDays||0)||0,transitDays:Number(n.transitDays||0)||0,etdLagDays:Number(n.etdLagDays||0)||0,goodsValue:E(n.goodsEur??n.goodsValueEur??n.goodsValueUsd),milestones:Array.isArray(n.milestones)?n.milestones:[]}});return[...r,...t].sort((a,i)=>{const n=x(a.orderDate,new Date(864e13)),l=x(i.orderDate,new Date(864e13));return((n==null?void 0:n.getTime())||0)-((l==null?void 0:l.getTime())||0)})}function z(e,r){const t=e.settings||{},a=F(t.startMonth);if(a)return a;const i=r.map(n=>n.orderDate).filter(n=>/^\d{4}-\d{2}-\d{2}$/.test(n)).sort()[0];return i?i.slice(0,7):new Date().toISOString().slice(0,7)}function I(e){const r=e.settings||{},t=Number(r.horizonMonths||0);return!Number.isFinite(t)||t<=0?12:Math.round(t)}function B(e){const r=x(e.orderDate,new Date)||new Date,t=N(r,e.prodDays),a=N(t,e.etdLagDays),i=N(t,e.transitDays);return{ORDER_DATE:r,PROD_DONE:t,ETD:a,ETA:i}}function H(e,r){const t=String(r.anchor||"ORDER_DATE"),a=e[t]||e.ORDER_DATE;return N(a,Number(r.lagDays||0)||0)}function h(e,r){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return 0;const a=(Math.min(Math.max(e.getTime(),r.startMs),r.endMs)-r.startMs)/w;return Math.max(0,Math.min(100,a/r.totalDays*100))}function U(e,r){return e.map(t=>{const a=B(t),i=[];if(a.PROD_DONE>a.ORDER_DATE){const o=h(a.ORDER_DATE,r),d=Math.max(.75,h(a.PROD_DONE,r)-o);i.push({key:`${t.id}-production`,cls:"production",label:"Produktion",left:o,width:d})}if(a.ETA>a.PROD_DONE){const o=h(a.PROD_DONE,r),d=Math.max(.75,h(a.ETA,r)-o);i.push({key:`${t.id}-transit`,cls:"transit",label:"Transit",left:o,width:d})}const n=t.milestones.reduce((o,d)=>o+T(d.percent),0),l=Math.round(n*10)/10,u=Math.abs(l-100)>.1,m=t.milestones.map((o,d)=>{const M=H(a,o),P=h(M,r),S=L(T(o.percent)),R=t.goodsValue*(S/100),A=`${String(o.label||"Milestone")} - ${j(M)} - ${O(R)}`;return{key:`${t.id}-${String(o.id||d)}`,left:P,title:A}}),g=t.type==="FO"?t.foNo||"FO":t.poNo||"PO",c=[`Order ${j(a.ORDER_DATE)}`,`ETA ${j(a.ETA)}`];return t.goodsValue>0&&c.push(O(t.goodsValue)),{id:t.id,type:t.type,label:g,warn:u,warnText:`Meilensteine summieren sich auf ${l}%`,subtitle:c.join(" | "),phases:i,markers:m}})}function J(){const{state:e,loading:r,error:t}=v(),a=e,i=p.useMemo(()=>V(a),[e]),n=p.useMemo(()=>z(a,i),[i,e]),l=p.useMemo(()=>I(a),[e]),u=p.useMemo(()=>k(n,l),[l,n]),m=p.useMemo(()=>{if(!u.length)return null;const c=`${u[0]}-01`,o=x(c,new Date);if(!o)return null;const d=new Date(o.getTime());return d.setMonth(d.getMonth()+l),{startMs:o.getTime(),endMs:d.getTime(),totalDays:Math.max(1,(d.getTime()-o.getTime())/w)}},[l,u]),g=p.useMemo(()=>m?U(i,m):[],[i,m]);return s.jsxs("div",{className:"v2-page",children:[s.jsx(f,{className:"v2-intro-card",children:s.jsx("div",{className:"v2-page-head",children:s.jsxs("div",{children:[s.jsx(b,{level:3,children:"Plan"}),s.jsx(y,{children:"Zeitplan der aktiven Purchase und Forecast Orders mit Produktions-/Transitphasen und Payment-Milestones."})]})})}),t?s.jsx(D,{type:"error",showIcon:!0,message:t}):null,r?s.jsx(D,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,i.length?null:s.jsx(f,{children:s.jsx(D,{type:"info",showIcon:!0,message:"Noch keine POs oder FOs erfasst.",description:"Lege zuerst Bestellungen in den entsprechenden Modulen an."})}),i.length>0&&!m?s.jsx(f,{children:s.jsx(D,{type:"warning",showIcon:!0,message:"Zeitraum konnte nicht berechnet werden.",description:"Bitte pruefe Startmonat/Horizont in den Settings."})}):null,m?s.jsxs(f,{className:"plan-card",children:[s.jsx(b,{level:4,children:"Plan"}),s.jsxs(y,{children:["Start: ",s.jsx("strong",{children:n})," | Horizont: ",s.jsx("strong",{children:l})," Monate | Eintraege: ",s.jsx("strong",{children:g.length})]}),s.jsxs("div",{className:"plan-grid",style:{"--plan-cols":u.length},children:[s.jsxs("div",{className:"plan-months",children:[s.jsx("div",{className:"plan-month head"}),u.map(c=>s.jsx("div",{className:"plan-month",children:_(c)},c))]}),s.jsx("div",{className:"plan-rows",children:g.map(c=>s.jsxs("div",{className:`plan-row${c.warn?" warn":""}`,children:[s.jsxs("div",{className:"plan-label",children:[s.jsxs("div",{className:"plan-title",children:[c.type," | ",c.label,c.warn?s.jsx("span",{className:"plan-alert",title:c.warnText,children:"!"}):null]}),s.jsx("div",{className:"plan-meta",children:c.subtitle})]}),s.jsxs("div",{className:"plan-track",children:[c.phases.map(o=>s.jsx("div",{className:`plan-phase ${o.cls}`,style:{left:`${o.left}%`,width:`${o.width}%`},title:o.label},o.key)),c.markers.map(o=>s.jsx("div",{className:"plan-marker",style:{left:`${o.left}%`},title:o.title,children:s.jsx("span",{})},o.key))]})]},c.id))})]}),s.jsxs("div",{className:"plan-legend",children:[s.jsxs("span",{children:[s.jsx("span",{className:"legend-box production"})," Produktion"]}),s.jsxs("span",{children:[s.jsx("span",{className:"legend-box transit"})," Transit"]}),s.jsxs("span",{children:[s.jsx("span",{className:"legend-dot"})," Zahlung (Milestone)"]})]}),s.jsx(y,{type:"secondary",style:{marginBottom:0},children:"Reihen mit ! markieren Milestone-Summen ungleich 100%."})]}):null]})}export{J as default};
