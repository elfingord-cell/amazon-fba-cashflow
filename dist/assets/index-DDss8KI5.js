import{L as Ot,t as m,k as e,J as Lt,M as h,S as D,N as U,I as dt,T as V,a9 as me,p as Ht,W as Kt}from"./index-Bu80Uwbp.js";import{C as Ne,n as Je,d as _t,e as Wt,c as Qe,a as Ee,b as Re,p as Gt,f as qt}from"./cashInRules-r9rlv23d.js";import{c as Q,m as xt,f as G,a as $e}from"./months-DiLwPhVv.js";import{c as Vt,d as Xt,n as Jt,e as Yt}from"./tableModels-DxjFmPmo.js";import{u as Zt,C as X}from"./workspace-CCwvBxSI.js";import{u as Y}from"./orderUtils-BspxdtGU.js";import{D as T}from"./DeNumberInput-DQCzJE4i.js";import"./productCompletenessV2-CGpzck-p.js";import"./planProducts-D4fZPYls.js";import"./Dropdown-Dn3rrflu.js";import"./foSuggestion-Ck1952gl.js";import"./index-C0GAWedD.js";import"./DownOutlined-DBjqZVAX.js";const{Paragraph:ht,Text:x,Title:J}=Lt,wt=3;function en(a){return a instanceof HTMLElement?!!(a.matches("input:not([type='hidden']), textarea, [contenteditable='true']")||a.closest(".ant-select, .ant-picker, .ant-input-number")):!1}function mt(a){return/^\d{4}-\d{2}$/.test(String(a||"").trim())}function r(a){if(a==null||a==="")return null;if(typeof a=="number")return Number.isFinite(a)?a:null;const u=Ht(a);return Number.isFinite(u)?Number(u):null}function te(a,u=Q()){const p=String(a||"").trim();return/^\d{4}-\d{2}$/.test(p)?p:u}function tn(a,u){const p=String(a.calibrationCutoffDate||"").trim(),o=/^\d{4}-\d{2}-\d{2}$/.test(p)?p:null;return{id:String(a.id||Y("inc")),month:te(a.month,u),revenueEur:r(a.revenueEur),payoutPct:r(a.payoutPct),source:String(a.source||"manual")==="forecast"?"forecast":"manual",calibrationCutoffDate:o,calibrationRevenueToDateEur:r(a.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(a.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(a.calibrationSellerboardMonthEndEur)}}function $(a){return a.slice().sort((u,p)=>u.month===p.month?u.id.localeCompare(p.id):u.month.localeCompare(p.month))}function Ue(a,u,p){const o=xt(u,Math.max(1,Math.round(p||1))),R=new Set(o),L=new Map;return $(a).forEach(M=>{R.has(M.month)&&L.set(M.month,{...M,id:M.id||Y("inc"),source:M.source==="forecast"?"forecast":"manual",revenueEur:r(M.revenueEur),payoutPct:r(M.payoutPct),calibrationCutoffDate:M.calibrationCutoffDate?String(M.calibrationCutoffDate):null,calibrationRevenueToDateEur:r(M.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(M.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(M.calibrationSellerboardMonthEndEur)})}),$(Array.from(L.values()))}function b(a,u=2){const p=Number(a);return Number.isFinite(p)?p.toLocaleString("de-DE",{minimumFractionDigits:u,maximumFractionDigits:u}):"—"}function ne(a){const u=Number(a);return Number.isFinite(u)?u.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function j(a){const u=Gt(a);return Number.isFinite(u)?Qe(Number(u),Re,Ee):null}function Te(a){const u=r(a);return Number.isFinite(u)?Math.max(0,Number(u)):null}function nn(a,u,p){const o=Math.max(1,Math.round(Number(p||1))),R=[];for(let L=0;L<o;L+=1){const M=$e(a,L),ae=qt(u,o,L);R.push(`${G(M)}: ${ne(ae)}`)}return R.push(`ab ${G($e(a,o))}: 1,00`),R.join(" · ")}function an(a){return Number.isFinite(a)?`${a>0?"+":""}${a.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}`:""}function bt(a){return Number.isFinite(a)?`${a>0?"+":""}${b(a,2)} EUR`:"0,00 EUR"}function Xe(a){const u=j(a.cashInRecommendationBaselineNormalPct)??Ne,p=j(a.cashInRecommendationBaselineQ4Pct);return JSON.stringify({openingBalance:Number(a.openingBalance||0),startMonth:String(a.startMonth||""),horizonMonths:Math.max(1,Math.round(Number(a.horizonMonths||1))),cashInCalibrationEnabled:a.cashInCalibrationEnabled!==!1,cashInCalibrationHorizonMonths:Je(a.cashInCalibrationHorizonMonths,6),cashInRecommendationIgnoreQ4:a.cashInRecommendationIgnoreQ4===!0,cashInRecommendationBaselineNormalPct:u,cashInRecommendationBaselineQ4Pct:p,incomings:$(a.incomings).map(o=>({id:String(o.id||""),month:String(o.month||""),revenueEur:r(o.revenueEur),payoutPct:r(o.payoutPct),source:o.source==="forecast"?"forecast":"manual",calibrationCutoffDate:o.calibrationCutoffDate?String(o.calibrationCutoffDate):null,calibrationRevenueToDateEur:r(o.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:r(o.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:r(o.calibrationSellerboardMonthEndEur)})),extras:a.extras.slice().sort((o,R)=>o.id.localeCompare(R.id)).map(o=>({id:String(o.id||""),date:String(o.date||""),label:String(o.label||""),amountEur:r(o.amountEur)})),dividends:a.dividends.slice().sort((o,R)=>o.month===R.month?o.id.localeCompare(R.id):o.month.localeCompare(R.month)).map(o=>({id:String(o.id||""),month:String(o.month||""),label:String(o.label||""),amountEur:r(o.amountEur)})),monthlyActuals:a.monthlyActuals.slice().sort((o,R)=>o.month.localeCompare(R.month)).map(o=>({month:String(o.month||""),realRevenueEUR:r(o.realRevenueEUR),realPayoutRatePct:r(o.realPayoutRatePct),realClosingBalanceEUR:r(o.realClosingBalanceEUR)}))})}function fn(){var rt,ot;const{state:a,loading:u,saving:p,error:o,lastSavedAt:R,saveWith:L}=Zt(),M=Ot(),[ae,Ye]=m.useState(0),[B,Ze]=m.useState(Q()),[O,Oe]=m.useState(18),[v,gt]=m.useState(!0),[H,jt]=m.useState(6),[K,pt]=m.useState(!1),[ie,ft]=m.useState(Ne),[se,vt]=m.useState(null),[A,q]=m.useState([]),[Pe,re]=m.useState([]),[Ce,oe]=m.useState([]),[le,Z]=m.useState([]),[Le,Se]=m.useState(!1),[we,He]=m.useState(""),ce=m.useRef(null),Ie=m.useRef(""),Ke=m.useRef(!0),_=m.useMemo(()=>xt(B,Math.max(1,Math.round(O||1))),[O,B]),yt=a.settings&&typeof a.settings=="object"?a.settings:{},_e=a.forecast&&typeof a.forecast=="object"?a.forecast:{},Mt=(_e.settings&&typeof _e.settings=="object"?_e.settings:{}).useForecast===!0,Nt=String(yt.cashInMode||"").trim().toLowerCase()==="basis"?"basis":"conservative",ue=m.useMemo(()=>{const t=a,n=Vt(t),i=Xt(t,n),s=a.forecast||{},c=s.forecastImport||{},d=Jt(s.forecastManual||{});return Yt({allMonths:_,products:i,manualDraft:d,forecastImport:c})},[_,a]);m.useEffect(()=>{const t=a.settings||{},n=Number(r(t.openingBalance)||0),i=te(t.startMonth,Q()),s=Math.max(1,Math.round(Number(t.horizonMonths||18)||18)),c=t.cashInCalibrationEnabled!==!1,d=Je(t.cashInCalibrationHorizonMonths,6),y=t.cashInRecommendationIgnoreQ4===!0,S=j(t.cashInRecommendationBaselineNormalPct)??Ne,l=j(t.cashInRecommendationBaselineQ4Pct),f=(Array.isArray(a.incomings)?a.incomings:[]).map(F=>tn(F,i)),I=Ue(f,i,s),z=(Array.isArray(a.extras)?a.extras:[]).map(F=>{const g=F;return{id:String(g.id||Y("extra")),date:String(g.date||""),label:String(g.label||"Extra"),amountEur:r(g.amountEur)}}),W=(Array.isArray(a.dividends)?a.dividends:[]).map(F=>{const g=F;return{id:String(g.id||Y("div")),month:te(g.month,i),label:String(g.label||"Dividende"),amountEur:r(g.amountEur)}}),k=a.monthlyActuals&&typeof a.monthlyActuals=="object"?a.monthlyActuals:{},P=Object.entries(k).map(([F,g])=>({month:te(F,Q()),realRevenueEUR:r(g.realRevenueEUR),realPayoutRatePct:r(g.realPayoutRatePct),realClosingBalanceEUR:r(g.realClosingBalanceEUR)})).sort((F,g)=>F.month.localeCompare(g.month));Ke.current=!0,Ye(n),Ze(i),Oe(s),gt(c),jt(d),pt(y),ft(S),vt(l),q(I),re(z),oe(W),Z(P),Ie.current=Xe({openingBalance:n,startMonth:i,horizonMonths:s,cashInCalibrationEnabled:c,cashInCalibrationHorizonMonths:d,cashInRecommendationIgnoreQ4:y,cashInRecommendationBaselineNormalPct:S,cashInRecommendationBaselineQ4Pct:l,incomings:I,extras:z,dividends:W,monthlyActuals:P}),Se(!1),He("")},[a.dividends,a.extras,a.incomings,a.monthlyActuals,a.settings]),m.useEffect(()=>()=>{ce.current!=null&&window.clearTimeout(ce.current)},[]);const et=m.useMemo(()=>{const t={};return _.forEach(n=>{t[n]=Number(ue.get(n)||0)}),t},[ue,_]),N=m.useMemo(()=>{const t={};return le.forEach(n=>{if(!mt(n.month))return;const i=r(n.realRevenueEUR),s=r(n.realPayoutRatePct),c={};Number.isFinite(i)&&(c.realRevenueEUR=Number(i)),Number.isFinite(s)&&(c.realPayoutRatePct=Number(s)),Object.keys(c).length&&(t[n.month]=c)}),_t({months:_,incomings:A,monthlyActuals:t,currentMonth:Q(),ignoreQ4:K,maxMonth:Q(),baselineNormalPct:ie,baselineQ4Pct:se,minSamples:4})},[ie,se,K,A,le,_]),be=m.useMemo(()=>{const t=new Map;return A.forEach(n=>{var s;const i=(s=N.byMonth)==null?void 0:s[n.month];!i||!Number.isFinite(Number(i.quotePct))||t.set(n.month,i)}),t},[A,N.byMonth]),xe=j(N.baselineNormalPct)??Ne,Fe=j(N.baselineQ4Pct)??xe,We=j(N.baselineQ4SuggestedPct)??xe,ke=j(N.currentMonthForecastQuotePct),Et=Math.max(0,Math.round(Number(N.observedNormalSampleCount||0))),Rt=j(N.observedNormalMedianPct),Pt=j(N.observedNormalAveragePct),Ct=Math.max(0,Math.round(Number(N.observedNormalWithForecastSampleCount||0))),St=j(N.observedNormalWithForecastMedianPct),It=j(N.observedNormalWithForecastAveragePct),tt=Array.isArray(N.usedMonths)?N.usedMonths:[],Ft=tt.length?tt.map(t=>G(t)).join(", "):"keine",kt=[`Normal Baseline (manuell): ${b(xe,1)}%`,`Q4 Baseline (aktiv): ${b(Fe,1)}%`,`Q4 Vorschlag: ${b(We,1)}%`,`Observed IST normal (n=${Et}): Median ${b(Rt,1)}%, Ø ${b(Pt,1)}%`,`Observed normal inkl. Prognose (n=${Ct}): Median ${b(St,1)}%, Ø ${b(It,1)}%`,`Genutzte IST-Monate: ${Ft}`,`Q4 ignorieren: ${K?"ja":"nein"}`].join(" | "),E=Q(),De=_.includes(E),ge=Number(ue.get(E)||0),C=m.useMemo(()=>$(A).find(t=>t.month===E)||null,[E,A]),Dt=r(C==null?void 0:C.calibrationSellerboardMonthEndEur),nt=r(C==null?void 0:C.calibrationPayoutRateToDatePct),je=m.useMemo(()=>Wt({incomings:v&&C?[C]:[],months:_,forecastRevenueByMonth:et,horizonMonths:H}),[v,H,C,et,_]),Ge=je.candidates.find(t=>t.month===E)||null,w=Number(Ge==null?void 0:Ge.rawFactor),Ae=Number(((ot=(rt=je.byMonth)==null?void 0:rt[E])==null?void 0:ot.factor)||1),at=ge*(Number.isFinite(Ae)?Ae:1),it=m.useMemo(()=>{const t=j(C==null?void 0:C.payoutPct);if(Number.isFinite(t))return Number(t);const n=be.get(E),i=Number(n==null?void 0:n.quotePct);return Number.isFinite(i)?Qe(i,Re,Ee):null},[C==null?void 0:C.payoutPct,E,be]),At=Number.isFinite(it)?at*(Number(it)/100):null,zt=Number.isFinite(w)&&(w>1.25||w<.5),Bt=Number.isFinite(w)&&v?["Kalibrierung ueber Umsatzprognose Monatsende.",`Startfaktor ${E}: ${ne(w)}`,`Fade-Out über ${H} Monate: ${nn(E,w,H)}`].join(" | "):v?"Kalibrierfaktor wird berechnet, sobald die Umsatzprognose Monatsende im aktuellen Monat gesetzt ist und Forecast-Umsatz > 0 ist.":"Kalibrierung ist deaktiviert.",pe=m.useMemo(()=>{let t=0,n=0,i=0,s=0,c=0;$(A).forEach(S=>{var fe,Be;const l=String(S.month||""),f=Number(ue.get(l)||0),I=v?Number(((Be=(fe=je.byMonth)==null?void 0:fe[l])==null?void 0:Be.factor)||1):1,z=Number.isFinite(I)?I:1,W=r(S.revenueEur),k=S.source==="manual"&&Number.isFinite(f)&&f>0,P=k?Number(W||0):f,F=k?P:f*z;t+=Number(P||0),n+=Number(F||0),!k&&Math.abs(z-1)>1e-6&&(c+=1);const g=j(S.payoutPct),de=be.get(l),ze=Number(de==null?void 0:de.quotePct),he=Number.isFinite(g)?Number(g):Number.isFinite(ze)?Qe(ze,Re,Ee):null;Number.isFinite(he)&&(i+=Number(P||0)*(Number(he)/100),s+=Number(F||0)*(Number(he)/100))});const d=v?n-t:0,y=v?s-i:0;return{revenueDelta:d,payoutDelta:y,affectedMonths:c}},[v,je.byMonth,ue,A,be]);function st(t){q(n=>{var c,d;const i=n.findIndex(y=>y.month===E);if(i>=0){const y=[...n];return y[i]={...y[i],...t},$(y)}if(!De)return n;const s={id:Y("inc"),month:E,revenueEur:Number.isFinite(ge)?ge:0,payoutPct:j((d=(c=N.byMonth)==null?void 0:c[E])==null?void 0:d.quotePct),source:ge>0?"forecast":"manual",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null,...t};return $([...n,s])})}async function Ut(t){const n=Ue(A,B,O),i={openingBalance:ae,startMonth:B,horizonMonths:O,cashInCalibrationEnabled:v,cashInCalibrationHorizonMonths:H,cashInRecommendationIgnoreQ4:K,cashInRecommendationBaselineNormalPct:ie,cashInRecommendationBaselineQ4Pct:se,incomings:n,extras:Pe,dividends:Ce,monthlyActuals:le},s=Xe(i);if(s===Ie.current){Se(!1);return}await L(c=>{const d=Kt(c),y=d.settings||{};d.settings={...y,openingBalance:Number(i.openingBalance||0),startMonth:i.startMonth,horizonMonths:Math.max(1,Math.round(i.horizonMonths||1)),cashInCalibrationEnabled:i.cashInCalibrationEnabled!==!1,cashInCalibrationHorizonMonths:Je(i.cashInCalibrationHorizonMonths,6),cashInRecommendationIgnoreQ4:i.cashInRecommendationIgnoreQ4===!0,cashInRecommendationBaselineNormalPct:j(i.cashInRecommendationBaselineNormalPct)??Ne,cashInRecommendationBaselineQ4Pct:j(i.cashInRecommendationBaselineQ4Pct),lastUpdatedAt:new Date().toISOString()},d.incomings=$(i.incomings).map(l=>({id:l.id,month:l.month,revenueEur:r(l.revenueEur),payoutPct:j(l.payoutPct),source:l.source,calibrationCutoffDate:l.calibrationCutoffDate||null,calibrationRevenueToDateEur:r(l.calibrationRevenueToDateEur),calibrationPayoutRateToDatePct:Te(l.calibrationPayoutRateToDatePct),calibrationSellerboardMonthEndEur:Te(l.calibrationSellerboardMonthEndEur)})),d.extras=i.extras.map(l=>({id:l.id,date:l.date||null,month:l.date?l.date.slice(0,7):null,label:l.label,amountEur:Number(l.amountEur||0)})),d.dividends=i.dividends.map(l=>({id:l.id,month:l.month,date:`${l.month}-28`,label:l.label,amountEur:Number(l.amountEur||0)}));const S={};return i.monthlyActuals.forEach(l=>{if(!mt(l.month))return;const f={},I=r(l.realRevenueEUR),z=r(l.realPayoutRatePct),W=r(l.realClosingBalanceEUR);Number.isFinite(I)&&(f.realRevenueEUR=Number(I)),Number.isFinite(z)&&(f.realPayoutRatePct=Number(z)),Number.isFinite(W)&&(f.realClosingBalanceEUR=Number(W)),Object.keys(f).length&&(S[l.month]=f)}),d.monthlyActuals=S,d},t),Ie.current=s,Se(!1),He(`Gespeichert: ${new Date().toLocaleTimeString("de-DE")}`)}function qe(t=380){ce.current!=null&&window.clearTimeout(ce.current),ce.current=window.setTimeout(()=>{if(ce.current=null,p){qe(220);return}Ut("v2:inputs:auto")},Math.max(80,Number(t)||380))}return m.useEffect(()=>{if(Ke.current){Ke.current=!1;return}const n=Xe({openingBalance:ae,startMonth:B,horizonMonths:O,cashInCalibrationEnabled:v,cashInCalibrationHorizonMonths:H,cashInRecommendationIgnoreQ4:K,cashInRecommendationBaselineNormalPct:ie,cashInRecommendationBaselineQ4Pct:se,incomings:A,extras:Pe,dividends:Ce,monthlyActuals:le})!==Ie.current;Se(n),n&&(He("Ungespeicherte Aenderungen"),qe(380))},[ae,B,O,v,H,K,ie,se,A,Pe,Ce,le]),e.jsxs("div",{className:"v2-page",onBlurCapture:t=>{en(t.target)&&Le&&qe(120)},children:[e.jsxs(X,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(J,{level:3,children:"Eingaben"}),e.jsx(ht,{children:"Opening Balance, Monats-Horizont, Umsaetze, Extras, Dividenden und Monats-Istwerte."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[p?e.jsx(h,{color:"processing",children:"Speichern..."}):null,Le?e.jsx(h,{color:"gold",children:"Ungespeicherte Aenderungen"}):e.jsx(h,{color:"green",children:"Synchron"}),R?e.jsxs(h,{color:"green",children:["Gespeichert: ",new Date(R).toLocaleTimeString("de-DE")]}):null,we?e.jsx(h,{color:Le?"gold":"blue",children:we}):null]})})]}),e.jsx(X,{children:e.jsxs(D,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsxs(D,{wrap:!0,children:[e.jsx(x,{strong:!0,children:"Methodik (global)"}),e.jsx(h,{color:"blue",children:"GLOBAL"})]}),e.jsxs(D,{wrap:!0,children:[e.jsxs(h,{children:["Forecast im Cashflow: ",Mt?"Ja":"Nein"]}),e.jsxs(h,{children:["Cash-In Modus: ",Nt==="basis"?"Basis":"Konservativ"]}),e.jsxs(h,{children:["Kalibrierung: ",v?`An (${H} Monate)`:"Aus"]}),e.jsxs(h,{children:["Q4 ignorieren: ",K?"An":"Aus"]})]}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"In Methodik & Regeln bearbeiten"})]})}),o?e.jsx(dt,{type:"error",showIcon:!0,message:o}):null,u?e.jsx(dt,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(X,{children:[e.jsx(J,{level:5,children:"Umsatz-Kalibrierung"}),e.jsxs("div",{style:{padding:12,border:"1px solid #d9d9d9",borderRadius:8,background:"#fafafa"},children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between",marginBottom:8},wrap:!0,children:[e.jsxs(J,{level:5,style:{margin:0},children:["Aktueller Monat: ",G(E)]}),De?null:e.jsx(h,{color:"orange",children:"Aktueller Monat liegt ausserhalb des Planungshorizonts"})]}),e.jsxs(D,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(h,{color:v?"green":"default",children:["Umsatzkalibrierung ",v?"aktiv":"aus"]}),e.jsxs(h,{children:["Wirkt über: ",H," Monate"]}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"Methodik (global) ändern"}),e.jsx(V,{title:"Faktor wird aus Sellerboard-Umsatzprognose Monatsende / Forecast-Umsatz berechnet und läuft linear bis 1,00 aus.",children:e.jsx(h,{children:"Info"})})]}),e.jsx(x,{type:"secondary",children:"Faktor läuft linear auf 1,00 aus."}),e.jsxs(D,{wrap:!0,align:"start",style:{marginTop:8},children:[e.jsxs("div",{children:[e.jsx(x,{children:"Umsatzprognose bis Monatsende (EUR)"}),e.jsx(T,{value:Dt??void 0,mode:"decimal",min:0,step:100,style:{width:240},onChange:t=>{const n=Te(t);n==null&&t!=null&&String(t).trim()!==""||st({calibrationSellerboardMonthEndEur:n})},disabled:!De})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Auszahlung bis Monatsende Prognose (EUR)"}),e.jsx(T,{value:nt??void 0,mode:"decimal",min:0,step:100,style:{width:260},onChange:t=>{const n=Te(t);n==null&&t!=null&&String(t).trim()!==""||st({calibrationPayoutRateToDatePct:n})},disabled:!De})]}),e.jsxs("div",{children:[e.jsxs(x,{children:["Kalibrierfaktor ",G(E)]}),e.jsx("div",{style:{minWidth:180,paddingTop:6},children:e.jsx(V,{title:Bt,children:e.jsx(x,{strong:!0,children:ne(Ae)})})})]})]}),e.jsxs("div",{style:{marginTop:8},children:[e.jsxs(x,{children:["Kalibrierfaktor aktueller Monat (",G(E),"):"," ",e.jsx(x,{strong:!0,children:ne(Ae)})]}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast Umsatz (",G(E),"): ",b(ge,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Kalibrierter Umsatz: ",b(at,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Kalibrierter Payout (aus Quote): ",b(At,2)," EUR"]})}),e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Auszahlung Monatsende Prognose (manuell): ",b(nt,2)," EUR"]})}),Number.isFinite(ke)?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Prognose-Quote aktueller Monat: ",b(ke,1),"%"," ","(wird als Datenpunkt fuer Baseline-Info genutzt)"]})}):null,zt?e.jsxs(h,{color:"warning",style:{marginTop:6},children:["Ungewoehnlicher Faktor (",ne(w),")"]}):null]})]})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[e.jsx(J,{level:5,style:{margin:0},children:"Umsaetze x Payout"}),e.jsxs(D,{wrap:!0,children:[e.jsxs(h,{children:["Baseline Normal: ",b(ie,1),"%"]}),e.jsxs(h,{children:["Baseline Q4: ",b(se??Fe,1),"%"]}),e.jsxs(h,{children:["Q4 ignorieren: ",K?"Ja":"Nein"]}),e.jsx(V,{title:"Q4 Vorschlag: Normal + 0,5 * (Dez - Normal).",children:e.jsxs(h,{children:["Auto-Vorschlag: ",b(We,1),"%"]})}),e.jsx(U,{size:"small",onClick:()=>M("/v2/methodik"),children:"Methodik (global) ändern"}),e.jsx(U,{onClick:()=>{q(t=>{var y,S,l;const n=$(t),i=n.length?n[n.length-1].month:$e(B||Q(),Math.max(0,Math.round(O||1)-1)),s=$e(i,1);if(n.some(f=>f.month===s))return n;const c=(y=n.slice().reverse().find(f=>Number.isFinite(j(f.payoutPct))))==null?void 0:y.payoutPct,d=j((l=(S=N.byMonth)==null?void 0:S[s])==null?void 0:l.quotePct);return $([...n,{id:Y("inc"),month:s,revenueEur:0,payoutPct:Number.isFinite(d)?d:j(c)??null,source:"manual",calibrationCutoffDate:null,calibrationRevenueToDateEur:null,calibrationPayoutRateToDatePct:null,calibrationSellerboardMonthEndEur:null}])}),Oe(t=>Math.max(1,Math.round(Number(t||1)))+1)},children:"Naechsten Monat anhaengen"})]})]}),e.jsxs(D,{style:{marginBottom:8},wrap:!0,children:[e.jsxs(x,{type:"secondary",children:["Die Umsatzzeilen sind strikt auf den Planungszeitraum (",B," + ",O," Monate) synchronisiert."]}),e.jsx(h,{color:v?"green":"default",children:v?"Umsatzkalibrierung aktiv":"Umsatzkalibrierung aus"}),e.jsx(V,{title:"Vergleich über den gesamten Planungshorizont: Kalibrierung aktiv vs. neutral (Faktor 1,00).",children:e.jsxs(h,{color:pe.revenueDelta<=0?"orange":"green",children:["Impact Umsatz: ",bt(pe.revenueDelta)]})}),e.jsx(V,{title:"Vergleich über den gesamten Planungshorizont: Kalibrierung aktiv vs. neutral (Faktor 1,00).",children:e.jsxs(h,{color:pe.payoutDelta<=0?"orange":"green",children:["Impact Auszahlung: ",bt(pe.payoutDelta)]})}),e.jsx(V,{title:kt,children:e.jsxs(h,{children:["Baseline N/Q4: ",b(xe,1),"% / ",b(Fe,1),"%"]})}),Number.isFinite(ke)?e.jsxs(h,{color:"blue",children:["Prognose-Quote aktuell: ",b(ke,1),"%"]}):null,e.jsxs(h,{children:["Aktive Kalibrier-Monate: ",pe.affectedMonths]}),N.uncertain?e.jsxs(h,{color:"orange",children:["Empfehlung unsicher (",N.sampleCount," Ist-Monate)"]}):null]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"fixed",style:{minWidth:1720},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:130},children:"Monat"}),e.jsx("th",{style:{width:200},children:"Umsatz EUR"}),e.jsx("th",{style:{width:90},children:"Faktor"}),e.jsx("th",{style:{width:180},children:"Umsatz kalibriert (EUR)"}),e.jsx("th",{style:{width:180},children:"Auszahlungsquote (manuell) %"}),e.jsx("th",{style:{width:170},children:"Empfehlung %"}),e.jsx("th",{style:{width:190},children:"Payout EUR (aktiv)"}),e.jsx("th",{style:{width:190},children:"Payout kalibriert (EUR)"}),e.jsx("th",{style:{width:240},children:"Status"}),e.jsx("th",{style:{width:60}})]})}),e.jsx("tbody",{children:$(A).map(t=>{var ut;const n=be.get(t.month)||null,i=String((n==null?void 0:n.sourceTag)||"BASELINE_NORMAL"),s=Number(n==null?void 0:n.quotePct),c=Number.isFinite(s)?Qe(s,Re,Ee):null,d=i==="IST"?"IST":i==="PROGNOSE"?"PROGNOSE":i==="BASELINE_Q4"?"BASELINE Q4":"BASELINE",y=i==="IST"?"green":i==="PROGNOSE"?"purple":"blue",S=i==="BASELINE_Q4"?`Q4 Baseline: ${b(Fe,1)}% (Vorschlag ${b(We,1)}%)`:i==="BASELINE_NORMAL"?`Normal Baseline: ${b(xe,1)}%`:i==="PROGNOSE"?"PROGNOSE = Auszahlung Monatsende / Umsatzprognose Monatsende":"IST = Monats-Istwerte",l=[`Quelle: ${d}`,n!=null&&n.explanation?String(n.explanation):null,S,`Q4 ignorieren: ${K?"ja":"nein"}`].filter(Boolean).join(" | "),f=j(t.payoutPct),I=Number.isFinite(f)?Number(f):Number.isFinite(c)?Number(c):null,z=Number.isFinite(c)&&Number.isFinite(f)?Number(f)-Number(c):null,W=Number.isFinite(z)&&Math.abs(Number(z))>=wt,k=Number(ue.get(t.month)||0),P=((ut=je.byMonth)==null?void 0:ut[t.month])||null,F=Number((P==null?void 0:P.factor)||1),g=Number.isFinite(F)?F:1,de=k*g,ze=String((P==null?void 0:P.method)||"").toLowerCase(),he=String((P==null?void 0:P.sourceMonth)||"").trim(),fe=v&&Math.abs(g-1)>1e-6,Be=t.source==="forecast"&&(!Number.isFinite(k)||k<=0),lt=r(t.revenueEur),ve=t.source==="manual"&&Number.isFinite(k)&&k>0,Tt=Number.isFinite(I)&&Number.isFinite(lt)?Number(lt)*(Number(I)/100):null,ct=Number.isFinite(I)?k*(Number(I)/100):null,Ve=Number.isFinite(I)?de*(Number(I)/100):null,Qt=ve?Tt:v?Ve:ct,$t=v?fe?[he?`Quelle: ${G(he)}`:null,ze==="linear"?"Methode: lineare Hochrechnung":null,`Angewendet: ${ne(g)}`].filter(Boolean).join(" | "):"Keine aktive Kalibrierung in diesem Monat (Faktor 1,00).":"Kalibrierung ist deaktiviert. Faktor = 1,00.";return e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx(x,{strong:!0,children:G(t.month)}),e.jsx("div",{children:e.jsx(x,{type:"secondary",children:t.month})})]}),e.jsx("td",{children:e.jsxs("div",{"data-field-key":`inputs.incomings.${t.id}.revenueEur`,style:ve?{border:"1px solid #faad14",borderRadius:8,padding:6}:void 0,children:[e.jsx(T,{value:t.revenueEur??void 0,mode:"decimal",min:0,step:100,style:{width:"100%"},onChange:ye=>{q(Me=>Me.map(ee=>ee.id!==t.id?ee:{...ee,revenueEur:r(ye),source:"manual"}))}}),ve?e.jsx(x,{type:"warning",children:"manuell ueberschrieben"}):null,e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast: ",b(k,2)," EUR"]})})]})}),e.jsx("td",{children:e.jsx(V,{title:$t,children:e.jsx(x,{strong:!0,children:ne(g)})})}),e.jsx("td",{children:b(de,2)}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.incomings.${t.id}.payoutPct`,children:e.jsx(T,{value:t.payoutPct??void 0,mode:"percent",min:Re,max:Ee,step:.1,style:{width:"100%"},onChange:ye=>{q(Me=>Me.map(ee=>ee.id===t.id?{...ee,payoutPct:j(ye)}:ee))}})})}),e.jsx("td",{children:Number.isFinite(c)?e.jsxs("div",{children:[e.jsx(V,{title:l,children:e.jsxs("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[e.jsx("span",{children:b(c,2)}),e.jsx(h,{color:y,style:{marginRight:0},children:d})]})}),W?e.jsxs(h,{color:"orange",children:["Delta ",an(Number(z))]}):null]}):e.jsx(x,{type:"secondary",children:"—"})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx(x,{strong:!0,children:b(Qt,2)}),ve?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast kalibriert: ",b(Ve,2)," EUR"]})}):v?e.jsx("div",{children:e.jsxs(x,{type:"secondary",children:["Forecast: ",b(ct,2)," EUR"]})}):null]})}),e.jsx("td",{children:b(Ve,2)}),e.jsx("td",{children:e.jsxs("div",{style:{minWidth:170},children:[t.source==="forecast"?e.jsx(h,{color:"blue",children:"Forecast übertragen"}):null,ve?e.jsx(h,{color:"orange",children:"Manuell ueberschrieben"}):null,fe?e.jsx(h,{color:"orange",children:"Kalibriert"}):null,Be?e.jsx("div",{children:e.jsx(x,{type:"warning",children:"Kein Forecast-Umsatz vorhanden"})}):null]})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{q(ye=>ye.filter(Me=>Me.id!==t.id))},children:"X"})})]},t.id)})})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Extras"}),e.jsx(U,{onClick:()=>{re(t=>[...t,{id:Y("extra"),date:`${Q()}-15`,label:"Extra",amountEur:0}])},children:"Extra"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Datum"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:Pe.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.date`,children:e.jsx(me,{type:"date",value:t.date,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,date:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.label`,children:e.jsx(me,{value:t.label,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,label:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.extras.${t.id}.amountEur`,children:e.jsx(T,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:n=>{re(i=>i.map(s=>s.id===t.id?{...s,amountEur:r(n)}:s))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{re(n=>n.filter(i=>i.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Dividenden"}),e.jsx(U,{onClick:()=>{oe(t=>[...t,{id:Y("div"),month:Q(),label:"Dividende",amountEur:0}])},children:"Dividende"})]}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Betrag EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:Ce.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.month`,children:e.jsx(me,{type:"month",value:t.month,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,month:te(n.target.value,t.month)}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.label`,children:e.jsx(me,{value:t.label,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,label:n.target.value}:s))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.dividends.${t.id}.amountEur`,children:e.jsx(T,{value:t.amountEur??void 0,mode:"decimal",style:{width:"100%"},step:10,onChange:n=>{oe(i=>i.map(s=>s.id===t.id?{...s,amountEur:r(n)}:s))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{oe(n=>n.filter(i=>i.id!==t.id))},children:"X"})})]},t.id))})]})})]}),e.jsxs(X,{children:[e.jsxs(D,{style:{width:"100%",justifyContent:"space-between"},children:[e.jsx(J,{level:5,style:{margin:0},children:"Monats-Istwerte (Monatsende)"}),e.jsx(U,{onClick:()=>{Z(t=>[...t,{month:Q(),realRevenueEUR:0,realPayoutRatePct:0,realClosingBalanceEUR:0}])},children:"Ist-Monat"})]}),e.jsx(ht,{type:"secondary",style:{marginTop:8,marginBottom:12},children:"Diese Werte gelten je Monat zum Monatsende und setzen den Kontostand ab diesem Monat als neue Baseline."}),e.jsx("div",{className:"v2-stats-table-wrap",children:e.jsxs("table",{className:"v2-stats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Monat"}),e.jsx("th",{children:"Realer Umsatz EUR"}),e.jsx("th",{children:"Reale Auszahlungsquote %"}),e.jsx("th",{children:"Realer Kontostand Monatsende EUR"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:le.map((t,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.month`,children:e.jsx(me,{type:"month",value:t.month,onChange:i=>{const s=te(i.target.value,t.month);Z(c=>c.map((d,y)=>y===n?{...d,month:s}:d))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realRevenueEUR`,children:e.jsx(T,{value:t.realRevenueEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realRevenueEUR:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realPayoutRatePct`,children:e.jsx(T,{value:t.realPayoutRatePct??void 0,mode:"percent",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realPayoutRatePct:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx("div",{"data-field-key":`inputs.monthlyActuals.${n}.realClosingBalanceEUR`,children:e.jsx(T,{value:t.realClosingBalanceEUR??void 0,mode:"decimal",style:{width:"100%"},onChange:i=>{Z(s=>s.map((c,d)=>d===n?{...c,realClosingBalanceEUR:r(i)}:c))}})})}),e.jsx("td",{children:e.jsx(U,{danger:!0,onClick:()=>{Z(i=>i.filter((s,c)=>c!==n))},children:"X"})})]},`${t.month}-${n}`))})]})})]}),e.jsxs(X,{children:[e.jsx(J,{level:5,children:"Basis-Parameter"}),e.jsxs(D,{wrap:!0,align:"start",children:[e.jsxs("div",{children:[e.jsx(x,{children:"Opening Balance (EUR)"}),e.jsx("div",{"data-field-key":"inputs.openingBalance",children:e.jsx(T,{value:ae,onChange:t=>{Ye(Number(r(t)||0))},style:{width:190},mode:"decimal",min:0,step:100})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Startmonat"}),e.jsx("div",{"data-field-key":"inputs.startMonth",children:e.jsx(me,{type:"month",value:B,onChange:t=>{const n=te(t.target.value,B);Ze(n),q(i=>Ue(i,n,O))},style:{width:170}})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"Horizont (Monate)"}),e.jsx("div",{"data-field-key":"inputs.horizonMonths",children:e.jsx(T,{value:O,onChange:t=>{const n=Math.max(1,Number(r(t)||1));Oe(n),q(i=>Ue(i,B,n))},mode:"int",min:1,max:48,style:{width:160}})})]})]})]})]})}export{fn as default};
