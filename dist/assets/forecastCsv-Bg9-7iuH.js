const I={jan:"01",januar:"01",feb:"02",februar:"02",märz:"03",maerz:"03",mrz:"03",marz:"03",apr:"04",april:"04",mai:"05",jun:"06",juni:"06",jul:"07",juli:"07",aug:"08",august:"08",sep:"09",sept:"09",september:"09",okt:"10",oktober:"10",nov:"11",november:"11",dez:"12",dezember:"12"};function p(r){return String(r||"").toLowerCase().replace(/\s+/g," ").trim()}function b(r){if(!r)return null;const t=String(r).replace(/\s+/g," ").trim().match(/Erwartete Verkäufe\s+([A-Za-zÄÖÜäöüß\.]+)\s+(\d{4})/i);if(!t)return null;const e=t[1].replace(".","").toLowerCase(),o=t[2],n=I[e];return n?`${o}-${n}`:null}function d(r){if(r==null)return null;if(typeof r=="number")return Number.isFinite(r)?r:null;const s=String(r).trim().replace(/\s+/g,"").replace(/[^0-9,.-]/g,"");if(!s)return null;const t=s.lastIndexOf(","),e=s.lastIndexOf("."),o=Math.max(t,e);let n=s;if(o>=0){const l=s.slice(0,o).replace(/[.,]/g,""),a=s.slice(o+1).replace(/[.,]/g,"");n=`${l}.${a}`}else n=s.replace(/[.,]/g,"");const i=Number(n);return Number.isFinite(i)?i:null}function w(r,s){let t=0,e=!1;for(let o=0;o<r.length;o+=1){const n=r[o];n==='"'?e&&r[o+1]==='"'?o+=1:e=!e:!e&&n===s&&(t+=1)}return t}function k(r){const s=r.slice(0,3);let t=0,e=0;return s.forEach(o=>{t+=w(o,";"),e+=w(o,",")}),t>=e?";":","}function S(r,s){const t=[];let e="",o=!1;for(let n=0;n<r.length;n+=1){const i=r[n];i==='"'?o&&r[n+1]==='"'?(e+='"',n+=1):o=!o:!o&&i===s?(t.push(e),e=""):e+=i}return t.push(e),t}function z(r){const t=String(r||"").replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(n=>n.length>0);if(!t.length)return{rows:[],delimiter:";"};const e=k(t);return{rows:t.map(n=>S(n,e)),delimiter:e}}function E(r,s){const t=(s||[]).findIndex(e=>p(e)==="sku");return t>=0?t:(r||[]).findIndex(e=>p(e)==="sku")}function M(r,s){const t=[],e=[];return(r||[]).forEach((n,i)=>{if(!n||!String(n).includes("Erwartete Verkäufe"))return;const l=b(n);if(!l){t.push(`Monat konnte nicht erkannt werden: "${n}"`);return}e.push({month:l,start:i})}),e.length?{groups:e.map((n,i)=>{const l=i+1<e.length?e[i+1].start:(s||[]).length,a=s.slice(n.start,l).map(p),c=a.findIndex(u=>u==="einheiten"),f=a.findIndex(u=>u.startsWith("umsatz")),m=a.findIndex(u=>u.startsWith("gewinn"));return c<0&&t.push(`Monatsgruppe ${n.month} ohne Einheiten-Spalte gefunden.`),{month:n.month,unitsIndex:c>=0?n.start+c:null,revenueIndex:f>=0?n.start+f:null,profitIndex:m>=0?n.start+m:null}}),warnings:t}:{groups:[],warnings:t}}function C(r){const{rows:s}=z(r);if(s.length<2)return{error:"CSV-Header nicht erkannt",records:[],warnings:[]};const t=s[0]||[],e=s[1]||[],o=E(t,e);if(o<0)return{error:"Keine SKU-Spalte gefunden",records:[],warnings:[]};const{groups:n,warnings:i}=M(t,e);if(!n.length)return{error:"Monatsgruppen unvollständig",records:[],warnings:i};const l=[];let a=0;for(let c=2;c<s.length;c+=1){const f=s[c]||[],m=String(f[o]||"").trim();if(m){if(m.toLowerCase()==="gesamt"){a+=1;continue}n.forEach(u=>{if(u.unitsIndex==null)return;const h=d(f[u.unitsIndex]),g=u.revenueIndex!=null?d(f[u.revenueIndex]):null,x=u.profitIndex!=null?d(f[u.profitIndex]):null;h==null&&g==null&&x==null||l.push({sku:m,month:u.month,units:h,revenueEur:g,profitEur:x})})}}return{records:l,warnings:i,ignoredTotal:a,skuIndex:o,months:n.map(c=>c.month)}}export{C as p};
