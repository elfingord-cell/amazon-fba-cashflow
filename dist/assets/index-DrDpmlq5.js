import{t as h,_ as tr,k as e,I as ee,J as Cs,K as sr,L as rr,P as Pt,M as P,S as Y,N as d,T as oe,O as me,R as vs,Q as Me,U as ys,V as at}from"./index-BX0hCHd9.js";import{E as nr}from"./index-CyYT_HvY.js";import{c as or}from"./cashflow-C10hZqFJ.js";import{T as ar}from"./TanStackGrid-BGkv20_p.js";import{b as ir}from"./dashboardMaturity-CZVPjRd9.js";import{b as lr}from"./orderEditorFactory-CY17qrsb.js";import{c as cr,a as dr,b as ur,d as hr}from"./orderUtils-BRCvVsAW.js";import{b as Is,r as mr,a as fr,c as gr}from"./phantomFo-DOBnNRbz.js";import{e as br,g as pr}from"./forecastVersioning-DR49vPk8.js";import{c as xr}from"./inventoryProjection-_R2jh3XS.js";import{m as vr,c as It,a as yr,n as jr,b as it,f as $}from"./months-DiLwPhVv.js";import{u as kr,C as L}from"./workspace-C5RCXX1l.js";import{h as Sr,g as Nr,s as Dr}from"./uiPrefs-CxTlE9qM.js";import{s as Mr}from"./index-BwH3Pskl.js";import{C as ne}from"./Collapse-DF_Cuh80.js";import{S as Ze}from"./index-DzJjwXuy.js";import{C as Ar}from"./index-D7NwOxsn.js";import{S as ye}from"./index-BP-khr7h.js";import{R as ws}from"./InfoCircleOutlined-DtNRuN3d.js";import{F as Cr}from"./Table-DxoWZYnf.js";import{T as Ir}from"./index-DVmxEQnU.js";import"./planProducts-Cw71DzXi.js";import"./store-DTKdAsoD.js";import"./prefill-Dxwr0p2A.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-DW61f7OT.js";import"./foSuggestion-Ck1952gl.js";import"./productCompletenessV2-B77TS4Tc.js";import"./abcClassification-CppDRep4.js";import"./Dropdown-Dqfaj-V1.js";import"./useBubbleLock-J8y-aVQh.js";import"./index-J71TIXUx.js";import"./Pagination-6S75qB_v.js";const{Text:wr}=Cs;function Er({className:t,groups:r=[],items:n,visibleStartMs:a,visibleEndMs:o,height:i=180,emptyMessage:c="Keine Timeline-Daten vorhanden."}){const k=h.useRef(null),[S,A]=h.useState(null),[p,v]=h.useState(null);h.useEffect(()=>{if(typeof window>"u")return;let x=!0;return tr(()=>import("./vis-timeline-graph2d-DVPA6HI_.js"),[]).then(T=>{x&&A(T)}).catch(T=>{x&&v(T instanceof Error?T.message:"Timeline konnte nicht geladen werden.")}),()=>{x=!1}},[]);const f=h.useMemo(()=>n.map(x=>({id:x.id,type:x.type||(x.endMs!=null?"range":"box"),content:x.content||"",start:x.startMs,end:x.endMs,className:x.className,title:x.title,selectable:!1,editable:!1})),[n]),y=h.useMemo(()=>r.map(x=>({id:x.id,content:x.content,className:x.className})),[r]),O=h.useMemo(()=>{const x=Number.isFinite(a)?a:Date.now(),T=Number.isFinite(o)?o:x+30*24*60*60*1e3,G=T>x?T:x+30*24*60*60*1e3;return{stack:!0,zoomable:!1,moveable:!1,selectable:!1,showCurrentTime:!0,orientation:{axis:"top",item:"top"},margin:{axis:10,item:8},start:x,end:G,tooltip:{followMouse:!0,overflowMethod:"cap"}}},[o,a]);return h.useEffect(()=>{if(!S||!k.current||!f.length)return;const x=k.current;x.innerHTML="";const T=y.length?new S.Timeline(x,f,y,O):new S.Timeline(x,f,O);return()=>{T.destroy()}},[y,f,O,S]),n.length?p?e.jsx(ee,{type:"warning",showIcon:!0,message:`Timeline konnte nicht geladen werden: ${p}`}):S?e.jsx("div",{className:["v2-vis-timeline",t||""].filter(Boolean).join(" "),children:e.jsx("div",{ref:k,style:{height:i}})}):e.jsx("div",{className:"v2-vis-timeline-loading",children:e.jsx(wr,{type:"secondary",children:"Timeline wird geladen..."})}):e.jsx(ee,{type:"info",showIcon:!0,message:c})}const Ct=24*60*60*1e3,Fr={slug:"po",entityLabel:"PO",numberField:"poNo"};function fe(t){return String(t||"").trim().toLowerCase()}function Se(t){const r=String(t||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(r))return null;const[n,a,o]=r.split("-").map(Number);if(!n||!a||!o)return null;const i=new Date(Date.UTC(n,a-1,o));return Number.isNaN(i.getTime())?null:r}function Ue(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(Date.UTC(r,n-1,a));return Number.isNaN(o.getTime())?null:o.getTime()}function ze(t){if(!t)return"—";const r=Ue(t);return r==null?t:new Date(r).toLocaleDateString("de-DE")}function Pr(t){return Number.isFinite(t)?t.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function Rr(t){const r=t.settings&&typeof t.settings=="object"?t.settings:{},n=r.cny&&typeof r.cny=="object"?r.cny:{start:"",end:""},a=r.cnyBlackoutByYear&&typeof r.cnyBlackoutByYear=="object"?r.cnyBlackoutByYear:{};return{fxRate:Number(r.fxRate||0),fxFeePct:Number(r.fxFeePct||0),dutyRatePct:Number(r.dutyRatePct||0),dutyIncludeFreight:r.dutyIncludeFreight!==!1,eustRatePct:Number(r.eustRatePct||0),vatRefundEnabled:r.vatRefundEnabled!==!1,vatRefundLagMonths:Number(r.vatRefundLagMonths||0),freightLagDays:Number(r.freightLagDays||0),cny:n,cnyBlackoutByYear:a}}function Or(t){const r=fe(t.sourceId),n=fe(t.sourceNumber);return(Array.isArray(t.state.pos)?t.state.pos:[]).find(o=>{const i=fe(o.id),c=fe(o.poNo);return!!(r&&r===i||n&&n===c||n&&n===i)})||null}function Tr(t){const r=fe(t.sourceId),n=fe(t.sourceNumber);return(Array.isArray(t.state.fos)?t.state.fos:[]).find(o=>{const i=fe(o.id),c=fe(o.foNo),k=fe(o.foNumber);return!!(r&&r===i||n&&(n===c||n===k||n===i))})||null}function Es(t,r,n){return String(t||"").trim().toLowerCase()==="paid"||String(r||"").trim()||String(n||"").trim()?"paid":"open"}function Fs(t){const r=String(t.explicitDirection||"").trim().toLowerCase();if(r==="in")return"in";if(r==="out")return"out";const n=`${String(t.eventType||"")} ${String(t.category||"")} ${String(t.label||"")}`.toLowerCase();return n.includes("refund")||n.includes("erstatt")||t.amount<0?"in":"out"}function Br(t,r){const n=Array.isArray(t.payments)?t.payments:[];let a=[];try{const o=typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r));a=lr(o,Fr,Rr(t),n,{includeIncoming:!0})}catch{a=[]}return a.map(o=>{const i=Se(o.dueDate);if(!i)return null;const c=Math.abs(Number(o.plannedEur||0));if(!(c>0))return null;const k=Fs({amount:Number(o.plannedEur||0),eventType:o.eventType,label:o.label||o.typeLabel,explicitDirection:o.direction});return{id:String(o.id||`po-pay-${i}`),label:String(o.typeLabel||o.label||"Zahlung"),dueDate:i,amountEur:c,status:Es(o.status,o.paidDate,o.paymentId),direction:k}}).filter(o=>!!o)}function Kr(t){const r=Number(t.fxRate||0);return(Array.isArray(t.payments)?t.payments:[]).map((a,o)=>{const i=Se(a.dueDate);if(!i)return null;const c=Number(a.amount||0);if(!Number.isFinite(c)||c===0)return null;const k=Fs({amount:c,category:a.category,label:a.label}),S=Math.abs(hr(c,a.currency||"EUR",r));return S>0?{id:String(a.id||`fo-pay-${o+1}`),label:String(a.label||a.category||"Zahlung"),dueDate:i,amountEur:S,status:Es(a.status,a.paidDate,a.paymentId),direction:k}:null}).filter(a=>!!a)}function js(t){const r=[],n=Ue(t.orderDate),a=Ue(t.etdDate),o=Ue(t.etaDate);n!=null&&a!=null&&a>=n&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:production`,type:"range",content:"Produktion",startMs:n,endMs:a,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--production",title:`Produktion: ${ze(t.orderDate)} bis ${ze(t.etdDate)}`}),a!=null&&o!=null&&o>=a&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:transit`,type:"range",content:"Transit",startMs:a,endMs:o,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--transit",title:`Transit: ${ze(t.etdDate)} bis ${ze(t.etaDate)}`}),[{key:"order",label:"Order",date:t.orderDate},{key:"etd",label:"ETD",date:t.etdDate},{key:"eta",label:"ETA",date:t.etaDate}].forEach(f=>{const y=Ue(f.date);y!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:milestone:${f.key}`,type:"box",content:f.label,startMs:y,className:`v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--milestone v2-dashboard-order-timeline-item--milestone-${f.key}`,title:`${f.label}: ${ze(f.date)}`})}),t.payments.forEach(f=>{const y=Ue(f.dueDate);y!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:payment:${f.id}`,type:"box",content:f.direction==="in"?"+":" ",startMs:y,className:["v2-dashboard-order-timeline-item","v2-dashboard-order-timeline-item--payment",f.status==="paid"?"v2-dashboard-order-timeline-item--payment-paid":"v2-dashboard-order-timeline-item--payment-open",f.direction==="in"?"v2-dashboard-order-timeline-item--payment-incoming":"v2-dashboard-order-timeline-item--payment-outgoing"].join(" "),title:[f.label,`Fällig: ${ze(f.dueDate)}`,`Betrag: ${Pr(f.amountEur)}`,`Status: ${f.status==="paid"?"Bezahlt":"Offen"}`].join(`
`)})});const c=r.flatMap(f=>[f.startMs,f.endMs].filter(y=>Number.isFinite(y)));if(!c.length)return null;const k=Math.min(...c),S=Math.max(...c),A=k-14*Ct,p=S+14*Ct,v=p>A?p:A+30*Ct;return{source:t.source,sourceId:t.sourceId,sourceNumber:t.sourceNumber,orderDate:t.orderDate,etdDate:t.etdDate,etaDate:t.etaDate,visibleStartMs:A,visibleEndMs:v,items:r}}function $r(t){const r=t.source==="fo"?"fo":"po",n=t.sourceId?String(t.sourceId):null,a=t.sourceNumber?String(t.sourceNumber):null;if(r==="po"){const c=Or({state:t.state,sourceId:n,sourceNumber:a});if(!c)return null;const k=t.state.settings&&typeof t.state.settings=="object"?t.state.settings:{},S=cr({items:c.items,orderDate:c.orderDate,fxRate:c.fxOverride??k.fxRate,fallback:c}),A=dr({orderDate:c.orderDate,productionLeadTimeDays:S.prodDays||c.prodDays,logisticsLeadTimeDays:S.transitDays||c.transitDays,bufferDays:0});return js({source:"po",sourceId:String(c.id||n||""),sourceNumber:String(c.poNo||a||""),orderDate:Se(c.orderDate||A.orderDate),etdDate:Se(c.etdManual||A.etdDate),etaDate:Se(c.etaManual||A.etaDate),payments:Br(t.state,c)})}const o=Tr({state:t.state,sourceId:n,sourceNumber:a});if(!o)return null;const i=ur({targetDeliveryDate:o.targetDeliveryDate||o.deliveryDate,productionLeadTimeDays:o.productionLeadTimeDays,logisticsLeadTimeDays:o.logisticsLeadTimeDays,bufferDays:o.bufferDays});return js({source:"fo",sourceId:String(o.id||n||""),sourceNumber:String(o.foNo||o.foNumber||a||""),orderDate:Se(o.orderDate||i.orderDate),etdDate:Se(o.etdDate||i.etdDate),etaDate:Se(o.etaDate||i.etaDate||o.targetDeliveryDate||o.deliveryDate),payments:Kr(o)})}function dt(t){if(!t)return null;const r=new Date(String(t));return Number.isNaN(r.getTime())?null:r}function Lr(t){if(!sr(t.includeInForecast,!0))return!1;if(typeof t.active=="boolean")return t.active;const r=String(t.status||"").trim().toLowerCase();return r?r==="active"||r==="aktiv"||r==="prelaunch"||r==="not_launched"||r==="planned":!0}function wt(t){return String(t||"").trim()}function zr(t){return(Array.isArray(t.products)?t.products:[]).filter(n=>wt(n.sku)?Lr(n):!1).map(n=>({sku:wt(n.sku),alias:String(n.alias||n.sku||""),status:String(n.status||"active"),safetyStockDohOverride:n.safetyStockDohOverride,foCoverageDohOverride:n.foCoverageDohOverride}))}function _r(t){const r=t.lastDriftSummary&&typeof t.lastDriftSummary=="object"?t.lastDriftSummary:{},n=typeof r.comparedAt=="string"?r.comparedAt:null;return n&&dt(n)?n:null}function Ur(t){return{id:`gate:${t.key}`,key:t.key,severity:"error",label:t.label,message:t.detail,route:t.route}}function Vr(t){const r=t.state||{},n=Number.isFinite(t.horizonMonths)?Math.max(1,Math.round(Number(t.horizonMonths))):12,a=vr(It(),n),o=Is({state:r,months:a}),i=o.robustMonthsCount>=a.length&&a.length>0,c=zr(r),k=xr({state:r,months:a,products:c,snapshot:null,snapshotMonth:yr(It(),-1),projectionMode:"units"}),S=Array.isArray(k.anchorSkuMissingHistory)?k.anchorSkuMissingHistory.map(J=>wt(J)).filter(Boolean).sort((J,mt)=>J.localeCompare(mt,"de-DE")):[],A=S.length===0,p=r.forecast&&typeof r.forecast=="object"?r.forecast:{},v=typeof p.lastImportAt=="string"?p.lastImportAt:null,f=dt(v),y=new Date,O=24*60*60*1e3,x=f?Math.floor((y.getTime()-f.getTime())/O):null,T=x!=null&&x<=35,G=_r(p),te=typeof p.lastDriftReviewedComparedAt=="string"?p.lastDriftReviewedComparedAt:null,ge=typeof p.lastDriftReviewedAt=="string"?p.lastDriftReviewedAt:null,Ie=!!(G&&te&&jr(String(G).slice(0,7))&&te===G&&dt(ge)),se=t.runtimeErrorAt&&dt(t.runtimeErrorAt)?String(t.runtimeErrorAt):null,be=!se,ae=[{key:"runtime_stable",label:"Runtime stabil",passed:be,status:be?"ok":"error",detail:be?"Keine offenen Tab-Ladefehler.":`Offener Tab-Ladefehler seit ${new Date(se).toLocaleString("de-DE")}${t.runtimeErrorRoute?` (${t.runtimeErrorRoute})`:""}.`,route:"/v2/dashboard",blockerCount:be?0:1},{key:"robust_12m",label:"Robustheit 12M",passed:i,status:i?"ok":"error",detail:i?`${o.robustMonthsCount}/${a.length} Monate robust.`:`${o.robustMonthsCount}/${a.length} Monate robust (erforderlich: ${a.length}).`,route:"/v2/dashboard",blockerCount:i?0:Math.max(0,a.length-o.robustMonthsCount)},{key:"anchor_history_complete",label:"Anchor-Historie vollständig",passed:A,status:A?"ok":"error",detail:A?"Alle aktiven/prelaunch SKUs haben Snapshot-Historie.":`${S.length} SKU(s) ohne Snapshot-Historie (Anker=0).`,route:"/v2/inventory/projektion?source=dashboard&risk=under_safety&abc=ab&expand=all",blockerCount:S.length},{key:"forecast_fresh",label:"Forecast aktuell",passed:T,status:T?"ok":"error",detail:T?`${x} Tage seit Import.`:x==null?"Kein Forecast-Import vorhanden.":`${x} Tage seit Import (erlaubt <= 35).`,route:"/v2/forecast",blockerCount:T?0:1},{key:"forecast_drift_reviewed",label:"Drift geprüft",passed:Ie,status:Ie?"ok":"error",detail:Ie?`Drift-Stand vom ${new Date(G).toLocaleDateString("de-DE")} geprüft.`:G?"Aktueller Drift-Stand ist noch nicht als geprüft markiert.":"Noch kein Driftvergleich verfügbar.",route:"/v2/forecast",blockerCount:Ie?0:1}],we=ae.filter(J=>!J.passed).map(J=>Ur(J)),Ee=we.length===0;return{ready:Ee,status:Ee?"ready":"not_ready",horizonMonths:n,checks:ae,blockers:we,robustMonthsCount:o.robustMonthsCount,robustRequiredCount:a.length,anchorMissingHistoryCount:S.length,anchorMissingHistorySkus:S,forecastDaysSinceImport:x,driftComparedAt:G,driftReviewedAt:ge,driftReviewedForComparedAt:te}}function Qe(t){return String(t||"").trim().toLowerCase()}function ht(t){const r=String(t||"").trim();if(!r)return null;const n=r.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!n)return null;const a=Number(n[1]),o=Number(n[2]),i=Number(n[3]),c=new Date(a,o-1,i);return Number.isNaN(c.getTime())||c.getFullYear()!==a||c.getMonth()!==o-1||c.getDate()!==i?null:`${a}-${String(o).padStart(2,"0")}-${String(i).padStart(2,"0")}`}function Gr(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(r,n-1,a);return Number.isNaN(o.getTime())?null:o}function Hr(){const t=new Date,r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${r}-${n}-${a}`}function ks(t){const r=Number(t);return Number.isFinite(r)?Math.max(0,Math.round(r)):0}function Wr(t){const r=ht(t.etaManual||t.etaDate||t.eta);if(r)return r;const n=Gr(ht(t.orderDate));if(!n)return null;const a=Math.max(0,Number(t.prodDays||0)),o=Math.max(0,Number(t.transitDays||0)),i=new Date(n.getTime());i.setDate(i.getDate()+a+o);const c=i.getFullYear(),k=String(i.getMonth()+1).padStart(2,"0"),S=String(i.getDate()).padStart(2,"0");return`${c}-${k}-${S}`}function Zr(t,r){const n=Qe(t.supplierId||t.supplier||t.supplierName);return n&&r.has(n)?String(r.get(n)):String(t.supplierName||t.supplier||"-")}function qr(t,r){const n=Array.isArray(t.items)?t.items:[],a=n.length?n.map(i=>String(i.sku||"").trim()).filter(Boolean):[String(t.sku||"").trim()].filter(Boolean);return Array.from(new Set(a.map(i=>r.get(Qe(i))||i))).join(", ")||"-"}function Qr(t){const r=Array.isArray(t.items)?t.items:[];return r.length?r.reduce((n,a)=>n+ks(a.units),0):ks(t.units)}function Yr(t){const r=t.state&&typeof t.state=="object"?t.state:{},n=String(t.month||""),a=ht(t.todayIso)||Hr(),o=new Map;(Array.isArray(r.suppliers)?r.suppliers:[]).forEach(p=>{const v=p&&typeof p=="object"?p:{},f=String(v.name||"").trim();if(!f)return;const y=Qe(v.id),O=Qe(f);y&&o.set(y,f),O&&o.set(O,f)});const c=new Map;(Array.isArray(r.products)?r.products:[]).forEach(p=>{const v=p&&typeof p=="object"?p:{},f=String(v.sku||"").trim();f&&c.set(Qe(f),String(v.alias||f))});const S=[];return(Array.isArray(r.pos)?r.pos:[]).forEach(p=>{const v=p&&typeof p=="object"?p:{};if(v.archived||String(v.status||"").toUpperCase()==="CANCELLED")return;const f=String(v.id||v.poNo||"").trim();if(!f)return;const y=Wr(v);if(!y)return;const O=ht(v.arrivalDate),T=y.slice(0,7)===n,G=!O,te=G&&y<a;!T&&!te||S.push({id:f,poNumber:String(v.poNo||v.id||""),supplier:Zr(v,o),skuAliases:qr(v,c),units:Qr(v),etaDate:y,arrivalDate:O,monthRelevant:T,isOverdue:te,pending:G})}),S.sort((p,v)=>{if(p.pending!==v.pending)return p.pending?-1:1;if(p.monthRelevant!==v.monthRelevant)return p.monthRelevant?-1:1;const f=p.etaDate||"9999-12-31",y=v.etaDate||"9999-12-31",O=f.localeCompare(y);return O!==0?O:p.poNumber.localeCompare(v.poNumber)})}const{Paragraph:je,Text:j,Title:he}=Cs,Jr="v2:last-route-error";function Xr(){return new Date().toISOString()}function en(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const Ss=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],tn=[{key:"inflow",label:"Einzahlungen"},{key:"po_fo",label:"PO/FO Zahlungen"},{key:"fixcost",label:"Fixkosten"},{key:"tax",label:"Steuern & Importkosten"},{key:"outflow",label:"Sonstige Auszahlungen"},{key:"other",label:"Sonstige"}],sn=new Set(["signals","cashflow","actions","robustness","simulation","pnl","actuals","kpis"]),rn=["signals","cashflow"],nn=[{value:me.CORE,label:"Kern"},{value:me.PLAN,label:"Plan"},{value:me.IDEAS,label:"Ideen"}],Ns={full:{label:"Vollständig",color:"green",className:"is-full"},wide:{label:"Weitgehend",color:"lime",className:"is-wide"},partial:{label:"Teilweise",color:"orange",className:"is-partial"},insufficient:{label:"Unzureichend",color:"red",className:"is-insufficient"}};function Ds(t){const r=new Set;return t.forEach(n=>{const a=String(n||"").trim();sn.has(a)&&r.add(a)}),Array.from(r)}function on(t){return Array.isArray(t)?t:t?[t]:[]}function D(t){const r=Number(t);return Number.isFinite(r)?r.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function Ae(t){return Number.isFinite(t)?t<0?`−${D(Math.abs(t))}`:D(t):"-"}function Ce(t,r=0){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"-"}function lt(t){const r=Number(t);return Number.isFinite(r)?`${r.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"-"}function ke(t){if(!t)return"-";const r=new Date(t);return Number.isNaN(r.getTime())?t:r.toLocaleDateString("de-DE")}function an(t){return t==="ok"?e.jsx(d,{color:"green",children:"OK"}):e.jsx(d,{color:"red",children:"Offen"})}function Et(t){return Ns[t]||Ns.insufficient}function ln(t){const r=Et(t);return e.jsx(d,{color:r.color,children:r.label})}function cn(t){return t.issueType==="forecast_missing"?"Forecast fehlt":t.issueType==="stock_oos"?"Out-of-Stock":"Unter Safety"}function _e(t){return t.reduce((r,n)=>r+Number(n.amount||0),0)}function dn(t,r){const n=new Date(t.getTime());return n.setDate(n.getDate()+r),n}function ut(t){return t==="dividend"?"Dividende (Simulation)":"CAPEX (Simulation)"}function ct(t,r){return e.jsxs("span",{className:"v2-dashboard-signal-title",children:[t,e.jsx(oe,{title:r,children:e.jsx(ws,{})})]})}function Ye(t,r){const[n,a=""]=String(t||"").split("?"),o=new URLSearchParams(a);Object.entries(r).forEach(([c,k])=>{if(k==null||k===""){o.delete(c);return}o.set(c,k)});const i=o.toString();return i?`${n}?${i}`:n}function un(t){return Ye("/v2/inventory/projektion",{source:"dashboard",risk:t.risk,abc:t.abc,month:t.month||null,sku:t.sku||null,mode:t.mode||null,expand:"all"})}function Ft(t){return Ye("/v2/products",{source:"dashboard",issues:t.issues||"needs_fix",sku:t.sku||null,expand:"all"})}function Ps(t){return Ye("/v2/forecast",{source:"dashboard",sku:t.sku||null,month:t.month||null})}function Ms(t){return Ye("/v2/orders/fo",{source:t.source||"inventory_projection",sku:t.sku||null,month:t.month||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null,phantomId:t.phantomId||null,firstRiskMonth:t.firstRiskMonth||null,orderMonth:t.orderMonth||null,leadTimeDays:Number.isFinite(Number(t.leadTimeDays))?String(Math.max(0,Math.round(Number(t.leadTimeDays)))):null,returnTo:t.returnTo||"/v2/dashboard"})}function hn(t){return Ye("/v2/orders/po",{source:"inventory_projection",sku:t.sku||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null})}function qe(t){const r=String(t.route||"");if(r.startsWith("/v2/forecast"))return Ps({sku:t.sku||null,month:t.month||null});if(r.startsWith("/v2/inventory/projektion")){const n=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"under_safety":"all",a=t.sku?"all":t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"ab":"all";return un({risk:n,abc:a,month:t.month||null,sku:t.sku||null,mode:t.mode||null})}if(r.startsWith("/v2/products")){const n=t.actionId==="revenue_inputs"||t.checkKey==="revenue_inputs"?"revenue":"needs_fix";return Ft({issues:n,sku:t.sku||null})}return r}function Rs(t){const r=typeof t.portfolioBucket=="string"?t.portfolioBucket:null;if(r)return r;const n=t.meta&&typeof t.meta=="object"?t.meta:{};return typeof n.portfolioBucket=="string"?String(n.portfolioBucket):null}function Rt(t,r){const n=Rs(t);return!n||!Pt.includes(n)?!0:r.has(n)}function mn(t,r){var o;if(!t.length)return[];const n=Number(((o=t[0])==null?void 0:o.opening)||0);let a=n;return t.map((i,c)=>{const k=c===0?n:a,S=(Array.isArray(i.entries)?i.entries:[]).filter(y=>Rt(y,r)),A=S.filter(y=>String(y.direction||"").toLowerCase()==="in").reduce((y,O)=>y+Math.abs(Number(O.amount||0)),0),p=S.filter(y=>String(y.direction||"").toLowerCase()==="out").reduce((y,O)=>y+Math.abs(Number(O.amount||0)),0),v=A-p,f=k+v;return a=f,{...i,opening:k,inflow:A,outflow:p,net:v,closing:f,entries:S}})}function fn(t){const r={};return Pt.forEach(n=>{r[n]={inflow:0,outflow:0}}),t.forEach(n=>{(Array.isArray(n.entries)?n.entries:[]).forEach(o=>{const i=Rs(o);if(!i||!r[i])return;const c=Math.abs(Number(o.amount||0));!Number.isFinite(c)||c<=0||(String(o.direction||"").toLowerCase()==="in"?r[i].inflow+=c:String(o.direction||"").toLowerCase()==="out"&&(r[i].outflow+=c))})}),r}function gn(t){const r=t.map(n=>(Array.isArray(n.entries)?n.entries:[]).filter(i=>String(i.direction||"").toLowerCase()==="out"&&String(i.group||"")==="Fixkosten").reduce((i,c)=>i+Math.abs(Number(c.amount||0)),0)).filter(n=>n>0);return r.length?r.reduce((n,a)=>n+a,0)/r.length:0}function bn(t,r,n){const a={fixcost:0,po:0,fo:0,phantomFo:0};return t.forEach(o=>{if(!o||typeof o!="object")return;const i=o;if(n&&!Rt(i,n)||String(i.direction||"").toLowerCase()!=="out")return;const c=Math.abs(Number(i.amount||0));if(!Number.isFinite(c)||c<=0)return;const k=String(i.source||"").toLowerCase();if(k==="po"){a.po+=c;return}if(k==="fo"){const A=String(i.sourceId||"").trim(),p=i.meta&&typeof i.meta=="object"?i.meta:{};i.provisional===!0||p.phantom===!0||(A?(r==null?void 0:r.has(A))===!0:!1)?a.phantomFo+=c:a.fo+=c;return}const S=String(i.group||"").toLowerCase();(k==="fixcosts"||S==="fixkosten")&&(a.fixcost+=c)}),a}function pn(t,r){const n={amazon:0,other:0,total:0};return t.forEach(a=>{if(!a||typeof a!="object")return;const o=a;if(r&&!Rt(o,r)||String(o.direction||"").toLowerCase()!=="in")return;const i=Math.abs(Number(o.amount||0));if(!Number.isFinite(i)||i<=0)return;const c=String(o.source||"").toLowerCase(),k=String(o.kind||"").toLowerCase();c==="sales"||c==="sales-plan"||k==="sales-payout"?n.amazon+=i:n.other+=i,n.total+=i}),n}function xn(t,r){var a;if(!r||!Number.isFinite(r.amount)||r.amount<=0)return t.map(o=>({...o}));let n=Number(((a=t[0])==null?void 0:a.opening)||0);return t.map((o,i)=>{const c=i===0?Number(o.opening||0):n,k=o.month===r.month,S=k?Math.abs(Number(r.amount||0)):0,A=Number(o.inflow||0),p=Number(o.outflow||0)+S,v=A-p,f=c+v;n=f;const y=k?[{id:`sim-${r.type}-${r.month}`,direction:"out",amount:S,label:r.label||ut(r.type),month:r.month,kind:r.type==="dividend"?"dividend":"capex",group:r.type==="dividend"?"Dividende & KapESt":"Extras (Out)",source:"simulation"}]:[];return{...o,opening:c,inflow:A,outflow:p,net:v,closing:f,entries:[...Array.isArray(o.entries)?o.entries:[],...y],simApplied:k}})}function vn(t,r){var n;for(let a=0;a<t.length;a+=1){const o=t[a].month;if((n=r.get(o))!=null&&n.robust&&Number(t[a].closing||0)<0)return o}return null}function yn(t){if(!t||typeof t!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0,topItems:[]};const r=t,n=Array.isArray(r.topItems)?r.topItems:[];return{comparedAt:typeof r.comparedAt=="string"?r.comparedAt:null,thresholdProfile:String(r.thresholdProfile||"medium"),flaggedSkuCount:Number(r.flaggedSkuCount||0),flaggedABCount:Number(r.flaggedABCount||0),flaggedMonthCount:Number(r.flaggedMonthCount||0),topItems:n.map(a=>{const o=a;return{sku:String(o.sku||""),month:String(o.month||""),abcClass:String(o.abcClass||"C"),deltaPct:Number(o.deltaPct||0),deltaUnits:Number(o.deltaUnits||0),deltaRevenue:Number(o.deltaRevenue||0)}}).filter(a=>a.sku&&a.month)}}function jn(t){if(!t||typeof t!="object")return{toVersionId:null,foConflictsOpen:0};const r=t;return{toVersionId:r.toVersionId==null?null:String(r.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function As(){if(typeof window>"u"||!window.sessionStorage)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};try{const t=window.sessionStorage.getItem(Jr);if(!t)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};const r=JSON.parse(t);return{errorAt:typeof r.errorAt=="string"?r.errorAt:null,routeKey:typeof r.routeKey=="string"?r.routeKey:null,routePath:typeof r.routePath=="string"?r.routePath:null,routeLabel:typeof r.routeLabel=="string"?r.routeLabel:null,message:typeof r.message=="string"?r.message:null}}catch{return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null}}}function lo(){var os,as,is,ls,cs,ds,us,hs,ms,fs,gs;const{state:t,loading:r,error:n,saving:a,saveWith:o}=kr(),i=rr(),[c,k]=Mr.useMessage(),S=Sr("dashboard"),[A,p]=h.useState("next12"),[v,f]=h.useState(()=>Pt.slice()),[y,O]=h.useState(""),[x,T]=h.useState(""),[G,te]=h.useState([]),[ge,Ie]=h.useState("dividend"),[se,be]=h.useState(""),[ae,we]=h.useState(null),[Ee,J]=h.useState(""),[mt,Ot]=h.useState({}),[Je,Os]=h.useState(()=>As()),[re,Ts]=h.useState(()=>{const s=Nr("dashboard");return S?Ds(s):rn.slice()}),X=t,H=h.useMemo(()=>mr(X,18),[t.settings]),Ne=h.useMemo(()=>y&&H.includes(y)?y:H[H.length-1]||"",[y,H]),W=h.useMemo(()=>fr({state:X,months:H,targetMonth:Ne||null}),[H,Ne,X]),Tt=h.useMemo(()=>new Map(W.map(s=>[s.id,s])),[W]),Bs=h.useMemo(()=>{const s=new Map;return W.forEach(l=>{const m=String(l.sku||"").trim().toLowerCase(),u=String(l.firstRiskMonth||"").trim(),M=String(l.orderMonth||"").trim();if(!m||!u||!M)return;const B=`${m}|${u}|${M}`;s.has(B)||s.set(B,l)}),s},[W]),Ks=h.useMemo(()=>{const s=new Map;return W.forEach(l=>{const m=String(l.sku||"").trim().toLowerCase();!m||s.has(m)||s.set(m,l)}),s},[W]),De=h.useMemo(()=>new Set(W.map(s=>s.id)),[W]),Fe=h.useMemo(()=>gr({state:X,suggestions:W}),[W,X]),pe=h.useMemo(()=>or(Fe),[Fe]),ft=pe.months||[],Bt=pe.breakdown||[],Kt=pe.actualComparisons||[],Ve=(os=pe.kpis)!=null&&os.cashIn&&typeof pe.kpis.cashIn=="object"?pe.kpis.cashIn:{},$t=String(Ve.mode||"conservative").trim().toLowerCase()==="basis"?"basis":"conservative",Lt=Number(Ve.basisQuotePct),gt=Math.max(0,Math.round(Number(Ve.istMonthsCount||0))),$s=Ve.hasIstData===!0,zt=String(Ve.fallbackUsed||"none").trim().toLowerCase(),_t=zt==="last_plan_quote"?"Fallback: letzte Plan-Quote":zt==="hardcoded_50"?"Fallback: 50 %":null,U=h.useMemo(()=>{const s=Ss.find(l=>l.value===A);return!s||s.count==null?ft:ft.slice(0,s.count)},[ft,A]),Xe=h.useMemo(()=>new Set(U),[U]),Pe=h.useMemo(()=>new Set(v),[v]),Z=h.useMemo(()=>{const s=Bt.filter(l=>Xe.has(l.month));return mn(s,Pe)},[Bt,Pe,Xe]),Ls=h.useMemo(()=>Kt.filter(s=>Xe.has(s.month)),[Kt,Xe]),C=h.useMemo(()=>Is({state:X,months:U}),[X,U]),ie=h.useMemo(()=>Vr({state:X,horizonMonths:12,runtimeErrorAt:Je.errorAt,runtimeErrorRoute:Je.routePath}),[Je.errorAt,Je.routePath,X]);h.useEffect(()=>{if(!H.length){O("");return}O(s=>s&&H.includes(s)?s:H[H.length-1])},[H]),h.useEffect(()=>{var s;if(!C.months.length){T("");return}if(!x||!C.monthMap.has(x)){const l=((s=C.months.find(m=>!m.robust))==null?void 0:s.month)||C.months[0].month;T(l)}},[C,x]),h.useEffect(()=>{if(!Z.length){te([]);return}te(s=>{const l=new Set(Z.map(u=>u.month)),m=s.filter(u=>l.has(u));return m.length?m:[Z[0].month]})},[Z]),h.useEffect(()=>{if(!U.length){be("");return}(!se||!U.includes(se))&&be(U[0])},[se,U]),h.useEffect(()=>{Dr("dashboard",re)},[re]);const xe=s=>{Ts(Ds(on(s)))},I=h.useMemo(()=>!se||!Number.isFinite(ae)||Number(ae)<=0?null:{month:se,amount:Math.abs(Number(ae)),type:ge,label:Ee.trim()||ut(ge)},[ae,Ee,se,ge]),E=h.useMemo(()=>xn(Z,I),[I,Z]),Ut=h.useMemo(()=>{const s=new Map;return E.forEach(l=>s.set(l.month,l)),s},[E]),et=h.useMemo(()=>{const s=new Map;return E.forEach(l=>{s.set(l.month,pn(Array.isArray(l.entries)?l.entries:[],Pe))}),s},[Pe,E]),tt=h.useMemo(()=>E.map(s=>et.get(s.month)||{amazon:0,other:0,total:0}),[et,E]),bt=h.useMemo(()=>tt.map(s=>s.amazon),[tt]),pt=h.useMemo(()=>tt.map(s=>s.other),[tt]),xt=E[E.length-1]||null,Vt=bt.reduce((s,l)=>s+Number(l||0),0),Gt=pt.reduce((s,l)=>s+Number(l||0),0),zs=Vt+Gt,_s=E.reduce((s,l)=>s+Number(l.outflow||0),0),Ht=E.reduce((s,l)=>s+Number(l.net||0),0),Re=h.useMemo(()=>fn(E),[E]),q=h.useMemo(()=>gn(Z),[Z])*2,vt=h.useMemo(()=>E.filter(s=>{var l;return(l=C.monthMap.get(s.month))==null?void 0:l.robust}).map(s=>Number(s.closing||0)),[C.monthMap,E]),Wt=h.useMemo(()=>!vt.length||q<=0?null:Math.min(...vt)-q,[q,vt]),Zt=h.useMemo(()=>vn(E,C.monthMap),[C.monthMap,E]),yt=h.useMemo(()=>{var s;return!I||q<=0?null:((s=E.find(l=>{const m=it(l.month),u=it(I.month);return m==null||u==null||m<u?!1:Number(l.closing||0)<q}))==null?void 0:s.month)||null},[q,E,I]),qt=!!I&&q>0&&!yt,le=t.forecast&&typeof t.forecast=="object"?t.forecast:{},st=h.useMemo(()=>{const s=structuredClone(le||{});return br(s),s},[le]),Us=h.useMemo(()=>pr(st),[st]),jt=jn(st.lastImpactSummary),Qt=String(st.activeVersionId||"").trim()||null,rt=jt.toVersionId&&Qt&&jt.toVersionId===Qt?jt.foConflictsOpen:0,kt=typeof le.lastImportAt=="string"?le.lastImportAt:null,Q=yn(le.lastDriftSummary),Yt=typeof le.lastDriftReviewedComparedAt=="string"?le.lastDriftReviewedComparedAt:null,St=typeof le.lastDriftReviewedAt=="string"?le.lastDriftReviewedAt:null,Nt=!!(Q.comparedAt&&Yt&&Yt===Q.comparedAt&&St),Oe=kt?new Date(kt):null,Vs=new Date,Gs=24*60*60*1e3,Ge=Oe?Math.floor((Vs.getTime()-Oe.getTime())/Gs):null,Te=Oe?Ge!=null&&Ge<=35?"fresh":Ge!=null&&Ge<=45?"aging":"stale":"none",Hs=Oe?`${Ge} Tage seit Import`:"Kein Forecast-Import",Jt=Oe?dn(Oe,30):null,g=x&&C.monthMap.get(x)||null,Xt=(g==null?void 0:g.coverage.stockIssues)||[],es=(g==null?void 0:g.coverage.orderDutyIssues)||[],ts=g?g.checks.filter(s=>s.key!=="sku_coverage"):[],ss=g?g.blockers.filter(s=>s.checkKey!=="sku_coverage"):[],Ws=h.useMemo(()=>{if(!g)return[];const s=g.coverage.projectionMode==="doh"?"DOH":"Units",l=g.coverage.stockIssueCount,m=g.coverage.orderDutyIssueCount,u=[{key:"stock",label:"Bestands-Check ok?",passed:l===0,description:l===0?`Alle aktiven SKUs im Monat ${$(g.month)} über Safety (${s}).`:`${l} SKU(s) mit OOS/unter Safety oder fehlendem Forecast.`},{key:"order_duty",label:"Bestellpflicht/Look-Ahead ok?",passed:m===0,description:m===0?"Keine SKU benötigt spätestens in diesem Monat eine neue FO/PO.":`${m} SKU(s) mit fälliger Bestellpflicht (inkl. Look-Ahead).`}],M=ts.map(B=>({key:B.key,label:`${B.label} ok?`,passed:B.passed,description:B.detail}));return[...u,...M]},[g,ts]),Dt=It(),Be=en(),rs=it(Dt),Mt=h.useMemo(()=>{var s;return((s=C.months.find(l=>!l.robust))==null?void 0:s.month)||x||U[0]||null},[C.months,x,U]),He=h.useMemo(()=>Yr({state:X,month:Dt,todayIso:Be}),[Dt,X,Be]);h.useEffect(()=>{const s=()=>Os(As());return s(),window.addEventListener("v2:route-load-state",s),window.addEventListener("storage",s),()=>{window.removeEventListener("v2:route-load-state",s),window.removeEventListener("storage",s)}},[]),h.useEffect(()=>{Ot(s=>{const l=new Set(He.map(M=>M.id));let m=!1;const u={};return Object.entries(s).forEach(([M,B])=>{if(!l.has(M)){m=!0;return}u[M]=B}),He.forEach(M=>{u[M.id]||(u[M.id]=M.arrivalDate||Be,m=!0)}),m?u:s})},[He,Be]);const ns=h.useMemo(()=>ir({breakdown:E,state:Fe,provisionalFoIds:De}),[De,Fe,E]),Zs=h.useMemo(()=>{const s=U.map(b=>$(b)),l=Z.map(b=>Number(b.closing||0)),m=Z.map(b=>{var F;return!!((F=C.monthMap.get(b.month))!=null&&F.robust)}),u=l.map((b,F)=>m[F]&&b>=0?b:null),M=l.map((b,F)=>m[F]&&b<0?b:null),B=l.map((b,F)=>!m[F]&&b>=0?b:null),ce=l.map((b,F)=>!m[F]&&b<0?b:null),de=I?Z.map(b=>{var F;return Number(((F=Ut.get(b.month))==null?void 0:F.closing)||0)}):[],w=E.map(b=>bn(Array.isArray(b.entries)?b.entries:[],De,Pe)),K=w.map(b=>-b.fixcost),We=w.map(b=>-b.po),V=w.map(b=>-b.fo),R=w.map(b=>-b.phantomFo),ue=["Amazon Einzahlungen","Sonstige Einzahlungen","Fixkosten","PO","FO","Phantom FO","Netto"],ve=["Kontostand belastbar","Kontostand belastbar (<0)","Kontostand orientierend","Kontostand orientierend (<0)",...I?["Simulation"]:[]];return{tooltip:{trigger:"axis",formatter:b=>{const F=Array.isArray(b)?b:[b],Ke=F[0],_=[`<div><strong>${(Ke==null?void 0:Ke.axisValueLabel)||""}</strong></div>`];return F.forEach($e=>{const z=$e,Le=Number(z==null?void 0:z.value);Number.isFinite(Le)&&_.push(`<div>${(z==null?void 0:z.marker)||""}${(z==null?void 0:z.seriesName)||""}: ${D(Le)}</div>`)}),_.join("")}},legend:[{top:0,left:0,itemGap:12,data:ue},{top:26,left:0,itemGap:12,data:ve}],grid:{left:56,right:70,top:78,bottom:32},xAxis:{type:"category",data:s},yAxis:[{type:"value",name:"Cashflow",axisLabel:{formatter:b=>Ae(b)}},{type:"value",name:"Kontostand",position:"right",axisLabel:{formatter:b=>D(b)}}],series:[{name:"Amazon Einzahlungen",type:"bar",stack:"cash",data:bt,itemStyle:{color:"#27ae60"}},{name:"Sonstige Einzahlungen",type:"bar",stack:"cash",data:pt,itemStyle:{color:"#86efac"}},{name:"Fixkosten",type:"bar",stack:"cash",data:K,itemStyle:{color:"#7f1d1d"}},{name:"PO",type:"bar",stack:"cash",data:We,itemStyle:{color:"#e74c3c"}},{name:"FO",type:"bar",stack:"cash",data:V,itemStyle:{color:"#f97316"}},{name:"Phantom FO",type:"bar",stack:"cash",data:R,itemStyle:{color:"#fbbf24"}},{name:"Netto",type:"line",smooth:!0,data:E.map(b=>Number(b.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:u,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:M,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:B,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Kontostand orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:ce,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}},...I?[{name:"Simulation",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:de,lineStyle:{width:2,type:"dashed",color:"#f59e0b"},itemStyle:{color:"#f59e0b"}}]:[]]}},[bt,Pe,pt,De,C.monthMap,E,Ut,I,Z,U]),qs=h.useMemo(()=>[{header:"Monat",accessorKey:"month"},{header:"Plan Umsatz",accessorKey:"plannedRevenue",cell:({row:s})=>D(s.original.plannedRevenue)},{header:"Ist Umsatz",accessorKey:"actualRevenue",cell:({row:s})=>D(s.original.actualRevenue)},{header:"Delta Umsatz",accessorKey:"revenueDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.revenueDelta||0)<0?"v2-negative":void 0,children:D(s.original.revenueDelta)})},{header:"Delta Umsatz %",accessorKey:"revenueDeltaPct",cell:({row:s})=>lt(s.original.revenueDeltaPct)},{header:"Plan Kontostand",accessorKey:"plannedClosing",cell:({row:s})=>D(s.original.plannedClosing)},{header:"Ist Kontostand",accessorKey:"actualClosing",cell:({row:s})=>D(s.original.actualClosing)},{header:"Delta Kontostand",accessorKey:"closingDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.closingDelta||0)<0?"v2-negative":void 0,children:D(s.original.closingDelta)})}],[]),Qs=h.useMemo(()=>[{title:"Check",dataIndex:"label",key:"label",sorter:(s,l)=>String(s.label||"").localeCompare(String(l.label||""),"de-DE")},{title:"Status",dataIndex:"status",key:"status",width:130,sorter:(s,l)=>String(s.status||"").localeCompare(String(l.status||""),"de-DE"),render:s=>an(s)},{title:"Detail",dataIndex:"detail",key:"detail",width:320,sorter:(s,l)=>String(s.detail||"").localeCompare(String(l.detail||""),"de-DE"),render:s=>e.jsx(j,{type:"secondary",children:s})},{title:"",key:"route",width:132,render:(s,l)=>e.jsx(P,{size:"small",onClick:()=>i(qe({route:l.route,checkKey:l.key,month:(g==null?void 0:g.month)||null,mode:(g==null?void 0:g.coverage.projectionMode)||null})),children:"Öffnen"})}],[i,g==null?void 0:g.coverage.projectionMode,g==null?void 0:g.month]),Ys=h.useMemo(()=>E.map(s=>{var de;const l=ns.get(s.month)||[],m=l.filter(w=>w.provisional),u=tn.map(w=>({...w,rows:l.filter(K=>K.group===w.key)})).filter(w=>w.rows.length>0),M=l.filter(w=>w.amount<0),B=et.get(s.month)||{amazon:0,other:0,total:0},ce=((de=C.monthMap.get(s.month))==null?void 0:de.robust)||!1;return{key:s.month,label:e.jsxs("div",{className:"v2-dashboard-pnl-header",children:[e.jsx(j,{strong:!0,children:$(s.month)}),e.jsxs(Y,{wrap:!0,children:[e.jsxs(d,{color:"green",children:["Einzahlungen: ",D(B.total)]}),e.jsxs(d,{color:"green",children:["Amazon: ",D(B.amazon)]}),e.jsxs(d,{color:"lime",children:["Sonstige: ",D(B.other)]}),e.jsxs(d,{color:"red",children:["Auszahlungen: ",D(Math.abs(_e(M)))]}),m.length?e.jsxs(d,{color:"gold",children:["Vorbehaltlich (enthalten): ",Ae(_e(m))]}):null,e.jsxs(d,{color:s.net>=0?"green":"red",children:["Netto: ",D(s.net)]}),e.jsxs(d,{color:ce?"green":"red",children:["Robust: ",ce?"ja":"nein"]})]})]}),children:e.jsx("div",{className:"v2-dashboard-pnl-month",children:u.map(w=>{if(w.key==="po_fo"){const K=new Map;w.rows.forEach(V=>{const R=V.source==="fo"?"fo":"po",ue=V.sourceId?String(V.sourceId):null,ve=V.sourceNumber?String(V.sourceNumber):null,b=`${R}:${ue||ve||V.label}`,F=K.get(b);if(F){F.rows.push(V),!F.sourceId&&ue&&(F.sourceId=ue),!F.sourceNumber&&ve&&(F.sourceNumber=ve);return}K.set(b,{source:R,sourceId:ue,sourceNumber:ve,rows:[V]})});const We=Array.from(K.entries()).map(([V,R])=>{var bs;const ue=_e(R.rows),ve=Array.from(new Set(R.rows.map(N=>N.portfolioBucket).filter(N=>!!N))),b=R.rows.filter(N=>N.provisional),F=b.map(N=>String(N.sourceId||"").trim()).find(N=>N&&De.has(N))||null,Ke=R.source==="fo"?R.sourceId&&De.has(R.sourceId)?R.sourceId:F:null,_=Ke&&Tt.get(Ke)||null,$e=(bs=R.rows.find(N=>N.tooltipMeta))==null?void 0:bs.tooltipMeta,z=Array.from(new Set(R.rows.flatMap(N=>{var ot;return((ot=N.tooltipMeta)==null?void 0:ot.aliases)||[]}).filter(Boolean))),Le=z.length>3?`${z.slice(0,3).join(", ")} +${z.length-3}`:z.join(", "),nt=$r({state:Fe,source:R.source,sourceId:R.sourceId,sourceNumber:R.sourceNumber});return{key:V,label:e.jsxs("div",{className:"v2-dashboard-pnl-order-row",children:[e.jsxs("div",{className:"v2-dashboard-pnl-order-row-main",children:[e.jsxs(j,{strong:!0,children:[String(R.source).toUpperCase()," ",R.sourceNumber||R.sourceId||"—"]}),Le?z.length>3?e.jsx(oe,{title:z.join(", "),children:e.jsxs(j,{type:"secondary",children:["· ",Le]})}):e.jsxs(j,{type:"secondary",children:["· ",Le]}):null]}),e.jsxs(Y,{size:6,children:[e.jsx(d,{color:ue<0?"red":"green",children:Ae(ue)}),ve.map(N=>e.jsx(d,{children:N},`${V}-${N}`)),b.length?e.jsx(d,{color:"gold",children:"Vorbehaltlich"}):null,_?e.jsx(d,{color:"orange",children:"Phantom FO"}):null,($e==null?void 0:$e.units)!=null?e.jsxs(d,{children:["Stück: ",Ce($e.units,0)]}):null]})]}),children:e.jsxs("div",{className:"v2-dashboard-pnl-order-detail",children:[_?e.jsx("div",{className:"v2-dashboard-pnl-phantom-hint",children:e.jsxs(Y,{wrap:!0,children:[e.jsx(d,{color:"gold",children:"Automatisch vorgeschlagen"}),e.jsxs(j,{type:"secondary",children:["Risikomonat ",$(_.firstRiskMonth)," · bestellen bis ",ke(_.latestOrderDate)]}),e.jsx(P,{size:"small",type:"primary",onClick:()=>i(Ms({sku:_.sku,month:s.month,suggestedUnits:_.suggestedUnits,requiredArrivalDate:_.requiredArrivalDate,recommendedOrderDate:_.recommendedOrderDate,source:"phantom_fo",phantomId:_.id,firstRiskMonth:_.firstRiskMonth,orderMonth:_.orderMonth,leadTimeDays:_.leadTimeDays,returnTo:"/v2/dashboard"})),children:"Prüfen & bestätigen"})]})}):null,nt?e.jsx("div",{className:"v2-dashboard-order-timeline-shell",children:e.jsx(Er,{className:"v2-dashboard-order-timeline",items:nt.items,visibleStartMs:nt.visibleStartMs,visibleEndMs:nt.visibleEndMs,height:188})}):e.jsx(ee,{type:"info",showIcon:!0,message:`Keine Timeline-Daten für ${String(R.source).toUpperCase()} ${R.sourceNumber||R.sourceId||"—"} verfügbar.`}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:R.rows.map((N,ot)=>{var xs;const ps=N.tooltipMeta?e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("strong",{children:[String(N.source).toUpperCase()," ",N.sourceNumber||N.sourceId||"—"]})}),e.jsxs("div",{children:["Alias: ",N.tooltipMeta.aliases.join(", ")||"-"]}),e.jsxs("div",{children:["Stückzahl: ",N.tooltipMeta.units!=null?Ce(N.tooltipMeta.units,0):"-"]}),e.jsxs("div",{children:["Fälligkeit: ",ke(N.tooltipMeta.dueDate)]})]}):null;return e.jsxs("tr",{children:[e.jsx("td",{children:ps?e.jsx(oe,{title:ps,children:N.label}):N.label}),e.jsx("td",{className:N.amount<0?"v2-negative":void 0,children:Ae(N.amount)}),e.jsx("td",{children:ke((xs=N.tooltipMeta)==null?void 0:xs.dueDate)}),e.jsx("td",{children:N.provisional?e.jsx(d,{color:"gold",children:"Vorbehaltlich"}):N.paid==null?e.jsx(d,{children:"—"}):N.paid?e.jsx(d,{color:"green",children:"Bezahlt"}):e.jsx(d,{color:"gold",children:"Offen"})})]},`${V}-${ot}`)})})]})})]})}});return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(j,{strong:!0,children:w.label}),e.jsx(d,{color:"blue",children:Ae(_e(w.rows))})]}),e.jsx(ne,{size:"small",items:We,destroyInactivePanel:!0})]},`${s.month}-${w.key}`)}return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(j,{strong:!0,children:w.label}),e.jsx(d,{color:_e(w.rows)<0?"red":"green",children:Ae(_e(w.rows))})]}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Bucket"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:w.rows.map((K,We)=>e.jsxs("tr",{children:[e.jsx("td",{children:K.tooltip?e.jsx(oe,{title:K.tooltip,children:K.label}):K.label}),e.jsx("td",{children:K.portfolioBucket?e.jsx(d,{children:K.portfolioBucket}):"—"}),e.jsx("td",{className:K.amount<0?"v2-negative":void 0,children:Ae(K.amount)}),e.jsx("td",{children:K.paid==null?e.jsx(d,{children:"—"}):K.paid?e.jsx(d,{color:"green",children:"Bezahlt"}):e.jsx(d,{color:"gold",children:"Offen"})})]},`${s.month}-${w.key}-${We}`))})]})})]},`${s.month}-${w.key}`)})})}}),[et,i,Tt,De,Fe,ns,C.monthMap,E]);async function Js(){I&&(await o(s=>{const l=at(s),m=l,u=I.label||ut(I.type);if(I.type==="dividend"){const M=Array.isArray(m.dividends)?[...m.dividends]:[];M.push({id:`div-${Date.now()}`,month:I.month,label:u,amountEur:Math.abs(I.amount)}),m.dividends=M}else{const M=Array.isArray(m.extras)?[...m.extras]:[];M.push({id:`extra-${Date.now()}`,month:I.month,label:u,amountEur:-Math.abs(I.amount)}),m.extras=M}return l},`v2:dashboard:simulation-commit:${I.type}`),we(null),J(""))}async function Xs(s){await o(l=>{const m=at(l),u=m;(!u.settings||typeof u.settings!="object")&&(u.settings={});const M=u.settings;return M.cashInMode=s==="basis"?"basis":"conservative",m},`v2:dashboard:cashin-mode:${s}`)}async function er(){Q.comparedAt&&await o(s=>{const l=at(s),m=l;(!m.forecast||typeof m.forecast!="object")&&(m.forecast={});const u=m.forecast;return u.lastDriftReviewedAt=Xr(),u.lastDriftReviewedComparedAt=Q.comparedAt,l},"v2:dashboard:forecast-drift-reviewed")}async function At(s,l,m){try{await o(u=>{const M=at(u),B=Array.isArray(M.pos)?M.pos:[];return M.pos=B.map(ce=>{if(!ce||typeof ce!="object")return ce;const de=ce;return String(de.id||de.poNo||"").trim()!==s?de:{...de,arrivalDate:l||null}}),M},m),c.success(l?"Wareneingang gespeichert.":"Wareneingang zurückgesetzt.")}catch(u){console.error(u),c.error(u instanceof Error?u.message:"Wareneingang konnte nicht gespeichert werden.")}}return((is=(as=t.settings)==null?void 0:as.featureFlags)==null?void 0:is.executiveDashboardV2)!==!1?e.jsxs("div",{className:"v2-page",children:[k,e.jsxs(L,{className:"v2-intro-card",children:[e.jsxs("div",{className:"v2-page-head",children:[e.jsxs("div",{children:[e.jsx(he,{level:3,children:"Dashboard"}),e.jsx(je,{children:"Executive-Cockpit für Kontostand, Robustheit und Maßnahmenpriorisierung. Nicht robuste Monate sind klar markiert."})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(j,{children:"PFO bis"}),e.jsx(Ze,{value:Ne||void 0,onChange:s=>O(String(s||"")),options:H.map(s=>({value:s,label:$(s)})),style:{width:220,maxWidth:"100%"},disabled:!H.length})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(j,{children:"Zeitraum"}),e.jsx(Ze,{value:A,onChange:s=>p(s),options:Ss.map(s=>({value:s.value,label:s.label})),style:{width:220,maxWidth:"100%"}})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(j,{children:"Cash-In Modus"}),e.jsx(Ze,{value:$t,onChange:s=>{Xs(String(s)==="basis"?"basis":"conservative")},options:[{value:"basis",label:"Basis"},{value:"conservative",label:"Konservativ"}],style:{width:220,maxWidth:"100%"},disabled:a})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(j,{children:"Bucket Scope"}),e.jsx(Ar.Group,{value:v,options:nn,onChange:s=>{const l=(Array.isArray(s)?s:[]).map(m=>String(m||""));l.length&&f(l)}})]})]}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(P,{onClick:()=>i("/v2/forecast"),children:"Zur Absatzprognose"}),e.jsx(P,{onClick:()=>i("/v2/inventory/projektion"),children:"Zur Bestandsprojektion"}),e.jsx(P,{onClick:()=>i("/v2/orders/po"),children:"Zu Bestellungen"}),e.jsx(P,{onClick:()=>i("/v2/abschluss/eingaben"),children:"Zum Abschluss"})]}),e.jsxs(j,{type:"secondary",children:["Aktueller Betrachtungszeitraum: ",U.length," Monat(e). PFO-Ziel: ",Ne?$(Ne):"—","."," ","Bucket-Scope: ",v.join(", "),"."]}),e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsxs(j,{children:["BasisQuote (",$s?`Median letzte ${gt} Monate`:"Keine Ist-Daten","):"," ",e.jsx("strong",{children:Number.isFinite(Lt)?`${Number(Lt).toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"—"})]}),e.jsx(oe,{title:"BasisQuote = Median der Ist-Auszahlungsquoten (Ist-Auszahlung / Ist-Umsatz)",children:e.jsx(d,{children:"BasisQuote Info"})}),$t==="conservative"?e.jsx(oe,{title:"Konservativ = BasisQuote minus Sicherheitsmarge je Zukunftsmonat (1pp/2pp/3pp/4pp/5pp)",children:e.jsx(d,{color:"gold",children:"Konservativ aktiv"})}):e.jsx(d,{color:"blue",children:"Basis aktiv"}),_t?e.jsx(d,{color:"default",children:_t}):null]}),gt<6?e.jsx(ee,{type:"info",showIcon:!1,message:`Nur ${gt} Ist-Monate vorhanden – Konservativ empfohlen.`}):null]})]}),n?e.jsx(ee,{type:"error",showIcon:!0,message:n}):null,r?e.jsx(ee,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,rt>0?e.jsx(ee,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${rt} FOs prüfen`,description:e.jsx(P,{size:"small",onClick:()=>i("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"signals",label:"Executive Signals",children:e.jsxs("div",{className:"v2-dashboard-signal-grid",children:[e.jsxs(L,{className:"v2-dashboard-signal-card v2-dashboard-readiness-card",children:[e.jsx(ye,{title:ct("Readiness Gate","Go/No-Go vor großer Datenpflege. Alle Checks müssen grün sein."),value:ie.ready?"Bereit":"Nicht bereit"}),e.jsxs(Y,{wrap:!0,children:[e.jsx(d,{color:ie.ready?"green":"red",children:ie.ready?"Go":"No-Go"}),e.jsxs(d,{color:ie.ready?"green":"gold",children:[ie.robustMonthsCount,"/",ie.robustRequiredCount," robuste Monate"]})]}),!ie.ready&&ie.blockers.length?e.jsx("div",{className:"v2-dashboard-readiness-blockers",children:ie.blockers.slice(0,2).map(s=>e.jsxs("div",{className:"v2-dashboard-readiness-blocker-item",children:[e.jsxs(j,{type:"secondary",children:[s.label,": ",s.message]}),e.jsx(P,{size:"small",onClick:()=>i(s.route),children:"Öffnen"})]},s.id))}):e.jsx(j,{type:"secondary",children:"Alle Gate-Checks erfüllt."})]}),e.jsxs(L,{className:"v2-dashboard-signal-card",children:[e.jsx(ye,{title:ct("Robust bis","Letzter Monat, in dem alle Hard-Checks erfüllt sind. Danach ist der Kontostand nur Orientierung."),value:C.robustUntilMonth?$(C.robustUntilMonth):"—"}),e.jsxs(j,{type:"secondary",children:[C.robustMonthsCount,"/",C.totalMonths," Monate robust"]})]}),e.jsxs(L,{className:"v2-dashboard-signal-card",children:[e.jsx(ye,{title:ct("Erster negativer Monat (robust)","Erster belastbarer Monat mit negativem Kontostand. Nicht robuste Monate werden dafür ignoriert."),value:Zt?$(Zt):"Keiner"}),e.jsx(j,{type:"secondary",children:"Simulation wird berücksichtigt"})]}),e.jsxs(L,{className:"v2-dashboard-signal-card",children:[e.jsx(ye,{title:ct("Freier Cash nach Buffer","Minimaler belastbarer Kontostand minus Sicherheitsreserve aus 2 Monaten Fixkosten."),value:Wt!=null?D(Wt):"—"}),e.jsxs(j,{type:"secondary",children:["Buffer (2M Fixkosten): ",D(q)]})]}),e.jsxs(L,{className:"v2-dashboard-signal-card",children:[e.jsxs("div",{className:"v2-dashboard-forecast-status-head",children:[e.jsxs(j,{strong:!0,children:["Forecast Freshness",e.jsx(oe,{title:"Ampel nach Importalter: Grün <=35 Tage, Gelb 36-45 Tage, Rot >45 Tage.",children:e.jsx(ws,{className:"v2-dashboard-inline-info"})})]}),e.jsx(d,{color:Te==="fresh"?"green":Te==="aging"?"gold":Te==="stale"?"red":"default",children:Te==="fresh"?"Grün":Te==="aging"?"Gelb":Te==="stale"?"Rot":"Keine Daten"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-status-meta",children:[e.jsxs("div",{children:["Baseline Forecast: ",Us]}),e.jsx("div",{children:Hs}),e.jsxs("div",{children:["Letzter Import: ",ke(kt)]}),e.jsxs("div",{children:["Nächster Import empfohlen: ",Jt?Jt.toLocaleDateString("de-DE"):"—"]}),rt>0?e.jsx("div",{children:e.jsxs(P,{size:"small",onClick:()=>i("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",rt," FOs prüfen"]})}):null]})]})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"cashflow",label:"Kontostand & Cashflow",children:e.jsxs(L,{className:"v2-dashboard-chart-card",children:[e.jsx(he,{level:4,children:"Kontostand & Cashflow"}),e.jsxs(Y,{wrap:!0,children:[e.jsxs(d,{color:"green",children:["Einzahlungen: ",D(zs)]}),e.jsxs(d,{color:"green",children:["Amazon: ",D(Vt)]}),e.jsxs(d,{color:"lime",children:["Sonstige Einzahlungen: ",D(Gt)]}),e.jsxs(d,{color:"red",children:["Auszahlungen: ",D(_s)]}),e.jsxs(d,{color:Ht>=0?"green":"red",children:["Netto: ",D(Ht)]}),e.jsxs(d,{color:"green",children:["Kern In: ",D(((ls=Re[me.CORE])==null?void 0:ls.inflow)||0)]}),e.jsxs(d,{color:"red",children:["Kern Out: ",D(((cs=Re[me.CORE])==null?void 0:cs.outflow)||0)]}),e.jsxs(d,{color:"gold",children:["Plan In: ",D(((ds=Re[me.PLAN])==null?void 0:ds.inflow)||0)]}),e.jsxs(d,{color:"gold",children:["Plan Out: ",D(((us=Re[me.PLAN])==null?void 0:us.outflow)||0)]}),e.jsxs(d,{color:"blue",children:["Ideen In: ",D(((hs=Re[me.IDEAS])==null?void 0:hs.inflow)||0)]}),e.jsxs(d,{color:"blue",children:["Ideen Out: ",D(((ms=Re[me.IDEAS])==null?void 0:ms.outflow)||0)]}),W.length?e.jsxs(d,{color:"gold",children:["Phantom-FOs (vorbehaltlich): ",W.length]}):null,Ne?e.jsxs(d,{color:"gold",children:["PFO bis: ",$(Ne)]}):null,e.jsxs(d,{color:I?"gold":"default",children:["Simulation: ",I?"aktiv":"aus"]})]}),e.jsxs("div",{className:"v2-dashboard-legend-help",children:[e.jsx(j,{type:"secondary",className:"v2-dashboard-legend-note",children:"Legende gruppiert: obere Zeile = Cashflow, untere Zeile = Kontostand."}),e.jsx(oe,{title:"Durchgezogene Linie: belastbarer Kontostand (alle Hard-Checks bestanden).",children:e.jsx(d,{className:"v2-dashboard-legend-tag",children:"Linie solid = belastbar"})}),e.jsx(oe,{title:"Gestrichelte Linie: orientierend, weil mindestens ein Hard-Check fehlt.",children:e.jsx(d,{className:"v2-dashboard-legend-tag",children:"Linie gestrichelt = orientierend"})}),e.jsx(oe,{title:"Rot markiert: Kontostand liegt unter 0 im jeweiligen Zustand.",children:e.jsx(d,{className:"v2-dashboard-legend-tag",children:"Rot = unter 0"})})]}),e.jsx(nr,{style:{height:380},option:Zs})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"actions",label:"Action Center & Forecast Ops",children:e.jsxs(vs,{gutter:[12,12],children:[e.jsx(Me,{xs:24,xl:14,children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Action Center"}),e.jsx(je,{type:"secondary",children:"Priorisierte Maßnahmen, damit der Kontostand wieder belastbar wird."}),C.actions.length?e.jsx("div",{className:"v2-dashboard-actions",children:C.actions.map(s=>e.jsxs("div",{className:`v2-dashboard-action-card is-${s.severity}`,children:[e.jsxs("div",{children:[e.jsx(j,{strong:!0,children:s.title}),e.jsx("div",{className:"v2-dashboard-action-detail",children:s.detail}),e.jsxs("div",{className:"v2-dashboard-action-impact",children:["Impact: ",s.impact]})]}),e.jsxs("div",{className:"v2-dashboard-action-meta",children:[e.jsx(d,{color:s.severity==="error"?"red":"gold",children:s.count}),e.jsx(P,{size:"small",onClick:()=>{var l;return i(qe({route:s.route,actionId:s.id,month:Mt,mode:Mt&&((l=C.monthMap.get(Mt))==null?void 0:l.coverage.projectionMode)||null}))},children:"Öffnen"})]})]},s.id))}):e.jsx(ee,{type:"success",showIcon:!0,message:"Keine offenen Hard-Blocker im gewählten Zeitraum."})]})}),e.jsx(Me,{xs:24,xl:10,children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Forecast Ops"}),e.jsxs(je,{type:"secondary",children:["Monatlicher Import mit Drift-Alarm (A/B Fokus, Profil: ",Q.thresholdProfile,")."]}),e.jsxs(Y,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(d,{color:Nt?"green":"gold",children:["Drift-Review: ",Nt?"geprüft":"offen"]}),St?e.jsxs(d,{children:["Geprüft am: ",new Date(St).toLocaleDateString("de-DE")]}):null,e.jsx(P,{size:"small",onClick:()=>{er()},disabled:!Q.comparedAt||Nt||a,children:"Drift geprüft"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-ops",children:[e.jsxs("div",{children:["Flagged SKUs: ",e.jsx("strong",{children:Ce(Q.flaggedSkuCount,0)})]}),e.jsxs("div",{children:["Flagged A/B: ",e.jsx("strong",{children:Ce(Q.flaggedABCount,0)})]}),e.jsxs("div",{children:["Flagged SKU-Monate: ",e.jsx("strong",{children:Ce(Q.flaggedMonthCount,0)})]}),e.jsxs("div",{children:["Verglichen am: ",e.jsx("strong",{children:ke(Q.comparedAt)})]})]}),Q.topItems.length?e.jsxs("div",{className:"v2-dashboard-drift-list",children:[Q.topItems.slice(0,5).map((s,l)=>e.jsxs("div",{className:"v2-dashboard-drift-item",children:[e.jsxs("div",{children:[e.jsx(j,{strong:!0,children:s.sku}),e.jsxs(j,{type:"secondary",children:[" · ",$(s.month)," · ",s.abcClass]})]}),e.jsxs("div",{children:["ΔUnits ",Ce(s.deltaUnits,0)," · ΔUmsatz ",D(s.deltaRevenue)," · Δ% ",lt(s.deltaPct)]})]},`${s.sku}-${s.month}-${l}`)),e.jsx(P,{size:"small",onClick:()=>i("/v2/forecast"),children:"Zur Forecast-Prüfung"})]}):e.jsx(ee,{type:"success",showIcon:!0,message:"Keine kritischen Drift-Abweichungen im letzten Vergleich."})]})}),e.jsx(Me,{xs:24,xl:24,children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"PO Wareneingang bestätigen"}),e.jsx(je,{type:"secondary",children:"Sichtbar sind POs mit ETA im aktuellen Monat sowie überfällige ETA ohne bestätigten Wareneingang."}),He.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"PO"}),e.jsx("th",{children:"Supplier"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"Stückzahl"}),e.jsx("th",{children:"ETA"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:He.map(s=>{const l=mt[s.id]||s.arrivalDate||Be,m=/^\d{4}-\d{2}-\d{2}$/.test(l);return e.jsxs("tr",{children:[e.jsx("td",{children:s.poNumber||"PO"}),e.jsx("td",{children:s.supplier||"-"}),e.jsx("td",{children:s.skuAliases||"-"}),e.jsx("td",{children:Ce(s.units,0)}),e.jsx("td",{children:ke(s.etaDate)}),e.jsx("td",{children:s.arrivalDate?e.jsxs(d,{color:"green",children:["Angekommen am ",ke(s.arrivalDate)]}):s.isOverdue?e.jsx(d,{color:"red",children:"Überfällig"}):e.jsx(d,{color:"gold",children:"Offen"})}),e.jsx("td",{children:e.jsxs(Y,{wrap:!0,children:[e.jsx(P,{size:"small",onClick:()=>{At(s.id,Be,"v2:dashboard:po-arrival-today")},disabled:a,children:"Heute"}),e.jsx(ys,{type:"date",value:l,onChange:u=>{const M=u.target.value||"";Ot(B=>({...B,[s.id]:M}))},style:{width:160}}),e.jsx(P,{size:"small",onClick:()=>{m&&At(s.id,l,"v2:dashboard:po-arrival-date")},disabled:a||!m||l===s.arrivalDate,children:"Datum setzen"}),s.arrivalDate?e.jsx(P,{size:"small",danger:!0,onClick:()=>{At(s.id,null,"v2:dashboard:po-arrival-clear")},disabled:a,children:"Zurücksetzen"}):null]})})]},s.id)})})]})}):e.jsx(ee,{type:"success",showIcon:!0,message:"Keine offenen PO-Wareneingänge für den aktuellen Scope."})]})})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"robustness",label:"Robustheits-Matrix",children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Robustheits-Matrix"}),e.jsx(je,{type:"secondary",children:"Ein Monat wird nur dann grün, wenn Bestands-Check und Look-Ahead-Bestellpflicht passen. Die Stufen folgen den Schwellen: Vollständig 100 %, Weitgehend ≥95 % ohne A/B-Blocker, Teilweise ≥80 %, sonst Unzureichend."}),e.jsx("div",{className:"v2-dashboard-robust-legend",children:["full","wide","partial","insufficient"].map(s=>{const l=Et(s);return e.jsxs("div",{className:"v2-dashboard-robust-legend-item",children:[e.jsx("span",{className:`v2-dashboard-robust-dot ${l.className}`}),e.jsx(j,{children:l.label})]},s)})}),e.jsx("div",{className:"v2-dashboard-robust-grid",children:C.months.map(s=>{const l=it(s.month),m=l!=null&&rs!=null&&l<rs,u=Et(s.coverage.statusKey);return e.jsxs("button",{type:"button",className:["v2-dashboard-robust-item",x===s.month?"is-selected":"",u.className,m?"is-past":""].filter(Boolean).join(" "),onClick:()=>T(s.month),children:[e.jsxs("div",{className:"v2-dashboard-robust-item-head",children:[e.jsx("span",{children:$(s.month)}),e.jsxs(Y,{size:6,children:[e.jsx(d,{color:u.color,children:u.label}),m?e.jsx(d,{children:"Vergangen"}):null]})]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Coverage: ",lt(s.coverage.ratio*100)," (",s.coverage.coveredSkus,"/",s.coverage.activeSkus,")"]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Blocker SKUs: ",s.coverage.blockerCount," (A/B ",s.coverage.blockerAbCount," · C ",s.coverage.blockerCCount,")"]})]},s.month)})}),g?e.jsxs("div",{className:"v2-dashboard-robust-detail",children:[e.jsxs("div",{className:"v2-dashboard-robust-detail-head",children:[e.jsx(j,{strong:!0,children:$(g.month)}),e.jsxs(Y,{wrap:!0,children:[ln(g.coverage.statusKey),e.jsxs(d,{children:["Coverage: ",lt(g.coverage.ratio*100)]}),e.jsxs(d,{children:["Blocker: ",g.coverage.blockerCount]}),e.jsxs(d,{children:["A/B: ",g.coverage.blockerAbCount," · C: ",g.coverage.blockerCCount]}),g.coverage.overdueOrderDutySkuCount>0?e.jsxs(d,{color:"red",children:["Überfällig: ",g.coverage.overdueOrderDutySkuCount]}):null]})]}),e.jsx("div",{className:"v2-dashboard-robust-checklist",children:Ws.map(s=>e.jsxs("div",{className:`v2-dashboard-robust-checklist-item ${s.passed?"is-pass":"is-fail"}`,children:[e.jsx("span",{className:"v2-dashboard-robust-check-icon",children:s.passed?"✅":"❌"}),e.jsxs("div",{children:[e.jsx(j,{strong:!0,children:s.label}),e.jsx("div",{children:e.jsx(j,{type:"secondary",children:s.description})})]})]},s.key))}),e.jsx(Cr,{size:"small",pagination:!1,rowKey:"key",columns:Qs,dataSource:g.checks}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(j,{strong:!0,children:["Bestands-Probleme in ",$(g.month)]}),Xt.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Problem"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Xt.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:cn(s)}),e.jsx("td",{children:e.jsxs(Y,{wrap:!0,children:[e.jsx(P,{size:"small",onClick:()=>i(qe({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:g.month,sku:s.sku,mode:g.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(P,{size:"small",onClick:()=>i(Ft({issues:"all",sku:s.sku})),children:"Produkt öffnen"}),s.issueType==="forecast_missing"?e.jsx(P,{size:"small",onClick:()=>i(Ps({sku:s.sku,month:g.month})),children:"Absatzprognose öffnen"}):null]})})]},`${s.sku}:${s.issueType}`))})]})}):e.jsx(j,{type:"secondary",children:"Keine Bestandsprobleme in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(j,{strong:!0,children:["Bestellpflicht in ",$(g.month)]}),es.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Erster Risikomonat"}),e.jsx("th",{children:"Spätester Bestellzeitpunkt"}),e.jsx("th",{children:"Warum Blocker"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:es.map(s=>{const l=String(s.sku||"").trim().toLowerCase(),m=`${l}|${String(s.firstRiskMonth||"").trim()}|${String(s.orderMonth||"").trim()}`,u=Bs.get(m)||Ks.get(l)||null;return e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:$(s.firstRiskMonth)}),e.jsxs("td",{children:[ke(s.latestOrderDate)," (",$(s.orderMonth),")",s.overdue?e.jsx(d,{color:"red",style:{marginInlineStart:8},children:"Überfällig"}):null]}),e.jsx("td",{children:s.reason}),e.jsx("td",{children:e.jsxs(Y,{wrap:!0,children:[e.jsx(P,{size:"small",onClick:()=>i(qe({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:g.month,sku:s.sku,mode:g.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(P,{size:"small",type:"primary",onClick:()=>i(Ms({sku:s.sku,month:g.month,suggestedUnits:(u==null?void 0:u.suggestedUnits)??s.shortageUnits,requiredArrivalDate:(u==null?void 0:u.requiredArrivalDate)??s.requiredArrivalDate,recommendedOrderDate:(u==null?void 0:u.recommendedOrderDate)??s.recommendedOrderDate,source:u?"phantom_fo":"inventory_projection",phantomId:(u==null?void 0:u.id)||null,firstRiskMonth:(u==null?void 0:u.firstRiskMonth)??s.firstRiskMonth,orderMonth:(u==null?void 0:u.orderMonth)??s.orderMonth,leadTimeDays:(u==null?void 0:u.leadTimeDays)??s.leadTimeDays,returnTo:"/v2/dashboard"})),children:"FO anlegen"}),e.jsx(P,{size:"small",onClick:()=>i(hn({sku:s.sku,suggestedUnits:s.shortageUnits,requiredArrivalDate:s.requiredArrivalDate,recommendedOrderDate:s.recommendedOrderDate})),children:"PO öffnen"}),e.jsx(P,{size:"small",onClick:()=>i(Ft({issues:"all",sku:s.sku})),children:"Produkt öffnen"})]})})]},`${s.sku}:${s.firstRiskMonth}:${s.orderMonth}`)})})]})}):e.jsx(j,{type:"secondary",children:"Keine fällige Bestellpflicht in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsx(j,{strong:!0,children:"Weitere Hard-Checks"}),ss.length?e.jsx("div",{className:"v2-dashboard-blocker-list",children:ss.map(s=>e.jsxs("div",{className:"v2-dashboard-blocker-item",children:[e.jsxs("div",{children:[e.jsx(j,{children:s.message}),s.sku?e.jsxs(j,{type:"secondary",children:[" · ",s.sku]}):null]}),e.jsx(P,{size:"small",onClick:()=>i(qe({route:s.route,checkKey:s.checkKey,month:s.month,sku:s.sku||null,mode:g.coverage.projectionMode})),children:"Öffnen"})]},s.id))}):e.jsx(j,{type:"secondary",children:"Keine weiteren Hard-Check-Blocker."})]})]}):null]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"simulation",label:"Payout Planner (Simulation)",children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Payout Planner (Simulation)"}),e.jsx(je,{type:"secondary",children:"Einmalige Dividenden oder CAPEX simulieren und optional als echten Eintrag übernehmen."}),e.jsxs("div",{className:"v2-dashboard-sim-grid",children:[e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(j,{children:"Typ"}),e.jsx(Ze,{value:ge,onChange:s=>Ie(s),options:[{value:"dividend",label:"Dividende"},{value:"capex",label:"CAPEX"}]})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(j,{children:"Monat"}),e.jsx(Ze,{value:se,onChange:s=>be(s),options:U.map(s=>({value:s,label:$(s)}))})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(j,{children:"Betrag (EUR)"}),e.jsx(Ir,{value:Number.isFinite(ae)?ae:null,onChange:s=>we(typeof s=="number"?s:null),min:0,controls:!1,placeholder:"0"})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(j,{children:"Label"}),e.jsx(ys,{value:Ee,onChange:s=>J(s.target.value),placeholder:ut(ge)})]})]}),e.jsxs("div",{className:"v2-dashboard-sim-status",children:[e.jsx(d,{color:I?"gold":"default",children:I?"Simulation aktiv":"Keine Simulation"}),e.jsxs(d,{color:q>0?"blue":"red",children:["Buffer-Ziel: ",D(q)]}),I&&q<=0?e.jsx(d,{color:"red",children:"Fixkostenbasis fehlt"}):null,I&&q>0?e.jsx(d,{color:qt?"green":"red",children:qt?"Sicher":`Kritisch ab ${yt?$(yt):"sofort"}`}):null]}),e.jsxs(Y,{children:[e.jsx(P,{onClick:()=>{we(null),J("")},children:"Simulation zurücksetzen"}),e.jsx(P,{type:"primary",onClick:()=>{Js()},disabled:!I,loading:a,children:"Als echten Eintrag übernehmen"})]})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"pnl",label:"Monatliche PnL (Drilldown)",children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Monatliche PnL (Drilldown)"}),e.jsx(je,{type:"secondary",children:"Einzahlungen, PO/FO-Zahlungen, Fixkosten und Steuern je Monat. PO/FO-Positionen sind bis auf Milestone-Ebene aufklappbar."}),e.jsx(ne,{className:"v2-dashboard-pnl-collapse",activeKey:G,onChange:s=>te(Array.isArray(s)?s.map(String):[String(s)]),items:Ys})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"actuals",label:"Plan/Ist Drilldown",children:e.jsxs(L,{children:[e.jsx(he,{level:4,children:"Plan/Ist Drilldown"}),e.jsx(je,{type:"secondary",children:"Monatsvergleich zwischen geplantem und erfasstem Istwert aus den Monats-Ist-Daten."}),e.jsx(ar,{data:Ls,columns:qs,minTableWidth:980,tableLayout:"auto"})]})}]}),e.jsx(ne,{className:"v2-dashboard-module-collapse",activeKey:re,onChange:xe,items:[{key:"kpis",label:"KPI-Übersicht",children:e.jsxs(vs,{gutter:[12,12],children:[e.jsx(Me,{xs:24,md:12,xl:6,children:e.jsx(L,{children:e.jsx(ye,{title:"Opening Balance",value:Number(((fs=pe.kpis)==null?void 0:fs.opening)||0),formatter:s=>D(s)})})}),e.jsx(Me,{xs:24,md:12,xl:6,children:e.jsx(L,{children:e.jsx(ye,{title:"Sales Payout Ø",value:Number(((gs=pe.kpis)==null?void 0:gs.salesPayoutAvg)||0),formatter:s=>D(s)})})}),e.jsx(Me,{xs:24,md:12,xl:6,children:e.jsx(L,{children:e.jsx(ye,{title:"Robuste Monate",value:`${C.robustMonthsCount}/${C.totalMonths}`})})}),e.jsx(Me,{xs:24,md:12,xl:6,children:e.jsx(L,{children:e.jsx(ye,{title:"Letzter Kontostand",value:Number((xt==null?void 0:xt.closing)||0),formatter:s=>D(s)})})})]})}]})]}):e.jsx("div",{className:"v2-page",children:e.jsx(ee,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{lo as default};
