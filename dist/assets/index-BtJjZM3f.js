import{t as d,_ as js,k as e,I as se,J as Xt,K as ks,L as w,S as J,M as m,T as Me,R as Vt,N as ke,O as Ht,P as mt}from"./index-elUAAuqx.js";import{E as Ds}from"./index-Dasg9NUr.js";import{c as Ns}from"./cashflow-BOzsDTyz.js";import{T as Ss}from"./TanStackGrid-BrER4EZn.js";import{b as Ms}from"./dashboardMaturity-BGfmwC8q.js";import{b as As}from"./orderEditorFactory-hbPkdMRR.js";import{c as Cs,a as ws,b as Is,d as Es}from"./orderUtils-BfaSmxZO.js";import{b as es,r as Rs,a as Fs,c as Ps}from"./phantomFo-C1P5_prX.js";import{e as Os,g as Ts}from"./forecastVersioning-c8wz3TkU.js";import{c as $s}from"./inventoryProjection-xbzaWWBa.js";import{m as Ks,c as gt,a as Ls,n as Bs,b as Ze,f as B}from"./months-DiLwPhVv.js";import{u as zs,C as $}from"./workspace-DMXjunb_.js";import{h as _s,g as Us,s as Vs}from"./uiPrefs-CxTlE9qM.js";import{s as Hs}from"./index-4z8CX_jA.js";import{C as te}from"./Collapse-DgS_t0WH.js";import{S as ht}from"./index-BytK8p14.js";import{S as be}from"./index-BzBVetP4.js";import{R as ts}from"./InfoCircleOutlined-CdcHYM2g.js";import{F as Gs}from"./Table-C_tyMDj7.js";import{T as Ws}from"./index-DChuXDnn.js";import"./planProducts-BY0Y95Lf.js";import"./store-BfTg1Dl2.js";import"./prefill-Q3SvZbkG.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-CFkOROtn.js";import"./foSuggestion-Ck1952gl.js";import"./productCompletenessV2-C6U-GVjR.js";import"./abcClassification-BRLNgmfY.js";import"./Dropdown-onqalcmq.js";import"./index-CVrItAb4.js";import"./useBubbleLock-DQn9hN27.js";import"./index-CYEnK3OG.js";import"./Pagination-B4liCMYf.js";const{Text:Zs}=Xt;function qs({className:t,groups:r=[],items:n,visibleStartMs:a,visibleEndMs:o,height:l=180,emptyMessage:c="Keine Timeline-Daten vorhanden."}){const k=d.useRef(null),[j,E]=d.useState(null),[x,b]=d.useState(null);d.useEffect(()=>{if(typeof window>"u")return;let p=!0;return js(()=>import("./vis-timeline-graph2d-DVPA6HI_.js"),[]).then(P=>{p&&E(P)}).catch(P=>{p&&b(P instanceof Error?P.message:"Timeline konnte nicht geladen werden.")}),()=>{p=!1}},[]);const h=d.useMemo(()=>n.map(p=>({id:p.id,type:p.type||(p.endMs!=null?"range":"box"),content:p.content||"",start:p.startMs,end:p.endMs,className:p.className,title:p.title,selectable:!1,editable:!1})),[n]),N=d.useMemo(()=>r.map(p=>({id:p.id,content:p.content,className:p.className})),[r]),T=d.useMemo(()=>{const p=Number.isFinite(a)?a:Date.now(),P=Number.isFinite(o)?o:p+30*24*60*60*1e3,O=P>p?P:p+30*24*60*60*1e3;return{stack:!0,zoomable:!1,moveable:!1,selectable:!1,showCurrentTime:!0,orientation:{axis:"top",item:"top"},margin:{axis:10,item:8},start:p,end:O,tooltip:{followMouse:!0,overflowMethod:"cap"}}},[o,a]);return d.useEffect(()=>{if(!j||!k.current||!h.length)return;const p=k.current;p.innerHTML="";const P=N.length?new j.Timeline(p,h,N,T):new j.Timeline(p,h,T);return()=>{P.destroy()}},[N,h,T,j]),n.length?x?e.jsx(se,{type:"warning",showIcon:!0,message:`Timeline konnte nicht geladen werden: ${x}`}):j?e.jsx("div",{className:["v2-vis-timeline",t||""].filter(Boolean).join(" "),children:e.jsx("div",{ref:k,style:{height:l}})}):e.jsx("div",{className:"v2-vis-timeline-loading",children:e.jsx(Zs,{type:"secondary",children:"Timeline wird geladen..."})}):e.jsx(se,{type:"info",showIcon:!0,message:c})}const ft=24*60*60*1e3,Ys={slug:"po",entityLabel:"PO",numberField:"poNo"};function ue(t){return String(t||"").trim().toLowerCase()}function ve(t){const r=String(t||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(r))return null;const[n,a,o]=r.split("-").map(Number);if(!n||!a||!o)return null;const l=new Date(Date.UTC(n,a-1,o));return Number.isNaN(l.getTime())?null:r}function Fe(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(Date.UTC(r,n-1,a));return Number.isNaN(o.getTime())?null:o.getTime()}function Re(t){if(!t)return"—";const r=Fe(t);return r==null?t:new Date(r).toLocaleDateString("de-DE")}function Js(t){return Number.isFinite(t)?t.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function Qs(t){const r=t.settings&&typeof t.settings=="object"?t.settings:{},n=r.cny&&typeof r.cny=="object"?r.cny:{start:"",end:""},a=r.cnyBlackoutByYear&&typeof r.cnyBlackoutByYear=="object"?r.cnyBlackoutByYear:{};return{fxRate:Number(r.fxRate||0),fxFeePct:Number(r.fxFeePct||0),dutyRatePct:Number(r.dutyRatePct||0),dutyIncludeFreight:r.dutyIncludeFreight!==!1,eustRatePct:Number(r.eustRatePct||0),vatRefundEnabled:r.vatRefundEnabled!==!1,vatRefundLagMonths:Number(r.vatRefundLagMonths||0),freightLagDays:Number(r.freightLagDays||0),cny:n,cnyBlackoutByYear:a}}function Xs(t){const r=ue(t.sourceId),n=ue(t.sourceNumber);return(Array.isArray(t.state.pos)?t.state.pos:[]).find(o=>{const l=ue(o.id),c=ue(o.poNo);return!!(r&&r===l||n&&n===c||n&&n===l)})||null}function er(t){const r=ue(t.sourceId),n=ue(t.sourceNumber);return(Array.isArray(t.state.fos)?t.state.fos:[]).find(o=>{const l=ue(o.id),c=ue(o.foNo),k=ue(o.foNumber);return!!(r&&r===l||n&&(n===c||n===k||n===l))})||null}function ss(t,r,n){return String(t||"").trim().toLowerCase()==="paid"||String(r||"").trim()||String(n||"").trim()?"paid":"open"}function rs(t){const r=String(t.explicitDirection||"").trim().toLowerCase();if(r==="in")return"in";if(r==="out")return"out";const n=`${String(t.eventType||"")} ${String(t.category||"")} ${String(t.label||"")}`.toLowerCase();return n.includes("refund")||n.includes("erstatt")||t.amount<0?"in":"out"}function tr(t,r){const n=Array.isArray(t.payments)?t.payments:[];let a=[];try{const o=typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r));a=As(o,Ys,Qs(t),n,{includeIncoming:!0})}catch{a=[]}return a.map(o=>{const l=ve(o.dueDate);if(!l)return null;const c=Math.abs(Number(o.plannedEur||0));if(!(c>0))return null;const k=rs({amount:Number(o.plannedEur||0),eventType:o.eventType,label:o.label||o.typeLabel,explicitDirection:o.direction});return{id:String(o.id||`po-pay-${l}`),label:String(o.typeLabel||o.label||"Zahlung"),dueDate:l,amountEur:c,status:ss(o.status,o.paidDate,o.paymentId),direction:k}}).filter(o=>!!o)}function sr(t){const r=Number(t.fxRate||0);return(Array.isArray(t.payments)?t.payments:[]).map((a,o)=>{const l=ve(a.dueDate);if(!l)return null;const c=Number(a.amount||0);if(!Number.isFinite(c)||c===0)return null;const k=rs({amount:c,category:a.category,label:a.label}),j=Math.abs(Es(c,a.currency||"EUR",r));return j>0?{id:String(a.id||`fo-pay-${o+1}`),label:String(a.label||a.category||"Zahlung"),dueDate:l,amountEur:j,status:ss(a.status,a.paidDate,a.paymentId),direction:k}:null}).filter(a=>!!a)}function Gt(t){const r=[],n=Fe(t.orderDate),a=Fe(t.etdDate),o=Fe(t.etaDate);n!=null&&a!=null&&a>=n&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:production`,type:"range",content:"Produktion",startMs:n,endMs:a,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--production",title:`Produktion: ${Re(t.orderDate)} bis ${Re(t.etdDate)}`}),a!=null&&o!=null&&o>=a&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:transit`,type:"range",content:"Transit",startMs:a,endMs:o,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--transit",title:`Transit: ${Re(t.etdDate)} bis ${Re(t.etaDate)}`}),[{key:"order",label:"Order",date:t.orderDate},{key:"etd",label:"ETD",date:t.etdDate},{key:"eta",label:"ETA",date:t.etaDate}].forEach(h=>{const N=Fe(h.date);N!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:milestone:${h.key}`,type:"box",content:h.label,startMs:N,className:`v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--milestone v2-dashboard-order-timeline-item--milestone-${h.key}`,title:`${h.label}: ${Re(h.date)}`})}),t.payments.forEach(h=>{const N=Fe(h.dueDate);N!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:payment:${h.id}`,type:"box",content:h.direction==="in"?"+":" ",startMs:N,className:["v2-dashboard-order-timeline-item","v2-dashboard-order-timeline-item--payment",h.status==="paid"?"v2-dashboard-order-timeline-item--payment-paid":"v2-dashboard-order-timeline-item--payment-open",h.direction==="in"?"v2-dashboard-order-timeline-item--payment-incoming":"v2-dashboard-order-timeline-item--payment-outgoing"].join(" "),title:[h.label,`Fällig: ${Re(h.dueDate)}`,`Betrag: ${Js(h.amountEur)}`,`Status: ${h.status==="paid"?"Bezahlt":"Offen"}`].join(`
`)})});const c=r.flatMap(h=>[h.startMs,h.endMs].filter(N=>Number.isFinite(N)));if(!c.length)return null;const k=Math.min(...c),j=Math.max(...c),E=k-14*ft,x=j+14*ft,b=x>E?x:E+30*ft;return{source:t.source,sourceId:t.sourceId,sourceNumber:t.sourceNumber,orderDate:t.orderDate,etdDate:t.etdDate,etaDate:t.etaDate,visibleStartMs:E,visibleEndMs:b,items:r}}function rr(t){const r=t.source==="fo"?"fo":"po",n=t.sourceId?String(t.sourceId):null,a=t.sourceNumber?String(t.sourceNumber):null;if(r==="po"){const c=Xs({state:t.state,sourceId:n,sourceNumber:a});if(!c)return null;const k=t.state.settings&&typeof t.state.settings=="object"?t.state.settings:{},j=Cs({items:c.items,orderDate:c.orderDate,fxRate:c.fxOverride??k.fxRate,fallback:c}),E=ws({orderDate:c.orderDate,productionLeadTimeDays:j.prodDays||c.prodDays,logisticsLeadTimeDays:j.transitDays||c.transitDays,bufferDays:0});return Gt({source:"po",sourceId:String(c.id||n||""),sourceNumber:String(c.poNo||a||""),orderDate:ve(c.orderDate||E.orderDate),etdDate:ve(c.etdManual||E.etdDate),etaDate:ve(c.etaManual||E.etaDate),payments:tr(t.state,c)})}const o=er({state:t.state,sourceId:n,sourceNumber:a});if(!o)return null;const l=Is({targetDeliveryDate:o.targetDeliveryDate||o.deliveryDate,productionLeadTimeDays:o.productionLeadTimeDays,logisticsLeadTimeDays:o.logisticsLeadTimeDays,bufferDays:o.bufferDays});return Gt({source:"fo",sourceId:String(o.id||n||""),sourceNumber:String(o.foNo||o.foNumber||a||""),orderDate:ve(o.orderDate||l.orderDate),etdDate:ve(o.etdDate||l.etdDate),etaDate:ve(o.etaDate||l.etaDate||o.targetDeliveryDate||o.deliveryDate),payments:sr(o)})}function Je(t){if(!t)return null;const r=new Date(String(t));return Number.isNaN(r.getTime())?null:r}function nr(t){if(typeof t.active=="boolean")return t.active;const r=String(t.status||"").trim().toLowerCase();return r?r==="active"||r==="aktiv"||r==="prelaunch"||r==="not_launched"||r==="planned":!0}function bt(t){return String(t||"").trim()}function or(t){return(Array.isArray(t.products)?t.products:[]).filter(n=>bt(n.sku)?nr(n):!1).map(n=>({sku:bt(n.sku),alias:String(n.alias||n.sku||""),status:String(n.status||"active"),safetyStockDohOverride:n.safetyStockDohOverride,foCoverageDohOverride:n.foCoverageDohOverride}))}function ar(t){const r=t.lastDriftSummary&&typeof t.lastDriftSummary=="object"?t.lastDriftSummary:{},n=typeof r.comparedAt=="string"?r.comparedAt:null;return n&&Je(n)?n:null}function ir(t){return{id:`gate:${t.key}`,key:t.key,severity:"error",label:t.label,message:t.detail,route:t.route}}function lr(t){const r=t.state||{},n=Number.isFinite(t.horizonMonths)?Math.max(1,Math.round(Number(t.horizonMonths))):12,a=Ks(gt(),n),o=es({state:r,months:a}),l=o.robustMonthsCount>=a.length&&a.length>0,c=or(r),k=$s({state:r,months:a,products:c,snapshot:null,snapshotMonth:Ls(gt(),-1),projectionMode:"units"}),j=Array.isArray(k.anchorSkuMissingHistory)?k.anchorSkuMissingHistory.map(ne=>bt(ne)).filter(Boolean).sort((ne,W)=>ne.localeCompare(W,"de-DE")):[],E=j.length===0,x=r.forecast&&typeof r.forecast=="object"?r.forecast:{},b=typeof x.lastImportAt=="string"?x.lastImportAt:null,h=Je(b),N=new Date,T=24*60*60*1e3,p=h?Math.floor((N.getTime()-h.getTime())/T):null,P=p!=null&&p<=35,O=ar(x),X=typeof x.lastDriftReviewedComparedAt=="string"?x.lastDriftReviewedComparedAt:null,re=typeof x.lastDriftReviewedAt=="string"?x.lastDriftReviewedAt:null,me=!!(O&&X&&Bs(String(O).slice(0,7))&&X===O&&Je(re)),Ae=t.runtimeErrorAt&&Je(t.runtimeErrorAt)?String(t.runtimeErrorAt):null,he=!Ae,_e=[{key:"runtime_stable",label:"Runtime stabil",passed:he,status:he?"ok":"error",detail:he?"Keine offenen Tab-Ladefehler.":`Offener Tab-Ladefehler seit ${new Date(Ae).toLocaleString("de-DE")}${t.runtimeErrorRoute?` (${t.runtimeErrorRoute})`:""}.`,route:"/v2/dashboard",blockerCount:he?0:1},{key:"robust_12m",label:"Robustheit 12M",passed:l,status:l?"ok":"error",detail:l?`${o.robustMonthsCount}/${a.length} Monate robust.`:`${o.robustMonthsCount}/${a.length} Monate robust (erforderlich: ${a.length}).`,route:"/v2/dashboard",blockerCount:l?0:Math.max(0,a.length-o.robustMonthsCount)},{key:"anchor_history_complete",label:"Anchor-Historie vollständig",passed:E,status:E?"ok":"error",detail:E?"Alle aktiven/prelaunch SKUs haben Snapshot-Historie.":`${j.length} SKU(s) ohne Snapshot-Historie (Anker=0).`,route:"/v2/inventory/projektion?source=dashboard&risk=under_safety&abc=ab&expand=all",blockerCount:j.length},{key:"forecast_fresh",label:"Forecast aktuell",passed:P,status:P?"ok":"error",detail:P?`${p} Tage seit Import.`:p==null?"Kein Forecast-Import vorhanden.":`${p} Tage seit Import (erlaubt <= 35).`,route:"/v2/forecast",blockerCount:P?0:1},{key:"forecast_drift_reviewed",label:"Drift geprüft",passed:me,status:me?"ok":"error",detail:me?`Drift-Stand vom ${new Date(O).toLocaleDateString("de-DE")} geprüft.`:O?"Aktueller Drift-Stand ist noch nicht als geprüft markiert.":"Noch kein Driftvergleich verfügbar.",route:"/v2/forecast",blockerCount:me?0:1}],Pe=_e.filter(ne=>!ne.passed).map(ne=>ir(ne)),ye=Pe.length===0;return{ready:ye,status:ye?"ready":"not_ready",horizonMonths:n,checks:_e,blockers:Pe,robustMonthsCount:o.robustMonthsCount,robustRequiredCount:a.length,anchorMissingHistoryCount:j.length,anchorMissingHistorySkus:j,forecastDaysSinceImport:p,driftComparedAt:O,driftReviewedAt:re,driftReviewedForComparedAt:X}}function Be(t){return String(t||"").trim().toLowerCase()}function Xe(t){const r=String(t||"").trim();if(!r)return null;const n=r.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!n)return null;const a=Number(n[1]),o=Number(n[2]),l=Number(n[3]),c=new Date(a,o-1,l);return Number.isNaN(c.getTime())||c.getFullYear()!==a||c.getMonth()!==o-1||c.getDate()!==l?null:`${a}-${String(o).padStart(2,"0")}-${String(l).padStart(2,"0")}`}function cr(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(r,n-1,a);return Number.isNaN(o.getTime())?null:o}function dr(){const t=new Date,r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${r}-${n}-${a}`}function Wt(t){const r=Number(t);return Number.isFinite(r)?Math.max(0,Math.round(r)):0}function ur(t){const r=Xe(t.etaManual||t.etaDate||t.eta);if(r)return r;const n=cr(Xe(t.orderDate));if(!n)return null;const a=Math.max(0,Number(t.prodDays||0)),o=Math.max(0,Number(t.transitDays||0)),l=new Date(n.getTime());l.setDate(l.getDate()+a+o);const c=l.getFullYear(),k=String(l.getMonth()+1).padStart(2,"0"),j=String(l.getDate()).padStart(2,"0");return`${c}-${k}-${j}`}function mr(t,r){const n=Be(t.supplierId||t.supplier||t.supplierName);return n&&r.has(n)?String(r.get(n)):String(t.supplierName||t.supplier||"-")}function hr(t,r){const n=Array.isArray(t.items)?t.items:[],a=n.length?n.map(l=>String(l.sku||"").trim()).filter(Boolean):[String(t.sku||"").trim()].filter(Boolean);return Array.from(new Set(a.map(l=>r.get(Be(l))||l))).join(", ")||"-"}function fr(t){const r=Array.isArray(t.items)?t.items:[];return r.length?r.reduce((n,a)=>n+Wt(a.units),0):Wt(t.units)}function gr(t){const r=t.state&&typeof t.state=="object"?t.state:{},n=String(t.month||""),a=Xe(t.todayIso)||dr(),o=new Map;(Array.isArray(r.suppliers)?r.suppliers:[]).forEach(x=>{const b=x&&typeof x=="object"?x:{},h=String(b.name||"").trim();if(!h)return;const N=Be(b.id),T=Be(h);N&&o.set(N,h),T&&o.set(T,h)});const c=new Map;(Array.isArray(r.products)?r.products:[]).forEach(x=>{const b=x&&typeof x=="object"?x:{},h=String(b.sku||"").trim();h&&c.set(Be(h),String(b.alias||h))});const j=[];return(Array.isArray(r.pos)?r.pos:[]).forEach(x=>{const b=x&&typeof x=="object"?x:{};if(b.archived||String(b.status||"").toUpperCase()==="CANCELLED")return;const h=String(b.id||b.poNo||"").trim();if(!h)return;const N=ur(b);if(!N)return;const T=Xe(b.arrivalDate),P=N.slice(0,7)===n,O=!T,X=O&&N<a;!P&&!X||j.push({id:h,poNumber:String(b.poNo||b.id||""),supplier:mr(b,o),skuAliases:hr(b,c),units:fr(b),etaDate:N,arrivalDate:T,monthRelevant:P,isOverdue:X,pending:O})}),j.sort((x,b)=>{if(x.pending!==b.pending)return x.pending?-1:1;if(x.monthRelevant!==b.monthRelevant)return x.monthRelevant?-1:1;const h=x.etaDate||"9999-12-31",N=b.etaDate||"9999-12-31",T=h.localeCompare(N);return T!==0?T:x.poNumber.localeCompare(b.poNumber)})}const{Paragraph:pe,Text:y,Title:de}=Xt,br="v2:last-route-error";function pr(){return new Date().toISOString()}function xr(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const Zt=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],vr=[{key:"inflow",label:"Einzahlungen"},{key:"po_fo",label:"PO/FO Zahlungen"},{key:"fixcost",label:"Fixkosten"},{key:"tax",label:"Steuern & Importkosten"},{key:"outflow",label:"Sonstige Auszahlungen"},{key:"other",label:"Sonstige"}],yr=new Set(["signals","cashflow","actions","robustness","simulation","pnl","actuals","kpis"]),jr=["signals","cashflow"],qt={full:{label:"Vollständig",color:"green",className:"is-full"},wide:{label:"Weitgehend",color:"lime",className:"is-wide"},partial:{label:"Teilweise",color:"orange",className:"is-partial"},insufficient:{label:"Unzureichend",color:"red",className:"is-insufficient"}};function Yt(t){const r=new Set;return t.forEach(n=>{const a=String(n||"").trim();yr.has(a)&&r.add(a)}),Array.from(r)}function kr(t){return Array.isArray(t)?t:t?[t]:[]}function F(t){const r=Number(t);return Number.isFinite(r)?r.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function De(t){return Number.isFinite(t)?t<0?`−${F(Math.abs(t))}`:F(t):"-"}function Ne(t,r=0){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"-"}function qe(t){const r=Number(t);return Number.isFinite(r)?`${r.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"-"}function xe(t){if(!t)return"-";const r=new Date(t);return Number.isNaN(r.getTime())?t:r.toLocaleDateString("de-DE")}function Dr(t){return t==="ok"?e.jsx(m,{color:"green",children:"OK"}):e.jsx(m,{color:"red",children:"Offen"})}function pt(t){return qt[t]||qt.insufficient}function Nr(t){const r=pt(t);return e.jsx(m,{color:r.color,children:r.label})}function Sr(t){return t.issueType==="forecast_missing"?"Forecast fehlt":t.issueType==="stock_oos"?"Out-of-Stock":"Unter Safety"}function Se(t){return t.reduce((r,n)=>r+Number(n.amount||0),0)}function Mr(t,r){const n=new Date(t.getTime());return n.setDate(n.getDate()+r),n}function Qe(t){return t==="dividend"?"Dividende (Simulation)":"CAPEX (Simulation)"}function Ye(t,r){return e.jsxs("span",{className:"v2-dashboard-signal-title",children:[t,e.jsx(Me,{title:r,children:e.jsx(ts,{})})]})}function ze(t,r){const[n,a=""]=String(t||"").split("?"),o=new URLSearchParams(a);Object.entries(r).forEach(([c,k])=>{if(k==null||k===""){o.delete(c);return}o.set(c,k)});const l=o.toString();return l?`${n}?${l}`:n}function Ar(t){return ze("/v2/inventory/projektion",{source:"dashboard",risk:t.risk,abc:t.abc,month:t.month||null,sku:t.sku||null,mode:t.mode||null,expand:"all"})}function xt(t){return ze("/v2/products",{source:"dashboard",issues:t.issues||"needs_fix",sku:t.sku||null,expand:"all"})}function ns(t){return ze("/v2/forecast",{source:"dashboard",sku:t.sku||null,month:t.month||null})}function Jt(t){return ze("/v2/orders/fo",{source:t.source||"inventory_projection",sku:t.sku||null,month:t.month||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null,phantomId:t.phantomId||null,firstRiskMonth:t.firstRiskMonth||null,orderMonth:t.orderMonth||null,leadTimeDays:Number.isFinite(Number(t.leadTimeDays))?String(Math.max(0,Math.round(Number(t.leadTimeDays)))):null,returnTo:t.returnTo||"/v2/dashboard"})}function Cr(t){return ze("/v2/orders/po",{source:"inventory_projection",sku:t.sku||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null})}function Le(t){const r=String(t.route||"");if(r.startsWith("/v2/forecast"))return ns({sku:t.sku||null,month:t.month||null});if(r.startsWith("/v2/inventory/projektion")){const n=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"under_safety":"all",a=t.sku?"all":t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"ab":"all";return Ar({risk:n,abc:a,month:t.month||null,sku:t.sku||null,mode:t.mode||null})}if(r.startsWith("/v2/products")){const n=t.actionId==="revenue_inputs"||t.checkKey==="revenue_inputs"?"revenue":"needs_fix";return xt({issues:n,sku:t.sku||null})}return r}function wr(t){const r=t.map(n=>(Array.isArray(n.entries)?n.entries:[]).filter(l=>String(l.direction||"").toLowerCase()==="out"&&String(l.group||"")==="Fixkosten").reduce((l,c)=>l+Math.abs(Number(c.amount||0)),0)).filter(n=>n>0);return r.length?r.reduce((n,a)=>n+a,0)/r.length:0}function Ir(t,r){const n={fixcost:0,po:0,fo:0,phantomFo:0};return t.forEach(a=>{if(!a||typeof a!="object")return;const o=a;if(String(o.direction||"").toLowerCase()!=="out")return;const l=Math.abs(Number(o.amount||0));if(!Number.isFinite(l)||l<=0)return;const c=String(o.source||"").toLowerCase();if(c==="po"){n.po+=l;return}if(c==="fo"){const j=String(o.sourceId||"").trim(),E=o.meta&&typeof o.meta=="object"?o.meta:{};o.provisional===!0||E.phantom===!0||(j?(r==null?void 0:r.has(j))===!0:!1)?n.phantomFo+=l:n.fo+=l;return}const k=String(o.group||"").toLowerCase();(c==="fixcosts"||k==="fixkosten")&&(n.fixcost+=l)}),n}function Er(t,r){var a;if(!r||!Number.isFinite(r.amount)||r.amount<=0)return t.map(o=>({...o}));let n=Number(((a=t[0])==null?void 0:a.opening)||0);return t.map((o,l)=>{const c=l===0?Number(o.opening||0):n,k=o.month===r.month,j=k?Math.abs(Number(r.amount||0)):0,E=Number(o.inflow||0),x=Number(o.outflow||0)+j,b=E-x,h=c+b;n=h;const N=k?[{id:`sim-${r.type}-${r.month}`,direction:"out",amount:j,label:r.label||Qe(r.type),month:r.month,kind:r.type==="dividend"?"dividend":"capex",group:r.type==="dividend"?"Dividende & KapESt":"Extras (Out)",source:"simulation"}]:[];return{...o,opening:c,inflow:E,outflow:x,net:b,closing:h,entries:[...Array.isArray(o.entries)?o.entries:[],...N],simApplied:k}})}function Rr(t,r){var n;for(let a=0;a<t.length;a+=1){const o=t[a].month;if((n=r.get(o))!=null&&n.robust&&Number(t[a].closing||0)<0)return o}return null}function Fr(t){if(!t||typeof t!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0,topItems:[]};const r=t,n=Array.isArray(r.topItems)?r.topItems:[];return{comparedAt:typeof r.comparedAt=="string"?r.comparedAt:null,thresholdProfile:String(r.thresholdProfile||"medium"),flaggedSkuCount:Number(r.flaggedSkuCount||0),flaggedABCount:Number(r.flaggedABCount||0),flaggedMonthCount:Number(r.flaggedMonthCount||0),topItems:n.map(a=>{const o=a;return{sku:String(o.sku||""),month:String(o.month||""),abcClass:String(o.abcClass||"C"),deltaPct:Number(o.deltaPct||0),deltaUnits:Number(o.deltaUnits||0),deltaRevenue:Number(o.deltaRevenue||0)}}).filter(a=>a.sku&&a.month)}}function Pr(t){if(!t||typeof t!="object")return{toVersionId:null,foConflictsOpen:0};const r=t;return{toVersionId:r.toVersionId==null?null:String(r.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function Qt(){if(typeof window>"u"||!window.sessionStorage)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};try{const t=window.sessionStorage.getItem(br);if(!t)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};const r=JSON.parse(t);return{errorAt:typeof r.errorAt=="string"?r.errorAt:null,routeKey:typeof r.routeKey=="string"?r.routeKey:null,routePath:typeof r.routePath=="string"?r.routePath:null,routeLabel:typeof r.routeLabel=="string"?r.routeLabel:null,message:typeof r.message=="string"?r.message:null}}catch{return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null}}}function kn(){var $t,Kt,Lt,Bt;const{state:t,loading:r,error:n,saving:a,saveWith:o}=zs(),l=ks(),[c,k]=Hs.useMessage(),j=_s("dashboard"),[E,x]=d.useState("next12"),[b,h]=d.useState(""),[N,T]=d.useState([]),[p,P]=d.useState("dividend"),[O,X]=d.useState(""),[re,me]=d.useState(null),[Ae,he]=d.useState(""),[_e,Pe]=d.useState({}),[ye,ne]=d.useState(()=>Qt()),[W,os]=d.useState(()=>{const s=Us("dashboard");return j?Yt(s):jr.slice()}),Q=t,vt=d.useMemo(()=>Rs(Q,18),[t.settings]),ee=d.useMemo(()=>Fs({state:Q,months:vt}),[vt,Q]),yt=d.useMemo(()=>new Map(ee.map(s=>[s.id,s])),[ee]),as=d.useMemo(()=>{const s=new Map;return ee.forEach(i=>{const g=String(i.sku||"").trim().toLowerCase();!g||s.has(g)||s.set(g,i)}),s},[ee]),je=d.useMemo(()=>new Set(ee.map(s=>s.id)),[ee]),Ce=d.useMemo(()=>Ps({state:Q,suggestions:ee}),[ee,Q]),Oe=d.useMemo(()=>Ns(Ce),[Ce]),et=Oe.months||[],jt=Oe.breakdown||[],kt=Oe.actualComparisons||[],z=d.useMemo(()=>{const s=Zt.find(i=>i.value===E);return!s||s.count==null?et:et.slice(0,s.count)},[et,E]),Ue=d.useMemo(()=>new Set(z),[z]),L=d.useMemo(()=>jt.filter(s=>Ue.has(s.month)),[jt,Ue]),is=d.useMemo(()=>kt.filter(s=>Ue.has(s.month)),[kt,Ue]),A=d.useMemo(()=>es({state:Q,months:z}),[Q,z]),oe=d.useMemo(()=>lr({state:Q,horizonMonths:12,runtimeErrorAt:ye.errorAt,runtimeErrorRoute:ye.routePath}),[ye.errorAt,ye.routePath,Q]);d.useEffect(()=>{var s;if(!A.months.length){h("");return}if(!b||!A.monthMap.has(b)){const i=((s=A.months.find(g=>!g.robust))==null?void 0:s.month)||A.months[0].month;h(i)}},[A,b]),d.useEffect(()=>{if(!L.length){T([]);return}T(s=>{const i=new Set(L.map(v=>v.month)),g=s.filter(v=>i.has(v));return g.length?g:[L[0].month]})},[L]),d.useEffect(()=>{if(!z.length){X("");return}(!O||!z.includes(O))&&X(z[0])},[O,z]),d.useEffect(()=>{Vs("dashboard",W)},[W]);const fe=s=>{os(Yt(kr(s)))},C=d.useMemo(()=>!O||!Number.isFinite(re)||Number(re)<=0?null:{month:O,amount:Math.abs(Number(re)),type:p,label:Ae.trim()||Qe(p)},[re,Ae,O,p]),K=d.useMemo(()=>Er(L,C),[C,L]),Dt=d.useMemo(()=>{const s=new Map;return K.forEach(i=>s.set(i.month,i)),s},[K]),tt=K[K.length-1]||null,ls=K.reduce((s,i)=>s+Number(i.inflow||0),0),cs=K.reduce((s,i)=>s+Number(i.outflow||0),0),Nt=K.reduce((s,i)=>s+Number(i.net||0),0),Z=d.useMemo(()=>wr(L),[L])*2,st=d.useMemo(()=>K.filter(s=>{var i;return(i=A.monthMap.get(s.month))==null?void 0:i.robust}).map(s=>Number(s.closing||0)),[A.monthMap,K]),St=d.useMemo(()=>!st.length||Z<=0?null:Math.min(...st)-Z,[Z,st]),Mt=d.useMemo(()=>Rr(K,A.monthMap),[A.monthMap,K]),rt=d.useMemo(()=>{var s;return!C||Z<=0?null:((s=K.find(i=>{const g=Ze(i.month),v=Ze(C.month);return g==null||v==null||g<v?!1:Number(i.closing||0)<Z}))==null?void 0:s.month)||null},[Z,K,C]),At=!!C&&Z>0&&!rt,ae=t.forecast&&typeof t.forecast=="object"?t.forecast:{},Ve=d.useMemo(()=>{const s=structuredClone(ae||{});return Os(s),s},[ae]),ds=d.useMemo(()=>Ts(Ve),[Ve]),nt=Pr(Ve.lastImpactSummary),Ct=String(Ve.activeVersionId||"").trim()||null,He=nt.toVersionId&&Ct&&nt.toVersionId===Ct?nt.foConflictsOpen:0,ot=typeof ae.lastImportAt=="string"?ae.lastImportAt:null,q=Fr(ae.lastDriftSummary),wt=typeof ae.lastDriftReviewedComparedAt=="string"?ae.lastDriftReviewedComparedAt:null,at=typeof ae.lastDriftReviewedAt=="string"?ae.lastDriftReviewedAt:null,it=!!(q.comparedAt&&wt&&wt===q.comparedAt&&at),we=ot?new Date(ot):null,us=new Date,ms=24*60*60*1e3,Te=we?Math.floor((us.getTime()-we.getTime())/ms):null,Ie=we?Te!=null&&Te<=35?"fresh":Te!=null&&Te<=45?"aging":"stale":"none",hs=we?`${Te} Tage seit Import`:"Kein Forecast-Import",It=we?Mr(we,30):null,f=b&&A.monthMap.get(b)||null,Et=(f==null?void 0:f.coverage.stockIssues)||[],Rt=(f==null?void 0:f.coverage.orderDutyIssues)||[],Ft=f?f.checks.filter(s=>s.key!=="sku_coverage"):[],Pt=f?f.blockers.filter(s=>s.checkKey!=="sku_coverage"):[],fs=d.useMemo(()=>{if(!f)return[];const s=f.coverage.projectionMode==="doh"?"DOH":"Units",i=f.coverage.stockIssueCount,g=f.coverage.orderDutyIssueCount,v=[{key:"stock",label:"Bestands-Check ok?",passed:i===0,description:i===0?`Alle aktiven SKUs im Monat ${B(f.month)} über Safety (${s}).`:`${i} SKU(s) mit OOS/unter Safety oder fehlendem Forecast.`},{key:"order_duty",label:"Bestellpflicht/Look-Ahead ok?",passed:g===0,description:g===0?"Keine SKU benötigt spätestens in diesem Monat eine neue FO/PO.":`${g} SKU(s) mit fälliger Bestellpflicht (inkl. Look-Ahead).`}],S=Ft.map(_=>({key:_.key,label:`${_.label} ok?`,passed:_.passed,description:_.detail}));return[...v,...S]},[f,Ft]),lt=gt(),Ee=xr(),Ot=Ze(lt),ct=d.useMemo(()=>{var s;return((s=A.months.find(i=>!i.robust))==null?void 0:s.month)||b||z[0]||null},[A.months,b,z]),$e=d.useMemo(()=>gr({state:Q,month:lt,todayIso:Ee}),[lt,Q,Ee]);d.useEffect(()=>{const s=()=>ne(Qt());return s(),window.addEventListener("v2:route-load-state",s),window.addEventListener("storage",s),()=>{window.removeEventListener("v2:route-load-state",s),window.removeEventListener("storage",s)}},[]),d.useEffect(()=>{Pe(s=>{const i=new Set($e.map(S=>S.id));let g=!1;const v={};return Object.entries(s).forEach(([S,_])=>{if(!i.has(S)){g=!0;return}v[S]=_}),$e.forEach(S=>{v[S.id]||(v[S.id]=S.arrivalDate||Ee,g=!0)}),g?v:s})},[$e,Ee]);const Tt=d.useMemo(()=>Ms({breakdown:L,state:Ce,provisionalFoIds:je}),[je,Ce,L]),gs=d.useMemo(()=>{const s=z.map(u=>B(u)),i=L.map(u=>Number(u.closing||0)),g=L.map(u=>{var I;return!!((I=A.monthMap.get(u.month))!=null&&I.robust)}),v=i.map((u,I)=>g[I]&&u>=0?u:null),S=i.map((u,I)=>g[I]&&u<0?u:null),_=i.map((u,I)=>!g[I]&&u>=0?u:null),ie=i.map((u,I)=>!g[I]&&u<0?u:null),le=C?L.map(u=>{var I;return Number(((I=Dt.get(u.month))==null?void 0:I.closing)||0)}):[],D=K.map(u=>Ir(Array.isArray(u.entries)?u.entries:[],je)),H=D.map(u=>-u.fixcost),Ke=D.map(u=>-u.po),G=D.map(u=>-u.fo),R=D.map(u=>-u.phantomFo);return{tooltip:{trigger:"axis",formatter:u=>{const I=Array.isArray(u)?u:[u],ge=I[0],Y=[`<div><strong>${(ge==null?void 0:ge.axisValueLabel)||""}</strong></div>`];return I.forEach(U=>{const V=U,ce=Number(V==null?void 0:V.value);Number.isFinite(ce)&&Y.push(`<div>${(V==null?void 0:V.marker)||""}${(V==null?void 0:V.seriesName)||""}: ${F(ce)}</div>`)}),Y.join("")}},legend:{top:0},grid:{left:56,right:70,top:44,bottom:32},xAxis:{type:"category",data:s},yAxis:[{type:"value",name:"Cashflow",axisLabel:{formatter:u=>De(u)}},{type:"value",name:"Kontostand",position:"right",axisLabel:{formatter:u=>F(u)}}],series:[{name:"Einzahlungen",type:"bar",stack:"cash",data:K.map(u=>Number(u.inflow||0)),itemStyle:{color:"#27ae60"}},{name:"Fixkosten",type:"bar",stack:"cash",data:H,itemStyle:{color:"#7f1d1d"}},{name:"PO",type:"bar",stack:"cash",data:Ke,itemStyle:{color:"#e74c3c"}},{name:"FO",type:"bar",stack:"cash",data:G,itemStyle:{color:"#f97316"}},{name:"Phantom FO",type:"bar",stack:"cash",data:R,itemStyle:{color:"#fbbf24"}},{name:"Netto",type:"line",smooth:!0,data:K.map(u=>Number(u.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:v,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:S,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend (nicht robust)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:_,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:ie,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}},...C?[{name:"Simulation",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:le,lineStyle:{width:2,type:"dashed",color:"#f59e0b"},itemStyle:{color:"#f59e0b"}}]:[]]}},[je,A.monthMap,K,Dt,C,L,z]),bs=d.useMemo(()=>[{header:"Monat",accessorKey:"month"},{header:"Plan Umsatz",accessorKey:"plannedRevenue",cell:({row:s})=>F(s.original.plannedRevenue)},{header:"Ist Umsatz",accessorKey:"actualRevenue",cell:({row:s})=>F(s.original.actualRevenue)},{header:"Delta Umsatz",accessorKey:"revenueDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.revenueDelta||0)<0?"v2-negative":void 0,children:F(s.original.revenueDelta)})},{header:"Delta Umsatz %",accessorKey:"revenueDeltaPct",cell:({row:s})=>qe(s.original.revenueDeltaPct)},{header:"Plan Kontostand",accessorKey:"plannedClosing",cell:({row:s})=>F(s.original.plannedClosing)},{header:"Ist Kontostand",accessorKey:"actualClosing",cell:({row:s})=>F(s.original.actualClosing)},{header:"Delta Kontostand",accessorKey:"closingDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.closingDelta||0)<0?"v2-negative":void 0,children:F(s.original.closingDelta)})}],[]),ps=d.useMemo(()=>[{title:"Check",dataIndex:"label",key:"label",sorter:(s,i)=>String(s.label||"").localeCompare(String(i.label||""),"de-DE")},{title:"Status",dataIndex:"status",key:"status",width:130,sorter:(s,i)=>String(s.status||"").localeCompare(String(i.status||""),"de-DE"),render:s=>Dr(s)},{title:"Detail",dataIndex:"detail",key:"detail",width:320,sorter:(s,i)=>String(s.detail||"").localeCompare(String(i.detail||""),"de-DE"),render:s=>e.jsx(y,{type:"secondary",children:s})},{title:"",key:"route",width:132,render:(s,i)=>e.jsx(w,{size:"small",onClick:()=>l(Le({route:i.route,checkKey:i.key,month:(f==null?void 0:f.month)||null,mode:(f==null?void 0:f.coverage.projectionMode)||null})),children:"Öffnen"})}],[l,f==null?void 0:f.coverage.projectionMode,f==null?void 0:f.month]),xs=d.useMemo(()=>L.map(s=>{var le;const i=Tt.get(s.month)||[],g=i.filter(D=>D.provisional),v=vr.map(D=>({...D,rows:i.filter(H=>H.group===D.key)})).filter(D=>D.rows.length>0),S=i.filter(D=>D.group==="inflow"),_=i.filter(D=>D.amount<0),ie=((le=A.monthMap.get(s.month))==null?void 0:le.robust)||!1;return{key:s.month,label:e.jsxs("div",{className:"v2-dashboard-pnl-header",children:[e.jsx(y,{strong:!0,children:B(s.month)}),e.jsxs(J,{wrap:!0,children:[e.jsxs(m,{color:"green",children:["Einzahlungen: ",F(Se(S))]}),e.jsxs(m,{color:"red",children:["Auszahlungen: ",F(Math.abs(Se(_)))]}),g.length?e.jsxs(m,{color:"gold",children:["Vorbehaltlich: ",De(Se(g))]}):null,e.jsxs(m,{color:s.net>=0?"green":"red",children:["Netto: ",F(s.net)]}),e.jsxs(m,{color:ie?"green":"red",children:["Robust: ",ie?"ja":"nein"]})]})]}),children:e.jsx("div",{className:"v2-dashboard-pnl-month",children:v.map(D=>{if(D.key==="po_fo"){const H=new Map;D.rows.forEach(G=>{const R=G.source==="fo"?"fo":"po",u=G.sourceId?String(G.sourceId):null,I=G.sourceNumber?String(G.sourceNumber):null,ge=`${R}:${u||I||G.label}`,Y=H.get(ge);if(Y){Y.rows.push(G),!Y.sourceId&&u&&(Y.sourceId=u),!Y.sourceNumber&&I&&(Y.sourceNumber=I);return}H.set(ge,{source:R,sourceId:u,sourceNumber:I,rows:[G]})});const Ke=Array.from(H.entries()).map(([G,R])=>{var zt;const u=Se(R.rows),I=R.rows.filter(M=>M.provisional),ge=I.map(M=>String(M.sourceId||"").trim()).find(M=>M&&je.has(M))||null,Y=R.source==="fo"?R.sourceId&&je.has(R.sourceId)?R.sourceId:ge:null,U=Y&&yt.get(Y)||null,V=(zt=R.rows.find(M=>M.tooltipMeta))==null?void 0:zt.tooltipMeta,ce=Array.from(new Set(R.rows.flatMap(M=>{var We;return((We=M.tooltipMeta)==null?void 0:We.aliases)||[]}).filter(Boolean))),ut=ce.length>3?`${ce.slice(0,3).join(", ")} +${ce.length-3}`:ce.join(", "),Ge=rr({state:Ce,source:R.source,sourceId:R.sourceId,sourceNumber:R.sourceNumber});return{key:G,label:e.jsxs("div",{className:"v2-dashboard-pnl-order-row",children:[e.jsxs("div",{className:"v2-dashboard-pnl-order-row-main",children:[e.jsxs(y,{strong:!0,children:[String(R.source).toUpperCase()," ",R.sourceNumber||R.sourceId||"—"]}),ut?ce.length>3?e.jsx(Me,{title:ce.join(", "),children:e.jsxs(y,{type:"secondary",children:["· ",ut]})}):e.jsxs(y,{type:"secondary",children:["· ",ut]}):null]}),e.jsxs(J,{size:6,children:[e.jsx(m,{color:u<0?"red":"green",children:De(u)}),I.length?e.jsx(m,{color:"gold",children:"Vorbehaltlich"}):null,U?e.jsx(m,{color:"orange",children:"Phantom FO"}):null,(V==null?void 0:V.units)!=null?e.jsxs(m,{children:["Stück: ",Ne(V.units,0)]}):null]})]}),children:e.jsxs("div",{className:"v2-dashboard-pnl-order-detail",children:[U?e.jsx("div",{className:"v2-dashboard-pnl-phantom-hint",children:e.jsxs(J,{wrap:!0,children:[e.jsx(m,{color:"gold",children:"Automatisch vorgeschlagen"}),e.jsxs(y,{type:"secondary",children:["Risikomonat ",B(U.firstRiskMonth)," · bestellen bis ",xe(U.latestOrderDate)]}),e.jsx(w,{size:"small",type:"primary",onClick:()=>l(Jt({sku:U.sku,month:s.month,suggestedUnits:U.suggestedUnits,requiredArrivalDate:U.requiredArrivalDate,recommendedOrderDate:U.recommendedOrderDate,source:"phantom_fo",phantomId:U.id,firstRiskMonth:U.firstRiskMonth,orderMonth:U.orderMonth,leadTimeDays:U.leadTimeDays,returnTo:"/v2/dashboard"})),children:"Prüfen & bestätigen"})]})}):null,Ge?e.jsx("div",{className:"v2-dashboard-order-timeline-shell",children:e.jsx(qs,{className:"v2-dashboard-order-timeline",items:Ge.items,visibleStartMs:Ge.visibleStartMs,visibleEndMs:Ge.visibleEndMs,height:188})}):e.jsx(se,{type:"info",showIcon:!0,message:`Keine Timeline-Daten für ${String(R.source).toUpperCase()} ${R.sourceNumber||R.sourceId||"—"} verfügbar.`}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:R.rows.map((M,We)=>{var Ut;const _t=M.tooltipMeta?e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("strong",{children:[String(M.source).toUpperCase()," ",M.sourceNumber||M.sourceId||"—"]})}),e.jsxs("div",{children:["Alias: ",M.tooltipMeta.aliases.join(", ")||"-"]}),e.jsxs("div",{children:["Stückzahl: ",M.tooltipMeta.units!=null?Ne(M.tooltipMeta.units,0):"-"]}),e.jsxs("div",{children:["Fälligkeit: ",xe(M.tooltipMeta.dueDate)]})]}):null;return e.jsxs("tr",{children:[e.jsx("td",{children:_t?e.jsx(Me,{title:_t,children:M.label}):M.label}),e.jsx("td",{className:M.amount<0?"v2-negative":void 0,children:De(M.amount)}),e.jsx("td",{children:xe((Ut=M.tooltipMeta)==null?void 0:Ut.dueDate)}),e.jsx("td",{children:M.provisional?e.jsx(m,{color:"gold",children:"Vorbehaltlich"}):M.paid==null?e.jsx(m,{children:"—"}):M.paid?e.jsx(m,{color:"green",children:"Bezahlt"}):e.jsx(m,{color:"gold",children:"Offen"})})]},`${G}-${We}`)})})]})})]})}});return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(y,{strong:!0,children:D.label}),e.jsx(m,{color:"blue",children:De(Se(D.rows))})]}),e.jsx(te,{size:"small",items:Ke,destroyInactivePanel:!0})]},`${s.month}-${D.key}`)}return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(y,{strong:!0,children:D.label}),e.jsx(m,{color:Se(D.rows)<0?"red":"green",children:De(Se(D.rows))})]}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:D.rows.map((H,Ke)=>e.jsxs("tr",{children:[e.jsx("td",{children:H.label}),e.jsx("td",{className:H.amount<0?"v2-negative":void 0,children:De(H.amount)}),e.jsx("td",{children:H.paid==null?e.jsx(m,{children:"—"}):H.paid?e.jsx(m,{color:"green",children:"Bezahlt"}):e.jsx(m,{color:"gold",children:"Offen"})})]},`${s.month}-${D.key}-${Ke}`))})]})})]},`${s.month}-${D.key}`)})})}}),[l,yt,je,Ce,Tt,A.monthMap,L]);async function vs(){C&&(await o(s=>{const i=mt(s),g=i,v=C.label||Qe(C.type);if(C.type==="dividend"){const S=Array.isArray(g.dividends)?[...g.dividends]:[];S.push({id:`div-${Date.now()}`,month:C.month,label:v,amountEur:Math.abs(C.amount)}),g.dividends=S}else{const S=Array.isArray(g.extras)?[...g.extras]:[];S.push({id:`extra-${Date.now()}`,month:C.month,label:v,amountEur:-Math.abs(C.amount)}),g.extras=S}return i},`v2:dashboard:simulation-commit:${C.type}`),me(null),he(""))}async function ys(){q.comparedAt&&await o(s=>{const i=mt(s),g=i;(!g.forecast||typeof g.forecast!="object")&&(g.forecast={});const v=g.forecast;return v.lastDriftReviewedAt=pr(),v.lastDriftReviewedComparedAt=q.comparedAt,i},"v2:dashboard:forecast-drift-reviewed")}async function dt(s,i,g){try{await o(v=>{const S=mt(v),_=Array.isArray(S.pos)?S.pos:[];return S.pos=_.map(ie=>{if(!ie||typeof ie!="object")return ie;const le=ie;return String(le.id||le.poNo||"").trim()!==s?le:{...le,arrivalDate:i||null}}),S},g),c.success(i?"Wareneingang gespeichert.":"Wareneingang zurückgesetzt.")}catch(v){console.error(v),c.error(v instanceof Error?v.message:"Wareneingang konnte nicht gespeichert werden.")}}return((Kt=($t=t.settings)==null?void 0:$t.featureFlags)==null?void 0:Kt.executiveDashboardV2)!==!1?e.jsxs("div",{className:"v2-page",children:[k,e.jsxs($,{className:"v2-intro-card",children:[e.jsxs("div",{className:"v2-page-head",children:[e.jsxs("div",{children:[e.jsx(de,{level:3,children:"Dashboard"}),e.jsx(pe,{children:"Executive-Cockpit für Kontostand, Robustheit und Maßnahmenpriorisierung. Nicht robuste Monate sind klar markiert."})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(y,{children:"Zeitraum"}),e.jsx(ht,{value:E,onChange:s=>x(s),options:Zt.map(s=>({value:s.value,label:s.label})),style:{width:220,maxWidth:"100%"}})]})]}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(w,{onClick:()=>l("/v2/forecast"),children:"Zur Absatzprognose"}),e.jsx(w,{onClick:()=>l("/v2/inventory/projektion"),children:"Zur Bestandsprojektion"}),e.jsx(w,{onClick:()=>l("/v2/orders/po"),children:"Zu Bestellungen"}),e.jsx(w,{onClick:()=>l("/v2/abschluss/eingaben"),children:"Zum Abschluss"})]}),e.jsxs(y,{type:"secondary",children:["Aktueller Betrachtungszeitraum: ",z.length," Monat(e)."]})]})]}),n?e.jsx(se,{type:"error",showIcon:!0,message:n}):null,r?e.jsx(se,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,He>0?e.jsx(se,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${He} FOs prüfen`,description:e.jsx(w,{size:"small",onClick:()=>l("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"signals",label:"Executive Signals",children:e.jsxs("div",{className:"v2-dashboard-signal-grid",children:[e.jsxs($,{className:"v2-dashboard-signal-card v2-dashboard-readiness-card",children:[e.jsx(be,{title:Ye("Readiness Gate","Go/No-Go vor großer Datenpflege. Alle Checks müssen grün sein."),value:oe.ready?"Bereit":"Nicht bereit"}),e.jsxs(J,{wrap:!0,children:[e.jsx(m,{color:oe.ready?"green":"red",children:oe.ready?"Go":"No-Go"}),e.jsxs(m,{color:oe.ready?"green":"gold",children:[oe.robustMonthsCount,"/",oe.robustRequiredCount," robuste Monate"]})]}),!oe.ready&&oe.blockers.length?e.jsx("div",{className:"v2-dashboard-readiness-blockers",children:oe.blockers.slice(0,2).map(s=>e.jsxs("div",{className:"v2-dashboard-readiness-blocker-item",children:[e.jsxs(y,{type:"secondary",children:[s.label,": ",s.message]}),e.jsx(w,{size:"small",onClick:()=>l(s.route),children:"Öffnen"})]},s.id))}):e.jsx(y,{type:"secondary",children:"Alle Gate-Checks erfüllt."})]}),e.jsxs($,{className:"v2-dashboard-signal-card",children:[e.jsx(be,{title:Ye("Robust bis","Letzter Monat, in dem alle Hard-Checks erfüllt sind. Danach ist der Kontostand nur Orientierung."),value:A.robustUntilMonth?B(A.robustUntilMonth):"—"}),e.jsxs(y,{type:"secondary",children:[A.robustMonthsCount,"/",A.totalMonths," Monate robust"]})]}),e.jsxs($,{className:"v2-dashboard-signal-card",children:[e.jsx(be,{title:Ye("Erster negativer Monat (robust)","Erster belastbarer Monat mit negativem Kontostand. Nicht robuste Monate werden dafür ignoriert."),value:Mt?B(Mt):"Keiner"}),e.jsx(y,{type:"secondary",children:"Simulation wird berücksichtigt"})]}),e.jsxs($,{className:"v2-dashboard-signal-card",children:[e.jsx(be,{title:Ye("Freier Cash nach Buffer","Minimaler belastbarer Kontostand minus Sicherheitsreserve aus 2 Monaten Fixkosten."),value:St!=null?F(St):"—"}),e.jsxs(y,{type:"secondary",children:["Buffer (2M Fixkosten): ",F(Z)]})]}),e.jsxs($,{className:"v2-dashboard-signal-card",children:[e.jsxs("div",{className:"v2-dashboard-forecast-status-head",children:[e.jsxs(y,{strong:!0,children:["Forecast Freshness",e.jsx(Me,{title:"Ampel nach Importalter: Grün <=35 Tage, Gelb 36-45 Tage, Rot >45 Tage.",children:e.jsx(ts,{className:"v2-dashboard-inline-info"})})]}),e.jsx(m,{color:Ie==="fresh"?"green":Ie==="aging"?"gold":Ie==="stale"?"red":"default",children:Ie==="fresh"?"Grün":Ie==="aging"?"Gelb":Ie==="stale"?"Rot":"Keine Daten"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-status-meta",children:[e.jsxs("div",{children:["Baseline Forecast: ",ds]}),e.jsx("div",{children:hs}),e.jsxs("div",{children:["Letzter Import: ",xe(ot)]}),e.jsxs("div",{children:["Nächster Import empfohlen: ",It?It.toLocaleDateString("de-DE"):"—"]}),He>0?e.jsx("div",{children:e.jsxs(w,{size:"small",onClick:()=>l("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",He," FOs prüfen"]})}):null]})]})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"cashflow",label:"Kontostand & Cashflow",children:e.jsxs($,{className:"v2-dashboard-chart-card",children:[e.jsx(de,{level:4,children:"Kontostand & Cashflow"}),e.jsxs(J,{wrap:!0,children:[e.jsxs(m,{color:"green",children:["Einzahlungen: ",F(ls)]}),e.jsxs(m,{color:"red",children:["Auszahlungen: ",F(cs)]}),e.jsxs(m,{color:Nt>=0?"green":"red",children:["Netto: ",F(Nt)]}),ee.length?e.jsxs(m,{color:"gold",children:["Phantom-FOs (vorbehaltlich): ",ee.length]}):null,e.jsxs(m,{color:C?"gold":"default",children:["Simulation: ",C?"aktiv":"aus"]})]}),e.jsxs("div",{className:"v2-dashboard-legend-help",children:[e.jsx(Me,{title:"Durchgezogene Linie: belastbarer Kontostand (alle Hard-Checks bestanden).",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Linie solid = belastbar"})}),e.jsx(Me,{title:"Gestrichelte Linie: orientierend, weil mindestens ein Hard-Check fehlt.",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Linie gestrichelt = orientierend"})}),e.jsx(Me,{title:"Rot markiert: Kontostand liegt unter 0 im jeweiligen Zustand.",children:e.jsx(m,{className:"v2-dashboard-legend-tag",children:"Rot = unter 0"})})]}),e.jsx(Ds,{style:{height:380},option:gs})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"actions",label:"Action Center & Forecast Ops",children:e.jsxs(Vt,{gutter:[12,12],children:[e.jsx(ke,{xs:24,xl:14,children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Action Center"}),e.jsx(pe,{type:"secondary",children:"Priorisierte Maßnahmen, damit der Kontostand wieder belastbar wird."}),A.actions.length?e.jsx("div",{className:"v2-dashboard-actions",children:A.actions.map(s=>e.jsxs("div",{className:`v2-dashboard-action-card is-${s.severity}`,children:[e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:s.title}),e.jsx("div",{className:"v2-dashboard-action-detail",children:s.detail}),e.jsxs("div",{className:"v2-dashboard-action-impact",children:["Impact: ",s.impact]})]}),e.jsxs("div",{className:"v2-dashboard-action-meta",children:[e.jsx(m,{color:s.severity==="error"?"red":"gold",children:s.count}),e.jsx(w,{size:"small",onClick:()=>{var i;return l(Le({route:s.route,actionId:s.id,month:ct,mode:ct&&((i=A.monthMap.get(ct))==null?void 0:i.coverage.projectionMode)||null}))},children:"Öffnen"})]})]},s.id))}):e.jsx(se,{type:"success",showIcon:!0,message:"Keine offenen Hard-Blocker im gewählten Zeitraum."})]})}),e.jsx(ke,{xs:24,xl:10,children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Forecast Ops"}),e.jsxs(pe,{type:"secondary",children:["Monatlicher Import mit Drift-Alarm (A/B Fokus, Profil: ",q.thresholdProfile,")."]}),e.jsxs(J,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(m,{color:it?"green":"gold",children:["Drift-Review: ",it?"geprüft":"offen"]}),at?e.jsxs(m,{children:["Geprüft am: ",new Date(at).toLocaleDateString("de-DE")]}):null,e.jsx(w,{size:"small",onClick:()=>{ys()},disabled:!q.comparedAt||it||a,children:"Drift geprüft"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-ops",children:[e.jsxs("div",{children:["Flagged SKUs: ",e.jsx("strong",{children:Ne(q.flaggedSkuCount,0)})]}),e.jsxs("div",{children:["Flagged A/B: ",e.jsx("strong",{children:Ne(q.flaggedABCount,0)})]}),e.jsxs("div",{children:["Flagged SKU-Monate: ",e.jsx("strong",{children:Ne(q.flaggedMonthCount,0)})]}),e.jsxs("div",{children:["Verglichen am: ",e.jsx("strong",{children:xe(q.comparedAt)})]})]}),q.topItems.length?e.jsxs("div",{className:"v2-dashboard-drift-list",children:[q.topItems.slice(0,5).map((s,i)=>e.jsxs("div",{className:"v2-dashboard-drift-item",children:[e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:s.sku}),e.jsxs(y,{type:"secondary",children:[" · ",B(s.month)," · ",s.abcClass]})]}),e.jsxs("div",{children:["ΔUnits ",Ne(s.deltaUnits,0)," · ΔUmsatz ",F(s.deltaRevenue)," · Δ% ",qe(s.deltaPct)]})]},`${s.sku}-${s.month}-${i}`)),e.jsx(w,{size:"small",onClick:()=>l("/v2/forecast"),children:"Zur Forecast-Prüfung"})]}):e.jsx(se,{type:"success",showIcon:!0,message:"Keine kritischen Drift-Abweichungen im letzten Vergleich."})]})}),e.jsx(ke,{xs:24,xl:24,children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"PO Wareneingang bestätigen"}),e.jsx(pe,{type:"secondary",children:"Sichtbar sind POs mit ETA im aktuellen Monat sowie überfällige ETA ohne bestätigten Wareneingang."}),$e.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"PO"}),e.jsx("th",{children:"Supplier"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"Stückzahl"}),e.jsx("th",{children:"ETA"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:$e.map(s=>{const i=_e[s.id]||s.arrivalDate||Ee,g=/^\d{4}-\d{2}-\d{2}$/.test(i);return e.jsxs("tr",{children:[e.jsx("td",{children:s.poNumber||"PO"}),e.jsx("td",{children:s.supplier||"-"}),e.jsx("td",{children:s.skuAliases||"-"}),e.jsx("td",{children:Ne(s.units,0)}),e.jsx("td",{children:xe(s.etaDate)}),e.jsx("td",{children:s.arrivalDate?e.jsxs(m,{color:"green",children:["Angekommen am ",xe(s.arrivalDate)]}):s.isOverdue?e.jsx(m,{color:"red",children:"Überfällig"}):e.jsx(m,{color:"gold",children:"Offen"})}),e.jsx("td",{children:e.jsxs(J,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>{dt(s.id,Ee,"v2:dashboard:po-arrival-today")},disabled:a,children:"Heute"}),e.jsx(Ht,{type:"date",value:i,onChange:v=>{const S=v.target.value||"";Pe(_=>({..._,[s.id]:S}))},style:{width:160}}),e.jsx(w,{size:"small",onClick:()=>{g&&dt(s.id,i,"v2:dashboard:po-arrival-date")},disabled:a||!g||i===s.arrivalDate,children:"Datum setzen"}),s.arrivalDate?e.jsx(w,{size:"small",danger:!0,onClick:()=>{dt(s.id,null,"v2:dashboard:po-arrival-clear")},disabled:a,children:"Zurücksetzen"}):null]})})]},s.id)})})]})}):e.jsx(se,{type:"success",showIcon:!0,message:"Keine offenen PO-Wareneingänge für den aktuellen Scope."})]})})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"robustness",label:"Robustheits-Matrix",children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Robustheits-Matrix"}),e.jsx(pe,{type:"secondary",children:"Ein Monat wird nur dann grün, wenn Bestands-Check und Look-Ahead-Bestellpflicht passen. Die Stufen folgen den Schwellen: Vollständig 100 %, Weitgehend ≥95 % ohne A/B-Blocker, Teilweise ≥80 %, sonst Unzureichend."}),e.jsx("div",{className:"v2-dashboard-robust-legend",children:["full","wide","partial","insufficient"].map(s=>{const i=pt(s);return e.jsxs("div",{className:"v2-dashboard-robust-legend-item",children:[e.jsx("span",{className:`v2-dashboard-robust-dot ${i.className}`}),e.jsx(y,{children:i.label})]},s)})}),e.jsx("div",{className:"v2-dashboard-robust-grid",children:A.months.map(s=>{const i=Ze(s.month),g=i!=null&&Ot!=null&&i<Ot,v=pt(s.coverage.statusKey);return e.jsxs("button",{type:"button",className:["v2-dashboard-robust-item",b===s.month?"is-selected":"",v.className,g?"is-past":""].filter(Boolean).join(" "),onClick:()=>h(s.month),children:[e.jsxs("div",{className:"v2-dashboard-robust-item-head",children:[e.jsx("span",{children:B(s.month)}),e.jsxs(J,{size:6,children:[e.jsx(m,{color:v.color,children:v.label}),g?e.jsx(m,{children:"Vergangen"}):null]})]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Coverage: ",qe(s.coverage.ratio*100)," (",s.coverage.coveredSkus,"/",s.coverage.activeSkus,")"]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Blocker SKUs: ",s.coverage.blockerCount," (A/B ",s.coverage.blockerAbCount," · C ",s.coverage.blockerCCount,")"]})]},s.month)})}),f?e.jsxs("div",{className:"v2-dashboard-robust-detail",children:[e.jsxs("div",{className:"v2-dashboard-robust-detail-head",children:[e.jsx(y,{strong:!0,children:B(f.month)}),e.jsxs(J,{wrap:!0,children:[Nr(f.coverage.statusKey),e.jsxs(m,{children:["Coverage: ",qe(f.coverage.ratio*100)]}),e.jsxs(m,{children:["Blocker: ",f.coverage.blockerCount]}),e.jsxs(m,{children:["A/B: ",f.coverage.blockerAbCount," · C: ",f.coverage.blockerCCount]}),f.coverage.overdueOrderDutySkuCount>0?e.jsxs(m,{color:"red",children:["Überfällig: ",f.coverage.overdueOrderDutySkuCount]}):null]})]}),e.jsx("div",{className:"v2-dashboard-robust-checklist",children:fs.map(s=>e.jsxs("div",{className:`v2-dashboard-robust-checklist-item ${s.passed?"is-pass":"is-fail"}`,children:[e.jsx("span",{className:"v2-dashboard-robust-check-icon",children:s.passed?"✅":"❌"}),e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:s.label}),e.jsx("div",{children:e.jsx(y,{type:"secondary",children:s.description})})]})]},s.key))}),e.jsx(Gs,{size:"small",pagination:!1,rowKey:"key",columns:ps,dataSource:f.checks}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(y,{strong:!0,children:["Bestands-Probleme in ",B(f.month)]}),Et.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Problem"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Et.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:Sr(s)}),e.jsx("td",{children:e.jsxs(J,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>l(Le({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:f.month,sku:s.sku,mode:f.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(w,{size:"small",onClick:()=>l(xt({issues:"all",sku:s.sku})),children:"Produkt öffnen"}),s.issueType==="forecast_missing"?e.jsx(w,{size:"small",onClick:()=>l(ns({sku:s.sku,month:f.month})),children:"Absatzprognose öffnen"}):null]})})]},`${s.sku}:${s.issueType}`))})]})}):e.jsx(y,{type:"secondary",children:"Keine Bestandsprobleme in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(y,{strong:!0,children:["Bestellpflicht in ",B(f.month)]}),Rt.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Erster Risikomonat"}),e.jsx("th",{children:"Spätester Bestellzeitpunkt"}),e.jsx("th",{children:"Warum Blocker"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Rt.map(s=>{const i=as.get(String(s.sku||"").trim().toLowerCase())||null;return e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:B(s.firstRiskMonth)}),e.jsxs("td",{children:[xe(s.latestOrderDate)," (",B(s.orderMonth),")",s.overdue?e.jsx(m,{color:"red",style:{marginInlineStart:8},children:"Überfällig"}):null]}),e.jsx("td",{children:s.reason}),e.jsx("td",{children:e.jsxs(J,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>l(Le({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:f.month,sku:s.sku,mode:f.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(w,{size:"small",type:"primary",onClick:()=>l(Jt({sku:s.sku,month:f.month,suggestedUnits:(i==null?void 0:i.suggestedUnits)??s.shortageUnits,requiredArrivalDate:(i==null?void 0:i.requiredArrivalDate)??s.requiredArrivalDate,recommendedOrderDate:(i==null?void 0:i.recommendedOrderDate)??s.recommendedOrderDate,source:i?"phantom_fo":"inventory_projection",phantomId:(i==null?void 0:i.id)||null,firstRiskMonth:(i==null?void 0:i.firstRiskMonth)??s.firstRiskMonth,orderMonth:(i==null?void 0:i.orderMonth)??s.orderMonth,leadTimeDays:(i==null?void 0:i.leadTimeDays)??s.leadTimeDays,returnTo:"/v2/dashboard"})),children:"FO anlegen"}),e.jsx(w,{size:"small",onClick:()=>l(Cr({sku:s.sku,suggestedUnits:s.shortageUnits,requiredArrivalDate:s.requiredArrivalDate,recommendedOrderDate:s.recommendedOrderDate})),children:"PO öffnen"}),e.jsx(w,{size:"small",onClick:()=>l(xt({issues:"all",sku:s.sku})),children:"Produkt öffnen"})]})})]},`${s.sku}:${s.firstRiskMonth}:${s.orderMonth}`)})})]})}):e.jsx(y,{type:"secondary",children:"Keine fällige Bestellpflicht in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsx(y,{strong:!0,children:"Weitere Hard-Checks"}),Pt.length?e.jsx("div",{className:"v2-dashboard-blocker-list",children:Pt.map(s=>e.jsxs("div",{className:"v2-dashboard-blocker-item",children:[e.jsxs("div",{children:[e.jsx(y,{children:s.message}),s.sku?e.jsxs(y,{type:"secondary",children:[" · ",s.sku]}):null]}),e.jsx(w,{size:"small",onClick:()=>l(Le({route:s.route,checkKey:s.checkKey,month:s.month,sku:s.sku||null,mode:f.coverage.projectionMode})),children:"Öffnen"})]},s.id))}):e.jsx(y,{type:"secondary",children:"Keine weiteren Hard-Check-Blocker."})]})]}):null]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"simulation",label:"Payout Planner (Simulation)",children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Payout Planner (Simulation)"}),e.jsx(pe,{type:"secondary",children:"Einmalige Dividenden oder CAPEX simulieren und optional als echten Eintrag übernehmen."}),e.jsxs("div",{className:"v2-dashboard-sim-grid",children:[e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(y,{children:"Typ"}),e.jsx(ht,{value:p,onChange:s=>P(s),options:[{value:"dividend",label:"Dividende"},{value:"capex",label:"CAPEX"}]})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(y,{children:"Monat"}),e.jsx(ht,{value:O,onChange:s=>X(s),options:z.map(s=>({value:s,label:B(s)}))})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(y,{children:"Betrag (EUR)"}),e.jsx(Ws,{value:Number.isFinite(re)?re:null,onChange:s=>me(typeof s=="number"?s:null),min:0,controls:!1,placeholder:"0"})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(y,{children:"Label"}),e.jsx(Ht,{value:Ae,onChange:s=>he(s.target.value),placeholder:Qe(p)})]})]}),e.jsxs("div",{className:"v2-dashboard-sim-status",children:[e.jsx(m,{color:C?"gold":"default",children:C?"Simulation aktiv":"Keine Simulation"}),e.jsxs(m,{color:Z>0?"blue":"red",children:["Buffer-Ziel: ",F(Z)]}),C&&Z<=0?e.jsx(m,{color:"red",children:"Fixkostenbasis fehlt"}):null,C&&Z>0?e.jsx(m,{color:At?"green":"red",children:At?"Sicher":`Kritisch ab ${rt?B(rt):"sofort"}`}):null]}),e.jsxs(J,{children:[e.jsx(w,{onClick:()=>{me(null),he("")},children:"Simulation zurücksetzen"}),e.jsx(w,{type:"primary",onClick:()=>{vs()},disabled:!C,loading:a,children:"Als echten Eintrag übernehmen"})]})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"pnl",label:"Monatliche PnL (Drilldown)",children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Monatliche PnL (Drilldown)"}),e.jsx(pe,{type:"secondary",children:"Einzahlungen, PO/FO-Zahlungen, Fixkosten und Steuern je Monat. PO/FO-Positionen sind bis auf Milestone-Ebene aufklappbar."}),e.jsx(te,{className:"v2-dashboard-pnl-collapse",activeKey:N,onChange:s=>T(Array.isArray(s)?s.map(String):[String(s)]),items:xs})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"actuals",label:"Plan/Ist Drilldown",children:e.jsxs($,{children:[e.jsx(de,{level:4,children:"Plan/Ist Drilldown"}),e.jsx(pe,{type:"secondary",children:"Monatsvergleich zwischen geplantem und erfasstem Istwert aus den Monats-Ist-Daten."}),e.jsx(Ss,{data:is,columns:bs,minTableWidth:980,tableLayout:"auto"})]})}]}),e.jsx(te,{className:"v2-dashboard-module-collapse",activeKey:W,onChange:fe,items:[{key:"kpis",label:"KPI-Übersicht",children:e.jsxs(Vt,{gutter:[12,12],children:[e.jsx(ke,{xs:24,md:12,xl:6,children:e.jsx($,{children:e.jsx(be,{title:"Opening Balance",value:Number(((Lt=Oe.kpis)==null?void 0:Lt.opening)||0),formatter:s=>F(s)})})}),e.jsx(ke,{xs:24,md:12,xl:6,children:e.jsx($,{children:e.jsx(be,{title:"Sales Payout Ø",value:Number(((Bt=Oe.kpis)==null?void 0:Bt.salesPayoutAvg)||0),formatter:s=>F(s)})})}),e.jsx(ke,{xs:24,md:12,xl:6,children:e.jsx($,{children:e.jsx(be,{title:"Robuste Monate",value:`${A.robustMonthsCount}/${A.totalMonths}`})})}),e.jsx(ke,{xs:24,md:12,xl:6,children:e.jsx($,{children:e.jsx(be,{title:"Letzter Kontostand",value:Number((tt==null?void 0:tt.closing)||0),formatter:s=>F(s)})})})]})}]})]}):e.jsx("div",{className:"v2-page",children:e.jsx(se,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{kn as default};
