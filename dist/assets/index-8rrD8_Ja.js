import{p as le,t as c,k as e,J as Je,O as Qe,K as Q,L as y,M as ie,S as U,a5 as _e,P as ee}from"./index-CAzQztwo.js";import{b as qe}from"./abcClassification-D8Ca84qt.js";import{p as He}from"./forecastCsv-Bg9-7iuH.js";import{T as Xe}from"./TanStackGrid-DGGNjv9D.js";import{h as Ye,g as et,b as tt,s as rt,a as st}from"./uiPrefs-DA4RgD3f.js";import{f as nt,n as be}from"./months-DiLwPhVv.js";import{n as at,b as ot,c as it,d as ct,f as lt,e as ut,g as dt,h as mt,i as ft,s as pt,j as ht}from"./tableModels-DR-xwumi.js";import{u as gt,C as Se}from"./workspace-xr5uOuIo.js";import{T as vt}from"./index-Dab_0RQN.js";import{S as yt}from"./index-C15xyCf_.js";import{R as z}from"./index-BZ5evjDG.js";import{C as _}from"./index-5SR9pC2K.js";import{C as xt}from"./Collapse-mRNqWjAX.js";import"./productCompletenessV2-CJLSMhtL.js";import"./planProducts-CfB8BW_g.js";import"./Dropdown-CZlZd-6U.js";import"./useBubbleLock-Cjjrx1CM.js";function je(r){return String(r||"").trim()}function te(r){return je(r).toLowerCase()}function bt(r){return/^\d{4}-\d{2}$/.test(String(r||""))}function Ce(r){const n=le(r);return Number.isFinite(n)?Number(n):null}function Fe(r){const n={};return Object.entries(r||{}).forEach(([u,d])=>{const m=je(u);if(!m||!d||typeof d!="object")return;const g={};Object.entries(d).forEach(([I,M])=>{!bt(I)||!M||typeof M!="object"||(g[I]=M)}),Object.keys(g).length&&(n[m]=g)}),n}function St(r){const n=new Map;return(Array.isArray(r)?r:[]).forEach(u=>{const d=je(u==null?void 0:u.sku);if(!d)return;const m=Ce(u==null?void 0:u.avgSellingPriceGrossEUR);!Number.isFinite(m)||Number(m)<=0||(n.set(d,Number(m)),n.set(te(d),Number(m)))}),n}function jt(r,n){if(!r)return"C";const u=r.get(n),d=r.get(te(n)),m=String((u==null?void 0:u.abcClass)||(d==null?void 0:d.abcClass)||"C").toUpperCase();return m==="A"||m==="B"||m==="C"?m:"C"}function Pe(r){const n=Ce(r==null?void 0:r.units);return Number.isFinite(n)?Number(n):0}function De(r,n,u){const d=Ce(r==null?void 0:r.revenueEur);return Number.isFinite(d)?Number(d):Number.isFinite(n)&&Number(n)>0?u*Number(n):0}function Ct(r){if(r.abcClass!=="A"&&r.abcClass!=="B")return!1;const n=Math.abs(r.deltaPct)>=20&&Math.abs(r.deltaUnits)>=30,u=Math.abs(r.deltaRevenue)>=1500;return n||u}function Mt(r){const n=r.profile||"medium",u=r.comparedAt||new Date().toISOString(),d=Math.max(1,Math.round(Number(r.topN||20))),m=Fe(r.previousImport||{}),g=Fe(r.nextImport||{}),I=St(r.products||[]),M=new Set([...Object.keys(m),...Object.keys(g)]),E=[];M.forEach(l=>{const S=new Set([...Object.keys(m[l]||{}),...Object.keys(g[l]||{})]),k=jt(r.abcBySku,l);S.forEach(F=>{var V,$;const j=(V=m[l])==null?void 0:V[F],X=($=g[l])==null?void 0:$[F];if(!j&&!X)return;const p=Pe(j),R=Pe(X),T=R-p,K=p===0?R===0?0:100:T/Math.abs(p)*100,P=I.get(l)??I.get(te(l))??null,W=De(j,P,p),L=De(X,P,R),G=L-W;n==="medium"&&Ct({abcClass:k,deltaPct:K,deltaUnits:T,deltaRevenue:G})&&E.push({sku:l,month:F,abcClass:k,prevUnits:p,nextUnits:R,deltaUnits:T,deltaPct:K,prevRevenue:W,nextRevenue:L,deltaRevenue:G})})}),E.sort((l,S)=>{const k=Math.abs(S.deltaRevenue)-Math.abs(l.deltaRevenue);if(k!==0)return k;const F=Math.abs(S.deltaUnits)-Math.abs(l.deltaUnits);if(F!==0)return F;const j=Math.abs(S.deltaPct)-Math.abs(l.deltaPct);return j!==0?j:l.sku!==S.sku?l.sku.localeCompare(S.sku):l.month.localeCompare(S.month)});const H=new Set(E.map(l=>te(l.sku))),ue=new Set(E.filter(l=>l.abcClass==="A"||l.abcClass==="B").map(l=>te(l.sku)));return{comparedAt:u,thresholdProfile:n,flaggedSkuCount:H.size,flaggedABCount:ue.size,flaggedMonthCount:E.length,topItems:E.slice(0,d)}}const{Paragraph:kt,Text:N,Title:Re}=Je,Be=[{value:"next6",label:"Nächste 6",count:6},{value:"next12",label:"Nächste 12",count:12},{value:"next18",label:"Nächste 18",count:18},{value:"all",label:"Alle",count:null}];function At(){return new Date().toISOString()}function wt(r){if(!r||typeof r!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0};const n=r;return{comparedAt:typeof n.comparedAt=="string"?n.comparedAt:null,thresholdProfile:String(n.thresholdProfile||"medium"),flaggedSkuCount:Number(n.flaggedSkuCount||0),flaggedABCount:Number(n.flaggedABCount||0),flaggedMonthCount:Number(n.flaggedMonthCount||0)}}function ce(r){(!r.forecast||typeof r.forecast!="object")&&(r.forecast={items:[],settings:{useForecast:!1},forecastImport:{},forecastManual:{},lastImportAt:null,importSource:null});const n=r.forecast;(!n.settings||typeof n.settings!="object")&&(n.settings={useForecast:!1}),(!n.forecastImport||typeof n.forecastImport!="object")&&(n.forecastImport={}),(!n.forecastManual||typeof n.forecastManual!="object")&&(n.forecastManual={})}function q(r,n=0){return Number.isFinite(r)?Number(r).toLocaleString("de-DE",{minimumFractionDigits:n,maximumFractionDigits:n}):"—"}function $t(){var Ie;const{state:r,loading:n,saving:u,error:d,lastSavedAt:m,saveWith:g}=gt(),I=Ye("forecast"),[M,E]=c.useState(""),[H,ue]=c.useState("next12"),[l,S]=c.useState("units"),[k,F]=c.useState(!0),[j,X]=c.useState(!1),[p,R]=c.useState({}),[T,K]=c.useState(!1),[P,W]=c.useState([]),[L,G]=c.useState([]),[de,V]=c.useState(""),[$,Oe]=c.useState("merge"),[Me,Ue]=c.useState(!0),[me,ze]=c.useState(""),[Te,fe]=c.useState(!1),[pe,ke]=c.useState([]),[re,se]=c.useState(()=>et("forecast")),he=r.settings||{},C=r.forecast||{},B=C.forecastImport||{},Y=r,A=c.useMemo(()=>wt(C.lastDriftSummary),[C.lastDriftSummary]),Ae=typeof C.lastDriftReviewedComparedAt=="string"?C.lastDriftReviewedComparedAt:null,ge=typeof C.lastDriftReviewedAt=="string"?C.lastDriftReviewedAt:null,ve=!!(A.comparedAt&&Ae&&Ae===A.comparedAt&&ge);c.useEffect(()=>{R(at(C.forecastManual||{})),K(!1)},[C.forecastManual]);const Z=c.useMemo(()=>ot(he),[he.horizonMonths,he.startMonth]),J=c.useMemo(()=>{const t=Be.find(o=>o.value===H);return!t||t.count==null?Z:Z.slice(0,t.count)},[Z,H]),we=c.useMemo(()=>it(Y),[Y]),Ne=c.useMemo(()=>tt(Y),[r.productCategories]),ne=c.useMemo(()=>ct(Y,we),[we,Y]),ye=c.useMemo(()=>lt({products:ne,search:M,onlyActive:k,onlyWithForecast:j,visibleMonths:J,manualDraft:p,forecastImport:B}),[B,p,k,j,ne,M,J]),w=c.useMemo(()=>{const t=new Map;ye.forEach(s=>{var i;const a=String(s.categoryLabel||"Ohne Kategorie");t.has(a)||t.set(a,[]),(i=t.get(a))==null||i.push(s)});const o=Array.from(t.entries()).map(([s,a])=>({key:s,label:s,rows:a.sort((i,f)=>i.sku.localeCompare(f.sku))}));return rt(o,Ne)},[Ne,ye]);c.useEffect(()=>{se(t=>{if(!w.length)return[];const o=new Set(w.map(a=>a.key)),s=t.filter(a=>o.has(a));return s.length||I?s:w.map(a=>a.key)})},[w,I]),c.useEffect(()=>{st("forecast",re)},[re]);const xe=c.useMemo(()=>ut({allMonths:Z,products:ne,manualDraft:p,forecastImport:B}),[Z,B,p,ne]),Ke=c.useMemo(()=>{const t=[{header:"SKU",accessorKey:"sku",meta:{width:190,minWidth:190},cell:({row:s})=>s.original.isPlan?e.jsxs(U,{size:6,children:[e.jsx(y,{color:"blue",children:"Plan"}),e.jsx("span",{children:s.original.plannedSku||"Pre-SKU"})]}):s.original.sku},{header:"Alias",accessorKey:"alias",meta:{width:220,minWidth:220}},{header:"Status",meta:{width:86,minWidth:86},cell:({row:s})=>s.original.isPlan?e.jsx(y,{color:"blue",children:"Plan"}):s.original.isActive?e.jsx(y,{color:"green",children:"Aktiv"}):e.jsx(y,{children:"Inaktiv"})}],o=J.map(s=>({id:s,header:nt(s),meta:{width:118,minWidth:118,align:"right"},cell:({row:a})=>{var x;const i=a.original.sku,f=(x=p==null?void 0:p[i])==null?void 0:x[s],h=dt(B,i,s),v=mt(p,B,i,s,a.original.plannedUnitsByMonth);if(l==="units")return a.original.isPlan?e.jsxs("div",{className:"v2-forecast-cell",children:[e.jsx("div",{children:q(v,0)}),e.jsx(N,{type:"secondary",style:{fontSize:11},children:"Quelle: Plan (Baseline + Saisonalitaet)"})]}):e.jsxs("div",{className:"v2-forecast-cell",children:[e.jsx(vt,{className:"v2-grid-input",value:Number.isFinite(f)?f:null,onChange:b=>{R(ae=>{const O={...ae},oe={...O[i]||{}},Ee=typeof b=="number"&&Number.isFinite(b)?b:null;return Ee==null?delete oe[s]:oe[s]=Ee,Object.keys(oe).length?O[i]=oe:delete O[i],O}),K(!0)},min:0,controls:!1,placeholder:Number.isFinite(v)?String(Math.round(Number(v))):"—",style:{width:"100%"}}),e.jsxs(N,{type:"secondary",style:{fontSize:11},children:["Imp: ",q((h==null?void 0:h.units)??null,0)]})]});const D=ft(l,v,a.original);return e.jsxs("div",{children:[e.jsx("div",{children:q(D,2)}),e.jsxs(N,{type:"secondary",style:{fontSize:11},children:["Units: ",q(v,0)]})]})}}));return[...t,...o]},[B,p,l,J]);async function We(){await g(t=>{const o=ee(t),s=o;ce(s);const a=s.forecast;return a.forecastManual=pt(p),o},"v2:forecast:manual-save"),K(!1)}async function Le(t){await g(o=>{const s=ee(o),a=s;ce(a);const i=a.forecast,f=i.settings||{};return f.useForecast=t,i.settings=f,s},"v2:forecast:toggle-useForecast")}async function Ge(t){V(""),G([]);try{const o=await t.text(),s=He(o);if(s.error){W([]),V(s.error),G(s.warnings||[]);return}const a=(s.records||[]).map(i=>({sku:String(i.sku||"").trim(),month:be(i.month)||String(i.month||""),units:le(i.units),revenueEur:le(i.revenueEur),profitEur:le(i.profitEur)})).filter(i=>i.sku&&be(i.month));W(a),G(s.warnings||[]),ze(t.name)}catch(o){V(o instanceof Error?o.message:"Datei konnte nicht gelesen werden."),W([])}}async function Ve(){P.length&&await g(t=>{const o=ee(t),s=o;ce(s);const a=s.forecast,i=a.forecastImport&&typeof a.forecastImport=="object"?structuredClone(a.forecastImport):{},f=$==="overwrite"?{}:{...a.forecastImport||{}},h=new Map((Array.isArray(o.products)?o.products:[]).map(x=>{const b=x;return[String(b.sku||"").trim(),b]}));P.forEach(x=>{const b=x.sku,ae=h.get(b);if(!ae||Me&&!ht(ae))return;const O=be(x.month);O&&((!f[b]||typeof f[b]!="object")&&(f[b]={}),f[b][O]={units:x.units,revenueEur:x.revenueEur,profitEur:x.profitEur})}),a.forecastImport=f;const v=new Date().toISOString(),D=qe(s).bySku;return a.lastImportAt=v,a.importSource=me||"CSV",a.importCadence="monthly",a.lastDriftSummary=Mt({previousImport:i,nextImport:f,products:Array.isArray(s.products)?s.products:[],abcBySku:D,comparedAt:v,profile:"medium"}),o},`v2:forecast:import:${$}`)}async function $e(){A.comparedAt&&await g(t=>{const o=ee(t),s=o;ce(s);const a=s.forecast;return a.lastDriftReviewedAt=At(),a.lastDriftReviewedComparedAt=A.comparedAt,o},"v2:forecast:drift-reviewed")}async function Ze(){pe.length&&(await g(t=>{var f;const o=ee(t),s=o,a=Array.isArray(s.incomings)?[...s.incomings]:[],i=(f=a.slice().reverse().find(h=>String(h.payoutPct||"").trim()))==null?void 0:f.payoutPct;return pe.forEach(h=>{const v=Number(xe.get(h)||0),D=a.findIndex(x=>String(x.month||"")===h);if(D>=0){a[D]={...a[D],month:h,revenueEur:v,payoutPct:a[D].payoutPct||i||"0",source:"forecast"};return}a.push({month:h,revenueEur:v,payoutPct:i||"0",source:"forecast"})}),a.sort((h,v)=>String(h.month||"").localeCompare(String(v.month||""))),s.incomings=a,o},"v2:forecast:transfer-revenue"),fe(!1))}return e.jsxs("div",{className:"v2-page",children:[e.jsxs(Se,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(Re,{level:3,children:"Forecast"}),e.jsx(kt,{children:"Manuelle Forecast-Eingaben, Ventory CSV-Import und Übertragung der Forecast-Umsätze in `Eingaben`."})]})}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(Qe,{value:M,onChange:t=>E(t.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),e.jsx(yt,{value:H,onChange:t=>ue(t),options:Be.map(t=>({value:t.value,label:t.label})),style:{width:140,maxWidth:"100%"}}),e.jsxs(z.Group,{value:l,onChange:t=>S(t.target.value),children:[e.jsx(z.Button,{value:"units",children:"Units"}),e.jsx(z.Button,{value:"revenue",children:"Umsatz"}),e.jsx(z.Button,{value:"profit",children:"Gewinn"})]}),e.jsx(_,{checked:k,onChange:t=>F(t.target.checked),children:"Nur aktive Produkte"}),e.jsx(_,{checked:j,onChange:t=>X(t.target.checked),children:"Nur mit Forecast"}),e.jsx(_,{checked:!!((Ie=C.settings)!=null&&Ie.useForecast),onChange:t=>{Le(t.target.checked)},children:"`useForecast` aktiv"})]}),e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(Q,{type:"primary",onClick:()=>{We()},disabled:!T,loading:u,children:"Manuelle Änderungen speichern"}),e.jsx(Q,{onClick:()=>{const t=J.filter(o=>Number(xe.get(o)||0)>0);ke(t),fe(!0)},children:"Umsatz übertragen"}),T?e.jsx(y,{color:"orange",children:"Ungespeicherte Änderungen"}):e.jsx(y,{color:"green",children:"Synchron"}),m?e.jsxs(y,{color:"green",children:["Gespeichert: ",new Date(m).toLocaleTimeString("de-DE")]}):null]})]})]}),d?e.jsx(ie,{type:"error",showIcon:!0,message:d}):null,n?e.jsx(ie,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsxs(Se,{children:[e.jsx(Re,{level:4,children:"Ventory CSV Import"}),e.jsxs(U,{direction:"vertical",style:{width:"100%"},children:[e.jsx("input",{type:"file",accept:".csv,text/csv",onChange:t=>{var s;const o=(s=t.target.files)==null?void 0:s[0];o&&Ge(o)}}),e.jsxs(U,{wrap:!0,children:[e.jsxs(z.Group,{value:$,onChange:t=>Oe(t.target.value),children:[e.jsx(z.Button,{value:"merge",children:"Merge"}),e.jsx(z.Button,{value:"overwrite",children:"Overwrite"})]}),e.jsx(_,{checked:Me,onChange:t=>Ue(t.target.checked),children:"Nur aktive SKUs importieren"}),e.jsx(Q,{onClick:()=>{Ve()},disabled:!P.length,loading:u,children:"Import anwenden"}),me?e.jsx(y,{children:me}):null]}),de?e.jsx(ie,{type:"error",showIcon:!0,message:de}):null,L.length?e.jsx(ie,{type:"warning",showIcon:!0,message:`${L.length} Warnung(en) beim Import`,description:L.slice(0,5).join(" | ")}):null,P.length?e.jsxs(N,{type:"secondary",children:[P.length," Forecast-Zeilen erkannt."]}):e.jsx(N,{type:"secondary",children:"Noch keine Importdaten geladen."}),e.jsxs(U,{wrap:!0,children:[e.jsxs(y,{color:ve?"green":"gold",children:["Drift-Review: ",ve?"geprüft":"offen"]}),e.jsxs(y,{children:["Profil: ",A.thresholdProfile," · Flagged A/B: ",q(A.flaggedABCount,0)]}),A.comparedAt?e.jsxs(y,{children:["Verglichen: ",new Date(A.comparedAt).toLocaleDateString("de-DE")]}):e.jsx(y,{color:"default",children:"Kein Driftvergleich"}),ge?e.jsxs(y,{children:["Geprüft am: ",new Date(ge).toLocaleDateString("de-DE")]}):null,e.jsx(Q,{size:"small",onClick:()=>{$e()},disabled:!A.comparedAt||ve,children:"Drift geprüft"})]})]})]}),e.jsxs(Se,{children:[e.jsxs("div",{className:"v2-category-tools",children:[e.jsxs(N,{type:"secondary",children:[ye.length," Produkte in ",w.length," Kategorien"]}),e.jsxs("div",{className:"v2-actions-inline",children:[e.jsx(Q,{size:"small",onClick:()=>se(w.map(t=>t.key)),disabled:!w.length,children:"Alles auf"}),e.jsx(Q,{size:"small",onClick:()=>se([]),disabled:!re.length,children:"Alles zu"})]})]}),w.length?e.jsx(xt,{className:"v2-category-collapse",activeKey:re,onChange:t=>se((Array.isArray(t)?t:[t]).map(String)),items:w.map(t=>({key:t.key,label:e.jsxs(U,{children:[e.jsx(N,{strong:!0,children:t.label}),e.jsxs("span",{className:"v2-category-count",children:[t.rows.length," Produkte"]})]}),children:e.jsx(Xe,{data:t.rows,columns:Ke,minTableWidth:Math.max(980,520+J.length*118),tableLayout:"fixed"})}))}):e.jsx(N,{type:"secondary",children:"Keine Forecast-Zeilen für den aktuellen Filter."})]}),e.jsx(_e,{title:"Umsatz in Eingaben übertragen",open:Te,onCancel:()=>fe(!1),onOk:()=>{Ze()},children:e.jsxs(U,{direction:"vertical",style:{width:"100%"},children:[e.jsx(N,{type:"secondary",children:"Monate auswählen, deren Forecast-Umsatz in `incomings` übernommen wird."}),e.jsx(_.Group,{value:pe,onChange:t=>ke(t),style:{width:"100%"},children:e.jsx(U,{direction:"vertical",style:{width:"100%"},children:Z.map(t=>e.jsxs(_,{value:t,children:[t," · ",q(xe.get(t)||0,2)," €"]},t))})})]})})]})}export{$t as default};
