import{p as ie,aj as se,t as o,k as a,M as c,L as oe,af as W,Q as T,N as le,S as ue}from"./index-D6pMtF0j.js";import{D as v}from"./DataTable-CIb--nRu.js";import{S as ce}from"./SkuAliasCell-Cia6rTd8.js";import{c as L}from"./months-BTPgK-LH.js";import{u as de,C as g}from"./workspace-CPdCVGI9.js";import{b as me}from"./paymentJournalCore-CLzxti5g.js";import{b as he,a as w,t as F}from"./accountantReport-D7x8q_dA.js";import{s as pe}from"./index-7KSmUmnD.js";import{C as I}from"./index-B8Utj4Z_.js";import"./Dropdown-CGxjL3l8.js";import"./orderEditorFactory-Cb-qhJ1F.js";import"./store-DGjnfDd_.js";import"./prefill-CIdjv3IX.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-DDA5nvsY.js";import"./useBubbleLock-CgXBP_Sr.js";function E(n){const t=ie(n);return Number.isFinite(t)?Number(t):0}function ge(n){const t=n.settings||{};return{fxRate:E(t.fxRate),fxFeePct:E(t.fxFeePct),eurUsdRate:E(t.eurUsdRate),dutyRatePct:E(t.dutyRatePct),dutyIncludeFreight:t.dutyIncludeFreight!==!1,eustRatePct:E(t.eustRatePct),vatRefundEnabled:t.vatRefundEnabled!==!1,vatRefundLagMonths:Number(t.vatRefundLagMonths||0)||0,freightLagDays:Number(t.freightLagDays||0)||0,cny:t.cny&&typeof t.cny=="object"?{start:String(t.cny.start||""),end:String(t.cny.end||"")}:{start:"",end:""},cnyBlackoutByYear:t.cnyBlackoutByYear&&typeof t.cnyBlackoutByYear=="object"?structuredClone(t.cnyBlackoutByYear):{}}}function ye(n,t){const r=n&&typeof n=="object"?n:{};return me({state:r,settings:ge(r),products:Array.isArray(r.products)?r.products:[],month:String(t.month||""),scope:t.scope||"both",includeFo:!0})}function z(n){if(n==null||n==="")return"";const t=Number(n);return Number.isFinite(t)?t.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2,useGrouping:!1}):""}function fe(n){return n.map(t=>{var r;return{month:t.month||"",entityType:t.entityType,poNumber:t.poNumber,foNumber:t.foNumber,supplierName:t.supplierName,itemSummary:t.itemSummary||"",skuAliases:t.skuAliases,paymentType:t.paymentType,includedPositions:Array.isArray(t.includedPositions)?t.includedPositions.join("+"):"",status:t.status,dueDate:t.dueDate,paidDate:t.paidDate,amountPlannedEur:z(t.amountPlannedEur),amountActualEur:t.status==="PAID"?z(t.amountActualEur):"",issues:(r=t.issues)!=null&&r.length?t.issues.join("|"):"",paymentId:t.paymentId||"",payer:t.payer,paymentMethod:t.paymentMethod,note:t.note,internalId:t.internalId}})}function xe(n,t=";"){const r=["month","entityType","poNumber","foNumber","supplierName","itemSummary","skuAliases","paymentType","includedPositions","status","dueDate","paidDate","amountPlannedEur","amountActualEur","issues","paymentId","payer","paymentMethod","note","internalId"],l=d=>`"${String(d??"").replace(/"/g,'""')}"`,u=r.map(d=>l(d)).join(t),N=n.map(d=>r.map(A=>l(d[A])).join(t)).join(`
`);return`${u}
${N}`}function K(n,t){return n.reduce((r,l)=>r+(Number(l[t])||0),0)}const{Paragraph:be,Text:P,Title:je}=oe;function m(n){return Number.isFinite(n)?Number(n).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function y(n){return Number.isFinite(n)?Math.round(Number(n)).toLocaleString("de-DE"):"-"}function x(n){if(!n)return"-";const[t,r,l]=String(n).split("-").map(Number);if(!t||!r||!l)return"-";const u=new Date(t,r-1,l);return Number.isNaN(u.getTime())?"-":u.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function k(n){const t=String(n||"").trim().replace(/\./g,"").replace(",","."),r=Number(t);return Number.isFinite(r)?r:null}function ve(n,t){return n&&t?"both":t?"open":"paid"}function Ee(n,t){if(!Number.isFinite(n))return!1;const r=Number(n),l=Number.isFinite(t)?Number(t):null;return r>0||r===0&&l!=null&&l===0}const Pe={DATE_UNCERTAIN:"Datum unsicher (Due-Date verwendet).",AUTO_GENERATED:"Auto generiert (bitte pruefen).",IST_FEHLT:"Ist fehlt (Plan als Fallback).",MISSING_ACTUAL_AMOUNT:"Ist-Zahlung fehlt.",PRO_RATA_ALLOCATION:"Ist wurde anteilig verteilt.",GROUPED_PAYMENT:"Mehrere Positionen in einer Zahlung.",PAID_WITHOUT_DATE:"Bezahlt ohne Datum."};function Ae(n){const t=Array.from(new Set((Array.isArray(n)?n:[]).map(r=>Pe[String(r)]||String(r)).filter(Boolean)));return t.length?t.join(" "):"-"}function Ne(n){return n.status==="PAID"?n.paidDate||n.dueDate||"":n.dueDate||""}async function De(n){var l;const t=String(n||"");if(!t)return;if((l=navigator.clipboard)!=null&&l.writeText){await navigator.clipboard.writeText(t);return}const r=document.createElement("textarea");r.value=t,r.style.position="fixed",r.style.left="-9999px",r.style.top="-9999px",document.body.appendChild(r),r.focus(),r.select(),document.execCommand("copy"),document.body.removeChild(r)}function Ve(){const{state:n,loading:t,error:r}=de(),l=se(),[u,N]=o.useState(()=>L()),[d,A]=o.useState(!1),[b,B]=o.useState(""),[M,_]=o.useState(!0),[R,J]=o.useState(!1),[f,Z]=pe.useMessage(),[C,O]=o.useState(!1),[$,U]=o.useState(""),j=n,D=l.workspaceId||"Workspace",S=ve(M,R),s=o.useMemo(()=>he(j,{month:u,scope:d?"core_plus_journal":"core"},{inventoryValueOverrideEur:k(b)}),[d,b,u,j,D]),h=o.useMemo(()=>ye(j,{month:u,scope:S}).filter(e=>e.entityType==="PO"),[S,u,j]),V=o.useMemo(()=>K(h.filter(e=>e.status==="PAID"),"amountActualEur"),[h]),q=o.useMemo(()=>K(h.filter(e=>e.status==="OPEN"),"amountPlannedEur"),[h]),G=o.useMemo(()=>[{header:"Alias",accessorKey:"alias",meta:{width:260,minWidth:240},cell:({row:e})=>a.jsx(ce,{alias:e.original.alias,sku:e.original.sku})},{header:"Kategorie",accessorKey:"category"},{header:"Amazon",cell:({row:e})=>y(e.original.amazonUnits)},{header:"3PL",cell:({row:e})=>y(e.original.threePLUnits)},{header:"In Transit",cell:({row:e})=>y(e.original.inTransitUnits)},{header:"Warenwert EUR",cell:({row:e})=>m(e.original.rowValueEur)}],[]),H=o.useMemo(()=>[{header:"PO",accessorKey:"poNumber"},{header:"Supplier",accessorKey:"supplier"},{header:"SKU Alias",accessorKey:"skuAliases"},{header:"Paid Date",cell:({row:e})=>x(e.original.paidDate)},{header:"Ist EUR",cell:({row:e})=>m(e.original.actualEur)},{header:"USD",cell:({row:e})=>m(e.original.amountUsd)},{header:"Issues",cell:({row:e})=>{var i;return((i=e.original.issues)==null?void 0:i.join(" | "))||"-"}}],[]),Y=o.useMemo(()=>[{header:"PO",accessorKey:"poNumber"},{header:"Supplier",accessorKey:"supplier"},{header:"SKU Alias",accessorKey:"skuAliases"},{header:"Arrival",cell:({row:e})=>x(e.original.arrivalDate)},{header:"Units",cell:({row:e})=>y(e.original.units||0)},{header:"Goods EUR",cell:({row:e})=>m(e.original.goodsEur)},{header:"Issues",cell:({row:e})=>{var i;return((i=e.original.issues)==null?void 0:i.join(" | "))||"-"}}],[]),Q=o.useMemo(()=>[{header:"Zahlungsdatum",cell:({row:e})=>x(Ne(e.original)),meta:{width:120,minWidth:120}},{header:"Status",cell:({row:e})=>e.original.status==="PAID"?a.jsx(c,{color:"green",children:"Bezahlt"}):a.jsx(c,{color:"gold",children:"Offen"}),meta:{width:98,minWidth:98}},{header:"PO",accessorKey:"poNumber",meta:{width:110,minWidth:110}},{header:"Lieferant",accessorKey:"supplierName",meta:{width:180,minWidth:160}},{header:"Item",cell:({row:e})=>{const i=e.original.itemSummary||e.original.skuAliases||"-",p=e.original.itemTooltip||e.original.skuAliases||i;return a.jsx("span",{title:p,children:i})},meta:{width:160,minWidth:140}},{header:"Positionen",cell:({row:e})=>a.jsx("span",{title:Array.isArray(e.original.includedPositions)?e.original.includedPositions.join(", "):e.original.paymentType,children:e.original.paymentType||"-"}),meta:{width:180,minWidth:160}},{header:"Ist EUR",cell:({row:e})=>e.original.status==="PAID"?a.jsx("span",{className:Ee(e.original.amountActualEur,e.original.amountPlannedEur)?void 0:"v2-negative",children:m(e.original.amountActualEur)}):"-",meta:{width:120,minWidth:110,align:"right"}},{header:"Plan EUR",cell:({row:e})=>m(e.original.amountPlannedEur),meta:{width:120,minWidth:110,align:"right"}},{header:"Zahler",cell:({row:e})=>e.original.payer||"-",meta:{width:120,minWidth:110}},{header:"Methode",cell:({row:e})=>e.original.paymentMethod||"-",meta:{width:150,minWidth:140}},{header:"Notiz",cell:({row:e})=>a.jsx("span",{title:e.original.note||"-",children:e.original.note||"-"}),meta:{width:210,minWidth:180}},{header:"Hinweise",cell:({row:e})=>a.jsx("span",{title:Array.isArray(e.original.issues)?e.original.issues.join(`
`):"",children:Ae(e.original.issues)}),meta:{width:240,minWidth:200}}],[]),X=o.useMemo(()=>[{header:"PO",accessorKey:"poNumber"},{header:"Supplier",accessorKey:"supplier"},{header:"SKU Alias",accessorKey:"skuAliases"},{header:"Units",cell:({row:e})=>y(e.original.units||0)},{header:"Deposit EUR (Monat)",cell:({row:e})=>m(e.original.depositActualEurMonth)},{header:"Deposit USD (Monat)",cell:({row:e})=>m(e.original.depositAmountUsdMonth)},{header:"ETD",cell:({row:e})=>x(e.original.etdDate)},{header:"ETA",cell:({row:e})=>x(e.original.etaDate)},{header:"Ankunft",cell:({row:e})=>x(e.original.arrivalDate||e.original.etaDate)},{header:"Source",accessorKey:"arrivalSource"},{header:"Issues",cell:({row:e})=>{var i;return((i=e.original.issues)==null?void 0:i.join(" | "))||"-"}}],[]),ee=o.useMemo(()=>[{header:"Severity",accessorKey:"severity"},{header:"Code",accessorKey:"code"},{header:"Message",accessorKey:"message"},{header:"Entity",cell:({row:e})=>e.original.entityType||"-"},{header:"ID",cell:({row:e})=>e.original.entityId||"-"}],[]);async function te(){var e;if(!C){O(!0);try{const i=await w(j,{month:u,scope:d?"core_plus_journal":"core"},{workspaceName:D,inventoryValueOverrideEur:k(b)});U(((e=i==null?void 0:i.emailDraft)==null?void 0:e.text)||""),await F(i.zipBlob,i.zipFileName),f.success(`Paket erstellt: ${i.zipFileName}`)}catch(i){console.error(i),f.error(i instanceof Error?i.message:"Export fehlgeschlagen")}finally{O(!1)}}}async function ae(){var e;try{let i=$;if(!i){const p=await w(j,{month:u,scope:d?"core_plus_journal":"core"},{workspaceName:D,inventoryValueOverrideEur:k(b)});i=((e=p==null?void 0:p.emailDraft)==null?void 0:e.text)||"",U(i)}await De(i),f.success("E-Mail Text kopiert.")}catch(i){console.error(i),f.error(i instanceof Error?i.message:"Kopieren fehlgeschlagen")}}async function ne(){try{if(!h.length){f.warning(`Keine PO-Zahlungen fuer ${u} gefunden.`);return}const e=fe(h),i=xe(e,";"),p=`po_payment_journal_${u}_${S}.csv`,re=new Blob([i],{type:"text/csv;charset=utf-8"});await F(re,p),f.success(`Payment-Journal exportiert: ${p} (${h.length} Zeilen)`)}catch(e){console.error(e),f.error(e instanceof Error?e.message:"PO Payments Ledger Export fehlgeschlagen")}}return a.jsxs("div",{className:"v2-page",children:[Z,a.jsxs(g,{className:"v2-intro-card",children:[a.jsx("div",{className:"v2-page-head",children:a.jsxs("div",{children:[a.jsx(je,{level:3,children:"Buchhalter Export"}),a.jsx(be,{children:"One-Click Monats-Paket mit Preview: Warenbestand, Lieferanzahlungen, Wareneingaenge und E-Mail Text."})]})}),a.jsxs("div",{className:"v2-toolbar",children:[a.jsxs("div",{className:"v2-toolbar-row",children:[a.jsxs("div",{className:"v2-toolbar-field",children:[a.jsx(P,{children:"Monat"}),a.jsx(W,{type:"month",value:u,onChange:e=>N(e.target.value||L()),style:{width:180,maxWidth:"100%"}})]}),a.jsxs("div",{className:"v2-toolbar-field",children:[a.jsx(P,{children:"Scope"}),a.jsx(I,{checked:d,onChange:e=>A(e.target.checked),children:"Zahlungsjournal zusaetzlich"})]}),a.jsxs("div",{className:"v2-toolbar-field",children:[a.jsx(P,{children:"Warenwert Override EUR (optional)"}),a.jsx(W,{placeholder:"z.B. 150000",value:b,onChange:e=>B(e.target.value),style:{width:220,maxWidth:"100%"}})]}),a.jsxs("div",{className:"v2-toolbar-field",children:[a.jsx(P,{children:"Payments Filter"}),a.jsx(I,{checked:M,onChange:e=>_(e.target.checked),children:"Nur bezahlt"}),a.jsx(I,{checked:R,onChange:e=>J(e.target.checked),children:"Offen/geplant anzeigen"})]})]}),a.jsxs("div",{className:"v2-toolbar-row v2-toolbar-actions",children:[a.jsxs("div",{className:"v2-actions-inline",children:[a.jsx(T,{type:"primary",onClick:()=>{te()},loading:C,children:"Paket erstellen"}),a.jsx(T,{onClick:()=>{ne()},children:"Export Payment-Journal"}),a.jsx(T,{onClick:()=>{ae()},children:"E-Mail Text kopieren"})]}),a.jsxs(c,{color:"blue",children:["Anzahlungen: ",s.deposits.length]}),a.jsxs(c,{color:"blue",children:["Wareneingaenge: ",s.arrivals.length]}),a.jsxs(c,{color:"blue",children:["PO Payment-Zeilen: ",h.length]}),a.jsxs(c,{color:"green",children:["Ist (paid): ",m(V)]}),a.jsxs(c,{color:"orange",children:["Plan (open): ",m(q)]}),a.jsxs(c,{color:s.quality.length?"red":"green",children:["Issues: ",s.quality.length]})]})]})]}),r?a.jsx(le,{type:"error",showIcon:!0,message:"Workspace Fehler",description:r}):null,a.jsx(g,{title:"Monatszusammenfassung",children:a.jsxs(ue,{wrap:!0,children:[a.jsxs(c,{color:"default",children:["Snapshot: ",x(s.inventory.snapshotAsOf)]}),a.jsxs(c,{color:"green",children:["Warenwert: ",s.inventory.totalValueEur!=null?`${m(s.inventory.totalValueEur)} EUR`:"-"]}),a.jsxs(c,{color:"default",children:["Amazon: ",y(s.inventory.totalAmazonUnits)]}),a.jsxs(c,{color:"default",children:["3PL: ",y(s.inventory.total3plUnits)]}),a.jsxs(c,{color:"default",children:["Transit: ",y(s.inventory.totalInTransitUnits)]}),a.jsxs(c,{color:s.inventory.manualOverrideUsed?"orange":"default",children:["Override: ",s.inventory.manualOverrideUsed?"ja":"nein"]})]})}),a.jsx(g,{title:"Warenbestand Preview",loading:t,children:a.jsx(v,{data:s.inventoryRows||[],columns:G,minTableWidth:980,tableLayout:"auto"})}),a.jsx(g,{title:"Lieferanzahlungen Preview",loading:t,children:a.jsx(v,{data:s.deposits||[],columns:H,minTableWidth:1180,tableLayout:"auto"})}),a.jsxs(g,{title:"PO Zahlungsjournal (steuerrelevant)",loading:t,children:[a.jsx(P,{type:"secondary",children:"Monatsfilter basiert auf Zahlungsdatum. Fehlt das Zahlungsdatum bei bezahlten Events, wird Due-Date verwendet und als Hinweis markiert."}),a.jsx(v,{data:h,columns:Q,minTableWidth:1680,tableLayout:"auto"})]}),a.jsx(g,{title:"Anzahlungen + Wareneingang (PO)",loading:t,children:a.jsx(v,{data:s.poLedger||[],columns:X,minTableWidth:1480,tableLayout:"auto"})}),a.jsx(g,{title:"Wareneingang Preview",loading:t,children:a.jsx(v,{data:s.arrivals||[],columns:Y,minTableWidth:1100,tableLayout:"auto"})}),a.jsx(g,{title:"Quality Issues",loading:t,children:a.jsx(v,{data:s.quality||[],columns:ee,minTableWidth:960,tableLayout:"auto"})})]})}export{Ve as default};
