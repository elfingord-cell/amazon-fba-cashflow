import{ao as B,t as i,k as e,J as V,O as k,K as C,L as l,M as _,S as q}from"./index-CAzQztwo.js";import{T as v}from"./TanStackGrid-DGGNjv9D.js";import{c as K}from"./months-DiLwPhVv.js";import{u as J,C as m}from"./workspace-xr5uOuIo.js";import{b as G,a as M,t as $}from"./accountantReport-DKjKKWiG.js";import{s as H}from"./index-Cs7EqDZh.js";import{C as Q}from"./index-5SR9pC2K.js";import"./Dropdown-CZlZd-6U.js";import"./orderEditorFactory-3AxbAuwW.js";import"./store-BzgQ-F5B.js";import"./prefill-BxMihg1A.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-cLNRxzoZ.js";import"./useBubbleLock-Cjjrx1CM.js";const{Paragraph:Z,Text:b,Title:X}=V;function y(o){return Number.isFinite(o)?Number(o).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function u(o){return Number.isFinite(o)?Math.round(Number(o)).toLocaleString("de-DE"):"-"}function E(o){if(!o)return"-";const[n,t,d]=String(o).split("-").map(Number);if(!n||!t||!d)return"-";const c=new Date(n,t-1,d);return Number.isNaN(c.getTime())?"-":c.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function w(o){const n=String(o||"").trim().replace(/\./g,"").replace(",","."),t=Number(n);return Number.isFinite(t)?t:null}async function Y(o){var d;const n=String(o||"");if(!n)return;if((d=navigator.clipboard)!=null&&d.writeText){await navigator.clipboard.writeText(n);return}const t=document.createElement("textarea");t.value=n,t.style.position="fixed",t.style.left="-9999px",t.style.top="-9999px",document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}function ve(){const{state:o,loading:n,error:t}=J(),d=B(),[c,U]=i.useState(()=>K()),[h,D]=i.useState(!1),[p,W]=i.useState(""),[g,A]=H.useMessage(),[S,N]=i.useState(!1),[O,T]=i.useState(""),x=o,f=d.workspaceId||"Workspace",s=i.useMemo(()=>G(x,{month:c,scope:h?"core_plus_journal":"core"},{inventoryValueOverrideEur:w(p)}),[h,p,c,x,f]),z=i.useMemo(()=>[{header:"SKU",accessorKey:"sku"},{header:"Alias",accessorKey:"alias"},{header:"Kategorie",accessorKey:"category"},{header:"Amazon",cell:({row:r})=>u(r.original.amazonUnits)},{header:"3PL",cell:({row:r})=>u(r.original.threePLUnits)},{header:"In Transit",cell:({row:r})=>u(r.original.inTransitUnits)},{header:"Warenwert EUR",cell:({row:r})=>y(r.original.rowValueEur)}],[]),I=i.useMemo(()=>[{header:"PO",accessorKey:"poNumber"},{header:"Supplier",accessorKey:"supplier"},{header:"SKU Alias",accessorKey:"skuAliases"},{header:"Paid Date",cell:({row:r})=>E(r.original.paidDate)},{header:"Ist EUR",cell:({row:r})=>y(r.original.actualEur)},{header:"USD",cell:({row:r})=>y(r.original.amountUsd)},{header:"Issues",cell:({row:r})=>{var a;return((a=r.original.issues)==null?void 0:a.join(" | "))||"-"}}],[]),L=i.useMemo(()=>[{header:"PO",accessorKey:"poNumber"},{header:"Supplier",accessorKey:"supplier"},{header:"SKU Alias",accessorKey:"skuAliases"},{header:"Arrival",cell:({row:r})=>E(r.original.arrivalDate)},{header:"Units",cell:({row:r})=>u(r.original.units||0)},{header:"Goods EUR",cell:({row:r})=>y(r.original.goodsEur)},{header:"Issues",cell:({row:r})=>{var a;return((a=r.original.issues)==null?void 0:a.join(" | "))||"-"}}],[]),P=i.useMemo(()=>[{header:"Severity",accessorKey:"severity"},{header:"Code",accessorKey:"code"},{header:"Message",accessorKey:"message"},{header:"Entity",cell:({row:r})=>r.original.entityType||"-"},{header:"ID",cell:({row:r})=>r.original.entityId||"-"}],[]);async function R(){var r;if(!S){N(!0);try{const a=await M(x,{month:c,scope:h?"core_plus_journal":"core"},{workspaceName:f,inventoryValueOverrideEur:w(p)});T(((r=a==null?void 0:a.emailDraft)==null?void 0:r.text)||""),await $(a.zipBlob,a.zipFileName),g.success(`Paket erstellt: ${a.zipFileName}`)}catch(a){console.error(a),g.error(a instanceof Error?a.message:"Export fehlgeschlagen")}finally{N(!1)}}}async function F(){var r;try{let a=O;if(!a){const j=await M(x,{month:c,scope:h?"core_plus_journal":"core"},{workspaceName:f,inventoryValueOverrideEur:w(p)});a=((r=j==null?void 0:j.emailDraft)==null?void 0:r.text)||"",T(a)}await Y(a),g.success("E-Mail Text kopiert.")}catch(a){console.error(a),g.error(a instanceof Error?a.message:"Kopieren fehlgeschlagen")}}return e.jsxs("div",{className:"v2-page",children:[A,e.jsxs(m,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(X,{level:3,children:"Buchhalter Export"}),e.jsx(Z,{children:"One-Click Monats-Paket mit Preview: Warenbestand, Lieferanzahlungen, Wareneingaenge und E-Mail Text."})]})}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(b,{children:"Monat"}),e.jsx(k,{type:"month",value:c,onChange:r=>U(r.target.value||K()),style:{width:180,maxWidth:"100%"}})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(b,{children:"Scope"}),e.jsx(Q,{checked:h,onChange:r=>D(r.target.checked),children:"Zahlungsjournal zusaetzlich"})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(b,{children:"Warenwert Override EUR (optional)"}),e.jsx(k,{placeholder:"z.B. 150000",value:p,onChange:r=>W(r.target.value),style:{width:220,maxWidth:"100%"}})]})]}),e.jsxs("div",{className:"v2-toolbar-row v2-toolbar-actions",children:[e.jsxs("div",{className:"v2-actions-inline",children:[e.jsx(C,{type:"primary",onClick:()=>{R()},loading:S,children:"Paket erstellen"}),e.jsx(C,{onClick:()=>{F()},children:"E-Mail Text kopieren"})]}),e.jsxs(l,{color:"blue",children:["Anzahlungen: ",s.deposits.length]}),e.jsxs(l,{color:"blue",children:["Wareneingaenge: ",s.arrivals.length]}),e.jsxs(l,{color:s.quality.length?"red":"green",children:["Issues: ",s.quality.length]})]})]})]}),t?e.jsx(_,{type:"error",showIcon:!0,message:"Workspace Fehler",description:t}):null,e.jsx(m,{title:"Monatszusammenfassung",children:e.jsxs(q,{wrap:!0,children:[e.jsxs(l,{color:"default",children:["Snapshot: ",E(s.inventory.snapshotAsOf)]}),e.jsxs(l,{color:"green",children:["Warenwert: ",s.inventory.totalValueEur!=null?`${y(s.inventory.totalValueEur)} EUR`:"-"]}),e.jsxs(l,{color:"default",children:["Amazon: ",u(s.inventory.totalAmazonUnits)]}),e.jsxs(l,{color:"default",children:["3PL: ",u(s.inventory.total3plUnits)]}),e.jsxs(l,{color:"default",children:["Transit: ",u(s.inventory.totalInTransitUnits)]}),e.jsxs(l,{color:s.inventory.manualOverrideUsed?"orange":"default",children:["Override: ",s.inventory.manualOverrideUsed?"ja":"nein"]})]})}),e.jsx(m,{title:"Warenbestand Preview",loading:n,children:e.jsx(v,{data:s.inventoryRows||[],columns:z,minTableWidth:980,tableLayout:"auto"})}),e.jsx(m,{title:"Lieferanzahlungen Preview",loading:n,children:e.jsx(v,{data:s.deposits||[],columns:I,minTableWidth:1180,tableLayout:"auto"})}),e.jsx(m,{title:"Wareneingang Preview",loading:n,children:e.jsx(v,{data:s.arrivals||[],columns:L,minTableWidth:1100,tableLayout:"auto"})}),e.jsx(m,{title:"Quality Issues",loading:n,children:e.jsx(v,{data:s.quality||[],columns:P,minTableWidth:960,tableLayout:"auto"})})]})}export{ve as default};
