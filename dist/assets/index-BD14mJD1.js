import{p as pt,ac as Qt,ad as Zt,t as c,a7 as o,ae as ht,af as Jt,ag as Xt,k as t,M as g,P as ie,ab as ft,R as Qe,J as Yt,S as ce,a9 as Y,N as O,I as z,a8 as Ge,aa as es,W as _e,Q as ts}from"./index-Bu80Uwbp.js";import{T as ss}from"./TanStackGrid-X7-aza4k.js";import{D as v}from"./DeNumberInput-DQCzJE4i.js";import{E as rs}from"./index-BstOMiNp.js";import{b as ns,s as is}from"./categoryOrder-C77cYWrY.js";import{d as as}from"./shipping-9Dzo5wwm.js";import{r as ls,e as gt,s as ee}from"./productCompletenessV2-CGpzck-p.js";import{n as os,f as rt}from"./months-DiLwPhVv.js";import{a as cs}from"./tableModels-DxjFmPmo.js";import{e as ds,f as us}from"./planProducts-D4fZPYls.js";import{u as ms,C as xt}from"./workspace-CCwvBxSI.js";import{h as ps,g as hs,s as fs}from"./uiPrefs-CxTlE9qM.js";import{u as gs}from"./modalCollaboration-T341izGu.js";import{S as q}from"./index-CchoASSq.js";import{S as yt}from"./index-i7vZqF7s.js";import{C as vt}from"./Collapse-GdZk7VXL.js";import{C as te}from"./index-i0sE1Ifp.js";import{F as xs}from"./Table-BOrCuHte.js";import{s as Me}from"./index-BRveqc8-.js";import"./index-C0GAWedD.js";import"./DownOutlined-DBjqZVAX.js";import"./costing-CmZrILJ2.js";import"./Dropdown-Dn3rrflu.js";import"./useBubbleLock-DTzDssvh.js";import"./index-DXAmib6p.js";import"./Pagination-D7WYevyM.js";function jt(s){return s==="order_override"?"Diese PO/FO":s==="product"?"Produkt":s==="supplier"?"Lieferant":s==="settings"?"Settings":s==="computed"?"Berechnet":"Fehlt"}function Ve(s){if(s==null||s==="")return null;const i=Number(s);return Number.isFinite(i)?i:null}function ys(s){const i=s.template&&typeof s.template=="object"?s.template:{};return(i.fields&&typeof i.fields=="object"?i.fields:i)||{}}function V(s,i){return{value:s.value,source:s.source,sourceLabel:jt(s.source),hint:i,required:s.required}}function de(s,i,d,p=!1){return{value:s,source:i,sourceLabel:jt(i),hint:d,required:p}}function He(s){const i=Number(s);return Number.isFinite(i)&&i>0?i:null}function vs(s){const i=s.product||{},d=s.state||{},p=d.settings||{},f=ys(i),y=ls({state:d,product:i,sku:String(i.sku||""),supplierId:s.supplierId||String(i.supplierId||""),orderContext:"product"}),b=V(y.fields.moqUnits,"MOQ für Einkaufsplanung."),D=He(i.safetyStockDohOverride),se=He(p.safetyStockDohDefault),k=D!=null?de(D,"product","Produktspezifischer Safety-Wert."):de(se,se!=null?"settings":"missing","Default aus Settings (Safety Stock DOH)."),j=He(i.foCoverageDohOverride),W=He(p.foCoverageDohDefault),ae=j!=null?de(j,"product","Produktspezifischer Coverage-Wert."):de(W,W!=null?"settings":"missing","Default aus Settings (FO Coverage DOH)."),Le=String(f.transportMode||f.transport||"SEA").toUpperCase()||"SEA",be=f.transportMode||f.transport?"product":"settings",ke=y.fields.logisticsPerUnitEur.value!=null?V(y.fields.logisticsPerUnitEur,"Logistik-/Importanteil je Einheit in EUR."):de(null,"missing","Logistik-/Importanteil je Einheit in EUR."),C=as({unitCostUsd:y.fields.unitPriceUsd.value,landedUnitCostEur:Ve(i.landedUnitCostEur),fxEurUsd:y.fields.fxRate.value}),le=ke.value!=null?ke:de(Ve(C.value),Number.isFinite(Number(C.value))?"computed":"missing","Logistik-/Importanteil je Einheit in EUR.");return{moqEffective:b,safetyDohEffective:k,coverageDohEffective:ae,productionLeadDays:V(y.fields.productionLeadTimeDays,"Produktionszeit für Planung/Bestellung."),unitPriceUsd:V(y.fields.unitPriceUsd,"Stückpreis in USD für Kostenkalkulation."),fxRate:V(y.fields.fxRate,"FX in USD je EUR für Umrechnung."),logisticsPerUnitEur:le,transportMode:de(Le,be,"Transportmodus für ETA/Lead-Time."),transitDays:V(y.fields.transitDays,"Transitzeit in Tagen für Planung."),currency:V(y.fields.currency,"Währung für Kostenwerte."),dutyPct:V(y.fields.dutyRatePct,"Zollsatz in Prozent."),eustPct:V(y.fields.eustRatePct,"EUSt-Satz in Prozent."),ddp:V(y.fields.ddp,"DDP = Importkosten in Lieferpreis enthalten."),shippingSuggestion:{value:Ve(C.value),goodsCostEur:Ve(C.goodsCostEur),warning:C.warning===!0}}}const bs=["Jan","Feb","Maerz","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];function ks(s,i){if(!i)return null;const d=s==null?void 0:s[i];if(d&&typeof d=="object")return d;const p=i.toLowerCase(),f=Object.keys(s||{}).find(b=>b.toLowerCase()===p);if(!f)return null;const y=s==null?void 0:s[f];return y&&typeof y=="object"?y:null}function Ss(s){return Object.entries(s||{}).map(([i,d])=>{const p=os(i);if(!p)return null;const f=Number(p.slice(5,7));if(!Number.isFinite(f)||f<1||f>12)return null;const y=d&&typeof d=="object"?pt(d.units):pt(d);return Number.isFinite(y)?{month:p,monthNumber:f,units:Number(y)}:null}).filter(i=>!!i).sort((i,d)=>i.month.localeCompare(d.month))}function js(s){return Number.isFinite(s)?Number(s)<.9?"unterdurchschnittlich":Number(s)>1.1?"ueberdurchschnittlich":"durchschnittlich":"keine_daten"}function Us(s){const i=String(s.sku||"").trim();if(!i)return null;const d=ks(s.forecastImport||{},i);if(!d)return null;const p=Ss(d);if(!p.length)return null;const f=Array.from({length:12},()=>[]);p.forEach(k=>{f[k.monthNumber-1].push(k.units)});const y=f.map(k=>k.length?k.reduce((W,ae)=>W+ae,0)/k.length:null),b=y.filter(k=>Number.isFinite(k)),D=b.length?b.reduce((k,j)=>k+j,0)/b.length:null,se=y.map((k,j)=>{const W=Number.isFinite(k)&&Number.isFinite(D)&&Number(D)>0?Number(k)/Number(D):null;return{monthNumber:j+1,monthLabel:bs[j],averageUnits:Number.isFinite(k)?Number(k):null,factor:Number.isFinite(W)?Number(W):null,sampleCount:f[j].length,classification:js(W)}});return{sku:i,startMonth:p[0].month,endMonth:p[p.length-1].month,sampleMonthCount:p.length,coveredMonthTypes:se.filter(k=>k.sampleCount>0).length,overallAverage:D,months:se}}const{Paragraph:nt,Text:Fe,Title:ne}=Yt,Ps=[{value:"active",label:"Aktiv"},{value:"prelaunch",label:"Noch nicht gelauncht"},{value:"inactive",label:"Inaktiv"}],Ds=ts.map(s=>({value:s,label:s})),Es=["AIR","RAIL","SEA"],Ns=["EUR","USD","CNY"],bt={unitPriceUsd:["templateUnitPriceUsd"],avgSellingPriceGrossEUR:["avgSellingPriceGrossEUR"],sellerboardMarginPct:["sellerboardMarginPct"],moqUnits:["moqUnits"],productionLeadTimeDaysDefault:["productionLeadTimeDaysDefault"],incoterm_ddp:["templateDdp"],hsCode:["hsCode"],goodsDescription:["goodsDescription"],landedUnitCostEur:["landedUnitCostEur"]},kt=new Set(["moqUnits","templateDdp"]),Cs={sku:"SKU",alias:"Alias",hsCode:"HS-Code",goodsDescription:"Warenbeschreibung",supplierId:"Supplier",categoryId:"Kategorie",status:"Status",portfolioBucket:"Portfolio Bucket",includeInForecast:"Im Forecast berücksichtigen",avgSellingPriceGrossEUR:"Verkaufspreis (EUR)",sellerboardMarginPct:"Marge %",moqUnits:"MOQ Units",landedUnitCostEur:"Einstand (EUR)",logisticsPerUnitEur:"Shipping (EUR/Stk)",productionLeadTimeDaysDefault:"Production Lead Time",templateUnitPriceUsd:"EK (USD)",templateTransitDays:"Transit-Tage",templateDdp:"Incoterm / DDP"},it={scope:"filtered",selectedSkus:[],applyTemplateUnitPriceUsd:!1,templateUnitPriceUsd:null,applyAvgSellingPriceGrossEUR:!1,avgSellingPriceGrossEUR:null,applySellerboardMarginPct:!1,sellerboardMarginPct:null,applyMoqUnits:!1,moqUnits:null,applyProductionLeadTimeDaysDefault:!1,productionLeadTimeDaysDefault:null,applyTemplateTransitDays:!1,templateTransitDays:null,applyTemplateDdp:!1,templateDdp:!0};function at(){return new Date().toISOString()}function Is(s){return`${s}-${Math.random().toString(36).slice(2,9)}`}function m(s){if(s==null||s==="")return null;const i=Number(s);return Number.isFinite(i)?i:null}function Ms(s){const i=[m(s.formFx),m(s.settingsFx),m(s.resolvedFx)];for(let p=0;p<i.length;p+=1){const f=i[p];if(f!=null&&f>0&&f<10)return f}const d=m(s.settingsEurUsd);if(d!=null&&d>0&&d<10){const p=1/d;if(Number.isFinite(p)&&p>0)return p}for(let p=0;p<i.length;p+=1){const f=i[p];if(f!=null&&f>0)return f}return null}function N(s,i=2){return Number.isFinite(s)?Number(s).toLocaleString("de-DE",{minimumFractionDigits:i,maximumFractionDigits:i}):"—"}function Fs(s,i){const d=(i==null?void 0:i.kind)||"number";return d==="boolean"?s.value===!0?"Ja":"Nein":d==="text"?String(s.value||"—"):N(typeof s.value=="number"?s.value:null,(i==null?void 0:i.digits)??2)}function Ls(s){return s==="ok"?t.jsx(g,{color:"green",children:"OK"}):s==="warn"?t.jsx(g,{color:"orange",children:"WARN"}):t.jsx(g,{color:"red",children:"BLOCKED"})}function Ts(s){const i=String(s||"").trim().toLowerCase();return i==="all"||i==="active"||i==="prelaunch"||i==="inactive"?i:null}function Rs(s){const i=String(s||"").trim().toLowerCase();return i==="needs_fix"?"needs_fix":i==="revenue"?"revenue":i==="blocked"?"blocked":"all"}function St(s){if(!s.includeInForecast)return!1;const i=Number(s.avgSellingPriceGrossEUR);return!Number.isFinite(i)||i<=0||s.completeness==="blocked"}function lt(s){const i=(s==null?void 0:s.raw.template)||{},d=i.fields&&typeof i.fields=="object"?i.fields:i,p=Array.isArray(s==null?void 0:s.raw.launchCosts)?s==null?void 0:s.raw.launchCosts:[];return{id:s==null?void 0:s.id,sku:(s==null?void 0:s.sku)||"",alias:(s==null?void 0:s.alias)||"",hsCode:String((s==null?void 0:s.raw.hsCode)||""),goodsDescription:String((s==null?void 0:s.raw.goodsDescription)||""),supplierId:(s==null?void 0:s.supplierId)||"",categoryId:(s==null?void 0:s.categoryId)||null,status:(s==null?void 0:s.status)||"active",portfolioBucket:Qe(s==null?void 0:s.raw.portfolioBucket,ie.CORE),includeInForecast:(s==null?void 0:s.includeInForecast)!==!1,launchCosts:p.map((f,y)=>{const b=f;return{id:String(b.id||`lc-${y+1}`),type:String(b.type||b.category||"Sonstiges"),amountEur:m(b.amountEur??b.amount),currency:String(b.currency||"EUR"),date:String(b.date||""),note:String(b.note||"")}}),avgSellingPriceGrossEUR:(s==null?void 0:s.avgSellingPriceGrossEUR)??null,sellerboardMarginPct:(s==null?void 0:s.sellerboardMarginPct)??null,moqUnits:(s==null?void 0:s.moqUnits)??null,safetyStockDohOverride:m(s==null?void 0:s.raw.safetyStockDohOverride),foCoverageDohOverride:m(s==null?void 0:s.raw.foCoverageDohOverride),moqOverrideUnits:m(s==null?void 0:s.raw.moqOverrideUnits),landedUnitCostEur:m(s==null?void 0:s.raw.landedUnitCostEur),logisticsPerUnitEur:m((s==null?void 0:s.raw.logisticsPerUnitEur)??(s==null?void 0:s.raw.freightPerUnitEur)),productionLeadTimeDaysDefault:m(s==null?void 0:s.raw.productionLeadTimeDaysDefault),templateUnitPriceUsd:m(d.unitPriceUsd),templateTransportMode:String(d.transportMode||"SEA"),templateProductionDays:m(d.productionDays),templateTransitDays:m(d.transitDays),templateFreightEur:m(d.freightEur),templateDutyPct:m(d.dutyPct),templateVatImportPct:m(d.vatImportPct),templateFxRate:m(d.fxRate),templateCurrency:String(d.currency||"USD"),templateDdp:d.ddp===!0}}function or(){const s=Qt(),{state:i,loading:d,saving:p,error:f,lastSavedAt:y,saveWith:b}=ms(),D=Zt(),se=ps("products"),k=c.useRef(!1),[j,W]=c.useState("management"),[ae,Le]=c.useState(""),[be,ke]=c.useState("all"),[C,le]=c.useState("all"),[M,Ut]=c.useState("factor"),[re,Te]=c.useState(!1),[Pt,Ze]=c.useState(!1),[h,Je]=c.useState(null),[Re,ue]=c.useState(!1),[Dt,me]=c.useState([]),[Oe,Se]=c.useState(()=>hs("products")),[ot,ct]=c.useState(!1),[P]=o.useForm(),[pe]=o.useForm(),u=o.useWatch([],P),Et=o.useWatch([],pe),H=i,Nt=c.useMemo(()=>ht(H),[i.pos]),$=i.settings||{},Xe=i.forecast&&typeof i.forecast=="object"?i.forecast:{},Ae=Xe.forecastImport&&typeof Xe.forecastImport=="object"?Xe.forecastImport:{},Ye=c.useMemo(()=>Jt($),[$]),Ct=c.useMemo(()=>Xt({userId:D.userId,userEmail:D.email},Ye),[Ye,D.email,D.userId]),It=c.useMemo(()=>`products:edit:${String((h==null?void 0:h.id)||"new")}`,[h==null?void 0:h.id]),S=gs({workspaceId:D.workspaceId,modalScope:It,isOpen:re,userId:D.userId,userEmail:D.email,userDisplayName:Ct,displayNames:Ye});c.useEffect(()=>{if(k.current)return;const e=new URLSearchParams(s.search),n=String(e.get("source")||"");if(n!=="dashboard"&&n!=="plan-products")return;k.current=!0;const r=String(e.get("sku")||"").trim();if(r&&Le(r),n==="dashboard"){le(Rs(e.get("issues")));const a=Ts(e.get("status"));a&&ke(a),e.get("expand")==="all"&&ct(!0)}},[s.search]);const et=c.useMemo(()=>(Array.isArray(i.productCategories)?i.productCategories:[]).map(e=>({id:String(e.id||""),name:String(e.name||"Ohne Kategorie")})).filter(e=>e.id),[i.productCategories]),tt=c.useMemo(()=>(Array.isArray(i.suppliers)?i.suppliers:[]).map(e=>({id:String(e.id||""),name:String(e.name||"")})).filter(e=>e.id),[i.suppliers]),Ke=c.useMemo(()=>new Map(et.map(e=>[e.id,e.name])),[et]),je=c.useMemo(()=>new Map(tt.map(e=>[e.id,e.name])),[tt]),dt=c.useMemo(()=>ns(H),[i.productCategories]),Ue=c.useMemo(()=>cs({state:H,search:ae,statusFilter:be,categoryLabelById:Ke,supplierLabelById:je}),[Ke,ae,H,be,je]),he=c.useMemo(()=>Ue.reduce((e,n)=>{const r=St(n),a=n.completeness!=="ok"||r;return r&&(e.revenue+=1),a&&(e.needsFix+=1),n.completeness==="blocked"&&(e.blocked+=1),e},{revenue:0,needsFix:0,blocked:0}),[Ue]),Pe=c.useMemo(()=>C==="all"?Ue:Ue.filter(e=>{const n=St(e);return C==="revenue"?n:C==="blocked"?e.completeness==="blocked":e.completeness!=="ok"||n}),[Ue,C]),A=c.useMemo(()=>{const e=new Map;Pe.forEach(r=>{var l;const a=r.categoryId&&Ke.get(r.categoryId)||"Ohne Kategorie";e.has(a)||e.set(a,[]),(l=e.get(a))==null||l.push(r)});const n=Array.from(e.entries()).map(([r,a])=>({key:r,label:r,rows:a.sort((l,x)=>l.sku.localeCompare(x.sku))}));return is(n,dt)},[Ke,dt,Pe]),Q=c.useMemo(()=>Pe.filter(e=>e.status==="active"||e.status==="prelaunch"),[Pe]),Mt=c.useMemo(()=>Q.map(e=>({value:e.sku,label:`${e.alias||e.sku} · ${e.sku}`})),[Q]),F=Et||it,Ft=c.useMemo(()=>{if(F.scope==="selected"){const e=new Set(Q.map(n=>n.sku));return(Array.isArray(F.selectedSkus)?F.selectedSkus:[]).map(n=>String(n||"").trim()).filter(n=>n&&e.has(n))}return Q.map(e=>e.sku)},[Q,F.scope,F.selectedSkus]);c.useEffect(()=>{Se(e=>{if(!A.length)return[];const n=new Set(A.map(a=>a.key)),r=e.filter(a=>n.has(a));return r.length||se?r:A.map(a=>a.key)})},[A,se]),c.useEffect(()=>{ot&&A.length&&(Se(A.map(e=>e.key)),ct(!1))},[ot,A]),c.useEffect(()=>{fs("products",Oe)},[Oe]);function Be(e){return e==null||!Number.isFinite(e)?"—":e.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function Lt(e){const n=lt(e);Je(e),P.setFieldsValue(n),ue(n.logisticsPerUnitEur!=null),Te(!0)}function Tt(e){const n=e.status==="active"?"inactive":e.status==="inactive"?"prelaunch":"active";b(r=>{const a=_e(r);return a.products=(Array.isArray(a.products)?a.products:[]).map(l=>{const x=l;return String(x.sku||"").toLowerCase()!==e.sku.toLowerCase()?x:{...x,status:n,updatedAt:at()}}),a},"v2:products:toggle-status")}function Rt(e){Ge.confirm({title:`Produkt "${e.sku}" loeschen?`,onOk:async()=>{await b(n=>{const r=_e(n);return r.products=(Array.isArray(r.products)?r.products:[]).filter(a=>String(a.sku||"").toLowerCase()!==e.sku.toLowerCase()),r},"v2:products:delete")}})}async function Ot(e){const n=`${e.hsCode||""}	${e.goodsDescription||""}`;try{await navigator.clipboard.writeText(n),Me.success("Kopiert")}catch{Me.error("Kopieren fehlgeschlagen")}}const At=c.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:260,minWidth:260},cell:({row:r})=>t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx(Fe,{className:"v2-proj-alias-main",children:r.original.alias||r.original.sku}),t.jsx(Fe,{className:"v2-proj-sku-secondary",type:"secondary",children:r.original.sku})]})},{header:"Supplier",accessorFn:r=>r.supplierId?je.get(r.supplierId)||r.supplierId:"",meta:{width:190},cell:({row:r})=>r.original.supplierId?je.get(r.original.supplierId)||r.original.supplierId:"—"}],n={header:"Aktionen",meta:{width:j==="logistics"?274:230,minWidth:j==="logistics"?274:230,sortable:!1},cell:({row:r})=>t.jsxs("div",{className:"v2-actions-nowrap",children:[j==="logistics"?t.jsx(O,{size:"small",onClick:()=>{Ot(r.original)},children:"Copy"}):null,t.jsx(O,{size:"small",onClick:()=>Lt(r.original),children:"Bearbeiten"}),t.jsx(O,{size:"small",onClick:()=>Tt(r.original),children:"Status"}),t.jsx(O,{size:"small",danger:!0,onClick:()=>Rt(r.original),children:"Loeschen"})]})};return j==="logistics"?[...e,{header:"HS-Code",accessorKey:"hsCode",meta:{width:160},cell:({row:r})=>r.original.hsCode||"—"},{header:"Warenbeschreibung",accessorKey:"goodsDescription",meta:{minWidth:320,width:420},cell:({row:r})=>r.original.goodsDescription||"—"},n]:[...e,{header:"Status",accessorKey:"status",meta:{width:96},cell:({row:r})=>r.original.status==="inactive"?t.jsx(g,{children:"Inaktiv"}):r.original.status==="prelaunch"?t.jsx(g,{color:"gold",children:"Noch nicht gelauncht"}):t.jsx(g,{color:"green",children:"Aktiv"})},{header:"Bucket",accessorKey:"portfolioBucket",meta:{width:146},cell:({row:r})=>t.jsx(g,{color:r.original.portfolioBucket===ie.CORE?"green":r.original.portfolioBucket===ie.PLAN?"gold":"blue",children:r.original.portfolioBucket})},{header:"Forecast",accessorKey:"includeInForecast",meta:{width:120},cell:({row:r})=>r.original.includeInForecast?t.jsx(g,{color:"green",children:"Ja"}):t.jsx(g,{color:"default",children:"Nein"})},{header:"Completeness",accessorKey:"completeness",meta:{width:122},cell:({row:r})=>Ls(r.original.completeness)},{header:"Ø VK (EUR)",accessorKey:"avgSellingPriceGrossEUR",meta:{width:120,align:"right"},cell:({row:r})=>Be(r.original.avgSellingPriceGrossEUR)},{header:"Ø EK (USD)",accessorKey:"templateUnitPriceUsd",meta:{width:120,align:"right"},cell:({row:r})=>Be(r.original.templateUnitPriceUsd)},{header:"Ø Einstand (EUR)",accessorKey:"landedUnitCostEur",meta:{width:140,align:"right"},cell:({row:r})=>Be(r.original.landedUnitCostEur)},{header:"Ø Shipping China->Lager/3PL (EUR/Stk)",accessorKey:"shippingPerUnitEur",meta:{width:220,align:"right"},cell:({row:r})=>Be(r.original.shippingPerUnitEur)},n]},[P,j,b,je]),De=c.useMemo(()=>{var l;const e=(h==null?void 0:h.raw)||{},n=((l=e.template)==null?void 0:l.fields)||e.template||{},r=u||lt(h||void 0);return{...e,sku:r.sku||e.sku||"",alias:r.alias||e.alias||"",portfolioBucket:Qe(r.portfolioBucket??e.portfolioBucket,ie.CORE),includeInForecast:r.includeInForecast!==!1,launchCosts:ft(r.launchCosts??e.launchCosts,"draft-lc"),hsCode:r.hsCode||e.hsCode||"",goodsDescription:r.goodsDescription||e.goodsDescription||"",supplierId:r.supplierId||e.supplierId||"",categoryId:r.categoryId??e.categoryId??null,moqUnits:r.moqUnits??e.moqUnits??null,moqOverrideUnits:r.moqOverrideUnits??e.moqOverrideUnits??null,safetyStockDohOverride:r.safetyStockDohOverride??e.safetyStockDohOverride??null,foCoverageDohOverride:r.foCoverageDohOverride??e.foCoverageDohOverride??null,landedUnitCostEur:r.landedUnitCostEur??e.landedUnitCostEur??null,logisticsPerUnitEur:r.logisticsPerUnitEur??e.logisticsPerUnitEur??null,freightPerUnitEur:r.logisticsPerUnitEur??e.freightPerUnitEur??null,productionLeadTimeDaysDefault:r.productionLeadTimeDaysDefault??e.productionLeadTimeDaysDefault??null,template:{scope:"SKU",name:"Standard (SKU)",fields:{...n,unitPriceUsd:r.templateUnitPriceUsd??n.unitPriceUsd??null,transportMode:r.templateTransportMode||String(n.transportMode||"SEA"),productionDays:r.templateProductionDays??n.productionDays??null,transitDays:r.templateTransitDays??n.transitDays??null,freightEur:r.templateFreightEur??n.freightEur??null,dutyPct:r.templateDutyPct??n.dutyPct??null,vatImportPct:r.templateVatImportPct??n.vatImportPct??null,fxRate:r.templateFxRate??n.fxRate??$.fxRate??null,currency:r.templateCurrency||String(n.currency||$.defaultCurrency||"EUR"),ddp:r.templateDdp??n.ddp??!1}}}},[u,h,$.defaultCurrency,$.fxRate,H]),U=c.useMemo(()=>vs({product:De,state:H,supplierId:String(De.supplierId||"")}),[De,H]),L=c.useMemo(()=>gt({product:De,state:H}),[De,H]),fe=c.useMemo(()=>String((u==null?void 0:u.sku)||(h==null?void 0:h.sku)||"").trim(),[u==null?void 0:u.sku,h==null?void 0:h.sku]),T=c.useMemo(()=>fe?Us({forecastImport:Ae,sku:fe}):null,[Ae,fe]),we=c.useMemo(()=>T?T.months.map(e=>({key:String(e.monthNumber),monthLabel:e.monthLabel,factor:e.factor,averageUnits:e.averageUnits,sampleCount:e.sampleCount,value:M==="factor"?e.factor:e.averageUnits})):[],[T,M]),Kt=c.useMemo(()=>{if(!T)return null;const e=we.map(l=>l.monthLabel),n=we.map(l=>typeof l.value=="number"?l.value:null),r=M==="factor"?"Saisonalitäts-Faktor":"Ø Units",a=M==="factor"?2:Math.max(...n.filter(l=>Number.isFinite(l)),0);return{tooltip:{trigger:"axis",formatter:l=>{const E=(Array.isArray(l)?l:[])[0];if(!E||typeof E!="object")return"";const R=Number(E.dataIndex),I=Number.isFinite(R)?we[R]:null;if(!I)return"";const ye=typeof I.value=="number"?I.value:null,B=String(E.axisValue||""),Ee=M==="factor"?N(ye,2):`${N(ye,1)} Units`;return`${B}<br/>${M==="factor"?"Faktor":"Ø Units"}: ${Ee}<br/>Datenpunkte: ${I.sampleCount}`},valueFormatter:l=>Number.isFinite(l)?M==="factor"?N(l,2):`${N(l,1)} Units`:"—"},grid:{left:48,right:16,top:24,bottom:32},xAxis:{type:"category",data:e,axisLine:{show:!0}},yAxis:{type:"value",name:r,scale:!(a>0),min:M==="factor"?0:void 0,max:M==="factor"?Math.max(2,a):void 0,axisLabel:{formatter:l=>Number.isFinite(l)?M==="factor"?l.toFixed(2):N(l,1):"—"}},series:[{name:r,type:"line",data:n,smooth:!0,showSymbol:!0,symbolSize:6,lineStyle:{width:2}}]}},[T,we,M]),G=c.useMemo(()=>{const e=String((u==null?void 0:u.sku)||(h==null?void 0:h.sku)||"").trim();return e&&(Array.isArray(i.planProductMappings)?i.planProductMappings:[]).map((r,a)=>ds(r,a)).filter(r=>r.sku.toLowerCase()===e.toLowerCase()).sort((r,a)=>String(a.mappedAt||"").localeCompare(String(r.mappedAt||"")))[0]||null},[u==null?void 0:u.sku,h==null?void 0:h.sku,i.planProductMappings]),ze=c.useMemo(()=>G?us({mapping:G,forecastImport:Ae,maxMonths:18}):[],[Ae,G]),ge=c.useMemo(()=>{const e=new Map,n=(a,l,x)=>{const E=e.get(a);if(!E){e.set(a,{level:l,messages:[x]});return}l==="error"&&(E.level="error"),E.messages.includes(x)||E.messages.push(x)},r=L.blockScope?"error":"warning";return L.blockingMissing.forEach(a=>{(bt[a.fieldKey]||[]).forEach(x=>n(x,r,a.reason||a.label))}),L.importantMissing.forEach(a=>{(bt[a.fieldKey]||[]).forEach(x=>n(x,"warning",a.reason||a.label))}),e},[L]),ut=c.useMemo(()=>Array.from(ge.keys()).some(e=>kt.has(e)),[ge]);function Z(e){var n;return(n=ge.get(e))==null?void 0:n.level}function J(e){const n=ge.get(e);if(!(!n||!n.messages.length))return`Prüfen: ${n.messages.join(" · ")}`}const st=c.useMemo(()=>Array.from(ge.entries()).map(([e,n])=>({field:e,level:n.level,messages:n.messages,label:Cs[e]||String(e)})),[ge]);function mt(e){kt.has(e)&&me(["advanced"]),window.setTimeout(()=>{try{P.scrollToField(e,{block:"center"})}catch{}const n=P.getFieldInstance(e);n&&typeof n.focus=="function"&&n.focus()},80)}function Bt(){var n;const e=(n=st[0])==null?void 0:n.field;e&&mt(e)}const xe=c.useMemo(()=>{const e=u||{},n=Ms({formFx:e.templateFxRate,settingsFx:$.fxRate,settingsEurUsd:$.eurUsdRate,resolvedFx:U.fxRate.value}),r=m(e.templateUnitPriceUsd),a=m(e.landedUnitCostEur),l=r!=null&&n!=null&&n>0?r/n:null,x=a!=null&&l!=null?a-l:null;return{value:Number.isFinite(x)?Math.max(0,Number(x)):null,warning:Number.isFinite(x)?Number(x)<0:!1,goodsCostEur:l,fxUsed:n,landedUnitCostEur:a,unitCostUsd:r}},[u,U.fxRate.value,$.eurUsdRate,$.fxRate]);c.useEffect(()=>{if(!re||Re)return;const e=Number(xe.value);if(!Number.isFinite(e))return;const n=Math.round(e*100)/100,r=m(P.getFieldValue("logisticsPerUnitEur"));(r==null||Math.abs(r-n)>1e-5)&&P.setFieldValue("logisticsPerUnitEur",n)},[P,Re,re,xe.value]),c.useEffect(()=>{!re||!S.readOnly||!S.remoteDraftPatch||P.setFieldsValue(S.remoteDraftPatch)},[P,S.readOnly,S.remoteDraftPatch,S.remoteDraftVersion,re]),c.useEffect(()=>{if(!re){me([]);return}ut&&me(["advanced"])},[ut,re]);function wt(e){if(P.setFieldsValue({[e]:null}),e==="logisticsPerUnitEur"){ue(!1);const n=Number(xe.value);Number.isFinite(n)&&P.setFieldValue("logisticsPerUnitEur",Math.round(n*100)/100)}}function K(e,n){const r=String(e.source||"missing"),a=e.source==="missing"&&e.required===!0;return t.jsxs("span",{className:"v2-field-meta",children:[t.jsxs("span",{children:["Effektiv: ",Fs(e,n)]}),t.jsxs("span",{className:"v2-field-meta-source",children:[t.jsx("span",{children:"Quelle:"}),t.jsx("span",{className:ee(r==="computed"?"settings":r,a),children:e.sourceLabel})]}),t.jsx("span",{children:(n==null?void 0:n.extraHint)||e.hint})]})}function X(e,n){const r=u==null?void 0:u[n],a=r!=null&&r!=="";return t.jsxs("span",{className:"v2-field-meta-row",children:[t.jsx("span",{children:e}),a?t.jsx(O,{type:"link",size:"small",className:"v2-field-reset",onClick:l=>{l.preventDefault(),l.stopPropagation(),wt(n)},children:"Zuruecksetzen"}):null]})}function zt(){const e=lt(void 0);Je(null),P.setFieldsValue(e),ue(e.logisticsPerUnitEur!=null),me([]),Te(!0)}function qt(){pe.setFieldsValue({...it,scope:"filtered",selectedSkus:Q.map(e=>e.sku)}),Ze(!0)}function Wt(e){const n=e.template&&typeof e.template=="object"?e.template:{},r=n.fields&&typeof n.fields=="object"?n.fields:n;return{template:n,fields:r}}function $t(e,n){if(!n.length)throw new Error("Keine aktiven/prelaunch SKUs im aktuellen Zielumfang.");if(!(e.applyTemplateUnitPriceUsd||e.applyAvgSellingPriceGrossEUR||e.applySellerboardMarginPct||e.applyMoqUnits||e.applyProductionLeadTimeDaysDefault||e.applyTemplateTransitDays||e.applyTemplateDdp))throw new Error("Bitte mindestens ein Feld für den Bulk-Update aktivieren.");const a=(l,x,E)=>{if(!l)return;const R=Number(x);if(!Number.isFinite(R))throw new Error(`Bitte gültigen Wert setzen: ${E}.`)};a(e.applyTemplateUnitPriceUsd,e.templateUnitPriceUsd,"Ø EK (USD)"),a(e.applyAvgSellingPriceGrossEUR,e.avgSellingPriceGrossEUR,"Ø VK (EUR)"),a(e.applySellerboardMarginPct,e.sellerboardMarginPct,"Marge (%)"),a(e.applyMoqUnits,e.moqUnits,"MOQ"),a(e.applyProductionLeadTimeDaysDefault,e.productionLeadTimeDaysDefault,"Production Lead Time"),a(e.applyTemplateTransitDays,e.templateTransitDays,"Transit-Tage")}async function Gt(e){const n=new Set(Q.map(l=>l.sku)),r=e.scope==="selected"?(Array.isArray(e.selectedSkus)?e.selectedSkus:[]).map(l=>String(l||"").trim()).filter(l=>l&&n.has(l)):Q.map(l=>l.sku).filter(l=>n.has(l)),a=new Set(r);$t(e,r),await b(l=>{const x=_e(l),E=Array.isArray(x.products)?[...x.products]:[],R=at();let I=0;if(x.products=E.map(ye=>{const B=ye,Ee=String(B.sku||"").trim();if(!Ee||!a.has(Ee))return B;const w=String(B.status||"active").trim().toLowerCase();if(!(w==="active"||w==="prelaunch"||w==="aktiv"||w==="not_launched"||w==="planned"))return B;const _={...B},{template:ve,fields:qe}=Wt(B),oe={...qe};return e.applyAvgSellingPriceGrossEUR&&(_.avgSellingPriceGrossEUR=Number(e.avgSellingPriceGrossEUR)),e.applySellerboardMarginPct&&(_.sellerboardMarginPct=Number(e.sellerboardMarginPct)),e.applyMoqUnits&&(_.moqUnits=Math.max(0,Math.round(Number(e.moqUnits)))),e.applyProductionLeadTimeDaysDefault&&(_.productionLeadTimeDaysDefault=Math.max(0,Math.round(Number(e.productionLeadTimeDaysDefault)))),e.applyTemplateUnitPriceUsd&&(oe.unitPriceUsd=Number(e.templateUnitPriceUsd)),e.applyTemplateTransitDays&&(oe.transitDays=Math.max(0,Math.round(Number(e.templateTransitDays)))),e.applyTemplateDdp&&(oe.ddp=!!e.templateDdp),_.template={...ve,scope:ve.scope||"SKU",name:ve.name||"Standard (SKU)",fields:oe},_.updatedAt=R,I+=1,_}),!I)throw new Error("Keine passenden aktiven/prelaunch SKUs im Zielumfang gefunden.");return x},"v2:products:bulk-update"),Me.success(`Bulk-Update gespeichert (${r.length} SKU${r.length===1?"":"s"}).`),Ze(!1),pe.resetFields()}async function _t(e){if(S.readOnly)throw new Error("Dieses Produkt wird gerade von einem anderen Nutzer bearbeitet.");const n=e.sku.trim();if(!n)throw new Error("SKU ist erforderlich.");const r=e.includeInForecast!==!1,a=Number(e.sellerboardMarginPct),l=Number.isFinite(a)?a:null;if(r&&(!Number.isFinite(l)||Number(l)<=0||Number(l)>100))throw new Error("Brutto-Marge muss > 0 und <= 100 sein.");let x=!1;await b(E=>{const R=_e(E),I=Array.isArray(R.products)?[...R.products]:[],ye=ht(R),B=n.toLowerCase();if(I.find(Ie=>{const $e=Ie;return String($e.sku||"").toLowerCase()===B&&String($e.id||"")!==String(e.id||"")}))throw new Error("SKU existiert bereits.");const w=I.findIndex(Ie=>String(Ie.id||"")===String(e.id||"")),Ne=w>=0?I[w]:null,_=at(),ve=Qe(e.portfolioBucket,ie.CORE),qe=ye.has(B)?ie.CORE:ve;qe!==ve&&(x=!0);const oe=r,Vt=ft(e.launchCosts,`prod-${B}`),Ht={unitPriceUsd:e.templateUnitPriceUsd,transportMode:e.templateTransportMode,productionDays:e.templateProductionDays,transitDays:e.templateTransitDays,freightEur:e.templateFreightEur,dutyPct:e.templateDutyPct,vatImportPct:e.templateVatImportPct,fxRate:e.templateFxRate,currency:e.templateCurrency,ddp:e.templateDdp},Ce={...Ne||{},id:e.id||(Ne==null?void 0:Ne.id)||Is("prod"),sku:n,alias:e.alias.trim()||n,hsCode:String(e.hsCode||"").trim(),goodsDescription:String(e.goodsDescription||"").trim(),supplierId:e.supplierId||"",categoryId:e.categoryId||null,status:e.status||"active",portfolioBucket:qe,includeInForecast:oe,launchCosts:Vt,avgSellingPriceGrossEUR:e.avgSellingPriceGrossEUR,sellerboardMarginPct:l,moqUnits:e.moqUnits,safetyStockDohOverride:e.safetyStockDohOverride,foCoverageDohOverride:e.foCoverageDohOverride,moqOverrideUnits:e.moqOverrideUnits,landedUnitCostEur:e.landedUnitCostEur,logisticsPerUnitEur:e.logisticsPerUnitEur,freightPerUnitEur:e.logisticsPerUnitEur,productionLeadTimeDaysDefault:e.productionLeadTimeDaysDefault,template:{scope:"SKU",name:"Standard (SKU)",fields:Ht},updatedAt:_};Ce.createdAt||(Ce.createdAt=_);const We=gt({product:Ce,state:R});if(oe&&We.status==="blocked"&&We.blockScope){const Ie=We.blockingMissing.map($e=>$e.label).slice(0,5).join(", ");throw new Error(`Blockierende Stammdaten fehlen: ${Ie}${We.blockingMissing.length>5?" ...":""}`)}return w>=0?I[w]=Ce:I.push(Ce),R.products=I,R},h?"v2:products:update":"v2:products:create"),S.clearDraft(),Je(null),Te(!1),ue(!1),P.resetFields(),x&&Me.info("Bucket wurde automatisch auf Kernportfolio gesetzt, da bereits mindestens eine PO zur SKU existiert.")}return t.jsxs("div",{className:"v2-page",children:[t.jsxs(xt,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(ne,{level:3,children:"Produkte"}),t.jsx(nt,{children:"Produktstammdaten fuer Tagesbetrieb und Logistik-Workflow mit klarer Default-/Override-Anzeige."})]})}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(ce,{wrap:!0,children:[t.jsx(Y,{value:ae,onChange:e=>Le(e.target.value),placeholder:"Suche SKU, Alias, Supplier, Kategorie, HS-Code, Warenbeschreibung",style:{width:340,maxWidth:"100%"}}),t.jsx(q,{value:be,onChange:e=>ke(e),options:[{value:"all",label:"Alle"},{value:"active",label:"Aktiv"},{value:"prelaunch",label:"Noch nicht gelauncht"},{value:"inactive",label:"Inaktiv"}],style:{width:140,maxWidth:"100%"}}),t.jsxs("div",{className:"v2-products-issue-filters",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${C==="all"?"is-active":""}`,onClick:()=>le("all"),children:"Alle"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${C==="needs_fix"?"is-active":""}`,onClick:()=>le("needs_fix"),children:"Nur korrigieren"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${C==="revenue"?"is-active":""}`,onClick:()=>le("revenue"),children:"Umsatzrelevant"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${C==="blocked"?"is-active":""}`,onClick:()=>le("blocked"),children:"Nur Blocker"})]}),t.jsx(yt,{value:j,onChange:e=>W(e),options:[{value:"management",label:"Management"},{value:"logistics",label:"Logistik"}]}),t.jsx(O,{type:"primary",onClick:zt,children:"Produkt hinzufuegen"}),t.jsx(O,{onClick:qt,children:"Bulk bearbeiten"})]}),t.jsxs(ce,{wrap:!0,children:[t.jsxs(g,{color:he.needsFix>0?"gold":"green",children:["Korrekturbedarf: ",he.needsFix]}),t.jsxs(g,{color:he.revenue>0?"volcano":"green",children:["Umsatzrelevant: ",he.revenue]}),t.jsxs(g,{color:he.blocked>0?"red":"green",children:["Blocker: ",he.blocked]})]}),p?t.jsx(g,{color:"processing",children:"Speichern..."}):null,y?t.jsxs(g,{color:"green",children:["Gespeichert: ",new Date(y).toLocaleTimeString("de-DE")]}):null]})})]}),f?t.jsx(z,{type:"error",showIcon:!0,message:f}):null,d?t.jsx(z,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,t.jsxs(xt,{children:[t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(Fe,{type:"secondary",children:[Pe.length," Produkte in ",A.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(O,{size:"small",onClick:()=>Se(A.map(e=>e.key)),disabled:!A.length,children:"Alles auf"}),t.jsx(O,{size:"small",onClick:()=>Se([]),disabled:!Oe.length,children:"Alles zu"})]})]}),A.length?t.jsx(vt,{className:"v2-category-collapse",activeKey:Oe,onChange:e=>Se((Array.isArray(e)?e:[e]).map(String)),items:A.map(e=>({key:e.key,label:t.jsxs(ce,{children:[t.jsx(Fe,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(ss,{className:"v2-products-grid-wrap",data:e.rows,columns:At,minTableWidth:j==="management"?1120:940,tableLayout:"fixed"})})}))}):t.jsx(Fe,{type:"secondary",children:"Keine Produkte für den aktuellen Filter."})]}),t.jsxs(Ge,{title:"Bulk-Stammdaten bearbeiten",rootClassName:"v2-form-modal",open:Pt,onCancel:()=>{Ze(!1),pe.resetFields()},onOk:()=>{pe.validateFields().then(e=>Gt(e)).catch(()=>{})},width:900,children:[t.jsx(z,{type:"info",showIcon:!0,style:{marginBottom:10},message:`Bulk-Editor für aktive/prelaunch SKUs (${Q.length} verfügbar)`,description:"Bulk-Änderungen schreiben explizit auf Produkt-Ebene. Herkunft in Modal/Liste bleibt danach konsistent als „Produkt“."}),t.jsxs(o,{form:pe,layout:"vertical",initialValues:it,children:[t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"scope",label:"Zielumfang",style:{flex:1},children:t.jsx(q,{options:[{value:"filtered",label:"Alle aktiven/prelaunch aus aktuellem Filter"},{value:"selected",label:"Manuelle SKU-Auswahl"}]})}),t.jsx(o.Item,{label:"Ziel-SKUs (Preview)",style:{width:220},children:t.jsx(Y,{value:String(Ft.length),disabled:!0})})]}),F.scope==="selected"?t.jsx(o.Item,{name:"selectedSkus",label:"SKUs auswählen",children:t.jsx(q,{mode:"multiple",allowClear:!0,showSearch:!0,optionFilterProp:"label",placeholder:"SKU(s) wählen",options:Mt})}):null,t.jsxs("div",{className:"v2-bulk-grid",children:[t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateUnitPriceUsd",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Ø EK (USD)"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateUnitPriceUsd",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"decimal",min:0,disabled:!F.applyTemplateUnitPriceUsd})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyAvgSellingPriceGrossEUR",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Ø VK (EUR)"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"avgSellingPriceGrossEUR",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"decimal",min:0,disabled:!F.applyAvgSellingPriceGrossEUR})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applySellerboardMarginPct",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Marge (%)"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"sellerboardMarginPct",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"percent",min:0,max:100,disabled:!F.applySellerboardMarginPct})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyMoqUnits",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"MOQ (Units)"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"moqUnits",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"int",min:0,disabled:!F.applyMoqUnits})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyProductionLeadTimeDaysDefault",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Production Lead Time (Tage)"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"productionLeadTimeDaysDefault",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"int",min:0,disabled:!F.applyProductionLeadTimeDaysDefault})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateTransitDays",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Transit-Tage"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateTransitDays",style:{marginBottom:0,minWidth:180},children:t.jsx(v,{mode:"int",min:0,disabled:!F.applyTemplateTransitDays})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateDdp",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"DDP / Incoterm-Flag"})}),t.jsx(g,{className:ee("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateDdp",style:{marginBottom:0,minWidth:180},children:t.jsx(q,{disabled:!F.applyTemplateDdp,options:[{value:!0,label:"DDP = Ja"},{value:!1,label:"DDP = Nein"}]})})]})]})]})]}),t.jsxs(Ge,{title:h?`Produkt bearbeiten: ${h.sku}`:"Produkt hinzufuegen",rootClassName:"v2-form-modal",open:re,onCancel:()=>{S.clearDraft(),Te(!1),ue(!1),me([])},onOk:()=>{if(S.readOnly){Ge.warning({title:"Nur Lesemodus",content:`${S.remoteUserLabel||"Kollege"} bearbeitet dieses Produkt. Bitte Bearbeitung übernehmen oder warten.`});return}P.validateFields().then(e=>_t(e)).catch(e=>{Bt();const n=e instanceof Error?e.message:"Stammdaten prüfen";Me.warning(n)})},width:1060,children:[S.banner?t.jsx(z,{style:{marginBottom:10},type:S.banner.tone,showIcon:!0,message:S.banner.text,action:S.readOnly?t.jsx(O,{size:"small",onClick:S.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,S.readOnly&&S.remoteDraftVersion>0?t.jsxs(g,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",S.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,t.jsxs(o,{name:"v2-products-modal",form:P,layout:"vertical",disabled:S.readOnly,onValuesChange:e=>{S.readOnly||S.publishDraftPatch(e)},children:[t.jsx(o.Item,{name:"id",hidden:!0,children:t.jsx(Y,{})}),(u==null?void 0:u.includeInForecast)!==!1&&L.status!=="ok"?t.jsx(z,{style:{marginBottom:10},type:L.status==="blocked"&&L.blockScope?"error":"warning",showIcon:!0,message:L.status==="blocked"&&L.blockScope?"Blockierende Stammdaten fehlen":"Stammdaten prüfen",description:t.jsxs(ce,{direction:"vertical",size:8,style:{width:"100%"},children:[t.jsx("span",{children:[L.blockingMissing.length?`Blocker: ${L.blockingMissing.map(e=>e.label).join(", ")}`:null,L.importantMissing.length?`Wichtig: ${L.importantMissing.map(e=>e.label).join(", ")}`:null].filter(Boolean).join(" · ")}),st.length?t.jsx("div",{className:"v2-issue-chip-row",children:st.map(e=>t.jsx(O,{size:"small",className:`v2-issue-chip ${e.level==="error"?"is-error":"is-warning"}`,onClick:()=>mt(e.field),children:e.label},String(e.field)))}):null]})}):null,t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Basis"}),t.jsx("span",{className:"v2-form-section-desc",children:"Identitaet, Zuordnung und Logistik-Referenzdaten."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"sku",label:"SKU",style:{flex:1},rules:[{required:!0,message:"SKU fehlt."}],children:t.jsx(Y,{})}),t.jsx(o.Item,{name:"alias",label:"Alias",style:{flex:1},rules:[{required:!0,message:"Alias fehlt."}],children:t.jsx(Y,{})}),t.jsx(o.Item,{name:"portfolioBucket",label:"Portfolio Bucket",style:{width:190},rules:[{required:!0}],children:t.jsx(q,{options:Ds})}),t.jsx(o.Item,{name:"status",label:"Status",style:{width:140},children:t.jsx(q,{options:Ps})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"includeInForecast",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(te,{children:"Im Forecast berücksichtigen"})}),(()=>{var a;const e=String((u==null?void 0:u.sku)||(h==null?void 0:h.sku)||"").trim().toLowerCase(),n=!!(e&&Nt.has(e)),r=Qe((u==null?void 0:u.portfolioBucket)||((a=h==null?void 0:h.raw)==null?void 0:a.portfolioBucket),ie.CORE);return!n||r===ie.CORE?null:t.jsx(z,{type:"warning",showIcon:!0,message:"PO vorhanden: Produkt wird im Cashflow als Kernportfolio behandelt."})})()]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"categoryId",label:"Kategorie",style:{flex:1},children:t.jsx(q,{allowClear:!0,options:et.map(e=>({value:e.id,label:e.name}))})}),t.jsx(o.Item,{name:"supplierId",label:"Supplier",style:{flex:1},children:t.jsx(q,{allowClear:!0,options:tt.map(e=>({value:e.id,label:e.name}))})}),t.jsx(o.Item,{name:"hsCode",label:"HS-Code",style:{flex:1},validateStatus:Z("hsCode"),help:J("hsCode"),children:t.jsx(Y,{placeholder:"z. B. 3926.90.97"})})]}),t.jsx("div",{className:"v2-form-row",children:t.jsx(o.Item,{name:"goodsDescription",label:"Warenbeschreibung",style:{gridColumn:"1 / -1"},validateStatus:Z("goodsDescription"),help:J("goodsDescription"),children:t.jsx(Y.TextArea,{rows:2,placeholder:"Kurzbeschreibung fuer Zoll / Logistiker"})})})]}),t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Einmalige Launch-Kosten"}),t.jsx("span",{className:"v2-form-section-desc",children:"Datumsgenaue Einmalkosten für Launch-Planung im Cashflow."})]}),t.jsx(o.List,{name:"launchCosts",children:(e,{add:n,remove:r})=>t.jsxs(ce,{direction:"vertical",style:{width:"100%"},children:[e.map(a=>t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:[a.name,"type"],label:"Typ",style:{minWidth:180,flex:1},rules:[{required:!0,message:"Typ fehlt."}],children:t.jsx(q,{options:es.map(l=>({value:l,label:l}))})}),t.jsx(o.Item,{name:[a.name,"amountEur"],label:"Betrag (EUR)",style:{minWidth:160,flex:1},rules:[{required:!0,message:"Betrag fehlt."}],children:t.jsx(v,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:[a.name,"date"],label:"Datum",style:{minWidth:170},rules:[{required:!0,message:"Datum fehlt."}],children:t.jsx(Y,{type:"date"})}),t.jsx(o.Item,{name:[a.name,"note"],label:"Notiz",style:{flex:2},children:t.jsx(Y,{placeholder:"Optional"})}),t.jsx(o.Item,{style:{marginTop:30},children:t.jsx(O,{danger:!0,onClick:()=>r(a.name),children:"Entfernen"})})]},a.key)),t.jsx(O,{onClick:()=>n({type:"Sonstiges",amountEur:null,currency:"EUR",date:"",note:""}),children:"Launch-Kosten hinzufügen"})]})})]}),t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Preise & Kosten (operativ)"}),t.jsx("span",{className:"v2-form-section-desc",children:"Kerndaten fuer Planung sowie FO/PO-Prefill."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"avgSellingPriceGrossEUR",label:"Durchschnittlicher Verkaufspreis (EUR)",style:{flex:1},validateStatus:Z("avgSellingPriceGrossEUR"),help:J("avgSellingPriceGrossEUR"),rules:[{validator:(e,n)=>{if((u==null?void 0:u.includeInForecast)===!1)return Promise.resolve();const r=Number(n);return Number.isFinite(r)&&r>0?Promise.resolve():Promise.reject(new Error("Verkaufspreis ist erforderlich."))}}],children:t.jsx(v,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"sellerboardMarginPct",label:"Brutto-Marge %",style:{flex:1},validateStatus:Z("sellerboardMarginPct"),help:J("sellerboardMarginPct"),rules:[{validator:(e,n)=>{if((u==null?void 0:u.includeInForecast)===!1)return Promise.resolve();const r=Number(n);return Number.isFinite(r)&&r>0&&r<=100?Promise.resolve():Promise.reject(new Error("Marge muss > 0 und <= 100 sein."))}}],extra:t.jsx("span",{className:"v2-field-meta",children:"Wird für Gewinn-/Deckungsbeitragsrechnung genutzt."}),children:t.jsx(v,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateUnitPriceUsd",label:X("Durchschnittlicher EK (USD)","templateUnitPriceUsd"),style:{flex:1},validateStatus:Z("templateUnitPriceUsd"),help:J("templateUnitPriceUsd"),extra:K(U.unitPriceUsd,{digits:2}),children:t.jsx(v,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"landedUnitCostEur",label:"Durchschnittlicher Einstand (EUR)",style:{flex:1},validateStatus:Z("landedUnitCostEur"),help:J("landedUnitCostEur"),extra:t.jsx("span",{className:"v2-field-meta",children:"Landed Cost je Einheit laut Ist-/Logistikdaten."}),children:t.jsx(v,{mode:"decimal",min:0})})]}),t.jsx("div",{className:"v2-form-row",children:t.jsx(o.Item,{name:"logisticsPerUnitEur",label:X("Ø Shipping China->Lager/3PL (EUR/Stk)","logisticsPerUnitEur"),style:{gridColumn:"1 / -1"},extra:t.jsxs("span",{className:"v2-field-meta",children:[t.jsxs("span",{children:["Effektiv: ",N(m(u==null?void 0:u.logisticsPerUnitEur),2)]}),t.jsxs("span",{className:"v2-field-meta-source",children:[t.jsx("span",{children:"Quelle:"}),t.jsx("span",{className:ee(Re?"product":U.logisticsPerUnitEur.source==="computed"?"settings":U.logisticsPerUnitEur.source,!1),children:Re?"Produkt":U.logisticsPerUnitEur.sourceLabel})]}),t.jsxs("span",{children:["Vorschlag: ",N(m(xe.value),2)," EUR/Stk (Formel: Einstand (EUR) - EK in EUR)"]}),t.jsxs("span",{children:["EK in EUR (aus USD/FX): ",N(m(xe.goodsCostEur),2)," EUR/Stk"]}),t.jsxs("span",{children:["FX-Referenz: ",N(m(xe.fxUsed),4)," USD je EUR"]}),t.jsx("span",{children:"Kann je nach Datenbasis auch Zoll/EUSt/Importnebenkosten enthalten."})]}),children:t.jsx(v,{mode:"decimal",min:0,onChange:()=>ue(!0)})})})]}),t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Lieferzeit"}),t.jsx("span",{className:"v2-form-section-desc",children:"Operative Hauptwerte fuer Produktions- und Transitdauer."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"productionLeadTimeDaysDefault",label:X("Production Lead Time (Tage)","productionLeadTimeDaysDefault"),style:{flex:1},validateStatus:Z("productionLeadTimeDaysDefault"),help:J("productionLeadTimeDaysDefault"),extra:K(U.productionLeadDays,{digits:0}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateTransitDays",label:X("Transit-Tage","templateTransitDays"),style:{flex:1},extra:K(U.transitDays,{digits:0}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateTransportMode",label:"Transportmodus",style:{flex:1},extra:K(U.transportMode,{kind:"text"}),children:t.jsx(q,{options:Es.map(e=>({value:e,label:e}))})})]})]}),t.jsx(vt,{className:"v2-inline-collapse",activeKey:Dt,onChange:e=>{const n=Array.isArray(e)?e:[e];me(n.map(String).filter(Boolean))},items:[{key:"advanced",label:"Erweitert",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Policies & Beschaffungs-Template"}),t.jsx("span",{className:"v2-form-section-desc",children:"Optional: produktspezifische Overrides und tiefe Template-Defaults."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"moqUnits",label:X("MOQ Units","moqUnits"),style:{flex:1},validateStatus:Z("moqUnits"),help:J("moqUnits"),extra:K(U.moqEffective,{digits:0}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"moqOverrideUnits",label:X("MOQ Override Units","moqOverrideUnits"),style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Nur fuer dieses Produkt. Leer = Defaultkette."}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"safetyStockDohOverride",label:X("Safety Stock DOH Override","safetyStockDohOverride"),style:{flex:1},extra:K(U.safetyDohEffective,{digits:0}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"foCoverageDohOverride",label:X("FO Coverage DOH Override","foCoverageDohOverride"),style:{flex:1},extra:K(U.coverageDohEffective,{digits:0}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateCurrency",label:"Waehrung",style:{flex:1},extra:K(U.currency,{kind:"text"}),children:t.jsx(q,{options:Ns.map(e=>({value:e,label:e}))})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"templateProductionDays",label:"Template Produktionstage",style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Nur fuer Template-Fallbacks, falls keine operative Lead-Time gepflegt ist."}),children:t.jsx(v,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateFreightEur",label:"Template Logistik/Stk (EUR)",style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Fallback, wenn kein produktspezifischer Shipping-Wert gesetzt ist."}),children:t.jsx(v,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"templateFxRate",label:X("FX Rate (USD je EUR)","templateFxRate"),style:{flex:1},extra:K(U.fxRate,{digits:4}),children:t.jsx(v,{mode:"fx",min:0})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"templateDutyPct",label:"Zoll %",style:{flex:1},extra:K(U.dutyPct,{digits:2}),children:t.jsx(v,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateVatImportPct",label:"EUSt %",style:{flex:1},extra:K(U.eustPct,{digits:2}),children:t.jsx(v,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateDdp",label:"Incoterm / DDP",valuePropName:"checked",validateStatus:Z("templateDdp"),help:J("templateDdp"),extra:K(U.ddp,{kind:"boolean"}),children:t.jsx(te,{children:"DDP aktiv (Door-to-Door, Importkosten im Lieferpreis)"})})]})]})},{key:"seasonality",label:"Saisonalitaet (berechnet)",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Saisonalitaet aus Forecast-CSV"}),t.jsx("span",{className:"v2-form-section-desc",children:"Jan-Dez Faktoren aus den importierten Monats-Units je SKU."})]}),t.jsx(nt,{type:"secondary",style:{marginBottom:8},children:"Wir nehmen die Monatsabsatze (Units) aus der importierten CSV, bilden fuer jeden Kalendermonat (z. B. alle Januare) den Durchschnitt und teilen ihn durch den durchschnittlichen Monatswert ueber alle Monate. So entstehen Multiplikatoren, die zeigen, wie stark oder schwach ein Monat typischerweise im Vergleich zum Durchschnitt ist."}),fe?T?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"v2-seasonality-headline",children:[t.jsxs(ce,{wrap:!0,style:{marginBottom:8},children:[t.jsxs(g,{color:"blue",children:["Zeitraum: ",rt(T.startMonth)," bis ",rt(T.endMonth)," ","(",T.sampleMonthCount," Monate)"]}),t.jsxs(g,{color:T.coveredMonthTypes===12?"green":"gold",children:["Kalendermonate mit Daten: ",T.coveredMonthTypes,"/12"]}),t.jsxs(g,{children:["Ø Monats-Units (Basis): ",N(T.overallAverage,1)," (aus ",T.sampleMonthCount," Monatsdaten)"]})]}),t.jsx(yt,{options:[{value:"factor",label:"Faktor"},{value:"units",label:"Absatz (Units)"}],value:M,onChange:e=>Ut(e)})]}),t.jsx("div",{className:"v2-seasonality-chart-wrap",children:t.jsx(rs,{style:{height:240},option:Kt||void 0,opts:{renderer:"canvas"}})}),t.jsx(nt,{type:"secondary",style:{margin:"8px 0 0"},children:M==="factor"?"Faktor 1,00 = durchschnittlicher Monat, 1,40 = 40 % ueberdurchschnittlich, 0,70 = 30 % unterdurchschnittlich.":"Auftragsvolumen in Units zeigt den berechneten Monatsdurchschnitt aus der Forecast-CSV."})]}):t.jsx(z,{type:"warning",showIcon:!0,message:`Keine Forecast-Daten fuer SKU ${fe}`,description:"Bitte Forecast-CSV importieren. Das Profil wird aus den importierten Monats-Units abgeleitet."}):t.jsx(z,{type:"info",showIcon:!0,message:"Keine SKU gesetzt",description:"Saisonalitaet wird angezeigt, sobald eine SKU im Produkt gesetzt ist."})]})},{key:"plan-vs-live",label:"Plan-vs-Ist (Plan -> Live)",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ne,{level:5,className:"v2-form-section-title",children:"Lessons Learned: Plan vs Live/CSV"}),t.jsx("span",{className:"v2-form-section-desc",children:"Monatlicher Vergleich nach Übernahme eines Plan-Produkts in eine Live-SKU."})]}),fe?G?ze.length?t.jsxs(t.Fragment,{children:[t.jsxs(ce,{wrap:!0,style:{marginBottom:8},children:[t.jsxs(g,{color:"blue",children:["Plan: ",G.planProductAlias||G.planProductId]}),t.jsxs(g,{color:"green",children:["Live-SKU: ",G.sku]}),t.jsxs(g,{children:["Übernommen: ",G.mappedAt?new Date(G.mappedAt).toLocaleDateString("de-DE"):"—"]}),t.jsxs(g,{children:["Launch: ",G.launchDate||"—"]}),t.jsxs(g,{color:ze.length>=12?"green":"gold",children:["Monate im Vergleich: ",ze.length]})]}),t.jsx(xs,{size:"small",pagination:!1,rowKey:"month",dataSource:ze,columns:[{title:"Monat",dataIndex:"month",key:"month",sorter:(e,n)=>String(e.month||"").localeCompare(String(n.month||"")),render:e=>rt(e)},{title:"Plan Units",dataIndex:"planUnits",key:"planUnits",align:"right",sorter:(e,n)=>Number(m(e.planUnits)||0)-Number(m(n.planUnits)||0),render:e=>N(m(e),0)},{title:"Live Units (CSV)",dataIndex:"liveUnits",key:"liveUnits",align:"right",sorter:(e,n)=>Number(m(e.liveUnits)||0)-Number(m(n.liveUnits)||0),render:e=>N(m(e),0)},{title:"Delta Units",dataIndex:"deltaUnits",key:"deltaUnits",align:"right",sorter:(e,n)=>Number(m(e.deltaUnits)||0)-Number(m(n.deltaUnits)||0),render:e=>N(m(e),0)},{title:"Delta %",dataIndex:"deltaPct",key:"deltaPct",align:"right",sorter:(e,n)=>Number(m(e.deltaPct)||0)-Number(m(n.deltaPct)||0),render:e=>{const n=m(e);return Number.isFinite(n)?`${N(n,1)}%`:"—"}}]})]}):t.jsx(z,{type:"warning",showIcon:!0,message:"Noch keine überlappenden Monatsdaten",description:"Für Plan oder Live/CSV sind aktuell keine gemeinsamen Monatswerte vorhanden."}):t.jsx(z,{type:"info",showIcon:!0,message:"Kein Plan->Live Mapping für diese SKU",description:"Die Ansicht wird automatisch verfügbar, sobald ein Plan-Produkt als gelauncht markiert und dieser SKU zugeordnet wurde."}):t.jsx(z,{type:"info",showIcon:!0,message:"Keine SKU gesetzt",description:"Plan-vs-Ist wird angezeigt, sobald eine SKU im Produkt gesetzt ist."})]})}]})]})]})]})}export{or as default};
