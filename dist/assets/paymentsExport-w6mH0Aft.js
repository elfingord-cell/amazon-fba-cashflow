import{g as q,l as G}from"./index-DrOkdIyL.js";import{g as Y,b as Q}from"./orderEditorFactory-B9TeLUbV.js";import{f as Z}from"./prefill-BZ-aTdxD.js";import"./store-CuqvLxCQ.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./costing-CmZrILJ2.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-Bobc_K1p.js";import"./productCompleteness-CNODPsSo.js";function u(e,t={},n=[]){const a=document.createElement(e);return Object.entries(t).forEach(([s,c])=>{s==="class"?a.className=c:s.startsWith("on")&&typeof c=="function"?a.addEventListener(s.slice(2),c):c!=null&&a.setAttribute(s,c)}),(Array.isArray(n)?n:[n]).forEach(s=>{s!=null&&a.append(s.nodeType?s:document.createTextNode(String(s)))}),a}function M(e){return String(e||"").trim().toLowerCase()}function L(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function B(e){if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?"—":t.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function U(e){if(e==null||e==="")return"—";const t=Number(e);return Number.isFinite(t)?`${Z(t,2)} EUR`:"—"}function x(e){if(e==null||e==="")return"";const t=Number(e);return Number.isFinite(t)?Z(t,2):""}function X(e,t,n=";"){const a=o=>`"${(o==null?"":String(o)).replace(/"/g,'""')}"`,s=t.map(o=>a(o.label)).join(n),c=e.map(o=>t.map(p=>a(o[p.key])).join(n)).join(`
`);return`${s}
${c}`}function R(e){const t=new Map;return(e.suppliers||[]).forEach(n=>{if(!n)return;const a=String(n.name||"").trim();if(!a)return;const s=M(n.id),c=M(a);s&&t.set(s,a),c&&t.set(c,a)}),t}function j(e,t){const n=e.supplierName||e.supplier||"",a=M(e.supplierId||e.supplier||e.supplierName||"");return t.get(a)||(n?String(n):"—")}function w(e){const t=new Map;return(e||[]).forEach(n=>{const a=M(n==null?void 0:n.sku);a&&t.set(a,(n==null?void 0:n.alias)||(n==null?void 0:n.sku)||"")}),t}function tt(e,t){const n=Array.isArray(e==null?void 0:e.items)?e.items.filter(Boolean):[],a=n.length?n.map(c=>c==null?void 0:c.sku).filter(Boolean):[e==null?void 0:e.sku];return Array.from(new Set(a.map(c=>{const o=M(c);return o?t.get(o)||c:null}).filter(Boolean))).join(", ")||"—"}function C({label:e,eventType:t}){const n=String(e||"").toLowerCase();return t==="fx_fee"||n.includes("fx")?null:t==="freight"||n.includes("shipping")||n.includes("fracht")?"Fracht":t==="eust"||n.includes("eust")?"EUSt":n.includes("balance2")||n.includes("balance 2")||n.includes("second balance")?"Balance2":n.includes("balance")||n.includes("rest")?"Balance":n.includes("deposit")||n.includes("anzahlung")?"Deposit":null}function J(e,t=[]){const n=t.map(p=>Number(p.plannedEur||0)),a=n.reduce((p,h)=>p+h,0);if(!Number.isFinite(a)||a<=0)return null;const s=n.map((p,h)=>{const N=p/a,i=e*N;return{eventId:t[h].id,planned:p,raw:i,actual:Math.round(i*100)/100}}),c=s.reduce((p,h)=>p+h.actual,0),o=Math.round((e-c)*100)/100;if(Math.abs(o)>0){let p=s[s.length-1];s.length>1&&(p=s.reduce((h,N)=>N.planned>h.planned?N:h,p)),p.actual=Math.round((p.actual+o)*100)/100}return s}function et(e=[]){const t=new Map,n=new Map;return(e||[]).forEach(a=>{a!=null&&a.id&&(t.set(a.id,a),Array.isArray(a.allocations)&&a.allocations.forEach(s=>{s!=null&&s.eventId&&n.set(s.eventId,s)}))}),{byId:t,allocationByEvent:n}}function nt({payment:e,paymentRow:t,paymentRows:n}){if(!e||!(t!=null&&t.paymentId))return null;const a=Number(e.amountActualEurTotal);if(!Number.isFinite(a))return null;const s=(n||[]).filter(o=>o.paymentId&&o.paymentId===t.paymentId);if(!s.length)return null;const c=J(a,s);return c&&c.find(o=>o.eventId===t.id)||null}function z(e){const t=e.status==="PAID"?e.paidDate:e.dueDate;return t?t.slice(0,7):""}function $(e,t){if(!Number.isFinite(Number(e)))return!1;const n=Number(e),a=Number.isFinite(Number(t))?Number(t):null;return n>0||n===0&&a!=null&&a===0}function at({row:e,paymentRow:t,paymentRows:n,paymentRecord:a,paymentIndexes:s,state:c}){var h,N;const o=[];if(e.status!=="PAID")return{amountActualEur:null,issues:o};if(e.paidDate||o.push("PAID_WITHOUT_DATE"),(t==null?void 0:t.paidEurActual)!=null&&(t==null?void 0:t.paidEurActual)!==""&&Number.isFinite(Number(t==null?void 0:t.paidEurActual)))return $(t.paidEurActual,e.amountPlannedEur)?{amountActualEur:Number(t.paidEurActual),issues:o}:(o.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:Number(t.paidEurActual),issues:o});if((h=a==null?void 0:a.allocations)!=null&&h.length){const i=a.allocations.find(f=>{if(!f)return!1;if(f.eventId&&(t!=null&&t.id)&&f.eventId===t.id||f.plannedId&&(t!=null&&t.id)&&f.plannedId===t.id)return!0;if(f.entityType&&f.paymentType){const I=String(f.paymentType)===String(e.paymentType),S=String(f.entityType)===String(e.entityType),k=String(f.poNumber||"")===String(e.poNumber||"");return I&&S&&k}return!1});if(i&&$(i.amountEur,e.amountPlannedEur))return{amountActualEur:Number(i.amountEur),issues:o}}if(a&&(t!=null&&t.paymentId)){const i=((N=s==null?void 0:s.allocationByEvent)==null?void 0:N.get(t.id))||nt({payment:a,paymentRow:t,paymentRows:n});if(i&&$(i.actual,e.amountPlannedEur))return o.push("PRO_RATA_ALLOCATION"),{amountActualEur:Number(i.actual),issues:o};if($(a.amountActualEurTotal,e.amountPlannedEur)&&(n==null?void 0:n.length)===1)return{amountActualEur:Number(a.amountActualEurTotal),issues:o}}if(!(t!=null&&t.paymentId)&&e.paidDate&&(t!=null&&t.id)){const i=(c.payments||[]).find(f=>!f||f.paidDate!==e.paidDate?!1:!!(Array.isArray(f.coveredEventIds)&&f.coveredEventIds.includes(t.id)));if(i&&$(i.amountActualEurTotal,e.amountPlannedEur))return{amountActualEur:Number(i.amountActualEurTotal),issues:o}}return o.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:null,issues:o}}function ut({state:e,settings:t,products:n,month:a,scope:s}){const c=R(e),o=w(n),p=Array.isArray(e.pos)?e.pos:[],h=Array.isArray(e.fos)?e.fos:[],N=et(e.payments||[]),i=[],f={entityLabel:"PO",numberField:"poNo"};p.forEach(r=>{if(!r)return;const E=j(r,c),l=tt(r,o),m=JSON.parse(JSON.stringify(r)),A=Q(m,f,t,e.payments||[]);A.forEach(d=>{const y=C({label:d.typeLabel||d.label,eventType:d.eventType});if(!y)return;const P=d.paymentId?N.byId.get(d.paymentId):null,D=d.status==="paid"||d.status==="PAID"?"PAID":"OPEN",g=d.dueDate||"",T=(P==null?void 0:P.paidDate)||d.paidDate||"",v=Number.isFinite(Number(d.plannedEur))?Number(d.plannedEur):null,O=`PO-${r.id||r.poNo||""}-${y}-${g||T||""}`,F={rowId:O,eventId:d.id,month:z({status:D,dueDate:g,paidDate:T}),entityType:"PO",poNumber:r.poNo||"",foNumber:"",supplierName:E,skuAliases:l,paymentType:y,status:D,dueDate:g,paidDate:T,paymentId:d.paymentId||"",amountPlannedEur:v,payer:d.paidBy||"",paymentMethod:d.method||"",note:d.note||"",internalId:d.paymentInternalId||d.id||r.id||O},{amountActualEur:H,issues:W}=at({row:F,paymentRow:d,paymentRows:A,paymentRecord:P,paymentIndexes:N,state:e});i.push({...F,amountActualEur:H,issues:W})})}),h.forEach(r=>{if(!r||!Array.isArray(r.payments))return;const E=j(r,c),l=r.sku?o.get(M(r.sku))||r.sku:"—",m=Number(r.fxRate||0);r.payments.forEach(A=>{if(!A||A.category==="eust_refund")return;const d=C({label:A.label,eventType:A.category});if(!d)return;const y=Number(A.amount||0);if(!Number.isFinite(y)||y<=0)return;const D=(A.currency||"EUR")==="EUR"?y:m>0?y/m:y,g=A.dueDate||"",v=`FO-${r.id||r.foNumber||""}-${d}-${g||""}`;i.push({rowId:v,eventId:A.id||v,month:z({status:"OPEN",dueDate:g,paidDate:""}),entityType:"FO",poNumber:r.convertedPoNo||"",foNumber:r.foNumber||r.id||"",supplierName:E,skuAliases:l,paymentType:d,status:"OPEN",dueDate:g,paidDate:"",paymentId:"",amountPlannedEur:D,amountActualEur:null,payer:"",paymentMethod:"",note:"",internalId:r.id||v,issues:[]})})});const I=s||"both",S=i.filter(r=>!(I==="paid"&&r.status!=="PAID"||I==="open"&&r.status!=="OPEN"||a&&r.month!==a)),k=[],b=new Set;return S.forEach(r=>{b.has(r.rowId)||(b.add(r.rowId),k.push(r))}),k.sort((r,E)=>{const l=r.dueDate||r.paidDate||"",m=E.dueDate||E.paidDate||"";return l.localeCompare(m)})}function st(e,{month:t="",scope:n="both"}={},a={}){const s=e&&typeof e=="object"?e:{},c=a.settings||Y(),o=a.products||q();return ut({state:s,settings:c,products:o,month:t,scope:n})}function _({month:e,scope:t}){const n=G();return st(n,{month:e,scope:t})}function lt(e){return e.map(t=>{var n;return{month:t.month||"",entityType:t.entityType,poNumber:t.poNumber,foNumber:t.foNumber,supplierName:t.supplierName,skuAliases:t.skuAliases,paymentType:t.paymentType,status:t.status,dueDate:t.dueDate,paidDate:t.paidDate,amountPlannedEur:x(t.amountPlannedEur),amountActualEur:t.status==="PAID"?x(t.amountActualEur):"",issues:(n=t.issues)!=null&&n.length?t.issues.join("|"):"",paymentId:t.paymentId||"",payer:t.payer,paymentMethod:t.paymentMethod,note:t.note,internalId:t.internalId}})}function V(e,t){return e.reduce((n,a)=>n+(Number(a[t])||0),0)}let K=!1;function it(){if(K)return;K=!0;const e=[{id:"dep",plannedEur:3e3,dueDate:"2025-01-10",status:"open"},{id:"bal",plannedEur:7e3,dueDate:"2025-02-10",status:"open"}],t=J(9500,e)||[],n=t.reduce((s,c)=>s+Number(c.actual||0),0);console.assert(Math.round(n*100)/100===9500,"Allocation sum should match total");const a=t.find(s=>s.eventId==="dep");console.assert(a&&Math.round(a.actual*100)/100===2850,"Deposit allocation should be proportional"),console.assert(e[0].plannedEur===3e3&&e[1].plannedEur===7e3,"Planned values should remain unchanged")}function rt(e,{month:t,scope:n}){const a=window.open("","_blank","noopener,noreferrer");if(!a)return;const s=n==="paid"?"Paid":n==="open"?"Open":"Both",c=`Zahlungsjournal ${t||""}`.trim(),o=V(e.filter(i=>i.status==="PAID"),"amountActualEur"),p=V(e.filter(i=>i.status==="OPEN"),"amountPlannedEur"),h=e.map(i=>{var f;return`
    <tr>
      <td>${i.entityType}</td>
      <td>${i.entityType==="PO"?i.poNumber:i.foNumber}</td>
      <td>${i.supplierName}</td>
      <td>${i.paymentType}</td>
      <td>${i.status}</td>
      <td>${i.dueDate||""}</td>
      <td>${i.paidDate||""}</td>
      <td>${i.status==="PAID"?x(i.amountActualEur):""}</td>
      <td>${(f=i.issues)!=null&&f.length?i.issues.join(" | "):""}</td>
      <td>${i.paymentId||""}</td>
      <td>${i.paymentMethod||""}</td>
      <td>${i.payer||""}</td>
    </tr>
  `}).join(""),N=`<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>${c}</title>
  <style>
    body { font-family: "Inter", "Helvetica Neue", Arial, sans-serif; color: #0f1b2d; margin: 24px; }
    h1 { font-size: 20px; margin-bottom: 4px; }
    .summary { margin-bottom: 12px; font-size: 12px; color: #6b7280; }
    .actions { margin-bottom: 16px; }
    .btn { background: #3bc2a7; color: #fff; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { border: 1px solid #d7dde5; padding: 6px 8px; text-align: left; vertical-align: top; }
    th { background: #f4f7fa; font-weight: 600; }
    .totals { margin-top: 12px; font-size: 12px; }
    @media print {
      body { margin: 12mm; }
      .actions { display: none; }
      @page { size: A4; margin: 12mm; }
    }
  </style>
</head>
<body>
  <h1>${c}</h1>
  <div class="summary">Scope: ${s} · Rows: ${e.length}</div>
  <div class="actions"><button class="btn" onclick="window.print()">Drucken / Als PDF speichern</button></div>
  <table>
    <thead>
      <tr>
        <th>Typ</th>
        <th>PO/FO Nr</th>
        <th>Supplier</th>
        <th>PaymentType</th>
        <th>Status</th>
        <th>DueDate</th>
        <th>PaidDate</th>
        <th>Ist EUR</th>
        <th>Issues</th>
        <th>PaymentId</th>
        <th>Methode</th>
        <th>Zahler</th>
      </tr>
    </thead>
    <tbody>
      ${h}
    </tbody>
  </table>
  <div class="totals">
    <div>Sum Actual EUR (PAID): ${x(o)}</div>
    <div>Sum Planned EUR (OPEN): ${x(p)}</div>
  </div>
</body>
</html>`;a.document.open(),a.document.write(N),a.document.close()}function ot(e){const t=u("input",{type:"month",value:L()}),n=[{value:"paid",label:"Paid"},{value:"open",label:"Open"},{value:"both",label:"Both"}],a=[{value:"csv",label:"CSV"},{value:"print",label:"PDF (Print)"}];function s(b,r,E){const l=u("div",{class:"segment-control"});return r.forEach(m=>{const A=u("input",{type:"radio",name:b,value:m.value,id:`${b}-${m.value}`});m.value===E&&(A.checked=!0);const d=u("label",{for:`${b}-${m.value}`},[m.label]);l.append(A,d)}),l}const c=s("payment-scope",n,"both"),o=s("payment-format",a,"csv"),p=u("table",{class:"table-compact ui-table-standard ui-data-table payments-export-table","data-ui-table":"true","data-sticky-cols":"1"}),h=u("thead",{},[u("tr",{},[u("th",{},["Monat"]),u("th",{},["Typ"]),u("th",{},["PO/FO Nr"]),u("th",{},["Supplier"]),u("th",{},["SKU Alias"]),u("th",{},["Payment Type"]),u("th",{},["Status"]),u("th",{},["Fällig"]),u("th",{},["Bezahlt"]),u("th",{class:"num"},["Soll EUR"]),u("th",{class:"num"},["Ist EUR"]),u("th",{},["Issues"]),u("th",{},["Payment ID"]),u("th",{},["Zahler"]),u("th",{},["Methode"]),u("th",{},["Notiz"])])]),N=u("tbody");p.append(h,N);function i(){const b=c.querySelector("input:checked");return b?b.value:"both"}function f(){const b=o.querySelector("input:checked");return b?b.value:"csv"}function I(){N.innerHTML="";const b=t.value||"",r=i(),E=_({month:b,scope:r});return it(),E.forEach(l=>{if(l.status==="PAID"&&Number.isFinite(Number(l.amountActualEur))){const m=Number.isFinite(Number(l.amountPlannedEur))?Number(l.amountPlannedEur):null;(m==null||m>0)&&console.assert(Number(l.amountActualEur)>0,"Paid rows should not have 0 actual amounts")}}),E.length?(E.forEach(l=>{var g;const m=$(l.amountActualEur,l.amountPlannedEur),A=m?U(l.amountActualEur):"—",d=(g=l.issues)!=null&&g.length?l.issues.join(" | "):"",y=l.status==="PAID"&&!m,P=l.entityType==="PO"?l.poNumber||"—":l.foNumber||"—",D=[`${l.entityType}: ${P}`,l.skuAliases?`Alias: ${l.skuAliases}`:"",l.supplierName?`Supplier: ${l.supplierName}`:"",l.paymentType?`Payment: ${l.paymentType}`:""].filter(Boolean).join(`
`);N.append(u("tr",{},[u("td",{},[l.month||"—"]),u("td",{},[l.entityType]),u("td",{"data-ui-tooltip":D},[P]),u("td",{},[l.supplierName]),u("td",{"data-ui-tooltip":l.skuAliases||"—"},[l.skuAliases]),u("td",{},[l.paymentType]),u("td",{},[l.status==="PAID"?"Bezahlt":"Offen"]),u("td",{},[B(l.dueDate)]),u("td",{},[B(l.paidDate)]),u("td",{class:"num"},[U(l.amountPlannedEur)]),u("td",{class:"num"},[l.status==="PAID"?A:"—",y?u("span",{class:"cell-warning",title:"Bezahlt, aber keine Ist-Zahlung zugeordnet"},["⚠︎"]):null]),u("td",{},[d||"—"]),u("td",{},[l.paymentId||"—"]),u("td",{},[l.payer||"—"]),u("td",{},[l.paymentMethod||"—"]),u("td",{},[l.note||"—"])]))}),E):(N.append(u("tr",{},[u("td",{colspan:"16",class:"muted"},["Keine Zahlungen gefunden."])])),E)}const S=u("button",{class:"btn primary",type:"button"},["Export"]),k=u("button",{class:"btn secondary",type:"button"},["Preview"]);S.addEventListener("click",()=>{const b=t.value||"",r=i(),E=_({month:b,scope:r});if(!E.length){window.alert("Keine passenden Zahlungen für den Export gefunden.");return}if(f()==="print"){rt(E,{month:b,scope:r});return}const m=[{key:"month",label:"month"},{key:"entityType",label:"entityType"},{key:"poNumber",label:"poNumber"},{key:"foNumber",label:"foNumber"},{key:"supplierName",label:"supplierName"},{key:"skuAliases",label:"skuAliases"},{key:"paymentType",label:"paymentType"},{key:"status",label:"status"},{key:"dueDate",label:"dueDate"},{key:"paidDate",label:"paidDate"},{key:"amountPlannedEur",label:"amountPlannedEur"},{key:"amountActualEur",label:"amountActualEur"},{key:"issues",label:"issues"},{key:"paymentId",label:"paymentId"},{key:"payer",label:"payer"},{key:"paymentMethod",label:"paymentMethod"},{key:"note",label:"note"},{key:"internalId",label:"internalId"}],A=lt(E),d=X(A,m,";"),y=r||"both",D=`payment_journal_${b||L()}_${y}.csv`,g=new Blob([d],{type:"text/csv"}),T=URL.createObjectURL(g),v=u("a",{href:T,download:D});document.body.append(v),v.click(),v.remove(),URL.revokeObjectURL(T)}),k.addEventListener("click",()=>{I()}),t.addEventListener("change",I),c.addEventListener("change",I),e.innerHTML="",e.append(u("section",{class:"card"},[u("div",{class:"ui-page-head"},[u("div",{},[u("h2",{},["Payment Exports"])])]),u("div",{class:"payments-export-toolbar"},[u("div",{class:"payments-export-filters"},[u("label",{class:"payments-export-field"},[u("span",{},["Monat"]),t]),u("div",{class:"payments-export-field"},[u("span",{},["Scope"]),c]),u("div",{class:"payments-export-field"},[u("span",{},["Format"]),o])]),u("div",{class:"payments-export-actions"},[S,k])]),u("div",{class:"table-wrap ui-table-shell ui-scroll-host"},[p])])),I()}const gt={render:ot};export{st as buildPaymentJournalRowsFromState,gt as default,ot as render};
