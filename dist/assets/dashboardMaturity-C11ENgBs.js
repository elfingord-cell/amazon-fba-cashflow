function v(o){return String(o||"").trim()}function h(o){const t=Number(o);return Number.isFinite(t)?t:0}function N(o){const t=Math.abs(h(o.amount));return String(o.direction||"").toLowerCase()==="out"?-t:t}function A(o){const t=String(o.source||"").toLowerCase();return t==="po"?"po":t==="fo"?"fo":t==="sales"||t==="sales-plan"?"sales":t==="fixcosts"?"fixcosts":t==="extras"?"extras":t==="dividends"?"dividends":t==="vat"?"vat":t==="launch-costs"?"extras":"unknown"}function w(o){const t=String(o.source||"").toLowerCase(),a=String(o.kind||"").toLowerCase(),u=String(o.group||"").toLowerCase();return t==="po"||t==="fo"?"po_fo":t==="sales"||t==="sales-plan"?"inflow":t==="fixcosts"||u==="fixkosten"?"fixcost":a.includes("duty")||a.includes("eust")||a.includes("vat")||u.includes("import")?"tax":String(o.direction||"").toLowerCase()==="in"?"inflow":String(o.direction||"").toLowerCase()==="out"?"outflow":"other"}function k(o){const t=Array.isArray(o.products)?o.products:[],a=new Map;t.forEach(i=>{const n=v(i.sku);if(!n)return;const e=String(i.alias||"").trim()||n;a.set(n,e)});const u=new Map,p=(i,n)=>{const e=(i==="po"?[n.poNo,n.id]:[n.foNo,n.foNumber,n.id]).map(s=>String(s||"").trim()).filter(Boolean);if(!e.length)return;const l=Array.isArray(n.items)&&n.items.length?n.items:[{sku:n.sku,units:n.units}],m=new Set;let f=0;l.forEach(s=>{const d=v(s.sku);if(!d)return;m.add(a.get(d)||d);const b=h(s.units??s.qty??s.quantity);f+=b});const c={aliases:Array.from(m),units:Number.isFinite(f)?f:null};Array.from(new Set(e)).forEach(s=>{u.set(`${i}:${s}`,c)})};return(Array.isArray(o.pos)?o.pos:[]).forEach(i=>p("po",i)),(Array.isArray(o.fos)?o.fos:[]).forEach(i=>p("fo",i)),u}function M(o){const t=new Map,a=k(o.state);return(Array.isArray(o.breakdown)?o.breakdown:[]).forEach(u=>{const p=String(u.month||"").trim();if(!p)return;const n=(Array.isArray(u.entries)?u.entries:[]).map(e=>{var g;const l=A(e),m=e.sourceNumber?String(e.sourceNumber):void 0,f=e.sourceId?String(e.sourceId):void 0,c=e.meta&&typeof e.meta=="object"?e.meta:{},s=l==="fo"&&(c.phantom===!0||(f?((g=o.provisionalFoIds)==null?void 0:g.has(f))===!0:!1)),d=e.provisional===!0||s,b=m&&(l==="po"||l==="fo")?`${l}:${m}`:null,S=b?a.get(b):null,r=c.cashIn&&typeof c.cashIn=="object"?c.cashIn:null;return{month:p,group:w(e),label:String(e.label||"Eintrag"),tooltip:typeof e.tooltip=="string"?e.tooltip:void 0,amount:N(e),provisional:d,paid:typeof e.paid=="boolean"?e.paid:null,source:l,portfolioBucket:e.portfolioBucket?String(e.portfolioBucket):c.portfolioBucket?String(c.portfolioBucket):null,sourceNumber:m,sourceId:f,tooltipMeta:S?{aliases:S.aliases,units:S.units,milestone:String(e.label||""),dueDate:e.date?String(e.date):null}:void 0,cashInMeta:r?{quoteSource:r.quoteSource?String(r.quoteSource):void 0,revenueSource:r.revenueSource?String(r.revenueSource):void 0,component:r.component?String(r.component):null,forecastRevenueRaw:Number.isFinite(Number(r.forecastRevenueRaw))?Number(r.forecastRevenueRaw):null,calibrationFactorApplied:Number.isFinite(Number(r.calibrationFactorApplied))?Number(r.calibrationFactorApplied):null,calibrationSourceMonth:r.calibrationSourceMonth?String(r.calibrationSourceMonth):null,calibrationMethod:r.calibrationMethod?String(r.calibrationMethod):null,planRevenueAfterCalibration:Number.isFinite(Number(r.planRevenueAfterCalibration))?Number(r.planRevenueAfterCalibration):null,payoutPct:Number.isFinite(Number(r.payoutPct))?Number(r.payoutPct):null,payoutAmount:Number.isFinite(Number(r.payoutAmount))?Number(r.payoutAmount):null}:void 0}});t.set(p,n)}),t}export{M as b};
