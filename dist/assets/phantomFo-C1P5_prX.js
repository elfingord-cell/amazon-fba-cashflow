import{p as Fe}from"./index-elUAAuqx.js";import{e as Ve,r as Ne}from"./productCompletenessV2-C6U-GVjR.js";import{c as Oe,a as We,n as Ie,m as qe}from"./months-DiLwPhVv.js";import{e as Ge,f as He,b as Xe,h as Ye,k as Ze}from"./orderUtils-BfaSmxZO.js";import{b as $e}from"./abcClassification-BRLNgmfY.js";import{c as Me,g as Je}from"./inventoryProjection-xbzaWWBa.js";const Ce={wide:.95,partial:.8},Qe={full:{label:"Vollständig",detail:"Coverage 100% und keine Blocker."},wide:{label:"Weitgehend",detail:"Coverage ≥95% und keine A/B-Blocker."},partial:{label:"Teilweise",detail:"Coverage ≥80%."},insufficient:{label:"Unzureichend",detail:"Coverage <80% oder A/B-Blocker."}};function Z(e){return String(e||"").trim()}function I(e){return Z(e).toLowerCase()}function et(e){if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function xe(e){return/^\d{4}-\d{2}$/.test(String(e||""))}function we(e){return e!=null&&String(e).trim()!==""}function _(e){const t=Fe(e);return Number.isFinite(t)?Number(t):null}function B(e){const t=_(e);return!Number.isFinite(t)||Number(t)<=0?null:Math.round(Number(t))}function tt(e){if(!xe(e))return null;const[t,s]=e.split("-").map(Number);return!t||!s?null:new Date(Date.UTC(t,s-1,1))}function st(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function rt(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`}function ot(e,t){const s=new Date(e.getTime());return s.setUTCDate(s.getUTCDate()+t),s}function Ee(e,t){const s=e.get(t),o=e.get(I(t)),n=String((s==null?void 0:s.abcClass)||(o==null?void 0:o.abcClass)||"C").toUpperCase();return n==="A"||n==="B"||n==="C"?n:"C"}function nt(e){const t=e.inventory&&typeof e.inventory=="object"?e.inventory:{},s=t.settings&&typeof t.settings=="object"?t.settings:{};return String(s.projectionMode||"").toLowerCase()==="doh"?"doh":"units"}function it(e){return Number.isFinite(e)?`${Math.max(0,Math.min(100,e*100)).toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}%`:"0.0%"}function Be(e,t){return!e||!e.hasForecast?"":Je({projectionMode:t,endAvailable:e.endAvailable,safetyUnits:e.safetyUnits,doh:e.doh,safetyDays:e.safetyDays})}function at(e,t){return e!=null&&e.hasForecast?t==="safety-negative"?"stock_oos":"stock_under_safety":"forecast_missing"}function ut(e){return e==="forecast_missing"?"Forecast fehlt":e==="stock_oos"?"Out-of-Stock":"Unter Safety"}function Pe(e){return e==="A"||e==="B"}function oe(e){return e==="A"?0:e==="B"?1:2}function Ae(e){return e==="stock_oos"?0:e==="stock_under_safety"?1:2}function Re(e){return e.slice().sort((t,s)=>{const o=oe(t.abcClass)-oe(s.abcClass);if(o!==0)return o;const n=Ae(t.issueType)-Ae(s.issueType);return n!==0?n:t.sku.localeCompare(s.sku,"de-DE")})}function Te(e){return e.slice().sort((t,s)=>{const o=Number(s.overdue)-Number(t.overdue);if(o!==0)return o;const n=oe(t.abcClass)-oe(s.abcClass);if(n!==0)return n;const i=t.orderMonth.localeCompare(s.orderMonth);return i!==0?i:t.sku.localeCompare(s.sku,"de-DE")})}function ct(e){const{coverageRatio:t,blockerCount:s,blockerAbCount:o,hasOrderDutyBlocker:n,hasOverdueOrderDutyBlocker:i}=e;return t>=.999999&&s===0?"full":o>0?"insufficient":t>=Ce.wide?n||i?"partial":"wide":t>=Ce.partial?"partial":"insufficient"}function lt(e,t){const o=(Array.isArray(e.incomings)?e.incomings:[]).find(u=>String(u.month||"")===t);if(o){const u=_(o.revenueEur),f=_(o.payoutPct);if(Number.isFinite(u)||Number.isFinite(f))return!0}const i=(e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{})[t];return i?Number.isFinite(_(i.realRevenueEUR))||Number.isFinite(_(i.realPayoutRatePct)):!1}function dt(e){const t=e.settings&&typeof e.settings=="object"?e.settings:{},s=t.vatPreview&&typeof t.vatPreview=="object"?t.vatPreview:{},o=e.vatPreviewMonths&&typeof e.vatPreviewMonths=="object"?e.vatPreviewMonths:{};return{active:[s.deShareDefault,s.feeRateDefault,s.fixInputDefault,s.feeRateOfGrossDefault,s.fixInputVatDefault].some(we),defaults:s,monthOverrides:o}}function ft(e,t){if(!e.active)return!0;const s=e.monthOverrides[t]&&typeof e.monthOverrides[t]=="object"?e.monthOverrides[t]:{};return[e.defaults.deShareDefault,e.defaults.feeRateDefault,e.defaults.fixInputDefault,e.defaults.feeRateOfGrossDefault,e.defaults.fixInputVatDefault,s.deShare,s.feeRateOfGross,s.fixInputVat].some(we)}function mt(e,t){const s=$e(e).bySku,o=[],n=[];return t.forEach(i=>{const u=Z(i.sku);if(!u)return;const f=String(i.alias||u),h=Ee(s,u),c={sku:u,alias:f,abcClass:h},l=_(i.avgSellingPriceGrossEUR);(!Number.isFinite(l)||Number(l)<=0)&&o.push(c);const r=Ve({product:i,state:e});(r==null?void 0:r.status)==="blocked"&&n.push(c)}),{missingPrice:o,blockedCompleteness:n}}function ht(e){const{state:t,product:s}=e,o=Ne({state:t,product:s,sku:String(s.sku||""),supplierId:String(s.supplierId||""),orderContext:"product"}),n=o.fields&&typeof o.fields=="object"?o.fields:{},i=S=>{const D=n[S];return!D||typeof D!="object"?null:D.value??null},u=String(i("transportMode")||"").toUpperCase(),f=String((s.template&&typeof s.template=="object"?s.template.transportMode:null)||"SEA").toUpperCase(),h=u||f||"SEA",c=i("ddp")===!0||String(s.incoterm||"").toUpperCase()==="DDP"||!!(s.template&&typeof s.template=="object"&&s.template.ddp===!0),l=c||h==="AIR",r=l?14:45,y=l?21:45,M=B(i("productionLeadTimeDays"))??B(s.productionLeadTimeDaysDefault)??B(s.template&&typeof s.template=="object"?s.template.productionDays:null)??r,p=B(i("transitDays"))??B(s.template&&typeof s.template=="object"?s.template.transitDays:null)??B(s.transitDays)??y;return{productionDays:M,transitDays:p,totalDays:Math.max(1,M+p),transportMode:h,ddp:c}}function gt(e){const t=new Map,s=e.months.filter(o=>o>=e.nowMonth).sort((o,n)=>o.localeCompare(n));return s.length&&e.products.forEach(o=>{const n=Z(o.sku);if(!n)return;const i=I(n),u=e.projection.perSkuMonth.get(n)||e.projection.perSkuMonth.get(i);if(!u)return;let f=null,h=null;for(let C=0;C<s.length;C+=1){const b=s[C],T=u.get(b),F=Be(T,e.projectionMode);if(F==="safety-negative"||F==="safety-low"){f=b,h=T||null;break}}if(!f)return;const c=tt(f);if(!(c instanceof Date)||Number.isNaN(c.getTime()))return;const l=ht({state:e.state,product:o}),r=ot(c,-l.totalDays),y=st(r),M=rt(r),p=M<e.nowMonth,S=Number(h==null?void 0:h.safetyUnits),D=Number(h==null?void 0:h.endAvailable),k=Number.isFinite(S)&&Number.isFinite(D)?Math.max(0,Math.ceil(S-D)):null;t.set(i,{sku:n,firstRiskMonth:f,latestOrderDate:y,orderMonth:M,leadTimeDays:l.totalDays,overdue:p,requiredArrivalDate:`${f}-01`,recommendedOrderDate:y,shortageUnits:k})}),t}function yt(e){const t=e.months.reduce((c,l)=>{const r=l.coverage.stockIssues.filter(y=>y.issueType==="forecast_missing").length;return c+r},0),s=e.months.reduce((c,l)=>c+l.coverage.safetyRiskSkus.length,0),o=e.months.reduce((c,l)=>c+l.coverage.orderDutyRiskSkus.length,0),n=e.months.reduce((c,l)=>c+l.coverage.overdueOrderDutySkuCount,0),i=e.months.filter(c=>{const l=c.checks.find(r=>r.key==="cash_in");return l&&!l.passed}).length,u=e.months.filter(c=>{const l=c.checks.find(r=>r.key==="vat");return l&&!l.passed}).length,f=[];if(t>0&&f.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${t} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:t,impact:"Kontostand nicht belastbar"}),s>0||o>0){const c=s+o,l=n>0?` · Überfällig ${n}`:"";f.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${c} SKU-Monat(e) mit Safety-/Bestellpflicht-Risiko${l}.`,severity:"error",route:"/v2/inventory/projektion",count:c,impact:"Stockout-Risiko in A/B möglich"})}i>0&&f.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${i} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:i,impact:"Kontostand-Projektion instabil"}),e.hasFixcostBasis||f.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:e.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),e.vatActive&&u>0&&f.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${u} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:u,impact:"Outflow-Bild unvollständig"}),e.revenueIssueSkus>0&&f.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${e.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:e.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const h=c=>c==="error"?2:1;return f.sort((c,l)=>{const r=h(l.severity)-h(c.severity);if(r!==0)return r;const y=l.count-c.count;return y!==0?y:c.title.localeCompare(l.title)}),f.slice(0,5)}function kt(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).filter(xe))).sort(),s=e.state||{},n=(Array.isArray(s.products)?s.products:[]).map(a=>a||{}).filter(a=>Z(a.sku)).filter(et),i=n.length,u=Array.isArray(s.fixcosts)&&s.fixcosts.length>0,f=dt(s),h=mt(s,n),c=new Set(h.missingPrice.map(a=>I(a.sku))),l=Oe(),r=nt(s),y=t.filter(a=>a<l),M=t.filter(a=>a>=l),p={perSkuMonth:new Map},S=y.length?Me({state:s,months:y,products:n,snapshot:null,snapshotMonth:y[0]||void 0,projectionMode:r}):p,D=M.length?Me({state:s,months:M,products:n,snapshot:null,snapshotMonth:We(l,-1),projectionMode:r}):p,k=$e(s).bySku,C=gt({state:s,products:n,months:t,projection:D,projectionMode:r,nowMonth:l}),b=t.map(a=>{const K=new Set,L=new Set,z=new Set,V=new Set,$=new Set,x=new Set,ie=new Set;let J=0;const Q=[],W=[];n.forEach(v=>{const m=Z(v.sku);if(!m)return;const d=I(m),w=String(v.alias||m),E=Ee(k,m),pe=a<l?S:D,le=pe.perSkuMonth.get(m)||pe.perSkuMonth.get(d),g=le==null?void 0:le.get(a),ve=Be(g,r),be=!!(g!=null&&g.hasForecast)&&!ve;if(!be){const De=at(g,ve),Le=r==="doh"?Number.isFinite(Number(g==null?void 0:g.doh))?Number(g==null?void 0:g.doh):null:Number.isFinite(Number(g==null?void 0:g.endAvailable))?Number(g==null?void 0:g.endAvailable):null,ze=r==="doh"?Number.isFinite(Number(g==null?void 0:g.safetyDays))?Number(g==null?void 0:g.safetyDays):null:Number.isFinite(Number(g==null?void 0:g.safetyUnits))?Number(g==null?void 0:g.safetyUnits):null;Q.push({sku:m,alias:w,abcClass:E,issueType:De,issueLabel:ut(De),value:Le,safetyValue:ze,projectionMode:r}),V.add(d),Pe(E)?$.add(d):x.add(d),g!=null&&g.hasForecast?L.add(m):K.add(m)}const P=C.get(d)||null,Se=!!(P&&P.orderMonth<=a);P&&Se&&(W.push({sku:m,alias:w,abcClass:E,firstRiskMonth:P.firstRiskMonth,latestOrderDate:P.latestOrderDate,orderMonth:P.orderMonth,leadTimeDays:P.leadTimeDays,overdue:P.overdue,requiredArrivalDate:P.requiredArrivalDate,recommendedOrderDate:P.recommendedOrderDate,shortageUnits:P.shortageUnits,reason:"Keine FO/PO vorhanden, die die Lücke schließt."}),z.add(m),V.add(d),Pe(E)?$.add(d):x.add(d),P.overdue&&ie.add(d)),be&&!Se&&(J+=1)});const ae=i?J/i:0,ee=V.size,te=$.size,he=x.size,_e=W.length>0,je=ie.size>0,se=ct({coverageRatio:ae,blockerCount:ee,blockerAbCount:te,hasOrderDutyBlocker:_e,hasOverdueOrderDutyBlocker:je}),ue=Qe[se],ce=se==="full"||se==="wide",q=lt(s,a),G=u,H=ft(f,a),X=h.missingPrice.length===0&&h.blockedCompleteness.length===0,re=[],R=v=>{re.push({id:`${v.checkKey}:${v.month}:${re.length}`,...v})};if(!ce){i===0&&R({month:a,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"});const v=Re(Q);v.slice(0,20).forEach(d=>{const w=d.issueType==="forecast_missing"?"/v2/forecast":"/v2/inventory/projektion",E=d.issueType==="forecast_missing"?"Forecast fehlt":d.issueType==="stock_oos"?"Out-of-Stock":"unter Safety";R({month:a,checkKey:"sku_coverage",severity:"error",message:`${d.sku} (${d.alias}): ${E} (${d.abcClass}).`,sku:d.sku,alias:d.alias,abcClass:d.abcClass,issueType:d.issueType,route:w})}),v.length>20&&R({month:a,checkKey:"sku_coverage",severity:"error",message:`+ ${v.length-20} weitere SKU(s) mit Bestandsproblemen.`,route:"/v2/inventory/projektion"});const m=Te(W);m.slice(0,20).forEach(d=>{const w=d.overdue?"überfällig":"fällig";R({month:a,checkKey:"sku_coverage",severity:"error",message:`${d.sku} (${d.alias}): Bestellpflicht ${w} bis ${d.latestOrderDate} (Risikomonat ${d.firstRiskMonth}).`,sku:d.sku,alias:d.alias,abcClass:d.abcClass,issueType:"order_duty",firstRiskMonth:d.firstRiskMonth,latestOrderDate:d.latestOrderDate,orderMonth:d.orderMonth,leadTimeDays:d.leadTimeDays,overdue:d.overdue,requiredArrivalDate:d.requiredArrivalDate,recommendedOrderDate:d.recommendedOrderDate,suggestedUnits:d.shortageUnits,route:"/v2/orders/fo"})}),m.length>20&&R({month:a,checkKey:"sku_coverage",severity:"error",message:`+ ${m.length-20} weitere SKU(s) mit Bestellpflicht.`,route:"/v2/orders/fo"})}q||R({month:a,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),G||R({month:a,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),H||R({month:a,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),X||(h.missingPrice.slice(0,20).forEach(m=>{R({month:a,checkKey:"revenue_inputs",severity:"error",message:`${m.sku} (${m.alias}): Ø VK-Preis fehlt.`,sku:m.sku,alias:m.alias,abcClass:m.abcClass,route:"/v2/products"})}),h.blockedCompleteness.filter(m=>!c.has(I(m.sku))).slice(0,20).forEach(m=>{R({month:a,checkKey:"revenue_inputs",severity:"error",message:`${m.sku} (${m.alias}): Stammdaten unvollständig.`,sku:m.sku,alias:m.alias,abcClass:m.abcClass,route:"/v2/products"})}));const ge=[{key:"sku_coverage",label:"Bestands- & Bestellpflicht-Coverage",status:ce?"ok":"error",passed:ce,detail:`${ue.label}: ${it(ae)} (${J}/${i}) · Blocker ${ee} (A/B ${te}, C ${he}) · Bestand ${Q.length} · Bestellpflicht ${W.length}`,blockerCount:ee+(i===0?1:0),route:K.size>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:q?"ok":"error",passed:q,detail:q?"vorhanden":"fehlend",blockerCount:q?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:G?"ok":"error",passed:G,detail:G?"vorhanden":"fehlend",blockerCount:G?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:H?"ok":"error",passed:H,detail:f.active?H?"vorhanden":"fehlend":"nicht aktiv",blockerCount:H?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:X?"ok":"error",passed:X,detail:X?"vollständig":`${h.missingPrice.length} ohne Preis · ${h.blockedCompleteness.length} unvollständig`,blockerCount:X?0:h.missingPrice.length+h.blockedCompleteness.length,route:"/v2/products"}],Ke=ge.every(v=>v.passed),ye=Re(Q),ke=Te(W);return{month:a,robust:Ke,checks:ge,blockers:re,blockerCount:re.length,coverage:{statusKey:se,statusLabel:ue.label,statusDetail:ue.detail,projectionMode:r,activeSkus:i,coveredSkus:J,ratio:ae,blockerCount:ee,blockerAbCount:te,blockerCCount:he,stockIssueCount:ye.length,orderDutyIssueCount:ke.length,overdueOrderDutySkuCount:ie.size,missingForecastSkus:Array.from(K).sort((v,m)=>v.localeCompare(m,"de-DE")),safetyRiskSkus:Array.from(L).sort((v,m)=>v.localeCompare(m,"de-DE")),orderDutyRiskSkus:Array.from(z).sort((v,m)=>v.localeCompare(m,"de-DE")),stockIssues:ye,orderDutyIssues:ke,abRiskSkuCount:te}}}),T=new Map;b.forEach(a=>T.set(a.month,a));const F=b.filter(a=>a.robust).length;let N=null;for(let a=0;a<b.length&&b[a].robust;a+=1)N=b[a].month;const A=new Set([...h.missingPrice.map(a=>I(a.sku)),...h.blockedCompleteness.map(a=>I(a.sku))]).size;return{months:b,monthMap:T,actions:yt({months:b,hasFixcostBasis:u,vatActive:f.active,revenueIssueSkus:A}),robustUntilMonth:N,robustMonthsCount:F,totalMonths:b.length,activeSkuCount:i}}const pt="robustness_order_duty_v2";function ne(e){return String(e||"").trim()}function fe(e){return ne(e).toLowerCase()}function de(e){const t=String(e||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const s=new Date(`${t}T00:00:00Z`);return Number.isNaN(s.getTime())?null:t}function vt(e){const t=Ie(e);return t?`${t}-01`:null}function j(e,t=0){const s=Fe(e);return Number.isFinite(s)?Number(s):t}function U(e){const t=j(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function O(e){const t=j(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:t}function bt(e){return Number.isFinite(e)?Math.round(e*100)/100:0}function St(e){if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function Y(e,t="PH"){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"")||t}function Dt(e){const t=Y(e.sku,"SKU").slice(0,14),s=Y(e.orderMonth,"OM"),o=Y(e.firstRiskMonth,"RM");return`phantom-fo-${t}-${s}-${o}`}function Mt(e){const t=Y(e.orderMonth,"000000").slice(0,6),s=Y(e.sku,"SKU").slice(0,6);return`PH-${t}-${s}`}function Ct(e){const t=new Map;return e.forEach(s=>{const o=ne(s.sku);if(!o)return;const n=fe(o);t.has(n)||t.set(n,s)}),t}function Pt(e,t){const s=kt({state:e,months:t}),o=new Map;return s.months.forEach(n=>{Ct(n.coverage.orderDutyIssues).forEach((u,f)=>{o.has(f)||o.set(f,u)})}),Array.from(o.values())}function me(e){const t=e!=null&&e.template&&typeof e.template=="object"?e.template:{};return(t.fields&&typeof t.fields=="object"?t.fields:t)||{}}function At(e){const t=me(e);return O(t.unitPriceUsd)??O(e==null?void 0:e.unitPriceUsd)??O(e==null?void 0:e.unitPrice)??0}function Rt(e){const t=me(e);return O(e==null?void 0:e.logisticsPerUnitEur)??O(e==null?void 0:e.freightPerUnitEur)??O(t.logisticsPerUnitEur)??O(t.freightEur)??0}function Tt(e){const t=e.product||{},s=e.settings||{},o=me(t),n=Ne({state:e.state,product:t||void 0,sku:String(t.sku||""),supplierId:e.supplierId||String(t.supplierId||""),orderContext:"fo"}),i=n.fields&&typeof n.fields=="object"?n.fields:{},u=D=>{const k=i[D];return!k||typeof k!="object"?null:k.value??null},f=String(u("transportMode")||o.transportMode||t.transportMode||"SEA").trim().toUpperCase(),h=f==="AIR"||f==="SEA"||f==="RAIL"?f:"SEA",c=u("ddp")===!0||String(t.incoterm||"").toUpperCase()==="DDP",l=c||h==="AIR",r=U(u("productionLeadTimeDays"))??U(t.productionLeadTimeDaysDefault)??U(o.productionDays)??U(s.defaultProductionLeadTimeDays)??(l?14:45),y=U(u("transitDays"))??U(o.transitDays)??U(t.transitDays)??(l?21:45),M=j(u("dutyRatePct"),j(s.dutyRatePct,0)),p=j(u("eustRatePct"),j(s.eustRatePct,0)),S=String(u("incoterm")||t.incoterm||(c?"DDP":"EXW")).trim().toUpperCase()||"EXW";return{productionDays:r,transitDays:y,totalDays:Math.max(1,r+y),transportMode:h,incoterm:S,dutyRatePct:Math.max(0,M),eustRatePct:Math.max(0,p)}}function Ut(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).map(s=>String(s||"").trim()))).filter(s=>/^\d{4}-\d{2}$/.test(s)).sort((s,o)=>s.localeCompare(o));return t.length?t:Ot(e.state)}function Ft(e){return Ze([],e||void 0)}function Ue(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function Nt(e,t){const s=Number(t.overdue)-Number(e.overdue);if(s!==0)return s;const o=u=>u==="A"?0:u==="B"?1:2,n=o(e.abcClass)-o(t.abcClass);if(n!==0)return n;const i=e.orderMonth.localeCompare(t.orderMonth);return i!==0?i:e.sku.localeCompare(t.sku,"de-DE")}function Ot(e,t=18){const s=e.settings&&typeof e.settings=="object"?e.settings:{},o=Ie(s.startMonth)||Oe(),n=U(s.horizonMonths)??Math.max(6,Math.round(Number(t)||18));return qe(o,n)}function Kt(e){const t=e.state||{},s=Ut({state:t,months:e.months});if(!s.length)return[];const o=(Array.isArray(t.products)?t.products:[]).map(r=>r).filter(r=>ne(r.sku)).filter(St),n=new Map;o.forEach(r=>{n.set(fe(r.sku),r)});const i=new Map;(Array.isArray(t.suppliers)?t.suppliers:[]).map(r=>r).forEach(r=>{const y=String(r.id||"").trim();y&&i.set(y,r)});const u=t.settings&&typeof t.settings=="object"?t.settings:{},f=Ge(t),h=Pt(t,s),c=[];h.forEach(r=>{const y=ne(r.sku);if(!y)return;const M=fe(y),p=n.get(M)||null,S=String((p==null?void 0:p.supplierId)||"").trim(),D=i.get(S)||null,k=Tt({state:t,product:p,supplierId:S,settings:u}),C=de(r.requiredArrivalDate)||vt(r.firstRiskMonth);if(!C)return;const b=He({context:f,sku:y,leadTimeDays:k.totalDays,product:p,settings:u,horizonMonths:Math.max(6,s.length),requiredArrivalMonth:r.firstRiskMonth}),T=Ue(b==null?void 0:b.recommendedUnits),F=Ue(r.shortageUnits),N=Math.max(T||0,F||0);if(!(N>0))return;const A=Xe({targetDeliveryDate:C,productionLeadTimeDays:k.productionDays,logisticsLeadTimeDays:k.transitDays,bufferDays:0}),a=At(p),K=Rt(p),L=bt(K*N),z=O(u.fxRate)??0,V=Ye({supplierTerms:Ft(D),schedule:A,unitPrice:a,units:N,currency:"USD",freight:L,freightCurrency:"EUR",dutyRatePct:k.dutyRatePct,eustRatePct:k.eustRatePct,fxRate:z,incoterm:k.incoterm,vatRefundLagMonths:u.vatRefundLagMonths,paymentDueDefaults:u.paymentDueDefaults,existingPayments:[]}),$=Dt(r),x=Mt(r);c.push({id:$,sku:y,alias:String(r.alias||(p==null?void 0:p.alias)||y),abcClass:r.abcClass,supplierId:S,orderMonth:String(r.orderMonth||"").trim(),firstRiskMonth:String(r.firstRiskMonth||"").trim(),latestOrderDate:de(r.latestOrderDate)||A.orderDate||"",requiredArrivalDate:C,recommendedOrderDate:de(r.recommendedOrderDate)||A.orderDate||"",leadTimeDays:k.totalDays,overdue:r.overdue===!0,suggestedUnits:N,shortageUnits:F??null,recommendationStatus:b?String(b.status||""):null,recommendationUnits:T??null,foRecord:{id:$,foNo:x,foNumber:x,sku:y,supplierId:S,targetDeliveryDate:C,units:N,transportMode:k.transportMode,incoterm:k.incoterm,unitPrice:a,currency:"USD",freight:L,freightCurrency:"EUR",dutyRatePct:k.dutyRatePct,eustRatePct:k.eustRatePct,fxRate:z,productionLeadTimeDays:k.productionDays,logisticsLeadTimeDays:k.transitDays,bufferDays:0,orderDate:A.orderDate||null,productionEndDate:A.productionEndDate||null,etdDate:A.etdDate||null,etaDate:A.etaDate||C,deliveryDate:A.deliveryDate||C,payments:V,status:"ACTIVE",phantom:!0,phantomSource:pt,phantomStatus:"suggested",phantomGeneratedAt:new Date().toISOString(),phantomMeta:{firstRiskMonth:r.firstRiskMonth,orderMonth:r.orderMonth,latestOrderDate:r.latestOrderDate,recommendedOrderDate:r.recommendedOrderDate,leadTimeDays:k.totalDays,abcClass:r.abcClass,shortageUnits:r.shortageUnits,reason:r.reason}}})}),c.sort(Nt);const l=U(e.maxSuggestions);return l!=null?c.slice(0,l):c}function Lt(e){const t=e.state||{},s=Array.isArray(t.fos)?t.fos:[],o=new Set(s.map(i=>String(i.id||"").trim()).filter(Boolean)),n=e.suggestions.map(i=>i.foRecord).filter(i=>{const u=String(i.id||"").trim();return u?!o.has(u):!1});return{...t,fos:[...s,...n]}}export{Kt as a,kt as b,Lt as c,Ot as r};
