import{t as r,k as t,S as ne,N as oe,M as w,I as K,J as le,U as se,V as G}from"./index-BAXFY6Sx.js";import{E as T}from"./index-C8Y02GVI.js";import{c as ie}from"./cashflow-IGITWurX.js";import{T as re}from"./TanStackGrid-B1ufKKMU.js";import{b as ce}from"./dashboardMaturity-C11ENgBs.js";import{c as ue,b as _,f as k}from"./months-DiLwPhVv.js";import{u as me,C as p}from"./workspace-U3XTpCZs.js";import{S as de}from"./index-JSAUgCOY.js";import{S as z}from"./index-BFbRrIN8.js";import{F as he}from"./Table-Duo5ddtA.js";import"./planProducts-CGSHsSOQ.js";import"./cashInRules-r9rlv23d.js";import"./Dropdown-BBd0NFNE.js";import"./DownOutlined-BlEEEBb_.js";import"./index-CMZUhGsA.js";import"./useBubbleLock-BgZAw-8N.js";import"./index-DJcsQHAB.js";import"./Pagination-CQKn-8_x.js";const{Paragraph:P,Text:N,Title:S}=le,Q=[{value:"last6",label:"Letzte 6 Monate",count:6},{value:"last12",label:"Letzte 12 Monate",count:12},{value:"all",label:"Alle Monate",count:null}],ge={inflow:"Einzahlungen",po_fo:"PO/FO",fixcost:"Fixkosten",tax:"Steuern & Import",outflow:"Auszahlungen",other:"Sonstige"};function s(i){const l=Number(i);return Number.isFinite(l)?l:null}function D(i){return Math.round(i*100)/100}function m(i){const l=Number(i);return Number.isFinite(l)?l.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function L(i){const l=Number(i);return Number.isFinite(l)?l<0?`−${m(Math.abs(l))}`:m(l):"—"}function U(i){const l=Number(i);return Number.isFinite(l)?`${l.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"—"}function V(i,l){return!Number.isFinite(i)||!Number.isFinite(l)||Number(l)===0?null:Number(i)/Number(l)*100}function O(i,l,f){const d=i.filter(c=>!c.provisional).map(c=>{const h=l(c),x=f(c);return!Number.isFinite(h)||!Number.isFinite(x)||!h?null:Math.abs((Number(x)-Number(h))/Number(h))*100}).filter(c=>Number.isFinite(c));if(!d.length)return{accuracyPct:null,mapePct:null,sampleCount:0};const v=d.reduce((c,h)=>c+h,0)/d.length;return{accuracyPct:Math.max(0,100-v),mapePct:v,sampleCount:d.length}}function pe(i,l){const f=s(i.plannedRevenue)||0,d=s(i.actualRevenue)||0,v=s(i.payoutDelta)||0,c=s(i.closingDelta)||0,h=s(l==null?void 0:l.closingDelta)||0,x=c-h,y=(s(i.plannedPayoutRatePct)||0)/100,A=(s(i.actualPayoutRatePct)||0)/100;let M=v,g=0;Number.isFinite(f)&&Number.isFinite(d)&&Number.isFinite(y)&&Number.isFinite(A)&&(M=(d-f)*y,g=d*(A-y));const o=x-v;return[{key:"rev_effect",label:"Umsatz-Effekt (auf Payout)",amount:D(M),kind:"component"},{key:"payout_effect",label:"Payout-Quote-Effekt",amount:D(g),kind:"component"},{key:"residual",label:"Sonstige Effekte (Kosten/Timing)",amount:D(o),kind:"component"},{key:"total",label:"Delta Kontostand (Monats-Effekt)",amount:D(x),kind:"total"}]}function Fe(){const{state:i,loading:l,error:f}=me(),[d,v]=r.useState("last12"),[c,h]=r.useState(""),x=i,y=r.useMemo(()=>ie(x),[x]),A=ue(),M=_(A),g=r.useMemo(()=>(Array.isArray(y.actualComparisons)?y.actualComparisons:[]).map(a=>{const n=String(a.month||"").trim(),j=_(n),Y=j!=null&&M!=null&&j>=M,ee=V(s(a.plannedPayout),s(a.plannedRevenue)),te=V(s(a.actualPayout),s(a.actualRevenue)),F=s(a.plannedClosing),B=s(a.actualClosing),ae=Number.isFinite(F)&&F&&Number.isFinite(B)?(Number(B)-Number(F))/Number(F)*100:null;return{...a,month:n,provisional:Y,plannedPayoutRatePct:ee,actualPayoutRatePct:te,closingDeltaPct:ae}}).filter(a=>a.month).sort((a,n)=>a.month.localeCompare(n.month)),[M,y.actualComparisons]),o=r.useMemo(()=>{const e=Q.find(a=>a.value===d);return!e||e.count==null?g:g.slice(-e.count)},[d,g]);r.useEffect(()=>{if(!o.length){h("");return}const e=new Set(o.map(a=>a.month));(!c||!e.has(c))&&h(o[o.length-1].month)},[c,o]);const u=r.useMemo(()=>o.find(e=>e.month===c)||o[o.length-1]||null,[c,o]),$=r.useMemo(()=>{if(!u)return null;const e=g.findIndex(a=>a.month===u.month);return e<=0?null:g[e-1]||null},[g,u]),b=r.useMemo(()=>o.filter(e=>!e.provisional),[o]),I=r.useMemo(()=>O(b,e=>s(e.plannedClosing),e=>s(e.actualClosing)),[b]),C=r.useMemo(()=>O(b,e=>s(e.plannedRevenue),e=>s(e.actualRevenue)),[b]),E=r.useMemo(()=>O(b,e=>s(e.plannedPayout),e=>s(e.actualPayout)),[b]),R=r.useMemo(()=>u?pe(u,$):[],[$,u]),W=r.useMemo(()=>ce({breakdown:Array.isArray(y.breakdown)?y.breakdown:[],state:x}),[y.breakdown,x]),Z=r.useMemo(()=>{if(!u)return[];const e=W.get(u.month)||[],a=new Map;return e.forEach(n=>{a.set(n.group,(a.get(n.group)||0)+Number(n.amount||0))}),Array.from(a.entries()).map(([n,j])=>({key:n,label:ge[n]||n,amount:D(j)})).sort((n,j)=>Math.abs(j.amount)-Math.abs(n.amount))},[W,u]),J=r.useMemo(()=>{const e=o.findIndex(n=>n.provisional),a=o.map(n=>k(n.month));return{tooltip:{trigger:"axis",valueFormatter:n=>m(n)},legend:{top:0},grid:{left:54,right:26,top:44,bottom:26},xAxis:{type:"category",data:a},yAxis:{type:"value",axisLabel:{formatter:n=>m(n)}},series:[{name:"Delta Kontostand",type:"bar",data:o.map(n=>Number(n.closingDelta||0)),itemStyle:{color:n=>e>=0&&n.dataIndex>=e?"rgba(245, 158, 11, 0.65)":n.value<0?"#dc2626":"#16a34a"}},{name:"Kontostand Soll",type:"line",smooth:!0,data:o.map(n=>s(n.plannedClosing)),lineStyle:{width:2,type:"dashed",color:"#0f172a"},itemStyle:{color:"#0f172a"}},{name:"Kontostand Ist",type:"line",smooth:!0,data:o.map(n=>s(n.actualClosing)),lineStyle:{width:2,color:"#0ea5e9"},itemStyle:{color:"#0ea5e9"},markArea:e>=0?{itemStyle:{color:"rgba(251, 191, 36, 0.12)"},data:[[{xAxis:a[e]},{xAxis:a[a.length-1]}]]}:void 0}]}},[o]),q=r.useMemo(()=>({tooltip:{trigger:"axis"},legend:{top:0},grid:{left:54,right:52,top:44,bottom:26},xAxis:{type:"category",data:o.map(e=>k(e.month))},yAxis:[{type:"value",name:"EUR",axisLabel:{formatter:e=>m(e)}},{type:"value",name:"%",min:0,max:100,axisLabel:{formatter:e=>`${e.toLocaleString("de-DE",{maximumFractionDigits:0})} %`}}],series:[{name:"Umsatz Soll",type:"bar",data:o.map(e=>s(e.plannedRevenue)),itemStyle:{color:"#94a3b8"}},{name:"Umsatz Ist",type:"bar",data:o.map(e=>s(e.actualRevenue)),itemStyle:{color:"#0ea5e9"}},{name:"Payout-Quote Soll",type:"line",yAxisIndex:1,smooth:!0,data:o.map(e=>s(e.plannedPayoutRatePct)),lineStyle:{width:2,type:"dashed",color:"#64748b"},itemStyle:{color:"#64748b"}},{name:"Payout-Quote Ist",type:"line",yAxisIndex:1,smooth:!0,data:o.map(e=>s(e.actualPayoutRatePct)),lineStyle:{width:2,color:"#f97316"},itemStyle:{color:"#f97316"}}]}),[o]),H=r.useMemo(()=>({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},valueFormatter:e=>m(e)},grid:{left:54,right:20,top:18,bottom:48},xAxis:{type:"category",data:R.map(e=>e.label),axisLabel:{interval:0,rotate:20}},yAxis:{type:"value",axisLabel:{formatter:e=>m(e)}},series:[{type:"bar",data:R.map(e=>e.amount),itemStyle:{color:e=>{const a=R[e.dataIndex];return(a==null?void 0:a.kind)==="total"?"#0f172a":e.value<0?"#dc2626":"#16a34a"}}}]}),[R]),X=r.useMemo(()=>[{header:"Monat",accessorKey:"month",meta:{minWidth:150},cell:({row:e})=>t.jsxs(ne,{size:6,children:[t.jsx(oe,{size:"small",type:c===e.original.month?"primary":"default",onClick:()=>h(e.original.month),children:k(e.original.month)}),e.original.provisional?t.jsx(w,{color:"gold",children:"Vorlaeufig"}):t.jsx(w,{color:"green",children:"Abgeschlossen"})]})},{header:"Kontostand Soll",meta:{align:"right",width:150},cell:({row:e})=>m(e.original.plannedClosing)},{header:"Kontostand Ist",meta:{align:"right",width:150},cell:({row:e})=>m(e.original.actualClosing)},{header:"Delta Kontostand",meta:{align:"right",width:150},cell:({row:e})=>t.jsx("span",{className:Number(e.original.closingDelta||0)<0?"v2-negative":void 0,children:L(e.original.closingDelta)})},{header:"Umsatz Soll",meta:{align:"right",width:140},cell:({row:e})=>m(e.original.plannedRevenue)},{header:"Umsatz Ist",meta:{align:"right",width:140},cell:({row:e})=>m(e.original.actualRevenue)},{header:"Payout Soll",meta:{align:"right",width:140},cell:({row:e})=>m(e.original.plannedPayout)},{header:"Payout Ist",meta:{align:"right",width:140},cell:({row:e})=>m(e.original.actualPayout)}],[c]);return l?t.jsx("div",{className:"v2-page",children:t.jsx(K,{type:"info",showIcon:!0,message:"Workspace wird geladen..."})}):f?t.jsx("div",{className:"v2-page",children:t.jsx(K,{type:"error",showIcon:!0,message:f})}):g.length?t.jsxs("div",{className:"v2-page",children:[t.jsxs(p,{className:"v2-intro-card",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsx(S,{level:3,children:"Soll vs. Ist"}),t.jsx(P,{children:"Wie gut war die Planung gegen die real eingetretenen Werte. Fokus: Kontostand, Umsatz und Payout."})]}),t.jsxs("div",{className:"v2-toolbar-field",children:[t.jsx(N,{children:"Zeitraum"}),t.jsx(de,{value:d,onChange:e=>v(e),options:Q.map(e=>({value:e.value,label:e.label})),style:{width:220,maxWidth:"100%"}})]})]}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(w,{color:"green",children:["Monate mit Istwerten: ",g.length]}),t.jsxs(w,{color:"blue",children:["Im Vergleich (abgeschlossen): ",b.length]}),t.jsx(w,{color:"gold",children:'Laufender Monat wird als "vorlaeufig" markiert'})]})})]}),t.jsxs("div",{className:"v2-svi-kpi-grid",children:[t.jsxs(p,{children:[t.jsx(z,{title:"Treffsicherheit Kontostand",value:I.accuracyPct!=null?`${I.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(N,{type:"secondary",children:["MAPE: ",U(I.mapePct)," · n=",I.sampleCount]})]}),t.jsxs(p,{children:[t.jsx(z,{title:"Treffsicherheit Umsatz",value:C.accuracyPct!=null?`${C.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(N,{type:"secondary",children:["MAPE: ",U(C.mapePct)," · n=",C.sampleCount]})]}),t.jsxs(p,{children:[t.jsx(z,{title:"Treffsicherheit Payout",value:E.accuracyPct!=null?`${E.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(N,{type:"secondary",children:["MAPE: ",U(E.mapePct)," · n=",E.sampleCount]})]}),t.jsxs(p,{children:[t.jsx(z,{title:"Aktueller Delta-Kontostand",value:u?L(u.closingDelta):"—"}),t.jsx(N,{type:"secondary",children:u?`${k(u.month)} ${u.provisional?"(vorlaeufig)":"(abgeschlossen)"}`:"Kein Monat gewählt"})]})]}),t.jsxs(p,{children:[t.jsx(S,{level:4,children:"Kontostand Soll vs. Ist"}),t.jsx(P,{type:"secondary",children:"Linien zeigen Soll/Ist-Kontostand, Balken darunter die Abweichung (Ist minus Soll) pro Monat."}),t.jsx(T,{style:{height:380},option:J})]}),t.jsxs(se,{gutter:[12,12],children:[t.jsx(G,{xs:24,xl:14,children:t.jsxs(p,{children:[t.jsx(S,{level:4,children:"Umsatz & Payout-Quote"}),t.jsx(P,{type:"secondary",children:"Umsatz in EUR als Balken, Payout-Quote als Linien (Soll vs. Ist)."}),t.jsx(T,{style:{height:340},option:q})]})}),t.jsx(G,{xs:24,xl:10,children:t.jsxs(p,{children:[t.jsxs(S,{level:4,children:["Treiber Monat ",u?k(u.month):"—"]}),t.jsx(P,{type:"secondary",children:"Zerlegung des Monats-Effekts auf den Kontostand in Umsatz-/Payout-Effekt und Residuum."}),t.jsx(T,{style:{height:260},option:H}),t.jsx("div",{className:"v2-svi-driver-list",children:R.map(e=>t.jsxs("div",{className:`v2-svi-driver-row ${e.kind==="total"?"is-total":""}`,children:[t.jsx(N,{children:e.label}),t.jsx(N,{className:e.amount<0?"v2-negative":void 0,children:L(e.amount)})]},e.key))})]})})]}),t.jsxs(p,{children:[t.jsx(S,{level:4,children:"Monatsvergleich"}),t.jsx(P,{type:"secondary",children:"Monat anklicken, um den Treiber- und Detailbereich zu aktualisieren."}),t.jsx(re,{data:o,columns:X,minTableWidth:1240,tableLayout:"auto"})]}),t.jsxs(p,{children:[t.jsxs(S,{level:4,children:["Plan-Detail (Auszahlungen) für ",u?k(u.month):"—"]}),t.jsx(P,{type:"secondary",children:"Geplante Auszahlungsstruktur im ausgewählten Monat als Kontext für die Soll-vs-Ist-Differenz."}),t.jsx(he,{size:"small",pagination:!1,rowKey:"key",dataSource:Z,columns:[{title:"Gruppe",dataIndex:"label",key:"label",sorter:(e,a)=>String(e.label||"").localeCompare(String(a.label||""),"de-DE")},{title:"Planbetrag",dataIndex:"amount",key:"amount",align:"right",sorter:(e,a)=>Number(e.amount||0)-Number(a.amount||0),render:e=>t.jsx("span",{className:e<0?"v2-negative":void 0,children:L(e)})}],locale:{emptyText:"Keine geplanten Positionen im ausgewählten Monat."}})]})]}):t.jsxs("div",{className:"v2-page",children:[t.jsx(p,{className:"v2-intro-card",children:t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(S,{level:3,children:"Soll vs. Ist"}),t.jsx(P,{children:"Analyse von Planwerten gegen eingetretene Ist-Werte (Kontostand, Umsatz und Payout)."})]})})}),t.jsx(K,{type:"warning",showIcon:!0,message:"Noch keine Ist-Daten vorhanden",description:"Bitte zuerst Monats-Istwerte in 'Abschluss > Eingaben' pflegen."})]})}export{Fe as default};
