import{T as Ge,U as _n,V as On,l as Lt,u as Fn,W as Bn,g as at,h as Kn,w as sn,x as an,D as xt,s as rn,t as rt,O as b,X as Gn,y as ln,Y as $n,Z as ne,E as lt,_ as Y,G as on,$ as cn,a0 as qn,a1 as Vn,a2 as zn}from"./index-Q77JbDRq.js";import{b as Wn}from"./supplierLabels-BolgyxWX.js";import{b as jn}from"./abcClassification-CRpkNsmW.js";function Dt({title:a,children:m,placement:V="topLeft"}){return a?Ge.jsx(_n,{title:a,placement:V,mouseEnterDelay:.15,children:m}):m}function Hn(a){if(a==null||a==="")return"—";const m=typeof a=="string"||typeof a=="number"?String(a):a;return typeof m!="string"?m:Ge.jsx(Dt,{title:m,children:Ge.jsx("span",{className:"app-table-ellipsis",children:m})})}function Xn({columns:a,dataSource:m,rowKey:V="id",stickyFirstColumn:D=!1,scrollY:U,className:K,...x}){const ge=(a||[]).map((X,Ce)=>{const Z={...X};if(X.tooltip){const Ne=X.title??X.label??"";Z.title=Ge.jsx(Dt,{title:X.tooltip,children:Ge.jsx("span",{children:Ne})})}if(X.numeric&&!Z.align&&(Z.align="right"),D&&Ce===0&&!Z.fixed&&(Z.fixed="left"),X.ellipsis!==!1){const Ne=X.render;Z.ellipsis={showTitle:!1},Z.render=(ot,Oe,Xe)=>{const Rt=Ne?Ne(ot,Oe,Xe):ot;return Hn(Rt)}}return Z}),he={x:"max-content",...U?{y:U}:{}};return Ge.jsx(On,{className:K,size:"middle",pagination:!1,sticky:!0,rowKey:V,columns:ge,dataSource:m||[],scroll:he,...x})}function je(a,m=document){return m.querySelector(a)}function e(a,m={},V=[]){const D=document.createElement(a);Object.entries(m).forEach(([U,K])=>{U==="class"?D.className=K:U.startsWith("on")&&typeof K=="function"?D.addEventListener(U.slice(2),K):U==="dataset"&&K&&typeof K=="object"?Object.entries(K).forEach(([x,ge])=>D.dataset[x]=ge):K!=null&&D.setAttribute(U,K)});for(const U of Array.isArray(V)?V:[V])U!=null&&D.append(U.nodeType?U:document.createTextNode(String(U)));return D}function fn(a){if(!a)return"—";const[m,V,D]=a.split("-").map(Number);if(!m||!V||!D)return"—";const U=new Date(Date.UTC(m,V-1,D));return Number.isNaN(U.getTime())?"—":U.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function bn(a){const m=b(a);return m==null?"—":m.toLocaleString("de-DE",{style:"currency",currency:"USD"})}function Zn(a){const m=b(a);return m==null?"—":m.toLocaleString("de-DE",{style:"currency",currency:"EUR"})}const Pt=["A","B","C"],Jn={A:0,B:1,C:2};function Ut(a){const m=String(a||"").trim().toUpperCase();return Pt.includes(m)?m:null}function it(a){return Ut(a)||"—"}function un(a){const m=Ut(a);return m?Jn[m]:Pt.length}function $(a,m=2){return Y(a,m,{emptyValue:"",useGrouping:!1})}function dn(a){if(!a.length)return"";const V=a.map(D=>D.field).map(D=>{switch(D){case"alias":return"Alias";case"currency":return"Currency";case"unitPrice":return"Unit Price";case"avgSellingPriceGrossEUR":return"Ø VK-Preis";case"sellerboardMarginPct":return"Sellerboard Marge";case"ddp":return"DDP";default:return D}});return`Fehlt: ${[...new Set(V)].join(", ")}`}function Ke(a){let m=document.getElementById("products-toast");m||(m=document.createElement("div"),m.id="products-toast",m.className="po-toast",document.body.appendChild(m)),m.textContent=a,m.hidden=!1,setTimeout(()=>{m.hidden=!0},2e3)}function pn({title:a,content:m,actions:V=[],onClose:D}){const U=e("div",{class:"po-modal-backdrop"}),K=e("div",{class:"po-modal product-modal-frame"}),x=e("div",{class:"po-modal-header"},[e("h3",{},[a]),e("button",{type:"button",class:"btn tertiary",onclick:()=>{if(typeof D=="function"){D();return}document.body.removeChild(U),document.removeEventListener("keydown",Ce)},"aria-label":"Schließen"},["✕"])]),ge=e("div",{class:"po-modal-body"},[m]),he=e("div",{class:"po-modal-actions"});V.forEach(Z=>he.append(Z)),K.append(x,ge,he),U.append(K);let X=!1;U.addEventListener("mousedown",Z=>{X=Z.target===U}),U.addEventListener("mouseup",Z=>{X&&Z.target===U&&(typeof D=="function"?D():(document.body.removeChild(U),document.removeEventListener("keydown",Ce))),X=!1});function Ce(Z){if(Z.key==="Escape"){if(typeof D=="function"){D();return}document.body.removeChild(U),document.removeEventListener("keydown",Ce)}}return document.addEventListener("keydown",Ce),document.body.append(U),{overlay:U,modal:K,body:ge,footer:he}}function mn(a,m){const V=(a.pos||[]).filter(x=>((x==null?void 0:x.sku)||"").trim().toLowerCase()===String(m||"").trim().toLowerCase()).sort((x,ge)=>(ge.orderDate||"").localeCompare(x.orderDate||"")).slice(0,10);if(!V.length)return e("p",{class:"empty-state"},["Keine Bestellhistorie verfügbar."]);const D=e("table",{class:"table","data-ui-table":"true"}),U=e("thead",{},[e("tr",{},[e("th",{},["PO-Nr."]),e("th",{},["Bestelldatum"]),e("th",{},["Stückzahl"]),e("th",{},["Stückpreis (USD)"]),e("th",{},["Produktionstage"]),e("th",{},["Transit"]),e("th",{},["Transport"]),e("th",{},["Fracht (€)"]),e("th",{},["Zoll %"]),e("th",{},["EUSt %"]),e("th",{},["FX-Fee %"])])]),K=e("tbody");return V.forEach(x=>{K.append(e("tr",{},[e("td",{},[x.poNumber||x.number||"—"]),e("td",{},[fn(x.orderDate)]),e("td",{},[x.units!=null?Y(b(x.units),0):"—"]),e("td",{},[bn(x.unitCostUsd)]),e("td",{},[Number.isFinite(Number(x.prodDays))?String(x.prodDays):"—"]),e("td",{},[Number.isFinite(Number(x.transitDays))?String(x.transitDays):"—"]),e("td",{},[x.transport||"—"]),e("td",{},[Zn(x.freightEur)]),e("td",{},[x.dutyRatePct!=null?Y(b(x.dutyRatePct),2):"—"]),e("td",{},[x.eustRatePct!=null?Y(b(x.eustRatePct),2):"—"]),e("td",{},[x.fxFeePct!=null?Y(b(x.fxFeePct),2):"—"])]))}),D.append(U,K),D}function He(a){const m=Lt(),V=jn(m),D=Fn().map(n=>{const c=String((n==null?void 0:n.sku)||"").trim().toLowerCase(),u=c?V.bySku.get(c):null;return{...n,abcClass:(u==null?void 0:u.abcClass)??null,abcMeta:u||null}}),U=Bn(D,m.settings||{}),K=new Map;U.forEach(n=>{const c=String(n.entityId||"").trim();c&&(K.has(c)||K.set(c,[]),K.get(c).push(n))});const x=Array.isArray(m.productCategories)?m.productCategories:[],ge=new Map(x.map(n=>[String(n.id),n])),he=Wn(m,D);let X="";const Ce="productsCompletenessView";let Ue=at(Ce,{filter:"all"}).filter||"all";const Ne="productsAbcFilter";let Oe=at(Ne,{filter:"all"}).filter||"all";const Xe="productsTableSort";let Ze=at(Xe,{mode:"category"}).mode||"category";Ue==="ready"&&(Ue="ok");let oe=Kn("productsView");oe!=="table"&&oe!=="list"&&(oe="list");const ye=a.__productsBulkDraft||sn({},{key:"products:bulk",enableDraftCache:!0});a.__productsBulkDraft=ye;const Le=ye.draft;a.__productsBulkGuard&&(a.__productsBulkGuard.unregister(),a.__productsBulkGuard.detachBeforeUnload());const ct=an(()=>ye.isDirty,"Ungespeicherte Änderungen verwerfen?");a.__productsBulkGuard=ct,ct.register(),ct.attachBeforeUnload();const Mt="productsCategoryCollapse",Tt=sessionStorage.getItem("healthFocus");if(Tt){try{const n=JSON.parse(Tt);(n==null?void 0:n.tab)==="produkte"&&n.sku&&(X=String(n.sku))}catch{}sessionStorage.removeItem("healthFocus")}const ut=ye.loadDraftIfAvailable();!a.__bulkDraftPrompted&&(ut!=null&&ut.exists)&&Object.keys(Le).length===0&&(a.__bulkDraftPrompted=!0,xt({title:"Entwurf gefunden",message:"Es gibt ungespeicherte Tabellenänderungen. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{ye.restoreDraft(),ae()},onCancel:()=>{ye.discardDraft()}}));function gn(n){const c=K.get(n)||[];if(!c.length)return null;const u=dn(c);return e("button",{class:"data-health-dot",type:"button",title:u,"aria-label":u,onclick:l=>{l.stopPropagation(),cn({scope:"product",entityId:n})}})}const dt=new Map,hn={state:m};function Je(n){return n!=null&&n.sku?(dt.has(n.sku)||dt.set(n.sku,lt(n,hn)),dt.get(n.sku)):lt(n,{state:m})}function It(n){var v;const c=b((v=m==null?void 0:m.settings)==null?void 0:v.moqDefaultUnits),u=b(n==null?void 0:n.moqOverrideUnits);if(u!=null&&u>0)return Math.round(u);const l=b(n==null?void 0:n.moqUnits);return l!=null&&l>0?Math.round(l):c!=null&&c>0?Math.round(c):null}function yn(n,c,u,l){const v=c?n.filter(g=>{const _=c.trim().toLowerCase(),p=Ft(g.categoryId),o=he.get(g.supplierId);return[g.alias,g.sku,g.supplierId,o,p].filter(Boolean).some(r=>String(r).toLowerCase().includes(_))}):n,k=!l||l==="all"?v:v.filter(g=>Ut(g.abcClass)===l);if(!u||u==="all")return k;const d=u==="ready"?"ok":u==="warning"?"warn":u;return k.filter(g=>Je(g).status===d)}function Nt(n){return n==="ok"?"OK":n==="warn"?"WARN":"BLOCKED"}function Fe(n,c=3){const u=(n||[]).map(k=>k.label).filter(Boolean);if(!u.length)return"";const l=u.slice(0,c),v=u.length-l.length;return`${l.join(", ")}${v>0?` +${v} weitere`:""}`}function vn(n){const c=[],u=Fe(n.blockingMissing),l=Fe(n.defaulted),v=Fe(n.suggestedMissing);u&&c.push(`Fehlt: ${u}`);const k=[];return l&&k.push(`Standardwert: ${l}`),v&&k.push(`Empfohlen: ${v}`),k.length&&c.push(k.join(" · ")),c.length||c.push("Alle Pflichtfelder vorhanden."),c.slice(0,2).map(d=>e("div",{},[d]))}function pt(){let n=document.getElementById("products-completeness-tooltip");return n||(n=e("div",{id:"products-completeness-tooltip",class:"portal-tooltip",role:"tooltip",hidden:!0}),document.body.appendChild(n)),n}function kn(n,c,{delay:u=150}={}){let l=null,v=!1,k=null;function d(){const r=pt(),C=n.getBoundingClientRect(),T=r.getBoundingClientRect(),G=8;let R=C.left,j=C.bottom+8;const re=window.innerWidth-T.width-G;R>re&&(R=re),R<G&&(R=G),j+T.height>window.innerHeight-G&&(j=C.top-T.height-8),j<G&&(j=G),r.style.left=`${R}px`,r.style.top=`${j}px`}function g(){if(v)return;v=!0;const r=pt();r.innerHTML="",r.append(...c()),r.hidden=!1,r.classList.add("is-visible"),n.setAttribute("aria-describedby",r.id),requestAnimationFrame(d);const C=()=>d(),T=()=>d();window.addEventListener("scroll",C,!0),window.addEventListener("resize",T),k=()=>{window.removeEventListener("scroll",C,!0),window.removeEventListener("resize",T)}}function _(){if(clearTimeout(l),!v)return;v=!1;const r=pt();r.hidden=!0,r.classList.remove("is-visible"),r.innerHTML="",k&&k(),k=null}function p(){clearTimeout(l),l=setTimeout(g,u)}function o(){_()}n.addEventListener("mouseenter",p),n.addEventListener("focus",p),n.addEventListener("mouseleave",o),n.addEventListener("blur",o)}function Sn(n){const c=Je(n),u=c.status||"blocked",l=Nt(u),v=e("button",{class:`tooltip-trigger completeness-badge ${u}`,type:"button","aria-label":l,onclick:k=>{var d;k.stopPropagation(),u==="blocked"&&((d=c.blockingMissing)!=null&&d.length)&&$e(n,{focusFieldKey:c.blockingMissing[0].fieldKey})}},[l]);return kn(v,()=>vn(c)),v}function En(n){const c=Je(n),u=c.status||"blocked",l=Nt(u),v=[Fe(c.blockingMissing),Fe(c.defaulted),Fe(c.suggestedMissing)].filter(Boolean).join(" · ")||"Alle Pflichtfelder vorhanden.",k=ne.createElement("button",{className:`tooltip-trigger completeness-badge ${u}`,type:"button",onClick:d=>{var g;d.stopPropagation(),u==="blocked"&&((g=c.blockingMissing)!=null&&g.length)&&$e(n,{focusFieldKey:c.blockingMissing[0].fieldKey})}},l);return ne.createElement(Dt,{title:v},k)}function wn(n){const c=K.get(n)||[];if(!c.length)return null;const u=dn(c);return ne.createElement("button",{className:"data-health-dot",type:"button","aria-label":u,onClick:l=>{l.stopPropagation(),cn({scope:"product",entityId:n})}})}a.__productsActionsCleanup&&a.__productsActionsCleanup();let pe=null,ve=null;function Re(){ve&&ve.setAttribute("aria-expanded","false"),pe&&pe.remove(),pe=null,ve=null}function mt(){if(!pe||!ve)return;const n=ve.getBoundingClientRect(),c=pe.getBoundingClientRect(),u=8,l=window.innerWidth-c.width-u,v=window.innerHeight-c.height-u;let k=n.right-c.width,d=n.bottom+6;k=Math.min(l,k),k=Math.max(u,k),d>v&&(d=n.top-c.height-6),d=Math.max(u,d),pe.style.left=`${k}px`,pe.style.top=`${d}px`}function Cn(n,c){if(!n||!c)return;if(ve===n){Re();return}Re();const u=e("div",{class:"product-actions-menu",role:"menu"}),l=e("button",{class:"product-actions-menu-item",type:"button",onclick:d=>{d.stopPropagation(),Kt(c),Re()}},["Historie"]),v=e("button",{class:"product-actions-menu-item",type:"button",onclick:d=>{d.stopPropagation(),Vn(c.sku,c.status==="inactive"?"active":"inactive"),Re(),He(a)}},[c.status==="inactive"?"Aktiv setzen":"Inaktiv setzen"]),k=e("button",{class:"product-actions-menu-item danger",type:"button",onclick:d=>{d.stopPropagation(),confirm("Produkt wirklich löschen?")&&(zn(c.sku),Re(),He(a))}},["Löschen"]);u.append(l,v,k),document.body.appendChild(u),pe=u,ve=n,ve.setAttribute("aria-expanded","true"),mt(),requestAnimationFrame(mt)}function At(n){pe&&(pe.contains(n.target)||ve&&ve.contains(n.target)||Re())}function _t(){mt()}function Ot(){pe&&Re()}document.addEventListener("click",At),window.addEventListener("resize",_t),window.addEventListener("scroll",Ot,!0),a.__productsActionsCleanup=()=>{Re(),document.removeEventListener("click",At),window.removeEventListener("resize",_t),window.removeEventListener("scroll",Ot,!0)};function Ft(n){if(!n)return"Ohne Kategorie";const c=ge.get(String(n));return(c==null?void 0:c.name)||"Ohne Kategorie"}function Qe(){return at(Mt,{})}function ft(n){rt(Mt,n)}function Bt(n){const c={};bt(D).forEach(l=>{c[l.id]=n}),ft(c)}function bt(n,{sortMode:c}={}){const u=new Map;n.forEach(d=>{const g=d.categoryId?String(d.categoryId):"";u.has(g)||u.set(g,[]),u.get(g).push(d)}),c==="abc"&&u.forEach(d=>{d.sort((g,_)=>{const p=un(g.abcClass)-un(_.abcClass);return p||String(g.alias||g.sku||"").localeCompare(String(_.alias||_.sku||""))})});const v=x.slice().sort((d,g)=>(d.sortOrder??0)-(g.sortOrder??0)||String(d.name||"").localeCompare(String(g.name||""))).map(d=>({id:String(d.id),name:d.name||"Ohne Kategorie",items:u.get(String(d.id))||[]})),k=u.get("")||[];return k.length&&v.push({id:"uncategorized",name:"Ohne Kategorie",items:k}),v}function $e(n,c={}){var nn;const u=Lt();let l=n?{...n}:{sku:"",alias:"",supplierId:"",status:"active",tags:[],template:null,abcClass:null};const v=sn(l,{key:l.sku?`product:${l.sku}`:"product:new",enableDraftCache:!0});l=v.draft;const k=an(()=>v.isDirty,"Ungespeicherte Änderungen verwerfen?"),d=e("form",{class:"form"}),g=c.focusFieldKey,_=e("input",{value:l.sku||"",required:!0}),p=e("input",{value:l.alias||"",required:!0}),o=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Supplier"])),(u.suppliers||[]).forEach(s=>{const f=he.get(s.id)||s.name||s.id;t.append(e("option",{value:s.id},[f]))}),t.value=l.supplierId||"",t})(),r=e("select",{},[e("option",{value:"active",selected:l.status!=="inactive"},["Aktiv"]),e("option",{value:"inactive",selected:l.status==="inactive"},["Inaktiv"])]),C=e("input",{value:it(l.abcClass),disabled:!0}),T=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Kategorie"])),x.forEach(s=>{t.append(e("option",{value:s.id},[s.name]))}),t.value=l.categoryId||"",t})(),G=e("input",{value:l.avgSellingPriceGrossEUR!=null?$(b(l.avgSellingPriceGrossEUR),2):"",inputmode:"decimal"}),R=e("input",{value:l.sellerboardMarginPct!=null?$(b(l.sellerboardMarginPct),2):"",inputmode:"decimal"}),j=e("input",{value:l.productionLeadTimeDaysDefault!=null?$(b(l.productionLeadTimeDaysDefault),0):"",inputmode:"decimal"}),re=e("input",{value:l.moqUnits!=null?$(b(l.moqUnits),0):"",inputmode:"decimal"}),me=e("input",{value:l.safetyStockDohOverride!=null?$(b(l.safetyStockDohOverride),0):"",inputmode:"decimal"}),F=e("input",{value:l.foCoverageDohOverride!=null?$(b(l.foCoverageDohOverride),0):"",inputmode:"decimal"}),le=e("input",{value:l.moqOverrideUnits!=null?$(b(l.moqOverrideUnits),0):"",inputmode:"decimal"}),ce=e("input",{value:l.landedUnitCostEur!=null?$(b(l.landedUnitCostEur),2):"",inputmode:"decimal"}),ee=(nn=l.template)!=null&&nn.fields?{...l.template.fields}:l.template||{};!ee.transportMode&&ee.transport&&(ee.transportMode=ee.transport);const J=u.settings||{},Me=Number(J.safetyStockDohDefault??60),ke=Number(J.foCoverageDohDefault??90),xe=Number(J.moqDefaultUnits??500),fe=b(J.fxRate)??b(J.fxRate)??null,Se={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,vatImportPct:19,vatRefundLag:0,fxRate:fe,fxFeePct:0,ddp:J.defaultDdp===!0,currency:J.defaultCurrency||"EUR"},De=[{key:"unitPriceUsd",label:"Stückpreis (USD)",valueType:"number",decimals:2},{key:"extraPerUnitUsd",label:"Zusatz je Stück (USD)",valueType:"number",decimals:2},{key:"extraFlatUsd",label:"Zusatz pauschal (USD)",valueType:"number",decimals:2},{key:"transportMode",label:"Transport",type:"select",options:["SEA","RAIL","AIR"]},{key:"productionDays",label:"Produktionstage",valueType:"number",decimals:0},{key:"transitDays",label:"Transit-Tage",valueType:"number",decimals:0},{key:"freightEur",label:"Logistik / Stk. (EUR)",valueType:"number",decimals:2},{key:"dutyPct",label:"Zoll %",valueType:"number",decimals:2},{key:"dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox"},{key:"vatImportPct",label:"EUSt %",valueType:"number",decimals:2},{key:"vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox"},{key:"vatRefundLag",label:"EUSt-Lag (Monate)",valueType:"number",decimals:0},{key:"fxRate",label:"FX-Kurs",valueType:"number",decimals:4},{key:"fxFeePct",label:"FX-Gebühr %",valueType:"number",decimals:2},{key:"currency",label:"Currency",type:"select",options:["USD","EUR","CNY"]},{key:"ddp",label:"DDP",type:"checkbox"}],P=e("div",{class:"table-card-header"},[e("h4",{},["Template-Werte"]),e("button",{class:"btn secondary",type:"button",id:"product-apply-latest"},["Letzte PO Werte übernehmen"])]),M=e("div",{class:"product-completeness-summary",hidden:!0}),I=e("div",{class:"product-completeness-summary-title"}),z=e("div",{class:"product-completeness-summary-list"});M.append(I,z);const te=e("label",{},["SKU",_]),i=e("label",{},["Alias",p]),S=e("label",{},["Supplier",o]),h=e("label",{},["Kategorie",T]),H=e("label",{},["Status",r]),B=e("label",{},["ABC Klassifizierung",C]),w=e("label",{},["Ø VK-Preis (Brutto)",G]),q=e("label",{},["Sellerboard Marge (%)",R]),O=e("label",{},["Default Production Lead Time (Fallback)",j]),ie=e("label",{},["MOQ (Einheiten)",re]),Q=e("label",{},["Safety Stock DOH Override (optional)",me,e("small",{class:"muted",id:"safety-stock-effective"},[])]),A=e("label",{},["FO Coverage DOH Override (optional)",F,e("small",{class:"muted",id:"fo-coverage-effective"},[])]),se=e("label",{},["MOQ Override (optional)",le,e("small",{class:"muted",id:"moq-effective"},[])]),be=e("label",{},["Einstandspreis (EUR)",ce,e("small",{class:"muted",id:"shipping-derived"},[])]);d.append(M,te,i,S,h,H,B,w,q,O,ie,e("hr"),e("h4",{},["Inventory Planning Overrides"]),Q,A,se,be,e("hr"),P),[{input:G,decimals:2},{input:R,decimals:2},{input:j,decimals:0},{input:re,decimals:0},{input:me,decimals:0},{input:F,decimals:0},{input:le,decimals:0},{input:ce,decimals:2}].forEach(({input:t,decimals:s})=>{t.addEventListener("blur",()=>{const f=b(t.value);t.value=f==null?"":$(f,s),Ae()}),t.addEventListener("input",()=>{Ae()})});const Ye=e("div",{class:"grid two"}),Pe={},Gt={},gt={},ht=new Map,$t=new Map,qt="Pflichtfeld – benötigt für PO/FO & Kalkulation",Pn={avgSellingPriceGrossEUR:"Empfohlen für Pricing Analytics.",sellerboardMarginPct:"Empfohlen für Pricing Analytics.",landedUnitCostEur:"Wird verfügbar nach erster PO / kann später gepflegt werden."},yt={unitPriceUsd:{min:0},extraPerUnitUsd:{min:0},extraFlatUsd:{min:0},productionDays:{min:0,integer:!0},transitDays:{min:0,integer:!0},freightEur:{min:0},dutyPct:{min:0,max:100},vatImportPct:{min:0,max:100},vatRefundLag:{min:0,integer:!0},fxRate:{min:1e-4},fxFeePct:{min:0,max:100}};function Ve(t){const s=yt[t];if(!s)return!0;const f=Pe[t],y=Gt[t];if(!f||!y)return!0;const E=String(f.value||"").trim();if(!E){const N=Se[t];return t==="fxRate"&&(N==null||N<=0)?(y.textContent="FX-Kurs ist erforderlich.",!1):(y.textContent="",!0)}const L=b(E);return L==null?(y.textContent="Ungültiger Wert.",!1):s.integer&&!Number.isInteger(L)?(y.textContent="Bitte eine ganze Zahl eingeben.",!1):s.min!=null&&L<s.min?(y.textContent=`Wert muss ≥ ${s.min} sein.`,!1):s.max!=null&&L>s.max?(y.textContent=`Wert muss ≤ ${s.max} sein.`,!1):(y.textContent="",!0)}function Vt(){return Object.keys(yt).every(t=>Ve(t))}function Te(){const t=Vt(),f=(et||wt()).status==="blocked";_e.disabled=!t||!v.isDirty||f}const Un=(()=>{const s=(u.pos||[]).filter(N=>String((N==null?void 0:N.sku)||"").trim().toLowerCase()===String(l.sku||"").trim().toLowerCase()).sort((N,W)=>(W.orderDate||"").localeCompare(N.orderDate||""))[0];if(!s)return"Hinweis: —";const f=b(s.freightPerUnitEur),y=b(s.units),E=b(s.freightEur),L=f??(E!=null&&y?E/y:null);return L==null||!Number.isFinite(L)?"Hinweis: —":`Hinweis: Logistik / Stk. (EUR) aus letzter PO: ${Y(L,2)} €`})();function Ee(t,s,f){if(!s||!f)return;const y=e("small",{class:"field-required-helper",hidden:!0},[qt]);s.append(y),ht.set(t,{input:f,helper:y})}function zt(t,s,f){if(!s||!f)return;const y=e("small",{class:"field-suggested-helper",hidden:!0},[Pn[t]||"Empfohlen."]);s.append(y),$t.set(t,{input:f,helper:y})}function Wt(t){const s=ht.get(t);s&&(s.input.scrollIntoView({behavior:"smooth",block:"center"}),s.input.focus({preventScroll:!0}))}De.forEach(t=>{if(gt[t.key]=t,t.type==="checkbox"){const s=e("input",{type:"checkbox",name:t.key,checked:!!ee[t.key]});Pe[t.key]=s,Ye.append(e("label",{class:"inline-checkbox"},[s," ",t.label]))}else if(t.type==="select"){const s=e("select",{name:t.key});(t.options||[]).forEach(y=>{s.append(e("option",{value:y},[y]))});const f=ee[t.key]??Se[t.key];s.value=f||(t.options?t.options[0]:""),Pe[t.key]=s,Ye.append(e("label",{},[t.label,s]))}else{const s=typeof t.decimals=="number"?t.decimals:2,f=ee[t.key]??Se[t.key],y=b(f),E=y!=null?$(y,s):"",L=e("input",{name:t.key,value:E,inputmode:"decimal"});L.addEventListener("blur",()=>{const de=b(L.value),we=Se[t.key],Ie=de??we;L.value=Ie==null?"":$(Ie,s),Ve(t.key),Te(),t.key==="unitPriceUsd"&&Ae()}),L.addEventListener("input",()=>{Ve(t.key),Te(),t.key==="unitPriceUsd"&&Ae()}),Pe[t.key]=L;const N=e("small",{class:"form-error"},[]);Gt[t.key]=N;const W=e("label",{},[t.label,L,N]);t.key==="freightEur"&&W.append(e("small",{class:"muted"},[Un])),t.key==="unitPriceUsd"&&Ee("unitPriceUsd",W,L),t.key==="transitDays"&&Ee("transitDays",W,L),t.key==="dutyPct"&&Ee("dutyPct",W,L),t.key==="vatImportPct"&&Ee("vatImportPct",W,L),Ye.append(W)}}),d.append(Ye);const jt=je("#safety-stock-effective",d),Ht=je("#fo-coverage-effective",d),Xt=je("#moq-effective",d),ze=je("#shipping-derived",d);function Ae(){var N,W;const t=b(me.value),s=b(F.value),f=b(le.value),y=t??Me,E=s??ke,L=f??xe;if(jt&&(jt.textContent=`Effektiv: ${Y(y,0)} Tage (Default: ${Y(Me,0)})`),Ht&&(Ht.textContent=`Effektiv: ${Y(E,0)} Tage (Default: ${Y(ke,0)})`),Xt&&(Xt.textContent=`Effektiv: ${Y(L,0)} Einheiten (Default: ${Y(xe,0)})`),ze){const de=b((N=Pe.unitPriceUsd)==null?void 0:N.value),we=b(ce.value),Ie=b((W=Pe.fxRate)==null?void 0:W.value)??fe,Be=on({unitPriceUsd:de,landedCostEur:we,fxUsdPerEur:Ie});ze.innerHTML="";const nt=Be.value==null?"Logistik / Stk. (EUR, berechnet): —":`Logistik / Stk. (EUR, berechnet): ${Y(Be.value,2)} €`;ze.append(document.createTextNode(nt));const We=Be.missingFields.map(st=>st==="landedCostEur"?"Einstandspreis (EUR)":st==="unitPriceUsd"?"Stückpreis USD":st==="fxUsdPerEur"?"FX (USD je EUR)":st);ze.append(e("span",{class:"tooltip"},[e("button",{class:"tooltip-trigger",type:"button","aria-label":"Formel"},["ℹ️"]),e("span",{class:"tooltip-content"},["Formel: Einstandspreis (EUR) – (Stückpreis USD ÷ FX). Negative Werte werden auf 0 gesetzt.",We.length?` Fehlend: ${We.join(", ")}.`:""])])),Be.warning&&ze.append(e("span",{class:"badge fo-recommendation-badge"},["Check landed cost / FX"]))}}function ue(t,s){const f=Pe[t];if(!f)return;const y=gt[t]||{};if(f.type==="checkbox"){f.checked=!!s;return}if(f.tagName==="SELECT"){f.value=s!=null?String(s):f.value;return}const E=typeof y.decimals=="number"?y.decimals:2,L=b(s);f.value=L==null?"":$(L,E),Ve(t)}function Rn(){var f;const t=v.draft||{};_.value=t.sku||"",p.value=t.alias||"",o.value=t.supplierId||"",r.value=t.status||"active",T.value=t.categoryId||"",C.value=it(l.abcClass),G.value=t.avgSellingPriceGrossEUR!=null?$(b(t.avgSellingPriceGrossEUR),2):"",R.value=t.sellerboardMarginPct!=null?$(b(t.sellerboardMarginPct),2):"",j.value=t.productionLeadTimeDaysDefault!=null?$(b(t.productionLeadTimeDaysDefault),0):"",re.value=t.moqUnits!=null?$(b(t.moqUnits),0):"",me.value=t.safetyStockDohOverride!=null?$(b(t.safetyStockDohOverride),0):"",F.value=t.foCoverageDohOverride!=null?$(b(t.foCoverageDohOverride),0):"",le.value=t.moqOverrideUnits!=null?$(b(t.moqOverrideUnits),0):"",ce.value=t.landedUnitCostEur!=null?$(b(t.landedUnitCostEur),2):"";const s=(f=t.template)!=null&&f.fields?t.template.fields:t.template||{};Object.keys(Pe).forEach(y=>{ue(y,s[y])}),vt.value=s.milestones?JSON.stringify(s.milestones,null,2):"",Ae(),Ct()}function Mn(){const t=_.value.trim();if(!t){Ke("Bitte zuerst eine SKU angeben.");return}const s=(u.pos||[]).filter(N=>String((N==null?void 0:N.sku)||"").trim().toLowerCase()===t.toLowerCase()).sort((N,W)=>(W.orderDate||"").localeCompare(N.orderDate||""))[0];if(!s){Ke("Keine PO vorhanden.");return}const f=b(s.freightPerUnitEur),y=b(s.units),E=b(s.freightEur),L=f??(E!=null&&y?E/y:null);ue("unitPriceUsd",s.unitCostUsd),ue("freightEur",L),ue("productionDays",s.prodDays),ue("transitDays",s.transitDays),ue("transportMode",String(s.transport||"SEA").toUpperCase()),ue("dutyPct",s.dutyRatePct),ue("vatImportPct",s.eustRatePct),ue("fxRate",s.fxOverride??J.fxRate),ue("fxFeePct",s.fxFeePct),ue("ddp",s.ddp===!0),ue("currency","USD"),Ae(),tt(),Ke("Letzte PO Werte übernommen.")}const vt=e("textarea",{placeholder:"Milestones im JSON-Format (optional)",value:ee.milestones?JSON.stringify(ee.milestones,null,2):"",rows:6,style:"width:100%; margin-top:12px;"});d.append(e("label",{},["Meilensteine (JSON)",vt]));const Tn=e("div",{class:"product-history"},[e("h4",{},["Historie"]),mn(u,l.sku)]),In=e("div",{class:"product-suppliers"},[e("h4",{},["Suppliers"]),e("p",{class:"muted"},["SKU-Mappings wurden entfernt. Lieferanten und Preise werden direkt im Produktstamm gepflegt."])]),_e=e("button",{class:"btn",type:"submit"},["Speichern"]),Zt=e("button",{class:"btn secondary",type:"button"},["Abbrechen"]);let kt,et=lt(l,{state:u});k.register(),k.attachBeforeUnload();function Jt(){k.unregister(),k.detachBeforeUnload(),a.__productsBulkGuard&&a.__productsBulkGuard.register(),kt.overlay.remove()}function Qt(){if(!v.isDirty){Jt();return}k({confirmWithModal:({onConfirm:t})=>xt({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{v.discardDraft(),t==null||t(),Jt()}})})}kt=pn({title:n?`Produkt bearbeiten – ${n.alias||n.sku}`:"Neues Produkt",content:e("div",{},[d,Tn,In]),actions:[Zt,_e],onClose:Qt}),Zt.addEventListener("click",Qt),_e.addEventListener("click",t=>{t.preventDefault(),d.requestSubmit()});const St=v.loadDraftIfAvailable();St!=null&&St.exists&&xt({title:"Entwurf gefunden",message:"Es gibt einen ungespeicherten Entwurf. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{v.restoreDraft(),Rn(),tt()},onCancel:()=>{v.discardDraft(),Te()}});const Yt=je("#product-apply-latest",d);Yt&&Yt.addEventListener("click",Mn),Ee("sku",te,_),Ee("alias",i,p),Ee("categoryId",h,T),Ee("moqUnits",ie,re),Ee("productionLeadTimeDaysDefault",O,j),Ee("avgSellingPriceGrossEUR",w,G),zt("sellerboardMarginPct",q,R),zt("landedUnitCostEur",be,ce),Object.keys(yt).forEach(t=>Ve(t)),Ct(),Ae(),g&&requestAnimationFrame(()=>Wt(g));function Nn({strict:t}={}){const s=vt.value.trim();if(!s)return null;try{const f=JSON.parse(s);if(!Array.isArray(f))return null;const y=f.reduce((E,L)=>E+Number(L.percent||0),0);if(t&&Math.round(y)!==100)throw new Error("Meilensteine müssen in Summe 100 % ergeben.");return f}catch(f){if(t)throw f;return null}}function Et({strictMilestones:t=!1}={}){var N,W;const s={sku:_.value.trim(),alias:p.value.trim(),supplierId:o.value.trim(),categoryId:T.value.trim()||null,status:r.value,tags:Array.isArray(l.tags)?[...l.tags]:[],avgSellingPriceGrossEUR:b(G.value.trim()),sellerboardMarginPct:b(R.value.trim()),productionLeadTimeDaysDefault:b(j.value.trim()),moqUnits:b(re.value.trim()),safetyStockDohOverride:b(me.value.trim()),foCoverageDohOverride:b(F.value.trim()),moqOverrideUnits:b(le.value.trim()),landedUnitCostEur:b(ce.value.trim())};n!=null&&n.sku&&(s.originalSku=n.sku);const f={};Object.entries(Pe).forEach(([de,we])=>{if(!we)return;if(we.type==="checkbox"){f[de]=we.checked;return}if(we.tagName==="SELECT"){f[de]=we.value;return}const Ie=we.value.trim(),Be=gt[de]||{};if(Ie===""){const We=Se[de];We!=null&&(f[de]=We);return}if(Be.valueType==="text"){f[de]=Ie;return}const nt=b(Ie);nt!=null&&(f[de]=nt)});const y=Nn({strict:t});y&&(f.milestones=y),Object.keys(f).length?s.template={scope:((N=n==null?void 0:n.template)==null?void 0:N.scope)||"SKU",name:((W=n==null?void 0:n.template)==null?void 0:W.name)||"Standard (SKU)",fields:f}:s.template=null;const E=f.fxRate??fe,L=on({unitPriceUsd:f.unitPriceUsd??null,landedCostEur:s.landedUnitCostEur,fxUsdPerEur:E});return s.fxUsdPerEur=E??null,s.logisticsPerUnitEur=L.value,s.freightPerUnitEur=L.value,s}function wt(){const t=Et();return lt(t,{state:u})}function An(t){if(!t)return"";if(t.fieldKey==="unitPriceUsd"&&t.value){const s=Y(t.value.amount,2),f=t.value.currency||"";return`Default aktiv: ${s} ${f}`.trim()}return t.fieldKey==="moqUnits"?`Default aktiv: ${Y(t.value,0)} Einheiten`:t.fieldKey==="productionLeadTimeDaysDefault"||t.fieldKey==="transitDays"?`Default aktiv: ${Y(t.value,0)} Tage`:t.fieldKey==="dutyPct"||t.fieldKey==="vatImportPct"?`Default aktiv: ${Y(t.value,2)} %`:"Default aktiv"}function en(t){const s=t.blockingMissing||[],f=t.defaulted||[];if(z.innerHTML="",s.length){M.hidden=!1,M.classList.add("blocked"),M.classList.remove("warn"),I.textContent=`Blockiert: ${s.length} Pflichtfelder fehlen`,s.forEach(y=>{const E=e("button",{class:"btn secondary sm",type:"button"},[y.label]);E.addEventListener("click",()=>Wt(y.fieldKey)),z.append(E)});return}if(f.length){M.hidden=!1,M.classList.add("warn"),M.classList.remove("blocked"),I.textContent="Hinweis: Defaults aktiv",f.forEach(y=>{const E=e("span",{class:"btn secondary sm"},[y.label]);z.append(E)});return}M.hidden=!0,M.classList.remove("blocked","warn")}function tn(t){const s=new Set((t.blockingMissing||[]).map(E=>E.fieldKey)),f=new Map((t.defaulted||[]).map(E=>[E.fieldKey,E]));ht.forEach((E,L)=>{const N=s.has(L),W=f.get(L);if(E.input.classList.toggle("field-missing-required",N),E.input.setAttribute("aria-invalid",N?"true":"false"),N){E.helper.textContent=qt,E.helper.classList.add("is-missing"),E.helper.classList.remove("is-defaulted"),E.helper.hidden=!1;return}if(W){E.helper.textContent=An(W),E.helper.classList.add("is-defaulted"),E.helper.classList.remove("is-missing"),E.helper.hidden=!1;return}E.helper.textContent="",E.helper.classList.remove("is-missing","is-defaulted"),E.helper.hidden=!0});const y=new Set((t.suggestedMissing||[]).map(E=>E.fieldKey));$t.forEach((E,L)=>{const N=y.has(L);E.helper.hidden=!N})}function Ct(){et=wt(),tn(et),en(et),Te()}function tt(){const t=Et();v.setDraft(t),Ct()}d.addEventListener("submit",async t=>{if(t.preventDefault(),!Vt()){Te();return}const s=wt();if(s.status==="blocked"){tn(s),en(s),Ke("Bitte Pflichtfelder ergänzen."),Te();return}_e.disabled=!0,_e.textContent="Speichern…";let f;try{f=Et({strictMilestones:!0})}catch(y){alert(y.message||String(y)),_e.textContent="Speichern",Te();return}try{await v.commit(()=>ln(f)),kt.overlay.remove(),He(a)}catch(y){alert(y.message||String(y)),_e.textContent="Speichern",Te()}}),d.addEventListener("input",tt),d.addEventListener("change",tt)}function Ln(n){if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const c=Qe(),u=bt(n),l=[];u.forEach(p=>{const o=!!c[p.id];l.push({id:`group-${p.id}`,isGroup:!0,categoryId:p.id,categoryName:p.name,count:p.items.length,collapsed:o}),!o&&p.items.forEach(r=>{l.push({id:`product-${r.sku}`,isGroup:!1,product:r})})});const v=[{key:"alias",title:"Alias",dataIndex:"alias",width:230,fixed:"left",onCell:p=>p.isGroup?{colSpan:14}:{},render:(p,o)=>{if(o.isGroup)return ne.createElement("button",{className:"product-group-toggle",type:"button","aria-expanded":String(!o.collapsed),onClick:()=>{const T=Qe();T[o.categoryId]=!o.collapsed,ft(T),ae()}},`${o.categoryName} (${o.count})`);const r=o.product,C=r.alias||"—";return ne.createElement("div",{className:"data-health-inline"},[wn(r.sku),ne.createElement("span",{className:"truncate-text"},C),r.status==="inactive"?ne.createElement("span",{className:"badge muted"},"inaktiv"):null])}},{key:"sku",title:"SKU",dataIndex:"sku",width:130,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>o.isGroup?null:o.product.sku||"—"},{key:"supplier",title:"Supplier",dataIndex:"supplier",width:180,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{if(o.isGroup)return null;const r=o.product;return he.get(r.supplierId)||r.supplierId||"—"}},{key:"category",title:"Kategorie",dataIndex:"category",width:150,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>o.isGroup?null:Ft(o.product.categoryId)},{key:"status",title:"Status",dataIndex:"status",width:100,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>o.isGroup?null:o.product.status==="inactive"?ne.createElement("span",{className:"badge muted"},"inaktiv"):ne.createElement("span",{className:"badge"},"aktiv")},{key:"abcClass",title:"ABC",dataIndex:"abcClass",width:70,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{if(o.isGroup)return null;const r=it(o.product.abcClass);return ne.createElement("span",{className:r==="—"?"badge muted":"badge"},r)}},{key:"completeness",title:"Vollständigkeit",dataIndex:"completeness",width:130,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>o.isGroup?null:En(o.product)},{key:"moqUnits",title:"MOQ",tooltip:"Minimum Order Quantity",dataIndex:"moqUnits",width:90,numeric:!0,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{if(o.isGroup)return null;const r=It(o.product);return Number.isFinite(r)?Number(r).toLocaleString("de-DE"):"—"}},{key:"lastPo",title:"Letzte PO",dataIndex:"lastPo",width:110,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{var r;return o.isGroup?null:(r=o.product.stats)!=null&&r.lastOrderDate?fn(o.product.stats.lastOrderDate):"—"}},{key:"avg",title:"Ø Stückpreis",dataIndex:"avg",width:120,numeric:!0,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{var r;return o.isGroup?null:((r=o.product.stats)==null?void 0:r.avgUnitPriceUsd)!=null?bn(o.product.stats.avgUnitPriceUsd):"—"}},{key:"count",title:"POs",dataIndex:"count",width:80,numeric:!0,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{var r;return o.isGroup?null:String(((r=o.product.stats)==null?void 0:r.poCount)??0)}},{key:"template",title:"Template",dataIndex:"template",width:100,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>o.isGroup?null:o.product.template?ne.createElement("span",{className:"badge"},"vorhanden"):ne.createElement("span",{className:"badge muted"},"—")},{key:"actions",title:"Aktionen",dataIndex:"actions",width:170,fixed:"right",ellipsis:!1,onCell:p=>p.isGroup?{colSpan:0}:{},render:(p,o)=>{if(o.isGroup)return null;const r=o.product;return ne.createElement("div",{className:"table-actions"},[ne.createElement("button",{className:"btn secondary sm",type:"button",onClick:()=>$e(r)},"Bearbeiten"),ne.createElement("button",{className:"btn ghost sm",type:"button","aria-haspopup":"menu","aria-expanded":"false",onClick:C=>{C.stopPropagation(),Cn(C.currentTarget,r)}},"Mehr…")])}}],k=e("div",{class:"table-wrap products-list products-list-antd"}),d=e("div",{class:"ui-scrollbar-custom ui-scrollbar-custom-top products-custom-scroll","aria-hidden":"true"},[e("div",{class:"ui-scrollbar-custom-rail"},[e("button",{class:"ui-scrollbar-custom-thumb",type:"button",tabindex:"-1"})])]),g=e("div",{class:"products-list-react-mount"}),_=e("div",{class:"ui-scrollbar-custom ui-scrollbar-custom-bottom products-custom-scroll","aria-hidden":"true"},[e("div",{class:"ui-scrollbar-custom-rail"},[e("button",{class:"ui-scrollbar-custom-thumb",type:"button",tabindex:"-1"})])]);return k.append(d,g,_),a.__productsListReactRoot=$n(g),a.__productsListReactRoot.render(ne.createElement(Xn,{className:"products-list-table-antd",columns:v,dataSource:l,rowKey:"id",rowClassName:p=>p.isGroup?"product-group-row":"product-product-row"})),requestAnimationFrame(()=>{const p=a.__productsListScrollCleanup;typeof p=="function"&&p();const o=Array.from(g.querySelectorAll(".ant-table-content, .ant-table-body")),r=o.find(P=>P&&P.scrollWidth-P.clientWidth>0)||o[0]||null,C=g.querySelector(".ant-table-content table, .ant-table-body table"),T=d.querySelector(".ui-scrollbar-custom-rail"),G=d.querySelector(".ui-scrollbar-custom-thumb"),R=_.querySelector(".ui-scrollbar-custom-rail"),j=_.querySelector(".ui-scrollbar-custom-thumb");if(!r||!C||!T||!G||!R||!j)return;const re=(P,M,I)=>Math.min(I,Math.max(M,P)),me=48,F={max:0,top:{span:1,thumb:1,left:0},bottom:{span:1,thumb:1,left:0}};let le=!1;const ce=P=>{const M=Math.max(0,Math.ceil(r.scrollWidth-r.clientWidth)),I=Math.max(1,Math.floor(P.clientWidth||1)),z=r.clientWidth/Math.max(r.scrollWidth,1),te=M<=0?I:Math.min(I,Math.max(me,Math.round(I*z))),i=Math.max(1,I-te);return{max:M,thumb:te,span:i}},ee=(P,M,I)=>{P.style.width=`${Math.max(1,Math.round(I))}px`,P.style.transform=`translateX(${Math.round(M)}px)`,P.dataset.left=String(M)},J=()=>{const P=Math.max(0,Math.ceil(r.scrollWidth-r.clientWidth));F.max=P;const M=ce(T),I=ce(R);F.top.span=M.span,F.top.thumb=M.thumb,F.bottom.span=I.span,F.bottom.thumb=I.thumb;const z=re(Math.round(r.scrollLeft),0,P),te=P<=0?0:z/P*M.span,i=P<=0?0:z/P*I.span;F.top.left=te,F.bottom.left=i,ee(G,te,M.thumb),ee(j,i,I.thumb),d.classList.toggle("is-overflow",P>0),_.classList.toggle("is-overflow",P>0)},Me=(P,M)=>{if(le)return;const I=M==="top"?F.top:F.bottom;if(F.max<=0)return;const z=re(P,0,I.span),te=I.span<=0?0:z/I.span;le=!0,r.scrollLeft=te*F.max,le=!1},ke=(P,M,I)=>{let z=!1,te=0,i=0;const S=w=>{if(!z)return;w.preventDefault();const q=w.clientX-te;Me(i+q,P)},h=()=>{z&&(z=!1,I.classList.remove("is-dragging"),window.removeEventListener("pointermove",S),window.removeEventListener("pointerup",h),window.removeEventListener("pointercancel",h))},H=w=>{F.max<=0||(w.preventDefault(),z=!0,I.classList.add("is-dragging"),te=w.clientX,i=Number(I.dataset.left||0),window.addEventListener("pointermove",S),window.addEventListener("pointerup",h),window.addEventListener("pointercancel",h))},B=w=>{if(F.max<=0||w.target===I)return;const q=M.getBoundingClientRect(),O=P==="top"?F.top:F.bottom,ie=w.clientX-q.left-O.thumb/2;Me(ie,P)};return I.addEventListener("pointerdown",H),M.addEventListener("pointerdown",B),()=>{h(),I.removeEventListener("pointerdown",H),M.removeEventListener("pointerdown",B)}},xe=ke("top",T,G),fe=ke("bottom",R,j),Se=()=>{le||J()};r.classList.add("ui-scrollbar-managed"),J(),r.addEventListener("scroll",Se,{passive:!0}),window.addEventListener("resize",J);const De=typeof ResizeObserver=="function"?new ResizeObserver(()=>J()):null;De&&(De.observe(r),De.observe(C)),a.__productsListScrollCleanup=()=>{xe(),fe(),r.removeEventListener("scroll",Se),window.removeEventListener("resize",J),r.classList.remove("ui-scrollbar-managed"),De&&De.disconnect()}}),k}function xn(n,{key:c,colgroup:u=null,widths:l=[]}={}){if(!n)return;const v=n.querySelector("thead tr:last-child");if(!v)return;const k=Array.from(v.querySelectorAll("th"));if(!k.length)return;n.style.tableLayout="fixed",k.forEach((o,r)=>{if(o.querySelector(".col-resizer"))return;const C=e("span",{class:"col-resizer","aria-hidden":"true"});o.append(C),o.dataset.colIndex=String(r)});const d=u?Array.from(u.children):null;k.forEach((o,r)=>{const C=l[r];if(Number.isFinite(C)){o.style.width=`${C}px`,d&&d[r]&&(d[r].style.width=`${C}px`);return}const T=o.getBoundingClientRect().width;T&&(o.style.width=`${T}px`,d&&d[r]&&(d[r].style.width=`${T}px`))});let g=null;function _(o){if(!g)return;const r=o.clientX-g.startX,C=Math.max(g.minWidth,g.startWidth+r);g.th.style.width=`${C}px`,g.col&&(g.col.style.width=`${C}px`)}function p(){if(!g)return;document.removeEventListener("pointermove",_),document.removeEventListener("pointerup",p);const o=k.map((r,C)=>d&&d[C]?d[C].getBoundingClientRect().width:r.getBoundingClientRect().width);c&&qn(c,o),g=null,n.classList.remove("is-resizing")}n.addEventListener("pointerdown",o=>{const r=o.target.closest(".col-resizer");if(!r)return;const C=r.closest("th");if(!C)return;o.preventDefault();const T=Number(C.dataset.colIndex),G=d&&Number.isFinite(T)?d[T]:null,R=C.getBoundingClientRect().width;g={th:C,col:G,startX:o.clientX,startWidth:R,minWidth:80},n.classList.add("is-resizing"),document.addEventListener("pointermove",_),document.addEventListener("pointerup",p)})}function Dn(n){var z,te;if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const c=m.settings||{},l={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,dutyIncludesFreight:!1,vatImportPct:19,vatRefundActive:!1,vatRefundLag:0,fxRate:b(c.fxRate)??null??0,fxFeePct:0,ddp:c.defaultDdp===!0,currency:c.defaultCurrency||"EUR"},k=(Array.isArray(m.suppliers)?m.suppliers:[]).map(i=>({value:String(i.id||"").trim(),label:he.get(i.id)||i.name||i.id||"—"})).filter(i=>i.value),d=x.map(i=>({value:String(i.id),label:i.name||"Ohne Kategorie"})),g=[{key:"alias",label:"Alias",type:"text",width:"240px",className:"col-alias"},{key:"sku",label:"SKU",type:"text",width:"160px",readOnly:!0,className:"col-sku"},{key:"supplierId",label:"Supplier",type:"select",options:k,width:"180px",className:"col-supplier"},{key:"categoryId",label:"Kategorie",type:"select",options:[{value:"",label:"Ohne Kategorie"},...d],width:"180px",className:"col-category"},{key:"status",label:"Status",type:"select",options:[{value:"active",label:"Aktiv"},{value:"inactive",label:"Inaktiv"}],width:"110px",className:"col-status"},{key:"abcClass",label:"ABC",type:"display",width:"80px",className:"col-abc"},{key:"completeness",label:"Vollständigkeit",type:"display",width:"160px",className:"col-completeness"},{key:"avgSellingPriceGrossEUR",label:"Ø VK-Preis (Brutto)",type:"number",decimals:2,width:"150px",className:"col-amount"},{key:"sellerboardMarginPct",label:"Sellerboard Marge (%)",type:"number",decimals:2,width:"140px",className:"col-short"},{key:"productionLeadTimeDaysDefault",label:"Default Production Lead Time (Fallback)",type:"number",decimals:0,width:"170px",className:"col-days"},{key:"moqUnits",label:"MOQ (Einheiten)",type:"number",decimals:0,width:"120px",className:"col-short col-group-end"},{key:"template.unitPriceUsd",label:"Stückpreis (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraPerUnitUsd",label:"Zusatz je Stück (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraFlatUsd",label:"Zusatz pauschal (USD)",type:"number",decimals:2,width:"140px",className:"col-amount col-group-end"},{key:"template.transportMode",label:"Transport",type:"select",options:[{value:"SEA",label:"SEA"},{value:"RAIL",label:"RAIL"},{value:"AIR",label:"AIR"}],width:"130px",className:"col-transport"},{key:"template.productionDays",label:"Produktionstage",type:"number",decimals:0,width:"120px",className:"col-days"},{key:"template.transitDays",label:"Transit-Tage",type:"number",decimals:0,width:"120px",className:"col-days col-group-end"},{key:"template.freightEur",label:"Logistik / Stk. (EUR)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.dutyPct",label:"Zoll %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatImportPct",label:"EUSt %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatRefundLag",label:"EUSt-Lag",type:"number",decimals:0,width:"80px",className:"col-short col-group-end"},{key:"template.fxRate",label:"FX-Kurs",type:"number",decimals:4,width:"140px",className:"col-amount"},{key:"template.fxFeePct",label:"FX-Gebühr %",type:"number",decimals:2,width:"90px",className:"col-short col-group-end"},{key:"template.currency",label:"Currency",type:"select",options:[{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"CNY",label:"CNY"}],width:"110px",className:"col-currency"},{key:"template.ddp",label:"DDP",type:"checkbox",width:"56px",className:"col-check col-group-end"}];function _(i){var h;const S=((h=i.template)==null?void 0:h.fields)||i.template||{};return{...l,...S}}function p(i,S){if(S.key.startsWith("template.")){const h=S.key.replace("template.","");return _(i)[h]}if(S.key==="categoryId")return i.categoryId||"";if(S.key==="abcClass")return it(i.abcClass);if(S.key==="completeness")return Je(i);if(S.key==="moqUnits"){const h=It(i);return h??""}return i[S.key]??""}function o(i,S){if(S.type==="number"){const h=b(i);return h==null?"":$(h,S.decimals??2)}return S.type==="display"?i:S.type==="checkbox"?!!i:i??""}function r(i,S){return S.type==="number"?b(i):S.type==="display"?i:S.type==="checkbox"?!!i:String(i??"").trim()}function C(i){return Le[i]||(Le[i]={}),Le[i]}function T(i,S){const h=Le[i];h&&(delete h[S],Object.keys(h).length||delete Le[i])}function G(){return Object.values(Le).reduce((i,S)=>i+Object.keys(S||{}).length,0)}const R=e("div",{class:"products-grid-toolbar"}),j=e("select",{onchange:i=>{Ze=i.target.value,rt(Xe,{mode:Ze}),ae()}},[e("option",{value:"category"},["Sortierung: Kategorie"]),e("option",{value:"abc"},["Sortierung: ABC (A → C)"])]);j.value=Ze;const re=e("span",{class:"muted"},["0 Änderungen"]),me=e("button",{class:"btn",type:"button",disabled:!0},["Änderungen speichern"]),F=e("button",{class:"btn secondary",type:"button",disabled:!0},["Änderungen verwerfen"]);R.append(j,re,e("div",{class:"products-grid-actions"},[F,me]));function le(){const i=G();re.textContent=`${i} Änderungen`,me.disabled=i===0,F.disabled=i===0}function ce(i){const S=!!i.querySelector("td.is-dirty");i.classList.toggle("is-dirty",S)}function ee(i,S,h){var ie;const H=h.type==="checkbox"?i.checked:i.value;h.type==="select"&&(i.title=((ie=i.options[i.selectedIndex])==null?void 0:ie.textContent)||String(H??""));const B=r(H,h),w=r(p(S,h),h),q=h.type==="number"?Number(B)!==Number(w):B!==w;if(q){const Q=C(S.sku);Q[h.key]=B}else T(S.sku,h.key);const O=i.closest("td");if(O){O.classList.toggle("is-dirty",q);const Q=O.closest("tr");Q&&ce(Q)}le(),ye.setDraft(ye.draft)}const J=e("div",{class:"products-grid"}),Me=e("div",{class:"products-grid-scroll"}),ke=e("table",{class:"products-grid-table","data-ui-table":"true","data-sticky-cols":"1"}),xe=e("colgroup"),fe=((te=(z=m==null?void 0:m.settings)==null?void 0:z.productsTableColumns)==null?void 0:te.grid)||[];g.forEach((i,S)=>{const h=Number.isFinite(fe[S])?`${fe[S]}px`:i.width;xe.append(e("col",{style:h?`width:${h}`:null}))});const Se=Number.isFinite(fe[g.length])?`${fe[g.length]}px`:"180px";xe.append(e("col",{style:`width:${Se}`}));const De=e("thead",{},[e("tr",{class:"products-grid-group-header"},[e("th",{colspan:"10",title:"Stammdaten"},["Stammdaten"]),e("th",{colspan:"3",title:"Kosten"},["Kosten"]),e("th",{colspan:"4",title:"Logistik"},["Logistik"]),e("th",{colspan:"5",title:"Steuern"},["Steuern"]),e("th",{colspan:"3",title:"FX & Währung"},["FX & Währung"]),e("th",{colspan:"1",title:"Sonstiges"},["Sonstiges"]),e("th",{colspan:"1",title:"Tags"},["Tags"]),e("th",{colspan:"1",class:"actions",title:"Aktionen"},["Aktionen"])]),e("tr",{},[...g.map(i=>e("th",{class:i.className||"",title:i.label},[i.label])),e("th",{class:"actions",title:"Aktionen"},["Aktionen"])])]),P=e("tbody"),M=Qe();return bt(n,{sortMode:Ze}).forEach(i=>{const S=!!M[i.id];P.append(e("tr",{class:"product-group-row"},[e("td",{colspan:String(g.length+1)},[e("button",{class:"product-group-toggle",type:"button",dataset:{categoryId:i.id},"aria-expanded":String(!S)},[`${i.name} (${i.items.length})`])])])),!S&&i.items.forEach(h=>{const H=e("tr");g.forEach(w=>{var ie,Q;const q=e("td",{class:w.className||""}),O=((ie=Le[h.sku])==null?void 0:ie[w.key])??p(h,w);if(w.type==="display")q.append(Sn(h));else if(w.type==="checkbox"){const A=e("input",{type:"checkbox",checked:!!O,onchange:()=>ee(A,h,w),title:w.label});q.append(A)}else if(w.type==="select"){const A=e("select",{onchange:()=>ee(A,h,w)}),se=w.options||[],be=String(O??"");["supplierId","status","categoryId","template.transportMode","template.currency"].includes(w.key)&&(A.title=be),!se.some(qe=>qe.value===be)&&be&&A.append(e("option",{value:be},[be])),se.forEach(qe=>{A.append(e("option",{value:qe.value},[qe.label]))}),A.value=be,A.title=((Q=A.options[A.selectedIndex])==null?void 0:Q.textContent)||be,q.append(A)}else{const A=e("input",{value:o(O,w),inputmode:w.type==="number"?"decimal":"text",readonly:w.readOnly?"readonly":null,title:["alias","sku","supplierId"].includes(w.key)?String(O??""):null,oninput:()=>ee(A,h,w),onblur:()=>{if(w.type==="number"){const se=b(A.value);A.value=se==null?"":$(se,w.decimals??2)}}});if(w.key==="alias"){const se=gn(h.sku);se&&q.append(se)}q.append(A)}if(w.type!=="display"){const A=r(p(h,w),w),se=r(O,w);(w.type==="number"?Number(se)!==Number(A):se!==A)&&q.classList.add("is-dirty")}H.append(q)});const B=e("td",{class:"actions"},[e("button",{class:"btn secondary",type:"button",onclick:()=>$e(h)},["Bearbeiten"]),e("button",{class:"btn tertiary",type:"button",onclick:()=>Kt(h)},["Historie"])]);H.append(B),ce(H),P.append(H)})}),ke.append(xe,De,P),xn(ke,{key:"grid",colgroup:xe,widths:fe}),Me.append(ke),J.append(R,Me),le(),ke.addEventListener("click",i=>{const S=i.target.closest(".product-group-toggle");if(!S)return;const h=Qe(),H=S.dataset.categoryId;h[H]=!h[H],ft(h),ae()}),F.addEventListener("click",()=>{ye.resetDraft(),ae()}),me.addEventListener("click",async()=>{const i=Object.entries(Le);if(!i.length)return;const S=[];await Promise.allSettled(i.map(([h,H])=>{var ie;const B=Gn(h);if(!B)return S.push(h),Promise.resolve();const w=Object.keys(H).some(Q=>Q.startsWith("template.")),q=w?_(B):null,O={sku:B.sku,alias:B.alias,supplierId:B.supplierId,categoryId:B.categoryId??null,status:B.status,tags:Array.isArray(B.tags)?[...B.tags]:[],template:B.template?{...B.template}:null,avgSellingPriceGrossEUR:B.avgSellingPriceGrossEUR??null,sellerboardMarginPct:B.sellerboardMarginPct??null,originalSku:B.sku};Object.entries(H).forEach(([Q,A])=>{if(Q.startsWith("template.")){const se=Q.replace("template.","");O.template||(O.template={scope:"SKU",name:"Standard (SKU)",fields:{}}),O.template.fields||(O.template.fields={...q}),O.template.fields[se]=A}else Q==="categoryId"?O.categoryId=A?String(A):null:O[Q]=A}),w&&((ie=O.template)!=null&&ie.fields)&&q&&(O.template.fields={...q,...O.template.fields});try{ln(O)}catch{S.push(h)}})),S.length?Ke(`Fehler bei SKUs: ${S.join(", ")}`):Ke("Änderungen gespeichert"),ye.resetDraft(),ae()}),J}function Kt(n){const c=Lt(),u=mn(c,n.sku),l=e("button",{class:"btn",type:"button"},["Schließen"]),v=pn({title:`Historie – ${n.alias||n.sku}`,content:u,actions:[l],onClose:()=>{}});l.addEventListener("click",()=>v.overlay.remove())}function ae(){const n=a.querySelector('input[type="search"]'),c=document.activeElement===n,u=c?n.selectionStart:null;typeof a.__productsListScrollCleanup=="function"&&(a.__productsListScrollCleanup(),a.__productsListScrollCleanup=null),a.__productsListReactRoot&&(a.__productsListReactRoot.unmount(),a.__productsListReactRoot=null),a.innerHTML="";const l=yn(D,X,Ue,Oe),v=D.filter(R=>R.alias.startsWith("Ohne Alias")).length,k=e("div",{class:"products-header"}),d=e("h2",{},["Produkte"]),g=e("div",{class:"products-actions"}),_=e("button",{class:"btn",type:"button",onclick:()=>$e(null)},["+ Produkt anlegen"]),p=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!1),ae()}},["Alles aufklappen"]),o=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!0),ae()}},["Alles zuklappen"]),r=e("input",{type:"search",placeholder:"Suche nach Alias, SKU, Supplier",value:X,oninput:R=>{X=R.target.value,ae()}}),C=e("select",{class:"products-completeness-filter",onchange:R=>{Ue=R.target.value,rt(Ce,{filter:Ue}),ae()}},[e("option",{value:"all"},["Alle Vollständigkeiten"]),e("option",{value:"blocked"},["Nur Blockierte"]),e("option",{value:"warn"},["Nur Warnungen"]),e("option",{value:"ok"},["Nur Vollständige"])]);C.value=Ue==="warning"?"warn":Ue;const T=e("select",{class:"products-abc-filter",onchange:R=>{Oe=R.target.value,rt(Ne,{filter:Oe}),ae()}},[e("option",{value:"all"},["ABC: Alle"]),...Pt.map(R=>e("option",{value:R},[`ABC: ${R}`]))]);T.value=Oe;const G=e("div",{class:"view-toggle"},[e("button",{type:"button",class:`btn tertiary${oe==="list"?" is-active":""}`,"aria-pressed":oe==="list",onclick:()=>{oe="list",rn("productsView",oe),ae()}},["Liste"]),e("button",{type:"button",class:`btn tertiary${oe==="table"?" is-active":""}`,"aria-pressed":oe==="table",onclick:()=>{oe="table",rn("productsView",oe),ae()}},["Tabelle"])]);g.append(r,C,T,p,o,G,_),k.append(d,g),a.append(k),v&&a.append(e("div",{class:"banner info"},[`${v} Produkte ohne Alias – bitte ergänzen.`])),a.append(oe==="table"?Dn(l):Ln(l)),c&&(r.focus(),u!=null&&r.setSelectionRange(u,u))}ae()}function ts(a){const m=()=>He(a);return a.__productsCleanup&&a.__productsCleanup(),document.addEventListener("state:changed",m),a.__productsCleanup=()=>{typeof a.__productsListScrollCleanup=="function"&&(a.__productsListScrollCleanup(),a.__productsListScrollCleanup=null),a.__productsListReactRoot&&(a.__productsListReactRoot.unmount(),a.__productsListReactRoot=null),document.removeEventListener("state:changed",m),a.__productsActionsCleanup&&(a.__productsActionsCleanup(),a.__productsActionsCleanup=null),a.__productsBulkGuard&&(a.__productsBulkGuard.unregister(),a.__productsBulkGuard.detachBeforeUnload(),a.__productsBulkGuard=null)},He(a),{cleanup:a.__productsCleanup}}export{ts as default};
