import{k as Oe,T as Mn,g as Fn,m as Bn,u as sn,h as xt,p as f,n as Kn,f as an,q as Gn,t as W,w as z,x as rn,y as $n,z as qn,A as Vn}from"./index-DN7VFcDZ.js";import{l as Lt,a as at,g as zn,s as ln,b as rt}from"./store-DeED5oF-.js";import{b as Wn}from"./supplierLabels-BolgyxWX.js";import{c as on}from"./costing-CmZrILJ2.js";import{e as lt}from"./productCompleteness-CNODPsSo.js";import{u as cn}from"./useDraftForm-BHSAI3va.js";import{b as jn}from"./abcClassification-CjzpwCXo.js";import{F as Hn}from"./Table-tY3ytGVC.js";import"./deepEqual-CGWqzo0t.js";import"./index-CRiLTIeN.js";import"./DownOutlined-BokHnPkJ.js";import"./index-tvZ13nRk.js";import"./useBubbleLock-BhAInPbh.js";import"./Dropdown-DPveZyNz.js";import"./index-eyO9lyJZ.js";import"./Pagination-14yzqtam.js";function Pt({title:s,children:o,placement:I="topLeft"}){return s?Oe.jsx(Mn,{title:s,placement:I,mouseEnterDelay:.15,children:o}):o}function Xn(s){if(s==null||s==="")return"—";const o=typeof s=="string"||typeof s=="number"?String(s):s;return typeof o!="string"?o:Oe.jsx(Pt,{title:o,children:Oe.jsx("span",{className:"app-table-ellipsis",children:o})})}function un(s,o){if(Array.isArray(o))return o.reduce((I,w)=>I==null?I:I[w],s);if(typeof o=="string"||typeof o=="number")return s==null?void 0:s[o]}function Zn(s,o){const I=s==null||s==="",w=o==null||o==="";if(I&&w)return 0;if(I)return 1;if(w)return-1;const L=Number(s),T=Number(o);return Number.isFinite(L)&&Number.isFinite(T)?L-T:String(s).localeCompare(String(o),"de-DE",{numeric:!0,sensitivity:"base"})}function Jn({columns:s,dataSource:o,rowKey:I="id",stickyFirstColumn:w=!1,scrollY:L,className:T,...x}){const ie=(s||[]).map((G,me)=>{const M={...G};if(G.tooltip){const fe=G.title??G.label??"";M.title=Oe.jsx(Pt,{title:G.tooltip,children:Oe.jsx("span",{children:fe})})}if(G.numeric&&!M.align&&(M.align="right"),w&&me===0&&!M.fixed&&(M.fixed="left"),M.sorter==null&&G.sortable!==!1&&M.dataIndex!=null&&(M.sorter=(fe,Me)=>Zn(un(fe,M.dataIndex),un(Me,M.dataIndex))),G.ellipsis!==!1){const fe=G.render;M.ellipsis={showTitle:!1},M.render=(Me,Ae,He)=>{const Nt=fe?fe(Me,Ae,He):Me;return Xn(Nt)}}return M}),oe={x:"max-content",...L?{y:L}:{}};return Oe.jsx(Hn,{className:T,size:"middle",pagination:!1,sticky:!0,rowKey:I,columns:ie,dataSource:o||[],scroll:oe,...x})}function We(s,o=document){return o.querySelector(s)}function e(s,o={},I=[]){const w=document.createElement(s);Object.entries(o).forEach(([L,T])=>{L==="class"?w.className=T:L.startsWith("on")&&typeof T=="function"?w.addEventListener(L.slice(2),T):L==="dataset"&&T&&typeof T=="object"?Object.entries(T).forEach(([x,ie])=>w.dataset[x]=ie):T!=null&&w.setAttribute(L,T)});for(const L of Array.isArray(I)?I:[I])L!=null&&w.append(L.nodeType?L:document.createTextNode(String(L)));return w}function gn(s){if(!s)return"—";const[o,I,w]=s.split("-").map(Number);if(!o||!I||!w)return"—";const L=new Date(Date.UTC(o,I-1,w));return Number.isNaN(L.getTime())?"—":L.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function bn(s){const o=f(s);return o==null?"—":o.toLocaleString("de-DE",{style:"currency",currency:"USD"})}function Qn(s){const o=f(s);return o==null?"—":o.toLocaleString("de-DE",{style:"currency",currency:"EUR"})}const Dt=["A","B","C"],Yn={A:0,B:1,C:2};function Ut(s){const o=String(s||"").trim().toUpperCase();return Dt.includes(o)?o:null}function it(s){return Ut(s)||"—"}function dn(s){const o=Ut(s);return o?Yn[o]:Dt.length}function B(s,o=2){return z(s,o,{emptyValue:"",useGrouping:!1})}function pn(s){if(!s.length)return"";const I=s.map(w=>w.field).map(w=>{switch(w){case"alias":return"Alias";case"currency":return"Currency";case"unitPrice":return"Unit Price";case"avgSellingPriceGrossEUR":return"Ø VK-Preis";case"sellerboardMarginPct":return"Sellerboard Marge";case"ddp":return"DDP";default:return w}});return`Fehlt: ${[...new Set(I)].join(", ")}`}function _e(s){let o=document.getElementById("products-toast");o||(o=document.createElement("div"),o.id="products-toast",o.className="po-toast",document.body.appendChild(o)),o.textContent=s,o.hidden=!1,setTimeout(()=>{o.hidden=!0},2e3)}function mn({title:s,content:o,actions:I=[],onClose:w}){const L=e("div",{class:"po-modal-backdrop"}),T=e("div",{class:"po-modal product-modal-frame"}),x=e("div",{class:"po-modal-header"},[e("h3",{},[s]),e("button",{type:"button",class:"btn tertiary",onclick:()=>{if(typeof w=="function"){w();return}document.body.removeChild(L),document.removeEventListener("keydown",me)},"aria-label":"Schließen"},["✕"])]),ie=e("div",{class:"po-modal-body"},[o]),oe=e("div",{class:"po-modal-actions"});I.forEach(M=>oe.append(M)),T.append(x,ie,oe),L.append(T);let G=!1;L.addEventListener("mousedown",M=>{G=M.target===L}),L.addEventListener("mouseup",M=>{G&&M.target===L&&(typeof w=="function"?w():(document.body.removeChild(L),document.removeEventListener("keydown",me))),G=!1});function me(M){if(M.key==="Escape"){if(typeof w=="function"){w();return}document.body.removeChild(L),document.removeEventListener("keydown",me)}}return document.addEventListener("keydown",me),document.body.append(L),{overlay:L,modal:T,body:ie,footer:oe}}function fn(s,o){const I=(s.pos||[]).filter(x=>((x==null?void 0:x.sku)||"").trim().toLowerCase()===String(o||"").trim().toLowerCase()).sort((x,ie)=>(ie.orderDate||"").localeCompare(x.orderDate||"")).slice(0,10);if(!I.length)return e("p",{class:"empty-state"},["Keine Bestellhistorie verfügbar."]);const w=e("table",{class:"table ui-table-standard","data-ui-table":"true"}),L=e("thead",{},[e("tr",{},[e("th",{},["PO-Nr."]),e("th",{},["Bestelldatum"]),e("th",{},["Stückzahl"]),e("th",{},["Stückpreis (USD)"]),e("th",{},["Produktionstage"]),e("th",{},["Transit"]),e("th",{},["Transport"]),e("th",{},["Fracht (€)"]),e("th",{},["Zoll %"]),e("th",{},["EUSt %"]),e("th",{},["FX-Fee %"])])]),T=e("tbody");return I.forEach(x=>{T.append(e("tr",{},[e("td",{},[x.poNumber||x.number||"—"]),e("td",{},[gn(x.orderDate)]),e("td",{},[x.units!=null?z(f(x.units),0):"—"]),e("td",{},[bn(x.unitCostUsd)]),e("td",{},[Number.isFinite(Number(x.prodDays))?String(x.prodDays):"—"]),e("td",{},[Number.isFinite(Number(x.transitDays))?String(x.transitDays):"—"]),e("td",{},[x.transport||"—"]),e("td",{},[Qn(x.freightEur)]),e("td",{},[x.dutyRatePct!=null?z(f(x.dutyRatePct),2):"—"]),e("td",{},[x.eustRatePct!=null?z(f(x.eustRatePct),2):"—"]),e("td",{},[x.fxFeePct!=null?z(f(x.fxFeePct),2):"—"])]))}),w.append(L,T),w}function je(s){const o=Lt(),I=jn(o),w=Fn().map(n=>{const i=String((n==null?void 0:n.sku)||"").trim().toLowerCase(),u=i?I.bySku.get(i):null;return{...n,abcClass:(u==null?void 0:u.abcClass)??null,abcMeta:u||null}}),L=Bn(w,o.settings||{}),T=new Map;L.forEach(n=>{const i=String(n.entityId||"").trim();i&&(T.has(i)||T.set(i,[]),T.get(i).push(n))});const x=Array.isArray(o.productCategories)?o.productCategories:[],ie=new Map(x.map(n=>[String(n.id),n])),oe=Wn(o,w);let G="";const me="productsCompletenessView";let Se=at(me,{filter:"all"}).filter||"all";const fe="productsAbcFilter";let Ae=at(fe,{filter:"all"}).filter||"all";const He="productsTableSort";let Xe=at(He,{mode:"category"}).mode||"category";Se==="ready"&&(Se="ok");let Q=zn("productsView");Q!=="table"&&Q!=="list"&&(Q="list");const ce=s.__productsBulkDraft||cn({},{key:"products:bulk",enableDraftCache:!0});s.__productsBulkDraft=ce;const ge=ce.draft;s.__productsBulkGuard&&(s.__productsBulkGuard.unregister(),s.__productsBulkGuard.detachBeforeUnload());const ot=sn(()=>ce.isDirty,"Ungespeicherte Änderungen verwerfen?");s.__productsBulkGuard=ot,ot.register(),ot.attachBeforeUnload();const Rt="productsCategoryCollapse",At=sessionStorage.getItem("healthFocus");if(At){try{const n=JSON.parse(At);(n==null?void 0:n.tab)==="produkte"&&n.sku&&(G=String(n.sku))}catch{}sessionStorage.removeItem("healthFocus")}const ct=ce.loadDraftIfAvailable();!s.__bulkDraftPrompted&&(ct!=null&&ct.exists)&&Object.keys(ge).length===0&&(s.__bulkDraftPrompted=!0,xt({title:"Entwurf gefunden",message:"Es gibt ungespeicherte Tabellenänderungen. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{ce.restoreDraft(),X()},onCancel:()=>{ce.discardDraft()}}));function yn(n){const i=T.get(n)||[];if(!i.length)return null;const u=pn(i);return e("button",{class:"data-health-dot",type:"button",title:u,"aria-label":u,onclick:l=>{l.stopPropagation(),rn({scope:"product",entityId:n})}})}const ut=new Map,hn={state:o};function Ze(n){return n!=null&&n.sku?(ut.has(n.sku)||ut.set(n.sku,lt(n,hn)),ut.get(n.sku)):lt(n,{state:o})}function It(n){var b;const i=f((b=o==null?void 0:o.settings)==null?void 0:b.moqDefaultUnits),u=f(n==null?void 0:n.moqOverrideUnits);if(u!=null&&u>0)return Math.round(u);const l=f(n==null?void 0:n.moqUnits);return l!=null&&l>0?Math.round(l):i!=null&&i>0?Math.round(i):null}function vn(n,i,u,l){const b=i?n.filter(a=>{const p=i.trim().toLowerCase(),y=Ft(a.categoryId),P=oe.get(a.supplierId);return[a.alias,a.sku,a.supplierId,P,y].filter(Boolean).some(S=>String(S).toLowerCase().includes(p))}):n,h=!l||l==="all"?b:b.filter(a=>Ut(a.abcClass)===l);if(!u||u==="all")return h;const d=u==="ready"?"ok":u==="warning"?"warn":u;return h.filter(a=>Ze(a).status===d)}function Tt(n){return n==="ok"?"OK":n==="warn"?"WARN":"BLOCKED"}function Ie(n,i=3){const u=(n||[]).map(h=>h.label).filter(Boolean);if(!u.length)return"";const l=u.slice(0,i),b=u.length-l.length;return`${l.join(", ")}${b>0?` +${b} weitere`:""}`}function kn(n){const i=[],u=Ie(n.blockingMissing),l=Ie(n.defaulted),b=Ie(n.suggestedMissing);u&&i.push(`Fehlt: ${u}`);const h=[];return l&&h.push(`Standardwert: ${l}`),b&&h.push(`Empfohlen: ${b}`),h.length&&i.push(h.join(" · ")),i.length||i.push("Alle Pflichtfelder vorhanden."),i.slice(0,2).map(d=>e("div",{},[d]))}function dt(){let n=document.getElementById("products-completeness-tooltip");return n||(n=e("div",{id:"products-completeness-tooltip",class:"portal-tooltip",role:"tooltip",hidden:!0}),document.body.appendChild(n)),n}function Sn(n,i,{delay:u=150}={}){let l=null,b=!1,h=null;function d(){const S=dt(),U=n.getBoundingClientRect(),O=S.getBoundingClientRect(),$=8;let R=U.left,Z=U.bottom+8;const se=window.innerWidth-O.width-$;R>se&&(R=se),R<$&&(R=$),Z+O.height>window.innerHeight-$&&(Z=U.top-O.height-8),Z<$&&(Z=$),S.style.left=`${R}px`,S.style.top=`${Z}px`}function a(){if(b)return;b=!0;const S=dt();S.innerHTML="",S.append(...i()),S.hidden=!1,S.classList.add("is-visible"),n.setAttribute("aria-describedby",S.id),requestAnimationFrame(d);const U=()=>d(),O=()=>d();window.addEventListener("scroll",U,!0),window.addEventListener("resize",O),h=()=>{window.removeEventListener("scroll",U,!0),window.removeEventListener("resize",O)}}function p(){if(clearTimeout(l),!b)return;b=!1;const S=dt();S.hidden=!0,S.classList.remove("is-visible"),S.innerHTML="",h&&h(),h=null}function y(){clearTimeout(l),l=setTimeout(a,u)}function P(){p()}n.addEventListener("mouseenter",y),n.addEventListener("focus",y),n.addEventListener("mouseleave",P),n.addEventListener("blur",P)}function En(n){const i=Ze(n),u=i.status||"blocked",l=Tt(u),b=e("button",{class:`tooltip-trigger completeness-badge ${u}`,type:"button","aria-label":l,onclick:h=>{var d;h.stopPropagation(),u==="blocked"&&((d=i.blockingMissing)!=null&&d.length)&&Fe(n,{focusFieldKey:i.blockingMissing[0].fieldKey})}},[l]);return Sn(b,()=>kn(i)),b}function wn(n){const i=Ze(n),u=i.status||"blocked",l=Tt(u),b=[Ie(i.blockingMissing),Ie(i.defaulted),Ie(i.suggestedMissing)].filter(Boolean).join(" · ")||"Alle Pflichtfelder vorhanden.",h=W.createElement("button",{className:`tooltip-trigger completeness-badge ${u}`,type:"button",onClick:d=>{var a;d.stopPropagation(),u==="blocked"&&((a=i.blockingMissing)!=null&&a.length)&&Fe(n,{focusFieldKey:i.blockingMissing[0].fieldKey})}},l);return W.createElement(Pt,{title:b},h)}function Cn(n){const i=T.get(n)||[];if(!i.length)return null;const u=pn(i);return W.createElement("button",{className:"data-health-dot",type:"button","aria-label":u,onClick:l=>{l.stopPropagation(),rn({scope:"product",entityId:n})}})}s.__productsActionsCleanup&&s.__productsActionsCleanup();let ne=null,ue=null;function Ee(){ue&&ue.setAttribute("aria-expanded","false"),ne&&ne.remove(),ne=null,ue=null}function pt(){if(!ne||!ue)return;const n=ue.getBoundingClientRect(),i=ne.getBoundingClientRect(),u=8,l=window.innerWidth-i.width-u,b=window.innerHeight-i.height-u;let h=n.right-i.width,d=n.bottom+6;h=Math.min(l,h),h=Math.max(u,h),d>b&&(d=n.top-i.height-6),d=Math.max(u,d),ne.style.left=`${h}px`,ne.style.top=`${d}px`}function xn(n,i){if(!n||!i)return;if(ue===n){Ee();return}Ee();const u=e("div",{class:"product-actions-menu",role:"menu"}),l=e("button",{class:"product-actions-menu-item",type:"button",onclick:d=>{d.stopPropagation(),Kt(i),Ee()}},["Historie"]),b=e("button",{class:"product-actions-menu-item",type:"button",onclick:d=>{d.stopPropagation(),qn(i.sku,i.status==="inactive"?"active":"inactive"),Ee(),je(s)}},[i.status==="inactive"?"Aktiv setzen":"Inaktiv setzen"]),h=e("button",{class:"product-actions-menu-item danger",type:"button",onclick:d=>{d.stopPropagation(),confirm("Produkt wirklich löschen?")&&(Vn(i.sku),Ee(),je(s))}},["Löschen"]);u.append(l,b,h),document.body.appendChild(u),ne=u,ue=n,ue.setAttribute("aria-expanded","true"),pt(),requestAnimationFrame(pt)}function _t(n){ne&&(ne.contains(n.target)||ue&&ue.contains(n.target)||Ee())}function Ot(){pt()}function Mt(){ne&&Ee()}document.addEventListener("click",_t),window.addEventListener("resize",Ot),window.addEventListener("scroll",Mt,!0),s.__productsActionsCleanup=()=>{Ee(),document.removeEventListener("click",_t),window.removeEventListener("resize",Ot),window.removeEventListener("scroll",Mt,!0)};function Ft(n){if(!n)return"Ohne Kategorie";const i=ie.get(String(n));return(i==null?void 0:i.name)||"Ohne Kategorie"}function Je(){return at(Rt,{})}function mt(n){rt(Rt,n)}function Bt(n){const i={};ft(w).forEach(l=>{i[l.id]=n}),mt(i)}function ft(n,{sortMode:i}={}){const u=new Map;n.forEach(d=>{const a=d.categoryId?String(d.categoryId):"";u.has(a)||u.set(a,[]),u.get(a).push(d)}),i==="abc"&&u.forEach(d=>{d.sort((a,p)=>{const y=dn(a.abcClass)-dn(p.abcClass);return y||String(a.alias||a.sku||"").localeCompare(String(p.alias||p.sku||""))})});const b=x.slice().sort((d,a)=>(d.sortOrder??0)-(a.sortOrder??0)||String(d.name||"").localeCompare(String(a.name||""))).map(d=>({id:String(d.id),name:d.name||"Ohne Kategorie",items:u.get(String(d.id))||[]})),h=u.get("")||[];return h.length&&b.push({id:"uncategorized",name:"Ohne Kategorie",items:h}),b}function Fe(n,i={}){var nn;const u=Lt();let l=n?{...n}:{sku:"",alias:"",supplierId:"",status:"active",tags:[],template:null,abcClass:null};const b=cn(l,{key:l.sku?`product:${l.sku}`:"product:new",enableDraftCache:!0});l=b.draft;const h=sn(()=>b.isDirty,"Ungespeicherte Änderungen verwerfen?"),d=e("form",{class:"form"}),a=i.focusFieldKey,p=e("input",{value:l.sku||"",required:!0}),y=e("input",{value:l.alias||"",required:!0}),P=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Supplier"])),(u.suppliers||[]).forEach(r=>{const m=oe.get(r.id)||r.name||r.id;t.append(e("option",{value:r.id},[m]))}),t.value=l.supplierId||"",t})(),S=e("select",{},[e("option",{value:"active",selected:l.status!=="inactive"},["Aktiv"]),e("option",{value:"inactive",selected:l.status==="inactive"},["Inaktiv"])]),U=e("input",{value:it(l.abcClass),disabled:!0}),O=(()=>{const t=e("select");return t.append(e("option",{value:""},["Ohne Kategorie"])),x.forEach(r=>{t.append(e("option",{value:r.id},[r.name]))}),t.value=l.categoryId||"",t})(),$=e("input",{value:l.avgSellingPriceGrossEUR!=null?B(f(l.avgSellingPriceGrossEUR),2):"",inputmode:"decimal"}),R=e("input",{value:l.sellerboardMarginPct!=null?B(f(l.sellerboardMarginPct),2):"",inputmode:"decimal"}),Z=e("input",{value:l.productionLeadTimeDaysDefault!=null?B(f(l.productionLeadTimeDaysDefault),0):"",inputmode:"decimal"}),se=e("input",{value:l.moqUnits!=null?B(f(l.moqUnits),0):"",inputmode:"decimal"}),be=e("input",{value:l.safetyStockDohOverride!=null?B(f(l.safetyStockDohOverride),0):"",inputmode:"decimal"}),ye=e("input",{value:l.foCoverageDohOverride!=null?B(f(l.foCoverageDohOverride),0):"",inputmode:"decimal"}),we=e("input",{value:l.moqOverrideUnits!=null?B(f(l.moqOverrideUnits),0):"",inputmode:"decimal"}),he=e("input",{value:l.landedUnitCostEur!=null?B(f(l.landedUnitCostEur),2):"",inputmode:"decimal"}),J=(nn=l.template)!=null&&nn.fields?{...l.template.fields}:l.template||{};!J.transportMode&&J.transport&&(J.transportMode=J.transport);const ae=u.settings||{},Be=Number(ae.safetyStockDohDefault??60),Le=Number(ae.foCoverageDohDefault??90),Pe=Number(ae.moqDefaultUnits??500),ve=f(ae.fxRate)??f(ae.fxRate)??null,De={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,vatImportPct:19,vatRefundLag:0,fxRate:ve,fxFeePct:0,ddp:ae.defaultDdp===!0,currency:ae.defaultCurrency||"EUR"},gt=[{key:"unitPriceUsd",label:"Stückpreis (USD)",valueType:"number",decimals:2},{key:"extraPerUnitUsd",label:"Zusatz je Stück (USD)",valueType:"number",decimals:2},{key:"extraFlatUsd",label:"Zusatz pauschal (USD)",valueType:"number",decimals:2},{key:"transportMode",label:"Transport",type:"select",options:["SEA","RAIL","AIR"]},{key:"productionDays",label:"Produktionstage",valueType:"number",decimals:0},{key:"transitDays",label:"Transit-Tage",valueType:"number",decimals:0},{key:"freightEur",label:"Logistik / Stk. (EUR)",valueType:"number",decimals:2},{key:"dutyPct",label:"Zoll %",valueType:"number",decimals:2},{key:"dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox"},{key:"vatImportPct",label:"EUSt %",valueType:"number",decimals:2},{key:"vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox"},{key:"vatRefundLag",label:"EUSt-Lag (Monate)",valueType:"number",decimals:0},{key:"fxRate",label:"FX-Kurs",valueType:"number",decimals:4},{key:"fxFeePct",label:"FX-Gebühr %",valueType:"number",decimals:2},{key:"currency",label:"Currency",type:"select",options:["USD","EUR","CNY"]},{key:"ddp",label:"DDP",type:"checkbox"}],Ke=e("div",{class:"table-card-header"},[e("h4",{},["Template-Werte"]),e("button",{class:"btn secondary",type:"button",id:"product-apply-latest"},["Letzte PO Werte übernehmen"])]),Y=e("div",{class:"product-completeness-summary",hidden:!0}),Qe=e("div",{class:"product-completeness-summary-title"}),Ue=e("div",{class:"product-completeness-summary-list"});Y.append(Qe,Ue);const Ge=e("label",{},["SKU",p]),c=e("label",{},["Alias",y]),E=e("label",{},["Supplier",P]),v=e("label",{},["Kategorie",O]),j=e("label",{},["Status",S]),F=e("label",{},["ABC Klassifizierung",U]),D=e("label",{},["Ø VK-Preis (Brutto)",$]),q=e("label",{},["Sellerboard Marge (%)",R]),_=e("label",{},["Default Production Lead Time (Fallback)",Z]),re=e("label",{},["MOQ (Einheiten)",se]),V=e("label",{},["Safety Stock DOH Override (optional)",be,e("small",{class:"muted",id:"safety-stock-effective"},[])]),A=e("label",{},["FO Coverage DOH Override (optional)",ye,e("small",{class:"muted",id:"fo-coverage-effective"},[])]),H=e("label",{},["MOQ Override (optional)",we,e("small",{class:"muted",id:"moq-effective"},[])]),le=e("label",{},["Einstandspreis (EUR)",he,e("small",{class:"muted",id:"shipping-derived"},[])]);d.append(Y,Ge,c,E,v,j,F,D,q,_,re,e("hr"),e("h4",{},["Inventory Planning Overrides"]),V,A,H,le,e("hr"),Ke),[{input:$,decimals:2},{input:R,decimals:2},{input:Z,decimals:0},{input:se,decimals:0},{input:be,decimals:0},{input:ye,decimals:0},{input:we,decimals:0},{input:he,decimals:2}].forEach(({input:t,decimals:r})=>{t.addEventListener("blur",()=>{const m=f(t.value);t.value=m==null?"":B(m,r),Ne()}),t.addEventListener("input",()=>{Ne()})});const Ye=e("div",{class:"grid two"}),ke={},Gt={},bt={},yt=new Map,$t=new Map,qt="Pflichtfeld – benötigt für PO/FO & Kalkulation",Un={avgSellingPriceGrossEUR:"Empfohlen für Pricing Analytics.",sellerboardMarginPct:"Empfohlen für Pricing Analytics.",landedUnitCostEur:"Wird verfügbar nach erster PO / kann später gepflegt werden."},ht={unitPriceUsd:{min:0},extraPerUnitUsd:{min:0},extraFlatUsd:{min:0},productionDays:{min:0,integer:!0},transitDays:{min:0,integer:!0},freightEur:{min:0},dutyPct:{min:0,max:100},vatImportPct:{min:0,max:100},vatRefundLag:{min:0,integer:!0},fxRate:{min:1e-4},fxFeePct:{min:0,max:100}};function qe(t){const r=ht[t];if(!r)return!0;const m=ke[t],g=Gt[t];if(!m||!g)return!0;const k=String(m.value||"").trim();if(!k){const N=De[t];return t==="fxRate"&&(N==null||N<=0)?(g.textContent="FX-Kurs ist erforderlich.",!1):(g.textContent="",!0)}const C=f(k);return C==null?(g.textContent="Ungültiger Wert.",!1):r.integer&&!Number.isInteger(C)?(g.textContent="Bitte eine ganze Zahl eingeben.",!1):r.min!=null&&C<r.min?(g.textContent=`Wert muss ≥ ${r.min} sein.`,!1):r.max!=null&&C>r.max?(g.textContent=`Wert muss ≤ ${r.max} sein.`,!1):(g.textContent="",!0)}function Vt(){return Object.keys(ht).every(t=>qe(t))}function Ce(){const t=Vt(),m=(et||wt()).status==="blocked";Re.disabled=!t||!b.isDirty||m}const Nn=(()=>{const r=(u.pos||[]).filter(N=>String((N==null?void 0:N.sku)||"").trim().toLowerCase()===String(l.sku||"").trim().toLowerCase()).sort((N,K)=>(K.orderDate||"").localeCompare(N.orderDate||""))[0];if(!r)return"Hinweis: —";const m=f(r.freightPerUnitEur),g=f(r.units),k=f(r.freightEur),C=m??(k!=null&&g?k/g:null);return C==null||!Number.isFinite(C)?"Hinweis: —":`Hinweis: Logistik / Stk. (EUR) aus letzter PO: ${z(C,2)} €`})();function de(t,r,m){if(!r||!m)return;const g=e("small",{class:"field-required-helper",hidden:!0},[qt]);r.append(g),yt.set(t,{input:m,helper:g})}function zt(t,r,m){if(!r||!m)return;const g=e("small",{class:"field-suggested-helper",hidden:!0},[Un[t]||"Empfohlen."]);r.append(g),$t.set(t,{input:m,helper:g})}function Wt(t){const r=yt.get(t);r&&(r.input.scrollIntoView({behavior:"smooth",block:"center"}),r.input.focus({preventScroll:!0}))}gt.forEach(t=>{if(bt[t.key]=t,t.type==="checkbox"){const r=e("input",{type:"checkbox",name:t.key,checked:!!J[t.key]});ke[t.key]=r,Ye.append(e("label",{class:"inline-checkbox"},[r," ",t.label]))}else if(t.type==="select"){const r=e("select",{name:t.key});(t.options||[]).forEach(g=>{r.append(e("option",{value:g},[g]))});const m=J[t.key]??De[t.key];r.value=m||(t.options?t.options[0]:""),ke[t.key]=r,Ye.append(e("label",{},[t.label,r]))}else{const r=typeof t.decimals=="number"?t.decimals:2,m=J[t.key]??De[t.key],g=f(m),k=g!=null?B(g,r):"",C=e("input",{name:t.key,value:k,inputmode:"decimal"});C.addEventListener("blur",()=>{const te=f(C.value),pe=De[t.key],xe=te??pe;C.value=xe==null?"":B(xe,r),qe(t.key),Ce(),t.key==="unitPriceUsd"&&Ne()}),C.addEventListener("input",()=>{qe(t.key),Ce(),t.key==="unitPriceUsd"&&Ne()}),ke[t.key]=C;const N=e("small",{class:"form-error"},[]);Gt[t.key]=N;const K=e("label",{},[t.label,C,N]);t.key==="freightEur"&&K.append(e("small",{class:"muted"},[Nn])),t.key==="unitPriceUsd"&&de("unitPriceUsd",K,C),t.key==="transitDays"&&de("transitDays",K,C),t.key==="dutyPct"&&de("dutyPct",K,C),t.key==="vatImportPct"&&de("vatImportPct",K,C),Ye.append(K)}}),d.append(Ye);const jt=We("#safety-stock-effective",d),Ht=We("#fo-coverage-effective",d),Xt=We("#moq-effective",d),Ve=We("#shipping-derived",d);function Ne(){var N,K;const t=f(be.value),r=f(ye.value),m=f(we.value),g=t??Be,k=r??Le,C=m??Pe;if(jt&&(jt.textContent=`Effektiv: ${z(g,0)} Tage (Default: ${z(Be,0)})`),Ht&&(Ht.textContent=`Effektiv: ${z(k,0)} Tage (Default: ${z(Le,0)})`),Xt&&(Xt.textContent=`Effektiv: ${z(C,0)} Einheiten (Default: ${z(Pe,0)})`),Ve){const te=f((N=ke.unitPriceUsd)==null?void 0:N.value),pe=f(he.value),xe=f((K=ke.fxRate)==null?void 0:K.value)??ve,Te=on({unitPriceUsd:te,landedCostEur:pe,fxUsdPerEur:xe});Ve.innerHTML="";const nt=Te.value==null?"Logistik / Stk. (EUR, berechnet): —":`Logistik / Stk. (EUR, berechnet): ${z(Te.value,2)} €`;Ve.append(document.createTextNode(nt));const ze=Te.missingFields.map(st=>st==="landedCostEur"?"Einstandspreis (EUR)":st==="unitPriceUsd"?"Stückpreis USD":st==="fxUsdPerEur"?"FX (USD je EUR)":st);Ve.append(e("span",{class:"tooltip"},[e("button",{class:"tooltip-trigger",type:"button","aria-label":"Formel"},["ℹ️"]),e("span",{class:"tooltip-content"},["Formel: Einstandspreis (EUR) – (Stückpreis USD ÷ FX). Negative Werte werden auf 0 gesetzt.",ze.length?` Fehlend: ${ze.join(", ")}.`:""])])),Te.warning&&Ve.append(e("span",{class:"badge fo-recommendation-badge"},["Check landed cost / FX"]))}}function ee(t,r){const m=ke[t];if(!m)return;const g=bt[t]||{};if(m.type==="checkbox"){m.checked=!!r;return}if(m.tagName==="SELECT"){m.value=r!=null?String(r):m.value;return}const k=typeof g.decimals=="number"?g.decimals:2,C=f(r);m.value=C==null?"":B(C,k),qe(t)}function Rn(){var m;const t=b.draft||{};p.value=t.sku||"",y.value=t.alias||"",P.value=t.supplierId||"",S.value=t.status||"active",O.value=t.categoryId||"",U.value=it(l.abcClass),$.value=t.avgSellingPriceGrossEUR!=null?B(f(t.avgSellingPriceGrossEUR),2):"",R.value=t.sellerboardMarginPct!=null?B(f(t.sellerboardMarginPct),2):"",Z.value=t.productionLeadTimeDaysDefault!=null?B(f(t.productionLeadTimeDaysDefault),0):"",se.value=t.moqUnits!=null?B(f(t.moqUnits),0):"",be.value=t.safetyStockDohOverride!=null?B(f(t.safetyStockDohOverride),0):"",ye.value=t.foCoverageDohOverride!=null?B(f(t.foCoverageDohOverride),0):"",we.value=t.moqOverrideUnits!=null?B(f(t.moqOverrideUnits),0):"",he.value=t.landedUnitCostEur!=null?B(f(t.landedUnitCostEur),2):"";const r=(m=t.template)!=null&&m.fields?t.template.fields:t.template||{};Object.keys(ke).forEach(g=>{ee(g,r[g])}),vt.value=r.milestones?JSON.stringify(r.milestones,null,2):"",Ne(),Ct()}function An(){const t=p.value.trim();if(!t){_e("Bitte zuerst eine SKU angeben.");return}const r=(u.pos||[]).filter(N=>String((N==null?void 0:N.sku)||"").trim().toLowerCase()===t.toLowerCase()).sort((N,K)=>(K.orderDate||"").localeCompare(N.orderDate||""))[0];if(!r){_e("Keine PO vorhanden.");return}const m=f(r.freightPerUnitEur),g=f(r.units),k=f(r.freightEur),C=m??(k!=null&&g?k/g:null);ee("unitPriceUsd",r.unitCostUsd),ee("freightEur",C),ee("productionDays",r.prodDays),ee("transitDays",r.transitDays),ee("transportMode",String(r.transport||"SEA").toUpperCase()),ee("dutyPct",r.dutyRatePct),ee("vatImportPct",r.eustRatePct),ee("fxRate",r.fxOverride??ae.fxRate),ee("fxFeePct",r.fxFeePct),ee("ddp",r.ddp===!0),ee("currency","USD"),Ne(),tt(),_e("Letzte PO Werte übernommen.")}const vt=e("textarea",{placeholder:"Milestones im JSON-Format (optional)",value:J.milestones?JSON.stringify(J.milestones,null,2):"",rows:6,style:"width:100%; margin-top:12px;"});d.append(e("label",{},["Meilensteine (JSON)",vt]));const In=e("div",{class:"product-history"},[e("h4",{},["Historie"]),fn(u,l.sku)]),Tn=e("div",{class:"product-suppliers"},[e("h4",{},["Suppliers"]),e("p",{class:"muted"},["SKU-Mappings wurden entfernt. Lieferanten und Preise werden direkt im Produktstamm gepflegt."])]),Re=e("button",{class:"btn",type:"submit"},["Speichern"]),Zt=e("button",{class:"btn secondary",type:"button"},["Abbrechen"]);let kt,et=lt(l,{state:u});h.register(),h.attachBeforeUnload();function Jt(){h.unregister(),h.detachBeforeUnload(),s.__productsBulkGuard&&s.__productsBulkGuard.register(),kt.overlay.remove()}function Qt(){if(!b.isDirty){Jt();return}h({confirmWithModal:({onConfirm:t})=>xt({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{b.discardDraft(),t==null||t(),Jt()}})})}kt=mn({title:n?`Produkt bearbeiten – ${n.alias||n.sku}`:"Neues Produkt",content:e("div",{},[d,In,Tn]),actions:[Zt,Re],onClose:Qt}),Zt.addEventListener("click",Qt),Re.addEventListener("click",t=>{t.preventDefault(),d.requestSubmit()});const St=b.loadDraftIfAvailable();St!=null&&St.exists&&xt({title:"Entwurf gefunden",message:"Es gibt einen ungespeicherten Entwurf. Wiederherstellen?",confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{b.restoreDraft(),Rn(),tt()},onCancel:()=>{b.discardDraft(),Ce()}});const Yt=We("#product-apply-latest",d);Yt&&Yt.addEventListener("click",An),de("sku",Ge,p),de("alias",c,y),de("categoryId",v,O),de("moqUnits",re,se),de("productionLeadTimeDaysDefault",_,Z),de("avgSellingPriceGrossEUR",D,$),zt("sellerboardMarginPct",q,R),zt("landedUnitCostEur",le,he),Object.keys(ht).forEach(t=>qe(t)),Ct(),Ne(),a&&requestAnimationFrame(()=>Wt(a));function _n({strict:t}={}){const r=vt.value.trim();if(!r)return null;try{const m=JSON.parse(r);if(!Array.isArray(m))return null;const g=m.reduce((k,C)=>k+Number(C.percent||0),0);if(t&&Math.round(g)!==100)throw new Error("Meilensteine müssen in Summe 100 % ergeben.");return m}catch(m){if(t)throw m;return null}}function Et({strictMilestones:t=!1}={}){var N,K;const r={sku:p.value.trim(),alias:y.value.trim(),supplierId:P.value.trim(),categoryId:O.value.trim()||null,status:S.value,tags:Array.isArray(l.tags)?[...l.tags]:[],avgSellingPriceGrossEUR:f($.value.trim()),sellerboardMarginPct:f(R.value.trim()),productionLeadTimeDaysDefault:f(Z.value.trim()),moqUnits:f(se.value.trim()),safetyStockDohOverride:f(be.value.trim()),foCoverageDohOverride:f(ye.value.trim()),moqOverrideUnits:f(we.value.trim()),landedUnitCostEur:f(he.value.trim())};n!=null&&n.sku&&(r.originalSku=n.sku);const m={};Object.entries(ke).forEach(([te,pe])=>{if(!pe)return;if(pe.type==="checkbox"){m[te]=pe.checked;return}if(pe.tagName==="SELECT"){m[te]=pe.value;return}const xe=pe.value.trim(),Te=bt[te]||{};if(xe===""){const ze=De[te];ze!=null&&(m[te]=ze);return}if(Te.valueType==="text"){m[te]=xe;return}const nt=f(xe);nt!=null&&(m[te]=nt)});const g=_n({strict:t});g&&(m.milestones=g),Object.keys(m).length?r.template={scope:((N=n==null?void 0:n.template)==null?void 0:N.scope)||"SKU",name:((K=n==null?void 0:n.template)==null?void 0:K.name)||"Standard (SKU)",fields:m}:r.template=null;const k=m.fxRate??ve,C=on({unitPriceUsd:m.unitPriceUsd??null,landedCostEur:r.landedUnitCostEur,fxUsdPerEur:k});return r.fxUsdPerEur=k??null,r.logisticsPerUnitEur=C.value,r.freightPerUnitEur=C.value,r}function wt(){const t=Et();return lt(t,{state:u})}function On(t){if(!t)return"";if(t.fieldKey==="unitPriceUsd"&&t.value){const r=z(t.value.amount,2),m=t.value.currency||"";return`Default aktiv: ${r} ${m}`.trim()}return t.fieldKey==="moqUnits"?`Default aktiv: ${z(t.value,0)} Einheiten`:t.fieldKey==="productionLeadTimeDaysDefault"||t.fieldKey==="transitDays"?`Default aktiv: ${z(t.value,0)} Tage`:t.fieldKey==="dutyPct"||t.fieldKey==="vatImportPct"?`Default aktiv: ${z(t.value,2)} %`:"Default aktiv"}function en(t){const r=t.blockingMissing||[],m=t.defaulted||[];if(Ue.innerHTML="",r.length){Y.hidden=!1,Y.classList.add("blocked"),Y.classList.remove("warn"),Qe.textContent=`Blockiert: ${r.length} Pflichtfelder fehlen`,r.forEach(g=>{const k=e("button",{class:"btn secondary sm",type:"button"},[g.label]);k.addEventListener("click",()=>Wt(g.fieldKey)),Ue.append(k)});return}if(m.length){Y.hidden=!1,Y.classList.add("warn"),Y.classList.remove("blocked"),Qe.textContent="Hinweis: Defaults aktiv",m.forEach(g=>{const k=e("span",{class:"btn secondary sm"},[g.label]);Ue.append(k)});return}Y.hidden=!0,Y.classList.remove("blocked","warn")}function tn(t){const r=new Set((t.blockingMissing||[]).map(k=>k.fieldKey)),m=new Map((t.defaulted||[]).map(k=>[k.fieldKey,k]));yt.forEach((k,C)=>{const N=r.has(C),K=m.get(C);if(k.input.classList.toggle("field-missing-required",N),k.input.setAttribute("aria-invalid",N?"true":"false"),N){k.helper.textContent=qt,k.helper.classList.add("is-missing"),k.helper.classList.remove("is-defaulted"),k.helper.hidden=!1;return}if(K){k.helper.textContent=On(K),k.helper.classList.add("is-defaulted"),k.helper.classList.remove("is-missing"),k.helper.hidden=!1;return}k.helper.textContent="",k.helper.classList.remove("is-missing","is-defaulted"),k.helper.hidden=!0});const g=new Set((t.suggestedMissing||[]).map(k=>k.fieldKey));$t.forEach((k,C)=>{const N=g.has(C);k.helper.hidden=!N})}function Ct(){et=wt(),tn(et),en(et),Ce()}function tt(){const t=Et();b.setDraft(t),Ct()}d.addEventListener("submit",async t=>{if(t.preventDefault(),!Vt()){Ce();return}const r=wt();if(r.status==="blocked"){tn(r),en(r),_e("Bitte Pflichtfelder ergänzen."),Ce();return}Re.disabled=!0,Re.textContent="Speichern…";let m;try{m=Et({strictMilestones:!0})}catch(g){alert(g.message||String(g)),Re.textContent="Speichern",Ce();return}try{await b.commit(()=>an(m)),kt.overlay.remove(),je(s)}catch(g){alert(g.message||String(g)),Re.textContent="Speichern",Ce()}}),d.addEventListener("input",tt),d.addEventListener("change",tt)}function Ln(n){if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const i=Je(),u=ft(n),l=[];u.forEach(a=>{const p=!!i[a.id];l.push({id:`group-${a.id}`,isGroup:!0,categoryId:a.id,categoryName:a.name,count:a.items.length,collapsed:p}),!p&&a.items.forEach(y=>{l.push({id:`product-${y.sku}`,isGroup:!1,product:y})})});const b=[{key:"alias",title:"Alias",dataIndex:"alias",width:230,fixed:"left",onCell:a=>a.isGroup?{colSpan:14}:{},render:(a,p)=>{if(p.isGroup)return W.createElement("button",{className:"product-group-toggle",type:"button","aria-expanded":String(!p.collapsed),onClick:()=>{const S=Je();S[p.categoryId]=!p.collapsed,mt(S),X()}},`${p.categoryName} (${p.count})`);const y=p.product,P=y.alias||"—";return W.createElement("div",{className:"data-health-inline"},[Cn(y.sku),W.createElement("span",{className:"truncate-text"},P),y.status==="inactive"?W.createElement("span",{className:"badge muted"},"inaktiv"):null])}},{key:"sku",title:"SKU",dataIndex:"sku",width:130,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>p.isGroup?null:p.product.sku||"—"},{key:"supplier",title:"Supplier",dataIndex:"supplier",width:180,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{if(p.isGroup)return null;const y=p.product;return oe.get(y.supplierId)||y.supplierId||"—"}},{key:"category",title:"Kategorie",dataIndex:"category",width:150,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>p.isGroup?null:Ft(p.product.categoryId)},{key:"status",title:"Status",dataIndex:"status",width:100,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>p.isGroup?null:p.product.status==="inactive"?W.createElement("span",{className:"badge muted"},"inaktiv"):W.createElement("span",{className:"badge"},"aktiv")},{key:"abcClass",title:"ABC",dataIndex:"abcClass",width:70,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{if(p.isGroup)return null;const y=it(p.product.abcClass);return W.createElement("span",{className:y==="—"?"badge muted":"badge"},y)}},{key:"completeness",title:"Vollständigkeit",dataIndex:"completeness",width:130,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>p.isGroup?null:wn(p.product)},{key:"moqUnits",title:"MOQ",tooltip:"Minimum Order Quantity",dataIndex:"moqUnits",width:90,numeric:!0,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{if(p.isGroup)return null;const y=It(p.product);return Number.isFinite(y)?Number(y).toLocaleString("de-DE"):"—"}},{key:"lastPo",title:"Letzte PO",dataIndex:"lastPo",width:110,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{var y;return p.isGroup?null:(y=p.product.stats)!=null&&y.lastOrderDate?gn(p.product.stats.lastOrderDate):"—"}},{key:"avg",title:"Ø Stückpreis",dataIndex:"avg",width:120,numeric:!0,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{var y;return p.isGroup?null:((y=p.product.stats)==null?void 0:y.avgUnitPriceUsd)!=null?bn(p.product.stats.avgUnitPriceUsd):"—"}},{key:"count",title:"POs",dataIndex:"count",width:80,numeric:!0,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{var y;return p.isGroup?null:String(((y=p.product.stats)==null?void 0:y.poCount)??0)}},{key:"template",title:"Template",dataIndex:"template",width:100,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>p.isGroup?null:p.product.template?W.createElement("span",{className:"badge"},"vorhanden"):W.createElement("span",{className:"badge muted"},"—")},{key:"actions",title:"Aktionen",dataIndex:"actions",width:170,fixed:"right",ellipsis:!1,onCell:a=>a.isGroup?{colSpan:0}:{},render:(a,p)=>{if(p.isGroup)return null;const y=p.product;return W.createElement("div",{className:"table-actions"},[W.createElement("button",{className:"btn secondary sm",type:"button",onClick:()=>Fe(y)},"Bearbeiten"),W.createElement("button",{className:"btn secondary sm",type:"button","aria-haspopup":"menu","aria-expanded":"false",onClick:P=>{P.stopPropagation(),xn(P.currentTarget,y)}},"Mehr…")])}}],h=e("div",{class:"table-wrap ui-table-shell ui-scroll-host products-list products-list-antd"}),d=e("div",{class:"products-list-react-mount"});return h.append(d),s.__productsListReactRoot=Gn(d),s.__productsListReactRoot.render(W.createElement(Jn,{className:"products-list-table-antd",columns:b,dataSource:l,rowKey:"id",rowClassName:a=>a.isGroup?"product-group-row":"product-product-row"})),s.__productsListScrollCleanup=null,h}function Pn(n,{key:i,colgroup:u=null,widths:l=[]}={}){if(!n)return;const b=n.querySelector("thead tr:last-child");if(!b)return;const h=Array.from(b.querySelectorAll("th"));if(!h.length)return;n.style.tableLayout="fixed",h.forEach((P,S)=>{if(P.querySelector(".col-resizer"))return;const U=e("span",{class:"col-resizer","aria-hidden":"true"});P.append(U),P.dataset.colIndex=String(S)});const d=u?Array.from(u.children):null;h.forEach((P,S)=>{const U=l[S];if(Number.isFinite(U)){P.style.width=`${U}px`,d&&d[S]&&(d[S].style.width=`${U}px`);return}const O=P.getBoundingClientRect().width;O&&(P.style.width=`${O}px`,d&&d[S]&&(d[S].style.width=`${O}px`))});let a=null;function p(P){if(!a)return;const S=P.clientX-a.startX,U=Math.max(a.minWidth,a.startWidth+S);a.th.style.width=`${U}px`,a.col&&(a.col.style.width=`${U}px`)}function y(){if(!a)return;document.removeEventListener("pointermove",p),document.removeEventListener("pointerup",y);const P=h.map((S,U)=>d&&d[U]?d[U].getBoundingClientRect().width:S.getBoundingClientRect().width);i&&$n(i,P),a=null,n.classList.remove("is-resizing")}n.addEventListener("pointerdown",P=>{const S=P.target.closest(".col-resizer");if(!S)return;const U=S.closest("th");if(!U)return;P.preventDefault();const O=Number(U.dataset.colIndex),$=d&&Number.isFinite(O)?d[O]:null,R=U.getBoundingClientRect().width;a={th:U,col:$,startX:P.clientX,startWidth:R,minWidth:80},n.classList.add("is-resizing"),document.addEventListener("pointermove",p),document.addEventListener("pointerup",y)})}function Dn(n){var Ue,Ge;if(!n.length)return e("p",{class:"empty-state"},["Keine Produkte gefunden. Lege ein Produkt an oder erfasse eine PO."]);const i=o.settings||{},l={unitPriceUsd:0,extraPerUnitUsd:0,extraFlatUsd:0,transportMode:"SEA",productionDays:0,transitDays:0,freightEur:0,dutyPct:0,dutyIncludesFreight:!1,vatImportPct:19,vatRefundActive:!1,vatRefundLag:0,fxRate:f(i.fxRate)??null??0,fxFeePct:0,ddp:i.defaultDdp===!0,currency:i.defaultCurrency||"EUR"},h=(Array.isArray(o.suppliers)?o.suppliers:[]).map(c=>({value:String(c.id||"").trim(),label:oe.get(c.id)||c.name||c.id||"—"})).filter(c=>c.value),d=x.map(c=>({value:String(c.id),label:c.name||"Ohne Kategorie"})),a=[{key:"alias",label:"Alias",type:"text",width:"240px",className:"col-alias"},{key:"sku",label:"SKU",type:"text",width:"160px",readOnly:!0,className:"col-sku"},{key:"supplierId",label:"Supplier",type:"select",options:h,width:"180px",className:"col-supplier"},{key:"categoryId",label:"Kategorie",type:"select",options:[{value:"",label:"Ohne Kategorie"},...d],width:"180px",className:"col-category"},{key:"status",label:"Status",type:"select",options:[{value:"active",label:"Aktiv"},{value:"inactive",label:"Inaktiv"}],width:"110px",className:"col-status"},{key:"abcClass",label:"ABC",type:"display",width:"80px",className:"col-abc"},{key:"completeness",label:"Vollständigkeit",type:"display",width:"160px",className:"col-completeness"},{key:"avgSellingPriceGrossEUR",label:"Ø VK-Preis (Brutto)",type:"number",decimals:2,width:"150px",className:"col-amount"},{key:"sellerboardMarginPct",label:"Sellerboard Marge (%)",type:"number",decimals:2,width:"140px",className:"col-short"},{key:"productionLeadTimeDaysDefault",label:"Default Production Lead Time (Fallback)",type:"number",decimals:0,width:"170px",className:"col-days"},{key:"moqUnits",label:"MOQ (Einheiten)",type:"number",decimals:0,width:"120px",className:"col-short col-group-end"},{key:"template.unitPriceUsd",label:"Stückpreis (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraPerUnitUsd",label:"Zusatz je Stück (USD)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.extraFlatUsd",label:"Zusatz pauschal (USD)",type:"number",decimals:2,width:"140px",className:"col-amount col-group-end"},{key:"template.transportMode",label:"Transport",type:"select",options:[{value:"SEA",label:"SEA"},{value:"RAIL",label:"RAIL"},{value:"AIR",label:"AIR"}],width:"130px",className:"col-transport"},{key:"template.productionDays",label:"Produktionstage",type:"number",decimals:0,width:"120px",className:"col-days"},{key:"template.transitDays",label:"Transit-Tage",type:"number",decimals:0,width:"120px",className:"col-days col-group-end"},{key:"template.freightEur",label:"Logistik / Stk. (EUR)",type:"number",decimals:2,width:"140px",className:"col-amount"},{key:"template.dutyPct",label:"Zoll %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.dutyIncludesFreight",label:"Fracht einbeziehen",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatImportPct",label:"EUSt %",type:"number",decimals:2,width:"90px",className:"col-short"},{key:"template.vatRefundActive",label:"EUSt-Erstattung aktiv",type:"checkbox",width:"56px",className:"col-check"},{key:"template.vatRefundLag",label:"EUSt-Lag",type:"number",decimals:0,width:"80px",className:"col-short col-group-end"},{key:"template.fxRate",label:"FX-Kurs",type:"number",decimals:4,width:"140px",className:"col-amount"},{key:"template.fxFeePct",label:"FX-Gebühr %",type:"number",decimals:2,width:"90px",className:"col-short col-group-end"},{key:"template.currency",label:"Currency",type:"select",options:[{value:"USD",label:"USD"},{value:"EUR",label:"EUR"},{value:"CNY",label:"CNY"}],width:"110px",className:"col-currency"},{key:"template.ddp",label:"DDP",type:"checkbox",width:"56px",className:"col-check col-group-end"}];function p(c){var v;const E=((v=c.template)==null?void 0:v.fields)||c.template||{};return{...l,...E}}function y(c,E){if(E.key.startsWith("template.")){const v=E.key.replace("template.","");return p(c)[v]}if(E.key==="categoryId")return c.categoryId||"";if(E.key==="abcClass")return it(c.abcClass);if(E.key==="completeness")return Ze(c);if(E.key==="moqUnits"){const v=It(c);return v??""}return c[E.key]??""}function P(c,E){if(E.type==="number"){const v=f(c);return v==null?"":B(v,E.decimals??2)}return E.type==="display"?c:E.type==="checkbox"?!!c:c??""}function S(c,E){return E.type==="number"?f(c):E.type==="display"?c:E.type==="checkbox"?!!c:String(c??"").trim()}function U(c){return ge[c]||(ge[c]={}),ge[c]}function O(c,E){const v=ge[c];v&&(delete v[E],Object.keys(v).length||delete ge[c])}function $(){return Object.values(ge).reduce((c,E)=>c+Object.keys(E||{}).length,0)}const R=e("div",{class:"products-grid-toolbar"}),Z=e("select",{onchange:c=>{Xe=c.target.value,rt(He,{mode:Xe}),X()}},[e("option",{value:"category"},["Sortierung: Kategorie"]),e("option",{value:"abc"},["Sortierung: ABC (A → C)"])]);Z.value=Xe;const se=e("span",{class:"muted"},["0 Änderungen"]),be=e("button",{class:"btn",type:"button",disabled:!0},["Änderungen speichern"]),ye=e("button",{class:"btn secondary",type:"button",disabled:!0},["Änderungen verwerfen"]);R.append(Z,se,e("div",{class:"products-grid-actions"},[ye,be]));function we(){const c=$();se.textContent=`${c} Änderungen`,be.disabled=c===0,ye.disabled=c===0}function he(c){const E=!!c.querySelector("td.is-dirty");c.classList.toggle("is-dirty",E)}function J(c,E,v){var re;const j=v.type==="checkbox"?c.checked:c.value;v.type==="select"&&(c.title=((re=c.options[c.selectedIndex])==null?void 0:re.textContent)||String(j??""));const F=S(j,v),D=S(y(E,v),v),q=v.type==="number"?Number(F)!==Number(D):F!==D;if(q){const V=U(E.sku);V[v.key]=F}else O(E.sku,v.key);const _=c.closest("td");if(_){_.classList.toggle("is-dirty",q);const V=_.closest("tr");V&&he(V)}we(),ce.setDraft(ce.draft)}const ae=e("div",{class:"products-grid"}),Be=e("div",{class:"products-grid-scroll ui-table-shell ui-scroll-host"}),Le=e("table",{class:"products-grid-table ui-table-standard","data-ui-table":"true","data-sticky-cols":"1"}),Pe=e("colgroup"),ve=((Ge=(Ue=o==null?void 0:o.settings)==null?void 0:Ue.productsTableColumns)==null?void 0:Ge.grid)||[];a.forEach((c,E)=>{const v=Number.isFinite(ve[E])?`${ve[E]}px`:c.width;Pe.append(e("col",{style:v?`width:${v}`:null}))});const De=Number.isFinite(ve[a.length])?`${ve[a.length]}px`:"180px";Pe.append(e("col",{style:`width:${De}`}));const gt=e("thead",{},[e("tr",{class:"products-grid-group-header"},[e("th",{colspan:"10",title:"Stammdaten"},["Stammdaten"]),e("th",{colspan:"3",title:"Kosten"},["Kosten"]),e("th",{colspan:"4",title:"Logistik"},["Logistik"]),e("th",{colspan:"5",title:"Steuern"},["Steuern"]),e("th",{colspan:"3",title:"FX & Währung"},["FX & Währung"]),e("th",{colspan:"1",title:"Sonstiges"},["Sonstiges"]),e("th",{colspan:"1",title:"Tags"},["Tags"]),e("th",{colspan:"1",class:"actions",title:"Aktionen"},["Aktionen"])]),e("tr",{},[...a.map(c=>e("th",{class:c.className||"",title:c.label},[c.label])),e("th",{class:"actions",title:"Aktionen"},["Aktionen"])])]),Ke=e("tbody"),Y=Je();return ft(n,{sortMode:Xe}).forEach(c=>{const E=!!Y[c.id];Ke.append(e("tr",{class:"product-group-row"},[e("td",{colspan:String(a.length+1)},[e("button",{class:"product-group-toggle",type:"button",dataset:{categoryId:c.id},"aria-expanded":String(!E)},[`${c.name} (${c.items.length})`])])])),!E&&c.items.forEach(v=>{const j=e("tr");a.forEach(D=>{var re,V;const q=e("td",{class:D.className||""}),_=((re=ge[v.sku])==null?void 0:re[D.key])??y(v,D);if(D.type==="display")q.append(En(v));else if(D.type==="checkbox"){const A=e("input",{type:"checkbox",checked:!!_,onchange:()=>J(A,v,D),title:D.label});q.append(A)}else if(D.type==="select"){const A=e("select",{onchange:()=>J(A,v,D)}),H=D.options||[],le=String(_??"");["supplierId","status","categoryId","template.transportMode","template.currency"].includes(D.key)&&(A.title=le),!H.some($e=>$e.value===le)&&le&&A.append(e("option",{value:le},[le])),H.forEach($e=>{A.append(e("option",{value:$e.value},[$e.label]))}),A.value=le,A.title=((V=A.options[A.selectedIndex])==null?void 0:V.textContent)||le,q.append(A)}else{const A=e("input",{value:P(_,D),inputmode:D.type==="number"?"decimal":"text",readonly:D.readOnly?"readonly":null,title:["alias","sku","supplierId"].includes(D.key)?String(_??""):null,oninput:()=>J(A,v,D),onblur:()=>{if(D.type==="number"){const H=f(A.value);A.value=H==null?"":B(H,D.decimals??2)}}});if(D.key==="alias"){const H=yn(v.sku);H&&q.append(H)}q.append(A)}if(D.type!=="display"){const A=S(y(v,D),D),H=S(_,D);(D.type==="number"?Number(H)!==Number(A):H!==A)&&q.classList.add("is-dirty")}j.append(q)});const F=e("td",{class:"actions"},[e("button",{class:"btn secondary",type:"button",onclick:()=>Fe(v)},["Bearbeiten"]),e("button",{class:"btn tertiary",type:"button",onclick:()=>Kt(v)},["Historie"])]);j.append(F),he(j),Ke.append(j)})}),Le.append(Pe,gt,Ke),Pn(Le,{key:"grid",colgroup:Pe,widths:ve}),Be.append(Le),ae.append(R,Be),we(),Le.addEventListener("click",c=>{const E=c.target.closest(".product-group-toggle");if(!E)return;const v=Je(),j=E.dataset.categoryId;v[j]=!v[j],mt(v),X()}),ye.addEventListener("click",()=>{ce.resetDraft(),X()}),be.addEventListener("click",async()=>{const c=Object.entries(ge);if(!c.length)return;const E=[];await Promise.allSettled(c.map(([v,j])=>{var re;const F=Kn(v);if(!F)return E.push(v),Promise.resolve();const D=Object.keys(j).some(V=>V.startsWith("template.")),q=D?p(F):null,_={sku:F.sku,alias:F.alias,supplierId:F.supplierId,categoryId:F.categoryId??null,status:F.status,tags:Array.isArray(F.tags)?[...F.tags]:[],template:F.template?{...F.template}:null,avgSellingPriceGrossEUR:F.avgSellingPriceGrossEUR??null,sellerboardMarginPct:F.sellerboardMarginPct??null,originalSku:F.sku};Object.entries(j).forEach(([V,A])=>{if(V.startsWith("template.")){const H=V.replace("template.","");_.template||(_.template={scope:"SKU",name:"Standard (SKU)",fields:{}}),_.template.fields||(_.template.fields={...q}),_.template.fields[H]=A}else V==="categoryId"?_.categoryId=A?String(A):null:_[V]=A}),D&&((re=_.template)!=null&&re.fields)&&q&&(_.template.fields={...q,..._.template.fields});try{an(_)}catch{E.push(v)}})),E.length?_e(`Fehler bei SKUs: ${E.join(", ")}`):_e("Änderungen gespeichert"),ce.resetDraft(),X()}),ae}function Kt(n){const i=Lt(),u=fn(i,n.sku),l=e("button",{class:"btn",type:"button"},["Schließen"]),b=mn({title:`Historie – ${n.alias||n.sku}`,content:u,actions:[l],onClose:()=>{}});l.addEventListener("click",()=>b.overlay.remove())}function X(){const n=s.querySelector('input[type="search"]'),i=document.activeElement===n,u=i?n.selectionStart:null;typeof s.__productsListScrollCleanup=="function"&&(s.__productsListScrollCleanup(),s.__productsListScrollCleanup=null),s.__productsListReactRoot&&(s.__productsListReactRoot.unmount(),s.__productsListReactRoot=null),s.innerHTML="";const l=vn(w,G,Se,Ae),b=w.filter(R=>R.alias.startsWith("Ohne Alias")).length,h=e("div",{class:"products-header ui-page-head"}),d=e("h2",{},["Produkte"]),a=e("div",{class:"products-actions"}),p=e("button",{class:"btn",type:"button",onclick:()=>Fe(null)},["+ Produkt anlegen"]),y=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!1),X()}},["Alles auf"]),P=e("button",{class:"btn secondary",type:"button",onclick:()=>{Bt(!0),X()}},["Alles zu"]),S=e("input",{type:"search",placeholder:"Suche nach Alias, SKU, Supplier",value:G,oninput:R=>{G=R.target.value,X()}}),U=e("select",{class:"products-completeness-filter",onchange:R=>{Se=R.target.value,rt(me,{filter:Se}),X()}},[e("option",{value:"all"},["Alle Vollständigkeiten"]),e("option",{value:"blocked"},["Nur Blockierte"]),e("option",{value:"warn"},["Nur Warnungen"]),e("option",{value:"ok"},["Nur Vollständige"])]);U.value=Se==="warning"?"warn":Se;const O=e("select",{class:"products-abc-filter",onchange:R=>{Ae=R.target.value,rt(fe,{filter:Ae}),X()}},[e("option",{value:"all"},["ABC: Alle"]),...Dt.map(R=>e("option",{value:R},[`ABC: ${R}`]))]);O.value=Ae;const $=e("div",{class:"view-toggle"},[e("button",{type:"button",class:`btn tertiary${Q==="list"?" is-active":""}`,"aria-pressed":Q==="list",onclick:()=>{Q="list",ln("productsView",Q),X()}},["Liste"]),e("button",{type:"button",class:`btn tertiary${Q==="table"?" is-active":""}`,"aria-pressed":Q==="table",onclick:()=>{Q="table",ln("productsView",Q),X()}},["Tabelle"])]);a.append(S,U,O,y,P,$,p),h.append(d,a),s.append(h),b&&s.append(e("div",{class:"banner info"},[`${b} Produkte ohne Alias – bitte ergänzen.`])),s.append(Q==="table"?Dn(l):Ln(l)),i&&(S.focus(),u!=null&&S.setSelectionRange(u,u))}X()}function bs(s){const o=()=>je(s);return s.__productsCleanup&&s.__productsCleanup(),document.addEventListener("state:changed",o),s.__productsCleanup=()=>{typeof s.__productsListScrollCleanup=="function"&&(s.__productsListScrollCleanup(),s.__productsListScrollCleanup=null),s.__productsListReactRoot&&(s.__productsListReactRoot.unmount(),s.__productsListReactRoot=null),document.removeEventListener("state:changed",o),s.__productsActionsCleanup&&(s.__productsActionsCleanup(),s.__productsActionsCleanup=null),s.__productsBulkGuard&&(s.__productsBulkGuard.unregister(),s.__productsBulkGuard.detachBeforeUnload(),s.__productsBulkGuard=null)},je(s),{cleanup:s.__productsCleanup}}export{bs as default};
