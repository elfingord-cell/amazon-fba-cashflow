import{ac as X,t as u,a6 as s,ae as J,af as Y,k as e,M as h,a7 as N,V as z,J as H,N as C,I as A,U as j,S as T}from"./index-BX0hCHd9.js";import{T as Q}from"./TanStackGrid-BGkv20_p.js";import{u as Z,C as U}from"./workspace-C5RCXX1l.js";import{u as ee}from"./modalCollaboration-C9VAZcdI.js";import{T as O}from"./index-DVmxEQnU.js";import{S as M}from"./index-DzJjwXuy.js";import"./Dropdown-Dqfaj-V1.js";const{Paragraph:te,Text:ae,Title:$}=H,re=["EXW","FOB","DDP","FCA"],ne=["EUR","USD","CNY"],F=["ORDER_DATE","PRODUCTION_END","ETD","ETA"];function se(){return new Date().toISOString()}function ie(i){return`${i}-${Math.random().toString(36).slice(2,9)}`}function le(){return[{label:"Deposit",percent:30,triggerEvent:"ORDER_DATE",offsetDays:0},{label:"Balance",percent:70,triggerEvent:"ETD",offsetDays:0}]}function B(i){return(Array.isArray(i)?i:[]).map(b=>{const m=b||{};return{label:String(m.label||"Milestone"),percent:Math.min(100,Math.max(0,Number(m.percent)||0)),triggerEvent:F.includes(String(m.triggerEvent||""))?String(m.triggerEvent):"ORDER_DATE",offsetDays:Number(m.offsetDays)||0}})}function oe(i){return i.length?i.map(o=>`${o.percent}% @ ${o.triggerEvent}${o.offsetDays?` ${o.offsetDays>=0?"+":""}${o.offsetDays}`:""}`).join(", "):"—"}function De(){const{state:i,loading:o,saving:b,error:m,lastSavedAt:k,saveWith:E}=Z(),d=X(),[g,D]=u.useState(!1),[x,S]=u.useState(null),[c]=s.useForm(),R=i.settings||{},w=u.useMemo(()=>J(R),[R]),V=u.useMemo(()=>Y({userId:d.userId,userEmail:d.email},w),[w,d.email,d.userId]),W=u.useMemo(()=>`suppliers:edit:${String(x||"new")}`,[x]),a=ee({workspaceId:d.workspaceId,modalScope:W,isOpen:g,userId:d.userId,userEmail:d.email,userDisplayName:V,displayNames:w}),K=u.useMemo(()=>(Array.isArray(i.suppliers)?i.suppliers:[]).map(l=>{const r=l;return{id:String(r.id||""),name:String(r.name||""),company_name:String(r.company_name||""),productionLeadTimeDaysDefault:Number(r.productionLeadTimeDaysDefault)||0,incotermDefault:String(r.incotermDefault||"EXW"),currencyDefault:String(r.currencyDefault||"EUR"),paymentTermsDefault:B(r.paymentTermsDefault),updatedAt:r.updatedAt?String(r.updatedAt):null}}).sort((l,r)=>l.name.localeCompare(r.name)),[i.suppliers]),q=u.useMemo(()=>[{header:"Name",accessorKey:"name",meta:{width:190}},{header:"Company",accessorKey:"company_name",meta:{width:240}},{header:"Prod. Lead (Tage)",accessorKey:"productionLeadTimeDaysDefault",meta:{width:118,align:"right"}},{header:"Incoterm",accessorKey:"incotermDefault",meta:{width:96}},{header:"Currency",accessorKey:"currencyDefault",meta:{width:96}},{header:"Payment Terms",meta:{width:260},cell:({row:t})=>oe(t.original.paymentTermsDefault)},{header:"Aktualisiert",meta:{width:108},cell:({row:t})=>t.original.updatedAt?new Date(t.original.updatedAt).toLocaleDateString("de-DE"):"—"},{header:"Aktionen",meta:{width:190,minWidth:190},cell:({row:t})=>e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(h,{size:"small",onClick:()=>{S(t.original.id),c.setFieldsValue({id:t.original.id,name:t.original.name,company_name:t.original.company_name,productionLeadTimeDaysDefault:t.original.productionLeadTimeDaysDefault,incotermDefault:t.original.incotermDefault,currencyDefault:t.original.currencyDefault,paymentTermsDefault:t.original.paymentTermsDefault}),D(!0)},children:"Bearbeiten"}),e.jsx(h,{size:"small",danger:!0,onClick:()=>{N.confirm({title:`Lieferant "${t.original.name}" loeschen?`,onOk:async()=>{await E(l=>{const r=z(l);return r.suppliers=(Array.isArray(r.suppliers)?r.suppliers:[]).filter(n=>String(n.id||"")!==t.original.id),r},"v2:suppliers:delete")}})},children:"Loeschen"})]})}],[c,E]);u.useEffect(()=>{!g||!a.readOnly||!a.remoteDraftPatch||c.setFieldsValue(a.remoteDraftPatch)},[c,a.readOnly,a.remoteDraftPatch,a.remoteDraftVersion,g]);async function G(t){if(a.readOnly)throw new Error("Dieser Lieferant wird gerade von einem anderen Nutzer bearbeitet.");const l=B(t.paymentTermsDefault),r=l.reduce((p,y)=>p+y.percent,0);if(Math.round(r)!==100)throw new Error("Payment Terms muessen insgesamt 100% ergeben.");const n=t.name.trim().toLowerCase();await E(p=>{const y=z(p),f=Array.isArray(y.suppliers)?[...y.suppliers]:[];if(f.some(L=>{const _=L;return String(_.name||"").trim().toLowerCase()===n&&String(_.id||"")!==String(t.id||"")}))throw new Error("Supplier-Name muss eindeutig sein.");const P=se(),v={id:t.id||ie("sup"),name:t.name.trim(),company_name:t.company_name.trim(),productionLeadTimeDaysDefault:Math.max(0,Math.round(t.productionLeadTimeDaysDefault||0)),incotermDefault:t.incotermDefault,currencyDefault:t.currencyDefault,paymentTermsDefault:l,updatedAt:P},I=f.findIndex(L=>String(L.id||"")===v.id);return I>=0?f[I]={...f[I],...v}:f.push({...v,createdAt:P,skuOverrides:{}}),y.suppliers=f,y},x?"v2:suppliers:update":"v2:suppliers:create"),a.clearDraft(),D(!1),S(null),c.resetFields()}return e.jsxs("div",{className:"v2-page",children:[e.jsxs(U,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx($,{level:3,children:"Suppliers"}),e.jsx(te,{children:"Lieferantenverwaltung inkl. Payment Terms mit Triggern fuer PO-Events."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(h,{type:"primary",onClick:()=>{S(null),c.setFieldsValue({id:void 0,name:"",company_name:"",productionLeadTimeDaysDefault:30,incotermDefault:"EXW",currencyDefault:"EUR",paymentTermsDefault:le()}),D(!0)},children:"Lieferant hinzufuegen"}),b?e.jsx(C,{color:"processing",children:"Speichern..."}):null,k?e.jsxs(C,{color:"green",children:["Gespeichert: ",new Date(k).toLocaleTimeString("de-DE")]}):null]})})]}),m?e.jsx(A,{type:"error",showIcon:!0,message:m}):null,o?e.jsx(A,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsx(U,{children:e.jsx(Q,{data:K,columns:q,minTableWidth:1320,tableLayout:"auto"})}),e.jsxs(N,{title:x?"Lieferant bearbeiten":"Lieferant hinzufuegen",open:g,onCancel:()=>{a.clearDraft(),D(!1)},onOk:()=>{if(a.readOnly){N.warning({title:"Nur Lesemodus",content:`${a.remoteUserLabel||"Kollege"} bearbeitet diesen Lieferanten. Bitte Bearbeitung übernehmen oder warten.`});return}c.validateFields().then(t=>G(t)).catch(()=>{})},width:980,children:[a.banner?e.jsx(A,{style:{marginBottom:10},type:a.banner.tone,showIcon:!0,message:a.banner.text,action:a.readOnly?e.jsx(h,{size:"small",onClick:a.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,a.readOnly&&a.remoteDraftVersion>0?e.jsxs(C,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",a.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,e.jsxs(s,{name:"v2-suppliers-modal",form:c,layout:"vertical",disabled:a.readOnly,onValuesChange:t=>{a.readOnly||a.publishDraftPatch(t)},children:[e.jsx(s.Item,{name:"id",hidden:!0,children:e.jsx(j,{})}),e.jsxs(T,{style:{width:"100%"},align:"start",children:[e.jsx(s.Item,{name:"name",label:"Name",style:{flex:1},rules:[{required:!0,message:"Name ist erforderlich."}],children:e.jsx(j,{})}),e.jsx(s.Item,{name:"company_name",label:"Company",style:{flex:1},children:e.jsx(j,{})})]}),e.jsxs(T,{style:{width:"100%"},align:"start",children:[e.jsx(s.Item,{name:"productionLeadTimeDaysDefault",label:"Production Lead Time (Tage)",style:{flex:1},children:e.jsx(O,{style:{width:"100%"},min:0})}),e.jsx(s.Item,{name:"incotermDefault",label:"Incoterm",style:{flex:1},children:e.jsx(M,{options:re.map(t=>({value:t,label:t}))})}),e.jsx(s.Item,{name:"currencyDefault",label:"Currency",style:{flex:1},children:e.jsx(M,{options:ne.map(t=>({value:t,label:t}))})})]}),e.jsx($,{level:5,children:"Payment Terms"}),e.jsx(s.List,{name:"paymentTermsDefault",children:(t,{add:l,remove:r})=>e.jsxs(T,{direction:"vertical",style:{width:"100%"},size:8,children:[t.map(n=>e.jsxs(T,{align:"start",style:{width:"100%"},children:[e.jsx(s.Item,{...n,name:[n.name,"label"],style:{flex:2},rules:[{required:!0,message:"Label fehlt."}],children:e.jsx(j,{placeholder:"Label"})}),e.jsx(s.Item,{...n,name:[n.name,"percent"],style:{flex:1},rules:[{required:!0,message:"%"}],children:e.jsx(O,{min:0,max:100,style:{width:"100%"}})}),e.jsx(s.Item,{...n,name:[n.name,"triggerEvent"],style:{flex:1},rules:[{required:!0,message:"Trigger fehlt."}],children:e.jsx(M,{options:F.map(p=>({value:p,label:p}))})}),e.jsx(s.Item,{...n,name:[n.name,"offsetDays"],style:{flex:1},children:e.jsx(O,{style:{width:"100%"}})}),e.jsx(h,{danger:!0,onClick:()=>r(n.name),children:"X"})]},n.key)),e.jsx(h,{onClick:()=>l({label:"Milestone",percent:0,triggerEvent:"ORDER_DATE",offsetDays:0}),children:"Milestone hinzufuegen"}),e.jsx(ae,{type:"secondary",children:"Summe muss 100% ergeben."})]})})]})]})]})}export{De as default};
