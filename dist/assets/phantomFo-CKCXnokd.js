import{an as De,p as je}from"./index-D6pMtF0j.js";import{e as Xe,r as Le}from"./productCompletenessV2-Barv506d.js";import{c as Ke,a as Je,n as ce,b as Qe}from"./months-BTPgK-LH.js";import{b as et,c as tt,a as st,e as rt,h as nt}from"./orderUtils-DfdZPrUm.js";import{b as ze}from"./abcClassification-6ogAsQHc.js";import{c as Oe,g as Ve}from"./inventoryProjection-CUkENcre.js";import{b as ot}from"./planProducts-C4xIiO35.js";const Ee={wide:.95,partial:.8},it=90,at=35,ct={full:{label:"Vollständig",detail:"Coverage 100% und keine Blocker."},wide:{label:"Weitgehend",detail:"Coverage ≥95% und keine A/B-Blocker."},partial:{label:"Teilweise",detail:"Coverage ≥80%."},insufficient:{label:"Unzureichend",detail:"Coverage <80% oder A/B-Blocker."}};function ue(e){return String(e||"").trim()}function H(e){return ue(e).toLowerCase()}function ut(e){if(!De(e.includeInForecast,!0))return!1;if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function We(e){return/^\d{4}-\d{2}$/.test(String(e||""))}function qe(e){return e!=null&&String(e).trim()!==""}function ee(e){const t=je(e);return Number.isFinite(t)?Number(t):null}function B(e){const t=ee(e);return!Number.isFinite(t)||Number(t)<=0?null:Math.round(Number(t))}function He(e){if(!We(e))return null;const[t,s]=e.split("-").map(Number);return!t||!s?null:new Date(Date.UTC(t,s-1,1))}function lt(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function dt(e){return`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`}function ft(e,t){const s=new Date(e.getTime());return s.setUTCDate(s.getUTCDate()+t),s}function ht(e){const t=He(e);if(!(t instanceof Date)||Number.isNaN(t.getTime()))return 30;const s=t.getUTCFullYear(),r=t.getUTCMonth();return new Date(Date.UTC(s,r+1,0)).getUTCDate()}function mt(e){if(e.ddp===!0||String(e.incoterm||"").trim().toUpperCase()==="DDP")return!0;const s=e.template&&typeof e.template=="object"?e.template:{};return s.ddp===!0?!0:(s.fields&&typeof s.fields=="object"?s.fields:{}).ddp===!0}function gt(e,t){const s=e.settings&&typeof e.settings=="object"?e.settings:{},r=B(s.robustnessLookaheadDaysNonDdp)??it,n=B(s.robustnessLookaheadDaysDdp)??at;return mt(t)?n:r}function kt(e){const t=Math.max(1,Math.round(Number(e.lookaheadDays||0))),s=`${e.month}:${t}`,r=e.cache.get(s);if(r)return r;const n=e.months.indexOf(e.month);if(n<0)return e.cache.set(s,[e.month]),[e.month];let o=0;const u=[];for(let c=n;c<e.months.length;c+=1){const a=e.months[c];if(u.push(a),o+=ht(a),o>=t)break}const i=u.length?u:[e.month];return e.cache.set(s,i),i}function yt(e){const t=e.month<e.nowMonth?e.pastProjection:e.futureProjection,s=t.perSkuMonth.get(e.sku)||t.perSkuMonth.get(e.skuKey);return s==null?void 0:s.get(e.month)}function Ge(e,t){const s=e.get(t),r=e.get(H(t)),n=String((s==null?void 0:s.abcClass)||(r==null?void 0:r.abcClass)||"C").toUpperCase();return n==="A"||n==="B"||n==="C"?n:"C"}function pt(e){const t=e.inventory&&typeof e.inventory=="object"?e.inventory:{},s=t.settings&&typeof t.settings=="object"?t.settings:{};return String(s.projectionMode||"").toLowerCase()==="doh"?"doh":"units"}function bt(e){return Number.isFinite(e)?`${Math.max(0,Math.min(100,e*100)).toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})}%`:"0.0%"}function vt(e,t){return!e||!e.hasForecast?"":Ve({projectionMode:t,endAvailable:e.endAvailable,safetyUnits:e.safetyUnits,doh:e.doh,safetyDays:e.safetyDays})}function St(e){return!e||!e.hasForecast?"":Ve({projectionMode:"doh",doh:e.doh,safetyDays:e.safetyDays})}function Dt(e,t){return e!=null&&e.hasForecast?t==="safety-negative"?"stock_oos":"stock_under_safety":"forecast_missing"}function Mt(e){return e==="forecast_missing"?"Forecast fehlt":e==="stock_oos"?"Out-of-Stock":"Unter Safety"}function $e(e){return e==="A"||e==="B"}function ye(e){return e==="A"?0:e==="B"?1:2}function xe(e){return e==="stock_oos"?0:e==="stock_under_safety"?1:2}function Be(e){return e.slice().sort((t,s)=>{const r=ye(t.abcClass)-ye(s.abcClass);if(r!==0)return r;const n=xe(t.issueType)-xe(s.issueType);return n!==0?n:t.sku.localeCompare(s.sku,"de-DE")})}function we(e){return e.slice().sort((t,s)=>{const r=Number(s.overdue)-Number(t.overdue);if(r!==0)return r;const n=ye(t.abcClass)-ye(s.abcClass);if(n!==0)return n;const o=t.orderMonth.localeCompare(s.orderMonth);return o!==0?o:t.sku.localeCompare(s.sku,"de-DE")})}function Ct(e){const{coverageRatio:t,blockerCount:s,blockerAbCount:r,hasOrderDutyBlocker:n,hasOverdueOrderDutyBlocker:o}=e;return t>=.999999&&s===0?"full":r>0?"insufficient":t>=Ee.wide?n||o?"partial":"wide":t>=Ee.partial?"partial":"insufficient"}function Pt(e,t){const r=(Array.isArray(e.incomings)?e.incomings:[]).find(u=>String(u.month||"")===t);if(r){const u=ee(r.revenueEur),i=ee(r.payoutPct);if(Number.isFinite(u)||Number.isFinite(i))return!0}const o=(e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{})[t];return o?Number.isFinite(ee(o.realRevenueEUR))||Number.isFinite(ee(o.realPayoutRatePct)):!1}function At(e){const t=e.settings&&typeof e.settings=="object"?e.settings:{},s=t.vatPreview&&typeof t.vatPreview=="object"?t.vatPreview:{},r=e.vatPreviewMonths&&typeof e.vatPreviewMonths=="object"?e.vatPreviewMonths:{};return{active:[s.deShareDefault,s.feeRateDefault,s.fixInputDefault,s.feeRateOfGrossDefault,s.fixInputVatDefault].some(qe),defaults:s,monthOverrides:r}}function Rt(e,t){if(!e.active)return!0;const s=e.monthOverrides[t]&&typeof e.monthOverrides[t]=="object"?e.monthOverrides[t]:{};return[e.defaults.deShareDefault,e.defaults.feeRateDefault,e.defaults.fixInputDefault,e.defaults.feeRateOfGrossDefault,e.defaults.fixInputVatDefault,s.deShare,s.feeRateOfGross,s.fixInputVat].some(qe)}function Tt(e,t){const s=ze(e).bySku,r=[],n=[];return t.forEach(o=>{const u=ue(o.sku);if(!u)return;const i=String(o.alias||u),c=Ge(s,u),a={sku:u,alias:i,abcClass:c},d=ee(o.avgSellingPriceGrossEUR);(!Number.isFinite(d)||Number(d)<=0)&&r.push(a);const g=Xe({product:o,state:e});(g==null?void 0:g.status)==="blocked"&&n.push(a)}),{missingPrice:r,blockedCompleteness:n}}function Ut(e){const{state:t,product:s}=e,r=Le({state:t,product:s,sku:String(s.sku||""),supplierId:String(s.supplierId||""),orderContext:"product"}),n=r.fields&&typeof r.fields=="object"?r.fields:{},o=M=>{const v=n[M];return!v||typeof v!="object"?null:v.value??null},u=String(o("transportMode")||"").toUpperCase(),i=String((s.template&&typeof s.template=="object"?s.template.transportMode:null)||"SEA").toUpperCase(),c=u||i||"SEA",a=o("ddp")===!0||String(s.incoterm||"").toUpperCase()==="DDP"||!!(s.template&&typeof s.template=="object"&&s.template.ddp===!0),d=a||c==="AIR",g=d?14:45,k=d?21:45,y=B(o("productionLeadTimeDays"))??B(s.productionLeadTimeDaysDefault)??B(s.template&&typeof s.template=="object"?s.template.productionDays:null)??g,A=B(o("transitDays"))??B(s.template&&typeof s.template=="object"?s.template.transitDays:null)??B(s.transitDays)??k;return{productionDays:y,transitDays:A,totalDays:Math.max(1,y+A),transportMode:c,ddp:a}}function Ft(e){const t=new Map,s=e.months.filter(r=>r>=e.nowMonth).sort((r,n)=>r.localeCompare(n));return s.length&&e.products.forEach(r=>{const n=ue(r.sku);if(!n)return;const o=H(n),u=e.projection.perSkuMonth.get(n)||e.projection.perSkuMonth.get(o);if(!u)return;let i=null,c=null;for(let I=0;I<s.length;I+=1){const D=s[I],b=u.get(D),_=vt(b,e.projectionMode);if(_==="safety-negative"||_==="safety-low"){i=D,c=b||null;break}}if(!i)return;const a=He(i);if(!(a instanceof Date)||Number.isNaN(a.getTime()))return;const d=Ut({state:e.state,product:r}),g=ft(a,-d.totalDays),k=lt(g),y=dt(g),A=y<e.nowMonth,M=Number(c==null?void 0:c.safetyUnits),v=Number(c==null?void 0:c.endAvailable),S=Number.isFinite(M)&&Number.isFinite(v)?Math.max(0,Math.ceil(M-v)):null;t.set(o,{sku:n,firstRiskMonth:i,latestOrderDate:k,orderMonth:y,leadTimeDays:d.totalDays,overdue:A,requiredArrivalDate:`${i}-01`,recommendedOrderDate:k,shortageUnits:S})}),t}function It(e){const t=e.months.reduce((a,d)=>{const g=d.coverage.stockIssues.filter(k=>k.issueType==="forecast_missing").length;return a+g},0),s=e.months.reduce((a,d)=>a+d.coverage.safetyRiskSkus.length,0),r=e.months.reduce((a,d)=>a+d.coverage.orderDutyRiskSkus.length,0),n=e.months.reduce((a,d)=>a+d.coverage.overdueOrderDutySkuCount,0),o=e.months.filter(a=>{const d=a.checks.find(g=>g.key==="cash_in");return d&&!d.passed}).length,u=e.months.filter(a=>{const d=a.checks.find(g=>g.key==="vat");return d&&!d.passed}).length,i=[];if(t>0&&i.push({id:"forecast_missing",title:"Forecast vervollständigen",detail:`${t} SKU-Monat(e) ohne Forecast.`,severity:"error",route:"/v2/forecast",count:t,impact:"Kontostand nicht belastbar"}),s>0||r>0){const a=s+r,d=n>0?` · Überfällig ${n}`:"";i.push({id:"inventory_safety",title:"Bestandsrisiken sichern (PO/FO)",detail:`${a} SKU-Monat(e) mit Safety-/Bestellpflicht-Risiko${d}.`,severity:"error",route:"/v2/inventory/projektion",count:a,impact:"Stockout-Risiko in A/B möglich"})}o>0&&i.push({id:"cashin_basis",title:"Cash-In Basis pflegen",detail:`${o} Monat(e) ohne belastbare Incomings/Payout-Basis.`,severity:"error",route:"/v2/abschluss/eingaben",count:o,impact:"Kontostand-Projektion instabil"}),e.hasFixcostBasis||i.push({id:"fixcost_basis",title:"Fixkostenbasis hinterlegen",detail:"Keine Fixkosten im Modell vorhanden.",severity:"error",route:"/v2/abschluss/fixkosten",count:e.months.length,impact:"Buffer-/Ausschüttungsentscheidung unzuverlässig"}),e.vatActive&&u>0&&i.push({id:"vat_basis",title:"USt-/Tax-Basis vervollständigen",detail:`${u} Monat(e) ohne belastbare VAT-Konfiguration.`,severity:"error",route:"/v2/abschluss/ust",count:u,impact:"Outflow-Bild unvollständig"}),e.revenueIssueSkus>0&&i.push({id:"revenue_inputs",title:"Umsatz-relevante Produktdaten korrigieren",detail:`${e.revenueIssueSkus} aktive SKU(s) mit fehlender Revenue-Basis.`,severity:"error",route:"/v2/products",count:e.revenueIssueSkus,impact:"Cash-In unterschätzt oder 0"});const c=a=>a==="error"?2:1;return i.sort((a,d)=>{const g=c(d.severity)-c(a.severity);if(g!==0)return g;const k=d.count-a.count;return k!==0?k:a.title.localeCompare(d.title)}),i.slice(0,5)}function Nt(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).filter(We))).sort(),s=e.state||{},n=(Array.isArray(s.products)?s.products:[]).map(l=>l||{}).filter(l=>ue(l.sku)).filter(ut),o=n.length,u=Array.isArray(s.fixcosts)&&s.fixcosts.length>0,i=At(s),c=Tt(s,n),a=new Set(c.missingPrice.map(l=>H(l.sku))),d=Ke(),g=pt(s),k=t.filter(l=>l<d),y=t.filter(l=>l>=d),A={perSkuMonth:new Map},M=k.length?Oe({state:s,months:k,products:n,snapshot:null,snapshotMonth:k[0]||void 0,projectionMode:g}):A,v=y.length?Oe({state:s,months:y,products:n,snapshot:null,snapshotMonth:Je(d,-1),projectionMode:g}):A,S=ze(s).bySku,I=Ft({state:s,products:n,months:t,projection:v,projectionMode:g,nowMonth:d}),D=new Map,b=t.map(l=>{const E=new Set,C=new Set,R=new Set,re=new Set,j=new Set,L=new Set,G=new Set;let K=0;const z=[],x=[];n.forEach(p=>{const m=ue(p.sku);if(!m)return;const h=H(m),Z=String(p.alias||m),X=Ge(S,m),me=gt(s,p),Te=kt({month:l,months:t,lookaheadDays:me,cache:D});let ge=null,P,Ue="",ke=null;Te.forEach(J=>{if(ge)return;const O=yt({month:J,nowMonth:d,pastProjection:M,futureProjection:v,sku:m,skuKey:h}),Q=Number(O==null?void 0:O.doh);Number.isFinite(Q)&&(ke=ke==null?Q:Math.min(ke,Q));const Ne=St(O);(!(O!=null&&O.hasForecast)||Ne)&&(ge=J,P=O,Ue=Ne)});const Fe=ge==null;if(!Fe){const J=Dt(P,Ue),O=Number.isFinite(Number(P==null?void 0:P.doh))?Number(P==null?void 0:P.doh):null,Q=Number.isFinite(Number(P==null?void 0:P.safetyDays))?Number(P==null?void 0:P.safetyDays):null;z.push({sku:m,alias:Z,abcClass:X,issueType:J,issueLabel:Mt(J),value:O,safetyValue:Q,projectionMode:"doh",safetyThresholdDoh:Q,minDohInWindow:ke,firstBreachMonth:ge,lookaheadDays:me,lookaheadMonths:Te}),re.add(h),$e(X)?j.add(h):L.add(h),J==="forecast_missing"?E.add(m):C.add(m)}const F=I.get(h)||null,Ie=!!(F&&F.orderMonth<=l);F&&Ie&&(x.push({sku:m,alias:Z,abcClass:X,firstRiskMonth:F.firstRiskMonth,latestOrderDate:F.latestOrderDate,orderMonth:F.orderMonth,leadTimeDays:F.leadTimeDays,overdue:F.overdue,requiredArrivalDate:F.requiredArrivalDate,recommendedOrderDate:F.recommendedOrderDate,shortageUnits:F.shortageUnits,reason:"Keine FO/PO vorhanden, die die Lücke schließt."}),R.add(m),re.add(h),$e(X)?j.add(h):L.add(h),F.overdue&&G.add(h)),Fe&&!Ie&&(K+=1)});const V=o?K/o:0,W=re.size,Y=j.size,de=L.size,pe=x.length>0,fe=G.size>0,q=Ct({coverageRatio:V,blockerCount:W,blockerAbCount:Y,hasOrderDutyBlocker:pe,hasOverdueOrderDutyBlocker:fe}),be=ct[q],ve=q==="full"||q==="wide",ne=Pt(s,l),oe=u,ie=Rt(i,l),ae=c.missingPrice.length===0&&c.blockedCompleteness.length===0,he=[],N=p=>{he.push({id:`${p.checkKey}:${p.month}:${he.length}`,...p})};if(!ve){o===0&&N({month:l,checkKey:"sku_coverage",severity:"error",message:"Keine aktiven SKUs vorhanden.",route:"/v2/products"});const p=Be(z);p.slice(0,20).forEach(h=>{const Z=h.issueType==="forecast_missing"?"/v2/forecast":"/v2/inventory/projektion",X=h.issueType==="forecast_missing"?"Forecast fehlt":h.issueType==="stock_oos"?"Out-of-Stock":"unter Safety",me=h.firstBreachMonth?` (erster Verstoß ${h.firstBreachMonth})`:"";N({month:l,checkKey:"sku_coverage",severity:"error",message:`${h.sku} (${h.alias}): ${X}${me} (${h.abcClass}).`,sku:h.sku,alias:h.alias,abcClass:h.abcClass,issueType:h.issueType,firstRiskMonth:h.firstBreachMonth||void 0,route:Z})}),p.length>20&&N({month:l,checkKey:"sku_coverage",severity:"error",message:`+ ${p.length-20} weitere SKU(s) mit Bestandsproblemen.`,route:"/v2/inventory/projektion"});const m=we(x);m.slice(0,20).forEach(h=>{const Z=h.overdue?"überfällig":"fällig";N({month:l,checkKey:"sku_coverage",severity:"error",message:`${h.sku} (${h.alias}): Bestellpflicht ${Z} bis ${h.latestOrderDate} (Risikomonat ${h.firstRiskMonth}).`,sku:h.sku,alias:h.alias,abcClass:h.abcClass,issueType:"order_duty",firstRiskMonth:h.firstRiskMonth,latestOrderDate:h.latestOrderDate,orderMonth:h.orderMonth,leadTimeDays:h.leadTimeDays,overdue:h.overdue,requiredArrivalDate:h.requiredArrivalDate,recommendedOrderDate:h.recommendedOrderDate,suggestedUnits:h.shortageUnits,route:"/v2/orders/fo"})}),m.length>20&&N({month:l,checkKey:"sku_coverage",severity:"error",message:`+ ${m.length-20} weitere SKU(s) mit Bestellpflicht.`,route:"/v2/orders/fo"})}ne||N({month:l,checkKey:"cash_in",severity:"error",message:"Cash-In Basis fehlt (Incomings/Payout).",route:"/v2/abschluss/eingaben"}),oe||N({month:l,checkKey:"fixcost",severity:"error",message:"Fixkostenbasis fehlt.",route:"/v2/abschluss/fixkosten"}),ie||N({month:l,checkKey:"vat",severity:"error",message:"USt-/Tax-Basis fehlt für den Monat.",route:"/v2/abschluss/ust"}),ae||(c.missingPrice.slice(0,20).forEach(m=>{N({month:l,checkKey:"revenue_inputs",severity:"error",message:`${m.sku} (${m.alias}): Ø VK-Preis fehlt.`,sku:m.sku,alias:m.alias,abcClass:m.abcClass,route:"/v2/products"})}),c.blockedCompleteness.filter(m=>!a.has(H(m.sku))).slice(0,20).forEach(m=>{N({month:l,checkKey:"revenue_inputs",severity:"error",message:`${m.sku} (${m.alias}): Stammdaten unvollständig.`,sku:m.sku,alias:m.alias,abcClass:m.abcClass,route:"/v2/products"})}));const Pe=[{key:"sku_coverage",label:"Bestands- & Bestellpflicht-Coverage",status:ve?"ok":"error",passed:ve,detail:`${be.label}: ${bt(V)} (${K}/${o}) · Blocker ${W} (A/B ${Y}, C ${de}) · Bestand (Lookahead) ${z.length} · Bestellpflicht ${x.length}`,blockerCount:W+(o===0?1:0),route:E.size>0?"/v2/forecast":"/v2/inventory/projektion"},{key:"cash_in",label:"Cash-In Basis",status:ne?"ok":"error",passed:ne,detail:ne?"vorhanden":"fehlend",blockerCount:ne?0:1,route:"/v2/abschluss/eingaben"},{key:"fixcost",label:"Fixkostenbasis",status:oe?"ok":"error",passed:oe,detail:oe?"vorhanden":"fehlend",blockerCount:oe?0:1,route:"/v2/abschluss/fixkosten"},{key:"vat",label:"Tax/VAT Basis",status:ie?"ok":"error",passed:ie,detail:i.active?ie?"vorhanden":"fehlend":"nicht aktiv",blockerCount:ie?0:1,route:"/v2/abschluss/ust"},{key:"revenue_inputs",label:"Revenue-Berechenbarkeit",status:ae?"ok":"error",passed:ae,detail:ae?"vollständig":`${c.missingPrice.length} ohne Preis · ${c.blockedCompleteness.length} unvollständig`,blockerCount:ae?0:c.missingPrice.length+c.blockedCompleteness.length,route:"/v2/products"}],Ze=Pe.every(p=>p.passed),Ae=Be(z),Re=we(x);return{month:l,robust:Ze,checks:Pe,blockers:he,blockerCount:he.length,coverage:{statusKey:q,statusLabel:be.label,statusDetail:be.detail,projectionMode:g,activeSkus:o,coveredSkus:K,ratio:V,blockerCount:W,blockerAbCount:Y,blockerCCount:de,stockIssueCount:Ae.length,orderDutyIssueCount:Re.length,overdueOrderDutySkuCount:G.size,missingForecastSkus:Array.from(E).sort((p,m)=>p.localeCompare(m,"de-DE")),safetyRiskSkus:Array.from(C).sort((p,m)=>p.localeCompare(m,"de-DE")),orderDutyRiskSkus:Array.from(R).sort((p,m)=>p.localeCompare(m,"de-DE")),stockIssues:Ae,orderDutyIssues:Re,abRiskSkuCount:Y}}}),_=new Map;b.forEach(l=>_.set(l.month,l));const f=b.filter(l=>l.robust).length;let U=null;for(let l=0;l<b.length&&b[l].robust;l+=1)U=b[l].month;const se=new Set([...c.missingPrice.map(l=>H(l.sku)),...c.blockedCompleteness.map(l=>H(l.sku))]).size;return{months:b,monthMap:_,actions:It({months:b,hasFixcostBasis:u,vatActive:i.active,revenueIssueSkus:se}),robustUntilMonth:U,robustMonthsCount:f,totalMonths:b.length,activeSkuCount:o}}const Ot="robustness_order_duty_v2";function le(e){return String(e||"").trim()}function Me(e){return le(e).toLowerCase()}function Se(e){const t=String(e||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const s=new Date(`${t}T00:00:00Z`);return Number.isNaN(s.getTime())?null:t}function Et(e){const t=ce(e);return t?`${t}-01`:null}function w(e,t=0){const s=je(e);return Number.isFinite(s)?Number(s):t}function T(e){const t=w(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function $(e){const t=w(e,Number.NaN);return!Number.isFinite(t)||t<=0?null:t}function $t(e){return Number.isFinite(e)?Math.round(e*100)/100:0}function xt(e){if(!De(e.includeInForecast,!0))return!1;if(typeof e.active=="boolean")return e.active;const t=String(e.status||"").trim().toLowerCase();return t?t==="active"||t==="aktiv":!0}function te(e,t="PH"){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"")||t}function Ye(e,t="PLAN"){return String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]+/g,"-").replace(/^-+|-+$/g,"")||t}function Bt(e,t){const s=Ye(e,"PLAN");let r=s,n=2;for(;t.has(r.toLowerCase());)r=`${s}-${n}`,n+=1;return r}function wt(e){const t=String(e||"").trim().toUpperCase();return t==="SEA"||t==="RAIL"||t==="AIR"?t:"SEA"}function _t(e,t){const s=e.transportLeadTimesDays||{};return T(s[t.toLowerCase()])??T(s.sea)??null}function jt(e){const t=te(e.sku,"SKU").slice(0,14),s=te(e.orderMonth,"OM"),r=te(e.firstRiskMonth,"RM");return`phantom-fo-${t}-${s}-${r}`}function Lt(e){const t=te(e.orderMonth,"000000").slice(0,6),s=te(e.sku,"SKU").slice(0,6),r=te(e.firstRiskMonth,"000000").slice(0,6);return`PH-${t}-${s}-${r}`}function Kt(e){const t=new Map;return e.forEach(s=>{const r=le(s.sku);if(!r)return;const n=Me(r);t.has(n)||t.set(n,s)}),t}function zt(e,t){const s=Nt({state:e,months:t}),r=new Map;return s.months.forEach(n=>{Kt(n.coverage.orderDutyIssues).forEach((u,i)=>{r.has(i)||r.set(i,u)})}),Array.from(r.values())}function Ce(e){const t=e!=null&&e.template&&typeof e.template=="object"?e.template:{};return(t.fields&&typeof t.fields=="object"?t.fields:t)||{}}function Vt(e){const t=Ce(e);return $(t.unitPriceUsd)??$(e==null?void 0:e.unitPriceUsd)??$(e==null?void 0:e.unitPrice)??0}function Wt(e){const t=Ce(e);return $(e==null?void 0:e.logisticsPerUnitEur)??$(e==null?void 0:e.freightPerUnitEur)??$(t.logisticsPerUnitEur)??$(t.freightEur)??0}function qt(e){const t=e.product||{},s=e.settings||{},r=Ce(t),n=Le({state:e.state,product:t||void 0,sku:String(t.sku||""),supplierId:e.supplierId||String(t.supplierId||""),orderContext:"fo"}),o=n.fields&&typeof n.fields=="object"?n.fields:{},u=v=>{const S=o[v];return!S||typeof S!="object"?null:S.value??null},i=String(u("transportMode")||r.transportMode||t.transportMode||"SEA").trim().toUpperCase(),c=i==="AIR"||i==="SEA"||i==="RAIL"?i:"SEA",a=u("ddp")===!0||String(t.incoterm||"").toUpperCase()==="DDP",d=a||c==="AIR",g=T(u("productionLeadTimeDays"))??T(t.productionLeadTimeDaysDefault)??T(r.productionDays)??T(s.defaultProductionLeadTimeDays)??(d?14:45),k=T(u("transitDays"))??T(r.transitDays)??T(t.transitDays)??(d?21:45),y=w(u("dutyRatePct"),w(s.dutyRatePct,0)),A=w(u("eustRatePct"),w(s.eustRatePct,0)),M=String(u("incoterm")||t.incoterm||(a?"DDP":"EXW")).trim().toUpperCase()||"EXW";return{productionDays:g,transitDays:k,totalDays:Math.max(1,g+k),transportMode:c,incoterm:M,dutyRatePct:Math.max(0,y),eustRatePct:Math.max(0,A)}}function Ht(e){const t=Array.from(new Set((Array.isArray(e.months)?e.months:[]).map(s=>String(s||"").trim()))).filter(s=>/^\d{4}-\d{2}$/.test(s)).sort((s,r)=>s.localeCompare(r));return t.length?t:Jt(e.state)}function Gt(e){return nt([],e||void 0)}function _e(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.max(1,Math.round(t))}function Yt(e,t){const s=Number(t.overdue)-Number(e.overdue);if(s!==0)return s;const r=i=>i==="A"?0:i==="B"?1:2,n=r(e.abcClass)-r(t.abcClass);if(n!==0)return n;const o=e.orderMonth.localeCompare(t.orderMonth);if(o!==0)return o;const u=e.firstRiskMonth.localeCompare(t.firstRiskMonth);return u!==0?u:e.sku.localeCompare(t.sku,"de-DE")}function Zt(e,t){if(!e.length)return null;const s=ce(t);if(!s)return e[e.length-1];let r=null;return e.forEach(n=>{n<=s&&(r=n)}),r||e[0]}function Xt(e){const t=e.issue,s=le(t.sku);if(!s)return null;const r=Me(s),n=e.productBySkuKey.get(r)||null,o=String((n==null?void 0:n.supplierId)||"").trim(),u=e.supplierById.get(o)||null,i=qt({state:e.state,product:n,supplierId:o,settings:e.settings}),c=Se(t.requiredArrivalDate)||Et(t.firstRiskMonth);if(!c)return null;const a=tt({context:e.recommendationContext,sku:s,leadTimeDays:i.totalDays,product:n,settings:e.settings,horizonMonths:Math.max(6,Math.round(Number(e.horizonMonths)||6)),requiredArrivalMonth:t.firstRiskMonth}),d=_e(a==null?void 0:a.recommendedUnits),g=_e(t.shortageUnits),k=Math.max(d||0,g||0);if(!(k>0))return null;const y=st({targetDeliveryDate:c,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0}),A=Vt(n),M=Wt(n),v=$t(M*k),S=$(e.settings.fxRate)??0,I=rt({supplierTerms:Gt(u),schedule:y,unitPrice:A,units:k,currency:"USD",freight:v,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:S,incoterm:i.incoterm,vatRefundLagMonths:e.settings.vatRefundLagMonths,paymentDueDefaults:e.settings.paymentDueDefaults,existingPayments:[]}),D=jt(t),b=Lt(t);return{id:D,sku:s,alias:String(t.alias||(n==null?void 0:n.alias)||s),abcClass:t.abcClass,supplierId:o,orderMonth:String(t.orderMonth||"").trim(),firstRiskMonth:String(t.firstRiskMonth||"").trim(),latestOrderDate:Se(t.latestOrderDate)||y.orderDate||"",requiredArrivalDate:c,recommendedOrderDate:Se(t.recommendedOrderDate)||y.orderDate||"",leadTimeDays:i.totalDays,overdue:t.overdue===!0,suggestedUnits:k,shortageUnits:g??null,recommendationStatus:a?String(a.status||""):null,recommendationUnits:d??null,foRecord:{id:D,foNo:b,foNumber:b,sku:s,supplierId:o,targetDeliveryDate:c,units:k,transportMode:i.transportMode,incoterm:i.incoterm,unitPrice:A,currency:"USD",freight:v,freightCurrency:"EUR",dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:S,productionLeadTimeDays:i.productionDays,logisticsLeadTimeDays:i.transitDays,bufferDays:0,orderDate:y.orderDate||null,productionEndDate:y.productionEndDate||null,etdDate:y.etdDate||null,etaDate:y.etaDate||c,deliveryDate:y.deliveryDate||c,payments:I,status:"ACTIVE",phantom:!0,phantomSource:Ot,phantomStatus:"suggested",phantomGeneratedAt:new Date().toISOString(),phantomMeta:{firstRiskMonth:t.firstRiskMonth,orderMonth:t.orderMonth,latestOrderDate:t.latestOrderDate,recommendedOrderDate:t.recommendedOrderDate,leadTimeDays:i.totalDays,abcClass:t.abcClass,shortageUnits:t.shortageUnits,reason:t.reason}}}}function Jt(e,t=18){const s=e.settings&&typeof e.settings=="object"?e.settings:{},r=ce(s.startMonth)||Ke(),n=T(s.horizonMonths)??Math.max(6,Math.round(Number(t)||18));return Qe(r,n)}function us(e){const t=e.state||{},s=Ht({state:t,months:e.months});if(!s.length)return[];const r=Zt(s,e.targetMonth);if(!r)return[];const n=t.settings&&typeof t.settings=="object"?t.settings:{},o=(Array.isArray(t.products)?t.products:[]).map(f=>f).filter(f=>le(f.sku)).filter(xt),u=new Set((Array.isArray(t.products)?t.products:[]).map(f=>le(f.sku).toLowerCase()).filter(Boolean)),i=ot({state:t,months:s}),c=[],a={};i.forEach((f,U)=>{if(!De(f.includeInForecast,!0))return;const l=String(f.status||"").trim().toLowerCase();if(l&&l!=="active"&&l!=="aktiv"||String(f.mappedSku||"").trim())return;const C=String(f.alias||"").trim();if(!C)return;const R=String(f.plannedSku||"").trim(),re=`PLAN-${Ye(f.id||C,String(U+1))}`,j=Bt(R||re,u);u.add(j.toLowerCase());const L=wt(f.transportMode),G=T(f.transitDays)??_t(n,L),K=T(f.productionLeadTimeDaysDefault),z=$(f.unitPriceUsd)??0,x=w(f.logisticsPerUnitEur??f.freightPerUnitEur,0),V=Number.isFinite(x)?Math.max(0,x):0,W={},Y=f.unitsByMonth&&typeof f.unitsByMonth=="object"?f.unitsByMonth:{};Object.entries(Y).forEach(([de,pe])=>{const fe=ce(de),q=w(pe,Number.NaN);!fe||!Number.isFinite(q)||(W[fe]=Math.max(0,Math.round(q)))}),a[j]=W,c.push({...f,id:`plan-virtual-${String(f.id||U+1)}`,sku:j,alias:C,status:"active",includeInForecast:!0,transportMode:L,transitDays:G,productionLeadTimeDaysDefault:K,unitPriceUsd:z,logisticsPerUnitEur:V,freightPerUnitEur:V,template:{scope:"SKU",name:"Planprodukt",fields:{transportMode:L,transitDays:G,productionDays:K,unitPriceUsd:z,freightEur:V}},__planVirtual:!0,__planProductId:String(f.id||"")})});const d=[...o,...c],g=new Map;d.forEach(f=>{g.set(Me(f.sku),f)});const k=new Map;(Array.isArray(t.suppliers)?t.suppliers:[]).map(f=>f).forEach(f=>{const U=String(f.id||"").trim();U&&k.set(U,f)});const y=t.forecast&&typeof t.forecast=="object"?t.forecast:{},M={...y.forecastManual&&typeof y.forecastManual=="object"?y.forecastManual:{}};Object.entries(a).forEach(([f,U])=>{M[f]={...M[f]||{},...U}});const v=c.length||Object.keys(a).length?{...t,products:[...Array.isArray(t.products)?t.products:[],...c],forecast:{...y,forecastManual:M}}:t,S=[],I=new Set;let D=v;const b=T(e.maxSuggestions),_=Math.max(1,s.length*2);for(let f=0;f<_;f+=1){const U=et(D),se=zt(D,s).filter(C=>{const R=ce(C.orderMonth);return R?R<=r:!1});if(!se.length)break;const l=new Set((Array.isArray(D.fos)?D.fos:[]).map(C=>String((C==null?void 0:C.id)||"").trim()).filter(Boolean)),E=[];if(se.forEach(C=>{const R=Xt({state:D,issue:C,productBySkuKey:g,supplierById:k,settings:n,recommendationContext:U,horizonMonths:s.length});R&&(I.has(R.id)||l.has(R.id)||(I.add(R.id),E.push(R)))}),!E.length||(S.push(...E),b!=null&&S.length>=b))break;D=Qt({state:D,suggestions:E})}return S.sort(Yt),b!=null?S.slice(0,b):S}function Qt(e){const t=e.state||{},s=Array.isArray(t.fos)?t.fos:[],r=new Set(s.map(o=>String(o.id||"").trim()).filter(Boolean)),n=e.suggestions.map(o=>o.foRecord).filter(o=>{const u=String(o.id||"").trim();return u?!r.has(u):!1});return{...t,fos:[...s,...n]}}export{Qt as a,us as b,Nt as c,Jt as r};
