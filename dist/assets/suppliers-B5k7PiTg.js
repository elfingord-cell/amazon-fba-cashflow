import{l as U,g as _,s as x,e as $,p as B,B as H,x as F}from"./index-DrOkdIyL.js";import{b as j}from"./supplierLabels-BolgyxWX.js";function m(l,n=document){return n.querySelector(l)}function e(l,n={},b=[]){const s=document.createElement(l);for(const[o,g]of Object.entries(n))if(o==="class")s.className=g;else if(o==="dataset")for(const[v,L]of Object.entries(g))s.dataset[v]=L;else o.startsWith("on")&&typeof g=="function"?s.addEventListener(o.slice(2),g):s.setAttribute(o,g);for(const o of[].concat(b))o!=null&&s.append(o.nodeType?o:document.createTextNode(String(o)));return s}const A=["ORDER_DATE","PRODUCTION_END","ETD","ETA"],W=["EUR","USD","CNY"],z=["EXW","FOB","DDP","FCA"];function J(){return[{label:"Deposit",percent:30,triggerEvent:"ORDER_DATE",offsetDays:0},{label:"Balance",percent:70,triggerEvent:"ETD",offsetDays:0}]}function K(l=[]){return l.length?l.map(n=>`${n.percent}% @ ${n.triggerEvent}${n.offsetDays?` ${n.offsetDays>=0?"+":""}${n.offsetDays}`:""}`).join(", "):"—"}function I(l){const n=Number(l);return Number.isFinite(n)?Math.min(Math.max(n,0),100):null}function O(l){return B(l)}function X(l,n,b){const s=String(n||"").trim().toLowerCase();return s?!l.some(o=>o.id!==b&&String(o.name||"").trim().toLowerCase()===s):!1}function q(l,n,b){const s=e("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),o=e("div",{class:"po-modal"},[e("header",{class:"po-modal-header"},[e("h4",{},[l]),e("button",{class:"btn ghost",type:"button",onclick:()=>s.remove(),"aria-label":"Schließen"},["✕"])]),e("div",{class:"po-modal-body"},[n]),e("footer",{class:"po-modal-actions"},b)]);return s.append(o),document.body.append(s),s}function G(l){const n=U();Array.isArray(n.suppliers)||(n.suppliers=[]);const b=_();j(n,b);let s=new Map;function o(a){if(!a.length)return"";const i=a.map(t=>{switch(t.field){case"name":return"Name";case"currency":return"Currency";case"paymentTerms":return"Payment Terms";case"productionLeadTime":return"Production Lead Time";default:return t.field}});return`Fehlt: ${[...new Set(i)].join(", ")}`}function g(a){const i=s.get(a)||[];if(!i.length)return null;const t=o(i);return e("button",{class:"data-health-dot",type:"button",title:t,"aria-label":t,onclick:u=>{u.stopPropagation(),F({scope:"supplier",entityId:a})}})}l.innerHTML=`
    <section class="card">
      <h2>Suppliers</h2>
      <div class="table-card-header">
        <span class="muted">Lieferanten-Stammdaten</span>
        <button class="btn primary" id="supplier-add">Lieferant hinzufügen</button>
      </div>
      <div id="supplier-table"></div>
    </section>
  `;const v=m("#supplier-table",l);function L(){s=new Map,H(n.suppliers).forEach(a=>{const i=String(a.entityId||"").trim();i&&(s.has(i)||s.set(i,[]),s.get(i).push(a))})}function w(){if(L(),!n.suppliers.length){v.innerHTML='<p class="muted">Keine Lieferanten vorhanden.</p>';return}const a=n.suppliers.slice().sort((t,u)=>(t.name||"").localeCompare(u.name||"")),i=[{key:"name",label:"Supplier Name"},{key:"company",label:"Company"},{key:"lead",label:"Default Production Lead Time",className:"num"},{key:"incoterm",label:"Incoterm"},{key:"currency",label:"Currency"},{key:"terms",label:"Payment Terms"},{key:"updated",label:"Updated"},{key:"actions",label:"Actions"}];v.innerHTML="",v.append($({className:"suppliers-table",columns:i,rows:a,rowKey:t=>t.id,rowAttrs:t=>({dataset:{id:t.id}}),renderCell:(t,u)=>{switch(u.key){case"name":return e("span",{class:"data-health-inline"},[g(t.id),t.name]);case"company":return t.company_name||"—";case"lead":return t.productionLeadTimeDaysDefault;case"incoterm":return t.incotermDefault;case"currency":return t.currencyDefault||"EUR";case"terms":return K(t.paymentTermsDefault);case"updated":return t.updatedAt?new Date(t.updatedAt).toLocaleDateString("de-DE"):"—";case"actions":return e("div",{class:"table-actions ui-table-actions-nowrap"},[e("button",{class:"btn sm",type:"button",dataset:{action:"edit"}},["Bearbeiten"]),e("button",{class:"btn sm danger",type:"button",dataset:{action:"delete"}},["Löschen"])]);default:return"—"}}}))}function k(a){const i=n.settings||{},t=a?JSON.parse(JSON.stringify(a)):{id:`sup-${Math.random().toString(36).slice(2,9)}`,name:"",company_name:"",productionLeadTimeDaysDefault:30,incotermDefault:"EXW",currencyDefault:i.defaultCurrency||"EUR",paymentTermsDefault:J(),updatedAt:null},u=e("table",{class:"table ui-table-standard"},[e("thead",{},[e("tr",{},[e("th",{},["Label"]),e("th",{class:"num"},["Percent"]),e("th",{},["Trigger Event"]),e("th",{class:"num"},["Offset Days"]),e("th",{},[""])])])]),E=e("tbody");u.append(E);const f=e("p",{class:"muted",style:"margin-top:6px"},["Summe: 100%"]);function T(){E.innerHTML="",t.paymentTermsDefault.forEach((r,c)=>{const h=e("tr",{},[e("td",{},[e("input",{type:"text",value:r.label||"",oninput:p=>{r.label=p.target.value}})]),e("td",{class:"num"},[e("input",{type:"number",min:"0",max:"100",step:"1",value:r.percent??0,oninput:p=>{r.percent=p.target.value,y()}})]),e("td",{},[(()=>{const p=e("select",{onchange:S=>{r.triggerEvent=S.target.value}});return A.forEach(S=>{p.append(e("option",{value:S},[S]))}),p.value=r.triggerEvent||"ORDER_DATE",p})()]),e("td",{class:"num"},[e("input",{type:"number",step:"1",value:r.offsetDays??0,oninput:p=>{r.offsetDays=p.target.value}})]),e("td",{},[e("button",{class:"btn danger",type:"button",onclick:()=>{t.paymentTermsDefault.splice(c,1),T(),y()}},["✕"])])]);E.append(h)})}function y(){const r=t.paymentTermsDefault.reduce((c,h)=>c+(I(h.percent)||0),0);return Math.round(r)===100?(f.textContent="Summe: 100%",f.style.color="#0f9960",!0):(f.textContent=`Summe: ${r}% (muss 100% sein)`,f.style.color="#c23636",!1)}const d=e("div",{},[e("label",{},["Name"]),e("input",{type:"text",id:"supplier-name",value:t.name}),e("label",{style:"margin-top:12px"},["Company"]),e("input",{type:"text",id:"supplier-company",value:t.company_name||""}),e("label",{style:"margin-top:12px"},["Default Production Lead Time"]),e("input",{type:"number",min:"0",step:"1",id:"supplier-lt",value:t.productionLeadTimeDaysDefault}),e("label",{style:"margin-top:12px"},["Incoterm"]),(()=>{const r=e("select",{id:"supplier-incoterm"});return z.forEach(c=>r.append(e("option",{value:c},[c]))),r})(),e("label",{style:"margin-top:12px"},["Currency"]),(()=>{const r=e("select",{id:"supplier-currency"});return W.forEach(c=>r.append(e("option",{value:c},[c]))),r.value=t.currencyDefault||i.defaultCurrency||"EUR",r})(),e("h4",{style:"margin-top:16px"},["Payment Terms"]),e("div",{class:"table-wrap ui-table-shell ui-scroll-host"},[u]),e("button",{class:"btn secondary",type:"button",id:"terms-add"},["+ Milestone"]),f,e("h4",{style:"margin-top:20px"},["Produkte & Preise"]),e("p",{class:"muted"},["SKU-Mappings wurden entfernt. Preise und Lieferanten sind jetzt direkt im Produktstamm gepflegt."])]),R=e("button",{class:"btn primary",type:"button"},["Speichern"]),P=e("button",{class:"btn",type:"button"},["Abbrechen"]),C=q(a?"Lieferant bearbeiten":"Lieferant hinzufügen",d,[P,R]);m("#supplier-incoterm",d).value=t.incotermDefault||"EXW",T(),y(),m("#terms-add",d).addEventListener("click",()=>{t.paymentTermsDefault.push({label:"Milestone",percent:0,triggerEvent:"ORDER_DATE",offsetDays:0}),T(),y()}),P.addEventListener("click",()=>C.remove()),R.addEventListener("click",()=>{const r=m("#supplier-name",d).value.trim(),c=m("#supplier-company",d).value.trim(),h=O(m("#supplier-lt",d).value),p=(m("#supplier-currency",d).value||"EUR").trim()||"EUR",S=y();if(!r){window.alert("Name ist erforderlich.");return}if(!X(n.suppliers,r,t.id)){window.alert("Name muss eindeutig sein.");return}if(h==null||h<0){window.alert("Production Lead Time muss ≥ 0 sein.");return}if(!S){window.alert("Payment Terms müssen insgesamt 100% ergeben.");return}t.name=r,t.company_name=c,t.productionLeadTimeDaysDefault=h,t.incotermDefault=m("#supplier-incoterm",d).value,t.currencyDefault=p,t.paymentTermsDefault=t.paymentTermsDefault.map(D=>({label:D.label||"Milestone",percent:I(D.percent)||0,triggerEvent:A.includes(D.triggerEvent)?D.triggerEvent:"ORDER_DATE",offsetDays:O(D.offsetDays)||0})),t.updatedAt=new Date().toISOString();const M=n.suppliers.findIndex(D=>D.id===t.id);M>=0?n.suppliers[M]=t:n.suppliers.push(t),x(n),w(),C.remove()})}m("#supplier-add",l).addEventListener("click",()=>k(null)),v.addEventListener("click",a=>{var f,T;const i=a.target.closest("tr[data-id]");if(!i)return;const t=i.dataset.id,u=n.suppliers.find(y=>y.id===t);if(!u)return;const E=(T=(f=a.target.closest("button"))==null?void 0:f.dataset)==null?void 0:T.action;if(E==="edit")k(u);else if(E==="delete"){if(!window.confirm(`Lieferant "${u.name}" löschen?`))return;n.suppliers=n.suppliers.filter(d=>d.id!==t),x(n),w()}}),w();const N=sessionStorage.getItem("healthFocus");if(N){try{const a=JSON.parse(N);if((a==null?void 0:a.tab)==="suppliers"&&a.supplierId){const i=n.suppliers.find(t=>t.id===a.supplierId);i&&k(i)}else(a==null?void 0:a.tab)==="suppliers"&&a.sku&&(location.hash="#produkte")}catch{}sessionStorage.removeItem("healthFocus")}}const Q={render:G};export{Q as default,G as render};
