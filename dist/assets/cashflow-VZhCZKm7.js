import{g as pn}from"./planProducts-BiK-QjG5.js";import{by as gn,K as Dt,ah as Rt,bt as hn,V as Yt,bs as Ze,bu as Nn,Y as yn,Z as vn,P as X,ag as He,bz as Lt,an as Xe,bA as re,a0 as Wt}from"./index-CLY33OwN.js";function En(t){return Number.isFinite(t)?t:0}function k(t){if(typeof t=="number")return t;if(!t)return 0;const e=String(t).trim().replace(/\./g,"").replace(",","."),o=Number(e);return Number.isFinite(o)?o:0}function ot(t){if(t===""||t===null||t===void 0)return 0;const e=Number(String(t).replace(",","."));return Number.isFinite(e)?e:0}function Ft(t,e=k){if(t==null)return null;if(typeof t=="number")return Number.isFinite(t)?t:null;const o=String(t).trim();if(!o)return null;const l=e(o);return Number.isFinite(l)?l:null}function Pn(t){return String(t||"").trim().toLowerCase()==="conservative"?"conservative":"basis"}function Dn(t){return String(t||"").trim().toLowerCase()==="recommendation"?"recommendation":"manual"}function Rn(t){return String(t||"").trim().toLowerCase()==="forecast_direct"?"forecast_direct":"hybrid"}function Sn(t){if(!t)return null;if(t instanceof Set)return t.size?t:null;if(Array.isArray(t)){const e=t.map(o=>Rt(o,"")).filter(o=>Dt.includes(o));return e.length?new Set(e):null}return null}function Fn(t){return!t||typeof t!="object"?!1:String(t.kind||"").toLowerCase()==="sales-payout"}function An(t){if(!t||typeof t!="object")return null;const e=t.meta&&typeof t.meta=="object"?t.meta:null;return!e||typeof e.cashIn!="object"?null:e.cashIn}function kn(t,e){if(!e||!e.size)return!0;const o=t!=null&&t.meta&&typeof t.meta=="object"?t.meta:null,l=(t==null?void 0:t.portfolioBucket)||(o==null?void 0:o.portfolioBucket)||"",u=Rt(l,X.CORE);return e.has(u)}function we(t,e){const o=t&&typeof t=="object"?structuredClone(t):{};return e&&typeof e=="object"&&((!o.settings||typeof o.settings!="object")&&(o.settings={}),o.settings={...o.settings,...e}),o}function oe(t){const e=Number(t);return Number.isFinite(e)?e.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}):"0 €"}function bt(t,e=0){const o=Number(t);return Number.isFinite(o)?o.toLocaleString("de-DE",{minimumFractionDigits:e,maximumFractionDigits:e}):"0"}function vt(t,e=3){const o=Number(t);return Number.isFinite(o)?o.toLocaleString("de-DE",{minimumFractionDigits:e,maximumFractionDigits:e}):"—"}function ue(t){const e=String(t||"").trim().toLowerCase();return e==="ist"?"ist":e==="manual"?"manual":"plan"}function Je(t){const e=ue(t);return e==="ist"?"IST":e==="manual"?"Manuell":"Empfohlen (Plan)"}function Tn(t){const e=String(t||"").trim().toLowerCase();return e?e==="ist_month"?"Ist-Daten (Kalendermonat)":e==="history_month"?"Historie (Kalendermonat)":e==="no_data"?"Keine Historie":e==="disabled"?"Aus":e:""}function $n(t={}){const e=Number(t.recommendationLevelPct),o=Number(t.recommendationLevelAvg3Pct),l=Number(t.recommendationLevelAvg12Pct),u=Number(t.recommendationSeasonalityPct),f=Number(t.recommendationSeasonalityMonthMeanPct),d=Number(t.recommendationSeasonalityOverallMeanPct),m=Number(t.recommendationSafetyMarginPct),a=Number(t.recommendationRiskAdjustmentPct),p=Math.max(0,Math.round(Number(t.recommendationSeasonalitySampleCount||0))),c=Tn(t.recommendationSeasonalitySourceTag),y=String(t.recommendationSeasonalityProfileSource||"").trim(),R=Array.isArray(t.recommendationCapsApplied)?t.recommendationCapsApplied.filter(Boolean):[],P=[];if(Number.isFinite(e)||Number.isFinite(u)){const F=Number.isFinite(e)?bt(e,1):"—",h=Number.isFinite(u)?bt(u,1):"—";P.push(`L: ${F}% · S: ${h}%`)}if(Number.isFinite(o)||Number.isFinite(l)){const F=Number.isFinite(o)?bt(o,1):"—",h=Number.isFinite(l)?bt(l,1):"—";P.push(`Level: Ø3M ${F}% · Ø12M ${h}%`)}if(Number.isFinite(m)||Number.isFinite(a)){const F=Number.isFinite(m)?bt(m,1):"0,0",h=Number.isFinite(a)?bt(a,1):"0,0";P.push(`Sicherheitsmarge: ${F}pp · Gesamtabschlag: ${h}pp`)}if(Number.isFinite(f)||Number.isFinite(d)){const F=Number.isFinite(f)?bt(f,1):"—",h=Number.isFinite(d)?bt(d,1):"—";P.push(`Saison: Monat ${F}% · Gesamt ${h}%`)}else p>0&&P.push(`Saison-Samples: ${p}`);if(c&&P.push(`Saisonquelle: ${c}`),y&&P.push(`Saisonalitätsprofil: ${y}`),t.recommendationLiveSignalUsed===!0){const F=Number.isFinite(Number(t.recommendationLiveSignalWeight))?bt(Number(t.recommendationLiveSignalWeight)*100,0):"0";P.push(`Live-Signal aktiv (${F}% Gewicht)`)}return R.length&&P.push("Grenzwert angewendet"),P}function Cn({forecastRevenue:t,calibrationFactorApplied:e,planRevenue:o,payoutPct:l,payoutAmount:u,quoteSource:f,recommendationSourceTag:d,recommendationExplanation:m,cashInMeta:a}){const p=ue(a==null?void 0:a.mode),c=f==="manual"?"Manuell":Je(p),y=d==="IST"?"IST":d==="RECOMMENDED_PLAN"||d==="RECOMMENDED_BASIS"||d==="RECOMMENDED_CONSERVATIVE"?"Empfohlen (Plan)":d==="PROGNOSE"?"Live-Signal":"Empfehlung",P=Ze(a==null?void 0:a.calibrationMode)==="conservative"?"Konservativ":"Basis",F=Number.isFinite(e)&&Math.abs(Number(e)-1)>1e-6?Number(e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):null,h=[`Forecast-Umsatz: ${oe(t)}`,`Kalibrierfaktor K (${P}): ${F||"1,00"}`,`Plan-Umsatz: ${oe(o)}`,`Quote: ${bt(l)}% (${c}${f!=="manual"?`, ${y}`:""})`,`Auszahlung: ${oe(u)}`];if((a==null?void 0:a.calibrationEnabled)!==!1){const $=Number(a==null?void 0:a.calibrationFactorBasis),j=Number(a==null?void 0:a.calibrationFactorConservative);(Number.isFinite($)||Number.isFinite(j))&&h.push(`K_basis: ${vt($,3)} · K_cons: ${vt(j,3)}`);const w=Number(a==null?void 0:a.calibrationBiasB),V=Number(a==null?void 0:a.calibrationRiskR);(Number.isFinite(w)||Number.isFinite(V))&&h.push(`B: ${vt(w,3)} · R: ${vt(V,3)}`);const G=Number(a==null?void 0:a.calibrationLiveFactorClamped),g=Number(a==null?void 0:a.calibrationWeightTime),S=Number(a==null?void 0:a.calibrationWeightH),O=Number(a==null?void 0:a.calibrationWeightEffective),A=Math.max(1,Math.round(Number((a==null?void 0:a.calibrationDayOfMonth)||1)));h.push(`C_live: ${vt(G,3)} · W_time: ${vt(g,3)} · W_h: ${vt(S,3)} · W_eff: ${vt(O,3)} · d: ${A}`),(a==null?void 0:a.calibrationLiveAnchorEnabled)===!0&&Number.isFinite(O)&&O>0?h.push(`Kalibrierung mit Tagesgewicht aktiv (Tag ${A}, h=${Math.max(0,Math.round(Number((a==null?void 0:a.calibrationHorizonOffset)||0)))}, Gewicht ${vt(O,3)}).`):h.push("Kein zusätzlicher Tagesfaktor aktiv; Kalibrierung folgt dem gelernten Profil.")}else h.push("Kalibrierung deaktiviert (K = 1,00).");m&&f!=="manual"&&h.push(`Warum: ${m}`);const T=$n(a);return f!=="manual"&&T.length&&h.push(...T),h.join(" · ")}function Mn(t){const e=t||{},o=new Map,l=e!=null&&e.monthlyActuals&&typeof e.monthlyActuals=="object"?e.monthlyActuals:{};return Object.entries(l).forEach(([f,d])=>{if(!f)return;const m=Ft(d==null?void 0:d.realRevenueEUR,k),a=Ft(d==null?void 0:d.realPayoutEur,k),p=Ft(d==null?void 0:d.realPayoutRatePct,ot),c=Ft(d==null?void 0:d.realClosingBalanceEUR,k),y={};Number.isFinite(m)&&(y.revenue=m),Number.isFinite(a)&&(y.payout=a),Number.isFinite(p)&&(y.payoutRatePct=p),!Number.isFinite(y.payout)&&Number.isFinite(m)&&Number.isFinite(p)&&(y.payout=m*(p/100)),!Number.isFinite(y.payoutRatePct)&&Number.isFinite(m)&&m!==0&&Number.isFinite(a)&&(y.payoutRatePct=a/m*100),Number.isFinite(c)&&(y.closing=c),Object.keys(y).length&&o.set(f,y)}),(Array.isArray(e.actuals)?e.actuals:[]).forEach(f=>{if(!f||!f.month)return;const d=f.month,m=Ft(f.revenueEur,k),a=Ft(f.payoutEur,k),p=Ft(f.closingBalanceEur,k),c=o.get(d)||{};!Number.isFinite(c.revenue)&&Number.isFinite(m)&&(c.revenue=m),!Number.isFinite(c.payout)&&Number.isFinite(a)&&(c.payout=a),!Number.isFinite(c.closing)&&Number.isFinite(p)&&(c.closing=p),!Number.isFinite(c.payoutRatePct)&&Number.isFinite(m)&&m!==0&&Number.isFinite(a)&&(c.payoutRatePct=a/m*100),Object.keys(c).length&&o.set(d,c)}),o}function Zn(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format(En(Number(t)))}function xn(t,e){const[o,l]=t.split("-").map(Number),u=new Date(o,l-1+e,1);return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`}function tn(t,e){const o=[];for(let l=0;l<e;l++)o.push(xn(t,l));return o}function pt(t){const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}function ut(t,e){const o=new Date(t.getTime());return o.setDate(o.getDate()+(e||0)),o}function Ut(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function At(t){if(!t)return null;const e=new Date(t);return Number.isNaN(e.getTime())?null:e}function ie(t){const[e,o]=t.split("-").map(Number);return new Date(e,o,0)}function On(t,e){var d;const o=t==null?void 0:t.cny;if(o!=null&&o.start&&(o!=null&&o.end)){const m=At(o.start),a=At(o.end);if(m&&a&&a>=m)return{start:m,end:a}}const l=(d=t==null?void 0:t.cnyBlackoutByYear)==null?void 0:d[String(e)];if(!l)return null;const u=At(l.start),f=At(l.end);return!u||!f||f<u?null:{start:u,end:f}}function Ln(t,e,o){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return{prodDone:t,adjustmentDays:0};const l=Math.max(0,Number(e||0)),u=ut(t,l);if(!o||l===0)return{prodDone:u,adjustmentDays:0};let f=0;const d=t.getUTCFullYear(),m=u.getUTCFullYear();for(let p=d;p<=m;p+=1){const c=On(o,p);if(!c)continue;const y=c.start>t?c.start:t,R=c.end<u?c.end:u;if(R<y)continue;const P=Math.round((R.getTime()-y.getTime())/(24*60*60*1e3))+1;f+=Math.max(0,P)}return{prodDone:f?ut(u,f):u,adjustmentDays:f}}function Ke(t,e){const o=At(t.orderDate)||new Date,l=Number(t.productionLeadTimeDays??t.prodDays??0),u=Number(t.logisticsLeadTimeDays??t.transitDays??0),d=Ln(o,l,e).prodDone??ut(o,l),m=d,a=ut(m,u),p=At(t.etdManual),c=At(t.etaManual);return{ORDER_DATE:o,PROD_DONE:d,PRODUCTION_END:d,ETD:p||m,ETA:c||a}}function Un(t,e){const o=new Date(t.getTime());return o.setMonth(o.getMonth()+e),o}function _n(t){return new Date(t.getFullYear(),t.getMonth()+1,0)}function Et(t){if(!/^\d{4}-\d{2}$/.test(t||""))return null;const[e,o]=t.split("-").map(Number);return e*12+(o-1)}function Bn(t,e){const o=Array.isArray(t==null?void 0:t.items)?t.items:[];let l=0,u=0;if(o.length)o.forEach(p=>{const c=k((p==null?void 0:p.units)??0),y=k((p==null?void 0:p.unitCostUsd)??0),R=k((p==null?void 0:p.unitExtraUsd)??0),P=k((p==null?void 0:p.extraFlatUsd)??0),F=(y+R)*c+P,h=Math.max(0,Math.round(F*100)/100);Number.isFinite(h)&&(l+=h),Number.isFinite(c)&&(u+=c)});else{const p=k((t==null?void 0:t.units)??0),c=k((t==null?void 0:t.unitCostUsd)??0),y=k((t==null?void 0:t.unitExtraUsd)??0),R=k((t==null?void 0:t.extraFlatUsd)??0),P=(c+y)*p+R;l=Math.max(0,Math.round(P*100)/100),Number.isFinite(p)&&(u=p)}const f=k((t==null?void 0:t.fxOverride)??0),d=Number.isFinite(f)&&f>0?f:k((e==null?void 0:e.fxRate)??0)||0,m=d>0?Math.round(l/d*100)/100:0,a=k((t==null?void 0:t.goodsEur)??0);return{usd:l,eur:m>0?m:a,units:u}}function Ve(t,e){if(((t==null?void 0:t.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const l=k((t==null?void 0:t.freightPerUnitEur)??0),u=Number((e==null?void 0:e.units)??0)||0,f=l*u;return Math.round(f*100)/100}return k((t==null?void 0:t.freightEur)??0)}function jn(t){if(Array.isArray(t==null?void 0:t.items)&&t.items.length)return t.items.map(u=>{const f=String((u==null?void 0:u.sku)||"").trim();if(!f)return null;const d=(u==null?void 0:u.units)??(u==null?void 0:u.qty)??(u==null?void 0:u.quantity)??0,m=Math.max(0,k(d));return{...u,sku:f,units:m}}).filter(Boolean);const e=String((t==null?void 0:t.sku)||"").trim();if(!e)return[];const o=(t==null?void 0:t.units)??0,l=Math.max(0,k(o));return[{sku:e,units:l,unitCostUsd:t==null?void 0:t.unitCostUsd,unitExtraUsd:t==null?void 0:t.unitExtraUsd,extraFlatUsd:t==null?void 0:t.extraFlatUsd,prodDays:t==null?void 0:t.prodDays,transitDays:t==null?void 0:t.transitDays,freightEur:t==null?void 0:t.freightEur}]}function Ge(t){const e=(t==null?void 0:t.order)||{},o=(t==null?void 0:t.profileBySku)instanceof Map?t.profileBySku:new Map,l=(t==null?void 0:t.poSkuSet)instanceof Set?t.poSkuSet:new Set,u=(t==null?void 0:t.fallbackBucket)||X.CORE,f=jn(e);if(!f.length)return[{bucket:u,share:1,row:{...e,payments:Array.isArray(e==null?void 0:e.payments)?e.payments.filter(Boolean).map(a=>({...a})):e==null?void 0:e.payments}}];const d=new Map;let m=0;return f.forEach(a=>{const p=String((a==null?void 0:a.sku)||"").trim();if(!p)return;const c=Lt(p),y=o.get(c);if(!(y?y.includeInForecast:Xe(void 0,!0)))return;const P=y?y.effectivePortfolioBucket:re({sku:p,poSkuSet:l,fallbackBucket:u}),F=k((a==null?void 0:a.units)??0),h=Number.isFinite(F)&&F>0?F:1;m+=h,d.has(P)||d.set(P,{bucket:P,items:[],weight:0});const T=d.get(P);T.items.push(a),T.weight+=h}),d.size?Array.from(d.values()).map((a,p,c)=>{const y=m>0?a.weight/m:c.length?1/c.length:1,R=Array.isArray(e==null?void 0:e.payments)?e.payments.filter(Boolean).map(T=>{const $=Number(T==null?void 0:T.amount);return Number.isFinite($)?{...T,amount:Math.round($*y*100)/100}:{...T}}):void 0,P=(e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total",F=k((e==null?void 0:e.freightEur)??0),h={...e,items:a.items.map(T=>({...T})),payments:R,freightMode:P,freightEur:P==="total"?Math.round(F*y*100)/100:e==null?void 0:e.freightEur};return{bucket:a.bucket,share:y,row:h}}):[]}function zn(t,e,o){const l=new Date(t,e+1,0).getDate(),u=Math.min(Math.max(1,o),l);return new Date(t,e,u)}function en(t,e){const o=Et(t);if(o==null)return null;const l=Math.floor(o/12),u=o%12;if(!e||e==="LAST"||e==="Letzter Tag"||e==="EOM")return new Date(l,u+1,0);const f=Number(e);return Number.isFinite(f)?zn(l,u,f):new Date(l,u+1,0)}function In(t){const e=String(t||"").trim().toUpperCase();return e?e==="PLANNED"?"ACTIVE":e==="CANCELLED"?"ARCHIVED":e:"DRAFT"}function Wn(t){const e=In(t);return e==="DRAFT"||e==="ACTIVE"}function Qn(t,e,o,l){if(!e||!e.proration||e.proration.enabled!==!0)return{amount:t,applied:!1};if(e.proration.method!=="daily")return{amount:t,applied:!1};const u=Et(o);if(u==null)return{amount:t,applied:!1};const f=Math.floor(u/12),d=u%12,m=new Date(f,d+1,0).getDate(),a=l instanceof Date&&!Number.isNaN(l.getTime())?l:en(o,e.anchor),p=a instanceof Date?a.getDate():m;let c=1;e.startMonth&&e.startMonth===o&&(c*=Math.max(0,m-p+1)/m),e.endMonth&&e.endMonth===o&&(c*=Math.max(0,p)/m);const y=Math.round(t*c*100)/100;return!Number.isFinite(y)||y===t?{amount:t,applied:!1}:{amount:y,applied:!0}}function nn({statusRecord:t,autoEligible:e,autoManualCheck:o,entryTime:l,todayTime:u,defaultPaid:f}){const d=typeof(t==null?void 0:t.manual)=="boolean"?t.manual:void 0;let m=!1,a=!1;typeof d=="boolean"?m=d:e&&!o&&l!=null&&l<=u?(m=!0,a=!0):m=!!f;const p=e&&o&&!a;let c=null;return e&&(a?c="Automatisch bezahlt am Fälligkeitstag":o?c="Automatische Zahlung – manuelle Prüfung aktiv":c="Automatische Zahlung"),{paid:m,autoApplied:a,manualOverride:typeof d=="boolean",autoSuppressed:p,autoTooltip:c}}function qn(t,e={}){const o=t||{},l=e.startMonth||o.settings&&o.settings.startMonth||"2025-01",u=Number(e.horizon||o.settings&&o.settings.horizonMonths||12),f=Array.isArray(e.months)&&e.months.length?e.months:tn(l,u),d=Array.isArray(o.fixcosts)?o.fixcosts:[],m=o.fixcostOverrides&&typeof o.fixcostOverrides=="object"?o.fixcostOverrides:{},a=e.status&&typeof e.status=="object"?e.status:o.status||{},p=e.statusEvents&&typeof e.statusEvents=="object"?e.statusEvents:a.events||{},c=e.autoManualCheck!=null?e.autoManualCheck===!0:a.autoManualCheck===!0,y=e.today?new Date(e.today):new Date;y.setHours(0,0,0,0);const R=y.getTime(),P=[],F=new Set(f);return d.forEach((h,T)=>{if(!h)return;const $=h.id||`fix-${T}`,j=h.startMonth||l,w=Et(j);if(w==null)return;const V=h.endMonth||null,G=V?Et(V):null,g=(h.frequency||"monthly").toLowerCase();let S=1;g==="quarterly"?S=3:g==="semiannual"||g==="halbjährlich"?S=6:g==="annual"||g==="jährlich"||g==="yearly"?S=12:(g==="custom"||g==="benutzerdefiniert")&&(S=Number(h.intervalMonths||h.everyMonths||1)||1),S<1&&(S=1);const O=h.anchor,A=!O||O==="Letzter Tag"?"LAST":String(O),C=m[$]&&typeof m[$]=="object"?m[$]:{},z=h.name||"Fixkosten",W=h.category||"Sonstiges",Q=Math.abs(k(h.amount)),gt=h.notes||"",st=h.autoPaid===!0;f.forEach(q=>{if(!F.has(q))return;const tt=Et(q);if(tt==null||tt<w||G!=null&&tt>G||(tt-w)%S!==0)return;const x=en(q,A),J=C[q]&&typeof C[q]=="object"?C[q]:{};let it=x;if(J.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(J.dueDate)){const St=new Date(J.dueDate);Number.isNaN(St.getTime())||(it=St)}let kt=Q,ct=!1;J.amount!=null&&String(J.amount).trim()!==""&&(kt=Math.abs(k(J.amount)),ct=!0);let _t=!1;if(!ct){const St=Qn(Q,h,q,it);kt=St.amount,_t=St.applied}const Bt=`fix-${$}-${q}`,ht=it instanceof Date&&!Number.isNaN(it.getTime())?it.getTime():null,Tt=p[Bt],_=nn({statusRecord:Tt,autoEligible:st,autoManualCheck:c,entryTime:ht,todayTime:R,defaultPaid:!1}),Xt=it instanceof Date&&!Number.isNaN(it.getTime())?Ut(it):null,Qt=J.note||"",Nt=[z];ct&&Nt.push("Override aktiv"),_t&&Nt.push("Proratiert");const rt=Nt.length>1?Nt.join(" · "):null;P.push({id:Bt,month:q,amount:kt,baseAmount:Q,label:z,category:W,dueDate:it,dueDateIso:Xt,fixedCostId:$,autoPaid:st,notes:gt,override:{amount:J.amount||"",dueDate:J.dueDate||"",note:Qt},overrideActive:ct||!!J.dueDate||!!Qt,prorationApplied:_t,paid:_.paid,autoApplied:_.autoApplied,manualOverride:_.manualOverride,autoTooltip:_.autoTooltip,autoSuppressed:_.autoSuppressed,anchor:A,frequency:g,tooltip:rt})})}),P.sort((h,T)=>{if(h.month===T.month){const $=h.dueDate instanceof Date?h.dueDate.getTime():0,j=T.dueDate instanceof Date?T.dueDate.getTime():0;return $-j}return Et(h.month)-Et(T.month)}),P}function Hn(t){const e=t||{};return{dutyRatePct:ot(e.dutyRatePct??0),dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:ot(e.eustRatePct??0),vatRefundLagMonths:Number(e.vatRefundLagMonths??0)||0,vatRefundEnabled:e.vatRefundEnabled!==!1,freightLagDays:Number(e.freightLagDays??0)||0,fxFeePct:ot(e.fxFeePct??0)}}function Kn(t,e,o){const l=["freight","duty","eust","vat_refund","fx_fee"],u=Array.isArray(t.autoEvents)?t.autoEvents.filter(Boolean).map(a=>({...a})):[],f=new Map;for(const a of u)!a||!a.type||(a.id||(a.id=`auto-${a.type}`),f.set(a.type,a));const d=(o||[])[0]||null;function m(a,p){if(!f.has(a)){const y={id:`auto-${a}`,type:a,...p};return u.push(y),f.set(a,y),y}const c=f.get(a);c.id||(c.id=`auto-${a}`);for(const[y,R]of Object.entries(p))c[y]===void 0&&(c[y]=R);return c}if(m("freight",{label:"Fracht",anchor:"ETA",lagDays:e.freightLagDays,enabled:!0}),m("duty",{label:"Zoll",percent:e.dutyRatePct,anchor:"ETA",lagDays:e.freightLagDays}),m("eust",{label:"EUSt",percent:e.eustRatePct,anchor:"ETA",lagDays:e.freightLagDays}),m("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:e.vatRefundLagMonths,enabled:e.vatRefundEnabled}),m("fx_fee",{label:"FX-Gebühr",percent:e.fxFeePct,anchor:d&&d.anchor||"ORDER_DATE",lagDays:d&&Number(d.lagDays||0)||0}),u.sort((a,p)=>l.indexOf(a.type)-l.indexOf(p.type)),t.ddp)for(const a of u)(a.type==="freight"||a.type==="duty"||a.type==="eust"||a.type==="vat_refund")&&(a.enabled=!1);return u}function Ye(t,e,o,l){var G;if(!t)return[];const u=o||"PO",f=t[l],d=f?`${u} ${f}`:u;if(Array.isArray(t.payments)&&t.payments.length){const g=Ke(t,e);return t.payments.filter(Boolean).map((S,O)=>{const A=S.triggerEvent||"ORDER_DATE",C=A==="PROD_DONE"?"PROD_DONE":A,z=g[C]||g.ORDER_DATE,W=S.dueDate?new Date(S.dueDate):ut(z,Number(S.offsetDays||0)),Q=Number(S.amount||0),gt=Q>=0?"out":"in",st=Math.abs(Q);return{label:`${d}${S.label?` – ${S.label}`:""}`,amount:st,due:W,month:pt(W),direction:gt,type:"manual",anchor:C,lagDays:Number(S.offsetDays||0)||0,percent:Number(S.percent||0),sourceType:u,sourceNumber:f,sourceId:t.id,id:S.id||`${t.id||u}-pay-${O}`,tooltip:`Fälligkeit: ${C} + ${Number(S.offsetDays||0)} Tage`}})}const m=Bn(t,e),a=m.eur,p=Ve(t,m),c=Ke(t,e),y=Array.isArray(t.milestones)?t.milestones:[],R=Kn(t,e,y),P=[];for(const[g,S]of y.entries()){const O=ot(S.percent),A=c[S.anchor||"ORDER_DATE"]||c.ORDER_DATE,C=ut(A,Number(S.lagDays||0)),z=S.id||`${t.id||u}-${g}-${S.id||"manual"}`;P.push({label:`${d}${S.label?` – ${S.label}`:""}`,amount:a*(O/100),due:C,month:pt(C),direction:"out",type:"manual",anchor:S.anchor||"ORDER_DATE",lagDays:Number(S.lagDays||0)||0,percent:O,sourceType:u,sourceNumber:f,sourceId:t.id,id:z,tooltip:`Fälligkeit: ${S.anchor||"ORDER_DATE"} + ${Number(S.lagDays||0)} Tage`})}const F=t.dutyIncludeFreight!==!1,h=ot(t.dutyRatePct??e.dutyRatePct??0),T=ot(t.eustRatePct??e.eustRatePct??0),$=ot(t.fxFeePct??e.fxFeePct??0),j=Number(t.vatRefundLagMonths??e.vatRefundLagMonths??0),w=t.vatRefundEnabled!==!1,V={};for(const g of R){if(!g||g.enabled===!1)continue;const S=g.anchor||"ETA",O=c[S]||c.ETA;if(!(!(O instanceof Date)||Number.isNaN(O.getTime()))){if(g.type==="freight"){const A=Ve(t,m);if(!A)continue;const C=g.id||`${t.id||u}-auto-freight`,z=ut(O,Number(g.lagDays||0));P.push({label:`${d} – ${g.label||"Fracht"}`,amount:A,due:z,month:pt(z),direction:"out",type:"freight",anchor:g.anchor||"ETA",lagDays:Number(g.lagDays||0)||0,sourceType:u,sourceNumber:f,sourceId:t.id,id:C,tooltip:"Frachtkosten laut Eingabe"});continue}if(g.type==="duty"){const A=ot(g.percent??h),C=ut(O,Number(g.lagDays||0)),W=(a+(F?p:0))*(A/100),Q=g.id||`${t.id||u}-auto-duty`;V.duty={amount:W,due:C},P.push({label:`${d} – ${g.label||"Zoll"}`,amount:W,due:C,month:pt(C),direction:"out",type:"duty",anchor:g.anchor||"ETA",lagDays:Number(g.lagDays||0)||0,percent:A,sourceType:u,sourceNumber:f,sourceId:t.id,id:Q,tooltip:`Zoll = ${A}% × (Warenwert${F?" + Fracht":""})`});continue}if(g.type==="eust"){const A=ot(g.percent??T),C=Math.abs(((G=V.duty)==null?void 0:G.amount)||0),z=a+p+C,W=ut(O,Number(g.lagDays||0)),Q=z*(A/100),gt=g.id||`${t.id||u}-auto-eust`;V.eust={amount:Q,due:W},P.push({label:`${d} – ${g.label||"EUSt"}`,amount:Q,due:W,month:pt(W),direction:"out",type:"eust",anchor:g.anchor||"ETA",lagDays:Number(g.lagDays||0)||0,percent:A,sourceType:u,sourceNumber:f,sourceId:t.id,id:gt,tooltip:`EUSt = ${A}% × (Warenwert + Fracht + Zoll)`});continue}if(g.type==="vat_refund"){const A=V.eust;if(!w||!A||A.amount===0)continue;const C=ot(g.percent??100),z=Number((g.lagMonths??j)||0),W=ut(A.due||O,Number(g.lagDays||0)),Q=_n(Un(W,z)),gt=Math.abs(A.amount)*(C/100),st=g.id||`${t.id||u}-auto-vat`;P.push({label:`${d} – ${g.label||"EUSt-Erstattung"}`,amount:gt,due:Q,month:pt(Q),direction:"in",type:"vat_refund",anchor:g.anchor||"ETA",lagMonths:z,percent:C,sourceType:u,sourceNumber:f,sourceId:t.id,id:st,tooltip:`Erstattung am Monatsende nach ${z} Monaten`});continue}if(g.type==="fx_fee"){const A=ot(g.percent??$);if(!A)continue;const C=ut(O,Number(g.lagDays||0)),z=a*(A/100),W=g.id||`${t.id||u}-auto-fx`;P.push({label:`${d} – ${g.label||"FX-Gebühr"}`,amount:z,due:C,month:pt(C),direction:"out",type:"fx_fee",anchor:g.anchor||"ORDER_DATE",lagDays:Number(g.lagDays||0)||0,percent:A,sourceType:u,sourceNumber:f,sourceId:t.id,id:W,tooltip:`FX-Gebühr = ${A}% × Warenwert`})}}}return P}function an(t){var he,Ne,ye,ve,Ee,Pe,De,Re,Se,Fe,Ae,ke,Te,$e,Ce,Me,xe,Oe,Le;const e=t||{},o=e.settings&&e.settings.startMonth||"2025-01",l=Number(e.settings&&e.settings.horizonMonths||12),u=tn(o,l),f=e.status&&typeof e.status=="object"?e.status:{},d=f.events&&typeof f.events=="object"?f.events:{},m=f.autoManualCheck===!0,a=new Date;a.setHours(0,0,0,0);const p=a.getTime(),c={};u.forEach(n=>{c[n]={entries:[]}});const{map:y,poSkuSet:R}=gn(e);function P(n){const r=Lt(n);return r?y.get(r)||{includeInForecast:!0,effectivePortfolioBucket:re({sku:n,poSkuSet:R,fallbackBucket:X.CORE})}:{includeInForecast:!0,effectivePortfolioBucket:X.CORE}}function F(n,r){c[n]&&c[n].entries.push(r)}function h(n,r={}){const b=n.id||`${n.month||""}-${n.label||""}-${n.date||""}`,v=d[b],s=n.date?new Date(n.date):null,E=s&&Number.isFinite(s.getTime())?new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime():null,D=r.auto===!0,M=D&&r.autoEligible!==!1,i=typeof n.paid=="boolean"?n.paid:!!r.defaultPaid,B=nn({statusRecord:v,autoEligible:M,autoManualCheck:m,entryTime:E,todayTime:p,defaultPaid:i}),H={...n.meta&&typeof n.meta=="object"?n.meta:{}},Y=n.portfolioBucket?Rt(n.portfolioBucket,X.CORE):null;return Y&&(H.portfolioBucket=Y),{id:b,direction:n.direction||"in",amount:Math.abs(n.amount||0),label:n.label||"",month:n.month,date:n.date,kind:n.kind,group:n.group,paid:B.paid,source:n.source||null,anchor:n.anchor,lagDays:n.lagDays,lagMonths:n.lagMonths,percent:n.percent,scenarioDelta:n.scenarioDelta||0,scenarioAmount:n.scenarioAmount||n.amount||0,meta:H,portfolioBucket:Y,tooltip:n.tooltip,sourceTab:n.sourceTab,sourceNumber:n.sourceNumber,sourceId:n.sourceId,statusId:b,auto:D,autoEligible:M,autoApplied:B.autoApplied,autoManualCheck:m,manualOverride:B.manualOverride,autoSuppressed:B.autoSuppressed,autoTooltip:B.autoTooltip}}qn(e,{months:u,statusEvents:d,autoManualCheck:m,today:a}).map(n=>({id:n.id,direction:"out",amount:n.amount,label:n.label,month:n.month,date:n.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:n.fixedCostId,category:n.category,override:n.overrideActive,overrideAmount:n.override.amount,overrideDueDate:n.override.dueDate,overrideNote:n.override.note,notes:n.notes,baseAmount:n.baseAmount,prorationApplied:n.prorationApplied},tooltip:n.tooltip,auto:n.autoPaid,autoEligible:n.autoPaid})).forEach(n=>{F(n.month,h(n,{auto:n.auto,autoEligible:n.autoEligible}))});const $=!!((Ne=(he=e==null?void 0:e.forecast)==null?void 0:he.settings)!=null&&Ne.useForecast),j={},w={},V={},G=Dt.reduce((n,r)=>(n[r]={},n),{}),g=Dt.reduce((n,r)=>(n[r]={},n),{});if(u.forEach(n=>{j[n]=0,w[n]=0,V[n]=0,Dt.forEach(r=>{G[r][n]=0,g[r][n]=0})}),$){(ye=e==null?void 0:e.forecast)!=null&&ye.forecastImport&&typeof e.forecast.forecastImport=="object"?Object.entries(e.forecast.forecastImport).forEach(([r,b])=>{const v=P(r);if(!v.includeInForecast)return;const s=Rt(v.effectivePortfolioBucket,X.CORE);Object.entries(b||{}).forEach(([E,D])=>{if(!E||!c[E])return;const M=k((D==null?void 0:D.revenueEur)??(D==null?void 0:D.revenue)??null);Number.isFinite(M)&&(j[E]=(j[E]||0)+M,G[s][E]=(G[s][E]||0)+M)})}):Array.isArray((ve=e==null?void 0:e.forecast)==null?void 0:ve.items)&&e.forecast.items.forEach(r=>{if(!r||!r.month||!r.sku)return;const b=P(r.sku);if(!b.includeInForecast)return;const v=Rt(b.effectivePortfolioBucket,X.CORE),s=r.month;if(!c[s])return;const E=Number(r.qty??r.quantity??0)||0,D=k(r.priceEur??r.price??0),M=E*D;j[s]=(j[s]||0)+M,G[v][s]=(G[v][s]||0)+M});const n=pn({state:e,months:u});Object.entries((n==null?void 0:n.byBucket)||{}).forEach(([r,b])=>{const v=Rt(r,X.PLAN);Object.entries(b||{}).forEach(([s,E])=>{if(!c[s])return;const D=k(E);Number.isFinite(D)&&(w[s]=(w[s]||0)+D,g[v][s]=(g[v][s]||0)+D)})}),Object.keys(c).forEach(r=>{V[r]=(j[r]||0)+(w[r]||0)})}const S=Array.isArray(e.incomings)?e.incomings:[],O=new Map;S.forEach(n=>{if(!n||!n.month)return;const r=String(n.month||"").trim();r&&O.set(r,n)});const A=pt(a),C=Et(A),z=Pn((Ee=e==null?void 0:e.settings)==null?void 0:Ee.cashInMode),W=Dn((Pe=e==null?void 0:e.settings)==null?void 0:Pe.cashInQuoteMode),Q=Rn((De=e==null?void 0:e.settings)==null?void 0:De.cashInRevenueBasisMode),gt=((Re=e==null?void 0:e.settings)==null?void 0:Re.cashInRecommendationIgnoreQ4)===!0,st=((Se=e==null?void 0:e.settings)==null?void 0:Se.cashInRecommendationSeasonalityEnabled)==null?!gt:((Fe=e==null?void 0:e.settings)==null?void 0:Fe.cashInRecommendationSeasonalityEnabled)!==!1,q=vn,tt=yn,Zt=Mn(e),x=hn({months:Object.keys(c),incomings:S,monthlyActuals:e==null?void 0:e.monthlyActuals,currentMonth:A,seasonalityEnabled:st,ignoreQ4:!st,maxMonth:A,baselineNormalPct:(Ae=e==null?void 0:e.settings)==null?void 0:Ae.cashInRecommendationBaselineNormalPct,learningState:(ke=e==null?void 0:e.settings)==null?void 0:ke.cashInLearning,now:a instanceof Date?a:new Date(a),nowIso:a instanceof Date&&!Number.isNaN(a.getTime())?a.toISOString():new Date().toISOString(),minSamples:4}),J=Yt(x.observedNormalMedianPct),it=Number.isFinite(J)?Wt(J,q,tt):null,kt=Yt(x.baselineNormalPct),ct=Number.isFinite(kt)?Wt(kt,q,tt):51,_t=x.learningStateNext||x.learningState||null,Bt="learning_model",ht=((Te=e==null?void 0:e.settings)==null?void 0:Te.cashInCalibrationEnabled)!==!1,Tt=Ze(($e=e==null?void 0:e.settings)==null?void 0:$e.cashInCalibrationMode),_=Nn({incomings:S,months:Object.keys(c),forecastRevenueByMonth:V,mode:Tt,currentMonth:A,now:a,monthlyActuals:e==null?void 0:e.monthlyActuals,learningState:(Ce=e==null?void 0:e.settings)==null?void 0:Ce.revenueCalibration,sourceForecastVersionId:((Me=e==null?void 0:e.forecast)==null?void 0:Me.activeVersionId)||null}),Xt=Math.max(1,Math.round(Number(_.horizonMonths||3))),Qt=Array.isArray(_.evaluations)?_.evaluations:[],Nt=Array.isArray(_.candidates)?_.candidates:[],rt=Nt.length?Nt[Nt.length-1]:null,St=Qt.reduce((n,r)=>{if(!r||typeof r!="object")return n;const b=String(r.reason||"").trim()||"unknown";return n[b]=Number(n[b]||0)+1,n},{}),se=Object.values(_.byMonth||{}).filter(n=>{const r=Number((n==null?void 0:n.factor)||1);return Number.isFinite(r)&&Math.abs(r-1)>1e-6}).length,on=ht&&se>0,wt={},qt={};Object.keys(c).forEach(n=>{var We,Qe;const r=O.get(n)||null,b=String((r==null?void 0:r.source)||"").trim().toLowerCase(),s=(r==null?void 0:r.revenueEur)!=null&&String(r.revenueEur).trim()!==""?k(r.revenueEur):null,E=$&&Q==="hybrid"&&b==="manual"&&Number.isFinite(s),D=(r==null?void 0:r.payoutPct)!=null&&String(r.payoutPct).trim()!=="",M=D?Yt(r.payoutPct):null,i=((We=x.byMonth)==null?void 0:We[n])||null,B=ue((i==null?void 0:i.mode)||z),H=String((i==null?void 0:i.sourceTag)||"RECOMMENDED_PLAN"),Y=String((i==null?void 0:i.explanation)||"").trim()||null,$t=Yt(i==null?void 0:i.quotePct),Ct=Number.isFinite($t)?Wt($t,q,tt):ct,Mt=W==="recommendation"?"recommendation":D?"manual":"recommendation",jt=Wt(Mt==="manual"?M:Ct,q,tt),I=((Qe=_.byMonth)==null?void 0:Qe[n])||{factor:1,factorBasis:1,factorConservative:1,sourceMonth:null,method:null,horizonOffset:0,signal:null,biasB:Number(_.biasB||1),riskR:Number(_.riskR||0),cLiveRaw:null,cLive:null,wTime:0,wH:0,wEff:0,dayOfMonth:a.getDate(),liveAnchorEnabled:!1},dt=Number(V[n]||0),xt=Number(I.factorBasis||1),zt=Number(I.factorConservative||1),N=Number(I.factor||(Tt==="conservative"?zt:xt)),L=ht&&Number.isFinite(N)?Number(N):1,It=dt*L,sn=dt*xt,cn=dt*zt;let K=null,Vt=null;if($)E?(K=Number(s),Vt="manual_override"):(K=Number(ht?It:dt),Vt=ht?"forecast_calibrated":"forecast_raw");else{if(!Number.isFinite(s))return;K=Number(s),Vt="manual_no_forecast"}if(!Number.isFinite(K))return;const _e=Et(n),Be=_e!=null&&C!=null?_e-C:0,ln=Be>0,Gt=Wt(jt,q,tt),je=$?E?Number(s):ht?It:dt:K,dn=$?dt:K,ze=Array.isArray(i==null?void 0:i.capsApplied)?i.capsApplied.filter(Boolean):[],fn=Mt==="manual"?"Manuell":Je(B);wt[n]=Gt,qt[n]={mode:B,calibrationEnabled:ht,isFutureMonth:ln,horizonFromCurrentMonth:Be,recommendationQuotePct:Ct,recommendationSourceTag:H,recommendationExplanation:Y,recommendationLevelPct:Number(i==null?void 0:i.levelPct),recommendationLevelAvg3Pct:Number(i==null?void 0:i.levelAvg3Pct),recommendationLevelAvg12Pct:Number(i==null?void 0:i.levelAvg12Pct),recommendationLevelRecentMonths:Array.isArray(i==null?void 0:i.levelRecentMonths)?i.levelRecentMonths:[],recommendationLevelWindowMonths:Array.isArray(i==null?void 0:i.levelWindowMonths)?i.levelWindowMonths:[],recommendationSeasonalityPct:Number(i==null?void 0:i.seasonalityPct),recommendationSeasonalityRawPct:Number(i==null?void 0:i.seasonalityRawPct),recommendationSeasonalityPriorPct:Number(i==null?void 0:i.seasonalityPriorPct),recommendationSeasonalityWeight:Number(i==null?void 0:i.seasonalityWeight),recommendationSeasonalitySampleCount:Number(i==null?void 0:i.seasonalitySampleCount),recommendationSeasonalitySourceTag:String((i==null?void 0:i.seasonalitySourceTag)||""),recommendationSeasonalityProfileSource:String((i==null?void 0:i.seasonalityProfileSource)||""),recommendationSeasonalityMonthMeanPct:Number(i==null?void 0:i.seasonalityMonthMeanPct),recommendationSeasonalityOverallMeanPct:Number(i==null?void 0:i.seasonalityOverallMeanPct),recommendationShrinkageActive:(i==null?void 0:i.shrinkageActive)===!0,recommendationRiskBasePct:Number(i==null?void 0:i.riskBasePct),recommendationRiskAdjustmentPct:Number(i==null?void 0:i.riskAdjustmentPct),recommendationSafetyMarginPct:Number(i==null?void 0:i.safetyMarginPct),recommendationRiskExtraPct:Number(i==null?void 0:i.riskExtraPct),recommendationHorizonMonths:Number(i==null?void 0:i.horizonMonths),recommendationCapsApplied:ze,recommendationCapApplied:(i==null?void 0:i.capApplied)===!0||ze.length>0,recommendationLiveSignalUsed:(i==null?void 0:i.liveSignalUsed)===!0,recommendationLiveSignalWeight:Number(i==null?void 0:i.liveSignalWeight),recommendationLiveSignalQuotePct:Number(i==null?void 0:i.liveSignalQuotePct),recommendationSeasonalityEnabled:(i==null?void 0:i.seasonalityEnabled)!==!1&&st,payoutPct:Gt,manualPayoutPct:M,quoteSource:Mt,quoteLabel:fn,quoteMode:W,revenueSource:Vt,revenueBasisMode:Q,appliedRevenue:K,forecastRevenueRaw:dt,calibrationMode:Tt,calibrationFactorApplied:L,calibrationFactorBasis:xt,calibrationFactorConservative:zt,calibrationSignal:Number(I.signal),calibrationBiasB:Number(I.biasB),calibrationRiskR:Number(I.riskR),calibrationLiveFactorRaw:Number(I.cLiveRaw),calibrationLiveFactorClamped:Number(I.cLive),calibrationWeightTime:Number(I.wTime),calibrationWeightH:Number(I.wH),calibrationWeightEffective:Number(I.wEff),calibrationDayOfMonth:Number(I.dayOfMonth),calibrationHorizonOffset:Number(I.horizonOffset),calibrationLiveAnchorEnabled:I.liveAnchorEnabled===!0,calibrationSourceMonth:I.sourceMonth||null,calibrationMethod:I.method||null,planRevenueAfterCalibration:je,calibratedRevenueBasis:sn,calibratedRevenueConservative:cn,fallbackUsed:Bt,quoteMinPct:q,quoteMaxPct:tt};const mn=ie(n),Ie=({id:U,label:yt,source:Z,sourceTab:et,component:nt,componentRevenueRaw:at,portfolioBucket:mt,componentRevenue:qe})=>{const Ot=Number(qe||0)*(Gt/100);if(Math.abs(Ot)<=1e-6)return;const bn=Cn({forecastRevenue:dn,calibrationFactorApplied:L,planRevenue:je,payoutPct:Gt,payoutAmount:Ot,quoteSource:Mt,recommendationSourceTag:H,recommendationExplanation:Y,cashInMeta:qt[n]});F(n,h({id:U,direction:Ot>=0?"in":"out",amount:Math.abs(Ot),label:yt,month:n,date:Ut(mn),kind:"sales-payout",group:Ot>=0?"Sales × Payout":"Extras (Out)",source:Z,sourceTab:et,tooltip:bn,portfolioBucket:mt,meta:{cashIn:{...qt[n],revenue:Number(qe||0),payoutAmount:Ot,component:nt,componentRevenueRaw:Number(at||0),portfolioBucket:mt}}},{auto:!1}))};if(!$){Ie({id:`sales-manual-${n}`,label:"Amazon Payout",source:"sales",sourceTab:"#eingaben",component:"manual_no_forecast",componentRevenueRaw:K,portfolioBucket:X.CORE,componentRevenue:K});return}const ft=[];if(E){const U=[];Dt.forEach(Z=>{var at,mt;const et=Number(((at=G[Z])==null?void 0:at[n])||0);et>0&&U.push({bucketName:Z,source:"sales",sourceTab:"#eingaben",component:"live",weight:et,componentRevenueRaw:et,label:`Amazon Payout (Manuell-Override - Live/CSV · ${Z})`});const nt=Number(((mt=g[Z])==null?void 0:mt[n])||0);nt>0&&U.push({bucketName:Z,source:"sales-plan",sourceTab:"#eingaben",component:"plan",weight:nt,componentRevenueRaw:nt,label:`Amazon Payout (Manuell-Override - Plan · ${Z})`})});const yt=U.reduce((Z,et)=>Z+Number(et.weight||0),0);if(yt>0){U.forEach(at=>{ft.push({...at,componentRevenue:K*Number(at.weight||0)/yt})});const Z=ft.reduce((at,mt)=>at+Number(mt.componentRevenue||0),0),et=Number(K||0)-Z,nt=ft[ft.length-1];nt&&(nt.componentRevenue=Number(nt.componentRevenue||0)+et)}else ft.push({bucketName:X.CORE,source:"sales",sourceTab:"#eingaben",component:"manual_fallback",componentRevenueRaw:K,componentRevenue:K,label:"Amazon Payout (Manuell-Override · Fallback)"})}else Dt.forEach(U=>{var at,mt;const yt=Number(((at=G[U])==null?void 0:at[n])||0),Z=yt*L;Math.abs(Z)>1e-6&&ft.push({bucketName:U,source:"sales",sourceTab:"#forecast",component:"live",componentRevenueRaw:yt,componentRevenue:Z,label:`Amazon Payout (Prognose - Live/CSV · ${U})`});const et=Number(((mt=g[U])==null?void 0:mt[n])||0),nt=et*L;Math.abs(nt)>1e-6&&ft.push({bucketName:U,source:"sales-plan",sourceTab:"#forecast",component:"plan",componentRevenueRaw:et,componentRevenue:nt,label:`Amazon Payout (Prognose - Plan · ${U})`})});!ft.length&&Math.abs(Number(K||0))>1e-6&&ft.push({bucketName:X.CORE,source:"sales",sourceTab:$?"#forecast":"#eingaben",component:"fallback",componentRevenueRaw:K,componentRevenue:K,label:"Amazon Payout"}),ft.forEach((U,yt)=>{Ie({id:`sales-${U.component}-${U.bucketName}-${n}-${yt+1}`,label:U.label,source:U.source,sourceTab:U.sourceTab,component:U.component,componentRevenueRaw:U.componentRevenueRaw,portfolioBucket:U.bucketName,componentRevenue:U.componentRevenue})})}),(Array.isArray(e.extras)?e.extras:[]).forEach(n=>{const r=n.month||(n.date?pt(n.date):null);if(!r||!c[r])return;const b=k(n.amountEur),v=b>=0?"in":"out",s=r,E=n.date?new Date(n.date):ie(s);F(s,h({id:`extra-${n.id||n.label||s}-${n.date||""}`,direction:v,amount:Math.abs(b),label:n.label||"Extra",month:s,date:Ut(E),kind:"extra",group:v==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:n.autoPaid===!0,autoEligible:n.autoPaid===!0}))}),(Array.isArray(e.dividends)?e.dividends:[]).forEach(n=>{const r=n.month||(n.date?pt(n.date):null);if(!r||!c[r])return;const b=k(n.amountEur),v=n.date?new Date(n.date):ie(r);F(r,h({id:`div-${n.id||n.label||r}`,direction:b>=0?"out":"in",amount:Math.abs(b),label:n.label||"Dividende",month:r,date:Ut(v),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))}),(Array.isArray(e.products)?e.products:[]).forEach((n,r)=>{const b=n&&typeof n=="object"?n:{},v=String(b.sku||"").trim();if(!v)return;const s=P(v);if(!s.includeInForecast)return;const E=Rt(s.effectivePortfolioBucket,X.CORE),D=String(b.alias||v).trim()||v;He(b.launchCosts,`prod-${r+1}-lc`).forEach((i,B)=>{const H=String(i.date||"").slice(0,7);!H||!c[H]||F(H,h({id:`launch-product-${Lt(v)}-${i.id||B+1}`,direction:"out",amount:Math.abs(k(i.amountEur)),label:`${D} · Launch-Kosten (${i.type||"Sonstiges"})`,month:H,date:i.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#products",portfolioBucket:E,meta:{sku:v,alias:D,type:i.type||"Sonstiges",note:i.note||"",currency:i.currency||"EUR"}},{auto:!1}))})}),(Array.isArray(e.planProducts)?e.planProducts:[]).forEach((n,r)=>{const b=n&&typeof n=="object"?n:{};if(String(b.status||"active").trim().toLowerCase()!=="active"||!Xe(b.includeInForecast,!0))return;const E=String(b.plannedSku||b.mappedSku||"").trim(),D=re({product:b,sku:E,poSkuSet:R,fallbackBucket:X.PLAN}),M=String(b.alias||E||`Planprodukt ${r+1}`).trim();He(b.launchCosts,`plan-${r+1}-lc`).forEach((B,H)=>{const Y=String(B.date||"").slice(0,7);!Y||!c[Y]||F(Y,h({id:`launch-plan-${Lt(E||M)}-${B.id||H+1}`,direction:"out",amount:Math.abs(k(B.amountEur)),label:`${M} · Launch-Kosten (${B.type||"Sonstiges"})`,month:Y,date:B.date,kind:"launch-cost",group:"Launch-Kosten",source:"launch-costs",sourceTab:"#plan-products",portfolioBucket:D,meta:{sku:E||null,alias:M,type:B.type||"Sonstiges",note:B.note||"",currency:B.currency||"EUR",source:"plan-product"}},{auto:!1}))})});const ce=Hn(e.settings);(Array.isArray(e.pos)?e.pos:[]).forEach(n=>{const r=Ge({order:n,profileBySku:y,poSkuSet:R,fallbackBucket:X.CORE}),b=r.length>1;r.forEach(v=>{Ye(v.row,ce,"PO","poNo").forEach(s=>{const E=s.month;if(!c[E])return;const D=s.type==="manual"?"po":s.type==="vat_refund"?"po-refund":"po-import",M=D==="po"?"PO/FO-Zahlungen":"Importkosten";F(E,h({id:b?`${s.id||`po-${n.id||""}-${s.type}-${s.month}`}-${Lt(v.bucket)}`:s.id||`po-${n.id||""}-${s.type}-${s.month}`,direction:s.direction==="in"?"in":"out",amount:Math.abs(s.amount||0),label:s.label,month:E,date:Ut(s.due),kind:D,group:M,source:"po",sourceTab:"#po",anchor:s.anchor,lagDays:s.lagDays,lagMonths:s.lagMonths,percent:s.percent,sourceNumber:s.sourceNumber||n.poNo||n.id,sourceId:n.id||n.poNo||null,tooltip:s.tooltip,portfolioBucket:v.bucket,meta:{skuBucketShare:v.share}},{auto:s.type!=="manual",autoEligible:s.type!=="manual"}))})})}),(Array.isArray(e.fos)?e.fos:[]).forEach(n=>{if(!Wn(n==null?void 0:n.status))return;const r=Ge({order:n,profileBySku:y,poSkuSet:R,fallbackBucket:X.CORE}),b=r.length>1;r.forEach(v=>{Ye(v.row,ce,"FO","foNo").forEach(s=>{const E=s.month;if(!c[E])return;const D=s.type==="manual"?"fo":s.type==="vat_refund"?"fo-refund":"fo-import",M=D==="fo"?"PO/FO-Zahlungen":"Importkosten";F(E,h({id:b?`${s.id||`fo-${n.id||""}-${s.type}-${s.month}`}-${Lt(v.bucket)}`:s.id||`fo-${n.id||""}-${s.type}-${s.month}`,direction:s.direction==="in"?"in":"out",amount:Math.abs(s.amount||0),label:s.label,month:E,date:Ut(s.due),kind:D,group:M,source:"fo",sourceTab:"#fo",anchor:s.anchor,lagDays:s.lagDays,lagMonths:s.lagMonths,percent:s.percent,sourceNumber:s.sourceNumber||n.foNo||n.foNumber||n.id,sourceId:n.id||n.foNo||n.foNumber||null,tooltip:s.tooltip,portfolioBucket:v.bucket,meta:{skuBucketShare:v.share}},{auto:!1,autoEligible:!1,defaultPaid:!1}))})})});const Ht=u.map(n=>{const b=c[n].entries||[],v=b.filter(N=>N.direction==="in"),s=b.filter(N=>N.direction==="out"),E=s.filter(N=>N.group==="Fixkosten"),D=E.reduce((N,L)=>N+(L.amount||0),0),M=E.filter(N=>N.paid).reduce((N,L)=>N+(L.amount||0),0),i=Math.max(0,D-M),B=E.slice().sort((N,L)=>(L.amount||0)-(N.amount||0)).slice(0,3).map(N=>({label:N.label,amount:N.amount,paid:N.paid,category:N.meta&&N.meta.category?N.meta.category:null})),H=v.reduce((N,L)=>N+(L.amount||0),0),Y=s.reduce((N,L)=>N+(L.amount||0),0),$t=v.filter(N=>N.paid).reduce((N,L)=>N+(L.amount||0),0),Ct=s.filter(N=>N.paid).reduce((N,L)=>N+(L.amount||0),0),Mt=Math.max(0,H-$t),Ue=Math.max(0,Y-Ct),jt={},I={};Dt.forEach(N=>{jt[N]=0,I[N]=0}),b.forEach(N=>{var It;const L=Rt((N==null?void 0:N.portfolioBucket)||((It=N==null?void 0:N.meta)==null?void 0:It.portfolioBucket),"");!L||!Dt.includes(L)||(N.direction==="in"?jt[L]+=Math.abs(Number(N.amount||0)):N.direction==="out"&&(I[L]+=Math.abs(Number(N.amount||0))))});const dt=H-Y,xt=$t-Ct,zt=dt-xt;return{month:n,inflow:{total:H,paid:$t,open:Mt},outflow:{total:Y,paid:Ct,open:Ue},bucketBreakdown:{inflow:jt,outflow:I},net:{total:dt,paid:xt,open:zt},fixcost:{total:D,paid:M,open:i,top:B},itemsIn:v.map(N=>({kind:N.kind,label:N.label,amount:N.amount})),itemsOut:s.map(N=>({kind:N.kind,label:N.label,amount:N.amount})),entries:b}}),Kt=k(e.settings&&e.settings.openingBalance),Jt=Ht.map(n=>n.itemsIn.filter(r=>r.kind==="sales-payout").reduce((r,b)=>r+b.amount,0)),le=Jt.length?Jt.reduce((n,r)=>n+r,0)/(Jt.filter(n=>n>0).length||1):0,de={},fe={};Object.keys(c).forEach(n=>{const r=qt[n];if(!r)return;const b=Number(r.appliedRevenue||0),v=Number.isFinite(wt[n])?Number(wt[n]):ct;de[n]=b,fe[n]=b*(v/100)});const te={opening:Kt,openingToday:Kt,salesPayoutAvg:le,avgSalesPayout:le,firstNegativeMonth:null,actuals:{},cashIn:{mode:x.mode||"plan",basisMethod:"learning",basisQuotePct:ct,istMonthsCount:x.sampleCount,hasIstData:x.sampleCount>0,fallbackUsed:Bt,quoteMinPct:q,quoteMaxPct:tt,recommendationMode:x.mode||"plan",recommendationSeasonalityEnabled:x.seasonalityEnabled!==!1,recommendationMedianPct:it,recommendationSampleCount:x.sampleCount,recommendationUsedMonths:x.usedMonths,recommendationUncertain:x.uncertain,recommendationIgnoreQ4:x.ignoreQ4,recommendationBaselineNormalPct:ct,recommendationObservedNormalMedianPct:x.observedNormalMedianPct,recommendationObservedNormalAveragePct:x.observedNormalAveragePct,recommendationObservedNormalSampleCount:x.observedNormalSampleCount,recommendationObservedNormalWithForecastMedianPct:x.observedNormalWithForecastMedianPct,recommendationObservedNormalWithForecastAveragePct:x.observedNormalWithForecastAveragePct,recommendationObservedNormalWithForecastSampleCount:x.observedNormalWithForecastSampleCount,recommendationCurrentMonthForecastQuotePct:x.currentMonthForecastQuotePct,recommendationCurrentMonth:x.currentMonth,recommendationRiskBasePct:Number(x.riskBasePct||0),recommendationLevelPct:Number(x.levelPct||ct),recommendationLearningState:_t,calibrationEnabled:ht,calibrationMode:Tt,calibrationApplied:on,calibrationHorizonMonths:Xt,calibrationCandidateCount:Nt.length,calibrationLatestCandidateMonth:(rt==null?void 0:rt.month)||null,calibrationLatestRawFactor:Number.isFinite(Number(rt==null?void 0:rt.rawFactor))?Number(rt==null?void 0:rt.rawFactor):null,calibrationNonDefaultFactorMonthCount:se,calibrationReasonCounts:St,calibrationBiasB:Number(_.biasB),calibrationRiskR:Number(_.riskR),calibrationLiveFactorRaw:Number((xe=_.liveAnchor)==null?void 0:xe.cLiveRaw),calibrationLiveFactorClamped:Number((Oe=_.liveAnchor)==null?void 0:Oe.cLive),calibrationLearningState:_.learningStateNext||null,calibrationLockAddedMonths:Array.isArray((Le=_.learning)==null?void 0:Le.lockAddedMonths)?_.learning.lockAddedMonths:[]}};let ee=Kt;const me=u.map((n,r)=>{const b=Ht[r],v=ee;return ee+=b.net.total,{month:n,opening:v,closing:ee,inflow:b.inflow.total,outflow:b.outflow.total,net:b.net.total,entries:b.entries}});let be=Kt;const pe=u.map((n,r)=>{var i;const b=Ht[r],v=be,s=v+b.net.total,E=(i=Zt.get(n))==null?void 0:i.closing,D=Number.isFinite(E),M=D?Number(E):s;return be=M,{month:n,opening:v,closing:M,inflow:b.inflow.total,outflow:b.outflow.total,net:b.net.total,entries:b.entries,plannedClosing:s,hasActualClosing:D,actualClosing:D?Number(E):null}}),ge=pe.find(n=>Number(n.closing||0)<0);te.firstNegativeMonth=ge?ge.month:null;const Pt=[];Zt.forEach((n,r)=>{const b=u.indexOf(r);if(b===-1)return;const v=b>=0&&b<me.length?me[b]:null,s=v?v.closing:null,E=de[r]??null,D=fe[r]??null;Pt.push({month:r,plannedRevenue:E,actualRevenue:n.revenue,revenueDelta:(n.revenue??0)-(E??0),revenueDeltaPct:E?((n.revenue??0)-E)/E*100:null,plannedPayout:D,actualPayout:n.payout,payoutDelta:(n.payout??0)-(D??0),payoutDeltaPct:D?((n.payout??0)-D)/D*100:null,plannedClosing:s,actualClosing:n.closing,closingDelta:(n.closing??0)-(s??0)})}),Pt.sort((n,r)=>(n.month||"").localeCompare(r.month||""));const lt=Pt[Pt.length-1]||null,ne=Pt.map(n=>n.revenueDeltaPct).filter(n=>Number.isFinite(n)),ae=Pt.map(n=>n.payoutDeltaPct).filter(n=>Number.isFinite(n)),rn=ne.length?ne.reduce((n,r)=>n+r,0)/ne.length:null,un=ae.length?ae.reduce((n,r)=>n+r,0)/ae.length:null;return te.actuals={count:Pt.length,lastMonth:lt?lt.month:null,lastClosing:lt?lt.actualClosing:null,closingDelta:lt?lt.closingDelta:null,revenueDeltaPct:lt?lt.revenueDeltaPct:null,payoutDeltaPct:lt?lt.payoutDeltaPct:null,avgRevenueDeltaPct:rn,avgPayoutDeltaPct:un},{startMonth:o,horizon:l,months:u,series:Ht,kpis:te,breakdown:pe,actualComparisons:Pt}}function Vn(t,e,o=null,l={}){const u=String(t||"").trim();if(!u)return{month:u,revenueUsedEUR:null,revenueSource:null,payoutPctUsed:null,payoutSource:null,payoutEUR:0};const f=we(e,o),d=l&&l.report&&typeof l.report=="object"?l.report:an(f),a=(Array.isArray(d==null?void 0:d.series)?d.series:[]).find(T=>String((T==null?void 0:T.month)||"")===u)||null,c=(Array.isArray(a==null?void 0:a.entries)?a.entries:[]).filter(Fn),y=Sn((l==null?void 0:l.bucketScope)||null);let R=null;for(const T of c){const $=An(T);if($){R=$;break}}const P=c.reduce((T,$)=>{if(!kn($,y))return T;const j=Math.abs(Number(($==null?void 0:$.amount)||0));return!Number.isFinite(j)||j<=0?T:String(($==null?void 0:$.direction)||"").toLowerCase()==="out"?T-j:T+j},0),F=Number(R==null?void 0:R.appliedRevenue),h=Number(R==null?void 0:R.payoutPct);return{month:u,revenueUsedEUR:Number.isFinite(F)?F:null,revenueSource:R!=null&&R.revenueSource?String(R.revenueSource):null,payoutPctUsed:Number.isFinite(h)?h:null,payoutSource:R!=null&&R.quoteSource?String(R.quoteSource):null,payoutEUR:Number.isFinite(P)?P:0}}function Xn(t,e,o=null,l={}){const u=Array.isArray(t)?t:[],f=we(e,o),d=l&&l.report&&typeof l.report=="object"?l.report:an(f),m={};return u.forEach(a=>{const p=String(a||"").trim();p&&(m[p]=Vn(p,f,null,{...l,report:d}))}),m}export{Xn as b,an as c,qn as e,Zn as f,k as p};
