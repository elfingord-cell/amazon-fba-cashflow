import{g as be,e as Fe,u as Ie,o as $e,f as Ve,h as Be,i as ke,v as _e,j as ze}from"./index-C5hLbMu6.js";import{b as Ke}from"./supplierLabels-BolgyxWX.js";import{b as He,p as je,D as qe}from"./prefill-CV-Sdcix.js";import{l as he,c as zt}from"./store-D6wC8Xks.js";import{u as We}from"./useDraftForm-CXbo99ss.js";const Ne=24*60*60*1e3;function Ut(t){if(t instanceof Date)return new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));if(typeof t!="string")throw new Error(`Invalid date: ${t}`);const[n,i,a]=t.split("-").map(Number);if(!n||!i||!a)throw new Error(`Invalid ISO date: ${t}`);return new Date(Date.UTC(n,i-1,a))}function Kt(t){const n=t.getUTCFullYear(),i=String(t.getUTCMonth()+1).padStart(2,"0"),a=String(t.getUTCDate()).padStart(2,"0");return`${n}-${i}-${a}`}function Ue(t){const n=t.getUTCFullYear(),i=String(t.getUTCMonth()+1).padStart(2,"0");return`${n}-${i}`}function Ct(t){const[n,i]=t.split("-").map(Number);if(!n||!i)throw new Error(`Invalid month: ${t}`);return{year:n,month:i-1}}function Ye(t,n){const i=Ct(t),a=Ct(n),d=i.year*12+i.month,D=a.year*12+a.month;return d-D}function Xe(t,n){const{year:i,month:a}=Ct(t),d=new Date(Date.UTC(i,a,1));return d.setUTCMonth(d.getUTCMonth()+n),Ue(d)}function Qe(t){const{year:n,month:i}=Ct(t);return new Date(Date.UTC(n,i,1))}function Ze(t,n){return new Date(Date.UTC(t,n+1,0)).getUTCDate()}function Wt(t,n){return new Date(t.getTime()+n*Ne)}function Ge(t,n,i,a){if(!t||!n||!i||!a)return 0;const d=Ut(t),D=Ut(n),y=Ut(i),v=Ut(a);if(!d||!D||!y||!v)return 0;const E=d>y?d:y,T=Wt(v,1),O=(D<T?D:T).getTime()-E.getTime();return O<=0?0:Math.ceil(O/Ne)}function Je(t=[]){let n=null;return t.forEach(i=>{const a=i==null?void 0:i.month;a&&(!n||Ye(a,n)>0)&&(n=a)}),n}function tn({sku:t,baselineMonth:n,stock0:i=0,forecastByMonth:a={},inboundByMonth:d={},horizonMonths:D=12}){const y=[],v=[];let E=Number(i||0);for(let T=1;T<=D;T+=1){const S=Xe(n,T),O=a==null?void 0:a[S],A=Number.isFinite(Number(O))?Number(O):0;O==null&&v.push(S);const p=Number((d==null?void 0:d[S])||0),{year:C,month:P}=Ct(S),L=Ze(C,P),b=A===0?0:A/L,R=E+p-A,k=b===0?Number.POSITIVE_INFINITY:Math.max(0,R/b);y.push({month:S,startStock:E,inbound:p,demand:A,endStock:R,avgDailyDemand:b,doh:k}),E=R}return{sku:t,baselineMonth:n,months:y,missingForecastMonths:v}}function en({sku:t,baselineMonth:n,projection:i,safetyStockDays:a=60,coverageDays:d=90,leadTimeDays:D=0,cnyPeriod:y,inboundWithoutEtaCount:v=0,moqUnits:E=0}){var k;if(!n)return{sku:t,status:"no_snapshot",issues:[]};const T=(k=i==null?void 0:i.months)==null?void 0:k.find(m=>Number.isFinite(m.doh)&&m.doh<a);if(!T)return{sku:t,status:"no_fo_needed",baselineMonth:n,issues:ve(i,v)};const S=Qe(T.month),O=Wt(S,-Number(D||0)),A=Ge(O,S,y==null?void 0:y.start,y==null?void 0:y.end),p=A>0?Wt(O,-A):O,C=Number(a||0)+Number(d||0),P=T.avgDailyDemand*C,L=T.startStock;let b=Math.max(0,Math.ceil(P-L)),R=!1;return b>0&&E>0&&b<E&&(b=E,R=!0),{sku:t,status:"ok",baselineMonth:n,criticalMonth:T.month,requiredArrivalDate:Kt(S),orderDate:Kt(O),orderDateAdjusted:Kt(p),overlapDays:A,recommendedUnits:b,safetyStockDays:a,coverageDays:d,moqUnits:E,moqApplied:R,stockAtArrival:L,avgDailyDemand:T.avgDailyDemand,issues:ve(i,v)}}function ve(t,n){var d;const i=[],a=((d=t==null?void 0:t.missingForecastMonths)==null?void 0:d.length)||0;return a>0&&i.push({code:"MISSING_FORECAST",count:a}),n>0&&i.push({code:"INBOUND_WITHOUT_ETA",count:n}),i}const nn={monthKey:Ue};function c(t,n=document){return n.querySelector(t)}function e(t,n={},i=[]){const a=document.createElement(t);for(const[d,D]of Object.entries(n))d==="class"?a.className=D:d==="dataset"?Object.entries(D).forEach(([y,v])=>a.dataset[y]=v):d.startsWith("on")&&typeof D=="function"?a.addEventListener(d.slice(2),D):D!=null&&a.setAttribute(d,D);for(const d of[].concat(i))d!=null&&a.append(d.nodeType?d:document.createTextNode(String(d)));return a}const sn=["SEA","RAIL","AIR"],rn=["EXW","DDP"],vt=["ORDER_DATE","PRODUCTION_END","ETD","ETA","DELIVERY"],Yt=["EUR","USD","CNY"],an={DRAFT:"Draft",PLANNED:"Planned",CONVERTED:"Converted",CANCELLED:"Cancelled"};function Ee(t,n="EUR"){const i=String(t||"").trim().toUpperCase();return Yt.includes(i)?i:n}function on(){return qe.map(t=>({...t}))}function Q(t){if(!t)return"—";const[n,i,a]=String(t).split("-").map(Number);if(!n||!i||!a)return"—";const d=new Date(Date.UTC(n,i-1,a));return Number.isNaN(d.getTime())?"—":d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function z(t){return je(t)}function un(t){return z(t)}function Z(t){const n=z(t);return!Number.isFinite(n)||n<0?null:n}function tt(t){if(!t)return null;const[n,i,a]=String(t).split("-").map(Number);if(!n||!i||!a)return null;const d=new Date(Date.UTC(n,i-1,a));return Number.isNaN(d.getTime())?null:d}function W(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}function it(t,n){const i=new Date(t.getTime());return i.setUTCDate(i.getUTCDate()+n),i}function Ot(t,n){const i=new Date(t.getTime());return i.setUTCMonth(i.getUTCMonth()+n),i}function mt(t,n){const i=Number(t||0);return Number.isFinite(i)?i.toLocaleString("de-DE",{style:"currency",currency:n||"EUR"}):"—"}function nt(t){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function pt(t){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2}):"—"}function xt(t){const n=Number(t);return Number.isFinite(n)?Math.round(n).toLocaleString("de-DE",{maximumFractionDigits:0}):"—"}function Pe(t){return Number.isFinite(t)?Math.round(t*100)/100:null}function cn(t){var D,y;const n=((D=t==null?void 0:t.forecast)==null?void 0:D.forecastManual)||{},i=((y=t==null?void 0:t.forecast)==null?void 0:y.forecastImport)||{},a={},d=v=>{const E=String(v||"").trim();if(!E)return;a[E]||(a[E]={});const T=n[E]||{},S=i[E]||{};new Set([...Object.keys(S),...Object.keys(T)]).forEach(A=>{var P;const p=z(T[A]);if(Number.isFinite(p)){a[E][A]=p;return}const C=z((P=S[A])==null?void 0:P.units);Number.isFinite(C)&&(a[E][A]=C)})};return Object.keys(i||{}).forEach(d),Object.keys(n||{}).forEach(d),a}function ln(t){var a;const n={};return(((a=t==null?void 0:t.inventory)==null?void 0:a.snapshots)||[]).forEach(d=>{const D=d==null?void 0:d.month;D&&(d.items||[]).forEach(y=>{const v=String((y==null?void 0:y.sku)||"").trim();if(!v)return;n[v]||(n[v]={});const E=Number((y==null?void 0:y.amazonUnits)||0),T=Number((y==null?void 0:y.threePLUnits)||0);n[v][D]=E+T})}),n}function Re(t){const n=(t==null?void 0:t.arrivalDateDe)||(t==null?void 0:t.arrivalDate)||(t==null?void 0:t.etaDate)||(t==null?void 0:t.etaManual)||(t==null?void 0:t.eta);if(n)return tt(n);const i=tt(t==null?void 0:t.orderDate);if(!i)return null;const a=Number((t==null?void 0:t.prodDays)??(t==null?void 0:t.productionLeadTimeDays)??0),d=Number((t==null?void 0:t.transitDays)??(t==null?void 0:t.logisticsLeadTimeDays)??0);return it(i,a+d)}function Se(t){return Array.isArray(t==null?void 0:t.items)&&t.items.length>0?t.items.map(n=>({sku:String((n==null?void 0:n.sku)||"").trim(),units:z(n==null?void 0:n.units)})):t!=null&&t.sku?[{sku:String(t.sku||"").trim(),units:z(t==null?void 0:t.units)}]:[]}function dn(t){const n={};let i=0;const a=nn.monthKey;return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(y=>{if(y!=null&&y.archived)return;const v=Re(y);if(!v){i+=1;return}const E=a(v);Se(y).forEach(T=>{if(!T.sku)return;const S=Number(T.units||0);!Number.isFinite(S)||S<=0||(n[T.sku]||(n[T.sku]={}),n[T.sku][E]=(n[T.sku][E]||0)+S)})}),(Array.isArray(t==null?void 0:t.fos)?t.fos:[]).forEach(y=>{const v=String((y==null?void 0:y.status)||"").toUpperCase();if(v==="CANCELLED"||v==="CONVERTED")return;const E=Re(y);if(!E){i+=1;return}const T=a(E);Se(y).forEach(S=>{if(!S.sku)return;const O=Number(S.units||0);!Number.isFinite(O)||O<=0||(n[S.sku]||(n[S.sku]={}),n[S.sku][T]=(n[S.sku][T]||0)+O)})}),{inboundBySku:n,inboundWithoutEtaCount:i}}function bt(t,n,i){const a=Number(t||0);if(!Number.isFinite(a))return 0;if(!n||n==="EUR")return a;const d=Number(i||0);return!Number.isFinite(d)||d<=0?a:a/d}function fn(t){return t?String(t).slice(-6).toUpperCase():"—"}function pn(t=[]){if(!t.length)return"—";const n=t.slice(0,2).map(a=>`${a.percent||0}% ${Q(a.dueDate)}`).join(", "),i=t.length>2?` +${t.length-2}`:"";return`${t.length} payments: ${n}${i}`}function mn(t=[],n=0){return t.reduce((a,d)=>{const D=Number(d.amount||0);if(!Number.isFinite(D))return a;const y=d.currency||"EUR",v=bt(D,y,n);return a+v},0)}function gn(t=[],n=0){return t.length?t.map(i=>{const a=Number(i.amount||0);if(!Number.isFinite(a))return null;const d=i.currency||"EUR",D=bt(a,d,n);return`${i.label||"Payment"}: ${mt(a,d)} (${mt(D,"EUR")})`}).filter(Boolean).join(" | "):""}function yn(t){return t==="PRODUCTION_END"?"PROD_DONE":t||"ORDER_DATE"}function st(t,n){if(!n)return null;const i=String(n).trim().toLowerCase();return t.find(a=>String((a==null?void 0:a.sku)||"").trim().toLowerCase()===i)||null}function Ht(t,n){if(!n)return null;const i=String(n).trim().toLowerCase();return t.find(a=>String((a==null?void 0:a.alias)||"").trim().toLowerCase()===i)||null}function Dn(t,n){return(t||[]).filter(Boolean).map(i=>{const a=String(i.alias||"").trim(),d=String(i.sku||"").trim(),D=a||d,y=ke(i,{state:n});return{sku:d,alias:D,label:D,completeness:y}}).sort((i,a)=>i.label.localeCompare(a.label))}function bn(t){return t==="ok"?"✅ OK":t==="warn"?"⚠️ Warnung":"❌ Blockiert"}function Te(t){var i,a,d;const n=[];return(i=t==null?void 0:t.blockingMissing)!=null&&i.length&&n.push(`Fehlt (blockierend): ${t.blockingMissing.map(D=>D.label).join(", ")}`),(a=t==null?void 0:t.defaulted)!=null&&a.length&&n.push(`Defaults aktiv: ${t.defaulted.map(D=>D.label).join(", ")}`),(d=t==null?void 0:t.suggestedMissing)!=null&&d.length&&n.push(`Empfohlen: ${t.suggestedMissing.map(D=>D.label).join(", ")}`),n.join(" • ")}function hn(t){var n;return((n=t==null?void 0:t.template)==null?void 0:n.fields)||(t==null?void 0:t.template)||{}}function Ce(t,n){const i=He(n.sku,{mode:"FO",supplierId:n.supplierId,transportMode:n.transportMode,incoterm:n.incoterm},{state:t}),a=String(i.incoterm).toUpperCase()==="DDP"?"USD":"EUR";return{transportMode:i.transportMode,incoterm:i.incoterm,unitPrice:i.unitPrice,unitPriceSource:i.sources.unitPrice||null,currency:i.currency,freight:i.logisticsPerUnitEur,freightMissingFields:i.logisticsMissingFields||[],freightCurrency:a,dutyRatePct:i.dutyRatePct,eustRatePct:i.eustRatePct,fxRate:i.fxRate,fxRateSource:i.sources.fxRate,supplierId:i.supplierId,supplierSource:i.sources.supplier,productionLeadTimeDays:i.productionLeadTimeDays,productionLeadTimeSource:i.sources.productionLeadTimeDays,incotermSource:i.sources.incoterm,paymentTermsSource:i.sources.paymentTerms,preferredSupplier:!1,logisticsLeadTimeDays:i.logisticsLeadTimeDays,bufferDays:i.bufferDays}}function rt(t){const n=tt(t.targetDeliveryDate),i=Z(t.productionLeadTimeDays),a=Number(t.logisticsLeadTimeDays||0),d=Number(t.bufferDays||0);if(!n||i==null||i===0)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null,deliveryDate:null};const D=it(n,-(i+a+d)),y=it(D,i),v=y,E=it(v,a);return{orderDate:W(D),productionEndDate:W(y),etdDate:W(v),etaDate:W(E),deliveryDate:W(n),logisticsLeadTimeDays:a}}function Dt(t){const n=z(t.unitPrice)||0,i=Number(t.units||0),a=i*n,d=z(t.fxRate)||0,D=t.currency||"USD",y=bt(a,D,d),v=z(t.freight)||0,E=v*i,T=t.freightCurrency||"EUR",S=bt(E,T,d),O=z(t.dutyRatePct)||0,A=O>0?y*(O/100):0,p=z(t.eustRatePct)||0,C=p>0?(y+A+S)*(p/100):0,P=y+A+S+C;return{unitPrice:n,units:i,supplierCost:a,supplierCostEur:y,freightPerUnit:v,freightTotal:E,freightCurrency:T,freightEur:S,dutyRatePct:O,eustRatePct:p,fxRate:d,landedCostEur:P}}function vn(t){return!t||!t.length?"":`Logistik nicht berechenbar – ${t.map(i=>i==="landedCostEur"?"Einstandspreis":i==="unitPriceUsd"?"Unit Price":i==="fxUsdPerEur"?"FX":i).join(", ")} fehlt`}function jt({product:t,units:n,unitPrice:i,currency:a,fxRate:d}){const D=[],y=z(t==null?void 0:t.landedUnitCostEur),v=String(a||"USD").toUpperCase(),E=hn(t),T=z(E.unitPriceUsd??(t==null?void 0:t.unitPriceUsd)??(t==null?void 0:t.defaultUnitPrice)??(t==null?void 0:t.unitPrice)),S=v==="USD"?z(i)??T:T,O=z(E.extraPerUnitUsd??(t==null?void 0:t.extraPerUnitUsd))||0,A=z(d),p=ze({unitPriceUsd:S!=null?S+O:S,landedCostEur:y,fxUsdPerEur:A});if(p.missingFields.length)return p.missingFields.forEach(R=>{R==="landedCostEur"&&D.push("Einstandspreis (EUR) fehlt (Produkt)"),R==="unitPriceUsd"&&D.push("Stückpreis USD fehlt (Produkt/FO)"),R==="fxUsdPerEur"&&D.push("FX (USD je EUR) fehlt (FO/Settings)")}),{total:null,perUnit:null,warning:!1,missing:!0,missingFields:D};const C=p.warning,P=p.value!=null?Pe(p.value):null,L=Number(n||0);return{total:P!=null&&L>0?Pe(P*L):null,perUnit:P,warning:C,missing:!1,missingFields:[]}}function Mt(t,n,i,a){const d=tt(t);if(!d)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null};const D=it(d,Number(n||0)+Number(i||0)),y=D,v=it(y,Number(a||0));return{orderDate:W(d),productionEndDate:W(D),etdDate:W(y),etaDate:W(v),logisticsLeadTimeDays:Number(a||0)}}function wt(t,n){const i={ORDER_DATE:t!=null&&t.orderDate?tt(t.orderDate):null,PRODUCTION_END:t!=null&&t.productionEndDate?tt(t.productionEndDate):null,ETD:t!=null&&t.etdDate?tt(t.etdDate):null,ETA:t!=null&&t.etaDate?tt(t.etaDate):null,DELIVERY:t!=null&&t.deliveryDate?tt(t.deliveryDate):n?tt(n):null};return!i.ETD&&i.ETA&&Number.isFinite(Number(t==null?void 0:t.logisticsLeadTimeDays))&&(i.ETD=it(i.ETA,-Number(t.logisticsLeadTimeDays||0))),i}function Ft(t,n){const i=vt.includes(t)?t:"ORDER_DATE";return(n==null?void 0:n[i])||null}function En(t,n){const i=wt(n||{},n==null?void 0:n.deliveryDate);return t.map(a=>{const d=vt.includes(a.triggerEvent)?a.triggerEvent:"ORDER_DATE",D=Number(a.offsetDays||0),y=Number(a.offsetMonths||0),v=Ft(d,i);let E=a.dueDate;if(!(a.dueDateManuallySet===!0||!!a.paidDate||a.dueDate&&typeof a.dueDateManuallySet>"u")){let S=v?it(v,D):null;S&&y&&(S=Ot(S,y)),E=S?W(S):null}return{...a,triggerEvent:d,offsetDays:D,offsetMonths:y,dueDate:E}})}function At({supplier:t,baseValue:n,currency:i,schedule:a,freight:d,freightCurrency:D,dutyRatePct:y,eustRatePct:v,fxRate:E,supplierCostEur:T,incoterm:S}){const O=Array.isArray(t==null?void 0:t.paymentTermsDefault)&&t.paymentTermsDefault.length?t.paymentTermsDefault:on(),A=wt(a||{},a==null?void 0:a.deliveryDate),p=O.map(k=>{const m=vt.includes(k.triggerEvent)?k.triggerEvent:"ORDER_DATE",w=Number(k.offsetDays||0),x=Number(k.offsetMonths||0),s=n*(Number(k.percent||0)/100),N=Ft(m,A);let K=N?W(it(N,w)):null;return K&&x&&(K=W(Ot(tt(K),x))),{id:`pay-${Math.random().toString(36).slice(2,9)}`,label:k.label||"Milestone",percent:Number(k.percent||0),amount:s,currency:i||"EUR",triggerEvent:m,offsetDays:w,offsetMonths:x,dueDate:K,isOverridden:!1,dueDateManuallySet:!1,category:"supplier"}}),C=[],P=String(S||"").toUpperCase(),L=Number(d||0);P!=="DDP"&&L>0&&C.push({id:`freight-${Math.random().toString(36).slice(2,9)}`,label:"Fracht",percent:0,amount:L,currency:D||"EUR",triggerEvent:"ETD",offsetDays:0,dueDate:A.ETD?W(A.ETD):null,isOverridden:!1,dueDateManuallySet:!1,category:"freight"});const b=Number(y||0);if(P!=="DDP"&&b>0){const k=T;C.push({id:`duty-${Math.random().toString(36).slice(2,9)}`,label:"Duty",percent:b,amount:k*(b/100),currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:A.ETA?W(A.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"duty"})}const R=Number(v||0);if(P!=="DDP"&&R>0){const k=bt(L,D,E),m=b>0?T*(b/100):0,x=(T+m+k)*(R/100);C.push({id:`eust-${Math.random().toString(36).slice(2,9)}`,label:"EUSt",percent:R,amount:x,currency:"EUR",triggerEvent:"ETA",offsetDays:0,dueDate:A.ETA?W(A.ETA):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust"}),C.push({id:`eust-refund-${Math.random().toString(36).slice(2,9)}`,label:"EUSt Erstattung",percent:R,amount:-x,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:2,dueDate:A.ETA?W(Ot(A.ETA,2)):null,isOverridden:!1,dueDateManuallySet:!1,category:"eust_refund"})}return[...p,...C]}function Le(t,n){const{baseValue:i,schedule:a,currency:d,freight:D,freightCurrency:y,dutyRatePct:v,eustRatePct:E,fxRate:T,supplierCostEur:S,incoterm:O}=n,A=Number(v||0),p=Number(E||0),C=Number(D||0),P=bt(C,y,T),L=A>0?S*(A/100):0,b=S+L+P,R=String(O||"").toUpperCase(),k=wt(a||{},a==null?void 0:a.deliveryDate);return t.map(m=>{const w=vt.includes(m.triggerEvent)?m.triggerEvent:"ORDER_DATE",x=Number(m.offsetDays||0),s=Number(m.offsetMonths||0);let N=Number(m.amount||0);m.category==="supplier"?N=i*(Number(m.percent||0)/100):m.category==="freight"?N=C:m.category==="duty"?N=R==="DDP"?0:L:m.category==="eust"?N=R==="DDP"?0:p>0?b*(p/100):0:m.category==="eust_refund"&&(N=p>0?b*(p/100):0,N=-N);let K=m.dueDate;if(!(m.dueDateManuallySet===!0||!!m.paidDate||m.dueDate&&typeof m.dueDateManuallySet>"u")){const g=Ft(w,k);let U=g?it(g,x):null;U&&s&&(U=Ot(U,s)),K=U?W(U):null}const M=m.category==="supplier"?d||"EUR":m.category==="freight"&&y||"EUR";return{...m,triggerEvent:w,offsetDays:x,amount:N,currency:M,dueDate:K}})}function Tt(t,n){return String(n||"").toUpperCase()!=="DDP"?t:t.filter(a=>a.category!=="freight")}function qt(t,n,i=[],a){const d=e("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),D=e("div",{class:"po-modal fo-modal-frame"},[e("header",{class:"po-modal-header"},[e("h3",{},[t]),e("button",{class:"btn ghost",type:"button",onclick:()=>{if(typeof a=="function"){a();return}d.remove()},"aria-label":"Schließen"},["✕"])]),e("div",{class:"po-modal-body"},[n]),e("footer",{class:"po-modal-actions"},i)]);d.append(D),document.body.append(d);let y=!1;return d.addEventListener("mousedown",v=>{y=v.target===d}),d.addEventListener("mouseup",v=>{y&&v.target===d&&(typeof a=="function"?a():d.remove()),y=!1}),d}function Pn(t,n,i){const a=new Date().toISOString(),d=t.productionLeadTimeDaysManual!=null?Number(t.productionLeadTimeDaysManual):null,D=Z(t.productionLeadTimeDays);return{id:t.id,sku:t.sku,supplierId:t.supplierId,targetDeliveryDate:t.targetDeliveryDate,units:Number(t.units||0),transportMode:t.transportMode,incoterm:t.incoterm,unitPrice:z(t.unitPrice)||0,unitPriceIsOverridden:!!t.unitPriceIsOverridden,currency:Ee(t.currency,"EUR"),freight:z(t.freight)||0,freightCurrency:Ee(t.freightCurrency,"EUR"),dutyRatePct:z(t.dutyRatePct)||0,eustRatePct:z(t.eustRatePct)||0,fxRate:z(t.fxRate)||0,productionLeadTimeDays:Number.isFinite(D)?D:null,productionLeadTimeDaysManual:Number.isFinite(d)?d:null,productionLeadTimeSource:t.productionLeadTimeSource||null,logisticsLeadTimeDays:Number(t.logisticsLeadTimeDays||0),bufferDays:Number(t.bufferDays||0),orderDate:n.orderDate,productionEndDate:n.productionEndDate,etdDate:n.etdDate,etaDate:n.etaDate,deliveryDate:n.deliveryDate,payments:i,status:t.status||"DRAFT",convertedPoId:t.convertedPoId||null,convertedPoNo:t.convertedPoNo||null,createdAt:t.createdAt||a,updatedAt:a}}function kn(t){const n=he();Array.isArray(n.fos)||(n.fos=[]),Array.isArray(n.suppliers)||(n.suppliers=[]);const i=be(),a=Ke(n,i);t.innerHTML=`
    <section class="card">
      <h2>Forecast Orders (FO)</h2>
      <div class="table-card-header">
        <span class="muted">Planung neuer Bestände</span>
        <div class="fo-toolbar">
          <input type="text" id="fo-search" placeholder="Alias oder SKU suchen" />
          <select id="fo-status-filter">
            <option value="ALL">Status: Alle</option>
            <option value="DRAFT">Draft</option>
            <option value="PLANNED">Planned</option>
            <option value="CONVERTED">Converted</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
          <button class="btn primary" id="fo-add">Create FO</button>
        </div>
      </div>
      <div id="fo-table"></div>
    </section>
  `;const d=c("#fo-table",t),D=c("#fo-search",t),y=c("#fo-status-filter",t);function v(p,C,P){const L=`po-${Math.random().toString(36).slice(2,9)}`,b=String(C||"").trim(),R=z(p.fxRate)||0,k=bt(z(p.freight)||0,p.freightCurrency,R),m=(p.payments||[]).filter(N=>N.category==="supplier").map(N=>({id:N.id||`ms-${Math.random().toString(36).slice(2,9)}`,label:N.label||"Milestone",percent:Number(N.percent||0),anchor:yn(N.triggerEvent),lagDays:Number(N.offsetDays||0)})),w=Number(p.productionLeadTimeDays||0)+Number(p.bufferDays||0),x=Number(p.logisticsLeadTimeDays||0),s=Mt(P,w,0,x);return{id:L,poNo:b,sku:p.sku,supplierId:p.supplierId,units:Number(p.units||0),unitCostUsd:nt(p.unitPrice||0),unitExtraUsd:"0,00",extraFlatUsd:"0,00",orderDate:s.orderDate||p.orderDate||null,prodDays:w,transitDays:x,transport:p.transportMode||"SEA",freightEur:nt(k),dutyRatePct:pt(p.dutyRatePct||0),eustRatePct:pt(p.eustRatePct||0),fxOverride:nt(R||0),ddp:String(p.incoterm||"").toUpperCase()==="DDP",milestones:m,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}function E(){var R,k;const p=(((R=c("#fo-search",t))==null?void 0:R.value)||"").trim().toLowerCase(),C=((k=c("#fo-status-filter",t))==null?void 0:k.value)||"ALL",P=n.fos.slice().filter(m=>{if(C!=="ALL"&&String(m.status||"DRAFT").toUpperCase()!==C)return!1;if(!p)return!0;const w=st(i,m.sku),x=String((w==null?void 0:w.alias)||"").toLowerCase(),s=String(m.sku||"").toLowerCase();return x.includes(p)||s.includes(p)}).sort((m,w)=>(m.targetDeliveryDate||"").localeCompare(w.targetDeliveryDate||""));if(!P.length){d.innerHTML='<p class="muted">Keine Forecast Orders vorhanden.</p>';return}const L=P.map(m=>{var at;const w=n.suppliers.find(B=>B.id===m.supplierId),x=st(i,m.sku),s=rt(m),N=Dt(m),K=jt({product:x,units:Number(m.units||0),unitPrice:m.unitPrice,currency:m.currency,fxRate:m.fxRate||((at=n.settings)==null?void 0:at.fxRate)}),$=pn(m.payments),M=mn(m.payments,m.fxRate),g=gn(m.payments,m.fxRate),U=String(m.status||"DRAFT").toUpperCase();return{fo:m,supplierLabel:w&&(a.get(w.id)||w.name)||"—",alias:(x==null?void 0:x.alias)||m.sku||"—",skuLabel:m.sku||"—",schedule:s,costValues:N,freightEstimate:K,paymentsSummary:$,paymentsTotal:M,paymentsTooltip:g,status:U,statusLabel:an[U]||U,statusClass:`badge${U==="CONVERTED"?" muted":""}`}}),b=[{key:"id",label:"FO ID"},{key:"product",label:"Produkt"},{key:"supplier",label:"Supplier"},{key:"units",label:"Units",className:"num"},{key:"target",label:"Target Delivery"},{key:"order",label:"Order Date"},{key:"timeline",label:"ETD / ETA"},{key:"total",label:"Total Value (EUR)",className:"num"},{key:"freight",label:"Geschätzte Fracht (EUR)",className:"num"},{key:"payments",label:"Payments"},{key:"status",label:"Status"},{key:"actions",label:"Actions"}];d.innerHTML="",d.append(Fe({columns:b,rows:L,rowKey:m=>m.fo.id,stickyColumns:1,rowAttrs:m=>({dataset:{id:m.fo.id}}),renderCell:(m,w)=>{var s,N;const{fo:x}=m;switch(w.key){case"id":return fn(x.id);case"product":return e("div",{class:"fo-product-cell"},[e("strong",{},[m.alias]),e("small",{class:"muted"},[m.skuLabel])]);case"supplier":return e("button",{class:"btn ghost fo-link",type:"button",dataset:{action:"supplier"}},[m.supplierLabel]);case"units":return Number(x.units||0).toLocaleString("de-DE");case"target":return Q(x.targetDeliveryDate);case"order":return Q(x.orderDate);case"timeline":return e("div",{class:"fo-date-stack"},[e("span",{},[`ETD ${Q(x.etdDate||m.schedule.etdDate)}`]),e("span",{class:"muted"},[`ETA ${Q(x.etaDate||m.schedule.etaDate)}`])]);case"total":return mt(m.costValues.landedCostEur,"EUR");case"freight":{const K=(s=m.freightEstimate)==null?void 0:s.total,$=((N=m.freightEstimate)==null?void 0:N.missingFields)||[],M=$.length?`Fehlend: ${$.join(", ")}`:"";return e("span",{title:M},[K==null?"—":mt(K,"EUR")])}case"payments":return e("div",{title:m.paymentsTooltip},[m.paymentsSummary,e("br"),e("span",{class:"muted"},[mt(m.paymentsTotal,"EUR")])]);case"status":return e("span",{class:m.statusClass},[m.statusLabel]);case"actions":return e("div",{class:"table-actions"},[e("button",{class:"btn",type:"button",dataset:{action:"edit"}},["View/Edit"]),e("button",{class:"btn secondary",type:"button",dataset:{action:"convert"},disabled:m.status==="CONVERTED"?"true":null},["Convert to PO"]),e("button",{class:"btn danger",type:"button",dataset:{action:"delete"}},["Delete"])]);default:return"—"}}}))}D&&D.addEventListener("input",E),y&&y.addEventListener("change",E);function T(p,C=[],P){const L=e("div",{class:"fo-info-list"},C.map(m=>e("p",{class:"muted"},[m]))),b=e("button",{class:"btn",type:"button"},["Schließen"]),R=e("button",{class:"btn primary",type:"button",onclick:()=>{k.remove(),location.hash="#suppliers"}},["Zu Suppliers"]),k=qt(p,L,R?[b,R]:[b]);b.addEventListener("click",()=>k.remove())}function S(p){const C=(n.pos||[]).map(M=>String(M.poNo||"").trim()).filter(Boolean);let L=rt(p).orderDate||p.orderDate||"",b=Mt(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0);const R=e("div",{class:"fo-convert-modal"},[e("label",{},["PO Number (Ventory One)",e("input",{type:"text",id:"fo-po-number",placeholder:"e.g. 250029",maxlength:"30"}),e("small",{class:"muted"},["Must match Ventory One PO number"]),e("small",{class:"form-error",id:"fo-po-error"},[])]),e("label",{style:"margin-top:10px"},["Order Date (PO)",e("input",{type:"date",id:"fo-po-order-date",value:L}),e("div",{class:"fo-convert-actions"},[e("button",{class:"btn secondary",type:"button",id:"fo-po-today"},["Today"])]),e("small",{class:"muted"},["Default is calculated from FO backward scheduling."])]),e("div",{class:"fo-convert-preview"},[e("p",{class:"muted"},["This will update PO dates:"]),e("div",{class:"fo-date-stack"},[e("span",{id:"fo-preview-production-convert"},["Production End: —"]),e("span",{id:"fo-preview-etd-convert"},["ETD: —"]),e("span",{id:"fo-preview-eta-convert"},["ETA: —"])])])]),k=e("button",{class:"btn primary",type:"button",disabled:"true"},["Convert"]),m=e("button",{class:"btn",type:"button"},["Cancel"]),w=qt("Convert FO to PO",R,[m,k]),x=c("#fo-po-number",R),s=c("#fo-po-order-date",R),N=c("#fo-po-error",R);function K(){b=Mt(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0),c("#fo-preview-production-convert",R).textContent=`Production End: ${Q(b.productionEndDate)}`,c("#fo-preview-etd-convert",R).textContent=`ETD: ${Q(b.etdDate)}`,c("#fo-preview-eta-convert",R).textContent=`ETA: ${Q(b.etaDate)}`}function $(){const M=x.value.trim();let g="";return M||(g="PO number is required."),M.length>30&&(g="Max length is 30."),C.includes(M)&&(g="PO number already exists."),L||(g=g||"Order date is required."),N.textContent=g,k.disabled=!!g,!g}c("#fo-po-today",R).addEventListener("click",()=>{const M=new Date;L=W(new Date(Date.UTC(M.getFullYear(),M.getMonth(),M.getDate()))),s.value=L,K()}),x.addEventListener("input",$),s.addEventListener("input",M=>{L=M.target.value,K()}),m.addEventListener("click",()=>w.remove()),K(),$(),k.addEventListener("click",()=>{if(!$())return;const M=Mt(L,p.productionLeadTimeDays||0,p.bufferDays||0,p.logisticsLeadTimeDays||0);p.orderDate=M.orderDate,p.productionEndDate=M.productionEndDate,p.etdDate=M.etdDate,p.etaDate=M.etaDate,p.payments=En(p.payments||[],M);const g=v(p,x.value,M.orderDate);Array.isArray(n.pos)||(n.pos=[]),n.pos.push(g),p.status="CONVERTED",p.convertedPoId=g.id,p.convertedPoNo=g.poNo,p.updatedAt=new Date().toISOString(),zt(n,{source:"fo:convert",entityKey:`fo:${p.id}`,action:"update"}),E(),w.remove(),window.confirm("PO created. Open PO?")&&(location.hash="#po")})}function O(p,C={}){var ae,oe,ue,ce,le,de,fe,pe,me;const P=be(),L=Dn(P,n),b=!!p,R=String((p==null?void 0:p.status)||"").toUpperCase()==="CONVERTED",k=cn(n),m=ln(n),w=dn(n),x={anchorMonth:(C==null?void 0:C.anchorMonth)||""};let s=p?JSON.parse(JSON.stringify(p)):{id:`fo-${Math.random().toString(36).slice(2,9)}`,sku:"",supplierId:"",targetDeliveryDate:"",units:"",transportMode:"SEA",incoterm:"EXW",unitPrice:"",unitPriceIsOverridden:!1,currency:((ae=n.settings)==null?void 0:ae.defaultCurrency)||"EUR",freight:"",freightCurrency:"EUR",dutyRatePct:((oe=n.settings)==null?void 0:oe.dutyRatePct)??0,eustRatePct:((ue=n.settings)==null?void 0:ue.eustRatePct)??0,fxRate:((ce=n.settings)==null?void 0:ce.fxRate)??"",productionLeadTimeDays:"",productionLeadTimeDaysManual:null,productionLeadTimeSource:null,logisticsLeadTimeDays:"",bufferDays:((le=n.settings)==null?void 0:le.defaultBufferDays)??0,payments:[],status:"DRAFT",createdAt:new Date().toISOString()};if(!b&&C){const r=String(C.sku||"").trim(),o=String(C.alias||"").trim(),u=st(P,r)||Ht(P,o)||Ht(P,r);u!=null&&u.sku?s.sku=u.sku:r&&(s.sku=r),C.targetDeliveryDate&&(s.targetDeliveryDate=C.targetDeliveryDate)}s.freightCurrency||(s.freightCurrency="EUR"),s.freight==null&&(s.freight=""),s.dutyRatePct==null&&(s.dutyRatePct=((de=n.settings)==null?void 0:de.dutyRatePct)??0),s.eustRatePct==null&&(s.eustRatePct=((fe=n.settings)==null?void 0:fe.eustRatePct)??0),s.fxRate==null&&(s.fxRate=((pe=n.settings)==null?void 0:pe.fxRate)??""),s.currency||(s.currency="USD"),typeof s.productionLeadTimeDaysManual>"u"&&(s.productionLeadTimeDaysManual=null),s.productionLeadTimeSource||(s.productionLeadTimeSource=null),Array.isArray(s.payments)&&(s.payments=s.payments.map(r=>({...r,category:r.category||"supplier"})));const N=We(s,{key:`fo:${s.id||"new"}`,enableDraftCache:!1});s=N.draft;const K=Ve(()=>N.isDirty,"Ungespeicherte Änderungen verwerfen?");K.register(),K.attachBeforeUnload();const $={transportMode:b,incoterm:b,currency:b,freightCurrency:b,freight:b,dutyRatePct:b,eustRatePct:b,fxRate:b,productionLeadTimeDays:b,logisticsLeadTimeDays:b,bufferDays:b};s.productionLeadTimeDaysManual!=null&&($.productionLeadTimeDays=!0),typeof s.unitPriceIsOverridden!="boolean"&&(s.unitPriceIsOverridden=b);let M=b&&Array.isArray(s.payments)&&s.payments.length>0,g=Ce(n,s);function U(r,o){s[r]=o,$[r]=!1,r==="productionLeadTimeDays"&&(s.productionLeadTimeDaysManual=null,s.productionLeadTimeSource=g.productionLeadTimeSource||null);const u=c(`#fo-${r}`,f);if(u){const l=o==null?"":["unitPrice","freight","fxRate"].includes(r)?nt(o):["dutyRatePct","eustRatePct"].includes(r)?pt(o):o;u.value=l}}function at(){const r=s.supplierId;if(g=Ce(n,s),!s.supplierId&&g.supplierId){s.supplierId=g.supplierId;const o=c("#fo-supplierId",f);o&&(o.value=g.supplierId)}if($.transportMode||U("transportMode",g.transportMode),$.incoterm||U("incoterm",g.incoterm),s.unitPriceIsOverridden||U("unitPrice",g.unitPrice??""),$.currency||U("currency",g.currency||"USD"),$.freight||U("freight",g.freight??""),$.freightCurrency||U("freightCurrency",g.freightCurrency||"EUR"),$.dutyRatePct||U("dutyRatePct",g.dutyRatePct??""),$.eustRatePct||U("eustRatePct",g.eustRatePct??""),$.fxRate||U("fxRate",g.fxRate??""),$.productionLeadTimeDays||U("productionLeadTimeDays",g.productionLeadTimeDays),$.logisticsLeadTimeDays||U("logisticsLeadTimeDays",g.logisticsLeadTimeDays),$.bufferDays||U("bufferDays",g.bufferDays),B(),Zt(),Xt(),Qt(),!M&&s.supplierId&&s.supplierId!==r){const o=rt(s),u=gt(),l=n.suppliers.find(_=>_.id===s.supplierId)||null,h=Dt(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(h.dutyRatePct=0,h.eustRatePct=0),s.payments=At({supplier:l,baseValue:u,currency:s.currency,schedule:o,freight:h.freightTotal,freightCurrency:h.freightCurrency,dutyRatePct:h.dutyRatePct,eustRatePct:h.eustRatePct,fxRate:h.fxRate,supplierCostEur:h.supplierCostEur,incoterm:s.incoterm}),s.payments=Tt(s.payments,s.incoterm)}}function B(){var l;if(c("#suggested-transport",f).textContent=`Suggested: ${g.transportMode}`,c("#suggested-incoterm",f).textContent=`Suggested: ${g.incoterm}`,g.unitPrice!=null){const h=g.unitPriceSource?` (Quelle: ${g.unitPriceSource})`:"";c("#suggested-unitPrice",f).textContent=`Suggested: ${nt(g.unitPrice)}${h}`}else c("#suggested-unitPrice",f).textContent="Suggested: —";c("#suggested-currency",f).textContent=`Suggested: ${g.currency||"USD"}`,c("#suggested-freight",f).textContent=`Suggested: ${g.freight!=null?nt(g.freight):"—"}`;const r=c("#fo-freight-warning",f);r&&(r.textContent=(l=g.freightMissingFields)!=null&&l.length?vn(g.freightMissingFields):""),c("#suggested-freightCurrency",f).textContent=`Suggested: ${g.freightCurrency||"EUR"}`,c("#suggested-dutyRatePct",f).textContent=`Suggested: ${g.dutyRatePct!=null?pt(g.dutyRatePct):"—"} %`,c("#suggested-eustRatePct",f).textContent=`Suggested: ${g.eustRatePct!=null?pt(g.eustRatePct):"—"} %`,c("#suggested-fxRate",f).textContent=`Suggested: ${g.fxRate!=null?nt(g.fxRate):"—"}`;const o=g.productionLeadTimeDays!=null?g.productionLeadTimeDays:"—",u=g.productionLeadTimeSource?` (Quelle: ${g.productionLeadTimeSource})`:"";c("#suggested-productionLeadTimeDays",f).textContent=`Vorschlag: ${o}${u}`,c("#suggested-logisticsLeadTimeDays",f).textContent=`Suggested: ${g.logisticsLeadTimeDays}`,c("#suggested-bufferDays",f).textContent=`Suggested: ${g.bufferDays}`,xe()}function xe(){var j,I;const r=c(".fo-suggestion-list",f);if(!r)return;r.innerHTML="";const o=s.supplierId&&s.supplierId!==g.supplierId?"Manual override":g.supplierSource||"—",u=s.unitPriceIsOverridden?"Manual override":g.unitPriceSource||"—",l=$.productionLeadTimeDays?"Manual override":g.productionLeadTimeSource||"missing",h=$.incoterm?"Manual override":g.incotermSource||"—",_=Array.isArray(s.payments)&&s.payments.length&&g.paymentTermsSource||"—",Y=$.fxRate?"Manual override":g.fxRateSource||"—",H=st(P,s.sku),X=jt({product:H,units:Number(s.units||0),unitPrice:s.unitPrice,currency:s.currency,fxRate:s.fxRate||((j=n.settings)==null?void 0:j.fxRate)}),G=(I=X==null?void 0:X.missingFields)!=null&&I.length?` Fehlend: ${X.missingFields.join(", ")}`:"";r.append(e("li",{},[`Supplier source: ${o}`]),e("li",{},[`Price source: ${u}`]),e("li",{},[`Production lead time source: ${l}`]),e("li",{},[`Incoterm source: ${h}`]),e("li",{},[`Payment terms source: ${_}`]),e("li",{},[`FX source: ${Y}`]),e("li",{},[`Logistikquelle: Einstandspreis (Produkt) + FX (Settings) + Stückpreis USD (Produkt/FO).${G}`]))}function Xt(){var l;const r=c("#fo-warning-info",f),o=c(".fo-warning-list",f);if(!r||!o)return;o.innerHTML="";const u=st(P,s.sku);if(s.sku&&!s.supplierId&&!(u!=null&&u.supplierId)&&o.append(e("li",{},["Supplier fehlt in Produktdaten."])),u){const h=((l=u.template)==null?void 0:l.fields)||{},_=u.freight!=null||u.freightAir!=null||u.freightSea!=null||u.freightRail!=null||h.freightEur!=null,Y=u.dutyRatePct!=null||h.dutyPct!=null,H=u.eustRatePct!=null||h.vatImportPct!=null;(!_||!Y||!H)&&o.append(e("li",{},["Produktkosten fehlen (Logistik/Zoll/EUSt)."," ",e("button",{class:"btn ghost fo-fix-now",type:"button",dataset:{sku:u.sku,tab:"produkte"}},["Fix now"])]))}r.style.display=o.childElementCount?"block":"none"}function Qt(){var Rt,St,ut,Nt,ge,ye,De;const r=c("#fo-recommendation",f),o=c("#fo-recommendation-summary",f),u=c("#fo-recommendation-details",f),l=c("#fo-recommendation-baseline",f),h=c("#fo-recommendation-critical",f),_=c("#fo-recommendation-arrival",f),Y=c("#fo-recommendation-order",f),H=c("#fo-recommendation-units",f),X=c("#fo-recommendation-issues",f),G=c("#fo-recommendation-notes",f);if(!r||!o||!u||!l||!h||!_||!Y||!H||!X||!G)return;X.innerHTML="",G.textContent="";const j=String(s.sku||"").trim();if(!j){o.textContent="SKU auswählen, um Empfehlung zu sehen.",u.style.display="none";return}const I=Je(((Rt=n==null?void 0:n.inventory)==null?void 0:Rt.snapshots)||[]);if(!I){o.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",u.style.display="none";return}const V=st(P,j),ot=Number((V==null?void 0:V.safetyStockDohOverride)??((St=n.settings)==null?void 0:St.safetyStockDohDefault)??60),J=Number((V==null?void 0:V.foCoverageDohOverride)??((ut=n.settings)==null?void 0:ut.foCoverageDohDefault)??90),Pt=Number(s.productionLeadTimeDays||0)+Number(s.logisticsLeadTimeDays||0)+Number(s.bufferDays||0),dt=((Nt=m==null?void 0:m[j])==null?void 0:Nt[I])??0,ft=tn({sku:j,baselineMonth:I,stock0:dt,forecastByMonth:(k==null?void 0:k[j])||{},inboundByMonth:((ge=w.inboundBySku)==null?void 0:ge[j])||{},horizonMonths:12}),q=en({sku:j,baselineMonth:I,projection:ft,safetyStockDays:ot,coverageDays:J,leadTimeDays:Pt,cnyPeriod:(ye=n==null?void 0:n.settings)==null?void 0:ye.cny,inboundWithoutEtaCount:w.inboundWithoutEtaCount,moqUnits:Number((V==null?void 0:V.moqOverrideUnits)??(V==null?void 0:V.moqUnits)??((De=n.settings)==null?void 0:De.moqDefaultUnits)??0)});if(l.textContent=`Closing Snapshot ${I}`,u.style.display="flex",q.status==="no_fo_needed")o.textContent="Keine FO innerhalb des Horizons erforderlich.",h.textContent="—",_.textContent="—",Y.textContent="—",H.textContent="—";else if(q.status==="ok"){o.textContent="Empfehlung basierend auf dem letzten Closing Snapshot.",h.textContent=q.criticalMonth||"—",_.textContent=q.requiredArrivalDate?Q(q.requiredArrivalDate):"—",Y.textContent=q.orderDateAdjusted?Q(q.orderDateAdjusted):"—",H.textContent=`SKU ${j}: ${xt(q.recommendedUnits)}`;const ct=[];q.overlapDays>0&&ct.push(`CNY berücksichtigt: +${q.overlapDays} Tage`),ct.push(`Safety DOH: ${xt(q.safetyStockDays)} · Coverage DOH: ${xt(q.coverageDays)}`),q.moqApplied&&ct.push(`MOQ berücksichtigt: ${xt(q.moqUnits)} Einheiten`),G.textContent=ct.join(" • ")}else o.textContent="Keine Empfehlung möglich: letzter Monats-Snapshot fehlt.",u.style.display="none";(q.issues||[]).forEach(ct=>{const we=ct.count?`${ct.code} (${ct.count})`:ct.code;X.append(e("span",{class:"badge fo-recommendation-badge"},[we]))})}function Zt(){const r=String(s.incoterm||"").toUpperCase()==="DDP",o=c("#fo-dutyRatePct",f),u=c("#fo-eustRatePct",f),l=c("#fo-freightCurrency",f);r&&(s.dutyRatePct=0,s.eustRatePct=0,s.freightCurrency="USD",o&&(o.value=pt(0)),u&&(u.value=pt(0)),l&&(l.value="USD")),o&&(o.disabled=r),u&&(u.disabled=r),l&&(l.disabled=r)}function It(){const r=String(s.sku||"").trim(),o=P.some(h=>String(h.sku||"").trim().toLowerCase()===r.toLowerCase()),u=c("#fo-product-banner",f);r&&!o?u.style.display="block":u.style.display="none";const l=c("#fo-sku-display",f);l&&(l.textContent=r?`SKU: ${r}`:"SKU: —")}function lt(){const r=rt(s),o=gt(),u=Dt(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(u.dutyRatePct=0,u.eustRatePct=0),s.payments=Le(s.payments,{baseValue:o,schedule:r,currency:s.currency,freight:u.freight,freightCurrency:u.freightCurrency,dutyRatePct:u.dutyRatePct,eustRatePct:u.eustRatePct,fxRate:u.fxRate,supplierCostEur:u.supplierCostEur,incoterm:s.incoterm}),s.payments=Tt(s.payments,s.incoterm),ne(),Jt(),Gt(r),ee(u),te(),re()}function Gt(r){c("#fo-preview-order",f).textContent=Q(r.orderDate),c("#fo-preview-production",f).textContent=Q(r.productionEndDate),c("#fo-preview-etd",f).textContent=Q(r.etdDate),c("#fo-preview-eta",f).textContent=Q(r.etaDate),c("#fo-preview-target",f).textContent=Q(s.targetDeliveryDate);const o=c("#fo-user-anchor",f);o&&(x.anchorMonth?(o.textContent=`User-Anker: ETA-Monat ${x.anchorMonth}`,o.style.display="block"):(o.textContent="",o.style.display="none"));const u=[];s.targetDeliveryDate||u.push("Zieltermin"),(!Number.isFinite(Number(s.productionLeadTimeDays))||Number(s.productionLeadTimeDays)<=0)&&u.push("Produktionszeit"),(!Number.isFinite(Number(s.logisticsLeadTimeDays))||Number(s.logisticsLeadTimeDays)<=0)&&u.push("Frachtlaufzeit");const l=c("#fo-schedule-missing",f),h=c("#fo-schedule-missing-list",f);l&&h&&(h.innerHTML="",u.forEach(X=>h.append(e("li",{},[X]))),l.style.display=u.length?"block":"none");const _=tt(r.etaDate),Y=tt(s.targetDeliveryDate),H=c("#fo-date-warning",f);_&&Y&&_>Y?(H.textContent="Warnung: ETA liegt nach dem Zieltermin.",H.style.display="block"):(H.textContent="",H.style.display="none")}function Jt(){const r=s.payments.filter(u=>u.category==="supplier").reduce((u,l)=>u+(Number(l.percent)||0),0),o=c("#fo-payment-total",f);Math.round(r)===100?(o.textContent="Summe: 100%",o.style.color="#0f9960"):(o.textContent=`Summe: ${r.toFixed(2)}% (muss 100% sein)`,o.style.color="#c23636")}function te(){const r=c("#fo-ddp-note",f);if(!r)return;const o=String(s.incoterm||"").toUpperCase()==="DDP";r.style.display=o?"block":"none"}function ee(r){var h;const o=st(P,s.sku),u=jt({product:o,units:Number(s.units||0),unitPrice:s.unitPrice,currency:s.currency,fxRate:s.fxRate||((h=n.settings)==null?void 0:h.fxRate)});c("#fo-supplier-cost",f).textContent=mt(r.supplierCost,s.currency||"USD"),c("#fo-landed-cost",f).textContent=mt(r.landedCostEur,"EUR"),c("#fo-shipping-estimate",f).textContent=u.total==null?"—":mt(u.total,"EUR");const l=c("#fo-shipping-note",f);l&&(u.missing?l.textContent=`Fehlend: ${u.missingFields.join(", ")}`:u.warning?l.textContent="Hinweis: Einstandspreis liegt unter Warenwert.":l.textContent="")}function gt(){return Number(s.units||0)*(z(s.unitPrice)||0)}function Me(){const o=s.payments.filter(u=>u.category==="supplier").reduce((u,l)=>u+(Number(l.percent)||0),0);o&&(s.payments=s.payments.map(u=>u.category!=="supplier"?u:{...u,percent:Math.round((Number(u.percent)||0)/o*1e4)/100,isOverridden:!0}),lt())}function ne(){const r=c("#fo-payments-body",f);r.innerHTML="";const o=wt(rt(s),s.targetDeliveryDate),u={ORDER_DATE:"Order Date",PRODUCTION_END:"Production End",ETD:"ETD",ETA:"ETA",DELIVERY:"Target Delivery"};s.payments.forEach((l,h)=>{const _=l.category==="supplier",Y=Number.isFinite(Number(l.amount))?nt(Number(l.amount)):"0,00",H=vt.includes(l.triggerEvent)?l.triggerEvent:"ORDER_DATE",G=!Ft(H,o)&&!l.dueDate?`Due Date kann nicht berechnet werden: ${u[H]||H} fehlt.`:"",j=e("tr",{},[e("td",{},[e("input",{type:"text",value:l.label||"",oninput:I=>{l.label=I.target.value,M=!0}})]),e("td",{class:"num"},[e("input",{type:"number",min:"0",max:"100",step:"0.1",value:l.percent??0,disabled:!_,oninput:I=>{l.percent=Z(I.target.value)??0,l.isOverridden=!0,M=!0,lt()}})]),e("td",{class:"num"},[e("div",{class:"fo-amount-field"},[e("input",{type:"text",inputmode:"decimal",value:Y,oninput:I=>{const V=Z(I.target.value)??0;if(_){const ot=gt();l.percent=ot?V/ot*100:0}l.amount=V,l.isOverridden=!0,M=!0,lt()},onblur:I=>{const V=Z(I.target.value);V!=null&&(I.target.value=nt(V))}}),e("span",{class:"fo-amount-currency muted"},[l.currency||"EUR"])])]),e("td",{},[(()=>{const I=e("select",{onchange:V=>{l.triggerEvent=V.target.value,l.isOverridden=!1,l.dueDateManuallySet=!1,M=!0,lt()}});return vt.forEach(V=>I.append(e("option",{value:V},[V]))),I.value=l.triggerEvent||"ORDER_DATE",I})()]),e("td",{class:"num"},[e("input",{type:"number",step:"1",value:l.offsetDays??0,oninput:I=>{l.offsetDays=un(I.target.value)??0,l.isOverridden=!1,l.dueDateManuallySet=!1,M=!0,lt()}})]),e("td",{},[e("input",{type:"date",value:l.dueDate||"",oninput:I=>{l.dueDate=I.target.value||null,l.isOverridden=!0,l.dueDateManuallySet=!0,M=!0,lt()}}),G?e("span",{class:"fo-due-date-warning",title:G},["⚠️"]):null]),e("td",{},[e("button",{class:"btn secondary",type:"button",onclick:()=>{const I=n.suppliers.find(ft=>ft.id===s.supplierId)||null,V=rt(s),ot=gt(),J=Dt(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(J.dutyRatePct=0,J.eustRatePct=0);const dt=At({supplier:I,baseValue:ot,currency:s.currency,schedule:V,freight:J.freightTotal,freightCurrency:J.freightCurrency,dutyRatePct:J.dutyRatePct,eustRatePct:J.eustRatePct,fxRate:J.fxRate,supplierCostEur:J.supplierCostEur,incoterm:s.incoterm})[h];dt&&(s.payments[h]={...dt,id:l.id||dt.id},s.payments[h].dueDateManuallySet=!1,M=!0,lt())}},["Reset"])])]);r.append(j)})}const f=e("div",{class:"fo-modal"},[R?e("div",{class:"banner info fo-converted-banner"},[e("strong",{},["Converted to PO."]),e("span",{class:"muted"},[` PO: ${s.convertedPoNo||s.convertedPoId||"—"}`])]):null,e("div",{class:"grid two"},[e("section",{class:"card"},[e("h3",{},["Inputs"]),e("div",{class:"grid two"},[e("label",{},["Produkt (Alias)",e("div",{class:"fo-product-picker"},[e("input",{type:"text",id:"fo-product-input",value:((me=st(P,s.sku))==null?void 0:me.alias)||s.sku||"",placeholder:"Alias oder SKU suchen",autocomplete:"off"}),e("div",{class:"fo-product-dropdown",id:"fo-product-dropdown"},[])]),e("div",{class:"muted fo-sku-display",id:"fo-sku-display"},["SKU: —"]),e("small",{class:"form-error",id:"fo-product-error"},[])]),e("label",{},["Units",e("input",{type:"number",min:"0",step:"1",id:"fo-units",value:s.units||""}),e("small",{class:"form-error",id:"fo-units-error"},[])]),e("label",{},["Target Delivery Date",e("input",{type:"date",id:"fo-targetDeliveryDate",value:s.targetDeliveryDate||""}),e("small",{class:"form-error",id:"fo-target-error"},[])]),e("label",{},["Supplier",(()=>{const r=e("select",{id:"fo-supplierId"});return r.append(e("option",{value:""},["Bitte auswählen"])),n.suppliers.forEach(o=>{const u=a.get(o.id)||o.name||o.id;r.append(e("option",{value:o.id},[u]))}),r.value=s.supplierId||"",r})(),e("small",{class:"form-error",id:"fo-supplier-error"},[])])]),e("div",{class:"grid two"},[e("label",{},["Transport Mode",(()=>{const r=e("select",{id:"fo-transportMode"});return sn.forEach(o=>r.append(e("option",{value:o},[o]))),r.value=s.transportMode||"SEA",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-transport"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-transportMode"},["Reset"])])]),e("label",{},["Incoterm",(()=>{const r=e("select",{id:"fo-incoterm"});return rn.forEach(o=>r.append(e("option",{value:o},[o]))),r.value=s.incoterm||"EXW",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-incoterm"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-incoterm"},["Reset"])])]),e("label",{},["Unit Price",e("input",{type:"text",inputmode:"decimal",id:"fo-unitPrice",value:s.unitPrice??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-unitPrice"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-unitPrice"},["Reset"])]),e("small",{class:"form-error",id:"fo-unitPrice-error"},[])]),e("label",{},["Currency",(()=>{const r=e("select",{id:"fo-currency"});return Yt.forEach(o=>r.append(e("option",{value:o},[o]))),r.value=s.currency||"USD",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-currency"},["USD"]),e("button",{class:"btn ghost",type:"button",id:"reset-currency"},["Reset"])]),e("small",{class:"form-error",id:"fo-currency-error"},[])]),e("label",{},["Logistik / Stk. (EUR)",e("input",{type:"text",inputmode:"decimal",id:"fo-freight",value:s.freight??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-freight"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-freight"},["Reset"])]),e("small",{class:"form-error",id:"fo-freight-warning"},[])]),e("label",{},["Logistik-Währung",(()=>{const r=e("select",{id:"fo-freightCurrency"});return Yt.forEach(o=>r.append(e("option",{value:o},[o]))),r.value=s.freightCurrency||"EUR",r})(),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-freightCurrency"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-freightCurrency"},["Reset"])])]),e("label",{},["Duty %",e("input",{type:"text",inputmode:"decimal",id:"fo-dutyRatePct",value:s.dutyRatePct??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-dutyRatePct"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-dutyRatePct"},["Reset"])])]),e("label",{},["EUSt %",e("input",{type:"text",inputmode:"decimal",id:"fo-eustRatePct",value:s.eustRatePct??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-eustRatePct"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-eustRatePct"},["Reset"])])]),e("label",{},["FX (USD je EUR)",e("input",{type:"text",inputmode:"decimal",id:"fo-fxRate",value:s.fxRate??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-fxRate"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-fxRate"},["Reset"])])]),e("label",{},["Production Lead Time (used)",e("input",{type:"number",min:"0",step:"1",id:"fo-productionLeadTimeDays",value:s.productionLeadTimeDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-productionLeadTimeDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-productionLeadTimeDays"},["Reset"])])]),e("label",{},["Fracht-LT (Tage)",e("input",{type:"number",min:"0",step:"1",id:"fo-logisticsLeadTimeDays",value:s.logisticsLeadTimeDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-logisticsLeadTimeDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-logisticsLeadTimeDays"},["Reset"])])]),e("label",{},[e("span",{class:"fo-buffer-label"},["Buffer (days)",e("span",{class:"tooltip"},[e("button",{class:"tooltip-trigger",type:"button","aria-label":"Buffer Erklärung"},["ℹ️"]),e("span",{class:"tooltip-content"},["Puffer in Tagen, der zur Sicherheit zusätzlich eingeplant wird. Er wird zur Summe aus Produktions- und Logistik-Leadtimes addiert und verschiebt das Bestelldatum entsprechend nach vorne."])])]),e("input",{type:"number",min:"0",step:"1",id:"fo-bufferDays",value:s.bufferDays??""}),e("div",{class:"suggested-row"},[e("span",{class:"muted",id:"suggested-bufferDays"},[]),e("button",{class:"btn ghost",type:"button",id:"reset-bufferDays"},["Reset"])])])]),e("div",{class:"fo-cost-summary"},[e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Supplier Cost"]),e("strong",{id:"fo-supplier-cost"},["—"])]),e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Landed Cost (EUR)"]),e("strong",{id:"fo-landed-cost"},["—"])]),e("div",{class:"fo-cost-row"},[e("span",{class:"muted"},["Geschätzte Fracht (EUR)"]),e("strong",{id:"fo-shipping-estimate"},["—"])]),e("small",{class:"muted",id:"fo-shipping-note"},[])]),e("div",{class:"banner info",id:"fo-suggestion-info"},[e("strong",{},["Why this suggestion"]),e("ul",{class:"fo-suggestion-list"},[])]),e("div",{class:"banner warning",id:"fo-warning-info",style:"display:none"},[e("strong",{},["Hinweise"]),e("ul",{class:"fo-warning-list"},[])]),e("div",{class:"banner info",id:"fo-product-banner",style:"display:none"},[e("strong",{},["SKU nicht in Produktdatenbank."]),e("span",{class:"muted"},[" Bitte Produkt anlegen."]),e("div",{class:"fo-banner-actions"},[e("input",{type:"text",id:"fo-product-name",placeholder:"Produktname (optional)"}),e("button",{class:"btn secondary",type:"button",id:"fo-product-create"},["Produkt anlegen"])])]),e("div",{class:"form-error",id:"fo-save-error",role:"alert"},[])]),e("section",{class:"card"},[e("h3",{},["Rückwärtsterminierung"]),e("div",{class:"fo-date-list"},[e("div",{class:"fo-date-row"},[e("span",{},["Ziel Delivery"]),e("strong",{id:"fo-preview-target"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["Order Date"]),e("strong",{id:"fo-preview-order"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["Production End"]),e("strong",{id:"fo-preview-production"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["ETD"]),e("strong",{id:"fo-preview-etd"},["—"])]),e("div",{class:"fo-date-row"},[e("span",{},["ETA"]),e("strong",{id:"fo-preview-eta"},["—"])])]),e("p",{class:"muted",id:"fo-user-anchor",style:"display:none;"},[]),e("div",{class:"fo-schedule-missing",id:"fo-schedule-missing",style:"display:none;"},[e("strong",{},["Fehlende Daten"]),e("ul",{class:"fo-schedule-missing-list",id:"fo-schedule-missing-list"},[])]),e("p",{class:"muted",id:"fo-date-warning",style:"display:none; margin-top:10px"},[]),e("div",{class:"fo-recommendation-card",id:"fo-recommendation"},[e("strong",{},["FO Empfehlung"]),e("p",{class:"muted",id:"fo-recommendation-summary"},["—"]),e("div",{class:"fo-recommendation-rows",id:"fo-recommendation-details"},[e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Baseline"]),e("strong",{id:"fo-recommendation-baseline"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["First month below safety DOH"]),e("strong",{id:"fo-recommendation-critical"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Required arrival (DE)"]),e("strong",{id:"fo-recommendation-arrival"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Recommended order date"]),e("strong",{id:"fo-recommendation-order"},["—"])]),e("div",{class:"fo-recommendation-row"},[e("span",{class:"muted"},["Recommended units"]),e("strong",{id:"fo-recommendation-units"},["—"])])]),e("div",{class:"fo-recommendation-issues",id:"fo-recommendation-issues"},[]),e("p",{class:"muted",id:"fo-recommendation-notes"},[])])])]),e("section",{class:"card"},[e("h3",{},["Payments"]),e("div",{class:"table-wrap"},[e("table",{class:"table-compact ui-data-table fo-payments-table","data-ui-table":"true"},[e("thead",{},[e("tr",{},[e("th",{},["Label"]),e("th",{class:"num"},["%"]),e("th",{class:"num"},["Amount"]),e("th",{},["Trigger"]),e("th",{class:"num"},["Offset Days"]),e("th",{},["Due Date"]),e("th",{},["Reset"])])]),e("tbody",{id:"fo-payments-body"},[])])]),e("p",{class:"muted fo-ddp-note",id:"fo-ddp-note",style:"display:none;"},["Bei DDP ist Fracht typischerweise in Deposit/Balance enthalten."]),e("div",{class:"fo-payments-footer"},[e("p",{class:"muted",id:"fo-payment-total"},["Summe: 100%"]),e("p",{class:"form-error",id:"fo-payment-error"},[]),e("button",{class:"btn secondary",type:"button",id:"fo-payment-normalize"},["Normalize to 100%"])])])]),yt=e("button",{class:"btn primary",type:"button"},["Save FO"]),$t=e("button",{class:"btn",type:"button"},["Cancel"]);let Lt=null;function Vt(){K.unregister(),K.detachBeforeUnload(),Lt&&document.removeEventListener("keydown",Lt),se.remove()}function Bt(){if(!N.isDirty){Vt();return}K({confirmWithModal:({onConfirm:r})=>Be({title:"Ungespeicherte Änderungen",message:"Ungespeicherte Änderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:()=>{N.discardDraft(),r==null||r(),Vt()}})})}const se=qt(b?"FO bearbeiten":"FO anlegen",f,[$t,yt],Bt);Lt=r=>{r.key==="Escape"&&(r.preventDefault(),Bt())},document.addEventListener("keydown",Lt),$t.addEventListener("click",Bt),R&&(yt.disabled=!0,f.querySelectorAll("input, select, textarea, button.btn.secondary, button.btn.ghost").forEach(r=>{r!==$t&&r.setAttribute("disabled","true")}));function et(r,o){s[r]=o,$[r]=!0,r==="productionLeadTimeDays"&&(s.productionLeadTimeDaysManual=o,s.productionLeadTimeSource="Manual override")}function kt(){const r=String(s.sku||"").trim(),o=String(s.supplierId||"").trim(),u=Number(s.units||0),l=z(s.unitPrice)||0,h=s.targetDeliveryDate,_=st(P,r),Y=!!_,H=_?ke(_,{state:n}):null,X=(H==null?void 0:H.status)==="blocked",G=s.payments.filter(ut=>ut.category==="supplier"),j=G.reduce((ut,Nt)=>ut+(Number(Nt.percent)||0),0),I=String(s.currency||"").trim(),V=G.length>0&&Math.round(j)===100,ot=r&&o&&u>0&&l>0&&h&&V&&I&&Y&&!X,J=c("#fo-unitPrice-error",f),Pt=c("#fo-units-error",f),dt=c("#fo-target-error",f),ft=c("#fo-product-error",f),q=c("#fo-supplier-error",f),Rt=c("#fo-currency-error",f),St=c("#fo-payment-error",f);if(J&&(J.textContent=l>0?"":"Unit Price ist erforderlich."),Pt&&(Pt.textContent=u>0?"":"Units ist erforderlich."),dt&&(dt.textContent=h?"":"Zieltermin ist erforderlich."),ft)if(!Y)ft.textContent="Produkt fehlt in der Datenbank.";else if(X){const ut=Te(H);ft.textContent=ut?`Produkt blockiert: ${ut}`:"Produkt blockiert."}else ft.textContent="";q&&(q.textContent=o?"":"Supplier ist erforderlich."),Rt&&(Rt.textContent=I?"":"Currency ist erforderlich."),St&&(St.textContent=V?"":"Payment Terms fehlen oder ergeben nicht 100%."),yt.disabled=!ot||!N.isDirty,c("#fo-save-error",f).textContent=ot?"":"Bitte fehlende Felder korrigieren."}function re(){N.setDraft(s),kt()}let _t=null;function F(){_t&&clearTimeout(_t),_t=setTimeout(()=>{const r=rt(s),o=gt(),u=Dt(s);s.payments=Le(s.payments,{baseValue:o,schedule:r,currency:s.currency,freight:u.freight,freightCurrency:u.freightCurrency,dutyRatePct:u.dutyRatePct,eustRatePct:u.eustRatePct,fxRate:u.fxRate,supplierCostEur:u.supplierCostEur,incoterm:s.incoterm}),s.payments=Tt(s.payments,s.incoterm),Gt(r),Jt(),kt(),Xt(),Qt(),ne(),ee(u),te(),re()},300)}const Et=c("#fo-product-input",f),ht=c("#fo-product-dropdown",f);function Ae(r){const o=st(P,r);return o||Ht(P,r)}function ie(r=""){ht.innerHTML="";const o=String(r||"").trim().toLowerCase(),u=L.filter(l=>o?l.label.toLowerCase().includes(o)||l.sku.toLowerCase().includes(o):!0).slice(0,12);if(!u.length){ht.append(e("div",{class:"muted fo-product-empty"},["Keine Produkte gefunden."]));return}u.forEach(l=>{var X,G,j;const h=((X=l.completeness)==null?void 0:X.status)==="blocked",_=bn((G=l.completeness)==null?void 0:G.status),Y=Te(l.completeness),H=e("button",{class:`fo-product-option${h?" is-blocked":""}`,type:"button",disabled:h,title:Y||_,onclick:()=>{s.sku=l.sku,Et.value=l.alias||l.sku,ht.style.display="none",at(),It(),F()}},[e("span",{class:"fo-product-alias",title:l.alias||l.sku},[l.alias||l.sku]),e("span",{class:"fo-product-sku muted",title:l.sku},[l.sku]),e("span",{class:`fo-product-status ${((j=l.completeness)==null?void 0:j.status)||"blocked"}`},[_])]);ht.append(H)})}Et.addEventListener("focus",()=>{ht.style.display="block",ie(Et.value)}),Et.addEventListener("input",r=>{const o=r.target.value;ie(o);const u=Ae(o);s.sku=u?u.sku:o.trim(),at(),It(),F()}),Et.addEventListener("blur",()=>{setTimeout(()=>{ht.style.display="none"},150)}),c("#fo-units",f).addEventListener("input",r=>{s.units=Z(r.target.value)??"",F()}),c("#fo-targetDeliveryDate",f).addEventListener("input",r=>{s.targetDeliveryDate=r.target.value,F()}),c("#fo-supplierId",f).addEventListener("change",r=>{if(s.supplierId=r.target.value,at(),!M){const o=rt(s),u=gt(),l=n.suppliers.find(_=>_.id===s.supplierId)||null,h=Dt(s);s.payments=At({supplier:l,baseValue:u,currency:s.currency,schedule:o,freight:h.freightTotal,freightCurrency:h.freightCurrency,dutyRatePct:h.dutyRatePct,eustRatePct:h.eustRatePct,fxRate:h.fxRate,supplierCostEur:h.supplierCostEur,incoterm:s.incoterm}),s.payments=Tt(s.payments,s.incoterm)}F()}),c("#fo-transportMode",f).addEventListener("change",r=>{et("transportMode",r.target.value),at(),F()}),c("#fo-incoterm",f).addEventListener("change",r=>{et("incoterm",r.target.value),at(),B(),Zt(),F()}),c("#fo-unitPrice",f).addEventListener("input",r=>{s.unitPrice=Z(r.target.value)??"",s.unitPriceIsOverridden=!0,B(),F()}),c("#fo-currency",f).addEventListener("change",r=>{et("currency",r.target.value.trim()||"USD"),B(),F()}),c("#fo-freight",f).addEventListener("input",r=>{et("freight",Z(r.target.value)??""),B(),F()}),c("#fo-freightCurrency",f).addEventListener("change",r=>{et("freightCurrency",r.target.value.trim()||"EUR"),B(),F()}),c("#fo-dutyRatePct",f).addEventListener("input",r=>{et("dutyRatePct",Z(r.target.value)??""),B(),F()}),c("#fo-eustRatePct",f).addEventListener("input",r=>{et("eustRatePct",Z(r.target.value)??""),B(),F()}),c("#fo-fxRate",f).addEventListener("input",r=>{et("fxRate",Z(r.target.value)??""),B(),F()}),c("#fo-productionLeadTimeDays",f).addEventListener("input",r=>{const o=Z(r.target.value);o==null?U("productionLeadTimeDays",g.productionLeadTimeDays):et("productionLeadTimeDays",o),B(),F()}),c("#fo-logisticsLeadTimeDays",f).addEventListener("input",r=>{et("logisticsLeadTimeDays",Z(r.target.value)??""),B(),F()}),c("#fo-bufferDays",f).addEventListener("input",r=>{et("bufferDays",Z(r.target.value)??""),B(),F()}),c("#reset-transportMode",f).addEventListener("click",()=>{U("transportMode",g.transportMode),B(),F()}),c("#reset-incoterm",f).addEventListener("click",()=>{U("incoterm",g.incoterm),B(),F()}),c("#reset-unitPrice",f).addEventListener("click",()=>{U("unitPrice",g.unitPrice??""),s.unitPriceIsOverridden=!1,B(),F()}),c("#reset-currency",f).addEventListener("click",()=>{U("currency",g.currency||"USD"),B(),F()}),c("#reset-freight",f).addEventListener("click",()=>{U("freight",g.freight??""),B(),F()}),c("#reset-freightCurrency",f).addEventListener("click",()=>{U("freightCurrency",g.freightCurrency||"EUR"),B(),F()}),c("#reset-dutyRatePct",f).addEventListener("click",()=>{U("dutyRatePct",g.dutyRatePct??""),B(),F()}),c("#reset-eustRatePct",f).addEventListener("click",()=>{U("eustRatePct",g.eustRatePct??""),B(),F()}),c("#reset-fxRate",f).addEventListener("click",()=>{U("fxRate",g.fxRate??""),B(),F()}),["fo-unitPrice","fo-freight","fo-dutyRatePct","fo-eustRatePct","fo-fxRate"].forEach(r=>{const o=c(`#${r}`,f);o&&o.addEventListener("blur",()=>{const u=Z(o.value);u!=null&&(r==="fo-dutyRatePct"||r==="fo-eustRatePct"?o.value=pt(u):o.value=nt(u))})}),c("#reset-productionLeadTimeDays",f).addEventListener("click",()=>{U("productionLeadTimeDays",g.productionLeadTimeDays),B(),F()}),c("#reset-logisticsLeadTimeDays",f).addEventListener("click",()=>{U("logisticsLeadTimeDays",g.logisticsLeadTimeDays),B(),F()}),c("#reset-bufferDays",f).addEventListener("click",()=>{U("bufferDays",g.bufferDays),B(),F()}),c("#fo-payment-normalize",f).addEventListener("click",Me),c("#fo-product-create",f).addEventListener("click",()=>{const r=String(s.sku||"").trim();if(!r)return;const o=c("#fo-product-name",f).value.trim();try{Ie({sku:r,alias:o||r,supplierId:s.supplierId||""}),P.push({sku:r,alias:o||r}),L.push({sku:r,alias:o||r,label:o||r}),c("#fo-product-banner",f).style.display="none",F()}catch(u){window.alert((u==null?void 0:u.message)||"Produkt konnte nicht angelegt werden.")}}),f.addEventListener("click",r=>{const o=r.target.closest(".fo-fix-now");if(!o)return;const u=o.dataset.sku,l=o.dataset.tab||"suppliers";u&&(sessionStorage.setItem("healthFocus",JSON.stringify({tab:l,sku:u})),l==="produkte"?location.hash="#produkte":location.hash="#suppliers",se.remove())});function Oe(){const{issues:r}=_e({settings:n.settings,products:n.products,suppliers:n.suppliers});return r.filter(o=>o.blocking?o.scope==="settings"?o.field==="fxRate":o.scope==="product"?o.entityId===s.sku&&(o.field==="currency"||o.field==="unitPrice"):o.scope==="supplier"?o.entityId===s.supplierId&&(o.field==="paymentTerms"||o.field==="productionLeadTime"):!1:!1)}if(yt.addEventListener("click",async()=>{if(kt(),yt.disabled)return;const r=Oe();if(r.length){$e(r);return}yt.disabled=!0,yt.textContent="Speichern…",String(s.incoterm||"").toUpperCase()==="DDP"&&(s.dutyRatePct=0,s.eustRatePct=0,s.freightCurrency="USD");const o=rt(s),u=Pn(s,o,s.payments);await N.commit(()=>{const l=he();Array.isArray(l.fos)||(l.fos=[]);const h=l.fos.findIndex(_=>_.id===u.id);h>=0?l.fos[h]=u:l.fos.push(u),zt(l,{source:"fo:save",entityKey:`fo:${u.id}`,action:h>=0?"update":"create"})}),E(),window.alert("FO gespeichert."),Vt()}),!s.payments.length){const r=rt(s),o=gt(),u=n.suppliers.find(h=>h.id===s.supplierId)||null,l=Dt(s);String(s.incoterm||"").toUpperCase()==="DDP"&&(l.dutyRatePct=0,l.eustRatePct=0),s.payments=At({supplier:u,baseValue:o,currency:s.currency,schedule:r,freight:l.freightTotal,freightCurrency:l.freightCurrency,dutyRatePct:l.dutyRatePct,eustRatePct:l.eustRatePct,fxRate:l.fxRate,supplierCostEur:l.supplierCostEur,incoterm:s.incoterm}),s.payments=Tt(s.payments,s.incoterm)}at(),It(),lt(),kt()}c("#fo-add",t).addEventListener("click",()=>O(null)),d.addEventListener("click",p=>{var k,m,w,x;const C=(k=p.target)!=null&&k.closest?p.target:(m=p.target)==null?void 0:m.parentElement;if(!C)return;const P=C.closest("tr[data-id], tr[data-key]");if(!P)return;const L=P.dataset.id||P.dataset.key,b=n.fos.find(s=>s.id===L);if(!b)return;const R=(x=(w=C.closest("button"))==null?void 0:w.dataset)==null?void 0:x.action;if(R==="edit")O(b);else if(R==="convert"){if(String(b.status||"").toUpperCase()==="CONVERTED")return;S(b)}else if(R==="delete"){const N=String(b.status||"").toUpperCase()==="CONVERTED"?"Diese FO wurde bereits in eine PO umgewandelt. FO trotzdem löschen? (Die PO bleibt bestehen.)":"Forecast Order wirklich löschen?";if(!window.confirm(N))return;n.fos=n.fos.filter($=>$.id!==L),zt(n,{source:"fo:delete",entityKey:`fo:${L}`,action:"delete"}),E()}else if(R==="supplier"){const s=n.suppliers.find(N=>N.id===b.supplierId);s?T("Supplier Details",[`Name: ${s.name}`,`Incoterm: ${s.incotermDefault||"—"}`,`Currency: ${s.currencyDefault||"—"}`]):T("Supplier Details",["Supplier ist nicht vorhanden."])}}),E();function A(){const p=window.__routeQuery||{};if(p.create==="1"||p.mode==="create"){O(null,{sku:p.sku||"",alias:p.alias||"",targetDeliveryDate:p.target||"",anchorMonth:p.anchorMonth||""}),window.__routeQuery={};return}if(!p.open)return;const P=String(p.open||"").trim().toLowerCase();if(!P)return;const L=n.fos.find(b=>{if(!b)return!1;const R=String(b.id||"").toLowerCase()===P,k=String(b.foNo||"").toLowerCase()===P;return R||k});L&&(O(L),window.__routeQuery={})}A()}export{kn as default};
