import{p as X}from"./index-CafJOI4c.js";import{b as R}from"./orderEditorFactory-DxK4Dg1F.js";const w={entityLabel:"PO",numberField:"poNo"},G=["Deposit","Balance","Balance2","Shipping","EUSt","Zoll","EUSt-Erstattung","Other"],tt=new Set(["Deposit","Balance","Balance2","Shipping","EUSt","Zoll","EUSt-Erstattung"]);function v(t){return String(t||"").trim().toLowerCase()}function nt(t){const n=String(t||"").trim();return/^\d{4}-\d{2}$/.test(n)?n:""}function B(t){const n=X(t);return Number.isFinite(n)?Number(n):0}function j(t){const n=Number(t);return Number.isFinite(n)?n:null}function _(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*100)/100:null}function N(...t){for(const n of t){const r=String(n||"").trim();if(r)return r}return""}function $(t){if(!t)return"";if(t instanceof Date&&!Number.isNaN(t.getTime())){const i=t.getUTCFullYear(),a=String(t.getUTCMonth()+1).padStart(2,"0"),d=String(t.getUTCDate()).padStart(2,"0");return`${i}-${a}-${d}`}const n=String(t).trim();if(!n)return"";const r=n.match(/^(\d{4})-(\d{2})-(\d{2})/);if(r)return`${r[1]}-${r[2]}-${r[3]}`;const u=n.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);if(u){const i=String(Number(u[1])).padStart(2,"0"),a=String(Number(u[2])).padStart(2,"0");return`${String(Number(u[3]))}-${a}-${i}`}const e=new Date(n);if(Number.isNaN(e.getTime()))return"";const o=e.getUTCFullYear(),s=String(e.getUTCMonth()+1).padStart(2,"0"),c=String(e.getUTCDate()).padStart(2,"0");return`${o}-${s}-${c}`}function x(t){const n=$(t);return n?n.slice(0,7):""}function k(t){if(t===!0||t===1)return!0;const n=String(t||"").trim().toLowerCase();return n==="paid"||n==="bezahlt"||n==="done"||n==="true"||n==="1"||n==="yes"||n==="ja"}function C(t,n){if(!Number.isFinite(Number(t)))return!1;const r=Number(t),u=Number.isFinite(Number(n))?Number(n):null;return r>0||r===0&&u!=null&&u===0}function q(t){return typeof structuredClone=="function"?structuredClone(t||{}):JSON.parse(JSON.stringify(t||{}))}function et(t,n=null){const r=n&&typeof n=="object"?n:(t==null?void 0:t.settings)||{};return{fxRate:B(r.fxRate),fxFeePct:B(r.fxFeePct),eurUsdRate:B(r.eurUsdRate),dutyRatePct:B(r.dutyRatePct),dutyIncludeFreight:r.dutyIncludeFreight!==!1,eustRatePct:B(r.eustRatePct),vatRefundEnabled:r.vatRefundEnabled!==!1,vatRefundLagMonths:Number(r.vatRefundLagMonths||0)||0,freightLagDays:Number(r.freightLagDays||0)||0,cny:r.cny&&typeof r.cny=="object"?{start:String(r.cny.start||""),end:String(r.cny.end||"")}:{start:"",end:""},cnyBlackoutByYear:r.cnyBlackoutByYear&&typeof r.cnyBlackoutByYear=="object"?q(r.cnyBlackoutByYear):{}}}function rt(t){const n=new Map;return(Array.isArray(t==null?void 0:t.suppliers)?t.suppliers:[]).forEach(r=>{const u=r||{},e=String(u.name||"").trim();if(!e)return;const o=v(u.id),s=v(e);o&&n.set(o,e),s&&n.set(s,e)}),n}function W(t,n){const r=v((t==null?void 0:t.supplierId)||(t==null?void 0:t.supplier)||(t==null?void 0:t.supplierName)||"");return r&&n.has(r)?n.get(r):String((t==null?void 0:t.supplierName)||(t==null?void 0:t.supplier)||"").trim()||"—"}function st(t){const n=new Map;return(Array.isArray(t)?t:[]).forEach(r=>{const u=r||{},e=v(u.sku);e&&n.set(e,String(u.alias||u.sku||""))}),n}function ut(t){const n=j(t);return Number.isFinite(n)?Math.max(0,Math.round(n)):null}function at(t){const n=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];return n.length?n:t!=null&&t.sku?[{sku:t.sku,units:t.units||0}]:[]}function it(t,n){const r=at(t);if(!r.length)return{skuAliases:"—",itemSummary:"—",itemTooltip:"Keine Positionen vorhanden."};const u=[],e=[];r.forEach(i=>{const a=String((i==null?void 0:i.sku)||"").trim(),d=a?n.get(v(a))||a:"—",g=ut(i==null?void 0:i.units);u.push(d),e.push(`${d} (${a||"—"}) · Menge ${g==null?"—":String(g)}`)});const o=Array.from(new Set(u.filter(Boolean))),s=o.join(", ")||"—",c=o.length>1?`${o[0]}, …`:o[0]||"—";return{skuAliases:s,itemSummary:c,itemTooltip:e.join(`
`)||s}}function ot(t){const n=String(t||"").trim().toUpperCase();return n?n==="PLANNED"?"ACTIVE":n==="CANCELLED"?"ARCHIVED":n:"DRAFT"}function lt(t){const n=ot(t);return n==="DRAFT"||n==="ACTIVE"}function U(t){return Array.from(new Set(t.filter(Boolean))).sort((n,r)=>{const u=G.indexOf(n),e=G.indexOf(r),o=u>=0?u:G.length+1,s=e>=0?e:G.length+1;return o-s})}function z(t){return t.some(n=>tt.has(n))}function V({label:t,eventType:n}){const r=String(t||"").toLowerCase(),u=String(n||"").toLowerCase();if(u==="fx_fee"||r.includes("fx"))return[];const e=new Set;u==="freight"&&e.add("Shipping"),u==="duty"&&e.add("Zoll"),u==="eust"&&e.add("EUSt"),(u==="vat_refund"||u==="eust_refund")&&e.add("EUSt-Erstattung"),(r.includes("deposit")||r.includes("anzahlung"))&&e.add("Deposit"),r.includes("balance2")||r.includes("balance 2")||r.includes("second balance")?e.add("Balance2"):(r.includes("balance")||r.includes("rest"))&&e.add("Balance"),(r.includes("shipping")||r.includes("fracht"))&&e.add("Shipping"),r.includes("eust")&&e.add("EUSt"),(r.includes("zoll")||r.includes("custom")||r.includes("duty"))&&e.add("Zoll"),r.includes("refund")&&r.includes("eust")&&e.add("EUSt-Erstattung");const o=U(Array.from(e));return o.length?o:["Other"]}function H(t){return U(t).join("+")||"Other"}function ct(t){const n=new Map,r=new Map,u=new Map;return(Array.isArray(t)?t:[]).forEach(e=>{const o=e||{},s=String(o.id||"").trim();s&&(n.set(s,o),Array.isArray(o.allocations)&&o.allocations.forEach(c=>{const i=c||{},a=String(i.eventId||i.plannedId||"").trim();a&&(r.set(a,i),u.set(a,s))}),Array.isArray(o.coveredEventIds)&&o.coveredEventIds.forEach(c=>{const i=String(c||"").trim();i&&u.set(i,s)}))}),{byId:n,allocationByEvent:r,paymentIdsByEvent:u}}function ft(t,n){const r=n.map(c=>Number(c.plannedEur||0)),u=r.reduce((c,i)=>c+i,0);if(!Number.isFinite(u)||u<=0)return null;const e=r.map((c,i)=>{const a=c/u,d=t*a;return{eventId:n[i].id,planned:c,actual:Math.round(d*100)/100}}),o=e.reduce((c,i)=>c+i.actual,0),s=Math.round((t-o)*100)/100;if(Math.abs(s)>0&&e.length){let c=e[e.length-1];e.length>1&&(c=e.reduce((i,a)=>a.planned>i.planned?a:i,c)),c.actual=Math.round((c.actual+s)*100)/100}return e}function dt({payment:t,paymentRow:n,paymentRows:r}){if(!t||!(n!=null&&n.paymentId))return null;const u=Number(t.amountActualEurTotal);if(!Number.isFinite(u))return null;const e=r.filter(s=>String((s==null?void 0:s.paymentId)||"")===String(n.paymentId||""));if(!e.length)return null;const o=ft(u,e.map(s=>({id:String(s.id||""),plannedEur:Number(s.plannedEur||0)})));return o&&o.find(s=>s.eventId===n.id)||null}function mt({status:t,plannedEur:n,paymentRow:r,paymentRows:u,paymentRecord:e,paymentIndexes:o,paymentLogEntry:s,state:c,eventId:i,paidDate:a}){const d=[];if(t!=="PAID")return{amountActualEur:null,issues:d};const g=[r==null?void 0:r.paidEurActual,s==null?void 0:s.amountActualEur];for(const f of g)if(!(f==null||f==="")&&Number.isFinite(Number(f)))return C(f,n)?{amountActualEur:Number(f),issues:d}:(d.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:Number(f),issues:d});if(e!=null&&e.allocations&&Array.isArray(e.allocations)){const f=e.allocations.find(h=>{const m=h||{},S=String(m.eventId||m.plannedId||"").trim();return S?S===String(i||""):!1})||null;if(f){const h=N(f.amountEur,f.amountActualEur,f.actualEur,f.actual);if(h!==""&&C(h,n))return{amountActualEur:Number(h),issues:d}}}if(e&&(r!=null&&r.paymentId)){const f=o.allocationByEvent.get(String(i||""))||dt({payment:e,paymentRow:r,paymentRows:u});if(f&&C(f.actual,n))return d.push("PRO_RATA_ALLOCATION"),{amountActualEur:Number(f.actual),issues:d};if(C(e.amountActualEurTotal,n)&&u.filter(m=>String((m==null?void 0:m.paymentId)||"")===String((r==null?void 0:r.paymentId)||"")).length<=1)return{amountActualEur:Number(e.amountActualEurTotal),issues:d}}if(!(r!=null&&r.paymentId)&&a&&i){const f=(Array.isArray(c==null?void 0:c.payments)?c.payments:[]).find(h=>{const m=h||{};return $(m.paidDate)!==$(a)?!1:!!(Array.isArray(m.coveredEventIds)&&m.coveredEventIds.includes(i))});if(f&&C(f.amountActualEurTotal,n))return{amountActualEur:Number(f.amountActualEurTotal),issues:d}}return d.push("MISSING_ACTUAL_AMOUNT"),{amountActualEur:null,issues:d}}function O(t){return Array.from(new Set(t.filter(Boolean)))}function Z(t){const n=O(t);return n.length?n.length===1?n[0]:`${n[0]}, …`:""}function pt({state:t,settings:n,supplierNameMap:r,skuAliasMap:u,paymentIndexes:e}){const o=[],s=Array.isArray(t==null?void 0:t.payments)?t.payments:[];return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(i=>{const a=i||{};if(a.archived||String(a.status||"").toUpperCase()==="CANCELLED")return;const d=W(a,r),g=it(a,u),f=String(a.id||a.poNo||"po"),h=a.paymentLog&&typeof a.paymentLog=="object"?a.paymentLog:{},m=R(q(a),w,n,s,{includeIncoming:!0}),S=new Set;m.forEach(I=>{const y=I||{},A=String(y.id||"").trim();if(!A)return;S.add(A);const E=h[A]&&typeof h[A]=="object"?h[A]:{},l=V({label:y.typeLabel||y.label||E.label||"",eventType:y.eventType||E.eventType||""});if(!z(l))return;const b=N(y.paymentId,E.paymentId,e.paymentIdsByEvent.get(A)),p=b&&e.byId.get(b)||null,T=k(y.status)||k(E.status)||k(E.paid)||p&&k(p.status)?"PAID":"OPEN",M=$(N(y.dueDate,E.dueDate));let D=$(N(p==null?void 0:p.paidDate,y.paidDate,E.paidDate));const P=[];T==="PAID"&&!D&&M&&(D=M,P.push("DATE_UNCERTAIN")),T==="PAID"&&!D&&P.push("PAID_WITHOUT_DATE");const F=j(y.plannedEur),Y=mt({status:T,plannedEur:F,paymentRow:y,paymentRows:m,paymentRecord:p,paymentIndexes:e,paymentLogEntry:E,state:t,eventId:A,paidDate:D});let L=Y.amountActualEur;P.push(...Y.issues),T==="PAID"&&!C(L,F)&&(Number.isFinite(F)?(L=F,P.push("IST_FEHLT")):(L=null,P.push("IST_FEHLT"))),T==="PAID"&&(!b||!p)&&P.push("AUTO_GENERATED");const Q=x(T==="PAID"?D:M),K=`PO-EVT-${f}-${A}`;o.push({rowId:K,eventId:A,month:Q,entityType:"PO",poNumber:String(a.poNo||a.id||""),foNumber:"",supplierName:d,skuAliases:g.skuAliases,itemSummary:g.itemSummary,itemTooltip:g.itemTooltip,paymentType:H(l),includedPositions:U(l),status:T,dueDate:M,paidDate:D,paymentId:b||"",amountPlannedEur:F,amountActualEur:T==="PAID"?_(L):null,payer:N(y.paidBy,p==null?void 0:p.payer,E.payer),paymentMethod:N(y.method,p==null?void 0:p.method,E.method),note:N(y.note,p==null?void 0:p.note,E.note),internalId:String(y.paymentInternalId||y.id||a.id||K),issues:O(P),_positions:U(l)})}),Object.entries(h).forEach(([I,y])=>{if(S.has(I))return;const A=y&&typeof y=="object"?y:{};if((k(A.status)||k(A.paid)?"PAID":"OPEN")!=="PAID")return;const l=V({label:A.label||I,eventType:A.eventType||""});if(!z(l))return;const b=N(A.paymentId,e.paymentIdsByEvent.get(I)),p=b&&e.byId.get(b)||null,T=$(N(A.dueDate));let M=$(N(p==null?void 0:p.paidDate,A.paidDate));const D=["AUTO_GENERATED"];!M&&T&&(M=T,D.push("DATE_UNCERTAIN")),M||D.push("PAID_WITHOUT_DATE");const P=j(N(A.amountPlannedEur,A.plannedEur));let F=j(N(A.amountActualEur,p==null?void 0:p.amountActualEurTotal));C(F,P)||(Number.isFinite(P)?(F=P,D.push("IST_FEHLT")):(F=null,D.push("IST_FEHLT")));const Y=x(M),L=`PO-LEGACY-${f}-${I}`;o.push({rowId:L,eventId:I,month:Y,entityType:"PO",poNumber:String(a.poNo||a.id||""),foNumber:"",supplierName:d,skuAliases:g.skuAliases,itemSummary:g.itemSummary,itemTooltip:g.itemTooltip,paymentType:H(l),includedPositions:U(l),status:"PAID",dueDate:T,paidDate:M,paymentId:b||"",amountPlannedEur:P,amountActualEur:_(F),payer:N(p==null?void 0:p.payer,A.payer),paymentMethod:N(p==null?void 0:p.method,A.method),note:N(p==null?void 0:p.note,A.note),internalId:String(A.paymentInternalId||I||a.id||L),issues:O(D),_positions:U(l)})})}),o}function yt(t,n){const r=new Map,u=[];return t.forEach(e=>{if(e.status==="PAID"&&e.paymentId){r.has(e.paymentId)||r.set(e.paymentId,[]),r.get(e.paymentId).push(e);return}u.push(e)}),r.forEach((e,o)=>{if(!e.length)return;if(e.length===1){u.push(e[0]);return}const s=n.byId.get(o)||null,c=U(e.flatMap(l=>l._positions||[])),i=O([...e.flatMap(l=>l.issues||[]),"GROUPED_PAYMENT"]),a=_(e.reduce((l,b)=>l+(Number(b.amountPlannedEur)||0),0));let d=j(s==null?void 0:s.amountActualEurTotal);C(d,a)||(d=_(e.reduce((l,b)=>l+(Number(b.amountActualEur)||0),0))),C(d,a)||(Number.isFinite(a)?(d=a,i.push("IST_FEHLT")):d=null);let g=$(N(s==null?void 0:s.paidDate,...e.map(l=>l.paidDate)));const h=e.map(l=>$(l.dueDate)).filter(Boolean).sort()[0]||"";!g&&h&&(g=h,i.push("DATE_UNCERTAIN"));const m=x(g),S=O(e.map(l=>l.poNumber)),I=O(e.map(l=>l.supplierName)),y=O(e.flatMap(l=>String(l.skuAliases||"").split(",").map(b=>b.trim()))),A=y.length>1?`${y[0]}, …`:y[0]||"—",E=O(e.map(l=>l.itemTooltip)).join(`

`);u.push({rowId:`PO-PAY-${o}-${m||"undated"}-${S[0]||"po"}`,eventId:e.map(l=>l.eventId).join("|"),month:m,entityType:"PO",poNumber:Z(S)||"—",foNumber:"",supplierName:Z(I)||"—",skuAliases:y.join(", ")||"—",itemSummary:A,itemTooltip:E||e[0].itemTooltip||"",paymentType:H(c),includedPositions:c,status:"PAID",dueDate:h,paidDate:g,paymentId:o,amountPlannedEur:a,amountActualEur:_(d),payer:N(s==null?void 0:s.payer,...e.map(l=>l.payer)),paymentMethod:N(s==null?void 0:s.method,...e.map(l=>l.paymentMethod)),note:N(s==null?void 0:s.note,...e.map(l=>l.note)),internalId:o,issues:O(i)})}),u}function At({state:t,supplierNameMap:n,skuAliasMap:r}){const u=[];return(Array.isArray(t==null?void 0:t.fos)?t.fos:[]).forEach(o=>{const s=o||{};if(!lt(s.status)||!Array.isArray(s.payments))return;const c=W(s,n),i=String(s.sku||"").trim(),a=i?r.get(v(i))||i:"—",d=Number(s.fxRate||0);s.payments.forEach(g=>{const f=g||{};if(String(f.category||"").toLowerCase()==="eust_refund")return;const h=V({label:f.label||f.category||"",eventType:f.category||""});if(!z(h))return;const m=Number(f.amount||0);if(!Number.isFinite(m)||m<=0)return;const I=String(f.currency||"EUR").toUpperCase()==="EUR"?m:d>0?m/d:m,y=$(f.dueDate),A=x(y),E=String(s.id||s.foNumber||""),l=H(h),b=String(f.id||`${E}-${l}-${y}`);u.push({rowId:`FO-${E}-${b}`,eventId:b,month:A,entityType:"FO",poNumber:String(s.convertedPoNo||""),foNumber:String(s.foNumber||s.id||""),supplierName:c,skuAliases:a,itemSummary:a,itemTooltip:`${a} (${i||"—"})`,paymentType:l,includedPositions:U(h),status:"OPEN",dueDate:y,paidDate:"",paymentId:"",amountPlannedEur:_(I),amountActualEur:null,payer:"",paymentMethod:"",note:"",internalId:String(s.id||b),issues:[]})})}),u}function J(t){return t.status==="PAID"?$(t.paidDate||t.dueDate):$(t.dueDate||t.paidDate)}function ht(t){const n=[],r=new Set;return t.forEach(u=>{const e=String(u.rowId||"");r.has(e)||(r.add(e),n.push(u))}),n}function bt(t={}){const n=t!=null&&t.state&&typeof t.state=="object"?t.state:{},r=et(n,(t==null?void 0:t.settings)||null),u=Array.isArray(t==null?void 0:t.products)?t.products:Array.isArray(n==null?void 0:n.products)?n.products:[],e=nt((t==null?void 0:t.month)||""),o=String((t==null?void 0:t.scope)||"both"),s=(t==null?void 0:t.includeFo)!==!1,c=rt(n),i=st(u),a=ct(Array.isArray(n==null?void 0:n.payments)?n.payments:[]),d=pt({state:n,settings:r,supplierNameMap:c,skuAliasMap:i,paymentIndexes:a}),g=yt(d,a),f=s?At({state:n,supplierNameMap:c,skuAliasMap:i}):[];return ht([...g,...f]).filter(m=>!(o==="paid"&&m.status!=="PAID"||o==="open"&&m.status!=="OPEN"||e&&m.month!==e)).sort((m,S)=>{const I=J(m),y=J(S);if(I!==y)return I.localeCompare(y);const A=`${m.entityType}:${m.poNumber||m.foNumber}:${m.paymentType}:${m.rowId}`,E=`${S.entityType}:${S.poNumber||S.foNumber}:${S.paymentType}:${S.rowId}`;return A.localeCompare(E)})}export{bt as b};
