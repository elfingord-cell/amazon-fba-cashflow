import{p as M}from"./index-CAzQztwo.js";import{g as W,b as j,c as q,f as Y}from"./foSuggestion-Ck1952gl.js";const $=["DRAFT","ACTIVE","CONVERTED","ARCHIVED"],G={PLANNED:"ACTIVE",CANCELLED:"ARCHIVED"},dt=["SEA","RAIL","AIR"],Dt=["EXW","DDP"],H=["ORDER_DATE","PRODUCTION_END","ETD","ETA","DELIVERY"],K=["EUR","USD","CNY"],lt=["ORDER_DATE","PROD_DONE","ETD","ETA"];function V(t,e="DRAFT"){const n=String(t||"").trim().toUpperCase();return n?$.includes(n)?n:G[n]||e:e}function z(t){const e=V(t);return e==="DRAFT"||e==="ACTIVE"}function ft(t){return z(t)}function X(t,e){const n=Array.isArray(e)?e:[];if(!n.length)return t;const o=new Map(n.map(r=>[String((r==null?void 0:r.id)||""),r]));return t.map(r=>{const s=o.get(String(r.id||""));return s?{...r,dueDate:s.dueDateManuallySet?String(s.dueDate||r.dueDate||""):r.dueDate,dueDateManuallySet:s.dueDateManuallySet===!0?!0:r.dueDateManuallySet,isOverridden:s.isOverridden===!0?!0:r.isOverridden}:r})}function h(t,e=0){const n=M(t);return Number.isFinite(n)?Number(n):e}function p(t){const e=M(t);if(!Number.isFinite(e))return null;const n=Number(e);return n<=0?null:n}function a(t,e=0){return Math.max(0,h(t,e))}function E(t){if(!t)return null;const[e,n,o]=String(t).split("-").map(Number);if(!e||!n||!o)return null;const r=new Date(Date.UTC(e,n-1,o));return Number.isNaN(r.getTime())?null:r}function m(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}function S(t,e){const n=new Date(t.getTime());return n.setUTCDate(n.getUTCDate()+Number(e||0)),n}function w(t,e){const n=new Date(t.getTime());return n.setUTCMonth(n.getUTCMonth()+Number(e||0)),n}function N(t){return t==="PRODUCTION_END"?"PROD_DONE":t==="DELIVERY"?"ETA":t}function L(t){return Y.monthKey(t)}function v(t){const e=String(t||"").trim().toUpperCase();return H.includes(e)?e:"ORDER_DATE"}function C(t,e="EUR"){const n=String(t||e).trim().toUpperCase();return K.includes(n)?n:e}function b(){return[{label:"Deposit",percent:30,triggerEvent:"ORDER_DATE",offsetDays:0,offsetMonths:0},{label:"Balance",percent:70,triggerEvent:"ETD",offsetDays:0,offsetMonths:0}]}function J(t){const e={ORDER_DATE:E(t.orderDate),PRODUCTION_END:E(t.productionEndDate),ETD:E(t.etdDate),ETA:E(t.etaDate),DELIVERY:E(t.deliveryDate)};return!e.ETD&&e.ETA&&Number.isFinite(Number(t.logisticsLeadTimeDays))&&(e.ETD=S(e.ETA,-Number(t.logisticsLeadTimeDays||0))),e}function P(t,e,n,o){const r=o[t]||null;if(!r)return null;let s=S(r,Number(e||0));return n&&(s=w(s,Number(n||0))),m(s)}function T(t){return`${t}-${Math.random().toString(36).slice(2,9)}`}function R(){return new Date().toISOString()}function U(t,e,n){const o=h(t,0);if(String(e||"EUR").toUpperCase()==="EUR")return o;const s=a(n,0);return s?o/s:o}function gt(t){const e=E(t.targetDeliveryDate),n=a(t.productionLeadTimeDays,0),o=a(t.logisticsLeadTimeDays,0),r=a(t.bufferDays,0);if(!e||n<=0)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null,deliveryDate:e?m(e):null,logisticsLeadTimeDays:o};const s=S(e,-(n+o+r)),d=S(s,n),u=d,i=S(u,o);return{orderDate:m(s),productionEndDate:m(d),etdDate:m(u),etaDate:m(i),deliveryDate:m(e),logisticsLeadTimeDays:o}}function Q(t){const e=E(t.orderDate),n=a(t.productionLeadTimeDays,0),o=a(t.logisticsLeadTimeDays,0),r=a(t.bufferDays,0);if(!e)return{orderDate:null,productionEndDate:null,etdDate:null,etaDate:null,deliveryDate:t.deliveryDate?String(t.deliveryDate):null,logisticsLeadTimeDays:o};const s=S(e,n+r),d=s,u=S(d,o);return{orderDate:m(e),productionEndDate:m(s),etdDate:m(d),etaDate:m(u),deliveryDate:t.deliveryDate?String(t.deliveryDate):null,logisticsLeadTimeDays:o}}function k(t){const e=t||{},n=String(e.sku||"").trim();if(!n)return null;const o=Math.max(0,Math.round(h(e.units,0))),r=a(e.unitCostUsd,0),s=a(e.unitExtraUsd,0),d=a(e.extraFlatUsd,0),u=Math.max(0,Math.round(p(e.prodDays)??a(e.productionLeadTimeDays,0))),i=Math.max(0,Math.round(p(e.transitDays)??a(e.logisticsLeadTimeDays,0))),l=a(e.freightEur,0);return{id:String(e.id||T("poi")),sku:n,units:o,unitCostUsd:r,unitExtraUsd:s,extraFlatUsd:d,prodDays:u,transitDays:i,freightEur:l}}function Z(t,e){const n=Array.isArray(t)?t.map(k).filter(Boolean):[];if(n.length)return n;const o=String((e==null?void 0:e.sku)||"").trim();if(!o)return[];const r=k({id:String((e==null?void 0:e.id)||T("poi")),sku:o,units:e==null?void 0:e.units,unitCostUsd:e==null?void 0:e.unitCostUsd,unitExtraUsd:e==null?void 0:e.unitExtraUsd,extraFlatUsd:e==null?void 0:e.extraFlatUsd,prodDays:e==null?void 0:e.prodDays,transitDays:e==null?void 0:e.transitDays,freightEur:e==null?void 0:e.freightEur});return r?[r]:[]}function yt(t){var y;const e=Z(t.items,t.fallback);let n=0,o=0,r=0,s=0,d=0;const u=E(t.orderDate);let i=null,l=null;e.forEach(g=>{const c=g.units*(g.unitCostUsd+g.unitExtraUsd)+g.extraFlatUsd;if(n+=c,o+=g.freightEur,r+=g.units,s=Math.max(s,g.prodDays),d=Math.max(d,g.transitDays),u){const D=S(u,g.prodDays+g.transitDays);(!i||D<i)&&(i=D),(!l||D>l)&&(l=D)}});const f=Q({orderDate:t.orderDate,productionLeadTimeDays:s,logisticsLeadTimeDays:d,bufferDays:0});return{items:e,goodsUsd:n,goodsEur:U(n,"USD",t.fxRate),freightEur:o,units:r,prodDays:s,transitDays:d,firstSku:((y=e[0])==null?void 0:y.sku)||"",minEtaDate:m(i),maxEtaDate:m(l),schedule:f}}function mt(t){return et([],t).map((n,o)=>({id:String(n.id||`ms-${o+1}-${Math.random().toString(36).slice(2,8)}`),label:String(n.label||"Milestone"),percent:a(n.percent,0),anchor:N(v(n.triggerEvent)),lagDays:h(n.offsetDays,0)}))}function tt(t){const e=a(t.units,0),n=a(t.unitPrice,0),o=e*n,r=U(o,t.currency,t.fxRate),s=a(t.freight,0),d=U(s,t.freightCurrency,t.fxRate),u=a(t.dutyRatePct,0),i=a(t.eustRatePct,0),l=r*(u/100),f=(r+l+d)*(i/100),y=r+d+l+f;return{supplierCost:o,supplierCostEur:r,freightAmount:s,freightEur:d,dutyAmountEur:l,eustAmountEur:f,landedCostEur:y}}function et(t,e){const n=Array.isArray(t)?t.filter(r=>String((r==null?void 0:r.category)||"supplier")==="supplier"):[];if(n.length)return n.map(r=>({id:r.id?String(r.id):void 0,label:String(r.label||"Milestone"),percent:a(r.percent,0),triggerEvent:v(r.triggerEvent),offsetDays:h(r.offsetDays,0),offsetMonths:h(r.offsetMonths,0)}));const o=Array.isArray(e==null?void 0:e.paymentTermsDefault)?e==null?void 0:e.paymentTermsDefault:[];return o.length?o.map(r=>({id:r.id?String(r.id):void 0,label:String(r.label||"Milestone"),percent:a(r.percent,0),triggerEvent:v(r.triggerEvent),offsetDays:h(r.offsetDays,0),offsetMonths:h(r.offsetMonths,0)})):b()}function nt(t){const e=tt(t),n=J(t.schedule),o=a(t.unitPrice,0)*a(t.units,0),r=(t.supplierTerms||[]).map((f,y)=>{const g=v(f.triggerEvent),c=h(f.offsetDays,0),D=h(f.offsetMonths,0);return{id:f.id||`supplier-${y}`,label:String(f.label||"Milestone"),percent:a(f.percent,0),amount:o*(a(f.percent,0)/100),currency:C(t.currency,"EUR"),triggerEvent:g,offsetDays:c,offsetMonths:D,dueDate:P(g,c,D,n),isOverridden:!1,dueDateManuallySet:!1,category:"supplier"}}),s=String(t.incoterm||"EXW").toUpperCase(),d=Math.max(0,Math.round(a(t.vatRefundLagMonths,2))),u=[...r];s!=="DDP"&&e.freightAmount>0&&u.push({id:"auto-freight",label:"Fracht",percent:0,amount:e.freightAmount,currency:C(t.freightCurrency,"EUR"),triggerEvent:"ETD",offsetDays:0,offsetMonths:0,dueDate:P("ETD",0,0,n),category:"freight",isOverridden:!1,dueDateManuallySet:!1});const i=a(t.dutyRatePct,0);s!=="DDP"&&i>0&&u.push({id:"auto-duty",label:"Duty",percent:i,amount:e.dutyAmountEur,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:0,dueDate:P("ETA",0,0,n),category:"duty",isOverridden:!1,dueDateManuallySet:!1});const l=a(t.eustRatePct,0);return s!=="DDP"&&l>0&&(u.push({id:"auto-eust",label:"EUSt",percent:l,amount:e.eustAmountEur,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:0,dueDate:P("ETA",0,0,n),category:"eust",isOverridden:!1,dueDateManuallySet:!1}),u.push({id:"auto-eust-refund",label:"EUSt Erstattung",percent:l,amount:-e.eustAmountEur,currency:"EUR",triggerEvent:"ETA",offsetDays:0,offsetMonths:d,dueDate:P("ETA",0,d,n),category:"eust_refund",isOverridden:!1,dueDateManuallySet:!1})),X(u,t.existingPayments)}function Et(t){return Math.round((t||[]).reduce((e,n)=>e+a(n.percent,0),0)*100)/100}function ht(t){const e=R(),n=t.values||{},o=t.schedule,r=t.supplierTerms||[],s=t.existing||null,d=nt({supplierTerms:r,schedule:o,unitPrice:n.unitPrice,units:n.units,currency:n.currency,freight:n.freight,freightCurrency:n.freightCurrency,dutyRatePct:n.dutyRatePct,eustRatePct:n.eustRatePct,fxRate:n.fxRate,incoterm:n.incoterm,vatRefundLagMonths:t.vatRefundLagMonths,existingPayments:s==null?void 0:s.payments});return{...s||{},id:String(n.id||(s==null?void 0:s.id)||T("fo")),sku:String(n.sku||""),supplierId:String(n.supplierId||""),targetDeliveryDate:n.targetDeliveryDate?String(n.targetDeliveryDate):null,units:a(n.units,0),transportMode:String(n.transportMode||"SEA").toUpperCase(),incoterm:String(n.incoterm||"EXW").toUpperCase(),unitPrice:a(n.unitPrice,0),unitPriceIsOverridden:!!n.unitPriceIsOverridden,currency:C(n.currency,"EUR"),freight:a(n.freight,0),freightCurrency:C(n.freightCurrency,"EUR"),dutyRatePct:a(n.dutyRatePct,0),eustRatePct:a(n.eustRatePct,0),fxRate:a(n.fxRate,0),productionLeadTimeDays:a(n.productionLeadTimeDays,0),productionLeadTimeDaysManual:a(n.productionLeadTimeDaysManual,0),productionLeadTimeSource:n.productionLeadTimeSource||null,logisticsLeadTimeDays:a(n.logisticsLeadTimeDays,0),bufferDays:a(n.bufferDays,0),orderDate:o.orderDate,productionEndDate:o.productionEndDate,etdDate:o.etdDate,etaDate:o.etaDate,deliveryDate:o.deliveryDate,payments:d,status:V(n.status,"DRAFT"),convertedPoId:n.convertedPoId||(s==null?void 0:s.convertedPoId)||null,convertedPoNo:n.convertedPoNo||(s==null?void 0:s.convertedPoNo)||null,createdAt:(s==null?void 0:s.createdAt)||e,updatedAt:e}}function St(t){const e=t.fo||{},n=String(t.poNumber||"").trim(),o=a(e.fxRate,0),r=U(e.freight,e.freightCurrency,o),s=a(e.productionLeadTimeDays,0),d=a(e.bufferDays,0),u=a(e.logisticsLeadTimeDays,0),i=s+d,l=Array.isArray(e.payments)?e.payments.filter(D=>String((D==null?void 0:D.category)||"")==="supplier"):[],f=l.length?l:b(),y=t.orderDateOverride||e.orderDate||null,g=E(y)?String(y):null;return{id:T("po"),poNo:n,sku:String(e.sku||""),supplierId:String(e.supplierId||""),units:a(e.units,0),unitCostUsd:a(e.unitPrice,0),unitExtraUsd:0,extraFlatUsd:0,orderDate:g,prodDays:i,transitDays:u,transport:String(e.transportMode||"SEA").toLowerCase(),freightEur:r,dutyRatePct:a(e.dutyRatePct,0),eustRatePct:a(e.eustRatePct,0),fxOverride:o||null,ddp:String(e.incoterm||"").toUpperCase()==="DDP",milestones:f.map(D=>({id:String(D.id||T("ms")),label:String(D.label||"Milestone"),percent:a(D.percent,0),anchor:N(v(D.triggerEvent)),lagDays:h(D.offsetDays,0)})),sourceFoIds:[String(e.id||"")].filter(Boolean),createdAt:R(),updatedAt:R()}}function rt(t){const e=E(t.orderDateOverride);if(e)return m(e);const n=E(t.targetDeliveryDate);if(n){const r=Math.max(0,Math.round(Number(t.maxProdDays||0)+Number(t.maxTransitDays||0)));return m(S(n,-r))}const o=E(t.fallbackOrderDate);return o?m(o):null}function st(t){const e=a(t.productionLeadTimeDays,0),n=a(t.bufferDays,0);return{id:T("poi"),sku:String(t.sku||"").trim(),units:a(t.units,0),unitCostUsd:a(t.unitPrice,0),unitExtraUsd:0,extraFlatUsd:0,prodDays:Math.max(0,Math.round(e+n)),transitDays:Math.max(0,Math.round(a(t.logisticsLeadTimeDays,0))),freightEur:U(t.freight,t.freightCurrency,t.fxRate)}}function pt(t){const e=Array.isArray(t.fos)?t.fos.filter(Boolean):[];if(!e.length)throw new Error("Keine FOs fuer Merge vorhanden.");const n=e[0];if(Array.from(new Set(e.map(c=>String((c==null?void 0:c.supplierId)||"").trim()).filter(Boolean))).length>1)throw new Error("FO-Merge erlaubt nur einen gemeinsamen Lieferanten.");const r=String(t.poNumber||"").trim(),s=e.map(c=>st(c)),d=s.reduce((c,D)=>Math.max(c,Number(D.prodDays||0)),0),u=s.reduce((c,D)=>Math.max(c,Number(D.transitDays||0)),0),i=rt({orderDateOverride:t.orderDateOverride,targetDeliveryDate:t.targetDeliveryDate,maxProdDays:d,maxTransitDays:u,fallbackOrderDate:String(n.orderDate||"")}),l=Array.isArray(n.payments)?n.payments.filter(c=>String((c==null?void 0:c.category)||"")==="supplier"):[],f=l.length?l:b(),y=s.reduce((c,D)=>c+Number(D.units||0),0),g=s.reduce((c,D)=>c+Number(D.freightEur||0),0);return{id:T("po"),poNo:r,supplierId:String(n.supplierId||""),sku:String(n.sku||""),items:s,units:Math.max(0,Math.round(y)),unitCostUsd:a(n.unitPrice,0),unitExtraUsd:0,extraFlatUsd:0,orderDate:i,prodDays:d,transitDays:u,transport:String(n.transportMode||"SEA").toLowerCase(),freightEur:Math.max(0,Math.round(g*100)/100),dutyRatePct:a(n.dutyRatePct,0),eustRatePct:a(n.eustRatePct,0),fxOverride:a(n.fxRate,0)||null,ddp:String(n.incoterm||"").toUpperCase()==="DDP",etaManual:E(t.targetDeliveryDate)?String(t.targetDeliveryDate):null,milestones:f.map(c=>({id:String(c.id||T("ms")),label:String(c.label||"Milestone"),percent:a(c.percent,0),anchor:N(v(c.triggerEvent)),lagDays:h(c.offsetDays,0)})),sourceFoIds:e.map(c=>String(c.id||"")).filter(Boolean),createdAt:R(),updatedAt:R()}}function ot(t){var s,d;const e=((s=t==null?void 0:t.forecast)==null?void 0:s.forecastManual)||{},n=((d=t==null?void 0:t.forecast)==null?void 0:d.forecastImport)||{},o={},r=u=>{const i=String(u||"").trim();if(!i)return;o[i]||(o[i]={});const l=e[i]||{},f=n[i]||{};new Set([...Object.keys(f),...Object.keys(l)]).forEach(g=>{var A;const c=M(l[g]);if(Number.isFinite(c)){o[i][g]=Number(c);return}const D=M((A=f[g])==null?void 0:A.units);Number.isFinite(D)&&(o[i][g]=Number(D))})};return Object.keys(n).forEach(r),Object.keys(e).forEach(r),o}function at(t){var o;const e={};return(((o=t==null?void 0:t.inventory)==null?void 0:o.snapshots)||[]).forEach(r=>{const s=String((r==null?void 0:r.month)||"");if(!s)return;(Array.isArray(r.items)?r.items:[]).forEach(u=>{const i=String((u==null?void 0:u.sku)||"").trim();if(!i)return;e[i]||(e[i]={});const l=M(u==null?void 0:u.amazonUnits),f=M(u==null?void 0:u.threePLUnits),y=M(u==null?void 0:u.units);if(Number.isFinite(l)||Number.isFinite(f)){const c=Number.isFinite(l)?Math.max(0,Number(l)):0,D=Number.isFinite(f)?Math.max(0,Number(f)):0;e[i][s]=c+D;return}e[i][s]=Number.isFinite(y)?Math.max(0,Number(y)):0})}),e}function B(t){const e=(t==null?void 0:t.arrivalDateDe)||(t==null?void 0:t.arrivalDate)||(t==null?void 0:t.etaDate)||(t==null?void 0:t.etaManual)||(t==null?void 0:t.eta);if(e)return E(e);const n=E(t==null?void 0:t.orderDate);if(!n)return null;const o=a((t==null?void 0:t.prodDays)??(t==null?void 0:t.productionLeadTimeDays),0),r=a((t==null?void 0:t.transitDays)??(t==null?void 0:t.logisticsLeadTimeDays),0);return S(n,o+r)}function _(t){if(Array.isArray(t==null?void 0:t.items)&&t.items.length>0)return t.items.map(n=>({sku:String((n==null?void 0:n.sku)||"").trim(),units:a(n==null?void 0:n.units,0)}));const e=String((t==null?void 0:t.sku)||"").trim();return e?[{sku:e,units:a(t==null?void 0:t.units,0)}]:[]}function it(t){const e={};let n=0;return(Array.isArray(t==null?void 0:t.pos)?t.pos:[]).forEach(s=>{if(s!=null&&s.archived)return;const d=B(s);if(!d){n+=1;return}const u=L(d);_(s).forEach(i=>{!i.sku||i.units<=0||(e[i.sku]||(e[i.sku]={}),e[i.sku][u]=(e[i.sku][u]||0)+i.units)})}),(Array.isArray(t==null?void 0:t.fos)?t.fos:[]).forEach(s=>{if(!z(s==null?void 0:s.status))return;const d=B(s);if(!d){n+=1;return}const u=L(d);_(s).forEach(i=>{!i.sku||i.units<=0||(e[i.sku]||(e[i.sku]={}),e[i.sku][u]=(e[i.sku][u]||0)+i.units)})}),{inboundBySku:e,inboundWithoutEtaCount:n}}function Tt(t){var s;const e=W(((s=t==null?void 0:t.inventory)==null?void 0:s.snapshots)||[]),n=ot(t),o=at(t),r=it(t);return{baselineMonth:e,plannedSalesBySku:n,closingStockBySku:o,inboundBySku:r.inboundBySku,inboundWithoutEtaCount:r.inboundWithoutEtaCount}}function Mt(t,e){const n=String(e||"").trim().toLowerCase();return n&&t.find(o=>String((o==null?void 0:o.sku)||"").trim().toLowerCase()===n)||null}function vt(t){var i,l,f,y,g,c,D,A,x,O,F,I;const{context:e}=t;if(!e.baselineMonth)return null;const n=String(t.sku||"").trim();if(!n)return null;const o=p((i=t.product)==null?void 0:i.safetyStockDohOverride)??p((l=t.settings)==null?void 0:l.safetyStockDohDefault)??60,r=p((f=t.product)==null?void 0:f.foCoverageDohOverride)??p((y=t.settings)==null?void 0:y.foCoverageDohDefault)??90,s=p((g=t.product)==null?void 0:g.moqOverrideUnits)??p((c=t.product)==null?void 0:c.moqUnits)??p((D=t.settings)==null?void 0:D.moqDefaultUnits)??0,d=((x=(A=e.closingStockBySku)==null?void 0:A[n])==null?void 0:x[e.baselineMonth])??0,u=j({sku:n,baselineMonth:e.baselineMonth,stock0:d,forecastByMonth:((O=e.plannedSalesBySku)==null?void 0:O[n])||{},inboundByMonth:((F=e.inboundBySku)==null?void 0:F[n])||{},horizonMonths:Number(t.horizonMonths||12)});return q({sku:n,baselineMonth:e.baselineMonth,projection:u,plannedSalesBySku:e.plannedSalesBySku,safetyStockDays:o,coverageDays:r,leadTimeDays:Number(t.leadTimeDays||0),cnyPeriod:(I=t.settings)==null?void 0:I.cny,inboundWithoutEtaCount:e.inboundWithoutEtaCount,moqUnits:s,requiredArrivalMonth:t.requiredArrivalMonth})}export{$ as F,Dt as I,K as P,dt as T,gt as a,Tt as b,vt as c,tt as d,nt as e,U as f,et as g,H as h,ft as i,R as j,ht as k,St as l,Q as m,V as n,pt as o,yt as p,Z as q,Mt as r,Et as s,T as t,lt as u,mt as v};
