function xt(e){return Number.isFinite(e)?e:0}function T(e){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim().replace(/\./g,"").replace(",","."),o=Number(n);return Number.isFinite(o)?o:0}function C(e){if(e===""||e===null||e===void 0)return 0;const n=Number(String(e).replace(",","."));return Number.isFinite(n)?n:0}function Ut(e){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format(xt(Number(e)))}function Tt(e,n){const[o,l]=e.split("-").map(Number),u=new Date(o,l-1+n,1);return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`}function bt(e,n){const o=[];for(let l=0;l<n;l++)o.push(Tt(e,l));return o}function V(e){const n=new Date(e);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function Z(e,n){const o=new Date(e.getTime());return o.setDate(o.getDate()+(n||0)),o}function nt(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?null:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function w(e){if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n}function dt(e){const[n,o]=e.split("-").map(Number);return new Date(n,o,0)}function At(e,n){var b;const o=e==null?void 0:e.cny;if(o!=null&&o.start&&(o!=null&&o.end)){const h=w(o.start),i=w(o.end);if(h&&i&&i>=h)return{start:h,end:i}}const l=(b=e==null?void 0:e.cnyBlackoutByYear)==null?void 0:b[String(n)];if(!l)return null;const u=w(l.start),d=w(l.end);return!u||!d||d<u?null:{start:u,end:d}}function Pt(e,n,o){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return{prodDone:e,adjustmentDays:0};const l=Math.max(0,Number(n||0)),u=Z(e,l);if(!o||l===0)return{prodDone:u,adjustmentDays:0};let d=0;const b=e.getUTCFullYear(),h=u.getUTCFullYear();for(let m=b;m<=h;m+=1){const r=At(o,m);if(!r)continue;const D=r.start>e?r.start:e,P=r.end<u?r.end:u;if(P<D)continue;const R=Math.round((P.getTime()-D.getTime())/(24*60*60*1e3))+1;d+=Math.max(0,R)}return{prodDone:d?Z(u,d):u,adjustmentDays:d}}function ht(e,n){const o=w(e.orderDate)||new Date,l=Number(e.productionLeadTimeDays??e.prodDays??0),u=Number(e.logisticsLeadTimeDays??e.transitDays??0),b=Pt(o,l,n).prodDone??Z(o,l),h=b,i=Z(h,u),m=w(e.etdManual),r=w(e.etaManual);return{ORDER_DATE:o,PROD_DONE:b,PRODUCTION_END:b,ETD:m||h,ETA:r||i}}function $t(e,n){const o=new Date(e.getTime());return o.setMonth(o.getMonth()+n),o}function Ft(e){return new Date(e.getFullYear(),e.getMonth()+1,0)}function K(e){if(!/^\d{4}-\d{2}$/.test(e||""))return null;const[n,o]=e.split("-").map(Number);return n*12+(o-1)}function Rt(e,n){const o=Array.isArray(e==null?void 0:e.items)?e.items:[];let l=0,u=0;if(o.length)o.forEach(m=>{const r=T((m==null?void 0:m.units)??0),D=T((m==null?void 0:m.unitCostUsd)??0),P=T((m==null?void 0:m.unitExtraUsd)??0),R=T((m==null?void 0:m.extraFlatUsd)??0),B=(D+P)*r+R,E=Math.max(0,Math.round(B*100)/100);Number.isFinite(E)&&(l+=E),Number.isFinite(r)&&(u+=r)});else{const m=T((e==null?void 0:e.units)??0),r=T((e==null?void 0:e.unitCostUsd)??0),D=T((e==null?void 0:e.unitExtraUsd)??0),P=T((e==null?void 0:e.extraFlatUsd)??0),R=(r+D)*m+P;l=Math.max(0,Math.round(R*100)/100),Number.isFinite(m)&&(u=m)}const d=T((e==null?void 0:e.fxOverride)??0),b=Number.isFinite(d)&&d>0?d:T((n==null?void 0:n.fxRate)??0)||0,h=b>0?Math.round(l/b*100)/100:0,i=T((e==null?void 0:e.goodsEur)??0);return{usd:l,eur:h>0?h:i,units:u}}function mt(e,n){if(((e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const l=T((e==null?void 0:e.freightPerUnitEur)??0),u=Number((n==null?void 0:n.units)??0)||0,d=l*u;return Math.round(d*100)/100}return T((e==null?void 0:e.freightEur)??0)}function Ot(e,n,o){const l=new Date(e,n+1,0).getDate(),u=Math.min(Math.max(1,o),l);return new Date(e,n,u)}function yt(e,n){const o=K(e);if(o==null)return null;const l=Math.floor(o/12),u=o%12;if(!n||n==="LAST"||n==="Letzter Tag"||n==="EOM")return new Date(l,u+1,0);const d=Number(n);return Number.isFinite(d)?Ot(l,u,d):new Date(l,u+1,0)}function vt(e,n,o,l){if(!n||!n.proration||n.proration.enabled!==!0)return{amount:e,applied:!1};if(n.proration.method!=="daily")return{amount:e,applied:!1};const u=K(o);if(u==null)return{amount:e,applied:!1};const d=Math.floor(u/12),b=u%12,h=new Date(d,b+1,0).getDate(),i=l instanceof Date&&!Number.isNaN(l.getTime())?l:yt(o,n.anchor),m=i instanceof Date?i.getDate():h;let r=1;n.startMonth&&n.startMonth===o&&(r*=Math.max(0,h-m+1)/h),n.endMonth&&n.endMonth===o&&(r*=Math.max(0,m)/h);const D=Math.round(e*r*100)/100;return!Number.isFinite(D)||D===e?{amount:e,applied:!1}:{amount:D,applied:!0}}function Dt({statusRecord:e,autoEligible:n,autoManualCheck:o,entryTime:l,todayTime:u,defaultPaid:d}){const b=typeof(e==null?void 0:e.manual)=="boolean"?e.manual:void 0;let h=!1,i=!1;typeof b=="boolean"?h=b:n&&!o&&l!=null&&l<=u?(h=!0,i=!0):h=!!d;const m=n&&o&&!i;let r=null;return n&&(i?r="Automatisch bezahlt am Fälligkeitstag":o?r="Automatische Zahlung – manuelle Prüfung aktiv":r="Automatische Zahlung"),{paid:h,autoApplied:i,manualOverride:typeof b=="boolean",autoSuppressed:m,autoTooltip:r}}function It(e,n={}){const o=e||{},l=n.startMonth||o.settings&&o.settings.startMonth||"2025-01",u=Number(n.horizon||o.settings&&o.settings.horizonMonths||12),d=Array.isArray(n.months)&&n.months.length?n.months:bt(l,u),b=Array.isArray(o.fixcosts)?o.fixcosts:[],h=o.fixcostOverrides&&typeof o.fixcostOverrides=="object"?o.fixcostOverrides:{},i=n.status&&typeof n.status=="object"?n.status:o.status||{},m=n.statusEvents&&typeof n.statusEvents=="object"?n.statusEvents:i.events||{},r=n.autoManualCheck!=null?n.autoManualCheck===!0:i.autoManualCheck===!0,D=n.today?new Date(n.today):new Date;D.setHours(0,0,0,0);const P=D.getTime(),R=[],B=new Set(d);return b.forEach((E,_)=>{if(!E)return;const k=E.id||`fix-${_}`,X=E.startMonth||l,q=K(X);if(q==null)return;const j=E.endMonth||null,H=j?K(j):null,c=(E.frequency||"monthly").toLowerCase();let g=1;c==="quarterly"?g=3:c==="semiannual"||c==="halbjährlich"?g=6:c==="annual"||c==="jährlich"||c==="yearly"?g=12:(c==="custom"||c==="benutzerdefiniert")&&(g=Number(E.intervalMonths||E.everyMonths||1)||1),g<1&&(g=1);const $=E.anchor,N=!$||$==="Letzter Tag"?"LAST":String($),M=h[k]&&typeof h[k]=="object"?h[k]:{},A=E.name||"Fixkosten",F=E.category||"Sonstiges",O=Math.abs(T(E.amount)),G=E.notes||"",W=E.autoPaid===!0;d.forEach(v=>{if(!B.has(v))return;const I=K(v);if(I==null||I<q||H!=null&&I>H||(I-q)%g!==0)return;const at=yt(v,N),L=M[v]&&typeof M[v]=="object"?M[v]:{};let z=at;if(L.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(L.dueDate)){const Y=new Date(L.dueDate);Number.isNaN(Y.getTime())||(z=Y)}let tt=O,J=!1;L.amount!=null&&String(L.amount).trim()!==""&&(tt=Math.abs(T(L.amount)),J=!0);let et=!1;if(!J){const Y=vt(O,E,v,z);tt=Y.amount,et=Y.applied}const ot=`fix-${k}-${v}`,t=z instanceof Date&&!Number.isNaN(z.getTime())?z.getTime():null,a=m[ot],s=Dt({statusRecord:a,autoEligible:W,autoManualCheck:r,entryTime:t,todayTime:P,defaultPaid:!1}),f=z instanceof Date&&!Number.isNaN(z.getTime())?nt(z):null,y=L.note||"",x=[A];J&&x.push("Override aktiv"),et&&x.push("Proratiert");const S=x.length>1?x.join(" · "):null;R.push({id:ot,month:v,amount:tt,baseAmount:O,label:A,category:F,dueDate:z,dueDateIso:f,fixedCostId:k,autoPaid:W,notes:G,override:{amount:L.amount||"",dueDate:L.dueDate||"",note:y},overrideActive:J||!!L.dueDate||!!y,prorationApplied:et,paid:s.paid,autoApplied:s.autoApplied,manualOverride:s.manualOverride,autoTooltip:s.autoTooltip,autoSuppressed:s.autoSuppressed,anchor:N,frequency:c,tooltip:S})})}),R.sort((E,_)=>{if(E.month===_.month){const k=E.dueDate instanceof Date?E.dueDate.getTime():0,X=_.dueDate instanceof Date?_.dueDate.getTime():0;return k-X}return K(E.month)-K(_.month)}),R}function kt(e){const n=e||{};return{dutyRatePct:C(n.dutyRatePct??0),dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:C(n.eustRatePct??0),vatRefundLagMonths:Number(n.vatRefundLagMonths??0)||0,vatRefundEnabled:n.vatRefundEnabled!==!1,freightLagDays:Number(n.freightLagDays??0)||0,fxFeePct:C(n.fxFeePct??0)}}function St(e,n,o){const l=["freight","duty","eust","vat_refund","fx_fee"],u=Array.isArray(e.autoEvents)?e.autoEvents.filter(Boolean).map(i=>({...i})):[],d=new Map;for(const i of u)!i||!i.type||(i.id||(i.id=`auto-${i.type}`),d.set(i.type,i));const b=(o||[])[0]||null;function h(i,m){if(!d.has(i)){const D={id:`auto-${i}`,type:i,...m};return u.push(D),d.set(i,D),D}const r=d.get(i);r.id||(r.id=`auto-${i}`);for(const[D,P]of Object.entries(m))r[D]===void 0&&(r[D]=P);return r}if(h("freight",{label:"Fracht",anchor:"ETA",lagDays:n.freightLagDays,enabled:!0}),h("duty",{label:"Zoll",percent:n.dutyRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("eust",{label:"EUSt",percent:n.eustRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:n.vatRefundLagMonths,enabled:n.vatRefundEnabled}),h("fx_fee",{label:"FX-Gebühr",percent:n.fxFeePct,anchor:b&&b.anchor||"ORDER_DATE",lagDays:b&&Number(b.lagDays||0)||0}),u.sort((i,m)=>l.indexOf(i.type)-l.indexOf(m.type)),e.ddp)for(const i of u)(i.type==="freight"||i.type==="duty"||i.type==="eust"||i.type==="vat_refund")&&(i.enabled=!1);return u}function gt(e,n,o,l){var H;if(!e)return[];const u=o||"PO",d=e[l],b=d?`${u} ${d}`:u;if(Array.isArray(e.payments)&&e.payments.length){const c=ht(e,n);return e.payments.filter(Boolean).map((g,$)=>{const N=g.triggerEvent||"ORDER_DATE",M=N==="PROD_DONE"?"PROD_DONE":N,A=c[M]||c.ORDER_DATE,F=g.dueDate?new Date(g.dueDate):Z(A,Number(g.offsetDays||0)),O=Number(g.amount||0),G=O>=0?"out":"in",W=Math.abs(O);return{label:`${b}${g.label?` – ${g.label}`:""}`,amount:W,due:F,month:V(F),direction:G,type:"manual",anchor:M,lagDays:Number(g.offsetDays||0)||0,percent:Number(g.percent||0),sourceType:u,sourceNumber:d,sourceId:e.id,id:g.id||`${e.id||u}-pay-${$}`,tooltip:`Fälligkeit: ${M} + ${Number(g.offsetDays||0)} Tage`}})}const h=Rt(e,n),i=h.eur,m=mt(e,h),r=ht(e,n),D=Array.isArray(e.milestones)?e.milestones:[],P=St(e,n,D),R=[];for(const[c,g]of D.entries()){const $=C(g.percent),N=r[g.anchor||"ORDER_DATE"]||r.ORDER_DATE,M=Z(N,Number(g.lagDays||0)),A=g.id||`${e.id||u}-${c}-${g.id||"manual"}`;R.push({label:`${b}${g.label?` – ${g.label}`:""}`,amount:i*($/100),due:M,month:V(M),direction:"out",type:"manual",anchor:g.anchor||"ORDER_DATE",lagDays:Number(g.lagDays||0)||0,percent:$,sourceType:u,sourceNumber:d,sourceId:e.id,id:A,tooltip:`Fälligkeit: ${g.anchor||"ORDER_DATE"} + ${Number(g.lagDays||0)} Tage`})}const B=e.dutyIncludeFreight!==!1,E=C(e.dutyRatePct??n.dutyRatePct??0),_=C(e.eustRatePct??n.eustRatePct??0),k=C(e.fxFeePct??n.fxFeePct??0),X=Number(e.vatRefundLagMonths??n.vatRefundLagMonths??0),q=e.vatRefundEnabled!==!1,j={};for(const c of P){if(!c||c.enabled===!1)continue;const g=c.anchor||"ETA",$=r[g]||r.ETA;if(!(!($ instanceof Date)||Number.isNaN($.getTime()))){if(c.type==="freight"){const N=mt(e,h);if(!N)continue;const M=c.id||`${e.id||u}-auto-freight`,A=Z($,Number(c.lagDays||0));R.push({label:`${b} – ${c.label||"Fracht"}`,amount:N,due:A,month:V(A),direction:"out",type:"freight",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,sourceType:u,sourceNumber:d,sourceId:e.id,id:M,tooltip:"Frachtkosten laut Eingabe"});continue}if(c.type==="duty"){const N=C(c.percent??E),M=Z($,Number(c.lagDays||0)),F=(i+(B?m:0))*(N/100),O=c.id||`${e.id||u}-auto-duty`;j.duty={amount:F,due:M},R.push({label:`${b} – ${c.label||"Zoll"}`,amount:F,due:M,month:V(M),direction:"out",type:"duty",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:d,sourceId:e.id,id:O,tooltip:`Zoll = ${N}% × (Warenwert${B?" + Fracht":""})`});continue}if(c.type==="eust"){const N=C(c.percent??_),M=Math.abs(((H=j.duty)==null?void 0:H.amount)||0),A=i+m+M,F=Z($,Number(c.lagDays||0)),O=A*(N/100),G=c.id||`${e.id||u}-auto-eust`;j.eust={amount:O,due:F},R.push({label:`${b} – ${c.label||"EUSt"}`,amount:O,due:F,month:V(F),direction:"out",type:"eust",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:d,sourceId:e.id,id:G,tooltip:`EUSt = ${N}% × (Warenwert + Fracht + Zoll)`});continue}if(c.type==="vat_refund"){const N=j.eust;if(!q||!N||N.amount===0)continue;const M=C(c.percent??100),A=Number((c.lagMonths??X)||0),F=Z(N.due||$,Number(c.lagDays||0)),O=Ft($t(F,A)),G=Math.abs(N.amount)*(M/100),W=c.id||`${e.id||u}-auto-vat`;R.push({label:`${b} – ${c.label||"EUSt-Erstattung"}`,amount:G,due:O,month:V(O),direction:"in",type:"vat_refund",anchor:c.anchor||"ETA",lagMonths:A,percent:M,sourceType:u,sourceNumber:d,sourceId:e.id,id:W,tooltip:`Erstattung am Monatsende nach ${A} Monaten`});continue}if(c.type==="fx_fee"){const N=C(c.percent??k);if(!N)continue;const M=Z($,Number(c.lagDays||0)),A=i*(N/100),F=c.id||`${e.id||u}-auto-fx`;R.push({label:`${b} – ${c.label||"FX-Gebühr"}`,amount:A,due:M,month:V(M),direction:"out",type:"fx_fee",anchor:c.anchor||"ORDER_DATE",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:d,sourceId:e.id,id:F,tooltip:`FX-Gebühr = ${N}% × Warenwert`})}}}return R}function Ct(e){var tt,J,et,ot;const n=e||{},o=n.settings&&n.settings.startMonth||"2025-01",l=Number(n.settings&&n.settings.horizonMonths||12),u=bt(o,l),d=n.status&&typeof n.status=="object"?n.status:{},b=d.events&&typeof d.events=="object"?d.events:{},h=d.autoManualCheck===!0,i=new Date;i.setHours(0,0,0,0);const m=i.getTime(),r={};u.forEach(t=>{r[t]={entries:[]}});function D(t,a){r[t]&&r[t].entries.push(a)}function P(t,a={}){const s=t.id||`${t.month||""}-${t.label||""}-${t.date||""}`,f=b[s],y=t.date?new Date(t.date):null,x=y&&Number.isFinite(y.getTime())?new Date(y.getFullYear(),y.getMonth(),y.getDate()).getTime():null,S=a.auto===!0,Y=S&&a.autoEligible!==!1,st=typeof t.paid=="boolean"?t.paid:!!a.defaultPaid,Q=Dt({statusRecord:f,autoEligible:Y,autoManualCheck:h,entryTime:x,todayTime:m,defaultPaid:st});return{id:s,direction:t.direction||"in",amount:Math.abs(t.amount||0),label:t.label||"",month:t.month,date:t.date,kind:t.kind,group:t.group,paid:Q.paid,source:t.source||null,anchor:t.anchor,lagDays:t.lagDays,lagMonths:t.lagMonths,percent:t.percent,scenarioDelta:t.scenarioDelta||0,scenarioAmount:t.scenarioAmount||t.amount||0,meta:t.meta||{},tooltip:t.tooltip,sourceTab:t.sourceTab,sourceNumber:t.sourceNumber,statusId:s,auto:S,autoEligible:Y,autoApplied:Q.autoApplied,autoManualCheck:h,manualOverride:Q.manualOverride,autoSuppressed:Q.autoSuppressed,autoTooltip:Q.autoTooltip}}It(n,{months:u,statusEvents:b,autoManualCheck:h,today:i}).map(t=>({id:t.id,direction:"out",amount:t.amount,label:t.label,month:t.month,date:t.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:t.fixedCostId,category:t.category,override:t.overrideActive,overrideAmount:t.override.amount,overrideDueDate:t.override.dueDate,overrideNote:t.override.note,notes:t.notes,baseAmount:t.baseAmount,prorationApplied:t.prorationApplied},tooltip:t.tooltip,auto:t.autoPaid,autoEligible:t.autoPaid})).forEach(t=>{D(t.month,P(t,{auto:t.auto,autoEligible:t.autoEligible}))});const B=!!((J=(tt=n==null?void 0:n.forecast)==null?void 0:tt.settings)!=null&&J.useForecast),E={};B&&((et=n==null?void 0:n.forecast)!=null&&et.forecastImport&&typeof n.forecast.forecastImport=="object"?Object.values(n.forecast.forecastImport).forEach(t=>{Object.entries(t||{}).forEach(([a,s])=>{if(!a||!r[a])return;const f=T((s==null?void 0:s.revenueEur)??(s==null?void 0:s.revenue)??null);Number.isFinite(f)&&(E[a]=(E[a]||0)+f)})}):Array.isArray((ot=n==null?void 0:n.forecast)==null?void 0:ot.items)&&n.forecast.items.forEach(t=>{if(!t||!t.month||!t.sku)return;const a=t.month;if(!r[a])return;const s=Number(t.qty??t.quantity??0)||0,f=T(t.priceEur??t.price??0),y=s*f;E[a]=(E[a]||0)+y}));const _={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(_[t.month]=t.payoutPct)});const k={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(k[t.month]=T(t.revenueEur))}),Object.keys(r).forEach(t=>{const a=B?E[t]||0:k[t];if(typeof a>"u")return;const s=C(_[t]||0),f=a*(s/100),y=dt(t);D(t,P({id:`sales-${t}`,direction:f>=0?"in":"out",amount:Math.abs(f),label:B?"Amazon Payout (Prognose)":"Amazon Payout",month:t,date:nt(y),kind:"sales-payout",group:f>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#eingaben"},{auto:!1}))}),(Array.isArray(n.extras)?n.extras:[]).forEach(t=>{const a=t.month||(t.date?V(t.date):null);if(!a||!r[a])return;const s=T(t.amountEur),f=s>=0?"in":"out",y=a,x=t.date?new Date(t.date):dt(y);D(y,P({id:`extra-${t.id||t.label||y}-${t.date||""}`,direction:f,amount:Math.abs(s),label:t.label||"Extra",month:y,date:nt(x),kind:"extra",group:f==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:t.autoPaid===!0,autoEligible:t.autoPaid===!0}))}),(Array.isArray(n.dividends)?n.dividends:[]).forEach(t=>{const a=t.month||(t.date?V(t.date):null);if(!a||!r[a])return;const s=T(t.amountEur),f=t.date?new Date(t.date):dt(a);D(a,P({id:`div-${t.id||t.label||a}`,direction:s>=0?"out":"in",amount:Math.abs(s),label:t.label||"Dividende",month:a,date:nt(f),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))});const X=kt(n.settings);(Array.isArray(n.pos)?n.pos:[]).forEach(t=>{gt(t,X,"PO","poNo").forEach(a=>{const s=a.month;if(!r[s])return;const f=a.type==="manual"?"po":a.type==="vat_refund"?"po-refund":"po-import",y=f==="po"?"PO/FO-Zahlungen":"Importkosten";D(s,P({id:a.id||`po-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:s,date:nt(a.due),kind:f,group:y,source:"po",sourceTab:"#po",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.poNo,tooltip:a.tooltip},{auto:a.type!=="manual",autoEligible:a.type!=="manual"}))})}),(Array.isArray(n.fos)?n.fos:[]).forEach(t=>{String((t==null?void 0:t.status)||"").toUpperCase()!=="CONVERTED"&&gt(t,X,"FO","foNo").forEach(a=>{const s=a.month;if(!r[s])return;const f=a.type==="manual"?"fo":a.type==="vat_refund"?"fo-refund":"fo-import",y=f==="fo"?"PO/FO-Zahlungen":"Importkosten";D(s,P({id:a.id||`fo-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:s,date:nt(a.due),kind:f,group:y,source:"fo",sourceTab:"#fo",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.foNo,tooltip:a.tooltip},{auto:a.type!=="manual",autoEligible:a.type!=="manual"}))})});const q=u.map(t=>{const s=r[t].entries||[],f=s.filter(p=>p.direction==="in"),y=s.filter(p=>p.direction==="out"),x=y.filter(p=>p.group==="Fixkosten"),S=x.reduce((p,U)=>p+(U.amount||0),0),Y=x.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),st=Math.max(0,S-Y),Q=x.slice().sort((p,U)=>(U.amount||0)-(p.amount||0)).slice(0,3).map(p=>({label:p.label,amount:p.amount,paid:p.paid,category:p.meta&&p.meta.category?p.meta.category:null})),ct=f.reduce((p,U)=>p+(U.amount||0),0),it=y.reduce((p,U)=>p+(U.amount||0),0),rt=f.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),lt=y.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),Et=Math.max(0,ct-rt),Nt=Math.max(0,it-lt),ft=ct-it,pt=rt-lt,Mt=ft-pt;return{month:t,inflow:{total:ct,paid:rt,open:Et},outflow:{total:it,paid:lt,open:Nt},net:{total:ft,paid:pt,open:Mt},fixcost:{total:S,paid:Y,open:st,top:Q},itemsIn:f.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),itemsOut:y.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),entries:s}}),j=T(n.settings&&n.settings.openingBalance),H=u.find(t=>{const a=u.indexOf(t);let s=j;for(let f=0;f<=a;f++)s+=q[f].net.total;return s<0})||null,c=q.map(t=>t.itemsIn.filter(a=>a.kind==="sales-payout").reduce((a,s)=>a+s.amount,0)),g=c.length?c.reduce((t,a)=>t+a,0)/(c.filter(t=>t>0).length||1):0,$={},N={};Object.keys(r).forEach(t=>{const a=B?E[t]||0:k[t],s=C(_[t]||0);$[t]=a,N[t]=a*(s/100)});const M={opening:j,openingToday:j,salesPayoutAvg:g,avgSalesPayout:g,firstNegativeMonth:H,actuals:{}};let A=j;const F=u.map((t,a)=>{const s=q[a],f=A;return A+=s.net.total,{month:t,opening:f,closing:A,inflow:s.inflow.total,outflow:s.outflow.total,net:s.net.total,entries:s.entries}}),O=new Map,G=n!=null&&n.monthlyActuals&&typeof n.monthlyActuals=="object"?n.monthlyActuals:{},W=Object.entries(G);W.length?W.forEach(([t,a])=>{if(!t)return;const s=Number(a==null?void 0:a.realRevenueEUR),f=Number(a==null?void 0:a.realPayoutRatePct),y=Number(a==null?void 0:a.realClosingBalanceEUR),x={};Number.isFinite(s)&&(x.revenue=s),Number.isFinite(s)&&Number.isFinite(f)&&(x.payout=s*(f/100)),Number.isFinite(y)&&(x.closing=y),Object.keys(x).length&&O.set(t,x)}):(Array.isArray(n.actuals)?n.actuals:[]).forEach(a=>{if(!a||!a.month)return;const s=a.month;O.set(s,{revenue:T(a.revenueEur),payout:T(a.payoutEur),closing:T(a.closingBalanceEur)})});const v=[];O.forEach((t,a)=>{const s=u.indexOf(a);if(s===-1)return;const f=s>=0&&s<F.length?F[s]:null,y=f?f.closing:null,x=$[a]??null,S=N[a]??null;v.push({month:a,plannedRevenue:x,actualRevenue:t.revenue,revenueDelta:(t.revenue??0)-(x??0),revenueDeltaPct:x?((t.revenue??0)-x)/x*100:null,plannedPayout:S,actualPayout:t.payout,payoutDelta:(t.payout??0)-(S??0),payoutDeltaPct:S?((t.payout??0)-S)/S*100:null,plannedClosing:y,actualClosing:t.closing,closingDelta:(t.closing??0)-(y??0)})}),v.sort((t,a)=>(t.month||"").localeCompare(a.month||""));const I=v[v.length-1]||null,ut=v.map(t=>t.revenueDeltaPct).filter(t=>Number.isFinite(t)),at=v.map(t=>t.payoutDeltaPct).filter(t=>Number.isFinite(t)),L=ut.length?ut.reduce((t,a)=>t+a,0)/ut.length:null,z=at.length?at.reduce((t,a)=>t+a,0)/at.length:null;return M.actuals={count:v.length,lastMonth:I?I.month:null,lastClosing:I?I.actualClosing:null,closingDelta:I?I.closingDelta:null,revenueDeltaPct:I?I.revenueDeltaPct:null,payoutDeltaPct:I?I.payoutDeltaPct:null,avgRevenueDeltaPct:L,avgPayoutDeltaPct:z},{startMonth:o,horizon:l,months:u,series:q,kpis:M,breakdown:F,actualComparisons:v}}export{Ct as c,It as e,Ut as f,T as p};
