import{p as at,a4 as Kt,a5 as wt,t as c,a2 as o,a6 as Bt,a7 as zt,k as t,L as g,J as qt,S as ye,O as le,K as B,M as W,a3 as Ke,P as we}from"./index-DrOkdIyL.js";import{T as Vt}from"./TanStackGrid-DNQbnxKh.js";import{D as S}from"./DeNumberInput-DYC0ZMi2.js";import{E as Wt}from"./index-rKZEcphe.js";import{b as $t,s as Gt}from"./categoryOrder-C77cYWrY.js";import{d as _t}from"./shipping-9Dzo5wwm.js";import{r as Ht,e as lt,s as J}from"./productCompletenessV2-wFpo7RYV.js";import{n as Qt,f as Ze}from"./months-DiLwPhVv.js";import{a as Zt}from"./tableModels-D8x4D7lf.js";import{e as Jt,f as Xt}from"./planProducts-CpwZ2WgY.js";import{u as Yt,C as ot}from"./workspace-hSJpURcw.js";import{h as es,g as ts,s as ss}from"./uiPrefs-CxTlE9qM.js";import{u as rs}from"./modalCollaboration-CW7FC8LJ.js";import{S as X}from"./index-Bs0NWQOM.js";import{S as ct}from"./index-D76sItGD.js";import{C as dt}from"./Collapse-BrChyUuB.js";import{C as re}from"./index-CwWsayj4.js";import{F as ns}from"./Table-DZmxMdD5.js";import{s as Be}from"./index-f0YJWE_y.js";import"./index-D1FgTqkK.js";import"./costing-CmZrILJ2.js";import"./Dropdown-QmF6_rIx.js";import"./useBubbleLock-BNNYgWjU.js";import"./index-D-YTDARI.js";import"./Pagination-DA_hDQym.js";function ht(s){return s==="order_override"?"Diese PO/FO":s==="product"?"Produkt":s==="supplier"?"Lieferant":s==="settings"?"Settings":s==="computed"?"Berechnet":"Fehlt"}function ze(s){if(s==null||s==="")return null;const i=Number(s);return Number.isFinite(i)?i:null}function is(s){const i=s.template&&typeof s.template=="object"?s.template:{};return(i.fields&&typeof i.fields=="object"?i.fields:i)||{}}function $(s,i){return{value:s.value,source:s.source,sourceLabel:ht(s.source),hint:i,required:s.required}}function oe(s,i,d,p=!1){return{value:s,source:i,sourceLabel:ht(i),hint:d,required:p}}function qe(s){const i=Number(s);return Number.isFinite(i)&&i>0?i:null}function as(s){const i=s.product||{},d=s.state||{},p=d.settings||{},h=is(i),f=Ht({state:d,product:i,sku:String(i.sku||""),supplierId:s.supplierId||String(i.supplierId||""),orderContext:"product"}),M=$(f.fields.moqUnits,"MOQ für Einkaufsplanung."),P=qe(i.safetyStockDohOverride),Y=qe(p.safetyStockDohDefault),y=P!=null?oe(P,"product","Produktspezifischer Safety-Wert."):oe(Y,Y!=null?"settings":"missing","Default aus Settings (Safety Stock DOH)."),k=qe(i.foCoverageDohOverride),z=qe(p.foCoverageDohDefault),ne=k!=null?oe(k,"product","Produktspezifischer Coverage-Wert."):oe(z,z!=null?"settings":"missing","Default aus Settings (FO Coverage DOH)."),Ne=String(h.transportMode||h.transport||"SEA").toUpperCase()||"SEA",ve=h.transportMode||h.transport?"product":"settings",be=f.fields.logisticsPerUnitEur.value!=null?$(f.fields.logisticsPerUnitEur,"Logistik-/Importanteil je Einheit in EUR."):oe(null,"missing","Logistik-/Importanteil je Einheit in EUR."),N=_t({unitCostUsd:f.fields.unitPriceUsd.value,landedUnitCostEur:ze(i.landedUnitCostEur),fxEurUsd:f.fields.fxRate.value}),ie=be.value!=null?be:oe(ze(N.value),Number.isFinite(Number(N.value))?"computed":"missing","Logistik-/Importanteil je Einheit in EUR.");return{moqEffective:M,safetyDohEffective:y,coverageDohEffective:ne,productionLeadDays:$(f.fields.productionLeadTimeDays,"Produktionszeit für Planung/Bestellung."),unitPriceUsd:$(f.fields.unitPriceUsd,"Stückpreis in USD für Kostenkalkulation."),fxRate:$(f.fields.fxRate,"FX in USD je EUR für Umrechnung."),logisticsPerUnitEur:ie,transportMode:oe(Ne,ve,"Transportmodus für ETA/Lead-Time."),transitDays:$(f.fields.transitDays,"Transitzeit in Tagen für Planung."),currency:$(f.fields.currency,"Währung für Kostenwerte."),dutyPct:$(f.fields.dutyRatePct,"Zollsatz in Prozent."),eustPct:$(f.fields.eustRatePct,"EUSt-Satz in Prozent."),ddp:$(f.fields.ddp,"DDP = Importkosten in Lieferpreis enthalten."),shippingSuggestion:{value:ze(N.value),goodsCostEur:ze(N.goodsCostEur),warning:N.warning===!0}}}const ls=["Jan","Feb","Maerz","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];function os(s,i){if(!i)return null;const d=s==null?void 0:s[i];if(d&&typeof d=="object")return d;const p=i.toLowerCase(),h=Object.keys(s||{}).find(M=>M.toLowerCase()===p);if(!h)return null;const f=s==null?void 0:s[h];return f&&typeof f=="object"?f:null}function cs(s){return Object.entries(s||{}).map(([i,d])=>{const p=Qt(i);if(!p)return null;const h=Number(p.slice(5,7));if(!Number.isFinite(h)||h<1||h>12)return null;const f=d&&typeof d=="object"?at(d.units):at(d);return Number.isFinite(f)?{month:p,monthNumber:h,units:Number(f)}:null}).filter(i=>!!i).sort((i,d)=>i.month.localeCompare(d.month))}function ds(s){return Number.isFinite(s)?Number(s)<.9?"unterdurchschnittlich":Number(s)>1.1?"ueberdurchschnittlich":"durchschnittlich":"keine_daten"}function us(s){const i=String(s.sku||"").trim();if(!i)return null;const d=os(s.forecastImport||{},i);if(!d)return null;const p=cs(d);if(!p.length)return null;const h=Array.from({length:12},()=>[]);p.forEach(y=>{h[y.monthNumber-1].push(y.units)});const f=h.map(y=>y.length?y.reduce((z,ne)=>z+ne,0)/y.length:null),M=f.filter(y=>Number.isFinite(y)),P=M.length?M.reduce((y,k)=>y+k,0)/M.length:null,Y=f.map((y,k)=>{const z=Number.isFinite(y)&&Number.isFinite(P)&&Number(P)>0?Number(y)/Number(P):null;return{monthNumber:k+1,monthLabel:ls[k],averageUnits:Number.isFinite(y)?Number(y):null,factor:Number.isFinite(z)?Number(z):null,sampleCount:h[k].length,classification:ds(z)}});return{sku:i,startMonth:p[0].month,endMonth:p[p.length-1].month,sampleMonthCount:p.length,coveredMonthTypes:Y.filter(y=>y.sampleCount>0).length,overallAverage:P,months:Y}}const{Paragraph:Je,Text:Ee,Title:ce}=qt,ms=[{value:"active",label:"Aktiv"},{value:"prelaunch",label:"Noch nicht gelauncht"},{value:"inactive",label:"Inaktiv"}],ps=["AIR","RAIL","SEA"],hs=["EUR","USD","CNY"],ut={unitPriceUsd:["templateUnitPriceUsd"],avgSellingPriceGrossEUR:["avgSellingPriceGrossEUR"],sellerboardMarginPct:["sellerboardMarginPct"],moqUnits:["moqUnits"],productionLeadTimeDaysDefault:["productionLeadTimeDaysDefault"],incoterm_ddp:["templateDdp"],hsCode:["hsCode"],goodsDescription:["goodsDescription"],landedUnitCostEur:["landedUnitCostEur"]},mt=new Set(["moqUnits","templateDdp"]),gs={sku:"SKU",alias:"Alias",hsCode:"HS-Code",goodsDescription:"Warenbeschreibung",supplierId:"Supplier",categoryId:"Kategorie",status:"Status",avgSellingPriceGrossEUR:"Verkaufspreis (EUR)",sellerboardMarginPct:"Marge %",moqUnits:"MOQ Units",landedUnitCostEur:"Einstand (EUR)",logisticsPerUnitEur:"Shipping (EUR/Stk)",productionLeadTimeDaysDefault:"Production Lead Time",templateUnitPriceUsd:"EK (USD)",templateTransitDays:"Transit-Tage",templateDdp:"Incoterm / DDP"},Xe={scope:"filtered",selectedSkus:[],applyTemplateUnitPriceUsd:!1,templateUnitPriceUsd:null,applyAvgSellingPriceGrossEUR:!1,avgSellingPriceGrossEUR:null,applySellerboardMarginPct:!1,sellerboardMarginPct:null,applyMoqUnits:!1,moqUnits:null,applyProductionLeadTimeDaysDefault:!1,productionLeadTimeDaysDefault:null,applyTemplateTransitDays:!1,templateTransitDays:null,applyTemplateDdp:!1,templateDdp:!0};function Ye(){return new Date().toISOString()}function fs(s){return`${s}-${Math.random().toString(36).slice(2,9)}`}function u(s){if(s==null||s==="")return null;const i=Number(s);return Number.isFinite(i)?i:null}function xs(s){const i=[u(s.formFx),u(s.settingsFx),u(s.resolvedFx)];for(let p=0;p<i.length;p+=1){const h=i[p];if(h!=null&&h>0&&h<10)return h}const d=u(s.settingsEurUsd);if(d!=null&&d>0&&d<10){const p=1/d;if(Number.isFinite(p)&&p>0)return p}for(let p=0;p<i.length;p+=1){const h=i[p];if(h!=null&&h>0)return h}return null}function E(s,i=2){return Number.isFinite(s)?Number(s).toLocaleString("de-DE",{minimumFractionDigits:i,maximumFractionDigits:i}):"—"}function ys(s,i){const d=(i==null?void 0:i.kind)||"number";return d==="boolean"?s.value===!0?"Ja":"Nein":d==="text"?String(s.value||"—"):E(typeof s.value=="number"?s.value:null,(i==null?void 0:i.digits)??2)}function vs(s){return s==="ok"?t.jsx(g,{color:"green",children:"OK"}):s==="warn"?t.jsx(g,{color:"orange",children:"WARN"}):t.jsx(g,{color:"red",children:"BLOCKED"})}function bs(s){const i=String(s||"").trim().toLowerCase();return i==="all"||i==="active"||i==="prelaunch"||i==="inactive"?i:null}function Ss(s){const i=String(s||"").trim().toLowerCase();return i==="needs_fix"?"needs_fix":i==="revenue"?"revenue":i==="blocked"?"blocked":"all"}function pt(s){const i=Number(s.avgSellingPriceGrossEUR);return!Number.isFinite(i)||i<=0||s.completeness==="blocked"}function et(s){const i=(s==null?void 0:s.raw.template)||{},d=i.fields&&typeof i.fields=="object"?i.fields:i;return{id:s==null?void 0:s.id,sku:(s==null?void 0:s.sku)||"",alias:(s==null?void 0:s.alias)||"",hsCode:String((s==null?void 0:s.raw.hsCode)||""),goodsDescription:String((s==null?void 0:s.raw.goodsDescription)||""),supplierId:(s==null?void 0:s.supplierId)||"",categoryId:(s==null?void 0:s.categoryId)||null,status:(s==null?void 0:s.status)||"active",avgSellingPriceGrossEUR:(s==null?void 0:s.avgSellingPriceGrossEUR)??null,sellerboardMarginPct:(s==null?void 0:s.sellerboardMarginPct)??null,moqUnits:(s==null?void 0:s.moqUnits)??null,safetyStockDohOverride:u(s==null?void 0:s.raw.safetyStockDohOverride),foCoverageDohOverride:u(s==null?void 0:s.raw.foCoverageDohOverride),moqOverrideUnits:u(s==null?void 0:s.raw.moqOverrideUnits),landedUnitCostEur:u(s==null?void 0:s.raw.landedUnitCostEur),logisticsPerUnitEur:u((s==null?void 0:s.raw.logisticsPerUnitEur)??(s==null?void 0:s.raw.freightPerUnitEur)),productionLeadTimeDaysDefault:u(s==null?void 0:s.raw.productionLeadTimeDaysDefault),templateUnitPriceUsd:u(d.unitPriceUsd),templateTransportMode:String(d.transportMode||"SEA"),templateProductionDays:u(d.productionDays),templateTransitDays:u(d.transitDays),templateFreightEur:u(d.freightEur),templateDutyPct:u(d.dutyPct),templateVatImportPct:u(d.vatImportPct),templateFxRate:u(d.fxRate),templateCurrency:String(d.currency||"USD"),templateDdp:d.ddp===!0}}function _s(){const s=Kt(),{state:i,loading:d,saving:p,error:h,lastSavedAt:f,saveWith:M}=Yt(),P=wt(),Y=es("products"),y=c.useRef(!1),[k,z]=c.useState("management"),[ne,Ne]=c.useState(""),[ve,be]=c.useState("all"),[N,ie]=c.useState("all"),[C,gt]=c.useState("factor"),[ee,Me]=c.useState(!1),[ft,Ve]=c.useState(!1),[x,We]=c.useState(null),[Ce,de]=c.useState(!1),[xt,ue]=c.useState([]),[Ie,Se]=c.useState(()=>ts("products")),[tt,st]=c.useState(!1),[U]=o.useForm(),[me]=o.useForm(),v=o.useWatch([],U),yt=o.useWatch([],me),te=i,q=i.settings||{},$e=i.forecast&&typeof i.forecast=="object"?i.forecast:{},Fe=$e.forecastImport&&typeof $e.forecastImport=="object"?$e.forecastImport:{},Ge=c.useMemo(()=>Bt(q),[q]),vt=c.useMemo(()=>zt({userId:P.userId,userEmail:P.email},Ge),[Ge,P.email,P.userId]),bt=c.useMemo(()=>`products:edit:${String((x==null?void 0:x.id)||"new")}`,[x==null?void 0:x.id]),b=rs({workspaceId:P.workspaceId,modalScope:bt,isOpen:ee,userId:P.userId,userEmail:P.email,userDisplayName:vt,displayNames:Ge});c.useEffect(()=>{if(y.current)return;const e=new URLSearchParams(s.search),r=String(e.get("source")||"");if(r!=="dashboard"&&r!=="plan-products")return;y.current=!0;const n=String(e.get("sku")||"").trim();if(n&&Ne(n),r==="dashboard"){ie(Ss(e.get("issues")));const a=bs(e.get("status"));a&&be(a),e.get("expand")==="all"&&st(!0)}},[s.search]);const _e=c.useMemo(()=>(Array.isArray(i.productCategories)?i.productCategories:[]).map(e=>({id:String(e.id||""),name:String(e.name||"Ohne Kategorie")})).filter(e=>e.id),[i.productCategories]),He=c.useMemo(()=>(Array.isArray(i.suppliers)?i.suppliers:[]).map(e=>({id:String(e.id||""),name:String(e.name||"")})).filter(e=>e.id),[i.suppliers]),Le=c.useMemo(()=>new Map(_e.map(e=>[e.id,e.name])),[_e]),ke=c.useMemo(()=>new Map(He.map(e=>[e.id,e.name])),[He]),rt=c.useMemo(()=>$t(te),[i.productCategories]),je=c.useMemo(()=>Zt({state:te,search:ne,statusFilter:ve,categoryLabelById:Le,supplierLabelById:ke}),[Le,ne,te,ve,ke]),pe=c.useMemo(()=>je.reduce((e,r)=>{const n=pt(r),a=r.completeness!=="ok"||n;return n&&(e.revenue+=1),a&&(e.needsFix+=1),r.completeness==="blocked"&&(e.blocked+=1),e},{revenue:0,needsFix:0,blocked:0}),[je]),Ue=c.useMemo(()=>N==="all"?je:je.filter(e=>{const r=pt(e);return N==="revenue"?r:N==="blocked"?e.completeness==="blocked":e.completeness!=="ok"||r}),[je,N]),R=c.useMemo(()=>{const e=new Map;Ue.forEach(n=>{var l;const a=n.categoryId&&Le.get(n.categoryId)||"Ohne Kategorie";e.has(a)||e.set(a,[]),(l=e.get(a))==null||l.push(n)});const r=Array.from(e.entries()).map(([n,a])=>({key:n,label:n,rows:a.sort((l,m)=>l.sku.localeCompare(m.sku))}));return Gt(r,rt)},[Le,rt,Ue]),G=c.useMemo(()=>Ue.filter(e=>e.status==="active"||e.status==="prelaunch"),[Ue]),St=c.useMemo(()=>G.map(e=>({value:e.sku,label:`${e.alias||e.sku} · ${e.sku}`})),[G]),I=yt||Xe,kt=c.useMemo(()=>{if(I.scope==="selected"){const e=new Set(G.map(r=>r.sku));return(Array.isArray(I.selectedSkus)?I.selectedSkus:[]).map(r=>String(r||"").trim()).filter(r=>r&&e.has(r))}return G.map(e=>e.sku)},[G,I.scope,I.selectedSkus]);c.useEffect(()=>{Se(e=>{if(!R.length)return[];const r=new Set(R.map(a=>a.key)),n=e.filter(a=>r.has(a));return n.length||Y?n:R.map(a=>a.key)})},[R,Y]),c.useEffect(()=>{tt&&R.length&&(Se(R.map(e=>e.key)),st(!1))},[tt,R]),c.useEffect(()=>{ss("products",Ie)},[Ie]);function Te(e){return e==null||!Number.isFinite(e)?"—":e.toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2})}function jt(e){const r=et(e);We(e),U.setFieldsValue(r),de(r.logisticsPerUnitEur!=null),Me(!0)}function Ut(e){const r=e.status==="active"?"inactive":e.status==="inactive"?"prelaunch":"active";M(n=>{const a=we(n);return a.products=(Array.isArray(a.products)?a.products:[]).map(l=>{const m=l;return String(m.sku||"").toLowerCase()!==e.sku.toLowerCase()?m:{...m,status:r,updatedAt:Ye()}}),a},"v2:products:toggle-status")}function Pt(e){Ke.confirm({title:`Produkt "${e.sku}" loeschen?`,onOk:async()=>{await M(r=>{const n=we(r);return n.products=(Array.isArray(n.products)?n.products:[]).filter(a=>String(a.sku||"").toLowerCase()!==e.sku.toLowerCase()),n},"v2:products:delete")}})}async function Dt(e){const r=`${e.hsCode||""}	${e.goodsDescription||""}`;try{await navigator.clipboard.writeText(r),Be.success("Kopiert")}catch{Be.error("Kopieren fehlgeschlagen")}}const Et=c.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:260,minWidth:260},cell:({row:n})=>t.jsxs("div",{className:"v2-proj-alias",children:[t.jsx(Ee,{className:"v2-proj-alias-main",children:n.original.alias||n.original.sku}),t.jsx(Ee,{className:"v2-proj-sku-secondary",type:"secondary",children:n.original.sku})]})},{header:"Supplier",accessorFn:n=>n.supplierId?ke.get(n.supplierId)||n.supplierId:"",meta:{width:190},cell:({row:n})=>n.original.supplierId?ke.get(n.original.supplierId)||n.original.supplierId:"—"}],r={header:"Aktionen",meta:{width:k==="logistics"?274:230,minWidth:k==="logistics"?274:230,sortable:!1},cell:({row:n})=>t.jsxs("div",{className:"v2-actions-nowrap",children:[k==="logistics"?t.jsx(B,{size:"small",onClick:()=>{Dt(n.original)},children:"Copy"}):null,t.jsx(B,{size:"small",onClick:()=>jt(n.original),children:"Bearbeiten"}),t.jsx(B,{size:"small",onClick:()=>Ut(n.original),children:"Status"}),t.jsx(B,{size:"small",danger:!0,onClick:()=>Pt(n.original),children:"Loeschen"})]})};return k==="logistics"?[...e,{header:"HS-Code",accessorKey:"hsCode",meta:{width:160},cell:({row:n})=>n.original.hsCode||"—"},{header:"Warenbeschreibung",accessorKey:"goodsDescription",meta:{minWidth:320,width:420},cell:({row:n})=>n.original.goodsDescription||"—"},r]:[...e,{header:"Status",accessorKey:"status",meta:{width:96},cell:({row:n})=>n.original.status==="inactive"?t.jsx(g,{children:"Inaktiv"}):n.original.status==="prelaunch"?t.jsx(g,{color:"gold",children:"Noch nicht gelauncht"}):t.jsx(g,{color:"green",children:"Aktiv"})},{header:"Completeness",accessorKey:"completeness",meta:{width:122},cell:({row:n})=>vs(n.original.completeness)},{header:"Ø VK (EUR)",accessorKey:"avgSellingPriceGrossEUR",meta:{width:120,align:"right"},cell:({row:n})=>Te(n.original.avgSellingPriceGrossEUR)},{header:"Ø EK (USD)",accessorKey:"templateUnitPriceUsd",meta:{width:120,align:"right"},cell:({row:n})=>Te(n.original.templateUnitPriceUsd)},{header:"Ø Einstand (EUR)",accessorKey:"landedUnitCostEur",meta:{width:140,align:"right"},cell:({row:n})=>Te(n.original.landedUnitCostEur)},{header:"Ø Shipping China->Lager/3PL (EUR/Stk)",accessorKey:"shippingPerUnitEur",meta:{width:220,align:"right"},cell:({row:n})=>Te(n.original.shippingPerUnitEur)},r]},[U,k,M,ke]),Pe=c.useMemo(()=>{var l;const e=(x==null?void 0:x.raw)||{},r=((l=e.template)==null?void 0:l.fields)||e.template||{},n=v||et(x||void 0);return{...e,sku:n.sku||e.sku||"",alias:n.alias||e.alias||"",hsCode:n.hsCode||e.hsCode||"",goodsDescription:n.goodsDescription||e.goodsDescription||"",supplierId:n.supplierId||e.supplierId||"",categoryId:n.categoryId??e.categoryId??null,moqUnits:n.moqUnits??e.moqUnits??null,moqOverrideUnits:n.moqOverrideUnits??e.moqOverrideUnits??null,safetyStockDohOverride:n.safetyStockDohOverride??e.safetyStockDohOverride??null,foCoverageDohOverride:n.foCoverageDohOverride??e.foCoverageDohOverride??null,landedUnitCostEur:n.landedUnitCostEur??e.landedUnitCostEur??null,logisticsPerUnitEur:n.logisticsPerUnitEur??e.logisticsPerUnitEur??null,freightPerUnitEur:n.logisticsPerUnitEur??e.freightPerUnitEur??null,productionLeadTimeDaysDefault:n.productionLeadTimeDaysDefault??e.productionLeadTimeDaysDefault??null,template:{scope:"SKU",name:"Standard (SKU)",fields:{...r,unitPriceUsd:n.templateUnitPriceUsd??r.unitPriceUsd??null,transportMode:n.templateTransportMode||String(r.transportMode||"SEA"),productionDays:n.templateProductionDays??r.productionDays??null,transitDays:n.templateTransitDays??r.transitDays??null,freightEur:n.templateFreightEur??r.freightEur??null,dutyPct:n.templateDutyPct??r.dutyPct??null,vatImportPct:n.templateVatImportPct??r.vatImportPct??null,fxRate:n.templateFxRate??r.fxRate??q.fxRate??null,currency:n.templateCurrency||String(r.currency||q.defaultCurrency||"EUR"),ddp:n.templateDdp??r.ddp??!1}}}},[v,x,q.defaultCurrency,q.fxRate,te]),j=c.useMemo(()=>as({product:Pe,state:te,supplierId:String(Pe.supplierId||"")}),[Pe,te]),F=c.useMemo(()=>lt({product:Pe,state:te}),[Pe,te]),he=c.useMemo(()=>String((v==null?void 0:v.sku)||(x==null?void 0:x.sku)||"").trim(),[v==null?void 0:v.sku,x==null?void 0:x.sku]),L=c.useMemo(()=>he?us({forecastImport:Fe,sku:he}):null,[Fe,he]),Re=c.useMemo(()=>L?L.months.map(e=>({key:String(e.monthNumber),monthLabel:e.monthLabel,factor:e.factor,averageUnits:e.averageUnits,sampleCount:e.sampleCount,value:C==="factor"?e.factor:e.averageUnits})):[],[L,C]),Nt=c.useMemo(()=>{if(!L)return null;const e=Re.map(l=>l.monthLabel),r=Re.map(l=>typeof l.value=="number"?l.value:null),n=C==="factor"?"Saisonalitäts-Faktor":"Ø Units",a=C==="factor"?2:Math.max(...r.filter(l=>Number.isFinite(l)),0);return{tooltip:{trigger:"axis",formatter:l=>{const D=(Array.isArray(l)?l:[])[0];if(!D||typeof D!="object")return"";const ae=Number(D.dataIndex),A=Number.isFinite(ae)?Re[ae]:null;if(!A)return"";const Z=typeof A.value=="number"?A.value:null,w=String(D.axisValue||""),xe=C==="factor"?E(Z,2):`${E(Z,1)} Units`;return`${w}<br/>${C==="factor"?"Faktor":"Ø Units"}: ${xe}<br/>Datenpunkte: ${A.sampleCount}`},valueFormatter:l=>Number.isFinite(l)?C==="factor"?E(l,2):`${E(l,1)} Units`:"—"},grid:{left:48,right:16,top:24,bottom:32},xAxis:{type:"category",data:e,axisLine:{show:!0}},yAxis:{type:"value",name:n,scale:!(a>0),min:C==="factor"?0:void 0,max:C==="factor"?Math.max(2,a):void 0,axisLabel:{formatter:l=>Number.isFinite(l)?C==="factor"?l.toFixed(2):E(l,1):"—"}},series:[{name:n,type:"line",data:r,smooth:!0,showSymbol:!0,symbolSize:6,lineStyle:{width:2}}]}},[L,Re,C]),V=c.useMemo(()=>{const e=String((v==null?void 0:v.sku)||(x==null?void 0:x.sku)||"").trim();return e&&(Array.isArray(i.planProductMappings)?i.planProductMappings:[]).map((n,a)=>Jt(n,a)).filter(n=>n.sku.toLowerCase()===e.toLowerCase()).sort((n,a)=>String(a.mappedAt||"").localeCompare(String(n.mappedAt||"")))[0]||null},[v==null?void 0:v.sku,x==null?void 0:x.sku,i.planProductMappings]),Oe=c.useMemo(()=>V?Xt({mapping:V,forecastImport:Fe,maxMonths:18}):[],[Fe,V]),ge=c.useMemo(()=>{const e=new Map,r=(a,l,m)=>{const D=e.get(a);if(!D){e.set(a,{level:l,messages:[m]});return}l==="error"&&(D.level="error"),D.messages.includes(m)||D.messages.push(m)},n=F.blockScope?"error":"warning";return F.blockingMissing.forEach(a=>{(ut[a.fieldKey]||[]).forEach(m=>r(m,n,a.reason||a.label))}),F.importantMissing.forEach(a=>{(ut[a.fieldKey]||[]).forEach(m=>r(m,"warning",a.reason||a.label))}),e},[F]),nt=c.useMemo(()=>Array.from(ge.keys()).some(e=>mt.has(e)),[ge]);function _(e){var r;return(r=ge.get(e))==null?void 0:r.level}function H(e){const r=ge.get(e);if(!(!r||!r.messages.length))return`Prüfen: ${r.messages.join(" · ")}`}const Qe=c.useMemo(()=>Array.from(ge.entries()).map(([e,r])=>({field:e,level:r.level,messages:r.messages,label:gs[e]||String(e)})),[ge]);function it(e){mt.has(e)&&ue(["advanced"]),window.setTimeout(()=>{try{U.scrollToField(e,{block:"center"})}catch{}const r=U.getFieldInstance(e);r&&typeof r.focus=="function"&&r.focus()},80)}function Mt(){var r;const e=(r=Qe[0])==null?void 0:r.field;e&&it(e)}const fe=c.useMemo(()=>{const e=v||{},r=xs({formFx:e.templateFxRate,settingsFx:q.fxRate,settingsEurUsd:q.eurUsdRate,resolvedFx:j.fxRate.value}),n=u(e.templateUnitPriceUsd),a=u(e.landedUnitCostEur),l=n!=null&&r!=null&&r>0?n/r:null,m=a!=null&&l!=null?a-l:null;return{value:Number.isFinite(m)?Math.max(0,Number(m)):null,warning:Number.isFinite(m)?Number(m)<0:!1,goodsCostEur:l,fxUsed:r,landedUnitCostEur:a,unitCostUsd:n}},[v,j.fxRate.value,q.eurUsdRate,q.fxRate]);c.useEffect(()=>{if(!ee||Ce)return;const e=Number(fe.value);if(!Number.isFinite(e))return;const r=Math.round(e*100)/100,n=u(U.getFieldValue("logisticsPerUnitEur"));(n==null||Math.abs(n-r)>1e-5)&&U.setFieldValue("logisticsPerUnitEur",r)},[U,Ce,ee,fe.value]),c.useEffect(()=>{!ee||!b.readOnly||!b.remoteDraftPatch||U.setFieldsValue(b.remoteDraftPatch)},[U,b.readOnly,b.remoteDraftPatch,b.remoteDraftVersion,ee]),c.useEffect(()=>{if(!ee){ue([]);return}nt&&ue(["advanced"])},[nt,ee]);function Ct(e){if(U.setFieldsValue({[e]:null}),e==="logisticsPerUnitEur"){de(!1);const r=Number(fe.value);Number.isFinite(r)&&U.setFieldValue("logisticsPerUnitEur",Math.round(r*100)/100)}}function O(e,r){const n=String(e.source||"missing"),a=e.source==="missing"&&e.required===!0;return t.jsxs("span",{className:"v2-field-meta",children:[t.jsxs("span",{children:["Effektiv: ",ys(e,r)]}),t.jsxs("span",{className:"v2-field-meta-source",children:[t.jsx("span",{children:"Quelle:"}),t.jsx("span",{className:J(n==="computed"?"settings":n,a),children:e.sourceLabel})]}),t.jsx("span",{children:(r==null?void 0:r.extraHint)||e.hint})]})}function Q(e,r){const n=v==null?void 0:v[r],a=n!=null&&n!=="";return t.jsxs("span",{className:"v2-field-meta-row",children:[t.jsx("span",{children:e}),a?t.jsx(B,{type:"link",size:"small",className:"v2-field-reset",onClick:l=>{l.preventDefault(),l.stopPropagation(),Ct(r)},children:"Zuruecksetzen"}):null]})}function It(){const e=et(void 0);We(null),U.setFieldsValue(e),de(e.logisticsPerUnitEur!=null),ue([]),Me(!0)}function Ft(){me.setFieldsValue({...Xe,scope:"filtered",selectedSkus:G.map(e=>e.sku)}),Ve(!0)}function Lt(e){const r=e.template&&typeof e.template=="object"?e.template:{},n=r.fields&&typeof r.fields=="object"?r.fields:r;return{template:r,fields:n}}function Tt(e,r){if(!r.length)throw new Error("Keine aktiven/prelaunch SKUs im aktuellen Zielumfang.");if(!(e.applyTemplateUnitPriceUsd||e.applyAvgSellingPriceGrossEUR||e.applySellerboardMarginPct||e.applyMoqUnits||e.applyProductionLeadTimeDaysDefault||e.applyTemplateTransitDays||e.applyTemplateDdp))throw new Error("Bitte mindestens ein Feld für den Bulk-Update aktivieren.");const a=(l,m,D)=>{if(!l)return;const ae=Number(m);if(!Number.isFinite(ae))throw new Error(`Bitte gültigen Wert setzen: ${D}.`)};a(e.applyTemplateUnitPriceUsd,e.templateUnitPriceUsd,"Ø EK (USD)"),a(e.applyAvgSellingPriceGrossEUR,e.avgSellingPriceGrossEUR,"Ø VK (EUR)"),a(e.applySellerboardMarginPct,e.sellerboardMarginPct,"Marge (%)"),a(e.applyMoqUnits,e.moqUnits,"MOQ"),a(e.applyProductionLeadTimeDaysDefault,e.productionLeadTimeDaysDefault,"Production Lead Time"),a(e.applyTemplateTransitDays,e.templateTransitDays,"Transit-Tage")}async function Rt(e){const r=new Set(G.map(l=>l.sku)),n=e.scope==="selected"?(Array.isArray(e.selectedSkus)?e.selectedSkus:[]).map(l=>String(l||"").trim()).filter(l=>l&&r.has(l)):G.map(l=>l.sku).filter(l=>r.has(l)),a=new Set(n);Tt(e,n),await M(l=>{const m=we(l),D=Array.isArray(m.products)?[...m.products]:[],ae=Ye();let A=0;if(m.products=D.map(Z=>{const w=Z,xe=String(w.sku||"").trim();if(!xe||!a.has(xe))return w;const K=String(w.status||"active").trim().toLowerCase();if(!(K==="active"||K==="prelaunch"||K==="aktiv"||K==="not_launched"||K==="planned"))return w;const T={...w},{template:se,fields:At}=Lt(w),Ae={...At};return e.applyAvgSellingPriceGrossEUR&&(T.avgSellingPriceGrossEUR=Number(e.avgSellingPriceGrossEUR)),e.applySellerboardMarginPct&&(T.sellerboardMarginPct=Number(e.sellerboardMarginPct)),e.applyMoqUnits&&(T.moqUnits=Math.max(0,Math.round(Number(e.moqUnits)))),e.applyProductionLeadTimeDaysDefault&&(T.productionLeadTimeDaysDefault=Math.max(0,Math.round(Number(e.productionLeadTimeDaysDefault)))),e.applyTemplateUnitPriceUsd&&(Ae.unitPriceUsd=Number(e.templateUnitPriceUsd)),e.applyTemplateTransitDays&&(Ae.transitDays=Math.max(0,Math.round(Number(e.templateTransitDays)))),e.applyTemplateDdp&&(Ae.ddp=!!e.templateDdp),T.template={...se,scope:se.scope||"SKU",name:se.name||"Standard (SKU)",fields:Ae},T.updatedAt=ae,A+=1,T}),!A)throw new Error("Keine passenden aktiven/prelaunch SKUs im Zielumfang gefunden.");return m},"v2:products:bulk-update"),Be.success(`Bulk-Update gespeichert (${n.length} SKU${n.length===1?"":"s"}).`),Ve(!1),me.resetFields()}async function Ot(e){if(b.readOnly)throw new Error("Dieses Produkt wird gerade von einem anderen Nutzer bearbeitet.");const r=e.sku.trim();if(!r)throw new Error("SKU ist erforderlich.");const n=Number(e.sellerboardMarginPct);if(!Number.isFinite(n)||n<=0||n>100)throw new Error("Brutto-Marge muss > 0 und <= 100 sein.");await M(a=>{const l=we(a),m=Array.isArray(l.products)?[...l.products]:[],D=r.toLowerCase();if(m.find(T=>{const se=T;return String(se.sku||"").toLowerCase()===D&&String(se.id||"")!==String(e.id||"")}))throw new Error("SKU existiert bereits.");const A=m.findIndex(T=>String(T.id||"")===String(e.id||"")),Z=A>=0?m[A]:null,w=Ye(),xe={unitPriceUsd:e.templateUnitPriceUsd,transportMode:e.templateTransportMode,productionDays:e.templateProductionDays,transitDays:e.templateTransitDays,freightEur:e.templateFreightEur,dutyPct:e.templateDutyPct,vatImportPct:e.templateVatImportPct,fxRate:e.templateFxRate,currency:e.templateCurrency,ddp:e.templateDdp},K={...Z||{},id:e.id||(Z==null?void 0:Z.id)||fs("prod"),sku:r,alias:e.alias.trim()||r,hsCode:String(e.hsCode||"").trim(),goodsDescription:String(e.goodsDescription||"").trim(),supplierId:e.supplierId||"",categoryId:e.categoryId||null,status:e.status||"active",avgSellingPriceGrossEUR:e.avgSellingPriceGrossEUR,sellerboardMarginPct:n,moqUnits:e.moqUnits,safetyStockDohOverride:e.safetyStockDohOverride,foCoverageDohOverride:e.foCoverageDohOverride,moqOverrideUnits:e.moqOverrideUnits,landedUnitCostEur:e.landedUnitCostEur,logisticsPerUnitEur:e.logisticsPerUnitEur,freightPerUnitEur:e.logisticsPerUnitEur,productionLeadTimeDaysDefault:e.productionLeadTimeDaysDefault,template:{scope:"SKU",name:"Standard (SKU)",fields:xe},updatedAt:w};K.createdAt||(K.createdAt=w);const De=lt({product:K,state:l});if(De.status==="blocked"&&De.blockScope){const T=De.blockingMissing.map(se=>se.label).slice(0,5).join(", ");throw new Error(`Blockierende Stammdaten fehlen: ${T}${De.blockingMissing.length>5?" ...":""}`)}return A>=0?m[A]=K:m.push(K),l.products=m,l},x?"v2:products:update":"v2:products:create"),b.clearDraft(),We(null),Me(!1),de(!1),U.resetFields()}return t.jsxs("div",{className:"v2-page",children:[t.jsxs(ot,{className:"v2-intro-card",children:[t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(ce,{level:3,children:"Produkte"}),t.jsx(Je,{children:"Produktstammdaten fuer Tagesbetrieb und Logistik-Workflow mit klarer Default-/Override-Anzeige."})]})}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(ye,{wrap:!0,children:[t.jsx(le,{value:ne,onChange:e=>Ne(e.target.value),placeholder:"Suche SKU, Alias, Supplier, Kategorie, HS-Code, Warenbeschreibung",style:{width:340,maxWidth:"100%"}}),t.jsx(X,{value:ve,onChange:e=>be(e),options:[{value:"all",label:"Alle"},{value:"active",label:"Aktiv"},{value:"prelaunch",label:"Noch nicht gelauncht"},{value:"inactive",label:"Inaktiv"}],style:{width:140,maxWidth:"100%"}}),t.jsxs("div",{className:"v2-products-issue-filters",children:[t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${N==="all"?"is-active":""}`,onClick:()=>ie("all"),children:"Alle"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${N==="needs_fix"?"is-active":""}`,onClick:()=>ie("needs_fix"),children:"Nur korrigieren"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${N==="revenue"?"is-active":""}`,onClick:()=>ie("revenue"),children:"Umsatzrelevant"}),t.jsx("button",{type:"button",className:`v2-proj-filter-btn ${N==="blocked"?"is-active":""}`,onClick:()=>ie("blocked"),children:"Nur Blocker"})]}),t.jsx(ct,{value:k,onChange:e=>z(e),options:[{value:"management",label:"Management"},{value:"logistics",label:"Logistik"}]}),t.jsx(B,{type:"primary",onClick:It,children:"Produkt hinzufuegen"}),t.jsx(B,{onClick:Ft,children:"Bulk bearbeiten"})]}),t.jsxs(ye,{wrap:!0,children:[t.jsxs(g,{color:pe.needsFix>0?"gold":"green",children:["Korrekturbedarf: ",pe.needsFix]}),t.jsxs(g,{color:pe.revenue>0?"volcano":"green",children:["Umsatzrelevant: ",pe.revenue]}),t.jsxs(g,{color:pe.blocked>0?"red":"green",children:["Blocker: ",pe.blocked]})]}),p?t.jsx(g,{color:"processing",children:"Speichern..."}):null,f?t.jsxs(g,{color:"green",children:["Gespeichert: ",new Date(f).toLocaleTimeString("de-DE")]}):null]})})]}),h?t.jsx(W,{type:"error",showIcon:!0,message:h}):null,d?t.jsx(W,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,t.jsxs(ot,{children:[t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(Ee,{type:"secondary",children:[Ue.length," Produkte in ",R.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(B,{size:"small",onClick:()=>Se(R.map(e=>e.key)),disabled:!R.length,children:"Alles auf"}),t.jsx(B,{size:"small",onClick:()=>Se([]),disabled:!Ie.length,children:"Alles zu"})]})]}),R.length?t.jsx(dt,{className:"v2-category-collapse",activeKey:Ie,onChange:e=>Se((Array.isArray(e)?e:[e]).map(String)),items:R.map(e=>({key:e.key,label:t.jsxs(ye,{children:[t.jsx(Ee,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(Vt,{className:"v2-products-grid-wrap",data:e.rows,columns:Et,minTableWidth:k==="management"?1120:940,tableLayout:"fixed"})})}))}):t.jsx(Ee,{type:"secondary",children:"Keine Produkte für den aktuellen Filter."})]}),t.jsxs(Ke,{title:"Bulk-Stammdaten bearbeiten",rootClassName:"v2-form-modal",open:ft,onCancel:()=>{Ve(!1),me.resetFields()},onOk:()=>{me.validateFields().then(e=>Rt(e)).catch(()=>{})},width:900,children:[t.jsx(W,{type:"info",showIcon:!0,style:{marginBottom:10},message:`Bulk-Editor für aktive/prelaunch SKUs (${G.length} verfügbar)`,description:"Bulk-Änderungen schreiben explizit auf Produkt-Ebene. Herkunft in Modal/Liste bleibt danach konsistent als „Produkt“."}),t.jsxs(o,{form:me,layout:"vertical",initialValues:Xe,children:[t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"scope",label:"Zielumfang",style:{flex:1},children:t.jsx(X,{options:[{value:"filtered",label:"Alle aktiven/prelaunch aus aktuellem Filter"},{value:"selected",label:"Manuelle SKU-Auswahl"}]})}),t.jsx(o.Item,{label:"Ziel-SKUs (Preview)",style:{width:220},children:t.jsx(le,{value:String(kt.length),disabled:!0})})]}),I.scope==="selected"?t.jsx(o.Item,{name:"selectedSkus",label:"SKUs auswählen",children:t.jsx(X,{mode:"multiple",allowClear:!0,showSearch:!0,optionFilterProp:"label",placeholder:"SKU(s) wählen",options:St})}):null,t.jsxs("div",{className:"v2-bulk-grid",children:[t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateUnitPriceUsd",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"Ø EK (USD)"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateUnitPriceUsd",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"decimal",min:0,disabled:!I.applyTemplateUnitPriceUsd})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyAvgSellingPriceGrossEUR",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"Ø VK (EUR)"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"avgSellingPriceGrossEUR",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"decimal",min:0,disabled:!I.applyAvgSellingPriceGrossEUR})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applySellerboardMarginPct",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"Marge (%)"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"sellerboardMarginPct",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"percent",min:0,max:100,disabled:!I.applySellerboardMarginPct})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyMoqUnits",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"MOQ (Units)"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"moqUnits",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"int",min:0,disabled:!I.applyMoqUnits})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyProductionLeadTimeDaysDefault",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"Production Lead Time (Tage)"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"productionLeadTimeDaysDefault",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"int",min:0,disabled:!I.applyProductionLeadTimeDaysDefault})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateTransitDays",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"Transit-Tage"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateTransitDays",style:{marginBottom:0,minWidth:180},children:t.jsx(S,{mode:"int",min:0,disabled:!I.applyTemplateTransitDays})})]}),t.jsxs("div",{className:"v2-bulk-field-row",children:[t.jsx(o.Item,{name:"applyTemplateDdp",valuePropName:"checked",style:{marginBottom:0},children:t.jsx(re,{children:"DDP / Incoterm-Flag"})}),t.jsx(g,{className:J("product",!1),children:"Produkt"}),t.jsx(o.Item,{name:"templateDdp",style:{marginBottom:0,minWidth:180},children:t.jsx(X,{disabled:!I.applyTemplateDdp,options:[{value:!0,label:"DDP = Ja"},{value:!1,label:"DDP = Nein"}]})})]})]})]})]}),t.jsxs(Ke,{title:x?`Produkt bearbeiten: ${x.sku}`:"Produkt hinzufuegen",rootClassName:"v2-form-modal",open:ee,onCancel:()=>{b.clearDraft(),Me(!1),de(!1),ue([])},onOk:()=>{if(b.readOnly){Ke.warning({title:"Nur Lesemodus",content:`${b.remoteUserLabel||"Kollege"} bearbeitet dieses Produkt. Bitte Bearbeitung übernehmen oder warten.`});return}U.validateFields().then(e=>Ot(e)).catch(e=>{Mt();const r=e instanceof Error?e.message:"Stammdaten prüfen";Be.warning(r)})},width:1060,children:[b.banner?t.jsx(W,{style:{marginBottom:10},type:b.banner.tone,showIcon:!0,message:b.banner.text,action:b.readOnly?t.jsx(B,{size:"small",onClick:b.takeOver,children:"Bearbeitung uebernehmen"}):null}):null,b.readOnly&&b.remoteDraftVersion>0?t.jsxs(g,{color:"orange",style:{marginBottom:10},children:["Entwurf von ",b.remoteUserLabel||"Kollege"," wird live gespiegelt."]}):null,t.jsxs(o,{name:"v2-products-modal",form:U,layout:"vertical",disabled:b.readOnly,onValuesChange:e=>{b.readOnly||b.publishDraftPatch(e)},children:[t.jsx(o.Item,{name:"id",hidden:!0,children:t.jsx(le,{})}),F.status!=="ok"?t.jsx(W,{style:{marginBottom:10},type:F.status==="blocked"&&F.blockScope?"error":"warning",showIcon:!0,message:F.status==="blocked"&&F.blockScope?"Blockierende Stammdaten fehlen":"Stammdaten prüfen",description:t.jsxs(ye,{direction:"vertical",size:8,style:{width:"100%"},children:[t.jsx("span",{children:[F.blockingMissing.length?`Blocker: ${F.blockingMissing.map(e=>e.label).join(", ")}`:null,F.importantMissing.length?`Wichtig: ${F.importantMissing.map(e=>e.label).join(", ")}`:null].filter(Boolean).join(" · ")}),Qe.length?t.jsx("div",{className:"v2-issue-chip-row",children:Qe.map(e=>t.jsx(B,{size:"small",className:`v2-issue-chip ${e.level==="error"?"is-error":"is-warning"}`,onClick:()=>it(e.field),children:e.label},String(e.field)))}):null]})}):null,t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Basis"}),t.jsx("span",{className:"v2-form-section-desc",children:"Identitaet, Zuordnung und Logistik-Referenzdaten."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"sku",label:"SKU",style:{flex:1},rules:[{required:!0,message:"SKU fehlt."}],children:t.jsx(le,{})}),t.jsx(o.Item,{name:"alias",label:"Alias",style:{flex:1},rules:[{required:!0,message:"Alias fehlt."}],children:t.jsx(le,{})}),t.jsx(o.Item,{name:"status",label:"Status",style:{width:140},children:t.jsx(X,{options:ms})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"categoryId",label:"Kategorie",style:{flex:1},children:t.jsx(X,{allowClear:!0,options:_e.map(e=>({value:e.id,label:e.name}))})}),t.jsx(o.Item,{name:"supplierId",label:"Supplier",style:{flex:1},children:t.jsx(X,{allowClear:!0,options:He.map(e=>({value:e.id,label:e.name}))})}),t.jsx(o.Item,{name:"hsCode",label:"HS-Code",style:{flex:1},validateStatus:_("hsCode"),help:H("hsCode"),children:t.jsx(le,{placeholder:"z. B. 3926.90.97"})})]}),t.jsx("div",{className:"v2-form-row",children:t.jsx(o.Item,{name:"goodsDescription",label:"Warenbeschreibung",style:{gridColumn:"1 / -1"},validateStatus:_("goodsDescription"),help:H("goodsDescription"),children:t.jsx(le.TextArea,{rows:2,placeholder:"Kurzbeschreibung fuer Zoll / Logistiker"})})})]}),t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Preise & Kosten (operativ)"}),t.jsx("span",{className:"v2-form-section-desc",children:"Kerndaten fuer Planung sowie FO/PO-Prefill."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"avgSellingPriceGrossEUR",label:"Durchschnittlicher Verkaufspreis (EUR)",style:{flex:1},validateStatus:_("avgSellingPriceGrossEUR"),help:H("avgSellingPriceGrossEUR"),rules:[{required:!0,message:"Verkaufspreis ist erforderlich."}],children:t.jsx(S,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"sellerboardMarginPct",label:"Brutto-Marge %",style:{flex:1},validateStatus:_("sellerboardMarginPct"),help:H("sellerboardMarginPct"),rules:[{required:!0,message:"Marge ist erforderlich."},{validator:(e,r)=>{const n=Number(r);return Number.isFinite(n)&&n>0&&n<=100?Promise.resolve():Promise.reject(new Error("Marge muss > 0 und <= 100 sein."))}}],extra:t.jsx("span",{className:"v2-field-meta",children:"Wird für Gewinn-/Deckungsbeitragsrechnung genutzt."}),children:t.jsx(S,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateUnitPriceUsd",label:Q("Durchschnittlicher EK (USD)","templateUnitPriceUsd"),style:{flex:1},validateStatus:_("templateUnitPriceUsd"),help:H("templateUnitPriceUsd"),extra:O(j.unitPriceUsd,{digits:2}),children:t.jsx(S,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"landedUnitCostEur",label:"Durchschnittlicher Einstand (EUR)",style:{flex:1},validateStatus:_("landedUnitCostEur"),help:H("landedUnitCostEur"),extra:t.jsx("span",{className:"v2-field-meta",children:"Landed Cost je Einheit laut Ist-/Logistikdaten."}),children:t.jsx(S,{mode:"decimal",min:0})})]}),t.jsx("div",{className:"v2-form-row",children:t.jsx(o.Item,{name:"logisticsPerUnitEur",label:Q("Ø Shipping China->Lager/3PL (EUR/Stk)","logisticsPerUnitEur"),style:{gridColumn:"1 / -1"},extra:t.jsxs("span",{className:"v2-field-meta",children:[t.jsxs("span",{children:["Effektiv: ",E(u(v==null?void 0:v.logisticsPerUnitEur),2)]}),t.jsxs("span",{className:"v2-field-meta-source",children:[t.jsx("span",{children:"Quelle:"}),t.jsx("span",{className:J(Ce?"product":j.logisticsPerUnitEur.source==="computed"?"settings":j.logisticsPerUnitEur.source,!1),children:Ce?"Produkt":j.logisticsPerUnitEur.sourceLabel})]}),t.jsxs("span",{children:["Vorschlag: ",E(u(fe.value),2)," EUR/Stk (Formel: Einstand (EUR) - EK in EUR)"]}),t.jsxs("span",{children:["EK in EUR (aus USD/FX): ",E(u(fe.goodsCostEur),2)," EUR/Stk"]}),t.jsxs("span",{children:["FX-Referenz: ",E(u(fe.fxUsed),4)," USD je EUR"]}),t.jsx("span",{children:"Kann je nach Datenbasis auch Zoll/EUSt/Importnebenkosten enthalten."})]}),children:t.jsx(S,{mode:"decimal",min:0,onChange:()=>de(!0)})})})]}),t.jsxs("div",{className:"v2-form-section",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Lieferzeit"}),t.jsx("span",{className:"v2-form-section-desc",children:"Operative Hauptwerte fuer Produktions- und Transitdauer."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"productionLeadTimeDaysDefault",label:Q("Production Lead Time (Tage)","productionLeadTimeDaysDefault"),style:{flex:1},validateStatus:_("productionLeadTimeDaysDefault"),help:H("productionLeadTimeDaysDefault"),extra:O(j.productionLeadDays,{digits:0}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateTransitDays",label:Q("Transit-Tage","templateTransitDays"),style:{flex:1},extra:O(j.transitDays,{digits:0}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateTransportMode",label:"Transportmodus",style:{flex:1},extra:O(j.transportMode,{kind:"text"}),children:t.jsx(X,{options:ps.map(e=>({value:e,label:e}))})})]})]}),t.jsx(dt,{className:"v2-inline-collapse",activeKey:xt,onChange:e=>{const r=Array.isArray(e)?e:[e];ue(r.map(String).filter(Boolean))},items:[{key:"advanced",label:"Erweitert",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Policies & Beschaffungs-Template"}),t.jsx("span",{className:"v2-form-section-desc",children:"Optional: produktspezifische Overrides und tiefe Template-Defaults."})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"moqUnits",label:Q("MOQ Units","moqUnits"),style:{flex:1},validateStatus:_("moqUnits"),help:H("moqUnits"),extra:O(j.moqEffective,{digits:0}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"moqOverrideUnits",label:Q("MOQ Override Units","moqOverrideUnits"),style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Nur fuer dieses Produkt. Leer = Defaultkette."}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"safetyStockDohOverride",label:Q("Safety Stock DOH Override","safetyStockDohOverride"),style:{flex:1},extra:O(j.safetyDohEffective,{digits:0}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"foCoverageDohOverride",label:Q("FO Coverage DOH Override","foCoverageDohOverride"),style:{flex:1},extra:O(j.coverageDohEffective,{digits:0}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateCurrency",label:"Waehrung",style:{flex:1},extra:O(j.currency,{kind:"text"}),children:t.jsx(X,{options:hs.map(e=>({value:e,label:e}))})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"templateProductionDays",label:"Template Produktionstage",style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Nur fuer Template-Fallbacks, falls keine operative Lead-Time gepflegt ist."}),children:t.jsx(S,{mode:"int",min:0})}),t.jsx(o.Item,{name:"templateFreightEur",label:"Template Logistik/Stk (EUR)",style:{flex:1},extra:t.jsx("span",{className:"v2-field-meta",children:"Fallback, wenn kein produktspezifischer Shipping-Wert gesetzt ist."}),children:t.jsx(S,{mode:"decimal",min:0})}),t.jsx(o.Item,{name:"templateFxRate",label:Q("FX Rate (USD je EUR)","templateFxRate"),style:{flex:1},extra:O(j.fxRate,{digits:4}),children:t.jsx(S,{mode:"fx",min:0})})]}),t.jsxs("div",{className:"v2-form-row",children:[t.jsx(o.Item,{name:"templateDutyPct",label:"Zoll %",style:{flex:1},extra:O(j.dutyPct,{digits:2}),children:t.jsx(S,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateVatImportPct",label:"EUSt %",style:{flex:1},extra:O(j.eustPct,{digits:2}),children:t.jsx(S,{mode:"percent",min:0,max:100})}),t.jsx(o.Item,{name:"templateDdp",label:"Incoterm / DDP",valuePropName:"checked",validateStatus:_("templateDdp"),help:H("templateDdp"),extra:O(j.ddp,{kind:"boolean"}),children:t.jsx(re,{children:"DDP aktiv (Door-to-Door, Importkosten im Lieferpreis)"})})]})]})},{key:"seasonality",label:"Saisonalitaet (berechnet)",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Saisonalitaet aus Forecast-CSV"}),t.jsx("span",{className:"v2-form-section-desc",children:"Jan-Dez Faktoren aus den importierten Monats-Units je SKU."})]}),t.jsx(Je,{type:"secondary",style:{marginBottom:8},children:"Wir nehmen die Monatsabsatze (Units) aus der importierten CSV, bilden fuer jeden Kalendermonat (z. B. alle Januare) den Durchschnitt und teilen ihn durch den durchschnittlichen Monatswert ueber alle Monate. So entstehen Multiplikatoren, die zeigen, wie stark oder schwach ein Monat typischerweise im Vergleich zum Durchschnitt ist."}),he?L?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"v2-seasonality-headline",children:[t.jsxs(ye,{wrap:!0,style:{marginBottom:8},children:[t.jsxs(g,{color:"blue",children:["Zeitraum: ",Ze(L.startMonth)," bis ",Ze(L.endMonth)," ","(",L.sampleMonthCount," Monate)"]}),t.jsxs(g,{color:L.coveredMonthTypes===12?"green":"gold",children:["Kalendermonate mit Daten: ",L.coveredMonthTypes,"/12"]}),t.jsxs(g,{children:["Ø Monats-Units (Basis): ",E(L.overallAverage,1)," (aus ",L.sampleMonthCount," Monatsdaten)"]})]}),t.jsx(ct,{options:[{value:"factor",label:"Faktor"},{value:"units",label:"Absatz (Units)"}],value:C,onChange:e=>gt(e)})]}),t.jsx("div",{className:"v2-seasonality-chart-wrap",children:t.jsx(Wt,{style:{height:240},option:Nt||void 0,opts:{renderer:"canvas"}})}),t.jsx(Je,{type:"secondary",style:{margin:"8px 0 0"},children:C==="factor"?"Faktor 1,00 = durchschnittlicher Monat, 1,40 = 40 % ueberdurchschnittlich, 0,70 = 30 % unterdurchschnittlich.":"Auftragsvolumen in Units zeigt den berechneten Monatsdurchschnitt aus der Forecast-CSV."})]}):t.jsx(W,{type:"warning",showIcon:!0,message:`Keine Forecast-Daten fuer SKU ${he}`,description:"Bitte Forecast-CSV importieren. Das Profil wird aus den importierten Monats-Units abgeleitet."}):t.jsx(W,{type:"info",showIcon:!0,message:"Keine SKU gesetzt",description:"Saisonalitaet wird angezeigt, sobald eine SKU im Produkt gesetzt ist."})]})},{key:"plan-vs-live",label:"Plan-vs-Ist (Plan -> Live)",children:t.jsxs("div",{className:"v2-form-section v2-form-section-nested",children:[t.jsxs("div",{className:"v2-form-section-head",children:[t.jsx(ce,{level:5,className:"v2-form-section-title",children:"Lessons Learned: Plan vs Live/CSV"}),t.jsx("span",{className:"v2-form-section-desc",children:"Monatlicher Vergleich nach Übernahme eines Plan-Produkts in eine Live-SKU."})]}),he?V?Oe.length?t.jsxs(t.Fragment,{children:[t.jsxs(ye,{wrap:!0,style:{marginBottom:8},children:[t.jsxs(g,{color:"blue",children:["Plan: ",V.planProductAlias||V.planProductId]}),t.jsxs(g,{color:"green",children:["Live-SKU: ",V.sku]}),t.jsxs(g,{children:["Übernommen: ",V.mappedAt?new Date(V.mappedAt).toLocaleDateString("de-DE"):"—"]}),t.jsxs(g,{children:["Launch: ",V.launchDate||"—"]}),t.jsxs(g,{color:Oe.length>=12?"green":"gold",children:["Monate im Vergleich: ",Oe.length]})]}),t.jsx(ns,{size:"small",pagination:!1,rowKey:"month",dataSource:Oe,columns:[{title:"Monat",dataIndex:"month",key:"month",sorter:(e,r)=>String(e.month||"").localeCompare(String(r.month||"")),render:e=>Ze(e)},{title:"Plan Units",dataIndex:"planUnits",key:"planUnits",align:"right",sorter:(e,r)=>Number(u(e.planUnits)||0)-Number(u(r.planUnits)||0),render:e=>E(u(e),0)},{title:"Live Units (CSV)",dataIndex:"liveUnits",key:"liveUnits",align:"right",sorter:(e,r)=>Number(u(e.liveUnits)||0)-Number(u(r.liveUnits)||0),render:e=>E(u(e),0)},{title:"Delta Units",dataIndex:"deltaUnits",key:"deltaUnits",align:"right",sorter:(e,r)=>Number(u(e.deltaUnits)||0)-Number(u(r.deltaUnits)||0),render:e=>E(u(e),0)},{title:"Delta %",dataIndex:"deltaPct",key:"deltaPct",align:"right",sorter:(e,r)=>Number(u(e.deltaPct)||0)-Number(u(r.deltaPct)||0),render:e=>{const r=u(e);return Number.isFinite(r)?`${E(r,1)}%`:"—"}}]})]}):t.jsx(W,{type:"warning",showIcon:!0,message:"Noch keine überlappenden Monatsdaten",description:"Für Plan oder Live/CSV sind aktuell keine gemeinsamen Monatswerte vorhanden."}):t.jsx(W,{type:"info",showIcon:!0,message:"Kein Plan->Live Mapping für diese SKU",description:"Die Ansicht wird automatisch verfügbar, sobald ein Plan-Produkt als gelauncht markiert und dieser SKU zugeordnet wurde."}):t.jsx(W,{type:"info",showIcon:!0,message:"Keine SKU gesetzt",description:"Plan-vs-Ist wird angezeigt, sobald eine SKU im Produkt gesetzt ist."})]})}]})]})]})]})}export{_s as default};
