import{t as u,_ as Ns,k as e,I as ne,J as ts,K as Ms,L as w,S as Q,M as h,T as Ce,R as Gt,N as Se,O as Wt,P as bt}from"./index-DZx8ouWC.js";import{E as As}from"./index-BrEp5C0V.js";import{c as Cs}from"./cashflow-CTNibywt.js";import{T as ws}from"./TanStackGrid-BJh74gbk.js";import{b as Is}from"./dashboardMaturity-BGfmwC8q.js";import{b as Es}from"./orderEditorFactory-Bitc9Tqf.js";import{c as Rs,a as Fs,b as Ps,d as Os}from"./orderUtils-CvLwbyX7.js";import{b as ss,r as $s,a as Ts,c as Ks}from"./phantomFo-BlXfj1Pv.js";import{e as Ls,g as Bs}from"./forecastVersioning-CiS4Ikyc.js";import{c as zs}from"./inventoryProjection-yyAEANAV.js";import{m as _s,c as xt,a as Us,n as Vs,b as Je,f as $}from"./months-DiLwPhVv.js";import{u as Hs,C as T}from"./workspace-DDU9z8sj.js";import{h as Gs,g as Ws,s as Zs}from"./uiPrefs-CxTlE9qM.js";import{s as qs}from"./index-CmFS2sMD.js";import{C as re}from"./Collapse-BERg2PXi.js";import{S as Qe}from"./index-BEQu2dKw.js";import{S as xe}from"./index-q4_rhBCQ.js";import{R as rs}from"./InfoCircleOutlined-DY50JiAj.js";import{F as Ys}from"./Table-CVtE9Enq.js";import{T as Js}from"./index-ClWh-X7T.js";import"./planProducts-DlOiHfMN.js";import"./store-CGIcF1vR.js";import"./prefill-BaEKHkHB.js";import"./productCompleteness-CNODPsSo.js";import"./costing-CmZrILJ2.js";import"./dateUtils-D7NmXfd-.js";import"./shipping-9Dzo5wwm.js";import"./deepEqual-CGWqzo0t.js";import"./useDraftForm-CNG_ojts.js";import"./foSuggestion-Ck1952gl.js";import"./productCompletenessV2-D1rSyPRd.js";import"./abcClassification-sRzf5rvu.js";import"./Dropdown-GerSUf01.js";import"./index-B7BqQAz9.js";import"./useBubbleLock-O9vKWJ3S.js";import"./index-DZ5l5gIc.js";import"./Pagination-Zbuj_xZJ.js";const{Text:Qs}=ts;function Xs({className:t,groups:r=[],items:n,visibleStartMs:a,visibleEndMs:o,height:l=180,emptyMessage:d="Keine Timeline-Daten vorhanden."}){const D=u.useRef(null),[k,E]=u.useState(null),[p,x]=u.useState(null);u.useEffect(()=>{if(typeof window>"u")return;let y=!0;return Ns(()=>import("./vis-timeline-graph2d-DVPA6HI_.js"),[]).then(P=>{y&&E(P)}).catch(P=>{y&&x(P instanceof Error?P.message:"Timeline konnte nicht geladen werden.")}),()=>{y=!1}},[]);const g=u.useMemo(()=>n.map(y=>({id:y.id,type:y.type||(y.endMs!=null?"range":"box"),content:y.content||"",start:y.startMs,end:y.endMs,className:y.className,title:y.title,selectable:!1,editable:!1})),[n]),j=u.useMemo(()=>r.map(y=>({id:y.id,content:y.content,className:y.className})),[r]),O=u.useMemo(()=>{const y=Number.isFinite(a)?a:Date.now(),P=Number.isFinite(o)?o:y+30*24*60*60*1e3,K=P>y?P:y+30*24*60*60*1e3;return{stack:!0,zoomable:!1,moveable:!1,selectable:!1,showCurrentTime:!0,orientation:{axis:"top",item:"top"},margin:{axis:10,item:8},start:y,end:K,tooltip:{followMouse:!0,overflowMethod:"cap"}}},[o,a]);return u.useEffect(()=>{if(!k||!D.current||!g.length)return;const y=D.current;y.innerHTML="";const P=j.length?new k.Timeline(y,g,j,O):new k.Timeline(y,g,O);return()=>{P.destroy()}},[j,g,O,k]),n.length?p?e.jsx(ne,{type:"warning",showIcon:!0,message:`Timeline konnte nicht geladen werden: ${p}`}):k?e.jsx("div",{className:["v2-vis-timeline",t||""].filter(Boolean).join(" "),children:e.jsx("div",{ref:D,style:{height:l}})}):e.jsx("div",{className:"v2-vis-timeline-loading",children:e.jsx(Qs,{type:"secondary",children:"Timeline wird geladen..."})}):e.jsx(ne,{type:"info",showIcon:!0,message:d})}const pt=24*60*60*1e3,er={slug:"po",entityLabel:"PO",numberField:"poNo"};function me(t){return String(t||"").trim().toLowerCase()}function je(t){const r=String(t||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(r))return null;const[n,a,o]=r.split("-").map(Number);if(!n||!a||!o)return null;const l=new Date(Date.UTC(n,a-1,o));return Number.isNaN(l.getTime())?null:r}function Te(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(Date.UTC(r,n-1,a));return Number.isNaN(o.getTime())?null:o.getTime()}function $e(t){if(!t)return"—";const r=Te(t);return r==null?t:new Date(r).toLocaleDateString("de-DE")}function tr(t){return Number.isFinite(t)?t.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function sr(t){const r=t.settings&&typeof t.settings=="object"?t.settings:{},n=r.cny&&typeof r.cny=="object"?r.cny:{start:"",end:""},a=r.cnyBlackoutByYear&&typeof r.cnyBlackoutByYear=="object"?r.cnyBlackoutByYear:{};return{fxRate:Number(r.fxRate||0),fxFeePct:Number(r.fxFeePct||0),dutyRatePct:Number(r.dutyRatePct||0),dutyIncludeFreight:r.dutyIncludeFreight!==!1,eustRatePct:Number(r.eustRatePct||0),vatRefundEnabled:r.vatRefundEnabled!==!1,vatRefundLagMonths:Number(r.vatRefundLagMonths||0),freightLagDays:Number(r.freightLagDays||0),cny:n,cnyBlackoutByYear:a}}function rr(t){const r=me(t.sourceId),n=me(t.sourceNumber);return(Array.isArray(t.state.pos)?t.state.pos:[]).find(o=>{const l=me(o.id),d=me(o.poNo);return!!(r&&r===l||n&&n===d||n&&n===l)})||null}function nr(t){const r=me(t.sourceId),n=me(t.sourceNumber);return(Array.isArray(t.state.fos)?t.state.fos:[]).find(o=>{const l=me(o.id),d=me(o.foNo),D=me(o.foNumber);return!!(r&&r===l||n&&(n===d||n===D||n===l))})||null}function ns(t,r,n){return String(t||"").trim().toLowerCase()==="paid"||String(r||"").trim()||String(n||"").trim()?"paid":"open"}function os(t){const r=String(t.explicitDirection||"").trim().toLowerCase();if(r==="in")return"in";if(r==="out")return"out";const n=`${String(t.eventType||"")} ${String(t.category||"")} ${String(t.label||"")}`.toLowerCase();return n.includes("refund")||n.includes("erstatt")||t.amount<0?"in":"out"}function or(t,r){const n=Array.isArray(t.payments)?t.payments:[];let a=[];try{const o=typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r));a=Es(o,er,sr(t),n,{includeIncoming:!0})}catch{a=[]}return a.map(o=>{const l=je(o.dueDate);if(!l)return null;const d=Math.abs(Number(o.plannedEur||0));if(!(d>0))return null;const D=os({amount:Number(o.plannedEur||0),eventType:o.eventType,label:o.label||o.typeLabel,explicitDirection:o.direction});return{id:String(o.id||`po-pay-${l}`),label:String(o.typeLabel||o.label||"Zahlung"),dueDate:l,amountEur:d,status:ns(o.status,o.paidDate,o.paymentId),direction:D}}).filter(o=>!!o)}function ar(t){const r=Number(t.fxRate||0);return(Array.isArray(t.payments)?t.payments:[]).map((a,o)=>{const l=je(a.dueDate);if(!l)return null;const d=Number(a.amount||0);if(!Number.isFinite(d)||d===0)return null;const D=os({amount:d,category:a.category,label:a.label}),k=Math.abs(Os(d,a.currency||"EUR",r));return k>0?{id:String(a.id||`fo-pay-${o+1}`),label:String(a.label||a.category||"Zahlung"),dueDate:l,amountEur:k,status:ns(a.status,a.paidDate,a.paymentId),direction:D}:null}).filter(a=>!!a)}function Zt(t){const r=[],n=Te(t.orderDate),a=Te(t.etdDate),o=Te(t.etaDate);n!=null&&a!=null&&a>=n&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:production`,type:"range",content:"Produktion",startMs:n,endMs:a,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--production",title:`Produktion: ${$e(t.orderDate)} bis ${$e(t.etdDate)}`}),a!=null&&o!=null&&o>=a&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:transit`,type:"range",content:"Transit",startMs:a,endMs:o,className:"v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--transit",title:`Transit: ${$e(t.etdDate)} bis ${$e(t.etaDate)}`}),[{key:"order",label:"Order",date:t.orderDate},{key:"etd",label:"ETD",date:t.etdDate},{key:"eta",label:"ETA",date:t.etaDate}].forEach(g=>{const j=Te(g.date);j!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:milestone:${g.key}`,type:"box",content:g.label,startMs:j,className:`v2-dashboard-order-timeline-item v2-dashboard-order-timeline-item--milestone v2-dashboard-order-timeline-item--milestone-${g.key}`,title:`${g.label}: ${$e(g.date)}`})}),t.payments.forEach(g=>{const j=Te(g.dueDate);j!=null&&r.push({id:`${t.source}:${t.sourceId||t.sourceNumber||"order"}:payment:${g.id}`,type:"box",content:g.direction==="in"?"+":" ",startMs:j,className:["v2-dashboard-order-timeline-item","v2-dashboard-order-timeline-item--payment",g.status==="paid"?"v2-dashboard-order-timeline-item--payment-paid":"v2-dashboard-order-timeline-item--payment-open",g.direction==="in"?"v2-dashboard-order-timeline-item--payment-incoming":"v2-dashboard-order-timeline-item--payment-outgoing"].join(" "),title:[g.label,`Fällig: ${$e(g.dueDate)}`,`Betrag: ${tr(g.amountEur)}`,`Status: ${g.status==="paid"?"Bezahlt":"Offen"}`].join(`
`)})});const d=r.flatMap(g=>[g.startMs,g.endMs].filter(j=>Number.isFinite(j)));if(!d.length)return null;const D=Math.min(...d),k=Math.max(...d),E=D-14*pt,p=k+14*pt,x=p>E?p:E+30*pt;return{source:t.source,sourceId:t.sourceId,sourceNumber:t.sourceNumber,orderDate:t.orderDate,etdDate:t.etdDate,etaDate:t.etaDate,visibleStartMs:E,visibleEndMs:x,items:r}}function ir(t){const r=t.source==="fo"?"fo":"po",n=t.sourceId?String(t.sourceId):null,a=t.sourceNumber?String(t.sourceNumber):null;if(r==="po"){const d=rr({state:t.state,sourceId:n,sourceNumber:a});if(!d)return null;const D=t.state.settings&&typeof t.state.settings=="object"?t.state.settings:{},k=Rs({items:d.items,orderDate:d.orderDate,fxRate:d.fxOverride??D.fxRate,fallback:d}),E=Fs({orderDate:d.orderDate,productionLeadTimeDays:k.prodDays||d.prodDays,logisticsLeadTimeDays:k.transitDays||d.transitDays,bufferDays:0});return Zt({source:"po",sourceId:String(d.id||n||""),sourceNumber:String(d.poNo||a||""),orderDate:je(d.orderDate||E.orderDate),etdDate:je(d.etdManual||E.etdDate),etaDate:je(d.etaManual||E.etaDate),payments:or(t.state,d)})}const o=nr({state:t.state,sourceId:n,sourceNumber:a});if(!o)return null;const l=Ps({targetDeliveryDate:o.targetDeliveryDate||o.deliveryDate,productionLeadTimeDays:o.productionLeadTimeDays,logisticsLeadTimeDays:o.logisticsLeadTimeDays,bufferDays:o.bufferDays});return Zt({source:"fo",sourceId:String(o.id||n||""),sourceNumber:String(o.foNo||o.foNumber||a||""),orderDate:je(o.orderDate||l.orderDate),etdDate:je(o.etdDate||l.etdDate),etaDate:je(o.etaDate||l.etaDate||o.targetDeliveryDate||o.deliveryDate),payments:ar(o)})}function tt(t){if(!t)return null;const r=new Date(String(t));return Number.isNaN(r.getTime())?null:r}function lr(t){if(typeof t.active=="boolean")return t.active;const r=String(t.status||"").trim().toLowerCase();return r?r==="active"||r==="aktiv"||r==="prelaunch"||r==="not_launched"||r==="planned":!0}function vt(t){return String(t||"").trim()}function cr(t){return(Array.isArray(t.products)?t.products:[]).filter(n=>vt(n.sku)?lr(n):!1).map(n=>({sku:vt(n.sku),alias:String(n.alias||n.sku||""),status:String(n.status||"active"),safetyStockDohOverride:n.safetyStockDohOverride,foCoverageDohOverride:n.foCoverageDohOverride}))}function dr(t){const r=t.lastDriftSummary&&typeof t.lastDriftSummary=="object"?t.lastDriftSummary:{},n=typeof r.comparedAt=="string"?r.comparedAt:null;return n&&tt(n)?n:null}function ur(t){return{id:`gate:${t.key}`,key:t.key,severity:"error",label:t.label,message:t.detail,route:t.route}}function mr(t){const r=t.state||{},n=Number.isFinite(t.horizonMonths)?Math.max(1,Math.round(Number(t.horizonMonths))):12,a=_s(xt(),n),o=ss({state:r,months:a}),l=o.robustMonthsCount>=a.length&&a.length>0,d=cr(r),D=zs({state:r,months:a,products:d,snapshot:null,snapshotMonth:Us(xt(),-1),projectionMode:"units"}),k=Array.isArray(D.anchorSkuMissingHistory)?D.anchorSkuMissingHistory.map(te=>vt(te)).filter(Boolean).sort((te,Ee)=>te.localeCompare(Ee,"de-DE")):[],E=k.length===0,p=r.forecast&&typeof r.forecast=="object"?r.forecast:{},x=typeof p.lastImportAt=="string"?p.lastImportAt:null,g=tt(x),j=new Date,O=24*60*60*1e3,y=g?Math.floor((j.getTime()-g.getTime())/O):null,P=y!=null&&y<=35,K=dr(p),he=typeof p.lastDriftReviewedComparedAt=="string"?p.lastDriftReviewedComparedAt:null,ee=typeof p.lastDriftReviewedAt=="string"?p.lastDriftReviewedAt:null,fe=!!(K&&he&&Vs(String(K).slice(0,7))&&he===K&&tt(ee)),oe=t.runtimeErrorAt&&tt(t.runtimeErrorAt)?String(t.runtimeErrorAt):null,ge=!oe,we=[{key:"runtime_stable",label:"Runtime stabil",passed:ge,status:ge?"ok":"error",detail:ge?"Keine offenen Tab-Ladefehler.":`Offener Tab-Ladefehler seit ${new Date(oe).toLocaleString("de-DE")}${t.runtimeErrorRoute?` (${t.runtimeErrorRoute})`:""}.`,route:"/v2/dashboard",blockerCount:ge?0:1},{key:"robust_12m",label:"Robustheit 12M",passed:l,status:l?"ok":"error",detail:l?`${o.robustMonthsCount}/${a.length} Monate robust.`:`${o.robustMonthsCount}/${a.length} Monate robust (erforderlich: ${a.length}).`,route:"/v2/dashboard",blockerCount:l?0:Math.max(0,a.length-o.robustMonthsCount)},{key:"anchor_history_complete",label:"Anchor-Historie vollständig",passed:E,status:E?"ok":"error",detail:E?"Alle aktiven/prelaunch SKUs haben Snapshot-Historie.":`${k.length} SKU(s) ohne Snapshot-Historie (Anker=0).`,route:"/v2/inventory/projektion?source=dashboard&risk=under_safety&abc=ab&expand=all",blockerCount:k.length},{key:"forecast_fresh",label:"Forecast aktuell",passed:P,status:P?"ok":"error",detail:P?`${y} Tage seit Import.`:y==null?"Kein Forecast-Import vorhanden.":`${y} Tage seit Import (erlaubt <= 35).`,route:"/v2/forecast",blockerCount:P?0:1},{key:"forecast_drift_reviewed",label:"Drift geprüft",passed:fe,status:fe?"ok":"error",detail:fe?`Drift-Stand vom ${new Date(K).toLocaleDateString("de-DE")} geprüft.`:K?"Aktueller Drift-Stand ist noch nicht als geprüft markiert.":"Noch kein Driftvergleich verfügbar.",route:"/v2/forecast",blockerCount:fe?0:1}],Ie=we.filter(te=>!te.passed).map(te=>ur(te)),He=Ie.length===0;return{ready:He,status:He?"ready":"not_ready",horizonMonths:n,checks:we,blockers:Ie,robustMonthsCount:o.robustMonthsCount,robustRequiredCount:a.length,anchorMissingHistoryCount:k.length,anchorMissingHistorySkus:k,forecastDaysSinceImport:y,driftComparedAt:K,driftReviewedAt:ee,driftReviewedForComparedAt:he}}function Ue(t){return String(t||"").trim().toLowerCase()}function rt(t){const r=String(t||"").trim();if(!r)return null;const n=r.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(!n)return null;const a=Number(n[1]),o=Number(n[2]),l=Number(n[3]),d=new Date(a,o-1,l);return Number.isNaN(d.getTime())||d.getFullYear()!==a||d.getMonth()!==o-1||d.getDate()!==l?null:`${a}-${String(o).padStart(2,"0")}-${String(l).padStart(2,"0")}`}function hr(t){if(!t)return null;const[r,n,a]=t.split("-").map(Number);if(!r||!n||!a)return null;const o=new Date(r,n-1,a);return Number.isNaN(o.getTime())?null:o}function fr(){const t=new Date,r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${r}-${n}-${a}`}function qt(t){const r=Number(t);return Number.isFinite(r)?Math.max(0,Math.round(r)):0}function gr(t){const r=rt(t.etaManual||t.etaDate||t.eta);if(r)return r;const n=hr(rt(t.orderDate));if(!n)return null;const a=Math.max(0,Number(t.prodDays||0)),o=Math.max(0,Number(t.transitDays||0)),l=new Date(n.getTime());l.setDate(l.getDate()+a+o);const d=l.getFullYear(),D=String(l.getMonth()+1).padStart(2,"0"),k=String(l.getDate()).padStart(2,"0");return`${d}-${D}-${k}`}function br(t,r){const n=Ue(t.supplierId||t.supplier||t.supplierName);return n&&r.has(n)?String(r.get(n)):String(t.supplierName||t.supplier||"-")}function pr(t,r){const n=Array.isArray(t.items)?t.items:[],a=n.length?n.map(l=>String(l.sku||"").trim()).filter(Boolean):[String(t.sku||"").trim()].filter(Boolean);return Array.from(new Set(a.map(l=>r.get(Ue(l))||l))).join(", ")||"-"}function xr(t){const r=Array.isArray(t.items)?t.items:[];return r.length?r.reduce((n,a)=>n+qt(a.units),0):qt(t.units)}function vr(t){const r=t.state&&typeof t.state=="object"?t.state:{},n=String(t.month||""),a=rt(t.todayIso)||fr(),o=new Map;(Array.isArray(r.suppliers)?r.suppliers:[]).forEach(p=>{const x=p&&typeof p=="object"?p:{},g=String(x.name||"").trim();if(!g)return;const j=Ue(x.id),O=Ue(g);j&&o.set(j,g),O&&o.set(O,g)});const d=new Map;(Array.isArray(r.products)?r.products:[]).forEach(p=>{const x=p&&typeof p=="object"?p:{},g=String(x.sku||"").trim();g&&d.set(Ue(g),String(x.alias||g))});const k=[];return(Array.isArray(r.pos)?r.pos:[]).forEach(p=>{const x=p&&typeof p=="object"?p:{};if(x.archived||String(x.status||"").toUpperCase()==="CANCELLED")return;const g=String(x.id||x.poNo||"").trim();if(!g)return;const j=gr(x);if(!j)return;const O=rt(x.arrivalDate),P=j.slice(0,7)===n,K=!O,he=K&&j<a;!P&&!he||k.push({id:g,poNumber:String(x.poNo||x.id||""),supplier:br(x,o),skuAliases:pr(x,d),units:xr(x),etaDate:j,arrivalDate:O,monthRelevant:P,isOverdue:he,pending:K})}),k.sort((p,x)=>{if(p.pending!==x.pending)return p.pending?-1:1;if(p.monthRelevant!==x.monthRelevant)return p.monthRelevant?-1:1;const g=p.etaDate||"9999-12-31",j=x.etaDate||"9999-12-31",O=g.localeCompare(j);return O!==0?O:p.poNumber.localeCompare(x.poNumber)})}const{Paragraph:ve,Text:v,Title:ue}=ts,yr="v2:last-route-error";function jr(){return new Date().toISOString()}function kr(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const Yt=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],Dr=[{key:"inflow",label:"Einzahlungen"},{key:"po_fo",label:"PO/FO Zahlungen"},{key:"fixcost",label:"Fixkosten"},{key:"tax",label:"Steuern & Importkosten"},{key:"outflow",label:"Sonstige Auszahlungen"},{key:"other",label:"Sonstige"}],Sr=new Set(["signals","cashflow","actions","robustness","simulation","pnl","actuals","kpis"]),Nr=["signals","cashflow"],Jt={full:{label:"Vollständig",color:"green",className:"is-full"},wide:{label:"Weitgehend",color:"lime",className:"is-wide"},partial:{label:"Teilweise",color:"orange",className:"is-partial"},insufficient:{label:"Unzureichend",color:"red",className:"is-insufficient"}};function Qt(t){const r=new Set;return t.forEach(n=>{const a=String(n||"").trim();Sr.has(a)&&r.add(a)}),Array.from(r)}function Mr(t){return Array.isArray(t)?t:t?[t]:[]}function F(t){const r=Number(t);return Number.isFinite(r)?r.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"-"}function Ne(t){return Number.isFinite(t)?t<0?`−${F(Math.abs(t))}`:F(t):"-"}function Me(t,r=0){const n=Number(t);return Number.isFinite(n)?n.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"-"}function Xe(t){const r=Number(t);return Number.isFinite(r)?`${r.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"-"}function ye(t){if(!t)return"-";const r=new Date(t);return Number.isNaN(r.getTime())?t:r.toLocaleDateString("de-DE")}function Ar(t){return t==="ok"?e.jsx(h,{color:"green",children:"OK"}):e.jsx(h,{color:"red",children:"Offen"})}function yt(t){return Jt[t]||Jt.insufficient}function Cr(t){const r=yt(t);return e.jsx(h,{color:r.color,children:r.label})}function wr(t){return t.issueType==="forecast_missing"?"Forecast fehlt":t.issueType==="stock_oos"?"Out-of-Stock":"Unter Safety"}function Ae(t){return t.reduce((r,n)=>r+Number(n.amount||0),0)}function Ir(t,r){const n=new Date(t.getTime());return n.setDate(n.getDate()+r),n}function st(t){return t==="dividend"?"Dividende (Simulation)":"CAPEX (Simulation)"}function et(t,r){return e.jsxs("span",{className:"v2-dashboard-signal-title",children:[t,e.jsx(Ce,{title:r,children:e.jsx(rs,{})})]})}function Ve(t,r){const[n,a=""]=String(t||"").split("?"),o=new URLSearchParams(a);Object.entries(r).forEach(([d,D])=>{if(D==null||D===""){o.delete(d);return}o.set(d,D)});const l=o.toString();return l?`${n}?${l}`:n}function Er(t){return Ve("/v2/inventory/projektion",{source:"dashboard",risk:t.risk,abc:t.abc,month:t.month||null,sku:t.sku||null,mode:t.mode||null,expand:"all"})}function jt(t){return Ve("/v2/products",{source:"dashboard",issues:t.issues||"needs_fix",sku:t.sku||null,expand:"all"})}function as(t){return Ve("/v2/forecast",{source:"dashboard",sku:t.sku||null,month:t.month||null})}function Xt(t){return Ve("/v2/orders/fo",{source:t.source||"inventory_projection",sku:t.sku||null,month:t.month||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null,phantomId:t.phantomId||null,firstRiskMonth:t.firstRiskMonth||null,orderMonth:t.orderMonth||null,leadTimeDays:Number.isFinite(Number(t.leadTimeDays))?String(Math.max(0,Math.round(Number(t.leadTimeDays)))):null,returnTo:t.returnTo||"/v2/dashboard"})}function Rr(t){return Ve("/v2/orders/po",{source:"inventory_projection",sku:t.sku||null,suggestedUnits:Number.isFinite(Number(t.suggestedUnits))?String(Math.max(0,Math.round(Number(t.suggestedUnits)))):"0",requiredArrivalDate:t.requiredArrivalDate||null,recommendedOrderDate:t.recommendedOrderDate||null})}function _e(t){const r=String(t.route||"");if(r.startsWith("/v2/forecast"))return as({sku:t.sku||null,month:t.month||null});if(r.startsWith("/v2/inventory/projektion")){const n=t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"under_safety":"all",a=t.sku?"all":t.actionId==="inventory_safety"||t.checkKey==="sku_coverage"?"ab":"all";return Er({risk:n,abc:a,month:t.month||null,sku:t.sku||null,mode:t.mode||null})}if(r.startsWith("/v2/products")){const n=t.actionId==="revenue_inputs"||t.checkKey==="revenue_inputs"?"revenue":"needs_fix";return jt({issues:n,sku:t.sku||null})}return r}function Fr(t){const r=t.map(n=>(Array.isArray(n.entries)?n.entries:[]).filter(l=>String(l.direction||"").toLowerCase()==="out"&&String(l.group||"")==="Fixkosten").reduce((l,d)=>l+Math.abs(Number(d.amount||0)),0)).filter(n=>n>0);return r.length?r.reduce((n,a)=>n+a,0)/r.length:0}function Pr(t,r){const n={fixcost:0,po:0,fo:0,phantomFo:0};return t.forEach(a=>{if(!a||typeof a!="object")return;const o=a;if(String(o.direction||"").toLowerCase()!=="out")return;const l=Math.abs(Number(o.amount||0));if(!Number.isFinite(l)||l<=0)return;const d=String(o.source||"").toLowerCase();if(d==="po"){n.po+=l;return}if(d==="fo"){const k=String(o.sourceId||"").trim(),E=o.meta&&typeof o.meta=="object"?o.meta:{};o.provisional===!0||E.phantom===!0||(k?(r==null?void 0:r.has(k))===!0:!1)?n.phantomFo+=l:n.fo+=l;return}const D=String(o.group||"").toLowerCase();(d==="fixcosts"||D==="fixkosten")&&(n.fixcost+=l)}),n}function Or(t,r){var a;if(!r||!Number.isFinite(r.amount)||r.amount<=0)return t.map(o=>({...o}));let n=Number(((a=t[0])==null?void 0:a.opening)||0);return t.map((o,l)=>{const d=l===0?Number(o.opening||0):n,D=o.month===r.month,k=D?Math.abs(Number(r.amount||0)):0,E=Number(o.inflow||0),p=Number(o.outflow||0)+k,x=E-p,g=d+x;n=g;const j=D?[{id:`sim-${r.type}-${r.month}`,direction:"out",amount:k,label:r.label||st(r.type),month:r.month,kind:r.type==="dividend"?"dividend":"capex",group:r.type==="dividend"?"Dividende & KapESt":"Extras (Out)",source:"simulation"}]:[];return{...o,opening:d,inflow:E,outflow:p,net:x,closing:g,entries:[...Array.isArray(o.entries)?o.entries:[],...j],simApplied:D}})}function $r(t,r){var n;for(let a=0;a<t.length;a+=1){const o=t[a].month;if((n=r.get(o))!=null&&n.robust&&Number(t[a].closing||0)<0)return o}return null}function Tr(t){if(!t||typeof t!="object")return{comparedAt:null,thresholdProfile:"medium",flaggedSkuCount:0,flaggedABCount:0,flaggedMonthCount:0,topItems:[]};const r=t,n=Array.isArray(r.topItems)?r.topItems:[];return{comparedAt:typeof r.comparedAt=="string"?r.comparedAt:null,thresholdProfile:String(r.thresholdProfile||"medium"),flaggedSkuCount:Number(r.flaggedSkuCount||0),flaggedABCount:Number(r.flaggedABCount||0),flaggedMonthCount:Number(r.flaggedMonthCount||0),topItems:n.map(a=>{const o=a;return{sku:String(o.sku||""),month:String(o.month||""),abcClass:String(o.abcClass||"C"),deltaPct:Number(o.deltaPct||0),deltaUnits:Number(o.deltaUnits||0),deltaRevenue:Number(o.deltaRevenue||0)}}).filter(a=>a.sku&&a.month)}}function Kr(t){if(!t||typeof t!="object")return{toVersionId:null,foConflictsOpen:0};const r=t;return{toVersionId:r.toVersionId==null?null:String(r.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function es(){if(typeof window>"u"||!window.sessionStorage)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};try{const t=window.sessionStorage.getItem(yr);if(!t)return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null};const r=JSON.parse(t);return{errorAt:typeof r.errorAt=="string"?r.errorAt:null,routeKey:typeof r.routeKey=="string"?r.routeKey:null,routePath:typeof r.routePath=="string"?r.routePath:null,routeLabel:typeof r.routeLabel=="string"?r.routeLabel:null,message:typeof r.message=="string"?r.message:null}}catch{return{errorAt:null,routeKey:null,routePath:null,routeLabel:null,message:null}}}function Mn(){var Lt,Bt,zt,_t;const{state:t,loading:r,error:n,saving:a,saveWith:o}=Hs(),l=Ms(),[d,D]=qs.useMessage(),k=Gs("dashboard"),[E,p]=u.useState("next12"),[x,g]=u.useState(""),[j,O]=u.useState(""),[y,P]=u.useState([]),[K,he]=u.useState("dividend"),[ee,fe]=u.useState(""),[oe,ge]=u.useState(null),[we,Ie]=u.useState(""),[He,te]=u.useState({}),[Ee,is]=u.useState(()=>es()),[se,ls]=u.useState(()=>{const s=Ws("dashboard");return k?Qt(s):Nr.slice()}),X=t,H=u.useMemo(()=>$s(X,18),[t.settings]),ke=u.useMemo(()=>x&&H.includes(x)?x:H[H.length-1]||"",[x,H]),Z=u.useMemo(()=>Ts({state:X,months:H,targetMonth:ke||null}),[H,ke,X]),kt=u.useMemo(()=>new Map(Z.map(s=>[s.id,s])),[Z]),cs=u.useMemo(()=>{const s=new Map;return Z.forEach(i=>{const m=String(i.sku||"").trim().toLowerCase(),c=String(i.firstRiskMonth||"").trim(),S=String(i.orderMonth||"").trim();if(!m||!c||!S)return;const B=`${m}|${c}|${S}`;s.has(B)||s.set(B,i)}),s},[Z]),ds=u.useMemo(()=>{const s=new Map;return Z.forEach(i=>{const m=String(i.sku||"").trim().toLowerCase();!m||s.has(m)||s.set(m,i)}),s},[Z]),De=u.useMemo(()=>new Set(Z.map(s=>s.id)),[Z]),Re=u.useMemo(()=>Ks({state:X,suggestions:Z}),[Z,X]),Ke=u.useMemo(()=>Cs(Re),[Re]),nt=Ke.months||[],Dt=Ke.breakdown||[],St=Ke.actualComparisons||[],_=u.useMemo(()=>{const s=Yt.find(i=>i.value===E);return!s||s.count==null?nt:nt.slice(0,s.count)},[nt,E]),Ge=u.useMemo(()=>new Set(_),[_]),z=u.useMemo(()=>Dt.filter(s=>Ge.has(s.month)),[Dt,Ge]),us=u.useMemo(()=>St.filter(s=>Ge.has(s.month)),[St,Ge]),A=u.useMemo(()=>ss({state:X,months:_}),[X,_]),ae=u.useMemo(()=>mr({state:X,horizonMonths:12,runtimeErrorAt:Ee.errorAt,runtimeErrorRoute:Ee.routePath}),[Ee.errorAt,Ee.routePath,X]);u.useEffect(()=>{if(!H.length){g("");return}g(s=>s&&H.includes(s)?s:H[H.length-1])},[H]),u.useEffect(()=>{var s;if(!A.months.length){O("");return}if(!j||!A.monthMap.has(j)){const i=((s=A.months.find(m=>!m.robust))==null?void 0:s.month)||A.months[0].month;O(i)}},[A,j]),u.useEffect(()=>{if(!z.length){P([]);return}P(s=>{const i=new Set(z.map(c=>c.month)),m=s.filter(c=>i.has(c));return m.length?m:[z[0].month]})},[z]),u.useEffect(()=>{if(!_.length){fe("");return}(!ee||!_.includes(ee))&&fe(_[0])},[ee,_]),u.useEffect(()=>{Zs("dashboard",se)},[se]);const be=s=>{ls(Qt(Mr(s)))},C=u.useMemo(()=>!ee||!Number.isFinite(oe)||Number(oe)<=0?null:{month:ee,amount:Math.abs(Number(oe)),type:K,label:we.trim()||st(K)},[oe,we,ee,K]),L=u.useMemo(()=>Or(z,C),[C,z]),Nt=u.useMemo(()=>{const s=new Map;return L.forEach(i=>s.set(i.month,i)),s},[L]),ot=L[L.length-1]||null,ms=L.reduce((s,i)=>s+Number(i.inflow||0),0),hs=L.reduce((s,i)=>s+Number(i.outflow||0),0),Mt=L.reduce((s,i)=>s+Number(i.net||0),0),q=u.useMemo(()=>Fr(z),[z])*2,at=u.useMemo(()=>L.filter(s=>{var i;return(i=A.monthMap.get(s.month))==null?void 0:i.robust}).map(s=>Number(s.closing||0)),[A.monthMap,L]),At=u.useMemo(()=>!at.length||q<=0?null:Math.min(...at)-q,[q,at]),Ct=u.useMemo(()=>$r(L,A.monthMap),[A.monthMap,L]),it=u.useMemo(()=>{var s;return!C||q<=0?null:((s=L.find(i=>{const m=Je(i.month),c=Je(C.month);return m==null||c==null||m<c?!1:Number(i.closing||0)<q}))==null?void 0:s.month)||null},[q,L,C]),wt=!!C&&q>0&&!it,ie=t.forecast&&typeof t.forecast=="object"?t.forecast:{},We=u.useMemo(()=>{const s=structuredClone(ie||{});return Ls(s),s},[ie]),fs=u.useMemo(()=>Bs(We),[We]),lt=Kr(We.lastImpactSummary),It=String(We.activeVersionId||"").trim()||null,Ze=lt.toVersionId&&It&&lt.toVersionId===It?lt.foConflictsOpen:0,ct=typeof ie.lastImportAt=="string"?ie.lastImportAt:null,Y=Tr(ie.lastDriftSummary),Et=typeof ie.lastDriftReviewedComparedAt=="string"?ie.lastDriftReviewedComparedAt:null,dt=typeof ie.lastDriftReviewedAt=="string"?ie.lastDriftReviewedAt:null,ut=!!(Y.comparedAt&&Et&&Et===Y.comparedAt&&dt),Fe=ct?new Date(ct):null,gs=new Date,bs=24*60*60*1e3,Le=Fe?Math.floor((gs.getTime()-Fe.getTime())/bs):null,Pe=Fe?Le!=null&&Le<=35?"fresh":Le!=null&&Le<=45?"aging":"stale":"none",ps=Fe?`${Le} Tage seit Import`:"Kein Forecast-Import",Rt=Fe?Ir(Fe,30):null,b=j&&A.monthMap.get(j)||null,Ft=(b==null?void 0:b.coverage.stockIssues)||[],Pt=(b==null?void 0:b.coverage.orderDutyIssues)||[],Ot=b?b.checks.filter(s=>s.key!=="sku_coverage"):[],$t=b?b.blockers.filter(s=>s.checkKey!=="sku_coverage"):[],xs=u.useMemo(()=>{if(!b)return[];const s=b.coverage.projectionMode==="doh"?"DOH":"Units",i=b.coverage.stockIssueCount,m=b.coverage.orderDutyIssueCount,c=[{key:"stock",label:"Bestands-Check ok?",passed:i===0,description:i===0?`Alle aktiven SKUs im Monat ${$(b.month)} über Safety (${s}).`:`${i} SKU(s) mit OOS/unter Safety oder fehlendem Forecast.`},{key:"order_duty",label:"Bestellpflicht/Look-Ahead ok?",passed:m===0,description:m===0?"Keine SKU benötigt spätestens in diesem Monat eine neue FO/PO.":`${m} SKU(s) mit fälliger Bestellpflicht (inkl. Look-Ahead).`}],S=Ot.map(B=>({key:B.key,label:`${B.label} ok?`,passed:B.passed,description:B.detail}));return[...c,...S]},[b,Ot]),mt=xt(),Oe=kr(),Tt=Je(mt),ht=u.useMemo(()=>{var s;return((s=A.months.find(i=>!i.robust))==null?void 0:s.month)||j||_[0]||null},[A.months,j,_]),Be=u.useMemo(()=>vr({state:X,month:mt,todayIso:Oe}),[mt,X,Oe]);u.useEffect(()=>{const s=()=>is(es());return s(),window.addEventListener("v2:route-load-state",s),window.addEventListener("storage",s),()=>{window.removeEventListener("v2:route-load-state",s),window.removeEventListener("storage",s)}},[]),u.useEffect(()=>{te(s=>{const i=new Set(Be.map(S=>S.id));let m=!1;const c={};return Object.entries(s).forEach(([S,B])=>{if(!i.has(S)){m=!0;return}c[S]=B}),Be.forEach(S=>{c[S.id]||(c[S.id]=S.arrivalDate||Oe,m=!0)}),m?c:s})},[Be,Oe]);const Kt=u.useMemo(()=>Is({breakdown:z,state:Re,provisionalFoIds:De}),[De,Re,z]),vs=u.useMemo(()=>{const s=_.map(f=>$(f)),i=z.map(f=>Number(f.closing||0)),m=z.map(f=>{var I;return!!((I=A.monthMap.get(f.month))!=null&&I.robust)}),c=i.map((f,I)=>m[I]&&f>=0?f:null),S=i.map((f,I)=>m[I]&&f<0?f:null),B=i.map((f,I)=>!m[I]&&f>=0?f:null),le=i.map((f,I)=>!m[I]&&f<0?f:null),ce=C?z.map(f=>{var I;return Number(((I=Nt.get(f.month))==null?void 0:I.closing)||0)}):[],N=L.map(f=>Pr(Array.isArray(f.entries)?f.entries:[],De)),G=N.map(f=>-f.fixcost),ze=N.map(f=>-f.po),W=N.map(f=>-f.fo),R=N.map(f=>-f.phantomFo);return{tooltip:{trigger:"axis",formatter:f=>{const I=Array.isArray(f)?f:[f],pe=I[0],J=[`<div><strong>${(pe==null?void 0:pe.axisValueLabel)||""}</strong></div>`];return I.forEach(U=>{const V=U,de=Number(V==null?void 0:V.value);Number.isFinite(de)&&J.push(`<div>${(V==null?void 0:V.marker)||""}${(V==null?void 0:V.seriesName)||""}: ${F(de)}</div>`)}),J.join("")}},legend:{top:0},grid:{left:56,right:70,top:44,bottom:32},xAxis:{type:"category",data:s},yAxis:[{type:"value",name:"Cashflow",axisLabel:{formatter:f=>Ne(f)}},{type:"value",name:"Kontostand",position:"right",axisLabel:{formatter:f=>F(f)}}],series:[{name:"Einzahlungen",type:"bar",stack:"cash",data:L.map(f=>Number(f.inflow||0)),itemStyle:{color:"#27ae60"}},{name:"Fixkosten",type:"bar",stack:"cash",data:G,itemStyle:{color:"#7f1d1d"}},{name:"PO",type:"bar",stack:"cash",data:ze,itemStyle:{color:"#e74c3c"}},{name:"FO",type:"bar",stack:"cash",data:W,itemStyle:{color:"#f97316"}},{name:"Phantom FO",type:"bar",stack:"cash",data:R,itemStyle:{color:"#fbbf24"}},{name:"Netto",type:"line",smooth:!0,data:L.map(f=>Number(f.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:c,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:S,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend (nicht robust)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:B,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:le,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}},...C?[{name:"Simulation",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,data:ce,lineStyle:{width:2,type:"dashed",color:"#f59e0b"},itemStyle:{color:"#f59e0b"}}]:[]]}},[De,A.monthMap,L,Nt,C,z,_]),ys=u.useMemo(()=>[{header:"Monat",accessorKey:"month"},{header:"Plan Umsatz",accessorKey:"plannedRevenue",cell:({row:s})=>F(s.original.plannedRevenue)},{header:"Ist Umsatz",accessorKey:"actualRevenue",cell:({row:s})=>F(s.original.actualRevenue)},{header:"Delta Umsatz",accessorKey:"revenueDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.revenueDelta||0)<0?"v2-negative":void 0,children:F(s.original.revenueDelta)})},{header:"Delta Umsatz %",accessorKey:"revenueDeltaPct",cell:({row:s})=>Xe(s.original.revenueDeltaPct)},{header:"Plan Kontostand",accessorKey:"plannedClosing",cell:({row:s})=>F(s.original.plannedClosing)},{header:"Ist Kontostand",accessorKey:"actualClosing",cell:({row:s})=>F(s.original.actualClosing)},{header:"Delta Kontostand",accessorKey:"closingDelta",cell:({row:s})=>e.jsx("span",{className:Number(s.original.closingDelta||0)<0?"v2-negative":void 0,children:F(s.original.closingDelta)})}],[]),js=u.useMemo(()=>[{title:"Check",dataIndex:"label",key:"label",sorter:(s,i)=>String(s.label||"").localeCompare(String(i.label||""),"de-DE")},{title:"Status",dataIndex:"status",key:"status",width:130,sorter:(s,i)=>String(s.status||"").localeCompare(String(i.status||""),"de-DE"),render:s=>Ar(s)},{title:"Detail",dataIndex:"detail",key:"detail",width:320,sorter:(s,i)=>String(s.detail||"").localeCompare(String(i.detail||""),"de-DE"),render:s=>e.jsx(v,{type:"secondary",children:s})},{title:"",key:"route",width:132,render:(s,i)=>e.jsx(w,{size:"small",onClick:()=>l(_e({route:i.route,checkKey:i.key,month:(b==null?void 0:b.month)||null,mode:(b==null?void 0:b.coverage.projectionMode)||null})),children:"Öffnen"})}],[l,b==null?void 0:b.coverage.projectionMode,b==null?void 0:b.month]),ks=u.useMemo(()=>z.map(s=>{var ce;const i=Kt.get(s.month)||[],m=i.filter(N=>N.provisional),c=Dr.map(N=>({...N,rows:i.filter(G=>G.group===N.key)})).filter(N=>N.rows.length>0),S=i.filter(N=>N.group==="inflow"),B=i.filter(N=>N.amount<0),le=((ce=A.monthMap.get(s.month))==null?void 0:ce.robust)||!1;return{key:s.month,label:e.jsxs("div",{className:"v2-dashboard-pnl-header",children:[e.jsx(v,{strong:!0,children:$(s.month)}),e.jsxs(Q,{wrap:!0,children:[e.jsxs(h,{color:"green",children:["Einzahlungen: ",F(Ae(S))]}),e.jsxs(h,{color:"red",children:["Auszahlungen: ",F(Math.abs(Ae(B)))]}),m.length?e.jsxs(h,{color:"gold",children:["Vorbehaltlich: ",Ne(Ae(m))]}):null,e.jsxs(h,{color:s.net>=0?"green":"red",children:["Netto: ",F(s.net)]}),e.jsxs(h,{color:le?"green":"red",children:["Robust: ",le?"ja":"nein"]})]})]}),children:e.jsx("div",{className:"v2-dashboard-pnl-month",children:c.map(N=>{if(N.key==="po_fo"){const G=new Map;N.rows.forEach(W=>{const R=W.source==="fo"?"fo":"po",f=W.sourceId?String(W.sourceId):null,I=W.sourceNumber?String(W.sourceNumber):null,pe=`${R}:${f||I||W.label}`,J=G.get(pe);if(J){J.rows.push(W),!J.sourceId&&f&&(J.sourceId=f),!J.sourceNumber&&I&&(J.sourceNumber=I);return}G.set(pe,{source:R,sourceId:f,sourceNumber:I,rows:[W]})});const ze=Array.from(G.entries()).map(([W,R])=>{var Ut;const f=Ae(R.rows),I=R.rows.filter(M=>M.provisional),pe=I.map(M=>String(M.sourceId||"").trim()).find(M=>M&&De.has(M))||null,J=R.source==="fo"?R.sourceId&&De.has(R.sourceId)?R.sourceId:pe:null,U=J&&kt.get(J)||null,V=(Ut=R.rows.find(M=>M.tooltipMeta))==null?void 0:Ut.tooltipMeta,de=Array.from(new Set(R.rows.flatMap(M=>{var Ye;return((Ye=M.tooltipMeta)==null?void 0:Ye.aliases)||[]}).filter(Boolean))),gt=de.length>3?`${de.slice(0,3).join(", ")} +${de.length-3}`:de.join(", "),qe=ir({state:Re,source:R.source,sourceId:R.sourceId,sourceNumber:R.sourceNumber});return{key:W,label:e.jsxs("div",{className:"v2-dashboard-pnl-order-row",children:[e.jsxs("div",{className:"v2-dashboard-pnl-order-row-main",children:[e.jsxs(v,{strong:!0,children:[String(R.source).toUpperCase()," ",R.sourceNumber||R.sourceId||"—"]}),gt?de.length>3?e.jsx(Ce,{title:de.join(", "),children:e.jsxs(v,{type:"secondary",children:["· ",gt]})}):e.jsxs(v,{type:"secondary",children:["· ",gt]}):null]}),e.jsxs(Q,{size:6,children:[e.jsx(h,{color:f<0?"red":"green",children:Ne(f)}),I.length?e.jsx(h,{color:"gold",children:"Vorbehaltlich"}):null,U?e.jsx(h,{color:"orange",children:"Phantom FO"}):null,(V==null?void 0:V.units)!=null?e.jsxs(h,{children:["Stück: ",Me(V.units,0)]}):null]})]}),children:e.jsxs("div",{className:"v2-dashboard-pnl-order-detail",children:[U?e.jsx("div",{className:"v2-dashboard-pnl-phantom-hint",children:e.jsxs(Q,{wrap:!0,children:[e.jsx(h,{color:"gold",children:"Automatisch vorgeschlagen"}),e.jsxs(v,{type:"secondary",children:["Risikomonat ",$(U.firstRiskMonth)," · bestellen bis ",ye(U.latestOrderDate)]}),e.jsx(w,{size:"small",type:"primary",onClick:()=>l(Xt({sku:U.sku,month:s.month,suggestedUnits:U.suggestedUnits,requiredArrivalDate:U.requiredArrivalDate,recommendedOrderDate:U.recommendedOrderDate,source:"phantom_fo",phantomId:U.id,firstRiskMonth:U.firstRiskMonth,orderMonth:U.orderMonth,leadTimeDays:U.leadTimeDays,returnTo:"/v2/dashboard"})),children:"Prüfen & bestätigen"})]})}):null,qe?e.jsx("div",{className:"v2-dashboard-order-timeline-shell",children:e.jsx(Xs,{className:"v2-dashboard-order-timeline",items:qe.items,visibleStartMs:qe.visibleStartMs,visibleEndMs:qe.visibleEndMs,height:188})}):e.jsx(ne,{type:"info",showIcon:!0,message:`Keine Timeline-Daten für ${String(R.source).toUpperCase()} ${R.sourceNumber||R.sourceId||"—"} verfügbar.`}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Fällig"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:R.rows.map((M,Ye)=>{var Ht;const Vt=M.tooltipMeta?e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs("strong",{children:[String(M.source).toUpperCase()," ",M.sourceNumber||M.sourceId||"—"]})}),e.jsxs("div",{children:["Alias: ",M.tooltipMeta.aliases.join(", ")||"-"]}),e.jsxs("div",{children:["Stückzahl: ",M.tooltipMeta.units!=null?Me(M.tooltipMeta.units,0):"-"]}),e.jsxs("div",{children:["Fälligkeit: ",ye(M.tooltipMeta.dueDate)]})]}):null;return e.jsxs("tr",{children:[e.jsx("td",{children:Vt?e.jsx(Ce,{title:Vt,children:M.label}):M.label}),e.jsx("td",{className:M.amount<0?"v2-negative":void 0,children:Ne(M.amount)}),e.jsx("td",{children:ye((Ht=M.tooltipMeta)==null?void 0:Ht.dueDate)}),e.jsx("td",{children:M.provisional?e.jsx(h,{color:"gold",children:"Vorbehaltlich"}):M.paid==null?e.jsx(h,{children:"—"}):M.paid?e.jsx(h,{color:"green",children:"Bezahlt"}):e.jsx(h,{color:"gold",children:"Offen"})})]},`${W}-${Ye}`)})})]})})]})}});return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(v,{strong:!0,children:N.label}),e.jsx(h,{color:"blue",children:Ne(Ae(N.rows))})]}),e.jsx(re,{size:"small",items:ze,destroyInactivePanel:!0})]},`${s.month}-${N.key}`)}return e.jsxs("div",{className:"v2-dashboard-pnl-group",children:[e.jsxs("div",{className:"v2-dashboard-pnl-group-head",children:[e.jsx(v,{strong:!0,children:N.label}),e.jsx(h,{color:Ae(N.rows)<0?"red":"green",children:Ne(Ae(N.rows))})]}),e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Position"}),e.jsx("th",{children:"Betrag"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:N.rows.map((G,ze)=>e.jsxs("tr",{children:[e.jsx("td",{children:G.label}),e.jsx("td",{className:G.amount<0?"v2-negative":void 0,children:Ne(G.amount)}),e.jsx("td",{children:G.paid==null?e.jsx(h,{children:"—"}):G.paid?e.jsx(h,{color:"green",children:"Bezahlt"}):e.jsx(h,{color:"gold",children:"Offen"})})]},`${s.month}-${N.key}-${ze}`))})]})})]},`${s.month}-${N.key}`)})})}}),[l,kt,De,Re,Kt,A.monthMap,z]);async function Ds(){C&&(await o(s=>{const i=bt(s),m=i,c=C.label||st(C.type);if(C.type==="dividend"){const S=Array.isArray(m.dividends)?[...m.dividends]:[];S.push({id:`div-${Date.now()}`,month:C.month,label:c,amountEur:Math.abs(C.amount)}),m.dividends=S}else{const S=Array.isArray(m.extras)?[...m.extras]:[];S.push({id:`extra-${Date.now()}`,month:C.month,label:c,amountEur:-Math.abs(C.amount)}),m.extras=S}return i},`v2:dashboard:simulation-commit:${C.type}`),ge(null),Ie(""))}async function Ss(){Y.comparedAt&&await o(s=>{const i=bt(s),m=i;(!m.forecast||typeof m.forecast!="object")&&(m.forecast={});const c=m.forecast;return c.lastDriftReviewedAt=jr(),c.lastDriftReviewedComparedAt=Y.comparedAt,i},"v2:dashboard:forecast-drift-reviewed")}async function ft(s,i,m){try{await o(c=>{const S=bt(c),B=Array.isArray(S.pos)?S.pos:[];return S.pos=B.map(le=>{if(!le||typeof le!="object")return le;const ce=le;return String(ce.id||ce.poNo||"").trim()!==s?ce:{...ce,arrivalDate:i||null}}),S},m),d.success(i?"Wareneingang gespeichert.":"Wareneingang zurückgesetzt.")}catch(c){console.error(c),d.error(c instanceof Error?c.message:"Wareneingang konnte nicht gespeichert werden.")}}return((Bt=(Lt=t.settings)==null?void 0:Lt.featureFlags)==null?void 0:Bt.executiveDashboardV2)!==!1?e.jsxs("div",{className:"v2-page",children:[D,e.jsxs(T,{className:"v2-intro-card",children:[e.jsxs("div",{className:"v2-page-head",children:[e.jsxs("div",{children:[e.jsx(ue,{level:3,children:"Dashboard"}),e.jsx(ve,{children:"Executive-Cockpit für Kontostand, Robustheit und Maßnahmenpriorisierung. Nicht robuste Monate sind klar markiert."})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(v,{children:"PFO bis"}),e.jsx(Qe,{value:ke||void 0,onChange:s=>g(String(s||"")),options:H.map(s=>({value:s,label:$(s)})),style:{width:220,maxWidth:"100%"},disabled:!H.length})]}),e.jsxs("div",{className:"v2-toolbar-field",children:[e.jsx(v,{children:"Zeitraum"}),e.jsx(Qe,{value:E,onChange:s=>p(s),options:Yt.map(s=>({value:s.value,label:s.label})),style:{width:220,maxWidth:"100%"}})]})]}),e.jsxs("div",{className:"v2-toolbar",children:[e.jsxs("div",{className:"v2-toolbar-row",children:[e.jsx(w,{onClick:()=>l("/v2/forecast"),children:"Zur Absatzprognose"}),e.jsx(w,{onClick:()=>l("/v2/inventory/projektion"),children:"Zur Bestandsprojektion"}),e.jsx(w,{onClick:()=>l("/v2/orders/po"),children:"Zu Bestellungen"}),e.jsx(w,{onClick:()=>l("/v2/abschluss/eingaben"),children:"Zum Abschluss"})]}),e.jsxs(v,{type:"secondary",children:["Aktueller Betrachtungszeitraum: ",_.length," Monat(e). PFO-Ziel: ",ke?$(ke):"—","."]})]})]}),n?e.jsx(ne,{type:"error",showIcon:!0,message:n}):null,r?e.jsx(ne,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,Ze>0?e.jsx(ne,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${Ze} FOs prüfen`,description:e.jsx(w,{size:"small",onClick:()=>l("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"signals",label:"Executive Signals",children:e.jsxs("div",{className:"v2-dashboard-signal-grid",children:[e.jsxs(T,{className:"v2-dashboard-signal-card v2-dashboard-readiness-card",children:[e.jsx(xe,{title:et("Readiness Gate","Go/No-Go vor großer Datenpflege. Alle Checks müssen grün sein."),value:ae.ready?"Bereit":"Nicht bereit"}),e.jsxs(Q,{wrap:!0,children:[e.jsx(h,{color:ae.ready?"green":"red",children:ae.ready?"Go":"No-Go"}),e.jsxs(h,{color:ae.ready?"green":"gold",children:[ae.robustMonthsCount,"/",ae.robustRequiredCount," robuste Monate"]})]}),!ae.ready&&ae.blockers.length?e.jsx("div",{className:"v2-dashboard-readiness-blockers",children:ae.blockers.slice(0,2).map(s=>e.jsxs("div",{className:"v2-dashboard-readiness-blocker-item",children:[e.jsxs(v,{type:"secondary",children:[s.label,": ",s.message]}),e.jsx(w,{size:"small",onClick:()=>l(s.route),children:"Öffnen"})]},s.id))}):e.jsx(v,{type:"secondary",children:"Alle Gate-Checks erfüllt."})]}),e.jsxs(T,{className:"v2-dashboard-signal-card",children:[e.jsx(xe,{title:et("Robust bis","Letzter Monat, in dem alle Hard-Checks erfüllt sind. Danach ist der Kontostand nur Orientierung."),value:A.robustUntilMonth?$(A.robustUntilMonth):"—"}),e.jsxs(v,{type:"secondary",children:[A.robustMonthsCount,"/",A.totalMonths," Monate robust"]})]}),e.jsxs(T,{className:"v2-dashboard-signal-card",children:[e.jsx(xe,{title:et("Erster negativer Monat (robust)","Erster belastbarer Monat mit negativem Kontostand. Nicht robuste Monate werden dafür ignoriert."),value:Ct?$(Ct):"Keiner"}),e.jsx(v,{type:"secondary",children:"Simulation wird berücksichtigt"})]}),e.jsxs(T,{className:"v2-dashboard-signal-card",children:[e.jsx(xe,{title:et("Freier Cash nach Buffer","Minimaler belastbarer Kontostand minus Sicherheitsreserve aus 2 Monaten Fixkosten."),value:At!=null?F(At):"—"}),e.jsxs(v,{type:"secondary",children:["Buffer (2M Fixkosten): ",F(q)]})]}),e.jsxs(T,{className:"v2-dashboard-signal-card",children:[e.jsxs("div",{className:"v2-dashboard-forecast-status-head",children:[e.jsxs(v,{strong:!0,children:["Forecast Freshness",e.jsx(Ce,{title:"Ampel nach Importalter: Grün <=35 Tage, Gelb 36-45 Tage, Rot >45 Tage.",children:e.jsx(rs,{className:"v2-dashboard-inline-info"})})]}),e.jsx(h,{color:Pe==="fresh"?"green":Pe==="aging"?"gold":Pe==="stale"?"red":"default",children:Pe==="fresh"?"Grün":Pe==="aging"?"Gelb":Pe==="stale"?"Rot":"Keine Daten"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-status-meta",children:[e.jsxs("div",{children:["Baseline Forecast: ",fs]}),e.jsx("div",{children:ps}),e.jsxs("div",{children:["Letzter Import: ",ye(ct)]}),e.jsxs("div",{children:["Nächster Import empfohlen: ",Rt?Rt.toLocaleDateString("de-DE"):"—"]}),Ze>0?e.jsx("div",{children:e.jsxs(w,{size:"small",onClick:()=>l("/v2/forecast?panel=conflicts"),children:["Forecast-Änderung: ",Ze," FOs prüfen"]})}):null]})]})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"cashflow",label:"Kontostand & Cashflow",children:e.jsxs(T,{className:"v2-dashboard-chart-card",children:[e.jsx(ue,{level:4,children:"Kontostand & Cashflow"}),e.jsxs(Q,{wrap:!0,children:[e.jsxs(h,{color:"green",children:["Einzahlungen: ",F(ms)]}),e.jsxs(h,{color:"red",children:["Auszahlungen: ",F(hs)]}),e.jsxs(h,{color:Mt>=0?"green":"red",children:["Netto: ",F(Mt)]}),Z.length?e.jsxs(h,{color:"gold",children:["Phantom-FOs (vorbehaltlich): ",Z.length]}):null,ke?e.jsxs(h,{color:"gold",children:["PFO bis: ",$(ke)]}):null,e.jsxs(h,{color:C?"gold":"default",children:["Simulation: ",C?"aktiv":"aus"]})]}),e.jsxs("div",{className:"v2-dashboard-legend-help",children:[e.jsx(Ce,{title:"Durchgezogene Linie: belastbarer Kontostand (alle Hard-Checks bestanden).",children:e.jsx(h,{className:"v2-dashboard-legend-tag",children:"Linie solid = belastbar"})}),e.jsx(Ce,{title:"Gestrichelte Linie: orientierend, weil mindestens ein Hard-Check fehlt.",children:e.jsx(h,{className:"v2-dashboard-legend-tag",children:"Linie gestrichelt = orientierend"})}),e.jsx(Ce,{title:"Rot markiert: Kontostand liegt unter 0 im jeweiligen Zustand.",children:e.jsx(h,{className:"v2-dashboard-legend-tag",children:"Rot = unter 0"})})]}),e.jsx(As,{style:{height:380},option:vs})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"actions",label:"Action Center & Forecast Ops",children:e.jsxs(Gt,{gutter:[12,12],children:[e.jsx(Se,{xs:24,xl:14,children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Action Center"}),e.jsx(ve,{type:"secondary",children:"Priorisierte Maßnahmen, damit der Kontostand wieder belastbar wird."}),A.actions.length?e.jsx("div",{className:"v2-dashboard-actions",children:A.actions.map(s=>e.jsxs("div",{className:`v2-dashboard-action-card is-${s.severity}`,children:[e.jsxs("div",{children:[e.jsx(v,{strong:!0,children:s.title}),e.jsx("div",{className:"v2-dashboard-action-detail",children:s.detail}),e.jsxs("div",{className:"v2-dashboard-action-impact",children:["Impact: ",s.impact]})]}),e.jsxs("div",{className:"v2-dashboard-action-meta",children:[e.jsx(h,{color:s.severity==="error"?"red":"gold",children:s.count}),e.jsx(w,{size:"small",onClick:()=>{var i;return l(_e({route:s.route,actionId:s.id,month:ht,mode:ht&&((i=A.monthMap.get(ht))==null?void 0:i.coverage.projectionMode)||null}))},children:"Öffnen"})]})]},s.id))}):e.jsx(ne,{type:"success",showIcon:!0,message:"Keine offenen Hard-Blocker im gewählten Zeitraum."})]})}),e.jsx(Se,{xs:24,xl:10,children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Forecast Ops"}),e.jsxs(ve,{type:"secondary",children:["Monatlicher Import mit Drift-Alarm (A/B Fokus, Profil: ",Y.thresholdProfile,")."]}),e.jsxs(Q,{wrap:!0,style:{marginBottom:8},children:[e.jsxs(h,{color:ut?"green":"gold",children:["Drift-Review: ",ut?"geprüft":"offen"]}),dt?e.jsxs(h,{children:["Geprüft am: ",new Date(dt).toLocaleDateString("de-DE")]}):null,e.jsx(w,{size:"small",onClick:()=>{Ss()},disabled:!Y.comparedAt||ut||a,children:"Drift geprüft"})]}),e.jsxs("div",{className:"v2-dashboard-forecast-ops",children:[e.jsxs("div",{children:["Flagged SKUs: ",e.jsx("strong",{children:Me(Y.flaggedSkuCount,0)})]}),e.jsxs("div",{children:["Flagged A/B: ",e.jsx("strong",{children:Me(Y.flaggedABCount,0)})]}),e.jsxs("div",{children:["Flagged SKU-Monate: ",e.jsx("strong",{children:Me(Y.flaggedMonthCount,0)})]}),e.jsxs("div",{children:["Verglichen am: ",e.jsx("strong",{children:ye(Y.comparedAt)})]})]}),Y.topItems.length?e.jsxs("div",{className:"v2-dashboard-drift-list",children:[Y.topItems.slice(0,5).map((s,i)=>e.jsxs("div",{className:"v2-dashboard-drift-item",children:[e.jsxs("div",{children:[e.jsx(v,{strong:!0,children:s.sku}),e.jsxs(v,{type:"secondary",children:[" · ",$(s.month)," · ",s.abcClass]})]}),e.jsxs("div",{children:["ΔUnits ",Me(s.deltaUnits,0)," · ΔUmsatz ",F(s.deltaRevenue)," · Δ% ",Xe(s.deltaPct)]})]},`${s.sku}-${s.month}-${i}`)),e.jsx(w,{size:"small",onClick:()=>l("/v2/forecast"),children:"Zur Forecast-Prüfung"})]}):e.jsx(ne,{type:"success",showIcon:!0,message:"Keine kritischen Drift-Abweichungen im letzten Vergleich."})]})}),e.jsx(Se,{xs:24,xl:24,children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"PO Wareneingang bestätigen"}),e.jsx(ve,{type:"secondary",children:"Sichtbar sind POs mit ETA im aktuellen Monat sowie überfällige ETA ohne bestätigten Wareneingang."}),Be.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"PO"}),e.jsx("th",{children:"Supplier"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"Stückzahl"}),e.jsx("th",{children:"ETA"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Be.map(s=>{const i=He[s.id]||s.arrivalDate||Oe,m=/^\d{4}-\d{2}-\d{2}$/.test(i);return e.jsxs("tr",{children:[e.jsx("td",{children:s.poNumber||"PO"}),e.jsx("td",{children:s.supplier||"-"}),e.jsx("td",{children:s.skuAliases||"-"}),e.jsx("td",{children:Me(s.units,0)}),e.jsx("td",{children:ye(s.etaDate)}),e.jsx("td",{children:s.arrivalDate?e.jsxs(h,{color:"green",children:["Angekommen am ",ye(s.arrivalDate)]}):s.isOverdue?e.jsx(h,{color:"red",children:"Überfällig"}):e.jsx(h,{color:"gold",children:"Offen"})}),e.jsx("td",{children:e.jsxs(Q,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>{ft(s.id,Oe,"v2:dashboard:po-arrival-today")},disabled:a,children:"Heute"}),e.jsx(Wt,{type:"date",value:i,onChange:c=>{const S=c.target.value||"";te(B=>({...B,[s.id]:S}))},style:{width:160}}),e.jsx(w,{size:"small",onClick:()=>{m&&ft(s.id,i,"v2:dashboard:po-arrival-date")},disabled:a||!m||i===s.arrivalDate,children:"Datum setzen"}),s.arrivalDate?e.jsx(w,{size:"small",danger:!0,onClick:()=>{ft(s.id,null,"v2:dashboard:po-arrival-clear")},disabled:a,children:"Zurücksetzen"}):null]})})]},s.id)})})]})}):e.jsx(ne,{type:"success",showIcon:!0,message:"Keine offenen PO-Wareneingänge für den aktuellen Scope."})]})})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"robustness",label:"Robustheits-Matrix",children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Robustheits-Matrix"}),e.jsx(ve,{type:"secondary",children:"Ein Monat wird nur dann grün, wenn Bestands-Check und Look-Ahead-Bestellpflicht passen. Die Stufen folgen den Schwellen: Vollständig 100 %, Weitgehend ≥95 % ohne A/B-Blocker, Teilweise ≥80 %, sonst Unzureichend."}),e.jsx("div",{className:"v2-dashboard-robust-legend",children:["full","wide","partial","insufficient"].map(s=>{const i=yt(s);return e.jsxs("div",{className:"v2-dashboard-robust-legend-item",children:[e.jsx("span",{className:`v2-dashboard-robust-dot ${i.className}`}),e.jsx(v,{children:i.label})]},s)})}),e.jsx("div",{className:"v2-dashboard-robust-grid",children:A.months.map(s=>{const i=Je(s.month),m=i!=null&&Tt!=null&&i<Tt,c=yt(s.coverage.statusKey);return e.jsxs("button",{type:"button",className:["v2-dashboard-robust-item",j===s.month?"is-selected":"",c.className,m?"is-past":""].filter(Boolean).join(" "),onClick:()=>O(s.month),children:[e.jsxs("div",{className:"v2-dashboard-robust-item-head",children:[e.jsx("span",{children:$(s.month)}),e.jsxs(Q,{size:6,children:[e.jsx(h,{color:c.color,children:c.label}),m?e.jsx(h,{children:"Vergangen"}):null]})]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Coverage: ",Xe(s.coverage.ratio*100)," (",s.coverage.coveredSkus,"/",s.coverage.activeSkus,")"]}),e.jsxs("div",{className:"v2-dashboard-robust-item-meta",children:["Blocker SKUs: ",s.coverage.blockerCount," (A/B ",s.coverage.blockerAbCount," · C ",s.coverage.blockerCCount,")"]})]},s.month)})}),b?e.jsxs("div",{className:"v2-dashboard-robust-detail",children:[e.jsxs("div",{className:"v2-dashboard-robust-detail-head",children:[e.jsx(v,{strong:!0,children:$(b.month)}),e.jsxs(Q,{wrap:!0,children:[Cr(b.coverage.statusKey),e.jsxs(h,{children:["Coverage: ",Xe(b.coverage.ratio*100)]}),e.jsxs(h,{children:["Blocker: ",b.coverage.blockerCount]}),e.jsxs(h,{children:["A/B: ",b.coverage.blockerAbCount," · C: ",b.coverage.blockerCCount]}),b.coverage.overdueOrderDutySkuCount>0?e.jsxs(h,{color:"red",children:["Überfällig: ",b.coverage.overdueOrderDutySkuCount]}):null]})]}),e.jsx("div",{className:"v2-dashboard-robust-checklist",children:xs.map(s=>e.jsxs("div",{className:`v2-dashboard-robust-checklist-item ${s.passed?"is-pass":"is-fail"}`,children:[e.jsx("span",{className:"v2-dashboard-robust-check-icon",children:s.passed?"✅":"❌"}),e.jsxs("div",{children:[e.jsx(v,{strong:!0,children:s.label}),e.jsx("div",{children:e.jsx(v,{type:"secondary",children:s.description})})]})]},s.key))}),e.jsx(Ys,{size:"small",pagination:!1,rowKey:"key",columns:js,dataSource:b.checks}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(v,{strong:!0,children:["Bestands-Probleme in ",$(b.month)]}),Ft.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Problem"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Ft.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:wr(s)}),e.jsx("td",{children:e.jsxs(Q,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>l(_e({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:b.month,sku:s.sku,mode:b.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(w,{size:"small",onClick:()=>l(jt({issues:"all",sku:s.sku})),children:"Produkt öffnen"}),s.issueType==="forecast_missing"?e.jsx(w,{size:"small",onClick:()=>l(as({sku:s.sku,month:b.month})),children:"Absatzprognose öffnen"}):null]})})]},`${s.sku}:${s.issueType}`))})]})}):e.jsx(v,{type:"secondary",children:"Keine Bestandsprobleme in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsxs(v,{strong:!0,children:["Bestellpflicht in ",$(b.month)]}),Pt.length?e.jsx("div",{className:"v2-table-shell v2-scroll-host",children:e.jsxs("table",{className:"v2-stats-table","data-layout":"auto",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Alias"}),e.jsx("th",{children:"ABC"}),e.jsx("th",{children:"Erster Risikomonat"}),e.jsx("th",{children:"Spätester Bestellzeitpunkt"}),e.jsx("th",{children:"Warum Blocker"}),e.jsx("th",{children:"Aktionen"})]})}),e.jsx("tbody",{children:Pt.map(s=>{const i=String(s.sku||"").trim().toLowerCase(),m=`${i}|${String(s.firstRiskMonth||"").trim()}|${String(s.orderMonth||"").trim()}`,c=cs.get(m)||ds.get(i)||null;return e.jsxs("tr",{children:[e.jsx("td",{children:s.sku}),e.jsx("td",{children:s.alias}),e.jsx("td",{children:s.abcClass}),e.jsx("td",{children:$(s.firstRiskMonth)}),e.jsxs("td",{children:[ye(s.latestOrderDate)," (",$(s.orderMonth),")",s.overdue?e.jsx(h,{color:"red",style:{marginInlineStart:8},children:"Überfällig"}):null]}),e.jsx("td",{children:s.reason}),e.jsx("td",{children:e.jsxs(Q,{wrap:!0,children:[e.jsx(w,{size:"small",onClick:()=>l(_e({route:"/v2/inventory/projektion",checkKey:"sku_coverage",month:b.month,sku:s.sku,mode:b.coverage.projectionMode})),children:"Zur Bestandsprojektion"}),e.jsx(w,{size:"small",type:"primary",onClick:()=>l(Xt({sku:s.sku,month:b.month,suggestedUnits:(c==null?void 0:c.suggestedUnits)??s.shortageUnits,requiredArrivalDate:(c==null?void 0:c.requiredArrivalDate)??s.requiredArrivalDate,recommendedOrderDate:(c==null?void 0:c.recommendedOrderDate)??s.recommendedOrderDate,source:c?"phantom_fo":"inventory_projection",phantomId:(c==null?void 0:c.id)||null,firstRiskMonth:(c==null?void 0:c.firstRiskMonth)??s.firstRiskMonth,orderMonth:(c==null?void 0:c.orderMonth)??s.orderMonth,leadTimeDays:(c==null?void 0:c.leadTimeDays)??s.leadTimeDays,returnTo:"/v2/dashboard"})),children:"FO anlegen"}),e.jsx(w,{size:"small",onClick:()=>l(Rr({sku:s.sku,suggestedUnits:s.shortageUnits,requiredArrivalDate:s.requiredArrivalDate,recommendedOrderDate:s.recommendedOrderDate})),children:"PO öffnen"}),e.jsx(w,{size:"small",onClick:()=>l(jt({issues:"all",sku:s.sku})),children:"Produkt öffnen"})]})})]},`${s.sku}:${s.firstRiskMonth}:${s.orderMonth}`)})})]})}):e.jsx(v,{type:"secondary",children:"Keine fällige Bestellpflicht in diesem Monat."})]}),e.jsxs("div",{className:"v2-dashboard-blockers",children:[e.jsx(v,{strong:!0,children:"Weitere Hard-Checks"}),$t.length?e.jsx("div",{className:"v2-dashboard-blocker-list",children:$t.map(s=>e.jsxs("div",{className:"v2-dashboard-blocker-item",children:[e.jsxs("div",{children:[e.jsx(v,{children:s.message}),s.sku?e.jsxs(v,{type:"secondary",children:[" · ",s.sku]}):null]}),e.jsx(w,{size:"small",onClick:()=>l(_e({route:s.route,checkKey:s.checkKey,month:s.month,sku:s.sku||null,mode:b.coverage.projectionMode})),children:"Öffnen"})]},s.id))}):e.jsx(v,{type:"secondary",children:"Keine weiteren Hard-Check-Blocker."})]})]}):null]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"simulation",label:"Payout Planner (Simulation)",children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Payout Planner (Simulation)"}),e.jsx(ve,{type:"secondary",children:"Einmalige Dividenden oder CAPEX simulieren und optional als echten Eintrag übernehmen."}),e.jsxs("div",{className:"v2-dashboard-sim-grid",children:[e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(v,{children:"Typ"}),e.jsx(Qe,{value:K,onChange:s=>he(s),options:[{value:"dividend",label:"Dividende"},{value:"capex",label:"CAPEX"}]})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(v,{children:"Monat"}),e.jsx(Qe,{value:ee,onChange:s=>fe(s),options:_.map(s=>({value:s,label:$(s)}))})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(v,{children:"Betrag (EUR)"}),e.jsx(Js,{value:Number.isFinite(oe)?oe:null,onChange:s=>ge(typeof s=="number"?s:null),min:0,controls:!1,placeholder:"0"})]}),e.jsxs("div",{className:"v2-dashboard-sim-field",children:[e.jsx(v,{children:"Label"}),e.jsx(Wt,{value:we,onChange:s=>Ie(s.target.value),placeholder:st(K)})]})]}),e.jsxs("div",{className:"v2-dashboard-sim-status",children:[e.jsx(h,{color:C?"gold":"default",children:C?"Simulation aktiv":"Keine Simulation"}),e.jsxs(h,{color:q>0?"blue":"red",children:["Buffer-Ziel: ",F(q)]}),C&&q<=0?e.jsx(h,{color:"red",children:"Fixkostenbasis fehlt"}):null,C&&q>0?e.jsx(h,{color:wt?"green":"red",children:wt?"Sicher":`Kritisch ab ${it?$(it):"sofort"}`}):null]}),e.jsxs(Q,{children:[e.jsx(w,{onClick:()=>{ge(null),Ie("")},children:"Simulation zurücksetzen"}),e.jsx(w,{type:"primary",onClick:()=>{Ds()},disabled:!C,loading:a,children:"Als echten Eintrag übernehmen"})]})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"pnl",label:"Monatliche PnL (Drilldown)",children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Monatliche PnL (Drilldown)"}),e.jsx(ve,{type:"secondary",children:"Einzahlungen, PO/FO-Zahlungen, Fixkosten und Steuern je Monat. PO/FO-Positionen sind bis auf Milestone-Ebene aufklappbar."}),e.jsx(re,{className:"v2-dashboard-pnl-collapse",activeKey:y,onChange:s=>P(Array.isArray(s)?s.map(String):[String(s)]),items:ks})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"actuals",label:"Plan/Ist Drilldown",children:e.jsxs(T,{children:[e.jsx(ue,{level:4,children:"Plan/Ist Drilldown"}),e.jsx(ve,{type:"secondary",children:"Monatsvergleich zwischen geplantem und erfasstem Istwert aus den Monats-Ist-Daten."}),e.jsx(ws,{data:us,columns:ys,minTableWidth:980,tableLayout:"auto"})]})}]}),e.jsx(re,{className:"v2-dashboard-module-collapse",activeKey:se,onChange:be,items:[{key:"kpis",label:"KPI-Übersicht",children:e.jsxs(Gt,{gutter:[12,12],children:[e.jsx(Se,{xs:24,md:12,xl:6,children:e.jsx(T,{children:e.jsx(xe,{title:"Opening Balance",value:Number(((zt=Ke.kpis)==null?void 0:zt.opening)||0),formatter:s=>F(s)})})}),e.jsx(Se,{xs:24,md:12,xl:6,children:e.jsx(T,{children:e.jsx(xe,{title:"Sales Payout Ø",value:Number(((_t=Ke.kpis)==null?void 0:_t.salesPayoutAvg)||0),formatter:s=>F(s)})})}),e.jsx(Se,{xs:24,md:12,xl:6,children:e.jsx(T,{children:e.jsx(xe,{title:"Robuste Monate",value:`${A.robustMonthsCount}/${A.totalMonths}`})})}),e.jsx(Se,{xs:24,md:12,xl:6,children:e.jsx(T,{children:e.jsx(xe,{title:"Letzter Kontostand",value:Number((ot==null?void 0:ot.closing)||0),formatter:s=>F(s)})})})]})}]})]}):e.jsx("div",{className:"v2-page",children:e.jsx(ne,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{Mn as default};
