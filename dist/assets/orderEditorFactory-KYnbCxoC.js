import{g as $s,u as Us,by as Re,f as An,h as Rn,bz as Ls,e as ws,v as Ts,bA as Ps,o as Fs}from"./index-BD5jv3Ko.js";import{l as wt,c as Ze}from"./store-DyvXiC6t.js";import{a as Zn,p as xs,c as Ns,d as Ge,b as Ms}from"./prefill-CeICBsYK.js";import{a as Xe,o as As,p as Cn}from"./dateUtils-D7NmXfd-.js";import{c as Rs}from"./shipping-9Dzo5wwm.js";import{c as Gn}from"./costing-CmZrILJ2.js";import{d as pn}from"./deepEqual-CGWqzo0t.js";import{u as In,s as ve}from"./useDraftForm-PoBbqJlk.js";import{e as On}from"./productCompleteness-CNODPsSo.js";function Wn(t){if(!t)return null;const e=String(t).trim();return e?`pay-${e.replace(/^(pay-?)+/i,"")}`:null}function Cs(){return Wn(`pay-${Math.random().toString(36).slice(2,9)}`)}function _t(t){return String(t||"").trim()}function ye(t){if(!t)return!1;try{const e=new URL(t);return e.protocol==="http:"||e.protocol==="https:"}catch{return!1}}function Yn(t,e){if(!Number.isFinite(t))return null;const s=(e||[]).filter(f=>f&&Number.isFinite(Number(f.plannedEur)));if(!s.length)return null;const u=s.reduce((f,b)=>f+Number(b.plannedEur||0),0);if(u<=0){const f=Math.round(t/s.length*100)/100;return s.map(b=>({eventId:b.id,planned:0,actual:f}))}const l=s.map(f=>{const b=Number(f.plannedEur||0),D=b/u,E=Math.round(t*D*100)/100;return{eventId:f.id,planned:b,actual:E}}),r=l.reduce((f,b)=>f+b.actual,0),i=Math.round((t-r)*100)/100;if(i!==0){let f=l[l.length-1];l.length>1&&(f=l.reduce((b,D)=>D.planned>b.planned?D:b,f)),f.actual=Math.round((f.actual+i)*100)/100}return l}function Is({selectedEvents:t,actualRaw:e,invoiceUrl:s,folderUrl:u,paymentRecord:l,paymentIdValue:r,mergedPayments:i=[]}){const f={},b=t||[];if(!b.length)return f.events="Bitte mindestens ein Event auswÃ¤hlen.",{valid:!1,reason:f.events,fieldErrors:f};const D=b.reduce((m,_)=>{const P=Number(_.plannedEur);return m+(Number.isFinite(P)?P:0)},0),E=e?Zn(e):D;if(!Number.isFinite(E))return f.actual="Bitte einen gÃ¼ltigen Ist-Betrag eingeben.",{valid:!1,reason:f.actual,fieldErrors:f,sumPlanned:D};if(E<0)return f.actual="Ist-Betrag darf nicht negativ sein.",{valid:!1,reason:f.actual,fieldErrors:f,sumPlanned:D,parsedActual:E};if(E===0&&D>0)return f.actual="Ist-Betrag darf nicht 0 sein, wenn ein Soll-Betrag vorhanden ist.",{valid:!1,reason:f.actual,fieldErrors:f,sumPlanned:D,parsedActual:E};const S=Yn(E,b);if(!S)return f.actual="Konnte die Ist-BetrÃ¤ge nicht aufteilen.",{valid:!1,reason:f.actual,fieldErrors:f,sumPlanned:D,parsedActual:E};if(s&&!ye(s))return f.invoiceUrl="Invoice URL muss mit http:// oder https:// beginnen.",{valid:!1,reason:f.invoiceUrl,fieldErrors:f,sumPlanned:D,parsedActual:E};if(u&&!ye(u))return f.folderUrl="Folder URL muss mit http:// oder https:// beginnen.",{valid:!1,reason:f.folderUrl,fieldErrors:f,sumPlanned:D,parsedActual:E};const F=Wn(r)||(l==null?void 0:l.id)||Cs();return l!=null&&l.id&&F!==l.id&&i.find(_=>(_==null?void 0:_.id)===F)?(f.paymentId="Diese Payment-ID ist bereits vergeben.",{valid:!1,reason:f.paymentId,fieldErrors:f,sumPlanned:D,parsedActual:E}):{valid:!0,fieldErrors:f,selectedEvents:b,sumPlanned:D,parsedActual:E,allocations:S,invoiceUrl:s,folderUrl:u,requestedPaymentId:F}}function cn(t){return t?String(t).trim().replace(/\s+/g,"-").replace(/[\\/:*?"<>|]/g,"-").replace(/[-_]{2,}/g,"-").replace(/^[-_]+|[-_]+$/g,""):""}function Os(t,e){if(!t)return e;if(typeof t=="string"){const s=t.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(s)return s[0]}return t instanceof Date&&!Number.isNaN(t.getTime())?t.toISOString().slice(0,10):e}function _s(t){const e=Number(t);return Number.isFinite(e)?e.toFixed(2).replace(/\./g,"-").replace(/,/g,""):"0-00"}function _n(t){if(t==null)return 0;if(typeof t=="number")return t;const e=String(t).trim();if(!e)return 0;const s=e.replace(/\./g,"").replace(/,/g,"."),u=Number(s);return Number.isFinite(u)?u:0}function Bs(t,e=[]){const s=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];let u=null;s.length===1?u=s[0]:s.length>1&&(u=s.reduce((r,i)=>{const f=_n(i==null?void 0:i.units),b=_n(r==null?void 0:r.units);return f>b?i:r||i},null));let l=(u==null?void 0:u.sku)||"";if(!l){const r=s.find(i=>(i==null?void 0:i.sku)||(i==null?void 0:i.alias));l=(r==null?void 0:r.sku)||(r==null?void 0:r.alias)||""}if(l||(l=(t==null?void 0:t.sku)||""),!l&&(t!=null&&t.sku)){const r=e.find(i=>String((i==null?void 0:i.sku)||"").toLowerCase()===String((t==null?void 0:t.sku)||"").toLowerCase());l=(r==null?void 0:r.alias)||(r==null?void 0:r.sku)||""}if(!l&&e.length){const r=e.find(i=>(i==null?void 0:i.alias)||(i==null?void 0:i.sku));l=(r==null?void 0:r.alias)||(r==null?void 0:r.sku)||""}return l||"SKU"}function Ks(t,e){const s=String(t||"").toLowerCase(),u=String(e||"").toLowerCase();return u==="freight"?"Fracht":u==="eust"?"EUSt":u==="duty"?"Zoll":s.includes("deposit")||s.includes("anzahlung")?"Deposit":s.includes("balance")||s.includes("rest")?"Balance":s.includes("shipping")||s.includes("fracht")?"Fracht":s.includes("eust")?"EUSt":s.includes("zoll")||s.includes("duty")?"Zoll":(s.includes("other")||s.includes("sonst"),"Other")}function zs(t,e,s={}){if(!t||!e)return"";const u="YYYY-MM-DD",l=e.status==="paid"||e.status==="PAID"||e.isPaid===!0,r=l?e.paidDate:e.dueDate,i=Os(r,u),f=s.poNumber||(t==null?void 0:t.poNo)||(t==null?void 0:t.poNumber)||(t==null?void 0:t.id)||"",D=`PO${String(f||"").trim().replace(/^PO/i,"")}`,E=(t==null?void 0:t.supplier)||(t==null?void 0:t.supplierName)||(t==null?void 0:t.supplierId)||"",S=cn(E)||"Supplier",F=Bs(t,s.products||[]),m=cn(F)||"SKU",_=Ks(e.typeLabel||e.label,e.eventType||e.type),P=cn(_)||"Other",R=l?e.amountActualEur??e.paidEurActual:e.amountPlannedEur??e.plannedEur,j=`${_s(R)}EUR`,J=(w,$)=>`${[i,D,w,$,P,j].filter(Boolean).join("_")}.pdf`;let k=J(S,m);if(k.length>120){const w=S.slice(0,20),$=m.slice(0,25);k=J(w,$)}return k.replace(/[-_]{2,}/g,"-")}const js=new Set(["TOTAL_EUR","PER_UNIT_EUR","AUTO_FROM_LANDED"]);function Qt(t){if(t==null||t==="")return null;if(typeof t=="number")return Number.isFinite(t)?t:null;const e=String(t).trim();if(!e)return null;const s=e.includes(","),u=e.includes(".");let l=e;s?l=e.replace(/\./g,"").replace(",","."):u&&(l=e.replace(/,/g,""));const r=Number(l);return Number.isFinite(r)?r:null}function Ce(t){return Math.round(t*100)/100}function Hs(t,e){if(!e||!t)return null;const s=String(e).trim().toLowerCase();return t instanceof Map?t.get(s)||t.get(String(e).trim())||null:t[s]||t[String(e).trim()]||null}function Js(t){var s;const e=(s=t==null?void 0:t.timeline)==null?void 0:s.freightInputMode;return js.has(e)?e:(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR"}function Vs(t){var u;const e=Qt((u=t==null?void 0:t.timeline)==null?void 0:u.fxUsdPerEur);if(e!=null&&e>0)return e;const s=Qt(t==null?void 0:t.fxOverride);return s!=null&&s>0?s:null}function qs(t,e){var k,w,$;const s=new Set,u=[],l=Array.isArray(t==null?void 0:t.items)?t.items:[],r=Vs(t),i=r!=null&&r>0;i||s.add("MISSING_FX");let f=0,b=0,D=0;l.forEach(y=>{const c=String((y==null?void 0:y.sku)||"").trim(),x=Hs(e,c),C=Qt(x==null?void 0:x.landedUnitCostEur),B=Qt((y==null?void 0:y.unitCostUsd)??(y==null?void 0:y.stueckkostenUsd)),V=Qt(y==null?void 0:y.units),z=[];let U=null,et=null;if(i||z.push("MISSING_FX"),C==null&&(z.push("MISSING_LANDED_COST"),b+=1),i&&B!=null&&C!=null){const N=Gn({unitPriceUsd:B,landedCostEur:C,fxUsdPerEur:r});U=N.goodsCostEur,N.value!=null&&(N.warning&&(z.push("NEGATIVE_DERIVED_LOGISTICS"),D+=1),et=Ce(N.value),f+=Rs({units:V,shippingPerUnitEur:et}))}z.forEach(N=>s.add(N)),u.push({id:y==null?void 0:y.id,sku:c,units:V,landedUnitCostEur:C,goodsPerUnitEur:U!=null?Ce(U):null,derivedLogisticsPerUnitEur:et,issues:z})});const E=Ce(f),S=l.reduce((y,c)=>y+(Qt(c==null?void 0:c.units)||0),0),F=(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR",m=Qt(((k=t==null?void 0:t.timeline)==null?void 0:k.freightPerUnitEur)??(t==null?void 0:t.freightPerUnitEur))||0,_=Qt(((w=t==null?void 0:t.timeline)==null?void 0:w.freightTotalEur)??(t==null?void 0:t.freightEur))||0,P=Ce(F==="PER_UNIT_EUR"?m*S:_),R=(($=t==null?void 0:t.timeline)==null?void 0:$.includeFreight)!==!1,j=Js(t);return{estimatedFreightEur:R&&j==="AUTO_FROM_LANDED"?E:P,autoFreightEur:E,manualFreightEur:P,includeFreight:R,mode:j,issues:Array.from(s),lines:u,missingLandedCount:b,negativeCount:D,fxUsdPerEur:r}}function I(t,e=document){return e.querySelector(t)}function n(t,e={},s=[]){const u=document.createElement(t);for(const[l,r]of Object.entries(e))if(l==="class")u.className=r;else if(l==="dataset")for(const[i,f]of Object.entries(r))u.dataset[i]=f;else typeof r=="boolean"?(u[l]=r,r&&u.setAttribute(l,"")):l.startsWith("on")&&typeof r=="function"?u.addEventListener(l.slice(2),r):u.setAttribute(l,r);for(const l of[].concat(s))l!=null&&u.append(l.nodeType?l:document.createTextNode(String(l)));return u}let ft=[];function Tt(){ft=$s()}function fn(t){if(!t)return"â€”";const e=ft.find(s=>s&&s.sku&&s.sku.trim().toLowerCase()===String(t).trim().toLowerCase());return e?`${e.alias||e.sku} (${e.sku})`:t}function Zs(){Tt();const t=new Map;return ft.forEach(e=>{if(!(e!=null&&e.sku))return;const s=e.sku.trim().toLowerCase();t.set(s,e),t.set(e.sku.trim(),e)}),t}function hn(t){var s;const e=(s=t==null?void 0:t.timeline)==null?void 0:s.freightInputMode;return e==="TOTAL_EUR"||e==="PER_UNIT_EUR"||e==="AUTO_FROM_LANDED"?e:(t==null?void 0:t.freightMode)==="per_unit"?"PER_UNIT_EUR":"TOTAL_EUR"}function Xn(t,e=W()){if(!t)return{};(!t.timeline||typeof t.timeline!="object")&&(t.timeline={}),t.timeline.includeFreight==null&&(t.timeline.includeFreight=!0),t.timeline.freightInputMode=hn(t);const s=Number(t.fxOverride||e.fxRate||0),u=Number(t.timeline.fxUsdPerEur||0);return(!Number.isFinite(u)||u<=0)&&(Number.isFinite(s)&&s>0?t.timeline.fxUsdPerEur=s:Number.isFinite(e.fxRate)&&e.fxRate>0&&(t.timeline.fxUsdPerEur=e.fxRate)),t.timeline}function pe(t,e=W()){var D;if(!t)return null;const s=Xn(t,e),u=q(t.freightEur),l=q(t.freightPerUnitEur);s.freightTotalEur=Number.isFinite(u)?u:0,s.freightPerUnitEur=Number.isFinite(l)?l:0;const r=qs({...t,timeline:s},Zs()),i=new Set(r.issues||[]),f=Array.isArray(t.autoEvents)?t.autoEvents.find(E=>(E==null?void 0:E.type)==="freight"):null;if(f!=null&&f.id){const E=((D=t.paymentLog)==null?void 0:D[f.id])||{};E.status==="paid"&&!Number.isFinite(Number(E.amountActualEur))&&i.add("MISSING_PAYMENT_MAPPING")}r.issues=Array.from(i),t.derived={...t.derived||{},estimatedFreightEur:r.estimatedFreightEur,freightIssues:r.issues};const b=new Map;return r.lines.forEach(E=>{E.id&&b.set(E.id,E),E.sku&&b.set(`sku:${String(E.sku).toLowerCase()}`,E)}),Array.isArray(t.items)&&(t.items=t.items.map(E=>{const S=b.get(E.id)||b.get(`sku:${String(E.sku||"").toLowerCase()}`)||null;return{...E,derivedLogisticsPerUnitEur:(S==null?void 0:S.derivedLogisticsPerUnitEur)??null,derivedIssues:(S==null?void 0:S.issues)??[]}})),r}function mn(t){const e=wt(),s=Array.isArray(e.payments)?e.payments:[],u=(t==null?void 0:t.paymentDrafts)||{},l=s.map(r=>{const i=u[r==null?void 0:r.id];return i?{...r,...i}:r});return Object.values(u).forEach(r=>{l.some(i=>(i==null?void 0:i.id)===(r==null?void 0:r.id))||l.push(r)}),l}function Bn(t,e){const s=ve(t||{});return ua(s),Pt(s,e),Zt(s,e,s.milestones||[]),_e(s),Qe(s),s.paymentDrafts||(s.paymentDrafts={}),pe(s,e),s}function Gs(t){var u,l,r,i;if(!t)return[];const e=(u=ft.find(f=>{var b;return((b=f==null?void 0:f.sku)==null?void 0:b.trim().toLowerCase())===String(t.sku||"").trim().toLowerCase()}))==null?void 0:u.alias,s=[`SKU: ${t.sku||"â€”"}`,`Alias: ${e||"â€”"}`,`Einstand (EUR/Stk): ${t.landedUnitCostEur!=null?At(t.landedUnitCostEur):"â€”"}`,`Warenwert (EUR/Stk): ${t.goodsPerUnitEur!=null?At(t.goodsPerUnitEur):"â€”"}`,`Logistik / Stk. (EUR): ${t.derivedLogisticsPerUnitEur!=null?At(t.derivedLogisticsPerUnitEur):"â€”"}`];return(l=t.issues)!=null&&l.includes("MISSING_LANDED_COST")&&s.push("Einstandskosten fehlen"),(r=t.issues)!=null&&r.includes("NEGATIVE_DERIVED_LOGISTICS")&&s.push("Einstand < Warenwert (FX/EK prÃ¼fen)"),(i=t.issues)!=null&&i.includes("MISSING_FX")&&s.push("FX fehlt"),s}function Ws(t){var r;if(!t)return null;const e=ft.find(i=>i&&i.sku&&i.sku.trim().toLowerCase()===String(t).trim().toLowerCase());if(!e)return null;const s=(r=e.template)!=null&&r.fields?e.template.fields:e.template,u=(s==null?void 0:s.unitPriceUsd)??e.unitPriceUsd??null,l=typeof u=="number"?u:Number(u);return!Number.isFinite(l)||l<=0?null:l}function Ys(t){return!t||!t.length?"":`Logistik nicht berechenbar â€“ ${t.map(s=>s==="landedCostEur"?"Einstandspreis":s==="unitPriceUsd"?"Unit Price":s==="fxUsdPerEur"?"FX":s).join(", ")} fehlt`}function Qn(t){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];if(!e.length)return fn(t==null?void 0:t.sku);const s=Array.from(new Set(e.map(l=>((l==null?void 0:l.sku)||"").trim()).filter(Boolean)));if(!s.length)return fn(t==null?void 0:t.sku);const u=fn(s[0]);return s.length===1?u:`${u} +${s.length-1}`}function q(t){const e=xs(t);return e??NaN}function Ft(t){return Number(t||0).toLocaleString("de-DE",{style:"currency",currency:"EUR"})}function At(t){const e=Number(t||0);return Number.isFinite(e)?Ge(e,2):"0,00"}function tt(t){const e=t==null?"":String(t),s=q(e);return e.trim()?Number.isFinite(s)?Ns(s,2,{minimumFractionDigits:2,maximumFractionDigits:2}):e:""}function Se(t){return Number(t||0).toLocaleString("de-DE",{style:"currency",currency:"USD"})}function gt(t){const e=Number.isFinite(Number(t))?Number(t):q(t);return Number(e||0).toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:2})}function We(t){const e=typeof t=="number"?t:q(t);return!Number.isFinite(e)||e<=0?"":Number(e).toLocaleString("de-DE",{minimumFractionDigits:2,maximumFractionDigits:4})}function it(t){if(!t)return"â€”";let e;if(typeof t=="string"){const s=t.split("-");if(s.length===3){const[u,l,r]=s.map(Number);Number.isFinite(u)&&Number.isFinite(l)&&Number.isFinite(r)&&(e=new Date(Date.UTC(u,l-1,r)))}}else t instanceof Date&&(e=t);return!(e instanceof Date)||Number.isNaN(e.getTime())?"â€”":e.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})}function Xs(t){var e;return t?(e=navigator.clipboard)!=null&&e.writeText?navigator.clipboard.writeText(t).then(()=>!0).catch(()=>!1):new Promise(s=>{const u=document.createElement("textarea");u.value=t,u.setAttribute("readonly",""),u.style.position="absolute",u.style.left="-9999px",document.body.append(u),u.select();try{const l=document.execCommand("copy");u.remove(),s(l)}catch{u.remove(),s(!1)}}):Promise.resolve(!1)}function Kn(t){if(!t)return null;const e=String(t).trim(),s=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec(e);if(!s)return null;const[u,l,r,i]=s,f=Number(i),b=Number(r),D=Number(l);if(!Number.isFinite(f)||!Number.isFinite(b)||!Number.isFinite(D))return null;const E=new Date(Date.UTC(f,b-1,D));return Number.isNaN(E.getTime())?null:E}function ee(t){if(!t)return null;const e=String(t).split("-");if(e.length!==3)return null;const[s,u,l]=e.map(Number);return[s,u,l].every(r=>Number.isFinite(r))?new Date(Date.UTC(s,u-1,l)):null}function Ie(t){return!(t instanceof Date)||Number.isNaN(t.getTime())?null:t.toISOString().slice(0,10)}function zn(t){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return null;const e=t.getUTCFullYear(),s=String(t.getUTCMonth()+1).padStart(2,"0");return`${e}-${s}`}function Qs(t){if(!t)return"â€”";const[e,s]=String(t).split("-");return!e||!s?"â€”":`${s}/${e}`}function ta(t,e){var i;const s=t==null?void 0:t.cny;if(s!=null&&s.start&&(s!=null&&s.end)){const f=Cn(s.start),b=Cn(s.end);if(f&&b&&b>=f)return{start:f,end:b}}const u=(i=t==null?void 0:t.cnyBlackoutByYear)==null?void 0:i[String(e)];if(!u)return null;const l=ee(u.start),r=ee(u.end);return!(l instanceof Date)||Number.isNaN(l.getTime())||!(r instanceof Date)||Number.isNaN(r.getTime())||r<l?null:{start:l,end:r}}function ts(t,e,s){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return{prodDone:t,adjustmentDays:0,cnyStart:null,cnyEnd:null};const u=Math.max(0,Number(e||0)),l=Xe(t,u);if(!l)return{prodDone:t,adjustmentDays:0,cnyStart:null,cnyEnd:null};let r=0,i=null,f=null;const b=t.getUTCFullYear(),D=l.getUTCFullYear();for(let S=b;S<=D;S+=1){const F=ta(s,S);if(!F)continue;const m=As(t,l,F.start,F.end);m>0&&(r+=m,i=!i||F.start<i?F.start:i,f=!f||F.end>f?F.end:f)}return{prodDone:(r?Xe(l,r):l)||l,adjustmentDays:r,cnyStart:i,cnyEnd:f}}const es=["units","unitCostUsd","unitExtraUsd","extraFlatUsd","fxOverride","fxFeePct","transport","prodDays","transitDays","freightEur","freightMode","freightPerUnitEur","dutyRatePct","dutyIncludeFreight","eustRatePct","vatRefundEnabled","vatRefundLagMonths","ddp"],ea=["milestones","autoEvents","items"],na=[{key:"units",label:"StÃ¼ckzahl"},{key:"unitCostUsd",label:"StÃ¼ckkosten (USD)"},{key:"unitExtraUsd",label:"Zusatzkosten je StÃ¼ck (USD)"},{key:"extraFlatUsd",label:"Zusatzkosten pauschal (USD)"},{key:"fxOverride",label:"FX-Kurs"},{key:"fxFeePct",label:"FX-GebÃ¼hr (%)"},{key:"transport",label:"Transport"},{key:"prodDays",label:"Produktionstage"},{key:"transitDays",label:"Transit-Tage"},{key:"freightEur",label:"Fracht (â‚¬)"},{key:"freightMode",label:"Fracht-Modus"},{key:"freightPerUnitEur",label:"Logistik / Stk. (EUR)"},{key:"dutyRatePct",label:"Zoll (%)"},{key:"dutyIncludeFreight",label:"Fracht einbeziehen"},{key:"eustRatePct",label:"EUSt (%)"},{key:"vatRefundEnabled",label:"EUSt-Erstattung aktiv"},{key:"vatRefundLagMonths",label:"EUSt-Lag (Monate)"},{key:"ddp",label:"DDP"},{key:"items",label:"Positionen"},{key:"milestones",label:"Meilensteine"},{key:"autoEvents",label:"Importkosten-Einstellungen"}];function ns(t=[]){return t.map(e=>({...e,id:Math.random().toString(36).slice(2,9)}))}function ss(t=[]){return t.map(e=>({...e,id:`auto-${e.type||"evt"}-${Math.random().toString(36).slice(2,7)}`}))}function sa(t=[]){return t.map(e=>({...e,id:e.id||`item-${Math.random().toString(36).slice(2,9)}`}))}function jn(t,e){if(!e)return t;const s=JSON.parse(JSON.stringify(t));for(const u of es)e[u]!=null&&(s[u]=Array.isArray(e[u])?JSON.parse(JSON.stringify(e[u])):e[u]);return e.milestones&&(s.milestones=ns(e.milestones)),e.autoEvents&&(s.autoEvents=ss(e.autoEvents)),e.items&&(s.items=sa(e.items)),e.fxOverride==null&&t.fxOverride!=null&&(s.fxOverride=t.fxOverride),s}function aa(t,e){var i,f;const s=[],u={units:"StÃ¼ckzahl",unitCostUsd:"StÃ¼ckkosten (USD)",unitExtraUsd:"Zusatzkosten je StÃ¼ck (USD)",extraFlatUsd:"Zusatzkosten pauschal (USD)",fxOverride:"FX-Kurs",fxFeePct:"FX-GebÃ¼hr (%)",transport:"Transport",prodDays:"Produktionstage",transitDays:"Transit-Tage",freightEur:"Fracht (â‚¬)",freightMode:"Fracht-Modus",freightPerUnitEur:"Logistik / Stk. (EUR)",dutyRatePct:"Zoll (%)",dutyIncludeFreight:"Fracht einbeziehen",eustRatePct:"EUSt (%)",vatRefundEnabled:"EUSt-Erstattung aktiv",vatRefundLagMonths:"EUSt-Lag (Monate)",ddp:"DDP",milestones:"Meilensteine",autoEvents:"Importkosten-Einstellungen"},l=new Set(["unitCostUsd","unitExtraUsd","extraFlatUsd","freightEur","freightPerUnitEur"]),r=new Set(["fxFeePct","dutyRatePct","eustRatePct"]);for(const b of[...es,...ea]){const D=u[b]||b;if(b==="milestones"||b==="autoEvents"){const m=JSON.stringify(t[b]||[]),_=JSON.stringify(e[b]||[]);m!==_&&s.push({label:D,before:((i=t[b])==null?void 0:i.length)||0,after:((f=e[b])==null?void 0:f.length)||0,type:"list"});continue}const E=t[b],S=e[b];if(E==null&&S==null||E===S)continue;const F=m=>m==null?"â€”":l.has(b)?b==="freightEur"||b==="freightPerUnitEur"?Ft(q(m)):Se(q(m)):r.has(b)?`${gt(m)} %`:b==="fxOverride"?We(m):b==="freightMode"?m==="per_unit"?"Pro StÃ¼ck":"Gesamt":typeof m=="boolean"?m?"Ja":"Nein":String(m);F(E)!==F(S)&&s.push({label:D,before:F(E),after:F(S)})}return s}function Oe({title:t,content:e,actions:s=[]}){const u=n("div",{class:"po-modal-backdrop",role:"dialog","aria-modal":"true"}),l=n("div",{class:"po-modal"},[n("header",{class:"po-modal-header"},[n("h4",{},[t||""]),n("button",{class:"btn ghost",type:"button",onclick:()=>vt(u),"aria-label":"SchlieÃŸen"},["âœ•"])]),n("div",{class:"po-modal-body"},[e]),n("footer",{class:"po-modal-actions"},s.length?s:[n("button",{class:"btn",type:"button",onclick:()=>vt(u)},["SchlieÃŸen"])])]);u.append(l),document.body.append(u);const r=u.querySelector("button, [href], input, select, textarea");r&&r.focus();function i(b){b.key==="Escape"&&vt(u)}let f=!1;return u.addEventListener("mousedown",b=>{f=b.target===u}),u.addEventListener("mouseup",b=>{f&&b.target===u&&vt(u),f=!1}),u.addEventListener("keydown",i),u}function vt(t){t&&t.remove()}function ct(t){const e=q(t);return e<0?0:e>100?100:e}function Ee(t){return t?((!Array.isArray(t.items)||!t.items.length)&&(t.items=[{id:`item-${Math.random().toString(36).slice(2,9)}`,sku:t.sku||"",units:t.units??"0",unitCostUsd:t.unitCostUsd??"0,00",unitExtraUsd:t.unitExtraUsd??"0,00",extraFlatUsd:t.extraFlatUsd??"0,00",unitCostManuallyEdited:!1}]),t.items=t.items.map(e=>({id:e.id||`item-${Math.random().toString(36).slice(2,9)}`,sku:e.sku||"",units:e.units??"0",unitCostUsd:e.unitCostUsd??"0,00",unitExtraUsd:e.unitExtraUsd??"0,00",extraFlatUsd:e.extraFlatUsd??"0,00",unitCostManuallyEdited:e.unitCostManuallyEdited===!0})),t.items):[]}function Rt(t,e=W()){const s=Ee(t);let u=0,l=0,r=0,i=0,f=0;s.forEach((S,F)=>{const m=q(S.units),_=q(S.unitCostUsd),P=q(S.unitExtraUsd),R=q(S.extraFlatUsd),j=Number.isFinite(m)?m:0,J=Number.isFinite(_)?_:0,k=Number.isFinite(P)?P:0,w=Number.isFinite(R)?R:0;F===0&&(r=J,i=k,f=w),j>0&&(l+=j);const $=(J+k)*j+w;Number.isFinite($)&&(u+=$)}),u=Math.max(0,Math.round(u*100)/100);let b=(e==null?void 0:e.fxRate)||0;if(t&&t.fxOverride!=null&&t.fxOverride!==""){const S=typeof t.fxOverride=="number"?t.fxOverride:q(t.fxOverride);Number.isFinite(S)&&S>0&&(b=S)}const D=q(t==null?void 0:t.goodsEur),E=b>0?Math.round(u/b*100)/100:Number.isFinite(D)?Math.round(D*100)/100:0;return{usd:u,eur:E,fxRate:b,units:l,unitCost:r,unitExtra:i,extraFlat:f}}function Gt(t,e=Rt(t,W())){var r,i,f;if(!t)return 0;const s=hn(t),u=((r=t==null?void 0:t.timeline)==null?void 0:r.includeFreight)!==!1;if(s==="AUTO_FROM_LANDED"){const b=((i=t==null?void 0:t.derived)==null?void 0:i.estimatedFreightEur)??((f=pe(t))==null?void 0:f.estimatedFreightEur)??0;return u?Math.round(b*100)/100:0}if(s==="PER_UNIT_EUR"){const b=q(t==null?void 0:t.freightPerUnitEur),D=Number((e==null?void 0:e.units)||0),E=b*D;return Number.isFinite(E)?Math.round(E*100)/100:0}const l=q(t==null?void 0:t.freightEur);return Number.isFinite(l)?Math.round(l*100)/100:0}function ia(t,e=W()){var u;if(!t)return{total:0,missing:0,used:[],estimate:null};const s=pe(t,e);return{total:Math.round(((s==null?void 0:s.estimatedFreightEur)||0)*100)/100,missing:(s==null?void 0:s.missingLandedCount)||0,used:((u=s==null?void 0:s.lines)==null?void 0:u.map(l=>l.sku).filter(Boolean))||[],estimate:s}}function Pt(t,e=W()){var u,l,r,i;if(!t)return;if(Ee(t),t.items=t.items.map(f=>({...f,unitCostUsd:tt(f.unitCostUsd??"0,00"),unitExtraUsd:tt(f.unitExtraUsd??"0,00"),units:String(f.units??"0"),extraFlatUsd:tt(f.extraFlatUsd??"0,00"),unitCostManuallyEdited:f.unitCostManuallyEdited===!0})),t.fxOverride!=null&&t.fxOverride!==""){const f=typeof t.fxOverride=="number"?t.fxOverride:q(t.fxOverride);t.fxOverride=Number.isFinite(f)&&f>0?f:null}Rt(t,e);const s=Rt(t,e);t.goodsEur=tt(s.eur),t.goodsUsd=tt(s.usd),t.goodsValueUsd=s.usd,t.units=String(s.units||"0"),t.unitCostUsd=tt(((u=t.items[0])==null?void 0:u.unitCostUsd)??"0,00"),t.unitExtraUsd=tt(((l=t.items[0])==null?void 0:l.unitExtraUsd)??"0,00"),t.extraFlatUsd=tt(((r=t.items[0])==null?void 0:r.extraFlatUsd)??"0,00"),t.freightMode=t.freightMode==="per_unit"?"per_unit":"total",t.freightEur=tt(t.freightEur??"0,00"),t.freightPerUnitEur=tt(t.freightPerUnitEur??"0,00"),Xn(t,e),(!t.derived||typeof t.derived!="object")&&(t.derived={estimatedFreightEur:0,freightIssues:[]}),!t.sku&&((i=t.items[0])!=null&&i.sku)&&(t.sku=t.items[0].sku)}function W(){const t=wt(),e=t&&t.settings||{},s=e.paymentDueDefaults&&typeof e.paymentDueDefaults=="object"?e.paymentDueDefaults:{},u=s.po&&typeof s.po=="object"?s.po:{},l=Number(e.freightLagDays??0)||0,r=(b,D)=>{const E=String(b||"").trim().toUpperCase();return["ORDER_DATE","PROD_DONE","ETD","ETA"].includes(E)?E:D},i=(b,D=0)=>{const E=Number(b);return Number.isFinite(E)?Math.round(E):D},f=(b,D,E)=>{const S=u[b]&&typeof u[b]=="object"?u[b]:{};return{anchor:r(S.anchor,D),lagDays:i(S.lagDays,E)}};return{fxRate:q(e.fxRate??0)||0,fxFeePct:q(e.fxFeePct??0)||0,eurUsdRate:q(e.eurUsdRate??0)||0,dutyRatePct:q(e.dutyRatePct??0)||0,dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:q(e.eustRatePct??0)||0,vatRefundEnabled:e.vatRefundEnabled!==!1,vatRefundLagMonths:Number(e.vatRefundLagMonths??0)||0,freightLagDays:l,paymentDueDefaults:{po:{freight:f("freight","ETA",l),duty:f("duty","ETA",l),eust:f("eust","ETA",l),vatRefund:f("vatRefund","ETA",0)}},cny:e.cny?{start:e.cny.start||"",end:e.cny.end||""}:{start:"",end:""},cnyBlackoutByYear:e.cnyBlackoutByYear&&typeof e.cnyBlackoutByYear=="object"?structuredClone(e.cnyBlackoutByYear):{}}}function ra(t,e){const s=t.getUTCFullYear(),u=t.getUTCMonth();return new Date(Date.UTC(s,u+e,1))}function la(t){const e=t.getUTCFullYear(),s=t.getUTCMonth();return new Date(Date.UTC(e,s+1,0))}function Zt(t,e,s=[]){var _;t.autoEvents||(t.autoEvents=[]);const u=new Map(t.autoEvents.map(P=>[P.type,P])),l=((_=e==null?void 0:e.paymentDueDefaults)==null?void 0:_.po)||{},r=(P,R)=>{const j=String(P||"").trim().toUpperCase();return["ORDER_DATE","PROD_DONE","ETD","ETA"].includes(j)?j:R},i=(P,R=0)=>{const j=Number(P);return Number.isFinite(j)?Math.round(j):R},f=(P,R,j)=>{const J=l[P]&&typeof l[P]=="object"?l[P]:{};return{anchor:r(J.anchor,R),lagDays:i(J.lagDays,j)}},b=f("freight","ETA",e.freightLagDays||0),D=f("duty","ETA",e.freightLagDays||0),E=f("eust","ETA",e.freightLagDays||0),S=f("vatRefund","ETA",0),F=(P,R)=>{if(u.has(P)){const j=u.get(P);Object.assign(j,{type:P,...R,...j})}else{const j={id:`auto-${P}`,type:P,...R};t.autoEvents.push(j),u.set(P,j)}return u.get(P)};F("freight",{label:"Fracht",anchor:b.anchor,lagDays:b.lagDays,enabled:!0}),F("duty",{label:"Zoll",percent:e.dutyRatePct||0,anchor:D.anchor,lagDays:D.lagDays,enabled:!0}),F("eust",{label:"EUSt",percent:e.eustRatePct||0,anchor:E.anchor,lagDays:E.lagDays,enabled:!0}),F("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:S.anchor,lagDays:S.lagDays,lagMonths:e.vatRefundLagMonths||0,enabled:e.vatRefundEnabled!==!1});const m=s[0];if(F("fx_fee",{label:"FX-GebÃ¼hr",percent:e.fxFeePct||0,anchor:(m==null?void 0:m.anchor)||"ORDER_DATE",lagDays:(m==null?void 0:m.lagDays)||0,enabled:e.fxFeePct>0}),t.autoEvents=["freight","duty","eust","vat_refund","fx_fee"].map(P=>u.get(P)).filter(Boolean),t.ddp)for(const P of t.autoEvents)(P.type==="freight"||P.type==="duty"||P.type==="eust"||P.type==="vat_refund")&&(P.enabled!==!1&&(P._ddpEnabledBackup=P.enabled!==!1),P.enabled=!1);else for(const P of t.autoEvents)(P.type==="freight"||P.type==="duty"||P.type==="eust"||P.type==="vat_refund")&&P._ddpEnabledBackup!=null&&(P.enabled=P._ddpEnabledBackup,delete P._ddpEnabledBackup);return t.autoEvents}function _e(t){return t?((!t.paymentLog||typeof t.paymentLog!="object")&&(t.paymentLog={}),t.paymentLog):{}}function ua(t){!t||!Array.isArray(t.milestones)||t.milestones.forEach(e=>{!e||e.id||(e.id=`ms-${Math.random().toString(36).slice(2,9)}`)})}function as(t=[]){const e=new Map;return(t||[]).forEach(s=>{s!=null&&s.id&&e.set(s.id,s)}),e}function oa(t,e){if(!t||!e)return null;const s=t.paymentLog||{};return(!s[e]||typeof s[e]!="object")&&(s[e]={}),s[e].paymentInternalId||(s[e].paymentInternalId=`payrow-${Math.random().toString(36).slice(2,9)}`),t.paymentLog=s,s[e].paymentInternalId}function da(t,e){if(t.type==="freight")return"Fracht";if(t.type==="eust")return"EUSt";if(t.type==="vat_refund")return"EUSt-Erstattung";if(t.type==="duty"||t.type==="fx_fee")return"Other";const s=String((e==null?void 0:e.label)||t.label||"").toLowerCase();return s.includes("deposit")||s.includes("anzahlung")?"Deposit":s.includes("balance")||s.includes("rest")?"Balance":s.includes("shipping")||s.includes("fracht")?"Fracht":"Other"}function Hn(t,e,s,u=[],l={}){const r=(l==null?void 0:l.includeIncoming)===!0,i=(l==null?void 0:l.includeZeroAmount)===!0;_e(t);const f=Array.isArray(t.milestones)?t.milestones:[],b=new Map(f.map(S=>[S.id,S])),D=as(u);return bn(JSON.parse(JSON.stringify(t)),e,s).filter(S=>{if(!S)return!1;const F=Number(S.amount||0);return Number.isFinite(F)?F<0?!0:F>0?r:i:!1}).map(S=>{var k;const F=((k=t.paymentLog)==null?void 0:k[S.id])||{},m=oa(t,S.id),_=Number(S.amount||0),P=Math.abs(_),R=F.paymentId?D.get(F.paymentId):null,j=F.status==="paid"||R?"paid":"open",J=F.paidDate||(R==null?void 0:R.paidDate)||null;return{id:S.id,paymentInternalId:m,typeLabel:da(S,b.get(S.id)),label:S.label,dueDate:S.date||null,plannedEur:P,status:j,paidDate:J,paidEurActual:Number.isFinite(Number(F.amountActualEur))?Number(F.amountActualEur):null,method:(R==null?void 0:R.method)||F.method||null,paidBy:(R==null?void 0:R.payer)||F.payer||null,paymentId:(R==null?void 0:R.id)||F.paymentId||null,note:F.note||"",invoiceDriveUrl:(R==null?void 0:R.invoiceDriveUrl)||"",invoiceFolderDriveUrl:(R==null?void 0:R.invoiceFolderDriveUrl)||"",eventType:S.type||null,direction:_<0?"out":_>0?"in":"neutral"}})}function ca(t,e){let s=null;const u=/(\d+)(?!.*\d)/;for(const b of t||[]){const D=b==null?void 0:b[e];if(!D)continue;const E=u.exec(String(D));if(!E)continue;const S=Number(E[1]);Number.isFinite(S)&&(!s||S>s.numeric)&&(s={raw:String(D),numeric:S,digits:E[1],index:E.index??String(D).lastIndexOf(E[1])})}if(!s)return{raw:null,next:null};const l=String(s.numeric+1).padStart(s.digits.length,"0"),r=s.raw.slice(0,s.index),i=s.raw.slice(s.index+s.digits.length),f=`${r}${l}${i}`;return{raw:s.raw,next:f}}function qt(t,e){const s=new Date(t);return s.setDate(s.getDate()+Number(e||0)),s}function fe(t){if(!(t instanceof Date))return null;const e=t.getTime();return Number.isNaN(e)?null:new Date(e-t.getTimezoneOffset()*6e4).toISOString().slice(0,10)}function ge(t,e=W()){const s=new Date().toISOString().slice(0,10),u={id:Math.random().toString(36).slice(2,9),[t.numberField]:"",orderDate:s,sku:"",supplier:"",items:[{id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1}],goodsEur:"0,00",fxOverride:e.fxRate||null,timeline:{fxUsdPerEur:e.fxRate||null,includeFreight:!0,freightInputMode:"TOTAL_EUR",freightTotalEur:0,freightPerUnitEur:0},freightEur:"0,00",freightMode:"total",freightPerUnitEur:"0,00",prodDays:60,transport:"sea",transitDays:60,ddp:!1,cnyAdjustmentDays:0,etdManual:null,etaManual:null,dutyRatePct:e.dutyRatePct||0,dutyIncludeFreight:e.dutyIncludeFreight!==!1,eustRatePct:e.eustRatePct||0,vatRefundLagMonths:e.vatRefundLagMonths||0,vatRefundEnabled:e.vatRefundEnabled!==!1,fxFeePct:e.fxFeePct||0,milestones:[{id:Math.random().toString(36).slice(2,9),label:"Deposit",percent:30,anchor:"ORDER_DATE",lagDays:0},{id:Math.random().toString(36).slice(2,9),label:"Balance",percent:70,anchor:"PROD_DONE",lagDays:0}],paymentLog:{},derived:{estimatedFreightEur:0,freightIssues:[]},archived:!1};return Zt(u,e,u.milestones),Pt(u,e),u}function Jn(t,e){return t?e==="ORDER_DATE"?t.order:e==="PROD_DONE"?t.prodDone:e==="ETD"?t.etd:t.eta:null}function fa(t){const e=(t||[]).reduce((s,u)=>s+ct(u.percent||0),0);return Math.round(e*10)/10}function bn(t,e,s){var J;const u=Rt(t,s);let l=u.eur;if(!l){const k=q(t.goodsEur);k&&(l=k)}const r=Gt(t,u),i=t[e.numberField]?`${e.entityLabel} ${t[e.numberField]} â€“ `:"",f=Array.isArray(t.milestones)?t.milestones:[],b=Zt(t,s,f),D=[],E=te(t,s),S=f.map(k=>{const w=ct(k.percent),$=Jn(E,k.anchor||"ORDER_DATE");if(!($ instanceof Date)||Number.isNaN($.getTime()))return null;const y=qt($,Number(k.lagDays||0)),c=fe(y);if(!c)return null;const x=-(l*(w/100));return Number.isFinite(x)?{id:k.id,label:`${i}${k.label||"Zahlung"}`.trim(),date:c,amount:x,type:"manual",due:y,auto:!1,direction:x<=0?"out":"in"}:null}).filter(Boolean);D.push(...S.map(k=>({id:k.id,label:k.label,date:k.date,amount:k.amount,type:k.type,auto:!1,due:k.due,direction:k.direction})));const F=t.dutyIncludeFreight!==!1,m=typeof t.dutyRatePct=="number"?t.dutyRatePct:ct(t.dutyRatePct),_=typeof t.eustRatePct=="number"?t.eustRatePct:ct(t.eustRatePct),P=typeof t.fxFeePct=="number"?t.fxFeePct:ct(t.fxFeePct),R=Number(t.vatRefundLagMonths??s.vatRefundLagMonths??0)||0,j={};for(const k of b){if(!k||k.enabled===!1)continue;const w=k.anchor||"ETA",$=Jn(E,w);if(!(!($ instanceof Date)||Number.isNaN($.getTime()))){if(k.type==="freight"){const y=Gt(t,u);if(!y){const B=qt($,Number(k.lagDays||0)),V=fe(B);if(!V)continue;D.push({id:k.id,label:`${i}${k.label?` â€“ ${k.label}`:""}`.trim(),date:V,amount:0,type:"freight",auto:!0,due:B,direction:"out"});continue}const c=qt($,Number(k.lagDays||0)),x=fe(c);if(!x)continue;const C=-y;D.push({id:k.id,label:`${i}${k.label?` â€“ ${k.label}`:""}`.trim(),date:x,amount:C,type:"freight",auto:!0,due:c,direction:C<=0?"out":"in"});continue}if(k.type==="duty"){const y=ct(k.percent??m??s.dutyRatePct??0),c=l+(F?r:0),x=qt($,Number(k.lagDays||0)),C=-(c*(y/100)),B=fe(x);if(!B)continue;j.duty={amount:C,due:x},D.push({id:k.id,label:`${i}${k.label||"Zoll"}`.trim(),date:B,amount:C,type:"duty",auto:!0,due:x,direction:C<=0?"out":"in"});continue}if(k.type==="eust"){const y=ct(k.percent??_??s.eustRatePct??0),c=Math.abs(((J=j.duty)==null?void 0:J.amount)||0),x=l+r+c,C=qt($,Number(k.lagDays||0)),B=-(x*(y/100)),V=fe(C);if(!V)continue;j.eust={amount:B,due:C},D.push({id:k.id,label:`${i}${k.label||"EUSt"}`.trim(),date:V,amount:B,type:"eust",auto:!0,due:C,direction:B<=0?"out":"in"});continue}if(k.type==="vat_refund"){const y=j.eust;if(!y||y.amount===0||t.vatRefundEnabled===!1)continue;const c=ct(k.percent??100),x=Number((k.lagMonths??R)||0),C=qt(y.due||$,Number(k.lagDays||0)),B=ra(C,x),V=la(B),z=fe(V);if(!z)continue;const U=Math.abs(y.amount)*(c/100);j.vat={amount:U,due:V},D.push({id:k.id,label:`${i}${k.label||"EUSt-Erstattung"}`.trim(),date:z,amount:U,type:"vat_refund",auto:!0,due:V,direction:U<=0?"out":"in"});continue}if(k.type==="fx_fee"){const y=ct(k.percent??P??s.fxFeePct??0),c=qt($,Number(k.lagDays||0)),x=fe(c);if(!x)continue;const C=-(l*(y/100));D.push({id:k.id,label:`${i}${k.label||"FX"}`.trim(),date:x,amount:C,type:"fx_fee",auto:!0,due:c,direction:C<=0?"out":"in"});continue}}}return D.filter(k=>k&&Number.isFinite(k.amount)).sort((k,w)=>k.date===w.date?(k.label||"").localeCompare(w.label||""):k.date.localeCompare(w.date))}function pa(t,e={},s=[]){const u=n("div",{class:"po-event-table"});if(!t.length)return u.append(n("div",{class:"muted"},["Keine Ereignisse definiert."])),u;const l=as(s);u.append(n("div",{class:"po-event-head"},[n("span",{class:"po-event-col"},["Name"]),n("span",{class:"po-event-col"},["Datum"]),n("span",{class:"po-event-col amount"},["Betrag"]),n("span",{class:"po-event-col status"},["Status"]),n("span",{class:"po-event-col status"},["Transfer"])]));for(const r of t){const i=(e==null?void 0:e[r.id])||{},f=i.paymentId?l.get(i.paymentId):null,b=i.status==="paid"||f?"paid":"open",D=b==="paid"?"Bezahlt":"Offen",E=(f==null?void 0:f.id)||i.paymentId||"â€”";u.append(n("div",{class:"po-event-row"},[n("span",{class:"po-event-col"},[r.label]),n("span",{class:"po-event-col"},[it(r.due||r.date)]),n("span",{class:"po-event-col amount"},[Ft(r.amount)]),n("span",{class:"po-event-col status"},[n("span",{class:`po-status-pill ${b==="paid"?"is-paid":"is-open"}`},[D])]),n("span",{class:"po-event-col status"},[n("span",{class:"po-transaction-pill"},[E])])]))}return u}function ma(t,e,s,u,l,r={}){if(s.slug==="po"){ha(t,e,s,u,l,r);return}t.innerHTML="",Tt();const i=W(),f=Array.isArray(e)?e:[];for(const S of f)Pt(S,i);const b=f.map(S=>{const F=Rt(S,i);return{rec:S,totals:F}}),D=[{key:"number",label:`${s.entityLabel}-Nr.`},...s.slug==="po"||s.slug==="fo"?[{key:"product",label:"Produkt"}]:[],{key:"order",label:"Order"},{key:"timeline",label:"Timeline"},{key:"units",label:"StÃ¼ck",className:"num"},{key:"usd",label:"Summe USD",className:"num"},{key:"freight",label:"Fracht (â‚¬)",className:"num"},{key:"payments",label:"Zahlungen"},{key:"transport",label:"Transport"},{key:"actions",label:"Aktionen"}],E=ws({columns:D,rows:b,rowKey:S=>S.rec.id,renderCell:(S,F)=>{const m=S.rec;switch(F.key){case"number":return m[s.numberField]||"â€”";case"product":return Qn(m);case"order":return it(m.orderDate);case"timeline":return va(m,i);case"units":return Number(S.totals.units||0).toLocaleString("de-DE");case"usd":return Se(S.totals.usd);case"freight":return Ft(Gt(m,S.totals));case"payments":return String((m.milestones||[]).length);case"transport":return`${m.transport||"sea"} Â· ${m.transitDays||0}d`;case"actions":return n("div",{class:"table-actions ui-table-actions-nowrap"},[n("button",{class:"btn sm",onclick:()=>u(m)},["Bearbeiten"]),n("button",{class:"btn danger sm",onclick:()=>l(m)},["LÃ¶schen"])]);default:return"â€”"}}});t.append(E)}function ha(t,e,s,u,l,r={}){t.innerHTML="",Tt();const i=W(),f=Array.isArray(e)?e:[];f.forEach($=>{Pt($,i),Qe($)});const b=String(r.searchTerm||"").trim().toLowerCase(),D=r.showArchived===!0,S=f.filter($=>{if(!D&&$.archived)return!1;if(!b)return!0;const c=(Array.isArray($.items)?$.items:[]).map(C=>{const B=(C==null?void 0:C.sku)||"",V=ft.find(z=>{var U;return((U=z==null?void 0:z.sku)==null?void 0:U.trim().toLowerCase())===String(B).trim().toLowerCase()});return[B,(V==null?void 0:V.alias)||""].filter(Boolean).join(" ")});return[$[s.numberField],$.sku,$.supplier,...c].filter(Boolean).join(" ").toLowerCase().includes(b)}).map($=>({rec:$,totals:Rt($,i),freightEstimate:ia($,i)})),F=r.sortKey,m=r.sortDir;if(F&&m){const $=m==="desc"?-1:1;S.sort((y,c)=>{const x=y.rec,C=c.rec,B=et=>{var N;switch(et){case"number":return String(x[s.numberField]||"");case"order":return x.orderDate||"";case"supplier":return String(x.supplier||"");case"usd":return Number(y.totals.usd||0);case"freight":return Number(Gt(x,y.totals)||0);case"estFreight":return Number(((N=y.freightEstimate)==null?void 0:N.total)||0);case"payments":return(x.milestones||[]).length;case"transport":return String(x.transport||"");default:return""}},V=et=>{var N;switch(et){case"number":return String(C[s.numberField]||"");case"order":return C.orderDate||"";case"supplier":return String(C.supplier||"");case"usd":return Number(c.totals.usd||0);case"freight":return Number(Gt(C,c.totals)||0);case"estFreight":return Number(((N=c.freightEstimate)==null?void 0:N.total)||0);case"payments":return(C.milestones||[]).length;case"transport":return String(C.transport||"");default:return""}},z=B(F),U=V(F);return typeof z=="number"&&typeof U=="number"?(z-U)*$:String(z).localeCompare(String(U))*$})}const _=n("table",{class:"table-compact ui-table-standard ui-data-table po-list-table","data-ui-table":"true","data-sticky-cols":"1"}),P=$=>{if(!r.onUpdate)return;const y=F!==$?"asc":m==="asc"?"desc":m==="desc"?null:"asc";r.onUpdate({sortKey:y?$:null,sortDir:y})},R=$=>F!==$?"â†•":m==="asc"?"â†‘":"â†“",j=n("thead",{},[n("tr",{},[n("th",{style:"width:90px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("number")},["PO-Nr. ",R("number")])]),n("th",{style:"width:160px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("supplier")},["Lieferant ",R("supplier")])]),n("th",{style:"width:200px"},["Produkt/Items"]),n("th",{style:"width:110px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("order")},["Bestelldatum ",R("order")])]),n("th",{style:"width:180px"},["Timeline"]),n("th",{style:"width:80px",class:"num"},["StÃ¼ck"]),n("th",{style:"width:110px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("usd")},["Summe USD ",R("usd")])]),n("th",{style:"width:110px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("freight")},["Fracht (â‚¬) ",R("freight")])]),n("th",{style:"width:140px",class:"num"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("estFreight")},["GeschÃ¤tzte Fracht (â‚¬) ",R("estFreight")])]),n("th",{style:"width:120px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("payments")},["Zahlungen ",R("payments")])]),n("th",{style:"width:120px"},[n("button",{class:"po-sort-btn",type:"button",onclick:()=>P("transport")},["Transport ",R("transport")])]),n("th",{style:"width:210px"},["Aktionen"])])]),J=n("tbody");_.append(j,J);function k($){const y=Array.isArray($.milestones)?$.milestones:[],c=$.paymentLog||{};if(!y.length)return n("span",{class:"muted"},["â€”"]);const x=n("div",{class:"po-payment-badges"});return y.forEach(C=>{var U;const B=(C.label||"Z").trim(),V=B.split(" ")[0].slice(0,3),z=((U=c==null?void 0:c[C.id])==null?void 0:U.status)==="paid";x.append(n("span",{class:`po-payment-badge ${z?"is-paid":"is-open"}`,title:B},[V]))}),x}function w($,y){const c=wt(),x=Array.isArray(c[s.entityKey])?c[s.entityKey]:[],C=x.findIndex(B=>(B==null?void 0:B.id)===$.id||(B==null?void 0:B[s.numberField])===$[s.numberField]);C>=0&&(x[C]={...x[C],archived:y},c[s.entityKey]=x,Ze(c,{source:`${s.slug}:archive`,entityKey:`${s.slug}:${$[s.numberField]||$.id}`,action:"update"}),typeof r.onUpdate=="function"&&r.onUpdate())}if(!S.length){J.append(n("tr",{},[n("td",{colspan:"12",class:"muted"},["Keine Bestellungen gefunden."])])),t.append(_);return}S.forEach(({rec:$,totals:y,freightEstimate:c})=>{const x=Qn($),C=Ea($),B=ya($,i),V=`${$.transport||"sea"} Â· ${$.transitDays||0}d`,z=n("tr",{},[n("td",{class:"cell-ellipsis",title:$[s.numberField]||"â€”"},[$[s.numberField]||"â€”"]),n("td",{class:"cell-ellipsis",title:$.supplier||"â€”"},[$.supplier||"â€”"]),n("td",{class:"cell-ellipsis",title:C},[x||"â€”"]),n("td",{class:"cell-ellipsis",title:it($.orderDate)},[it($.orderDate)]),n("td",{class:"cell-ellipsis",title:B},[B]),n("td",{class:"cell-ellipsis num",title:String(y.units||0)},[Number(y.units||0).toLocaleString("de-DE")]),n("td",{class:"cell-ellipsis num",title:Se(y.usd)},[Se(y.usd)]),n("td",{class:"cell-ellipsis num",title:Ft(Gt($,y))},[Ft(Gt($,y))]),n("td",{class:"cell-ellipsis num",title:Ft((c==null?void 0:c.total)||0)},[Ft((c==null?void 0:c.total)||0)]),n("td",{class:"cell-ellipsis",title:"Zahlungen"},[k($)]),n("td",{class:"cell-ellipsis",title:V},[V]),n("td",{class:"po-actions-cell"},[n("div",{class:"po-table-actions"},[n("button",{class:"btn sm",type:"button",title:"Bearbeiten",onclick:()=>u($)},["Bearbeiten"]),n("button",{class:"btn sm secondary",type:"button",title:$.archived?"Reaktivieren":"Archivieren",onclick:()=>w($,!$.archived)},[$.archived?"Aktivieren":"Archivieren"]),n("button",{class:"btn sm danger",type:"button",title:"LÃ¶schen",onclick:()=>l($)},["LÃ¶schen"])])])]);J.append(z)}),t.append(_)}function Ye(t,e,s,u){var F;if(!t)return;Tt(),Ee(e);const l=pe(e,W()),r=new Map;(F=l==null?void 0:l.lines)==null||F.forEach(m=>{m.id&&r.set(m.id,m),m.sku&&r.set(`sku:${String(m.sku).toLowerCase()}`,m)}),t.innerHTML="";const i=(m,_)=>{m&&(m.classList.toggle("is-missing",_),m.title=_?"StÃ¼ckpreis fehlt im Produktstamm":"")},f=(m,_,{force:P}={})=>{if(!m||!_||m.unitCostManuallyEdited)return;const R=q(m.unitCostUsd);if(Number.isFinite(R)&&R>0&&!P){i(_,!1);return}const J=Ws(m.sku);J!=null?(m.unitCostUsd=tt(J),_.value=m.unitCostUsd,i(_,!1)):m.sku?(m.unitCostUsd="",_.value="",i(_,!0)):i(_,!1)},b=n("thead",{},[n("tr",{},[n("th",{},["SKU"]),n("th",{},["StÃ¼ck"]),n("th",{},["StÃ¼ckkosten (USD)"]),n("th",{},["Zusatz/ StÃ¼ck (USD)"]),n("th",{},["Pauschal (USD)"]),n("th",{},["Logistik / Stk. (EUR)"]),n("th",{},[""])])]),D=n("tbody"),E=n("datalist",{id:u});ft.forEach(m=>{E.append(n("option",{value:m.sku,label:m.alias?`${m.alias}`:m.sku}))}),e.items.forEach(m=>{const _=n("tr",{dataset:{itemId:m.id,unitCostManual:m.unitCostManuallyEdited?"true":"false"}}),P=m.type==="misc"?{value:m.sku||"",placeholder:"Freie Position"}:{list:u,value:m.sku||"",placeholder:"SKU"},R=n("input",P),j=n("input",{type:"number",min:"0",step:"1",value:m.units||"0"});j.addEventListener("input",()=>{m.units=j.value,s()});const J=n("input",{inputmode:"decimal",value:tt(m.unitCostUsd??"0,00"),placeholder:"0,00"});f(m,J,{force:!1}),J.addEventListener("blur",()=>{m.unitCostUsd=tt(J.value),J.value=m.unitCostUsd,m.unitCostManuallyEdited=J.value!=="",_.dataset.unitCostManual=m.unitCostManuallyEdited?"true":"false",i(J,!1),s()}),J.addEventListener("input",()=>{m.unitCostUsd=J.value,m.unitCostManuallyEdited=!0,_.dataset.unitCostManual="true",i(J,!1)}),R.addEventListener("input",()=>{m.sku=R.value.trim(),s()}),R.addEventListener("change",()=>{m.sku=R.value.trim(),f(m,J,{force:!0}),s()}),R.addEventListener("blur",()=>{m.sku=R.value.trim(),f(m,J,{force:!0}),s()});const k=n("input",{inputmode:"decimal",value:tt(m.unitExtraUsd??"0,00"),placeholder:"0,00"});k.addEventListener("blur",()=>{m.unitExtraUsd=tt(k.value),k.value=m.unitExtraUsd,s()}),k.addEventListener("input",()=>{m.unitExtraUsd=k.value});const w=n("input",{inputmode:"decimal",value:tt(m.extraFlatUsd??"0,00"),placeholder:"0,00"});w.addEventListener("blur",()=>{m.extraFlatUsd=tt(w.value),w.value=m.extraFlatUsd,s()}),w.addEventListener("input",()=>{m.extraFlatUsd=w.value});const $=r.get(m.id)||r.get(`sku:${String(m.sku||"").toLowerCase()}`)||null,y=is($),c=n("button",{class:"btn danger",type:"button"},["âœ•"]);c.addEventListener("click",()=>{(e.items||[]).length<=1||(e.items=e.items.filter(x=>x.id!==m.id),Ye(t,e,s,u),s())}),_.append(n("td",{},[R]),n("td",{},[j]),n("td",{},[J]),n("td",{},[k]),n("td",{},[w]),n("td",{dataset:{logisticsCell:"true"}},[y]),n("td",{},[c])),D.append(_)});const S=n("table",{class:"table-compact ui-table-standard ui-data-table po-items-table","data-ui-table":"true"},[b,D]);t.append(S,E)}function is(t){var D,E;const e=t==null?void 0:t.derivedLogisticsPerUnitEur,s=e!=null?At(e):"â€”",u=Gs(t),l=n("span",{class:"tooltip"},[n("button",{class:"tooltip-trigger",type:"button","aria-label":"Fracht Details"},["â„¹ï¸"]),n("span",{class:"tooltip-content"},u.map(S=>n("div",{},[S])))]),r=(D=t==null?void 0:t.issues)==null?void 0:D.includes("MISSING_LANDED_COST"),i=(E=t==null?void 0:t.issues)==null?void 0:E.includes("NEGATIVE_DERIVED_LOGISTICS"),f=r?"Einstandskosten fehlen":i?"Einstand < Warenwert (FX/EK prÃ¼fen)":"",b=f?n("span",{class:"cell-warning",title:f},["âš ï¸Ž"]):null;return n("div",{class:"po-logistics-cell"},[n("span",{class:"num"},[s]),b,l])}function ba(t,e){var l;if(!t||!e)return;const s=new Map;(l=e==null?void 0:e.lines)==null||l.forEach(r=>{r.id&&s.set(r.id,r),r.sku&&s.set(`sku:${String(r.sku).toLowerCase()}`,r)}),Array.from(t.querySelectorAll("[data-item-id]")).forEach(r=>{var S;const i=r.querySelector("[data-logistics-cell]");if(!i)return;const f=r.dataset.itemId,b=r.querySelector("input"),D=((S=b==null?void 0:b.value)==null?void 0:S.trim())||"",E=s.get(f)||s.get(`sku:${D.toLowerCase()}`)||null;i.innerHTML="",i.append(is(E))})}function te(t,e=W()){if(!t)return null;const s=ee(t.orderDate)||null;if(!s)return null;const u=Math.max(0,Number(t.prodDays||0)),l=Math.max(0,Number(t.transitDays||0)),r=ts(s,u,e),i=r.prodDone??qt(s,u),f=i,b=qt(f,l),D=ee(t.etdManual),E=ee(t.etaManual),S=D||f,F=E||b,m=Math.max(u+l+(r.adjustmentDays||0),1);return{order:s,prodDone:i,etd:S,eta:F,etdComputed:f,etaComputed:b,etdManual:D,etaManual:E,prodDays:u,transitDays:l,totalDays:m,cnyAdjustmentDays:r.adjustmentDays||0,cnyStart:r.cnyStart,cnyEnd:r.cnyEnd}}function ga(t,e,s=W()){if(!(t instanceof Date)||Number.isNaN(t.getTime()))return null;const u=Math.max(0,Number((e==null?void 0:e.prodDays)||0)),l=Math.max(0,Number((e==null?void 0:e.transitDays)||0)),r=Math.max(0,Number((s==null?void 0:s.defaultBufferDays)||0)),i=u+l+r;let f=Xe(t,-i);const b=ts(f,u,s);return b.adjustmentDays&&(f=Xe(f,-b.adjustmentDays)),f}function va(t,e){const s=te(t,e);return s?[`Order ${it(s.order)}`,`ETD ${it(s.etd)}`,`ETA ${it(s.eta)}`].join(" â€¢ "):"â€”"}function ya(t,e){const s=te(t,e);return s?`ETD ${it(s.etd)} â€¢ ETA ${it(s.eta)}`:"â€”"}function Ea(t){const e=Array.isArray(t==null?void 0:t.items)?t.items.filter(Boolean):[];return e.length?e.map(u=>{const l=(u==null?void 0:u.sku)||"",r=ft.find(i=>{var f;return((f=i==null?void 0:i.sku)==null?void 0:f.trim().toLowerCase())===String(l).trim().toLowerCase()});return r?r.alias?`${r.alias} (${r.sku})`:r.sku:l||"â€”"}).filter(Boolean).join(", "):(t==null?void 0:t.sku)||"â€”"}function Qe(t){t&&t.archived==null&&(t.archived=!1)}function Sa(t){return t==="air"?"âœˆï¸":t==="rail"?"ðŸš†":"ðŸš¢"}function Vn(t,e,s,u,l){if(!t||!e)return;const r=te(s,u);if(e.innerHTML="",t.innerHTML="",l&&(l.innerHTML="",l.hidden=!0),!r){e.append(n("span",{class:"muted"},["Bitte gÃ¼ltiges Bestelldatum eingeben."]));return}const i=n("div",{class:"po-timeline-summary-items"},[n("span",{class:"po-timeline-summary-item"},[n("strong",{},["Order"])," ",it(r.order)]),n("span",{class:"po-timeline-summary-item"},[n("strong",{},["ETD"])," ",it(r.etd)]),n("span",{class:"po-timeline-summary-item"},[n("strong",{},["ETA"])," ",it(r.eta)])]);if(e.append(i),l&&r.cnyAdjustmentDays>0){const x=r.cnyStart?it(r.cnyStart):"â€”",C=r.cnyEnd?it(r.cnyEnd):"â€”";l.textContent=`CNY berÃ¼cksichtigt: +${r.cnyAdjustmentDays} Tage Produktionspause. ETD/ETA angepasst. (${x} â€“ ${C})`,l.hidden=!1}const f=n("div",{class:"po-timeline-track"});f.append(n("div",{class:"po-timeline-base"}));const b=n("div",{class:"po-timeline-segments"}),D=r.totalDays,E=D?r.prodDays/D*100:0,S=D?r.transitDays/D*100:0,F=Math.max(0,Math.min(100,E)),m=Math.max(0,Math.min(100,S));if(r.prodDays>0&&b.append(n("div",{class:"po-timeline-segment production",style:`left:0%; width:${F}%`},[n("span",{class:"po-timeline-segment-icon","aria-hidden":"true"},["ðŸ­"]),n("span",{class:"sr-only"},[`Produktion ${r.prodDays} Tage`])])),r.transitDays>0){const x=F;b.append(n("div",{class:"po-timeline-segment transit",style:`left:${x}% ; width:${m}%`},[n("span",{class:"po-timeline-segment-icon","aria-hidden":"true"},[Sa(s.transport)]),n("span",{class:"sr-only"},[`Transport ${r.transitDays} Tage`])]))}f.append(b);const _=n("div",{class:"po-timeline-markers"}),P=(x,C,B,V,z="")=>{const U=n("div",{class:`po-timeline-marker po-timeline-marker-${V}${z?` ${z}`:""}`,style:`left:${B}%`},[n("span",{class:"po-timeline-dot"}),n("span",{class:"po-timeline-marker-label"},[n("strong",{},[x]),n("span",{},[it(C)])])]);_.append(U)};P("Order",r.order,0,"start");const R=F<=10?"start":F>=90?"end":"center";P("ETD",r.etd,F,R),P("ETA",r.eta,100,"end");const j=new Date,J=new Date(Date.UTC(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate())),k=24*60*60*1e3,w=(J.getTime()-r.order.getTime())/k,$=Math.max(0,Math.min(r.totalDays,w)),y=r.totalDays?$/r.totalDays*100:0,c=y<=10?"start":y>=90?"end":"center";P("Heute",J,y,c,"po-timeline-marker-current"),f.append(_),t.append(f)}function qn(t,e,s,u,l,r,i={}){const f=typeof i.showToast=="function"?i.showToast:c=>{typeof window<"u"&&window.alert&&window.alert(c)};t.innerHTML="",t.append(n("div",{class:"muted",style:"margin-bottom:6px"},["Zahlungsmeilensteine & Importkosten"])),Zt(e,r,e.milestones||[]);const b=bn(JSON.parse(JSON.stringify(e)),s,r),D=new Map(b.map(c=>[c.id,c])),E=n("table",{class:"table-compact ui-table-standard ui-data-table po-milestones-table","data-ui-table":"true"},[n("thead",{},[n("tr",{},[n("th",{},["Label"]),n("th",{},["%"]),n("th",{},["Anker"]),n("th",{},["Lag (Einheit)"]),n("th",{},["Datum"]),n("th",{},["Betrag (â‚¬)"]),n("th",{},["Aktion"])])])]),S=n("tbody",{});E.append(S);const F=Rt(e,r),m=F.eur||q(e.goodsEur);(e.milestones||[]).forEach((c,x)=>{const C=D.get(c.id),B=it((C==null?void 0:C.due)||(C==null?void 0:C.date)),V=(C==null?void 0:C.amount)??-(m*(ct(c.percent)/100)),z=n("tr",{dataset:{msId:c.id}},[n("td",{},[n("input",{value:c.label||"",dataset:{field:"label"},oninput:U=>{c.label=U.target.value,u()},onblur:U=>{c.label=U.target.value.trim(),u()}})]),n("td",{},[n("input",{type:"text",inputmode:"decimal",value:gt(c.percent??0),dataset:{field:"percent"},oninput:U=>{c.percent=U.target.value,u()},onblur:U=>{const et=ct(U.target.value);c.percent=et,U.target.value=gt(et),u()}})]),n("td",{},[(()=>{const U=n("select",{dataset:{field:"anchor"},onchange:et=>{c.anchor=et.target.value,u()}},[n("option",{value:"ORDER_DATE"},["ORDER_DATE"]),n("option",{value:"PROD_DONE"},["PROD_DONE"]),n("option",{value:"ETD"},["ETD"]),n("option",{value:"ETA"},["ETA"])]);return U.value=c.anchor||"ORDER_DATE",U})()]),n("td",{},[n("div",{class:"lag-field"},[n("input",{type:"number",value:String(c.lagDays||0),dataset:{field:"lag"},oninput:U=>{c.lagDays=Number(U.target.value||0),u()},onblur:U=>{const et=Number.isFinite(Number(U.target.value))?Number(U.target.value):0;U.target.value=String(et),c.lagDays=et,u()}}),n("span",{class:"muted"},["Tage"])])]),n("td",{dataset:{role:"ms-date"}},[B]),n("td",{dataset:{role:"ms-amount"}},[Ft(V)]),n("td",{},[n("button",{class:"btn danger",onclick:()=>{e.milestones.splice(x,1),u()}},["Entfernen"])])]);S.append(z)}),(e.autoEvents||[]).forEach(c=>{const x=D.get(c.id),C=c.type==="freight"?-(Gt(e,F)||0):0,B=it((x==null?void 0:x.due)||(x==null?void 0:x.date)),V=(x==null?void 0:x.amount)??C,z=c.enabled!==!1,U=c.type==="vat_refund"?Number(c.lagMonths??e.vatRefundLagMonths??r.vatRefundLagMonths??0):Number(c.lagDays||0),et=n("tr",{dataset:{msId:c.id},class:`auto-ms${z?"":" disabled"}`},[n("td",{},[n("input",{value:c.label||"",dataset:{field:"label"},oninput:N=>{c.label=N.target.value,u()},onblur:N=>{c.label=N.target.value.trim(),u()}})]),c.type==="freight"?n("td",{},[n("span",{class:"muted"},["â€”"])]):n("td",{},[n("input",{type:"text",inputmode:"decimal",value:gt(c.percent??0),dataset:{field:"percent"},oninput:N=>{c.percent=N.target.value,u()},onblur:N=>{const Y=ct(N.target.value);c.percent=Y,N.target.value=gt(Y),u()}})]),n("td",{},[(()=>{const N=n("select",{dataset:{field:"anchor"},onchange:Y=>{c.anchor=Y.target.value,u()}},[n("option",{value:"ORDER_DATE"},["ORDER_DATE"]),n("option",{value:"PROD_DONE"},["PROD_DONE"]),n("option",{value:"ETD"},["ETD"]),n("option",{value:"ETA"},["ETA"])]);return N.value=c.anchor||"ETA",N})()]),n("td",{},[n("div",{class:"lag-field"},[c.type==="vat_refund"?n("input",{type:"number",min:"0",value:String(U),dataset:{field:"lagMonths"},oninput:N=>{c.lagMonths=Number(N.target.value||0),u()}}):n("input",{type:"number",value:String(U),dataset:{field:"lag"},oninput:N=>{c.lagDays=Number(N.target.value||0),u()},onblur:N=>{const Y=Number.isFinite(Number(N.target.value))?Number(N.target.value):0;N.target.value=String(Y),c.lagDays=Y,u()}}),n("span",{class:"muted"},[c.type==="vat_refund"?"Monate":"Tage"])])]),n("td",{dataset:{role:"ms-date"}},[B]),n("td",{dataset:{role:"ms-amount"}},[Ft(V)]),n("td",{},[n("label",{class:"inline-checkbox"},[n("input",{type:"checkbox",checked:z,onchange:N=>{const Y=N.target.checked;c.enabled=Y,Y?delete c._ddpEnabledBackup:c._ddpEnabledBackup=!1,u()}})," Aktiv"])])]);S.append(et)}),t.append(E);const _=n("button",{class:"btn",style:"margin-top:8px",onclick:()=>{const c=(e.milestones||[]).length,x=Math.random().toString(36).slice(2,9);e.milestones.push({id:x,label:`Milestone ${c+1}`,percent:0,anchor:"ETA",lagDays:0}),u({focusInfo:{id:x,field:"label"}})}},["+ Zahlung hinzufÃ¼gen"]);t.append(_);const P=fa(e.milestones),R=P!==100,j=n("div",{dataset:{role:"ms-sum"},style:`margin-top:8px;font-weight:600;${R?"color:#c23636":"color:#0f9960"}`},[R?`Summe: ${P}% â€” Bitte auf 100% anpassen.`:"Summe: 100% âœ“"]);t.append(j);const J=Hn(e,s,r,mn(e));_e(e);const k=n("div",{class:"po-payments-section"},[n("h4",{},["Zahlungen"]),n("p",{class:"muted"},["Markiere Zahlungen als bezahlt und ergÃ¤nze Ist-Daten fÃ¼r die Buchhaltung."])]),w=n("table",{class:"table-compact ui-table-standard ui-data-table po-payments-table","data-ui-table":"true"},[n("thead",{},[n("tr",{},[n("th",{},["Typ"]),n("th",{},["FÃ¤llig am"]),n("th",{},["Geplant (EUR)"]),n("th",{},["Status"]),n("th",{},["Bezahlt am"]),n("th",{},["Ist (EUR)"]),n("th",{},["Methode"]),n("th",{},["Paid by"]),n("th",{},["Transfer"]),n("th",{},["Dateiname (Vorschlag)"]),n("th",{},["Aktion"])])])]),$=n("tbody");w.append($);function y(c){var h;const x=typeof window<"u"&&window.__DEBUG_FORMS__===!0,C=mn(e),B=Hn(e,s,r,C),V=c?((h=e.paymentLog)==null?void 0:h[c.id])||{}:{},z=V.paymentId||(c==null?void 0:c.paymentId)||null,U=z&&C.find(T=>(T==null?void 0:T.id)===z)||null,et=(U==null?void 0:U.id)||z||null,N=new Set,Y=(U==null?void 0:U.paidDate)||V.paidDate||new Date().toISOString().slice(0,10),bt=(U==null?void 0:U.method)||V.method||"",Wt=(U==null?void 0:U.payer)||V.payer||"",Yt=(U==null?void 0:U.note)||V.note||"",Be=(U==null?void 0:U.id)||V.paymentId||"",Ke=(U==null?void 0:U.invoiceDriveUrl)||"",ke=(U==null?void 0:U.invoiceFolderDriveUrl)||"",ne=n("input",{type:"date",value:Y}),ut=n("select",{},[n("option",{value:""},["â€”"]),n("option",{value:"Alibaba Trade Assurance"},["Alibaba Trade Assurance"]),n("option",{value:"Wise/Transferwise"},["Wise/Transferwise"]),n("option",{value:"PayPal"},["PayPal"]),n("option",{value:"Bank Transfer"},["Bank Transfer"]),n("option",{value:"Credit Card"},["Credit Card"]),n("option",{value:"Other"},["Other"])]);bt&&!Array.from(ut.options).some(T=>T.value===bt)&&ut.append(n("option",{value:bt},[bt])),ut.value=bt;const pt=n("select",{},[n("option",{value:""},["â€”"]),n("option",{value:"Pierre"},["Pierre"]),n("option",{value:"Patrick"},["Patrick"])]);Wt&&!Array.from(pt.options).some(T=>T.value===Wt)&&pt.append(n("option",{value:Wt},[Wt])),pt.value=Wt;const $t=n("input",{type:"text",inputmode:"decimal",placeholder:"0,00"});Number.isFinite(Number(U==null?void 0:U.amountActualEurTotal))?$t.value=Ge(Number(U.amountActualEurTotal),2):Number.isFinite(Number(c==null?void 0:c.paidEurActual))&&($t.value=Ge(Number(c.paidEurActual),2));const yt=n("textarea",{rows:"2",placeholder:"Notiz (optional)"},[Yt]),rt=n("input",{type:"text",placeholder:"pay-..."});rt.value=Be;const Et=n("input",{type:"url",placeholder:"https://drive.google.com/..."});Et.value=Ke;const xt=n("input",{type:"url",placeholder:"https://drive.google.com/..."});xt.value=ke;const Xt=n("a",{class:"btn secondary sm",target:"_blank",rel:"noopener noreferrer"},["Open Invoice"]),se=n("a",{class:"btn secondary sm",target:"_blank",rel:"noopener noreferrer"},["Open Folder"]),Bt=n("div",{class:"po-payment-summary muted"}),Kt=n("table",{class:"table-compact ui-table-standard ui-data-table po-payment-allocation","data-ui-table":"true"},[n("thead",{},[n("tr",{},[n("th",{},["Event"]),n("th",{},["Geplant (EUR)"]),n("th",{},["Ist (EUR)"])])])]),Nt=n("tbody");Kt.append(Nt);function me(){Nt.innerHTML="";const T=B.filter(Q=>N.has(Q.id));if(!T.length){Nt.append(n("tr",{},[n("td",{colspan:"3",class:"muted"},["Bitte Events auswÃ¤hlen, um die Aufteilung zu sehen."])]));return}const O=Zn($t.value),nt=Number.isFinite(O)?Yn(O,T):null;T.forEach(Q=>{const St=nt==null?void 0:nt.find(ot=>ot.eventId===Q.id);Nt.append(n("tr",{},[n("td",{},[Q.label]),n("td",{},[At(Q.plannedEur)]),n("td",{},[St?Ge(St.actual,2):"â€”"])]))})}function zt(){const T=B.filter(nt=>N.has(nt.id)),O=T.reduce((nt,Q)=>nt+Number(Q.plannedEur||0),0);Bt.textContent=T.length?`AusgewÃ¤hlt: ${T.length} Events Â· Geplant ${At(O)} EUR`:"Bitte mindestens ein Event auswÃ¤hlen.",me()}const Ct=n("div",{class:"po-payment-event-list"}),De=B;Array.isArray(U==null?void 0:U.coveredEventIds)&&U.coveredEventIds.forEach(T=>{T&&N.add(T)}),et&&Object.entries(e.paymentLog||{}).forEach(([T,O])=>{(O==null?void 0:O.paymentId)===et&&N.add(T)}),!N.size&&(c!=null&&c.id)&&N.add(c.id);const ae=(T,O)=>{O===!0?N.add(T):O===!1||N.has(T)?N.delete(T):N.add(T),zt(),It()};De.forEach(T=>{const O=T.status==="paid"&&T.paymentId!==et,nt=n("input",{type:"checkbox",checked:N.has(T.id),disabled:O});nt.addEventListener("change",()=>{O||ae(T.id,nt.checked)});const Q=T.status==="paid"?"Bezahlt":"Offen",St=n("div",{class:`po-payment-event-row ${O?"is-disabled":""}`,role:"button",tabindex:O?"-1":"0"},[nt,n("span",{class:"po-payment-event-main"},[n("span",{class:"po-payment-event-title"},[T.label]),n("span",{class:"muted"},[`${it(T.dueDate)} Â· ${At(T.plannedEur)} EUR`])]),n("span",{class:`po-status-pill ${T.status==="paid"?"is-paid":"is-open"}`},[Q]),n("span",{class:"po-transaction-pill"},[T.paymentId||"â€”"])]);St.addEventListener("click",ot=>{O||ot.target instanceof HTMLInputElement||(ae(T.id),nt.checked=N.has(T.id))}),St.addEventListener("keydown",ot=>{O||(ot.key==="Enter"||ot.key===" ")&&(ot.preventDefault(),ae(T.id),nt.checked=N.has(T.id))}),Ct.append(St)}),$t.addEventListener("input",me);const ie=()=>{const T=_t(Et.value),O=_t(xt.value),nt=T&&ye(T),Q=O&&ye(O);Xt.href=nt?T:"#",se.href=Q?O:"#",Xt.style.display=nt?"inline-flex":"none",se.style.display=Q?"inline-flex":"none"};Et.addEventListener("input",ie),xt.addEventListener("input",ie),zt(),ie();const $e=n("div",{class:"form-error po-payment-error"},[]),Ue=n("div",{class:"form-error po-payment-field-error",dataset:{field:"events"}},[]),Le=n("div",{class:"form-error po-payment-field-error",dataset:{field:"actual"}},[]),we=n("div",{class:"form-error po-payment-field-error",dataset:{field:"paymentId"}},[]),Te=n("div",{class:"form-error po-payment-field-error",dataset:{field:"invoiceUrl"}},[]),Mt=n("div",{class:"form-error po-payment-field-error",dataset:{field:"folderUrl"}},[]);function Ut(){return{selectedIds:Array.from(N).sort(),paidDate:ne.value||"",method:ut.value||"",paidBy:pt.value||"",actual:$t.value.trim(),paymentId:rt.value.trim(),invoiceUrl:_t(Et.value)||"",folderUrl:_t(xt.value)||"",note:yt.value.trim()}}const re=Ut();function jt(T){$e.textContent=T||""}function Pe(){const T=B.filter(O=>N.has(O.id));return Is({selectedEvents:T,actualRaw:$t.value.trim(),invoiceUrl:_t(Et.value),folderUrl:_t(xt.value),paymentRecord:U,paymentIdValue:rt.value,mergedPayments:C})}const le=n("div",{class:"po-payment-form"},[$e,n("div",{class:"po-payment-debug muted"},["Status: bereit"]),n("label",{},["Events (mehrere mÃ¶glich)"]),Ct,Ue,Bt,n("label",{},["Bezahlt am"]),ne,n("label",{},["Methode"]),ut,n("label",{},["Paid by"]),pt,n("label",{},["Ist bezahlt (EUR)"]),$t,Le,n("label",{},["Transfer / Payment-ID"]),rt,we,n("label",{},["Invoice (GDrive URL)"]),n("div",{style:"display:flex;gap:8px;align-items:center;"},[Et,Xt]),Te,n("label",{},["Invoice Folder (GDrive URL)"]),n("div",{style:"display:flex;gap:8px;align-items:center;"},[xt,se]),Mt,n("label",{},["Aufteilung (Preview)"]),Kt,n("label",{},["Notiz"]),yt]),ue=n("div",{class:"muted po-payment-save-hint"},[]),Fe=n("button",{class:"btn",type:"button"},["Speichern"]),tn=!z&&!U;function oe(T={}){Ue.textContent=T.events||"",Le.textContent=T.actual||"",we.textContent=T.paymentId||"",Te.textContent=T.invoiceUrl||"",Mt.textContent=T.folderUrl||"",Ct.classList.toggle("input-error",!!T.events),$t.classList.toggle("input-error",!!T.actual),rt.classList.toggle("input-error",!!T.paymentId),Et.classList.toggle("input-error",!!T.invoiceUrl),xt.classList.toggle("input-error",!!T.folderUrl)}function It(){const T=Pe(),O=!pn(Ut(),re),nt=(c==null?void 0:c.status)!=="paid",Q=T.valid;return Fe.disabled=!Q,T.valid?!O&&!tn&&!nt?(ue.textContent="Keine Ã„nderungen",jt("")):(ue.textContent="",jt("")):(ue.textContent=T.reason||"Bitte Pflichtfelder ausfÃ¼llen",jt(T.reason||"Bitte Pflichtfelder ausfÃ¼llen")),oe(T.fieldErrors||{}),{isDirty:O,validation:T}}[ne,ut,pt,$t,rt,Et,xt,yt].forEach(T=>{T.addEventListener("input",It),T.addEventListener("change",It)}),It(),Fe.addEventListener("click",()=>{var St;const T=!pn(Ut(),re),O=Pe();c==null||c.status;const nt=Array.isArray(O.allocations)?O.allocations.reduce((ot,kt)=>ot+Number(kt.actual||0),0):null;if(x&&console.debug("[po-payment-modal] save click",{isDirty:T,valid:O.valid,reason:O.reason||null,allocationsSum:nt}),!O.valid){console.warn("[po-payment-modal] validation failed",{reason:O.reason||null,selectedCount:((St=O.selectedEvents)==null?void 0:St.length)||0,sumPlanned:O.sumPlanned||0}),jt(`Speichern nicht mÃ¶glich: ${O.reason}`),oe(O.fieldErrors||{}),It();return}const Q={id:O.requestedPaymentId,paidDate:ne.value||null,method:ut.value||null,payer:pt.value||null,currency:"EUR",amountActualEurTotal:O.parsedActual,coveredEventIds:O.allocations.map(ot=>ot.eventId),note:yt.value.trim()||null,invoiceDriveUrl:O.invoiceUrl||"",invoiceFolderDriveUrl:O.folderUrl||""};try{const ot=e||{},kt={...ot.paymentDrafts||{}};z&&z!==Q.id&&delete kt[z],kt[Q.id]=Q;const mt=ot.paymentLog||{},Ht={...mt},ze=new Set;z&&Object.entries(mt).forEach(([ht,Dt])=>{(Dt==null?void 0:Dt.paymentId)===z&&!N.has(ht)&&ze.add(ht)}),ze.forEach(ht=>{const Dt=(mt==null?void 0:mt[ht])||{};Ht[ht]={...Dt,status:"open",paidDate:null,paymentId:null,amountActualEur:null,method:null,payer:null,note:null}}),O.allocations.forEach(ht=>{const Dt=(mt==null?void 0:mt[ht.eventId])||{},en=Dt.paymentInternalId||`payrow-${Math.random().toString(36).slice(2,9)}`;Ht[ht.eventId]={...Dt,paymentInternalId:en,status:"paid",paidDate:Q.paidDate,paymentId:Q.id,amountActualEur:ht.actual,method:Q.method,payer:Q.payer,note:Q.note}}),ot.paymentDrafts=kt,ot.paymentLog=Ht,console.info("[po-payment-modal] payment marked as paid",{eventCount:O.allocations.length,sumPlanned:O.sumPlanned,amountActual:O.parsedActual}),u(),vt(dt)}catch(ot){console.error("[po-payment-modal] save failed",ot),f("Speichern fehlgeschlagen. Bitte erneut versuchen.")}});const dt=Oe({title:U||z?"Zahlung bearbeiten":"Zahlungen als bezahlt markieren",content:le,actions:[n("button",{class:"btn secondary",type:"button",onclick:()=>vt(dt)},["Abbrechen"]),ue,Fe]})}if(J.forEach(c=>{const x=`${At(c.plannedEur)} EUR`,C=c.status==="paid"?"Bezahlt":"Offen",B=c.paidEurActual!=null?`${At(c.paidEurActual)} EUR`:"â€”",V=c.paidEurActual!=null?`Î” ${At(c.paidEurActual-c.plannedEur)} EUR`:null,z=zs(e,{status:c.status,paidDate:c.paidDate,dueDate:c.dueDate,typeLabel:c.typeLabel,eventType:c.eventType,amountActualEur:c.paidEurActual,amountPlannedEur:c.plannedEur},{poNumber:e==null?void 0:e[s.numberField],products:ft}),U=n("button",{class:"btn secondary sm",type:"button",onclick:async()=>{if(!await Xs(z)){alert("Konnte den Dateinamen nicht kopieren.");return}const Y=U.textContent;U.textContent="Copied",setTimeout(()=>{U.textContent=Y},1200)}},["Copy"]),et=n("tr",{dataset:{paymentId:c.id,paymentType:c.typeLabel,paymentEventType:c.eventType||""}},[n("td",{},[c.typeLabel]),n("td",{},[it(c.dueDate)]),n("td",{},[x]),n("td",{},[n("span",{class:`po-status-pill ${c.status==="paid"?"is-paid":"is-open"}`},[C])]),n("td",{},[c.paidDate?it(c.paidDate):"â€”"]),n("td",{},[B,V?n("div",{class:"muted"},[V]):null]),n("td",{},[c.method||"â€”"]),n("td",{},[c.paidBy||"â€”"]),n("td",{},[c.paymentId?n("span",{class:"po-transaction-pill"},[c.paymentId]):"â€”"]),n("td",{},[n("div",{class:"po-payment-filename"},[n("div",{class:"po-filename-suggestion"},[z||"â€”"]),U])]),n("td",{},[n("div",{style:"display:flex;gap:6px;flex-wrap:wrap;"},[n("button",{class:"btn secondary sm",type:"button",onclick:()=>y(c)},[c.status==="paid"?"Edit":"Mark as paid"]),ye(_t(c.invoiceDriveUrl))?n("a",{class:"btn secondary sm",href:_t(c.invoiceDriveUrl),target:"_blank",rel:"noopener noreferrer"},["Open Invoice"]):null,ye(_t(c.invoiceFolderDriveUrl))?n("a",{class:"btn secondary sm",href:_t(c.invoiceFolderDriveUrl),target:"_blank",rel:"noopener noreferrer"},["Open Folder"]):null])])]);$.append(et)}),J.length||$.append(n("tr",{},[n("td",{colspan:"11",class:"muted"},["Keine Zahlungen verfÃ¼gbar."])])),k.append(w),t.append(k),l&&l.id&&l.field){const c=t.querySelector(`[data-ms-id="${l.id}"] [data-field="${l.field}"]`);c&&(c.focus(),l.selectionStart!=null&&l.selectionEnd!=null&&c.setSelectionRange&&c.setSelectionRange(l.selectionStart,l.selectionEnd))}}function xa(t,e){const s=wt();Array.isArray(s[e.entityKey])||(s[e.entityKey]=[]);const u=W();s[e.entityKey].forEach(a=>Pt(a,u));const l=e.slug==="po",r=e.slug==="po",i={list:`${e.slug}-list`,number:`${e.slug}-number`,orderDate:`${e.slug}-order-date`,orderDateDisplay:`${e.slug}-order-date-display`,orderDatePicker:`${e.slug}-order-date-picker`,orderDateError:`${e.slug}-order-date-error`,items:`${e.slug}-items`,addItem:`${e.slug}-add-item`,goodsSummary:`${e.slug}-goods-summary`,fxRate:`${e.slug}-fx-rate`,freight:`${e.slug}-freight`,freightMode:`${e.slug}-freight-mode`,freightModeHint:`${e.slug}-freight-mode-hint`,freightPerUnit:`${e.slug}-freight-per-unit`,freightPerUnitSuggested:`${e.slug}-freight-per-unit-suggested`,freightPerUnitReset:`${e.slug}-freight-per-unit-reset`,freightPerUnitWarning:`${e.slug}-freight-per-unit-warning`,prod:`${e.slug}-prod`,transport:`${e.slug}-transport`,transit:`${e.slug}-transit`,dutyRate:`${e.slug}-duty-rate`,dutyInclude:`${e.slug}-duty-include`,eustRate:`${e.slug}-eust-rate`,fxFee:`${e.slug}-fx-fee`,vatLag:`${e.slug}-vat-lag`,vatToggle:`${e.slug}-vat-toggle`,ddp:`${e.slug}-ddp`,timeline:`${e.slug}-timeline`,timelineSummary:`${e.slug}-timeline-summary`,cnyBanner:`${e.slug}-cny-banner`,prefillBanner:`${e.slug}-prefill-banner`,etdComputed:`${e.slug}-etd-computed`,etaComputed:`${e.slug}-eta-computed`,etdManual:`${e.slug}-etd-manual`,etaManual:`${e.slug}-eta-manual`,etdReset:`${e.slug}-etd-reset`,etaReset:`${e.slug}-eta-reset`,msZone:`${e.slug}-ms-zone`,preview:`${e.slug}-preview`,save:`${e.slug}-save`,create:`${e.slug}-create`,remove:`${e.slug}-remove`,cancel:`${e.slug}-cancel`};l&&Object.assign(i,{sku:`${e.slug}-sku`,skuList:`${e.slug}-sku-list`,recent:`${e.slug}-sku-recent`,supplier:`${e.slug}-supplier`,quickLatest:`${e.slug}-quick-latest`,quickHistory:`${e.slug}-quick-history`,templateLoad:`${e.slug}-template-load`,templateSave:`${e.slug}-template-save`,quickStatus:`${e.slug}-quick-status`,productCreate:`${e.slug}-quick-create-product`,showBlocked:`${e.slug}-show-blocked`}),r&&Object.assign(i,{search:`${e.slug}-search`,archiveToggle:`${e.slug}-archive-toggle`,newButton:`${e.slug}-new`,modal:`${e.slug}-modal`,modalClose:`${e.slug}-modal-close`,status:`${e.slug}-status`,addMiscItem:`${e.slug}-add-misc-item`,meta:`${e.slug}-meta`,saveHeader:`${e.slug}-save-header`}),e.convertTo&&(i.convert=`${e.slug}-convert`);const f=`
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Header</h4>
          <span class="po-form-section-meta" id="${i.status}"></span>
        </div>
        <div id="${i.prefillBanner}" class="banner warning" hidden></div>
        ${l?`
        <div class="grid two po-quickfill">
        <div class="po-product-field">
          <label>Produkt (Alias/SKU)</label>
          <input id="${i.sku}" list="${i.skuList}" placeholder="Tippe Alias oder SKU â€¦" autocomplete="off" />
          <datalist id="${i.skuList}"></datalist>
          <div class="po-product-recent" id="${i.recent}" aria-live="polite"></div>
          <label class="inline-checkbox po-show-blocked">
            <input type="checkbox" id="${i.showBlocked}" />
            Blockierte Produkte anzeigen
          </label>
        </div>
        <div class="po-quickfill-actions">
          <div class="po-quickfill-buttons">
            <button class="btn secondary" type="button" id="${i.quickLatest}">Neueste Ã¼bernehmen</button>
            <button class="btn" type="button" id="${i.quickHistory}">Aus Historie wÃ¤hlen</button>
            <button class="btn secondary" type="button" id="${i.templateLoad}">Template laden</button>
            <button class="btn secondary" type="button" id="${i.templateSave}">Als Template speichernâ€¦</button>
            <button class="btn tertiary" type="button" id="${i.productCreate}">Neues Produkt anlegen</button>
          </div>
          <p class="po-quickfill-status" id="${i.quickStatus}" aria-live="polite"></p>
        </div>
        </div>
        `:""}
        <div class="grid ${l?"three":"two"}">
        <div>
          <label>${e.numberLabel}</label>
          <input id="${i.number}" placeholder="${e.numberPlaceholder}" />
        </div>
        <div>
          <label>Bestelldatum</label>
          <div class="po-date-picker">
            <input
              id="${i.orderDateDisplay}"
              placeholder="TT.MM.JJJJ"
              inputmode="numeric"
              aria-describedby="${i.orderDateError}"
            />
            <button type="button" class="btn tertiary" id="${i.orderDate}-picker-btn" aria-label="Datum auswÃ¤hlen">ðŸ“…</button>
            <input id="${i.orderDate}" type="date" aria-hidden="true" tabindex="-1" class="sr-only" />
          </div>
          <div id="${i.orderDateError}" class="form-error" role="alert"></div>
        </div>
        ${l?`
        <div>
          <label>Lieferant</label>
          <input id="${i.supplier}" placeholder="z. B. Ningbo Trading" />
        </div>
        `:""}
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Positionen</h4>
        </div>
        <div class="po-items-card">
          <div class="po-items-card-header">
            <h4>Artikel</h4>
            <div class="po-table-actions">
              <button class="btn sm" type="button" id="${i.addItem}">+ SKU Position</button>
              ${r?`<button class="btn sm secondary" type="button" id="${i.addMiscItem}">+ Freie Position</button>`:""}
            </div>
          </div>
          <div id="${i.items}"></div>
        </div>
        <div class="po-goods-summary" id="${i.goodsSummary}">Summe Warenwert: 0,00 â‚¬ (0,00 USD)</div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Timeline / Termine</h4>
        </div>
        <div class="grid two" style="margin-top:12px">
        <div>
          <label>FX-Kurs (USD je EUR)</label>
          <input id="${i.fxRate}" placeholder="z. B. 1,08" inputmode="decimal" />
        </div>
        </div>
        <div class="grid two" style="margin-top:12px">
        <div>
          <label>Fracht (Eingabeart)</label>
          <select id="${i.freightMode}">
            <option value="TOTAL_EUR">Gesamtbetrag (â‚¬)</option>
            <option value="PER_UNIT_EUR">Pro StÃ¼ck (â‚¬)</option>
            <option value="AUTO_FROM_LANDED">Auto (aus Einstandskosten)</option>
          </select>
          <p class="muted" id="${i.freightModeHint}" hidden>Berechnung: Einstandskosten (EUR/Stk) âˆ’ Warenwert (USD Ã· FX). Fehlende Einstandskosten werden markiert.</p>
        </div>
        <div>
          <label>Fracht gesamt (â‚¬)</label>
          <input id="${i.freight}" placeholder="z. B. 4.800,00" />
        </div>
        <div>
          <label>Logistik / Stk. (EUR)</label>
          <input id="${i.freightPerUnit}" placeholder="z. B. 1,25" />
          <div class="po-suggested-row">
            <span class="muted" id="${i.freightPerUnitSuggested}"></span>
            <button class="btn ghost" type="button" id="${i.freightPerUnitReset}">Reset</button>
          </div>
          <small class="form-error" id="${i.freightPerUnitWarning}"></small>
        </div>
        <div>
          <label>Produktionstage</label>
          <input id="${i.prod}" type="number" value="60" />
        </div>
        <div>
          <label>Transport</label>
          <select id="${i.transport}">
            <option value="sea">Sea</option>
            <option value="rail">Rail</option>
            <option value="air">Air</option>
          </select>
        </div>
        <div>
          <label>Transit-Tage</label>
          <input id="${i.transit}" type="number" value="60" />
        </div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div>
          <label>Zollsatz (%)</label>
          <input id="${i.dutyRate}" placeholder="z. B. 6,5" />
          <label class="inline-checkbox"><input type="checkbox" id="${i.dutyInclude}" /> Fracht einbeziehen</label>
        </div>
        <div>
          <label>EUSt (%)</label>
          <input id="${i.eustRate}" placeholder="z. B. 19" />
        </div>
        <div>
          <label>FX-GebÃ¼hr (%)</label>
          <input id="${i.fxFee}" placeholder="z. B. 0,5" />
        </div>
        <div>
          <label>EUSt-Erstattung (Monate)</label>
          <input id="${i.vatLag}" type="number" min="0" step="1" />
          <label class="inline-checkbox"><input type="checkbox" id="${i.vatToggle}" /> Erstattung aktiv</label>
        </div>
        <div class="checkbox-line">
          <label><input type="checkbox" id="${i.ddp}" /> DDP (Importkosten enthalten)</label>
        </div>
        </div>
        <div class="po-timeline-card">
          <div class="po-timeline-card-header">
            <h4>PO Timeline</h4>
            <div id="${i.timelineSummary}" class="po-timeline-summary"></div>
          </div>
          <div class="po-timeline-dates">
            <div class="po-timeline-date">
              <span class="muted">Berechnet ETD</span>
              <strong id="${i.etdComputed}">â€”</strong>
            </div>
            <div class="po-timeline-date">
              <span class="muted">Berechnet ETA</span>
              <strong id="${i.etaComputed}">â€”</strong>
            </div>
            <div class="po-timeline-date">
              <label>ETD Override</label>
              <div class="po-timeline-input-row">
                <input id="${i.etdManual}" type="date" />
                <button class="btn sm" type="button" id="${i.etdReset}">Reset</button>
              </div>
            </div>
            <div class="po-timeline-date">
              <label>ETA Override</label>
              <div class="po-timeline-input-row">
                <input id="${i.etaManual}" type="date" />
                <button class="btn sm" type="button" id="${i.etaReset}">Reset</button>
              </div>
            </div>
          </div>
          <div id="${i.cnyBanner}" class="banner warning" hidden></div>
          <div id="${i.timeline}" class="po-timeline-track-wrapper"></div>
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Zahlungsplan & Importkosten</h4>
        </div>
        <div id="${i.msZone}" style="margin-top:10px"></div>
      </div>
      <div class="po-sticky-footer">
        <div class="po-sticky-actions">
          <button class="btn primary sm" id="${i.save}">Speichern</button>
          <button class="btn sm" id="${i.cancel}">SchlieÃŸen</button>
          <button class="btn sm" id="${i.create}">${e.newButtonLabel}</button>
          ${e.convertTo?`<button class="btn secondary sm" id="${i.convert}">${e.convertTo.buttonLabel||"In PO umwandeln"}</button>`:""}
          <button class="btn danger sm" id="${i.remove}">LÃ¶schen</button>
        </div>
      </div>
      <div class="po-form-section">
        <div class="po-form-section-header">
          <h4>Ereignisse / Ledger</h4>
        </div>
        <div id="${i.preview}" class="po-event-preview"></div>
      </div>
  `,b=r?`
      <section class="card po-form-card">
        <div class="po-form-modal-header">
          <div>
            <h3>${e.formTitle}</h3>
            <div class="po-form-modal-meta" id="${i.meta}"></div>
          </div>
          <div class="po-table-actions">
            <button class="btn primary sm" type="button" id="${i.saveHeader}">Speichern</button>
            <button class="btn ghost" type="button" id="${i.modalClose}" aria-label="SchlieÃŸen">âœ•</button>
          </div>
        </div>
        ${f}
      </section>
    `:`
      <section class="card">
        <h3>${e.formTitle}</h3>
        ${f}
      </section>
    `;t.innerHTML=r?`
      <section class="card po-list-card">
        <div class="po-list-toolbar">
          <div>
            <h2>${e.listTitle}</h2>
          </div>
          <div class="po-list-actions">
            <input id="${i.search}" placeholder="Suche PO-Nr., SKU, Alias, Supplier" />
            <label class="po-archive-toggle">
              <input type="checkbox" id="${i.archiveToggle}" />
              Archiviert
            </label>
            <button class="btn primary" type="button" id="${i.newButton}">+ Neue PO</button>
          </div>
        </div>
        <div id="${i.list}" class="po-table-wrap ui-table-shell ui-scroll-host"></div>
      </section>
      <div class="po-form-modal" id="${i.modal}" aria-hidden="true">
        <div class="po-form-modal-panel">
          ${b}
        </div>
      </div>
    `:`
      <section class="card">
        <h2>${e.listTitle}</h2>
        <div id="${i.list}"></div>
      </section>
      ${b}
    `;const D=I(`#${i.list}`,t),E=r?I(`#${i.search}`,t):null,S=r?I(`#${i.archiveToggle}`,t):null,F=r?I(`#${i.newButton}`,t):null,m=r?I(`#${i.modal}`,t):null,_=r&&m?m.querySelector(".po-form-modal-panel"):null,P=r?I(`#${i.modalClose}`,t):null,R=r?I(`#${i.status}`,t):null,j=r?I(`#${i.meta}`,t):null,J=r?I(`#${i.saveHeader}`,t):null,k=I(`#${i.prefillBanner}`,t),w=l?I(`#${i.sku}`,t):null,$=l?I(`#${i.skuList}`,t):null,y=l?I(`#${i.supplier}`,t):null,c=l?I(`#${i.quickLatest}`,t):null,x=l?I(`#${i.quickHistory}`,t):null,C=l?I(`#${i.productCreate}`,t):null,B=l?I(`#${i.templateLoad}`,t):null,V=l?I(`#${i.templateSave}`,t):null,z=l?I(`#${i.quickStatus}`,t):null,U=l?I(`#${i.showBlocked}`,t):null,et=I(`#${i.number}`,t),N=I(`#${i.orderDate}`,t),Y=I(`#${i.orderDateDisplay}`,t),bt=I(`#${i.orderDateError}`,t),Wt=I(`#${i.orderDate}-picker-btn`,t),Yt=I(`#${i.items}`,t),Be=I(`#${i.addItem}`,t),Ke=r?I(`#${i.addMiscItem}`,t):null,ke=`${i.items}-dl`,ne=I(`#${i.goodsSummary}`,t),ut=I(`#${i.fxRate}`,t),pt=I(`#${i.freightMode}`,t),$t=I(`#${i.freightModeHint}`,t),yt=I(`#${i.freight}`,t),rt=I(`#${i.freightPerUnit}`,t),Et=I(`#${i.freightPerUnitSuggested}`,t),xt=I(`#${i.freightPerUnitReset}`,t),Xt=I(`#${i.freightPerUnitWarning}`,t),se=I(`#${i.prod}`,t),Bt=I(`#${i.transport}`,t),Kt=I(`#${i.transit}`,t),Nt=I(`#${i.dutyRate}`,t),me=I(`#${i.dutyInclude}`,t),zt=I(`#${i.eustRate}`,t),Ct=I(`#${i.fxFee}`,t),De=I(`#${i.vatLag}`,t),ae=I(`#${i.vatToggle}`,t),ie=I(`#${i.ddp}`,t),$e=I(`#${i.timeline}`,t),Ue=I(`#${i.timelineSummary}`,t),Le=I(`#${i.cnyBanner}`,t),we=I(`#${i.etdComputed}`,t),Te=I(`#${i.etaComputed}`,t),Mt=I(`#${i.etdManual}`,t),Ut=I(`#${i.etaManual}`,t),re=I(`#${i.etdReset}`,t),jt=I(`#${i.etaReset}`,t),Pe=I(`#${i.msZone}`,t),le=I(`#${i.save}`,t),ue=I(`#${i.cancel}`,t),Fe=I(`#${i.create}`,t),tn=I(`#${i.remove}`,t),oe=I(`#${i.preview}`,t),It=i.convert?I(`#${i.convert}`,t):null;let dt=In(Bn(ge(e,W()),W()),{key:`${e.slug}:new`,enableDraftCache:!0}),h=dt.draft,T=JSON.parse(JSON.stringify(h));const O=Us(()=>dt.isDirty,"Ungespeicherte Ã„nderungen verwerfen?");O.register(),O.attachBeforeUnload();let nt=!1;const Q=r?{searchTerm:"",showArchived:!1,sortKey:null,sortDir:null}:null;let St=!1;function ot(a){if(!a)return"";const d=a.alias||a.sku||"Produkt",o=a.sku||"",p=a.supplierId?` â€¢ ${a.supplierId}`:"";return`${d} â€“ ${o}${p}`}function kt(a){const d=String(a||"").trim().toLowerCase(),o=d.split("â€¢")[0].trim();return d&&ft.find(p=>{if(!p||!p.sku)return!1;const v=String(p.alias||"").trim().toLowerCase(),g=String(p.sku||"").trim().toLowerCase(),L=`${v} â€“ ${g}`,M=p.supplierId?`${L} â€¢ ${String(p.supplierId).trim().toLowerCase()}`:null;return!!(d===L.toLowerCase()||o===L.toLowerCase()||M&&d===M||v&&(d===v||o===v)||g&&(d===g||o===g))})||null}function mt(a){const d=kt(a);return d?d.sku:String(a||"").trim()}function Ht(a){!l||!w||(a?(w.value=ot(a),w.dataset.sku=a.sku,y&&!h.supplier&&a.supplierId&&(y.value=a.supplierId,h.supplier=a.supplierId)):w.dataset.sku="")}function ze(){if(!l)return;const a=I(`#${i.recent}`,t);if(!a)return;const d=Ls();if(a.innerHTML="",!d.length){a.append(n("span",{class:"muted"},["Zuletzt genutzte Produkte erscheinen hier."]));return}d.forEach(o=>{const p=n("button",{type:"button",class:"chip",onclick:()=>{Ht(o),h.sku=o.sku,Jt(),nt=!1,Vt(o),ce()}},[o.alias?`${o.alias} (${o.sku})`:o.sku]);a.append(p)})}function ht(a){z&&(z.textContent=a||"")}function Dt(a=[],d="Hinweise"){if(!k)return;if(!a.length){k.hidden=!0,k.innerHTML="";return}const o=a.map(p=>`<li>${p}</li>`).join("");k.innerHTML=`<strong>${d}</strong><ul>${o}</ul>`,k.hidden=!1}function en(a){var o,p,v;if(!a)return[];const d=[];return(o=a.blockingMissing)!=null&&o.length&&d.push(`Pflichtfelder fehlen: ${a.blockingMissing.map(g=>g.label).join(", ")}`),(p=a.defaulted)!=null&&p.length&&d.push(`Defaults aktiv: ${a.defaulted.map(g=>g.label).join(", ")}`),(v=a.suggestedMissing)!=null&&v.length&&d.push(`Empfohlen: ${a.suggestedMissing.map(g=>g.label).join(", ")}`),d}function nn(a){if(z){z.textContent=a;return}let d=document.getElementById(`${e.slug}-toast`);d||(d=document.createElement("div"),d.id=`${e.slug}-toast`,d.className="po-toast",document.body.appendChild(d)),d.textContent=a,d.hidden=!1,setTimeout(()=>{d.hidden=!0},2e3)}function rs(){const a=W(),d=JSON.parse(JSON.stringify(h));be(a,d);const o=!pn(d,T);return o?(h=d,dt.setDraft(h)):dt.setDraft(T),o}function ls(a){Rn({title:"Ungespeicherte Ã„nderungen",message:"Ungespeicherte Ã„nderungen verwerfen?",confirmLabel:"Verwerfen",cancelLabel:"Abbrechen",onConfirm:a})}function us(a){if(!a)return"unbekannt";const d=new Date(a);return Number.isNaN(d.getTime())?"unbekannt":d.toLocaleString("de-DE",{dateStyle:"medium",timeStyle:"short"})}function sn(a){const d=(a==null?void 0:a[e.numberField])||(a==null?void 0:a.id)||"new";return`${e.slug}:${d}`}function an(){if(!r||!m)return;m.classList.add("is-open"),m.setAttribute("aria-hidden","false");const a=m.querySelector("input, select, textarea, button");a&&a.focus()}function je(){!r||!m||(m.classList.remove("is-open"),m.setAttribute("aria-hidden","true"))}function He({reset:a}={}){if(!r)return;if(!rs()){a&&Ot(T||h),je();return}O({confirmWithModal:({onConfirm:o})=>ls(o),onConfirm:()=>{a&&Ot(T||h),je()}})}let Je=!1;_&&(_.addEventListener("mousedown",()=>{Je=!0}),window.addEventListener("mouseup",()=>{Je&&setTimeout(()=>{Je=!1},0)}));function xe(){return wt()}function rn(){const a=xe();return Array.isArray(a[e.entityKey])||(a[e.entityKey]=[]),a[e.entityKey]}function de(a,d=null){const o=a||rn();r&&d&&(Object.prototype.hasOwnProperty.call(d,"sortKey")&&(Q.sortKey=d.sortKey),Object.prototype.hasOwnProperty.call(d,"sortDir")&&(Q.sortDir=d.sortDir));const p=r?{...Q,onUpdate:v=>de(null,v)}:void 0;ma(D,o,e,Pn,Fn,p)}function gn(a){const d=W();return(a||[]).map(o=>{const p=JSON.parse(JSON.stringify(o));return Pt(p,d),Zt(p,d,p.milestones||[]),p})}function vn(a){const d=ee(a);return d?d.getTime():0}function he(a,d,o=10){if(!a)return[];const p=a.trim().toLowerCase(),v=d?d.trim().toLowerCase():null,g=rn().filter(L=>{const M=((L==null?void 0:L.sku)||"").trim().toLowerCase(),K=Array.isArray(L==null?void 0:L.items)?L.items.some(A=>((A==null?void 0:A.sku)||"").trim().toLowerCase()===p):!1;return!M&&!K||M&&M!==p&&!K?!1:v?((L==null?void 0:L.supplier)||"").trim().toLowerCase()===v:!0});return g.sort((L,M)=>vn(M.orderDate)-vn(L.orderDate)),g.slice(0,o)}function yn(a,d){if(!a)return null;const o=d?he(a,d,1):[];if(o.length)return o[0];const p=he(a,null,1);return p.length?p[0]:null}function os(){const a=xe();return Array.isArray(a.poTemplates)||(a.poTemplates=[]),a.poTemplates}function ds(a,d){if(!a)return[];const o=a.trim().toLowerCase(),p=d?d.trim().toLowerCase():null;return os().filter(v=>{if(!v||!v.sku||String(v.sku).trim().toLowerCase()!==o)return!1;if(v.scope==="SKU_SUPPLIER"){const L=(v.supplier||"").trim().toLowerCase();return p?L===p:!1}return v.scope==="SKU"}).sort((v,g)=>new Date(g.updatedAt||0)-new Date(v.updatedAt||0))}function Ve(a,d){if(!a)return[];const o=[],p=ft.find(g=>g&&g.sku&&g.sku.trim().toLowerCase()===a.trim().toLowerCase());if(p&&p.template){const g=p.template.scope==="SKU_SUPPLIER"?"SKU_SUPPLIER":"SKU",L=(p.template.supplierId||p.supplierId||"").trim().toLowerCase(),M=(d||"").trim().toLowerCase();(g==="SKU_SUPPLIER"?M&&L===M:!0)&&o.push({id:`product-${p.sku}-${g}`,name:p.template.name||(g==="SKU_SUPPLIER"?"Produkt-Template (SKU+Supplier)":"Produkt-Template (SKU)"),scope:g,source:"product",template:p.template})}return ds(a,d).forEach(g=>{o.push({id:g.id,name:g.name||(g.scope==="SKU_SUPPLIER"?"Legacy (SKU+Supplier)":"Legacy (SKU)"),scope:g.scope,source:"legacy",template:g})}),o}function cs(){!l||!$||(Tt(),$.innerHTML="",ft.filter(a=>a&&a.status!=="inactive").filter(a=>St?!0:On(a,{state:xe()}).status!=="blocked").forEach(a=>{$.append(n("option",{value:ot(a)}))}))}function Jt(){var v;if(!l)return;cs(),ze();const a=mt((w==null?void 0:w.value)||h.sku||""),d=((v=y==null?void 0:y.value)==null?void 0:v.trim())||"",o=yn(a,d),p=Ve(a,d);if(c&&(c.disabled=!o&&p.length===0,o?c.title=`Werte aus ${e.entityLabel} ${o[e.numberField]||"â€”"} Ã¼bernehmen`:p.length?c.title=`Werte aus ${p[0].name} Ã¼bernehmen`:c.title="Keine Produktvorlage oder VorgÃ¤nger-POs fÃ¼r diese SKU"),x){const g=a&&(he(a,d).length>0||!d&&he(a,null).length>0);x.disabled=!g,x.title=g?"":"Keine VorgÃ¤nger-POs fÃ¼r diese SKU"}if(B){const g=Ve(a,d);B.disabled=g.length===0,B.title=g.length?"":"Kein Template verfÃ¼gbar"}}function qe(a,d){var g,L;if(!a)return;const o=W(),p=jn(h,a);if(l){const M=(((g=w==null?void 0:w.value)==null?void 0:g.trim())||a.sku||"").trim(),K=(((L=y==null?void 0:y.value)==null?void 0:L.trim())||a.supplier||"").trim();p.sku=mt(M),p.supplier=K}Pt(p,o),Zt(p,o,p.milestones||[]),Ot(p);const v=mt(p.sku);if(v){const M=kt(v)||ft.find(K=>K&&K.sku&&K.sku.trim().toLowerCase()===v.trim().toLowerCase());M&&(Ht(M),Re(M.sku))}d&&ht(d)}function fs(a,d){if(!d)return;if(d.innerHTML="",!a.length){d.append(n("p",{class:"muted"},["Keine Unterschiede zum aktuellen Formular."]));return}const o=n("dl",{class:"po-diff-list"});a.forEach(p=>{o.append(n("dt",{},[p.label]),n("dd",{},[p.type==="list"?`Anzahl ${p.before} â†’ ${p.after}`:`${p.before} â†’ ${p.after}`]))}),d.append(o)}function ps(){var H;if(!l)return;const a=mt((w==null?void 0:w.value)||h.sku||"");if(!a){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const d=((H=y==null?void 0:y.value)==null?void 0:H.trim())||"";let o=he(a,d),p=!0;if(!o.length&&d&&(o=he(a,null),p=!1),!o.length){window.alert("Keine VorgÃ¤nger-POs fÃ¼r diese SKU gefunden.");return}const v=n("tbody"),g=n("div",{class:"po-history-diff"}),L=n("div",{class:"po-history"},[n("p",{class:"muted"},[p?"Sortiert nach Datum (neueste zuerst).":"Keine passende Lieferantenhistorie â€“ zeige jÃ¼ngste POs dieser SKU."]),n("table",{class:"table-compact ui-table-standard ui-data-table po-history-table","data-ui-table":"true"},[n("thead",{},[n("tr",{},[n("th",{},["PO-Nr."]),n("th",{},["Bestelldatum"]),n("th",{},["StÃ¼ckzahl"]),n("th",{},["StÃ¼ckpreis (USD)"]),n("th",{},["Produktionstage"]),n("th",{},["Transit-Tage"]),n("th",{},["Transport"]),n("th",{},["Fracht (â‚¬)"]),n("th",{},["Zoll %"]),n("th",{},["EUSt %"]),n("th",{},["FX-Fee %"]),n("th",{},["Aktionen"])])]),v]),g]),M=Oe({title:`Historie fÃ¼r ${a}`,content:L,actions:[]}),K=M.querySelector(".po-modal-actions");K&&(K.innerHTML="",K.append(n("button",{class:"btn",type:"button",onclick:()=>vt(M)},["Abbrechen"])));const st=W(),A=JSON.parse(JSON.stringify(h));Pt(A,st),Zt(A,st,A.milestones||[]),o.slice(0,10).forEach((G,at)=>{const X=gn([G])[0],Lt=n("button",{class:"btn secondary",type:"button"},["Vergleichen"]),lt=n("button",{class:"btn primary",type:"button"},["Ãœbernehmen"]);lt.addEventListener("click",()=>{vt(M),qe(X,`Werte aus ${e.entityLabel} ${G[e.numberField]||""} Ã¼bernommen. Du kannst alles anpassen.`)}),Lt.addEventListener("click",()=>{const Me=jn(A,X),Ae=aa(A,Me);fs(Ae,g)});const Ne=Ft(Gt(X,Rt(X,st)));v.append(n("tr",{class:at===0?"po-history-latest":""},[n("td",{},[G[e.numberField]||"â€”"]),n("td",{},[it(G.orderDate)]),n("td",{},[Number(q(X.units||G.units||0)||0).toLocaleString("de-DE")]),n("td",{},[Se(q(X.unitCostUsd||G.unitCostUsd||0))]),n("td",{},[String(G.prodDays||0)]),n("td",{},[String(G.transitDays||0)]),n("td",{},[G.transport||"â€”"]),n("td",{},[Ne]),n("td",{},[`${gt(X.dutyRatePct??G.dutyRatePct??0)} %`]),n("td",{},[`${gt(X.eustRatePct??G.eustRatePct??0)} %`]),n("td",{},[`${gt(X.fxFeePct??G.fxFeePct??0)} %`]),n("td",{class:"po-history-actions"},[Lt,lt])]))})}function ms(){var K;if(!l)return;const a=mt((w==null?void 0:w.value)||h.sku||"");if(!a){window.alert("Bitte zuerst eine SKU eingeben.");return}const d=((K=y==null?void 0:y.value)==null?void 0:K.trim())||"";Tt();const o=n("input",{type:"text",placeholder:"z. B. Standardbestellung"}),p=n("select",{},[n("option",{value:"SKU"},["SKU"]),n("option",{value:"SKU_SUPPLIER"},["SKU+Supplier"])]);d||(p.value="SKU");const v=n("div",{class:"po-template-fields"});na.forEach(st=>{const A=n("input",{type:"checkbox",value:st.key,id:`tpl-${st.key}`});st.key!=="autoEvents"&&(A.checked=!0);const H=n("label",{for:`tpl-${st.key}`},[st.label]),G=n("div",{class:"po-template-field"},[A,H]);v.append(G)});const g=n("div",{class:"po-template-form"},[n("label",{},["Name"]),o,n("label",{style:"margin-top:12px"},["Geltungsbereich"]),p,n("p",{class:"muted"},["Welche Felder Ã¼bernehmen?"]),v]),L=Oe({title:"Als Template speichern",content:g,actions:[]}),M=L.querySelector(".po-modal-actions");if(M){M.innerHTML="";const st=n("button",{class:"btn",type:"button",onclick:()=>vt(L)},["Abbrechen"]),A=n("button",{class:"btn primary",type:"button"},["Speichern"]);A.addEventListener("click",()=>{const H=Array.from(v.querySelectorAll("input[type=checkbox]:checked")).map(lt=>lt.value);if(!H.length){window.alert("Bitte mindestens ein Feld auswÃ¤hlen.");return}const G=p.value==="SKU_SUPPLIER"&&d?"SKU_SUPPLIER":"SKU",at={scope:G,supplierId:G==="SKU_SUPPLIER"?d:"",name:o.value.trim()||(G==="SKU_SUPPLIER"?"Standard (SKU+Supplier)":"Standard (SKU)"),fields:{},updatedAt:new Date().toISOString()};H.forEach(lt=>{lt==="milestones"?at.fields[lt]=ns(h.milestones||[]):lt==="autoEvents"?at.fields[lt]=ss(h.autoEvents||[]):at.fields[lt]=h[lt]});const X=ft.find(lt=>lt&&lt.sku&&lt.sku.trim().toLowerCase()===a.trim().toLowerCase()),Lt={sku:a,alias:(X==null?void 0:X.alias)||a,supplierId:(X==null?void 0:X.supplierId)||"",status:(X==null?void 0:X.status)||"active",tags:(X==null?void 0:X.tags)||[],template:at};X!=null&&X.sku&&(Lt.originalSku=X.sku),An(Lt),Re(a),Tt(),Jt(),ht(`Template â€ž${at.name}â€œ gespeichert.`),vt(L)}),M.append(st,A)}}function En(a){if(!a||!a.template)return;const d=a.template.fields?JSON.parse(JSON.stringify(a.template.fields)):JSON.parse(JSON.stringify(a.template));qe(d,`Template â€ž${a.name}â€œ geladen. Du kannst alles anpassen.`)}function hs(a){let d;const o=n("div",{class:"po-template-picker"});a.forEach(v=>{const g=v.scope==="SKU_SUPPLIER"?"SKU+Supplier":"SKU",L=n("div",{class:"po-template-row"},[n("div",{class:"po-template-info"},[n("strong",{},[v.name||"Template"]),n("span",{class:"muted"},[`${g} â€¢ ${v.source==="product"?"Produkt":"Legacy"}`])]),n("div",{class:"po-template-actions"},[n("button",{class:"btn",type:"button",onclick:()=>{En(v),vt(d)}},["Ãœbernehmen"])])]);o.append(L)}),d=Oe({title:"Template wÃ¤hlen",content:o,actions:[]});const p=d.querySelector(".po-modal-actions");p&&(p.innerHTML="",p.append(n("button",{class:"btn",type:"button",onclick:()=>vt(d)},["Abbrechen"])))}function bs(){var p;if(!l)return;const a=mt((w==null?void 0:w.value)||h.sku||"");if(!a){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const d=((p=y==null?void 0:y.value)==null?void 0:p.trim())||"";Tt();const o=Ve(a,d);if(!o.length){window.alert("Kein Template verfÃ¼gbar.");return}if(o.length===1){En(o[0]);return}hs(o)}function gs(){Tt();const a=n("form",{class:"po-product-create"}),d=n("input",{required:!0,placeholder:"SKU"}),o=n("input",{required:!0,placeholder:"Alias"}),p=n("input",{placeholder:"Supplier"});a.append(n("label",{},["SKU",d]),n("label",{},["Alias",o]),n("label",{},["Supplier",p]));const v=Oe({title:"Neues Produkt anlegen",content:a,actions:[]}),g=v.querySelector(".po-modal-actions");if(g){const L=n("button",{class:"btn",type:"button",onclick:()=>vt(v)},["Abbrechen"]),M=n("button",{class:"btn primary",type:"button"},["Speichern"]);M.addEventListener("click",()=>{const K=d.value.trim(),st=o.value.trim();if(!K||!st){window.alert("Bitte SKU und Alias angeben.");return}try{if(An({sku:K,alias:st,supplierId:p.value.trim(),status:"active",tags:[]}),Re(K),Tt(),w){const A=ft.find(H=>H&&H.sku&&H.sku.trim().toLowerCase()===K.trim().toLowerCase());A&&(Ht(A),h.sku=A.sku,Jt(),ce())}vt(v),ht("Produkt angelegt.")}catch(A){window.alert(A.message||String(A))}}),g.innerHTML="",g.append(L,M)}}function ln(a){const d=JSON.parse(JSON.stringify(h));be(a,d);const o=JSON.parse(JSON.stringify(d));Pt(o,a);const p=bn(o,e,a);oe.innerHTML="",oe.append(n("h4",{},["Ereignisse"])),oe.append(pa(p,h.paymentLog,mn(h)))}function Sn(a){we&&(we.textContent=it(a==null?void 0:a.etdComputed)),Te&&(Te.textContent=it(a==null?void 0:a.etaComputed)),re&&(re.disabled=!h.etdManual),jt&&(jt.disabled=!h.etaManual)}function ce(){const a=(h.milestones||[]).reduce((p,v)=>p+ct(v.percent||0),0),d=!l||w&&w.value.trim()!==""||(h.items||[]).some(p=>p.sku),o=Math.round(a*10)/10===100&&et.value.trim()!==""&&Rt(h,W()).usd>0&&!!N.value&&d;le.disabled=!o||!dt.isDirty,It&&(It.disabled=!o),on()}function kn(a){[le,J].forEach(d=>{d&&(d.dataset.label||(d.dataset.label=d.textContent),d.textContent=a?"Speichernâ€¦":d.dataset.label,d.disabled=a||d.disabled)})}async function un(){le.disabled||(kn(!0),await Tn(),kn(!1),ce())}function on(){if(!R)return;const a=h.archived?"Status: Archiviert":"Status: Aktiv";R.textContent=dt.isDirty?`${a} â€¢ Ungespeichert`:a}function Dn(a,d){if(!ne)return;const o=Ft(a.eur||0),p=Se(a.usd||0),v=We(a.fxRate),g=d||pe(h,W()),L=Ft((g==null?void 0:g.estimatedFreightEur)||0),M=(g==null?void 0:g.mode)==="AUTO_FROM_LANDED"&&(g!=null&&g.missingLandedCount)?` Â· Einstandskosten fehlen (${g.missingLandedCount})`:"";ne.textContent=v?`Summe Warenwert: ${o} (${p} Ã· FX ${v}) Â· GeschÃ¤tzte Fracht (EUR): ${L}${M}`:`Summe Warenwert: ${o} (${p}) Â· GeschÃ¤tzte Fracht (EUR): ${L}${M}`}function $n(){if(!pt||!yt||!rt)return;const a=pt.value||"TOTAL_EUR",d=a==="AUTO_FROM_LANDED";yt.disabled=a==="PER_UNIT_EUR"||d,rt.disabled=a!=="PER_UNIT_EUR"||d,$t&&($t.hidden=!d)}function vs(a,d){var L;const o=q((ut==null?void 0:ut.value)??"");if(Number.isFinite(o)&&o>0)return o;const p=(L=a==null?void 0:a.template)!=null&&L.fields?a.template.fields:a==null?void 0:a.template,v=q((a==null?void 0:a.fxUsdPerEur)??(p==null?void 0:p.fxRate)??"");if(Number.isFinite(v)&&v>0)return v;const g=typeof d.fxRate=="number"?d.fxRate:q(d.fxRate);return Number.isFinite(g)&&g>0?g:null}function ys(a,d){var M;if(!a)return{value:null,warning:!1,missingFields:[]};const o=q(a.logisticsPerUnitEur??a.freightPerUnitEur);if(Number.isFinite(o)&&o>0)return{value:o,warning:!1,missingFields:[]};const p=(M=a.template)!=null&&M.fields?a.template.fields:a.template,v=q((p==null?void 0:p.unitPriceUsd)??a.unitPriceUsd??""),g=q(a.landedUnitCostEur??a.landedCostEur??""),L=vs(a,d);return Gn({unitPriceUsd:v,landedCostEur:g,fxUsdPerEur:L})}function Vt(a,{force:d=!1}={}){if(!rt)return;if(!a){Et&&(Et.textContent=""),Xt&&(Xt.textContent="");return}const o=W(),p=ys(a,o);Et&&(Et.textContent=p.value!=null?`Vorschlag: ${At(p.value)}`:"Vorschlag: â€”"),Xt&&(Xt.textContent=p.missingFields.length?Ys(p.missingFields):"");const v=q(rt.value),g=Number.isFinite(v)&&v>0;!nt&&(d||!g)&&(p.value!=null?rt.value=tt(p.value):(d||!g)&&(rt.value=""))}function dn(a){var st;if(!a)return!1;const d=xe(),o=Ms(a.sku,{mode:"PO",supplierId:((st=y==null?void 0:y.value)==null?void 0:st.trim())||a.supplierId,transportMode:Bt==null?void 0:Bt.value},{state:d}),p=JSON.parse(JSON.stringify(h)),v=A=>{const H=typeof A=="number"?A:q(A);return Number.isFinite(H)?H:null},g=A=>{const H=v(A);return H==null||H<=0},L=(A,H)=>{H==null||!g(p[A])||(p[A]=H)};Array.isArray(p.items)&&(p.items=p.items.map(A=>{if(!A||A.sku&&A.sku!==a.sku)return A;const H={...A},G=v(H.unitCostUsd);return!H.unitCostManuallyEdited&&(G==null||G<=0)&&o.unitPrice!=null&&(H.unitCostUsd=tt(o.unitPrice),H.unitCostManuallyEdited=!1),H})),L("fxOverride",o.fxRate),L("prodDays",o.productionLeadTimeDays),p.transport||(p.transport=String(o.transportMode).toLowerCase()),L("transitDays",o.logisticsLeadTimeDays),o.logisticsPerUnitEur!=null&&g(p.freightPerUnitEur)&&(p.freightMode="per_unit",p.freightPerUnitEur=tt(o.logisticsPerUnitEur),p.freightEur=tt(0)),L("dutyRatePct",o.dutyRatePct),L("eustRatePct",o.eustRatePct),o.ddp===!0&&p.ddp!==!0&&(p.ddp=!0);const M=[{label:"Deposit",percent:30,anchor:"ORDER_DATE",lagDays:0},{label:"Balance",percent:70,anchor:"PROD_DONE",lagDays:0}],K=A=>!Array.isArray(A)||A.length!==M.length?!1:A.every((H,G)=>{const at=M[G];return H.label===at.label&&Number(H.percent)===at.percent&&H.anchor===at.anchor});return Array.isArray(o.paymentTerms)&&o.paymentTerms.length&&K(p.milestones)&&(p.milestones=o.paymentTerms.map(A=>({id:`ms-${Math.random().toString(36).slice(2,9)}`,label:A.label||"Milestone",percent:Number(A.percent)||0,anchor:A.triggerEvent==="PRODUCTION_END"?"PROD_DONE":A.triggerEvent||"ORDER_DATE",lagDays:Number(A.offsetDays||A.lagDays||0)||0}))),Ot(p),!0}function be(a=W(),d=h){const o=d||h;l&&(o.sku=w?mt(w.value):"",o.supplier=y?y.value.trim():""),o[e.numberField]=et.value.trim();const p=Kn((Y==null?void 0:Y.value)||""),v=p?Ie(p):null,g=(N==null?void 0:N.value)||null;o.orderDate=v||g||o.orderDate;const L=Yt?Array.from(Yt.querySelectorAll("[data-item-id]")):[],M=[];L.forEach(at=>{var Mn;const X=at.dataset.itemId||`item-${Math.random().toString(36).slice(2,9)}`,[Lt,lt,Ne,Me,Ae]=at.querySelectorAll("input");M.push({id:X,sku:((Mn=Lt==null?void 0:Lt.value)==null?void 0:Mn.trim())||"",units:(lt==null?void 0:lt.value)||"0",unitCostUsd:tt((Ne==null?void 0:Ne.value)||"0,00"),unitExtraUsd:tt((Me==null?void 0:Me.value)||"0,00"),extraFlatUsd:tt((Ae==null?void 0:Ae.value)||"0,00"),unitCostManuallyEdited:at.dataset.unitCostManual==="true"})}),M.length&&(o.items=M),Ee(o);const K=q((ut==null?void 0:ut.value)??"");o.fxOverride=Number.isFinite(K)&&K>0?K:null,o.timeline=o.timeline||{},o.timeline.fxUsdPerEur=o.fxOverride?o.fxOverride:Number.isFinite(a.fxRate)&&a.fxRate>0?a.fxRate:null,Pt(o,a);const st=Rt(o,a),A=(pt==null?void 0:pt.value)||"TOTAL_EUR";o.timeline=o.timeline||{},o.timeline.freightInputMode=A,o.freightMode=A==="PER_UNIT_EUR"?"per_unit":"total",o.freightEur=tt(yt.value),o.freightPerUnitEur=tt((rt==null?void 0:rt.value)||"");const H=pe(o,a);Dn(st,H),o.prodDays=Number(se.value||0),o.transport=Bt.value,o.transitDays=Number(Kt.value||0),o.dutyRatePct=ct(Nt.value),o.dutyIncludeFreight=me.checked,o.eustRatePct=ct(zt.value),o.fxFeePct=ct(Ct.value),o.vatRefundLagMonths=Number(De.value||0),o.vatRefundEnabled=ae.checked,o.ddp=ie.checked,Mt&&(o.etdManual=Mt.value||null),Ut&&(o.etaManual=Ut.value||null);const G=te(o,a);return o.cnyAdjustmentDays=(G==null?void 0:G.cnyAdjustmentDays)||0,H}function Z(a={}){var v,g;let d=a.focusInfo||null;if(!d){const L=document.activeElement;if(L&&L.closest&&L.closest("[data-ms-id]")){const M=L.closest("[data-ms-id]");d={id:(v=M==null?void 0:M.dataset)==null?void 0:v.msId,field:((g=L.dataset)==null?void 0:g.field)||null,selectionStart:L.selectionStart,selectionEnd:L.selectionEnd}}}const o=W();let p=be(o);Kt.value||(Kt.value=h.transport==="air"?"10":h.transport==="rail"?"30":"60"),p=be(o),Zt(h,o,h.milestones),_e(h),Vn($e,Ue,h,o,Le),Sn(te(h,o)),qn(Pe,h,e,Z,d,o,{showToast:nn}),ln(o),ba(Yt,p),ce(),dt.setDraft(h),dt.isDirty}function Un(a){const d=a||new Date().toISOString().slice(0,10);N&&(N.value=d),Y&&(Y.value=it(d)),bt&&(bt.textContent="")}function Ln(a=!1){const d=Kn((Y==null?void 0:Y.value)||"")||ee((N==null?void 0:N.value)||"");if(!d)return bt&&a&&(bt.textContent="Bitte Datum im Format TT.MM.JJJJ eingeben"),null;bt&&(bt.textContent="");const o=Ie(d);return N&&(N.value=o),Y&&(Y.value=it(o)),o}function wn(){const a=W();if(h=dt.draft,Pt(h,a),Zt(h,a,h.milestones),_e(h),Qe(h),h.paymentDrafts||(h.paymentDrafts={}),R&&(R.textContent=h.archived?"Status: Archiviert":"Status: Aktiv"),j){const v=h[e.numberField]||"â€”",g=h.supplier||"â€”";j.textContent=`${v} â€¢ ${g}`}if(Ye(Yt,h,()=>Z(),ke),l){if(Tt(),w){const v=ft.find(g=>g&&g.sku&&g.sku.trim().toLowerCase()===String(h.sku||"").trim().toLowerCase());v?Ht(v):(w.value=h.sku||"",w.dataset.sku=h.sku||"")}y&&(y.value=h.supplier||""),ht(""),Jt()}et.value=h[e.numberField]||"",Un(h.orderDate||new Date().toISOString().slice(0,10));const d=h.fxOverride??a.fxRate??0;ut&&(ut.value=d?We(d):"");const o=pe(h,a);if(Dn(Rt(h,a),o),pt&&(pt.value=hn(h)),yt.value=tt(h.freightEur??"0,00"),rt&&(rt.value=tt(h.freightPerUnitEur??"0,00")),nt=Number.isFinite(q(h.freightPerUnitEur))&&q(h.freightPerUnitEur)>0,rt){const v=ft.find(g=>g&&g.sku&&g.sku.trim().toLowerCase()===String(h.sku||"").trim().toLowerCase());Vt(v)}$n(),se.value=String(h.prodDays??60),Bt.value=h.transport||"sea",Kt.value=String(h.transitDays??(h.transport==="air"?10:h.transport==="rail"?30:60)),Nt.value=gt(h.dutyRatePct??a.dutyRatePct??0),me.checked=h.dutyIncludeFreight!==!1,zt.value=gt(h.eustRatePct??a.eustRatePct??0),Ct.value=gt(h.fxFeePct??a.fxFeePct??0),De.value=String(h.vatRefundLagMonths??a.vatRefundLagMonths??0),ae.checked=h.vatRefundEnabled!==!1,ie.checked=!!h.ddp,Mt&&(Mt.value=h.etdManual||""),Ut&&(Ut.value=h.etaManual||"");const p=te(h,a);Vn($e,Ue,h,a,Le),Sn(p),qn(Pe,h,e,Z,null,a,{showToast:nn}),ln(a),ce()}function Ot(a){Dt([]);const d=W();dt=In(Bn(a,d),{key:sn(a),enableDraftCache:!0}),h=dt.draft,T=ve(h),wn(),dt.markClean();const o=dt.loadDraftIfAvailable();o!=null&&o.exists&&Rn({title:"Entwurf gefunden",message:`Es gibt einen ungespeicherten Entwurf von ${us(o.updatedAt)}. Wiederherstellen?`,confirmLabel:"Wiederherstellen",cancelLabel:"Verwerfen",onConfirm:()=>{dt.restoreDraft(),wn(),on()},onCancel:()=>{dt.discardDraft(),on()}})}async function Tn(){if(!Ln(!0)){Y&&Y.focus();return}const d=W();be(d),Qe(h);const o=wt(),{issues:p}=Ts({settings:o.settings,products:o.products,suppliers:o.suppliers}),v=p.filter(g=>g.blocking&&g.scope==="product"&&g.entityId===h.sku&&(g.field==="currency"||g.field==="unitPrice"));if(h.supplier||v.push(Ps({scope:"po",entityId:h.id||h[e.numberField]||"po",severity:"error",field:"supplier",message:"Supplier fehlt.",hint:"Bitte einen Supplier hinterlegen.",blocking:!0})),v.length){Fs(v);return}await dt.commit(g=>{const L=wt(),M=ve(g),K=M.paymentDrafts||{};delete M.paymentDrafts;const A=(Array.isArray(L.payments)?L.payments:[]).map(at=>ve(at));Object.values(K).forEach(at=>{if(!(at!=null&&at.id))return;const X=A.findIndex(lt=>(lt==null?void 0:lt.id)===at.id),Lt=ve(at);X>=0?A[X]={...A[X],...Lt}:A.push(Lt)}),L.payments=A;const H=Array.isArray(L[e.entityKey])?L[e.entityKey]:[],G=H.findIndex(at=>at.id&&at.id===M.id||at[e.numberField]&&at[e.numberField]===M[e.numberField]);G>=0?H[G]=M:H.push(M),L[e.entityKey]=H,Ze(L,{source:`${e.slug}:save`,entityKey:sn(M),action:G>=0?"update":"create"}),T=ve(M)}),de(wt()[e.entityKey]),Jt(),l&&h.sku&&Re(h.sku),nn(`${e.entityLabel||"PO"} gespeichert`),r&&je()}async function Es(){if(!e.convertTo)return;const a=W();if(be(a),le.disabled){window.alert("Bitte gÃ¼ltige Daten eingeben, bevor die FO umgewandelt wird.");return}await Tn();const d=wt();Array.isArray(d[e.convertTo.entityKey])||(d[e.convertTo.entityKey]=[]);const o=d[e.convertTo.entityKey],p=ca(o,e.convertTo.numberField),v=e.convertTo.targetLabel||e.convertTo.numberField||"PO",g=p.raw?`Aktuell hÃ¶chste ${v}-Nummer: ${p.raw}`:`Es existiert noch keine ${v}-Nummer.`,L=p.next||"",M=window.prompt(`${g}
Bitte neue ${v}-Nummer eingeben:`,L);if(M==null)return;const K=M.trim();if(!K){window.alert("Bitte eine gÃ¼ltige Nummer eingeben.");return}if(o.some(G=>((G==null?void 0:G[e.convertTo.numberField])||"").toLowerCase()===K.toLowerCase())){window.alert(`${v}-Nummer ${K} ist bereits vergeben.`);return}const H={...JSON.parse(JSON.stringify(h)),id:Math.random().toString(36).slice(2,9),[e.convertTo.numberField]:K};delete H[e.numberField],o.push(H),Ze(d,{source:`${e.slug}:convert`,entityKey:`${e.convertTo.slug||e.convertTo.entityKey}:${H[e.convertTo.numberField]||H.id}`,action:"create"}),window.alert(`${v} ${K} wurde angelegt.`)}function Pn(a){Ot(a),r&&an()}function Fn(a){const d=wt(),o=Array.isArray(d[e.entityKey])?d[e.entityKey]:[];d[e.entityKey]=o.filter(p=>p.id&&a.id?p.id!==a.id:p[e.numberField]!==a[e.numberField]),Ze(d,{source:`${e.slug}:delete`,entityKey:sn(a),action:"delete"}),de(wt()[e.entityKey]),Ot(ge(e,W())),r&&je()}if(Be&&Be.addEventListener("click",()=>{Ee(h),h.items.push({id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1}),Ye(Yt,h,()=>Z(),ke),Z()}),Ke&&Ke.addEventListener("click",()=>{Ee(h),h.items.push({id:`item-${Math.random().toString(36).slice(2,9)}`,sku:"",units:"0",unitCostUsd:"0,00",unitExtraUsd:"0,00",extraFlatUsd:"0,00",unitCostManuallyEdited:!1,type:"misc"}),Ye(Yt,h,()=>Z(),ke),Z()}),Y&&(Y.addEventListener("blur",()=>Ln(!0)),Y.addEventListener("input",()=>{bt&&(bt.textContent="")})),N&&N.addEventListener("change",()=>{Un(N.value),Z()}),Wt&&N&&Wt.addEventListener("click",()=>{N.showPicker?N.showPicker():N.focus()}),pt&&pt.addEventListener("change",()=>{$n(),Z()}),yt.addEventListener("input",Z),yt.addEventListener("blur",()=>{yt.value=tt(yt.value),Z()}),rt&&(rt.addEventListener("input",()=>{nt=!0,Z()}),rt.addEventListener("blur",()=>{rt.value=tt(rt.value),Z()})),xt&&xt.addEventListener("click",()=>{nt=!1;const a=kt((w==null?void 0:w.value)||h.sku||"");Vt(a,{force:!0}),Z()}),Nt.addEventListener("input",Z),Nt.addEventListener("blur",()=>{const a=ct(Nt.value);Nt.value=gt(a),Z()}),me.addEventListener("change",Z),zt.addEventListener("input",Z),zt.addEventListener("blur",()=>{const a=ct(zt.value);zt.value=gt(a),Z()}),Ct.addEventListener("input",Z),Ct.addEventListener("blur",()=>{const a=ct(Ct.value);Ct.value=gt(a),Z()}),ut&&(ut.addEventListener("input",()=>{Z();const a=kt((w==null?void 0:w.value)||h.sku||"");Vt(a)}),ut.addEventListener("blur",()=>{const a=q(ut.value);ut.value=a>0?We(a):"",Z();const d=kt((w==null?void 0:w.value)||h.sku||"");Vt(d)})),De.addEventListener("input",Z),ae.addEventListener("change",Z),ie.addEventListener("change",Z),Mt&&Mt.addEventListener("change",Z),Ut&&Ut.addEventListener("change",Z),re&&re.addEventListener("click",()=>{Mt&&(Mt.value=""),h.etdManual=null,Z()}),jt&&jt.addEventListener("click",()=>{Ut&&(Ut.value=""),h.etaManual=null,Z()}),se.addEventListener("input",a=>{h.prodDays=Number(a.target.value||0),Z()}),Bt.addEventListener("change",a=>{h.transport=a.target.value,h.transport==="air"&&(h.transitDays=10),h.transport==="rail"&&(h.transitDays=30),h.transport==="sea"&&(h.transitDays=60),Kt.value=String(h.transitDays),Z()}),Kt.addEventListener("input",a=>{h.transitDays=Number(a.target.value||0),Z()}),l&&w){const a=()=>{const d=kt(w.value);if(d){Ht(d),h.sku=d.sku,Re(d.sku);const o=On(d,{state:xe()}),p=en(o);if(o.status==="blocked"){Dt(p,"Produkt blockiert"),Vt(d),ce();return}Dt(p,"Prefill verwendet Defaults");const v=dn(d);if(nt=!1,Vt(d),v)return}else h.sku=w.value.trim(),Vt(null);ht(""),Jt(),ce()};w.addEventListener("input",a),w.addEventListener("blur",()=>{w.value=w.value.trim(),a()})}if(l&&y){const a=()=>{h.supplier=y.value.trim();const d=kt((w==null?void 0:w.value)||h.sku||"");d&&dn(d),Jt()};y.addEventListener("input",a),y.addEventListener("blur",()=>{y.value=y.value.trim(),a()})}if(l&&U&&(U.checked=St,U.addEventListener("change",()=>{St=U.checked,Jt()})),l&&c&&c.addEventListener("click",a=>{var M;a.preventDefault(),a.stopPropagation();const d=mt((w==null?void 0:w.value)||h.sku||"");if(!d){window.alert("Bitte zuerst eine SKU wÃ¤hlen.");return}const o=((M=y==null?void 0:y.value)==null?void 0:M.trim())||"",p=yn(d,o);if(p){const K=gn([p])[0];qe(K,`Werte aus ${e.entityLabel} ${p[e.numberField]||""} Ã¼bernommen. Du kannst alles anpassen.`);return}const v=Ve(d,o);if(!v.length){window.alert("Keine Produktvorlage oder VorgÃ¤nger-POs fÃ¼r diese SKU gefunden.");return}const g=v[0],L=g.template.fields?JSON.parse(JSON.stringify(g.template.fields)):JSON.parse(JSON.stringify(g.template));qe(L,`Werte aus ${g.name} Ã¼bernommen. Du kannst alles anpassen.`)}),l&&x&&x.addEventListener("click",ps),C&&C.addEventListener("click",gs),B&&B.addEventListener("click",bs),V&&V.addEventListener("click",ms),E&&E.addEventListener("input",()=>{Q&&(Q.searchTerm=E.value,de())}),S&&S.addEventListener("change",()=>{Q&&(Q.showArchived=S.checked,de())}),F&&F.addEventListener("click",()=>{Ot(ge(e,W())),an()}),P&&P.addEventListener("click",()=>He({reset:!0})),J&&J.addEventListener("click",un),m){let a=!1;m.addEventListener("mousedown",d=>{a=d.target===m}),m.addEventListener("mouseup",d=>{if(a&&d.target===m){if(Je)return;He({reset:!0})}a=!1})}et.addEventListener("input",Z),Y&&Y.addEventListener("input",Z),le.addEventListener("click",un),ue&&ue.addEventListener("click",()=>{He({reset:!0})}),Fe.addEventListener("click",()=>Ot(ge(e,W()))),tn.addEventListener("click",()=>Fn(h)),It&&It.addEventListener("click",()=>Es());const xn=a=>{(a.ctrlKey||a.metaKey)&&a.key.toLowerCase()==="s"&&(a.preventDefault(),un()),a.key==="Escape"&&r&&(m!=null&&m.classList.contains("is-open"))&&(a.preventDefault(),He({reset:!0}))};window.addEventListener("keydown",xn),de(s[e.entityKey]),Jt(),Ot(ge(e,W()));function Ss(a){const d=W();Tt();const o=ge(e,d),p=[],v=String(a.sku||"").trim();v&&(o.sku=v,Array.isArray(o.items)&&o.items[0]&&(o.items[0].sku=v,o.items[0].units=""));const g=v?ft.find(A=>{var H;return((H=A==null?void 0:A.sku)==null?void 0:H.trim().toLowerCase())===v.toLowerCase()}):null;g!=null&&g.supplierId?o.supplier=g.supplierId:v&&p.push("Supplier fehlt in Produktdaten.");const L=String(a.anchorMode||"order").toLowerCase(),M=a.orderDate||a.anchorDate||"",K=ee(M);if(K)if(L==="arrival"){o.etaManual=Ie(K);const A=ga(K,o,d);A&&(o.orderDate=Ie(A)),p.push(`Order Date wurde rÃ¼ckwÃ¤rts bestimmt fÃ¼r ETA-Anker ${it(K)}.`)}else o.orderDate=Ie(K);Number.isFinite(q(d.fxRate))||p.push("FX-Kurs fehlt in Settings.");const st=a.anchorMonth||(K?zn(K):null);return{record:o,messages:p,anchorMonth:st,anchorMode:L,anchorDate:K,product:g}}function ks(a){if(!a||!r)return;const d=String(a).split(":")[1]||"";if(!d)return;const o=t.querySelector(".po-payments-table");if(!o)return;const p=Array.from(o.querySelectorAll("tbody tr"));p.forEach(L=>L.classList.remove("is-focus"));const v=d.toLowerCase(),g=p.find(L=>{const M=String(L.dataset.paymentType||"").toLowerCase(),K=String(L.dataset.paymentEventType||"").toLowerCase();return M.includes(v)||K.includes(v)});g&&(g.classList.add("is-focus"),g.scrollIntoView({block:"center",behavior:"smooth"}))}function Ds(){var v;const a=window.__routeQuery||{};if(a.create==="1"||a.mode==="create"){const{record:g,messages:L,anchorMonth:M,anchorMode:K,product:st}=Ss(a);Ot(g),st&&l&&(dn(st),nt=!1,Vt(st,{force:!0}));const A=K!=="arrival"?zn((v=te(h,W()))==null?void 0:v.eta):null;M&&A&&A>M&&L.push(`Mit aktuellen Lead Times liegt ETA voraussichtlich in ${Qs(A)} (Stockout-Risiko mÃ¶glich).`),Dt(L),r&&an(),window.__routeQuery={};return}if(!a.open)return;const o=String(a.open||"").trim().toLowerCase();if(!o)return;const p=rn().find(g=>{if(!g)return!1;const L=String(g.id||"").trim().toLowerCase()===o,M=String(g[e.numberField]||"").trim().toLowerCase()===o;return L||M});p&&(Pn(p),a.focus&&setTimeout(()=>ks(a.focus),150),window.__routeQuery={})}Ds(),t._orderStateListener&&window.removeEventListener("state:changed",t._orderStateListener);const Nn=()=>{const a=wt(),d=W();de(a[e.entityKey]),oe&&ln(d)};return t._orderStateListener=Nn,window.addEventListener("state:changed",Nn),{cleanup:()=>{t._orderStateListener&&window.removeEventListener("state:changed",t._orderStateListener),O.unregister(),O.detachBeforeUnload(),window.removeEventListener("keydown",xn)}}}const Na={normaliseGoodsFields:Pt};export{Yn as a,Hn as b,W as g,ye as i,Wn as n,Na as o,xa as r};
