import{t as g,k as t,S as ie,N as re,L as F,M as T,K as se,R as le,U as G}from"./index-D7jH1FVY.js";import{E as U}from"./index-BUQvO9GH.js";import{c as ue}from"./cashflow-CGZq5oFU.js";import{T as ce}from"./TanStackGrid-Dj2Kv21o.js";import{c as me,m as _,f as I}from"./months-BTPgK-LH.js";import{u as de,C as j}from"./workspace-BOh-scKZ.js";import{S as pe}from"./index-DHM-xNG6.js";import{S as z}from"./index-DGSf9dMo.js";import{F as he}from"./Table-DDyQ8Gn8.js";import"./planProducts-B3Cdri-V.js";import"./cashInRules-oX83SMz9.js";import"./Dropdown-YtRXoqxq.js";import"./DownOutlined-DUcFHC8J.js";import"./index-ygadgiJ9.js";import"./useBubbleLock-DNuYBdSj.js";import"./index-BdbRizcT.js";import"./Pagination-Dxw0Fog1.js";function q(a){return String(a||"").trim()}function Z(a){const n=Number(a);return Number.isFinite(n)?n:0}function ge(a){const n=Math.abs(Z(a.amount));return String(a.direction||"").toLowerCase()==="out"?-n:n}function fe(a){const n=String(a.source||"").toLowerCase();return n==="po"?"po":n==="fo"?"fo":n==="sales"||n==="sales-plan"?"sales":n==="fixcosts"?"fixcosts":n==="extras"?"extras":n==="dividends"?"dividends":n==="vat"?"vat":n==="launch-costs"?"extras":"unknown"}function be(a){const n=String(a.source||"").toLowerCase(),b=String(a.kind||"").toLowerCase(),p=String(a.group||"").toLowerCase();return n==="po"||n==="fo"?"po_fo":n==="sales"||n==="sales-plan"?"inflow":n==="fixcosts"||p==="fixkosten"?"fixcost":b.includes("duty")||b.includes("eust")||b.includes("vat")||p.includes("import")?"tax":String(a.direction||"").toLowerCase()==="in"?"inflow":String(a.direction||"").toLowerCase()==="out"?"outflow":"other"}function xe(a){const n=Array.isArray(a.products)?a.products:[],b=new Map;n.forEach(l=>{const u=q(l.sku);if(!u)return;const o=String(l.alias||"").trim()||u;b.set(u,o)});const p=new Map,x=(l,u)=>{const o=(l==="po"?[u.poNo,u.id]:[u.foNo,u.foNumber,u.id]).map(i=>String(i||"").trim()).filter(Boolean);if(!o.length)return;const f=Array.isArray(u.items)&&u.items.length?u.items:[{sku:u.sku,units:u.units}],S=new Set;let v=0;f.forEach(i=>{const d=q(i.sku);if(!d)return;S.add(b.get(d)||d);const M=Z(i.units??i.qty??i.quantity);v+=M});const h={aliases:Array.from(S),units:Number.isFinite(v)?v:null};Array.from(new Set(o)).forEach(i=>{p.set(`${l}:${i}`,h)})};return(Array.isArray(a.pos)?a.pos:[]).forEach(l=>x("po",l)),(Array.isArray(a.fos)?a.fos:[]).forEach(l=>x("fo",l)),p}function ve(a){const n=new Map,b=xe(a.state);return(Array.isArray(a.breakdown)?a.breakdown:[]).forEach(p=>{const x=String(p.month||"").trim();if(!x)return;const u=(Array.isArray(p.entries)?p.entries:[]).map(o=>{var P;const f=fe(o),S=o.sourceNumber?String(o.sourceNumber):void 0,v=o.sourceId?String(o.sourceId):void 0,h=o.meta&&typeof o.meta=="object"?o.meta:{},i=f==="fo"&&(h.phantom===!0||(v?((P=a.provisionalFoIds)==null?void 0:P.has(v))===!0:!1)),d=o.provisional===!0||i,M=S&&(f==="po"||f==="fo")?`${f}:${S}`:null,N=M?b.get(M):null,c=h.cashIn&&typeof h.cashIn=="object"?h.cashIn:null;return{month:x,group:be(o),label:String(o.label||"Eintrag"),tooltip:typeof o.tooltip=="string"?o.tooltip:void 0,amount:ge(o),provisional:d,paid:typeof o.paid=="boolean"?o.paid:null,source:f,portfolioBucket:o.portfolioBucket?String(o.portfolioBucket):h.portfolioBucket?String(h.portfolioBucket):null,sourceNumber:S,sourceId:v,tooltipMeta:N?{aliases:N.aliases,units:N.units,milestone:String(o.label||""),dueDate:o.date?String(o.date):null}:void 0,cashInMeta:c?{quoteSource:c.quoteSource?String(c.quoteSource):void 0,revenueSource:c.revenueSource?String(c.revenueSource):void 0,component:c.component?String(c.component):null,forecastRevenueRaw:Number.isFinite(Number(c.forecastRevenueRaw))?Number(c.forecastRevenueRaw):null,calibrationFactorApplied:Number.isFinite(Number(c.calibrationFactorApplied))?Number(c.calibrationFactorApplied):null,calibrationSourceMonth:c.calibrationSourceMonth?String(c.calibrationSourceMonth):null,calibrationMethod:c.calibrationMethod?String(c.calibrationMethod):null,planRevenueAfterCalibration:Number.isFinite(Number(c.planRevenueAfterCalibration))?Number(c.planRevenueAfterCalibration):null,payoutPct:Number.isFinite(Number(c.payoutPct))?Number(c.payoutPct):null,payoutAmount:Number.isFinite(Number(c.payoutAmount))?Number(c.payoutAmount):null}:void 0}});n.set(x,u)}),n}const{Paragraph:A,Text:w,Title:R}=se,Q=[{value:"last6",label:"Letzte 6 Monate",count:6},{value:"last12",label:"Letzte 12 Monate",count:12},{value:"all",label:"Alle Monate",count:null}],ye={inflow:"Einzahlungen",po_fo:"PO/FO",fixcost:"Fixkosten",tax:"Steuern & Import",outflow:"Auszahlungen",other:"Sonstige"};function m(a){const n=Number(a);return Number.isFinite(n)?n:null}function D(a){return Math.round(a*100)/100}function y(a){const n=Number(a);return Number.isFinite(n)?n.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}):"—"}function K(a){const n=Number(a);return Number.isFinite(n)?n<0?`−${y(Math.abs(n))}`:y(n):"—"}function B(a){const n=Number(a);return Number.isFinite(n)?`${n.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`:"—"}function V(a,n){return!Number.isFinite(a)||!Number.isFinite(n)||Number(n)===0?null:Number(a)/Number(n)*100}function $(a,n,b){const p=a.filter(l=>!l.provisional).map(l=>{const u=n(l),o=b(l);return!Number.isFinite(u)||!Number.isFinite(o)||!u?null:Math.abs((Number(o)-Number(u))/Number(u))*100}).filter(l=>Number.isFinite(l));if(!p.length)return{accuracyPct:null,mapePct:null,sampleCount:0};const x=p.reduce((l,u)=>l+u,0)/p.length;return{accuracyPct:Math.max(0,100-x),mapePct:x,sampleCount:p.length}}function Se(a,n){const b=m(a.plannedRevenue)||0,p=m(a.actualRevenue)||0,x=m(a.payoutDelta)||0,l=m(a.closingDelta)||0,u=m(n==null?void 0:n.closingDelta)||0,o=l-u,f=(m(a.plannedPayoutRatePct)||0)/100,S=(m(a.actualPayoutRatePct)||0)/100;let v=x,h=0;Number.isFinite(b)&&Number.isFinite(p)&&Number.isFinite(f)&&Number.isFinite(S)&&(v=(p-b)*f,h=p*(S-f));const i=o-x;return[{key:"rev_effect",label:"Umsatz-Effekt (auf Payout)",amount:D(v),kind:"component"},{key:"payout_effect",label:"Payout-Quote-Effekt",amount:D(h),kind:"component"},{key:"residual",label:"Sonstige Effekte (Kosten/Timing)",amount:D(i),kind:"component"},{key:"total",label:"Delta Kontostand (Monats-Effekt)",amount:D(o),kind:"total"}]}function Ue(){const{state:a,loading:n,error:b}=de(),[p,x]=g.useState("last12"),[l,u]=g.useState(""),o=a,f=g.useMemo(()=>ue(o),[o]),S=me(),v=_(S),h=g.useMemo(()=>(Array.isArray(f.actualComparisons)?f.actualComparisons:[]).map(r=>{const s=String(r.month||"").trim(),k=_(s),te=k!=null&&v!=null&&k>=v,ne=V(m(r.plannedPayout),m(r.plannedRevenue)),ae=V(m(r.actualPayout),m(r.actualRevenue)),L=m(r.plannedClosing),W=m(r.actualClosing),oe=Number.isFinite(L)&&L&&Number.isFinite(W)?(Number(W)-Number(L))/Number(L)*100:null;return{...r,month:s,provisional:te,plannedPayoutRatePct:ne,actualPayoutRatePct:ae,closingDeltaPct:oe}}).filter(r=>r.month).sort((r,s)=>r.month.localeCompare(s.month)),[v,f.actualComparisons]),i=g.useMemo(()=>{const e=Q.find(r=>r.value===p);return!e||e.count==null?h:h.slice(-e.count)},[p,h]);g.useEffect(()=>{if(!i.length){u("");return}const e=new Set(i.map(r=>r.month));(!l||!e.has(l))&&u(i[i.length-1].month)},[l,i]);const d=g.useMemo(()=>i.find(e=>e.month===l)||i[i.length-1]||null,[l,i]),M=g.useMemo(()=>{if(!d)return null;const e=h.findIndex(r=>r.month===d.month);return e<=0?null:h[e-1]||null},[h,d]),N=g.useMemo(()=>i.filter(e=>!e.provisional),[i]),c=g.useMemo(()=>$(N,e=>m(e.plannedClosing),e=>m(e.actualClosing)),[N]),P=g.useMemo(()=>$(N,e=>m(e.plannedRevenue),e=>m(e.actualRevenue)),[N]),E=g.useMemo(()=>$(N,e=>m(e.plannedPayout),e=>m(e.actualPayout)),[N]),C=g.useMemo(()=>d?Se(d,M):[],[M,d]),O=g.useMemo(()=>ve({breakdown:Array.isArray(f.breakdown)?f.breakdown:[],state:o}),[f.breakdown,o]),H=g.useMemo(()=>{if(!d)return[];const e=O.get(d.month)||[],r=new Map;return e.forEach(s=>{r.set(s.group,(r.get(s.group)||0)+Number(s.amount||0))}),Array.from(r.entries()).map(([s,k])=>({key:s,label:ye[s]||s,amount:D(k)})).sort((s,k)=>Math.abs(k.amount)-Math.abs(s.amount))},[O,d]),J=g.useMemo(()=>{const e=i.findIndex(s=>s.provisional),r=i.map(s=>I(s.month));return{tooltip:{trigger:"axis",valueFormatter:s=>y(s)},legend:{top:0},grid:{left:54,right:26,top:44,bottom:26},xAxis:{type:"category",data:r},yAxis:{type:"value",axisLabel:{formatter:s=>y(s)}},series:[{name:"Delta Kontostand",type:"bar",data:i.map(s=>Number(s.closingDelta||0)),itemStyle:{color:s=>e>=0&&s.dataIndex>=e?"rgba(245, 158, 11, 0.65)":s.value<0?"#dc2626":"#16a34a"}},{name:"Kontostand Soll",type:"line",smooth:!0,data:i.map(s=>m(s.plannedClosing)),lineStyle:{width:2,type:"dashed",color:"#0f172a"},itemStyle:{color:"#0f172a"}},{name:"Kontostand Ist",type:"line",smooth:!0,data:i.map(s=>m(s.actualClosing)),lineStyle:{width:2,color:"#0ea5e9"},itemStyle:{color:"#0ea5e9"},markArea:e>=0?{itemStyle:{color:"rgba(251, 191, 36, 0.12)"},data:[[{xAxis:r[e]},{xAxis:r[r.length-1]}]]}:void 0}]}},[i]),X=g.useMemo(()=>({tooltip:{trigger:"axis"},legend:{top:0},grid:{left:54,right:52,top:44,bottom:26},xAxis:{type:"category",data:i.map(e=>I(e.month))},yAxis:[{type:"value",name:"EUR",axisLabel:{formatter:e=>y(e)}},{type:"value",name:"%",min:0,max:100,axisLabel:{formatter:e=>`${e.toLocaleString("de-DE",{maximumFractionDigits:0})} %`}}],series:[{name:"Umsatz Soll",type:"bar",data:i.map(e=>m(e.plannedRevenue)),itemStyle:{color:"#94a3b8"}},{name:"Umsatz Ist",type:"bar",data:i.map(e=>m(e.actualRevenue)),itemStyle:{color:"#0ea5e9"}},{name:"Payout-Quote Soll",type:"line",yAxisIndex:1,smooth:!0,data:i.map(e=>m(e.plannedPayoutRatePct)),lineStyle:{width:2,type:"dashed",color:"#64748b"},itemStyle:{color:"#64748b"}},{name:"Payout-Quote Ist",type:"line",yAxisIndex:1,smooth:!0,data:i.map(e=>m(e.actualPayoutRatePct)),lineStyle:{width:2,color:"#f97316"},itemStyle:{color:"#f97316"}}]}),[i]),Y=g.useMemo(()=>({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},valueFormatter:e=>y(e)},grid:{left:54,right:20,top:18,bottom:48},xAxis:{type:"category",data:C.map(e=>e.label),axisLabel:{interval:0,rotate:20}},yAxis:{type:"value",axisLabel:{formatter:e=>y(e)}},series:[{type:"bar",data:C.map(e=>e.amount),itemStyle:{color:e=>{const r=C[e.dataIndex];return(r==null?void 0:r.kind)==="total"?"#0f172a":e.value<0?"#dc2626":"#16a34a"}}}]}),[C]),ee=g.useMemo(()=>[{header:"Monat",accessorKey:"month",meta:{minWidth:150},cell:({row:e})=>t.jsxs(ie,{size:6,children:[t.jsx(re,{size:"small",type:l===e.original.month?"primary":"default",onClick:()=>u(e.original.month),children:I(e.original.month)}),e.original.provisional?t.jsx(F,{color:"gold",children:"Vorlaeufig"}):t.jsx(F,{color:"green",children:"Abgeschlossen"})]})},{header:"Kontostand Soll",meta:{align:"right",width:150},cell:({row:e})=>y(e.original.plannedClosing)},{header:"Kontostand Ist",meta:{align:"right",width:150},cell:({row:e})=>y(e.original.actualClosing)},{header:"Delta Kontostand",meta:{align:"right",width:150},cell:({row:e})=>t.jsx("span",{className:Number(e.original.closingDelta||0)<0?"v2-negative":void 0,children:K(e.original.closingDelta)})},{header:"Umsatz Soll",meta:{align:"right",width:140},cell:({row:e})=>y(e.original.plannedRevenue)},{header:"Umsatz Ist",meta:{align:"right",width:140},cell:({row:e})=>y(e.original.actualRevenue)},{header:"Payout Soll",meta:{align:"right",width:140},cell:({row:e})=>y(e.original.plannedPayout)},{header:"Payout Ist",meta:{align:"right",width:140},cell:({row:e})=>y(e.original.actualPayout)}],[l]);return n?t.jsx("div",{className:"v2-page",children:t.jsx(T,{type:"info",showIcon:!0,message:"Workspace wird geladen..."})}):b?t.jsx("div",{className:"v2-page",children:t.jsx(T,{type:"error",showIcon:!0,message:b})}):h.length?t.jsxs("div",{className:"v2-page",children:[t.jsxs(j,{className:"v2-intro-card",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsx(R,{level:3,children:"Soll vs. Ist"}),t.jsx(A,{children:"Wie gut war die Planung gegen die real eingetretenen Werte. Fokus: Kontostand, Umsatz und Payout."})]}),t.jsxs("div",{className:"v2-toolbar-field",children:[t.jsx(w,{children:"Zeitraum"}),t.jsx(pe,{value:p,onChange:e=>x(e),options:Q.map(e=>({value:e.value,label:e.label})),style:{width:220,maxWidth:"100%"}})]})]}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(F,{color:"green",children:["Monate mit Istwerten: ",h.length]}),t.jsxs(F,{color:"blue",children:["Im Vergleich (abgeschlossen): ",N.length]}),t.jsx(F,{color:"gold",children:'Laufender Monat wird als "vorlaeufig" markiert'})]})})]}),t.jsxs("div",{className:"v2-svi-kpi-grid",children:[t.jsxs(j,{children:[t.jsx(z,{title:"Treffsicherheit Kontostand",value:c.accuracyPct!=null?`${c.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(w,{type:"secondary",children:["MAPE: ",B(c.mapePct)," · n=",c.sampleCount]})]}),t.jsxs(j,{children:[t.jsx(z,{title:"Treffsicherheit Umsatz",value:P.accuracyPct!=null?`${P.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(w,{type:"secondary",children:["MAPE: ",B(P.mapePct)," · n=",P.sampleCount]})]}),t.jsxs(j,{children:[t.jsx(z,{title:"Treffsicherheit Payout",value:E.accuracyPct!=null?`${E.accuracyPct.toLocaleString("de-DE",{maximumFractionDigits:1})} %`:"—"}),t.jsxs(w,{type:"secondary",children:["MAPE: ",B(E.mapePct)," · n=",E.sampleCount]})]}),t.jsxs(j,{children:[t.jsx(z,{title:"Aktueller Delta-Kontostand",value:d?K(d.closingDelta):"—"}),t.jsx(w,{type:"secondary",children:d?`${I(d.month)} ${d.provisional?"(vorlaeufig)":"(abgeschlossen)"}`:"Kein Monat gewählt"})]})]}),t.jsxs(j,{children:[t.jsx(R,{level:4,children:"Kontostand Soll vs. Ist"}),t.jsx(A,{type:"secondary",children:"Linien zeigen Soll/Ist-Kontostand, Balken darunter die Abweichung (Ist minus Soll) pro Monat."}),t.jsx(U,{style:{height:380},option:J})]}),t.jsxs(le,{gutter:[12,12],children:[t.jsx(G,{xs:24,xl:14,children:t.jsxs(j,{children:[t.jsx(R,{level:4,children:"Umsatz & Payout-Quote"}),t.jsx(A,{type:"secondary",children:"Umsatz in EUR als Balken, Payout-Quote als Linien (Soll vs. Ist)."}),t.jsx(U,{style:{height:340},option:X})]})}),t.jsx(G,{xs:24,xl:10,children:t.jsxs(j,{children:[t.jsxs(R,{level:4,children:["Treiber Monat ",d?I(d.month):"—"]}),t.jsx(A,{type:"secondary",children:"Zerlegung des Monats-Effekts auf den Kontostand in Umsatz-/Payout-Effekt und Residuum."}),t.jsx(U,{style:{height:260},option:Y}),t.jsx("div",{className:"v2-svi-driver-list",children:C.map(e=>t.jsxs("div",{className:`v2-svi-driver-row ${e.kind==="total"?"is-total":""}`,children:[t.jsx(w,{children:e.label}),t.jsx(w,{className:e.amount<0?"v2-negative":void 0,children:K(e.amount)})]},e.key))})]})})]}),t.jsxs(j,{children:[t.jsx(R,{level:4,children:"Monatsvergleich"}),t.jsx(A,{type:"secondary",children:"Monat anklicken, um den Treiber- und Detailbereich zu aktualisieren."}),t.jsx(ce,{data:i,columns:ee,minTableWidth:1240,tableLayout:"auto"})]}),t.jsxs(j,{children:[t.jsxs(R,{level:4,children:["Plan-Detail (Auszahlungen) für ",d?I(d.month):"—"]}),t.jsx(A,{type:"secondary",children:"Geplante Auszahlungsstruktur im ausgewählten Monat als Kontext für die Soll-vs-Ist-Differenz."}),t.jsx(he,{size:"small",pagination:!1,rowKey:"key",dataSource:H,columns:[{title:"Gruppe",dataIndex:"label",key:"label",sorter:(e,r)=>String(e.label||"").localeCompare(String(r.label||""),"de-DE")},{title:"Planbetrag",dataIndex:"amount",key:"amount",align:"right",sorter:(e,r)=>Number(e.amount||0)-Number(r.amount||0),render:e=>t.jsx("span",{className:e<0?"v2-negative":void 0,children:K(e)})}],locale:{emptyText:"Keine geplanten Positionen im ausgewählten Monat."}})]})]}):t.jsxs("div",{className:"v2-page",children:[t.jsx(j,{className:"v2-intro-card",children:t.jsx("div",{className:"v2-page-head",children:t.jsxs("div",{children:[t.jsx(R,{level:3,children:"Soll vs. Ist"}),t.jsx(A,{children:"Analyse von Planwerten gegen eingetretene Ist-Werte (Kontostand, Umsatz und Payout)."})]})})}),t.jsx(T,{type:"warning",showIcon:!0,message:"Noch keine Ist-Daten vorhanden",description:"Bitte zuerst Monats-Istwerte in 'Abschluss > Eingaben' pflegen."})]})}export{Ue as default};
