import{p as Qe,a4 as Cn,t as d,k as t,J as wn,L as y,S as w,K as F,O as Je,M as be,a3 as Te,P as de}from"./index-DrOkdIyL.js";import{b as sn}from"./abcClassification-CaF87ldU.js";import{p as Mn}from"./forecastCsv-Bg9-7iuH.js";import{T as jt}from"./TanStackGrid-DNQbnxKh.js";import{S as kt}from"./SkuAliasCell-CL-LWo3A.js";import{b as An,s as $t}from"./categoryOrder-C77cYWrY.js";import{c as Dn,g as In}from"./inventoryProjection-BSwUHpBo.js";import{n as lt,c as Ge,a as Ue,m as Nn,f as Fn}from"./months-DiLwPhVv.js";import{b as Vn,n as Bn,r as En,c as On,a as qt}from"./orderUtils-CdSgcPrO.js";import{n as qe,e as on,a as _e,g as Tn,b as Gt,c as Un,d as Pn,s as Zt,r as zn,f as Rn}from"./forecastVersioning-CgxN5ixE.js";import{n as Ln,b as Wn,c as _n,d as Kn,f as $n,e as qn,g as Gn,h as Zn,i as Hn,s as Jn,j as Qn}from"./tableModels-D8x4D7lf.js";import{h as Xn,g as Yn,s as er}from"./uiPrefs-CxTlE9qM.js";import{u as tr,C as Ie}from"./workspace-hSJpURcw.js";import{T as nr}from"./index-D1FgTqkK.js";import{R as Y}from"./index-D-YTDARI.js";import{C as Ne}from"./index-CwWsayj4.js";import{S as rr}from"./index-Bs0NWQOM.js";import{C as Ht}from"./Collapse-BrChyUuB.js";import{s as me}from"./index-f0YJWE_y.js";import"./foSuggestion-Ck1952gl.js";import"./productCompletenessV2-wFpo7RYV.js";import"./planProducts-CpwZ2WgY.js";import"./Dropdown-QmF6_rIx.js";import"./useBubbleLock-BNNYgWjU.js";function It(n){return String(n||"").trim()}function Xe(n){return It(n).toLowerCase()}function sr(n){return/^\d{4}-\d{2}$/.test(String(n||""))}function Nt(n){const r=Qe(n);return Number.isFinite(r)?Number(r):null}function Jt(n){const r={};return Object.entries(n||{}).forEach(([a,l])=>{const u=It(a);if(!u||!l||typeof l!="object")return;const h={};Object.entries(l).forEach(([S,M])=>{!sr(S)||!M||typeof M!="object"||(h[S]=M)}),Object.keys(h).length&&(r[u]=h)}),r}function or(n){const r=new Map;return(Array.isArray(n)?n:[]).forEach(a=>{const l=It(a==null?void 0:a.sku);if(!l)return;const u=Nt(a==null?void 0:a.avgSellingPriceGrossEUR);!Number.isFinite(u)||Number(u)<=0||(r.set(l,Number(u)),r.set(Xe(l),Number(u)))}),r}function ir(n,r){if(!n)return"C";const a=n.get(r),l=n.get(Xe(r)),u=String((a==null?void 0:a.abcClass)||(l==null?void 0:l.abcClass)||"C").toUpperCase();return u==="A"||u==="B"||u==="C"?u:"C"}function Qt(n){const r=Nt(n==null?void 0:n.units);return Number.isFinite(r)?Number(r):0}function Xt(n,r,a){const l=Nt(n==null?void 0:n.revenueEur);return Number.isFinite(l)?Number(l):Number.isFinite(r)&&Number(r)>0?a*Number(r):0}function ar(n){if(n.abcClass!=="A"&&n.abcClass!=="B")return!1;const r=Math.abs(n.deltaPct)>=20&&Math.abs(n.deltaUnits)>=30,a=Math.abs(n.deltaRevenue)>=1500;return r||a}function cr(n){const r=n.profile||"medium",a=n.comparedAt||new Date().toISOString(),l=Math.max(1,Math.round(Number(n.topN||20))),u=Jt(n.previousImport||{}),h=Jt(n.nextImport||{}),S=or(n.products||[]),M=new Set([...Object.keys(u),...Object.keys(h)]),k=[];M.forEach(p=>{const B=new Set([...Object.keys(u[p]||{}),...Object.keys(h[p]||{})]),fe=ir(n.abcBySku,p);B.forEach(T=>{var ge,q;const ee=(ge=u[p])==null?void 0:ge[T],te=(q=h[p])==null?void 0:q[T];if(!ee&&!te)return;const ne=Qt(ee),re=Qt(te),Fe=re-ne,E=ne===0?re===0?0:100:Fe/Math.abs(ne)*100,se=S.get(p)??S.get(Xe(p))??null,Se=Xt(ee,se,ne),je=Xt(te,se,re),L=je-Se;r==="medium"&&ar({abcClass:fe,deltaPct:E,deltaUnits:Fe,deltaRevenue:L})&&k.push({sku:p,month:T,abcClass:fe,prevUnits:ne,nextUnits:re,deltaUnits:Fe,deltaPct:E,prevRevenue:Se,nextRevenue:je,deltaRevenue:L})})}),k.sort((p,B)=>{const fe=Math.abs(B.deltaRevenue)-Math.abs(p.deltaRevenue);if(fe!==0)return fe;const T=Math.abs(B.deltaUnits)-Math.abs(p.deltaUnits);if(T!==0)return T;const ee=Math.abs(B.deltaPct)-Math.abs(p.deltaPct);return ee!==0?ee:p.sku!==B.sku?p.sku.localeCompare(B.sku):p.month.localeCompare(B.month)});const I=new Set(k.map(p=>Xe(p.sku))),v=new Set(k.filter(p=>p.abcClass==="A"||p.abcClass==="B").map(p=>Xe(p.sku)));return{comparedAt:a,thresholdProfile:r,flaggedSkuCount:I.size,flaggedABCount:v.size,flaggedMonthCount:k.length,topItems:k.slice(0,l)}}const Yt={A:{pct:10,units:50},B:{pct:15,units:80},C:{pct:25,units:120}};function lr(){return new Date().toISOString()}function ur(n){const r=String(n||"").trim().toUpperCase();return r==="A"||r==="B"||r==="C"?r:"C"}function en(n){return n==="A"?0:n==="B"?1:2}function dt(n){const r=Qe(n);return Number.isFinite(r)?Number(r):null}function dr(n){const r=dt(n);return Number.isFinite(r)?Math.max(0,Number(r)):null}function Ct(n,r){return n===0?r===0?0:100:(r-n)/Math.abs(n)*100}function mr(n,r,a){const l=n.get(String(r||"").trim().toLowerCase())||{},u=l==null?void 0:l[a];if(!u||typeof u!="object")return{units:0,revenue:null};const h=dt(u.units),S=dt(u.revenueEur);return{units:Number.isFinite(h)?Number(h):0,revenue:Number.isFinite(S)?Number(S):null}}function Ke(n,r,a){let l=0,u=0,h=!1;return a.forEach(S=>{const M=mr(n,r,S);l+=Number(M.units||0),Number.isFinite(M.revenue)&&(u+=Number(M.revenue||0),h=!0)}),{units:l,revenue:h?u:null}}function tn(n){const r=new Map;return Object.entries(n||{}).forEach(([a,l])=>{const u=String(a||"").trim();!u||!l||typeof l!="object"||r.set(u.toLowerCase(),l)}),r}function fr(n){const r=["targetDeliveryDate","deliveryDate","etaDate","etaManual","eta","arrivalDate","arrivalDateDe"];for(const a of r){const l=String((n==null?void 0:n[a])||"").trim();if(/^\d{4}-\d{2}-\d{2}$/.test(l))return l}return null}function hr(n,r,a){var S;const l=Number(n.productionLeadTimeDays||0)+Number(n.logisticsLeadTimeDays||0)+Number(n.bufferDays||0);if(Number.isFinite(l)&&l>0)return Math.round(l);const u=Number((r==null?void 0:r.productionLeadTimeDaysDefault)||0)+Number((r==null?void 0:r.transitDays)||0)+Number((a==null?void 0:a.defaultBufferDays)||0);if(Number.isFinite(u)&&u>0)return Math.round(u);const h=Number((a==null?void 0:a.defaultProductionLeadTimeDays)||0)+Number(((S=a==null?void 0:a.transportLeadTimesDays)==null?void 0:S.sea)||0)+Number((a==null?void 0:a.defaultBufferDays)||0);return Number.isFinite(h)&&h>0?Math.round(h):0}function gr(n){const r=new Map;return(Array.isArray(n.suppliers)?n.suppliers:[]).forEach(a=>{const l=a,u=String(l.id||"").trim();u&&r.set(u,String(l.name||u))}),r}function pr(n){const r=new Map;return(Array.isArray(n.products)?n.products:[]).forEach(a=>{const l=a,u=String(l.sku||"").trim();if(!u)return;const h=dt(l.avgSellingPriceGrossEUR);!Number.isFinite(h)||Number(h)<=0||r.set(u.toLowerCase(),Number(h))}),r}function yr(n){const r=new Map;return(Array.isArray(n.products)?n.products:[]).forEach(a=>{const l=a,u=String(l.sku||"").trim();u&&r.set(u.toLowerCase(),String(l.alias||u))}),r}function vr(n){const r=structuredClone(n||{}),a=sn(r),l=new Map;return a.bySku.forEach((u,h)=>{const S=String(h||"").trim().toLowerCase();S&&l.set(S,ur(u==null?void 0:u.abcClass))}),l}function br(n,r){const a=Nn(r,12),l=Dn({state:n,months:a,products:Array.isArray(n.products)?n.products:[],projectionMode:"units"}),u=new Map;return l.perSkuMonth.forEach((h,S)=>{const M=String(S||"").trim().toLowerCase();if(!M)return;let k=null;a.forEach(I=>{if(k)return;const v=h==null?void 0:h.get(I);if(!v)return;const p=In({projectionMode:"units",endAvailable:v.endAvailable,safetyUnits:v.safetyUnits,doh:v.doh,safetyDays:v.safetyDays});(p==="safety-low"||p==="safety-negative")&&(k=I)}),u.set(M,{hasSafetyRisk:!!k,firstSafetyMonth:k})}),u}function xr(n){const r=n.abcClass==="A"?0:n.abcClass==="B"?1e3:2e3,a=n.recommendedArrivalMonth?Number(String(n.recommendedArrivalMonth).replace("-","")):999999,l=n.conflictTypes.includes("timing_too_late")?-150:n.conflictTypes.includes("units_too_small")?-90:n.conflictTypes.includes("timing_too_early")?-20:0,u=n.firstSafetyMonth?-40:0;return r+a+l+u}function ut(n){var L,he,ge,q,Ze,ke;const r=lt(n.nowMonth||Ge())||Ge(),a=[r],l=[r,Ue(r,1),Ue(r,2)],u=[r,Ue(r,1),Ue(r,2),Ue(r,3),Ue(r,4),Ue(r,5)],h=lr(),S=qe(((L=n.fromVersion)==null?void 0:L.forecastImport)||{}),M=qe(((he=n.toVersion)==null?void 0:he.forecastImport)||{}),k=tn(S),I=tn(M),v=structuredClone(n.state||{});(!v.forecast||typeof v.forecast!="object")&&(v.forecast={}),v.forecast.forecastImport=structuredClone(M);const p=vr(v),B=yr(v),fe=pr(v),T=br(v,r),ee=new Set([...Array.from(k.keys()),...Array.from(I.keys()),...(Array.isArray(v.products)?v.products:[]).map(m=>String((m==null?void 0:m.sku)||"").trim().toLowerCase()).filter(Boolean)]),te=Array.from(ee).map(m=>{const D=p.get(m)||"C",O=Yt[D],U=Ke(k,m,a),G=Ke(k,m,l),Z=Ke(k,m,u),oe=Ke(I,m,a),ie=Ke(I,m,l),V=Ke(I,m,u),H=oe.units-U.units,P=ie.units-G.units,ae=V.units-Z.units,W=Ct(U.units,oe.units),Ve=Ct(G.units,ie.units),ce=Ct(Z.units,V.units),K=fe.get(m)??null,Pe=Number.isFinite(U.revenue)&&Number.isFinite(oe.revenue)?Number(oe.revenue||0)-Number(U.revenue||0):Number.isFinite(K)?H*Number(K):null,Ce=Number.isFinite(G.revenue)&&Number.isFinite(ie.revenue)?Number(ie.revenue||0)-Number(G.revenue||0):Number.isFinite(K)?P*Number(K):null,le=Number.isFinite(Z.revenue)&&Number.isFinite(V.revenue)?Number(V.revenue||0)-Number(Z.revenue||0):Number.isFinite(K)?ae*Number(K):null,pe=T.get(m)||{hasSafetyRisk:!1,firstSafetyMonth:null},ue=Math.abs(Ve)>O.pct||Math.abs(P)>O.units,ye=[];ue&&ye.push("abc_threshold"),pe.hasSafetyRisk&&ye.push("safety_risk");const Be=ue||pe.hasSafetyRisk;return{sku:m.toUpperCase(),alias:B.get(m)||m.toUpperCase(),abcClass:D,delta1Units:H,delta1Pct:W,delta3Units:P,delta3Pct:Ve,delta6Units:ae,delta6Pct:ce,delta1Revenue:Pe,delta3Revenue:Ce,delta6Revenue:le,flagged:Be,reasons:ye,firstSafetyMonth:pe.firstSafetyMonth}}).sort((m,D)=>{const O=en(m.abcClass)-en(D.abcClass);if(O!==0)return O;const U=Math.abs(D.delta3Units)-Math.abs(m.delta3Units);return U!==0?U:m.sku.localeCompare(D.sku)}),ne=v.settings||{},re=Array.isArray(v.products)?v.products:[],Fe=gr(v),E=Vn(v),se=(Array.isArray(v.fos)?v.fos:[]).map(m=>m).filter(m=>{const D=Bn(m.status);return D==="ACTIVE"||D==="DRAFT"}).map(m=>{const D=String(m.id||"").trim(),O=String(m.sku||"").trim(),U=O.toLowerCase();if(!D||!U)return null;const G=En(re,O),Z=p.get(U)||"C",oe=Yt[Z],ie=hr(m,G,ne),V=On({context:E,sku:O,leadTimeDays:ie,product:G,settings:ne,horizonMonths:12});if(!V||String(V.status||"")!=="ok")return null;const H=String(V.requiredArrivalDate||"")||null,P=H?H.slice(0,7):null,ae=String(V.orderDateAdjusted||V.orderDate||"")||null,W=Math.max(0,Math.round(Number(V.recommendedUnits||0))),Ve=dr(V.coverageDays),ce=Math.max(0,Math.round(Number(m.units||0))),K=String(m.targetDeliveryDate||"")||null,Pe=String(m.etaDate||"")||null,Ce=fr(m),le=Ce?Ce.slice(0,7):null,pe=T.get(U)||{hasSafetyRisk:!1,firstSafetyMonth:null},ue=pe.firstSafetyMonth,ye=ce-W,Be=W>0?ye/W*100:ce>0?100:0,He=Math.abs(Be)>oe.pct||Math.abs(ye)>oe.units,J=[];if(ce<W&&(He||pe.hasSafetyRisk)&&J.push("units_too_small"),ce>W&&He&&J.push("units_too_large"),le&&(P&&le>P||ue&&le>ue)&&J.push("timing_too_late"),le&&P&&le<P&&ce>W&&He&&J.push("timing_too_early"),!J.length)return null;const mt=xr({abcClass:Z,firstSafetyMonth:ue,conflictTypes:J,recommendedArrivalMonth:P});return{foId:D,sku:O,alias:B.get(U)||O,abcClass:Z,supplierName:Fe.get(String(m.supplierId||""))||String(m.supplierId||"—"),supplierId:String(m.supplierId||""),conflictTypes:J,currentUnits:ce,currentTargetDeliveryDate:K,currentEtaDate:Pe,firstMonthBelowSafety:ue,requiredArrivalDate:H,requiredArrivalMonth:P,recommendedUnits:W,recommendedOrderDate:ae,recommendedArrivalDate:H,recommendedArrivalMonth:P,recommendedCoverageDays:Ve,recommendedStatus:String(V.status||""),severityScore:mt,rawFo:m}}).filter(Boolean);se.sort((m,D)=>m.severityScore!==D.severityScore?m.severityScore-D.severityScore:m.requiredArrivalMonth!==D.requiredArrivalMonth?String(m.requiredArrivalMonth||"").localeCompare(String(D.requiredArrivalMonth||"")):m.foId.localeCompare(D.foId));const Se=te.filter(m=>m.flagged),je={comparedAt:h,fromVersionId:(ge=n.fromVersion)!=null&&ge.id?String(n.fromVersion.id):null,fromVersionName:(q=n.fromVersion)!=null&&q.name?String(n.fromVersion.name):null,toVersionId:(Ze=n.toVersion)!=null&&Ze.id?String(n.toVersion.id):null,toVersionName:(ke=n.toVersion)!=null&&ke.name?String(n.toVersion.name):null,flaggedSkus:Se.length,flaggedAB:Se.filter(m=>m.abcClass==="A"||m.abcClass==="B").length,foConflictsTotal:se.length,foConflictsOpen:se.length};return{comparedAt:h,months:{now:r,months1:a,months3:l,months6:u},skuRows:te,foConflicts:se,summary:je}}const{Paragraph:nn,Text:b,Title:$e}=wn,rn=[{value:"next6",label:"Nächste 6",count:6},{value:"next12",label:"Nächste 12",count:12},{value:"next18",label:"Nächste 18",count:18},{value:"all",label:"Alle",count:null}];function at(){return new Date().toISOString()}function Sr(n="id"){return`${n}-${Math.random().toString(36).slice(2,10)}-${Date.now().toString(36)}`}function xe(n){(!n.forecast||typeof n.forecast!="object")&&(n.forecast={items:[],settings:{useForecast:!1},forecastImport:{},forecastManual:{},versions:[],activeVersionId:null,lastImpactSummary:null,foConflictDecisionsByVersion:{},lastImportAt:null,importSource:null});const r=n.forecast;(!r.settings||typeof r.settings!="object")&&(r.settings={useForecast:!1}),(!r.forecastManual||typeof r.forecastManual!="object")&&(r.forecastManual={}),on(r)}function _(n,r=0){return Number.isFinite(n)?Number(n).toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"—"}function ct(n,r=0){if(!Number.isFinite(n))return"—";const a=Number(n);return`${a>0?"+":""}${a.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r})}`}function wt(n){if(!Number.isFinite(n))return"—";const r=Number(n);return`${r>0?"+":""}${r.toLocaleString("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1})} %`}function At(n){if(!n||typeof n!="object")return null;const r=n,a=String(r.comparedAt||"").trim(),l=r.toVersionId==null?null:String(r.toVersionId||"").trim()||null;return!a||!l?null:{comparedAt:a,fromVersionId:r.fromVersionId==null?null:String(r.fromVersionId||"").trim()||null,fromVersionName:r.fromVersionName==null?null:String(r.fromVersionName||""),toVersionId:l,toVersionName:r.toVersionName==null?null:String(r.toVersionName||""),flaggedSkus:Math.max(0,Math.round(Number(r.flaggedSkus||0))),flaggedAB:Math.max(0,Math.round(Number(r.flaggedAB||0))),foConflictsTotal:Math.max(0,Math.round(Number(r.foConflictsTotal||0))),foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function an(n,r){const a=n==null?void 0:n[r];return!a||typeof a!="object"?!1:a.ignored===!0}function Dt(n,r){return n.foConflicts.filter(a=>!an(r,a.foId)).length}function jr(n){return n==="units_too_small"?"Menge zu klein":n==="units_too_large"?"Menge zu groß":n==="timing_too_late"?"Timing zu spät":n==="timing_too_early"?"Timing zu früh":n}function Mt(n,r){const a=At(r.lastImpactSummary);if(!a)return;const l=Array.isArray(r.versions)?r.versions:[],u=l.find(I=>I.id===a.toVersionId)||null;if(!u){r.lastImpactSummary=null;return}const h=a.fromVersionId&&l.find(I=>I.id===a.fromVersionId)||null,S=ut({state:n,fromVersion:h,toVersion:u,nowMonth:Ge()}),M=r.foConflictDecisionsByVersion&&typeof r.foConflictDecisionsByVersion=="object"?r.foConflictDecisionsByVersion:{},k=M[u.id]&&typeof M[u.id]=="object"?M[u.id]:{};r.lastImpactSummary={...S.summary,foConflictsOpen:Dt(S,k)}}function Zr(){var _t;const{state:n,loading:r,saving:a,error:l,lastSavedAt:u,saveWith:h}=tr(),S=Cn(),M=Xn("forecast"),[k,I]=d.useState("grid"),[v,p]=d.useState(""),[B,fe]=d.useState("next12"),[T,ee]=d.useState("units"),[te,ne]=d.useState(!0),[re,Fe]=d.useState(!1),[E,se]=d.useState({}),[Se,je]=d.useState(!1),[L,he]=d.useState([]),[ge,q]=d.useState([]),[Ze,ke]=d.useState(""),[m,D]=d.useState("merge"),[O,U]=d.useState(!0),[G,Z]=d.useState(""),[oe,ie]=d.useState(""),[V,H]=d.useState(""),[P,ae]=d.useState(!1),[W,Ve]=d.useState(!1),[ce,K]=d.useState(!1),[Pe,Ce]=d.useState(null),[le,pe]=d.useState(""),[ue,ye]=d.useState(""),[Be,He]=d.useState(!0),[J,mt]=d.useState(!1),[cn,ft]=d.useState(!1),[ht,Ft]=d.useState([]),[Ye,et]=d.useState(()=>Yn("forecast")),[Vt,tt]=d.useState([]),gt=n.settings||{},ze=n.forecast||{},Ee=ze.forecastImport||{},we=n;d.useEffect(()=>{const e=new URLSearchParams(S.search).get("panel");if(e==="versions"){I("versions");return}if(e==="impact"||e==="conflicts"){I("impact");return}},[S.search]),d.useEffect(()=>{se(Ln(ze.forecastManual||{})),je(!1)},[ze.forecastManual]);const Re=d.useMemo(()=>Wn(gt),[gt.horizonMonths,gt.startMonth]),Le=d.useMemo(()=>{const e=rn.find(o=>o.value===B);return!e||e.count==null?Re:Re.slice(0,e.count)},[Re,B]),Bt=d.useMemo(()=>_n(we),[we]),nt=d.useMemo(()=>An(we),[n.productCategories,we]),Me=d.useMemo(()=>Kn(we,Bt),[Bt,we]),ln=d.useMemo(()=>{const e=new Map;return(Array.isArray(n.products)?n.products:[]).map(o=>o).forEach(o=>{const s=String(o.sku||"").trim();s&&e.set(s.toLowerCase(),o)}),e},[n.products]),rt=d.useMemo(()=>Me.filter(e=>e.isActive).filter(e=>{const o=Number(e.sellerboardMarginPct);return!(Number.isFinite(o)&&o>0&&o<=100)}),[Me]),pt=d.useMemo(()=>$n({products:Me,search:v,onlyActive:te,onlyWithForecast:re,visibleMonths:Le,manualDraft:E,forecastImport:Ee}),[Ee,E,te,re,Me,v,Le]),ve=d.useMemo(()=>{const e=new Map;pt.forEach(s=>{var c;const i=String(s.categoryLabel||"Ohne Kategorie");e.has(i)||e.set(i,[]),(c=e.get(i))==null||c.push(s)});const o=Array.from(e.entries()).map(([s,i])=>({key:s,label:s,rows:i.sort((c,f)=>c.sku.localeCompare(f.sku))}));return $t(o,nt)},[nt,pt]);d.useEffect(()=>{et(e=>{if(!ve.length)return[];const o=new Set(ve.map(i=>i.key)),s=e.filter(i=>o.has(i));return s.length||M?s:ve.map(i=>i.key)})},[ve,M]),d.useEffect(()=>{er("forecast",Ye)},[Ye]);const yt=d.useMemo(()=>qn({allMonths:Re,products:Me,manualDraft:E,forecastImport:Ee}),[Re,Ee,E,Me]),$=d.useMemo(()=>{const e=structuredClone(ze||{});return on(e),e},[ze]),st=d.useMemo(()=>(Array.isArray($.versions)?$.versions:[]).slice().sort((o,s)=>String(s.createdAt||"").localeCompare(String(o.createdAt||""))),[$.versions]),vt=d.useMemo(()=>new Map(st.map(e=>[e.id,e])),[st]),ot=d.useMemo(()=>_e($),[$]),Q=(ot==null?void 0:ot.id)||null,un=d.useMemo(()=>Tn($),[$]),N=d.useMemo(()=>At($.lastImpactSummary),[$.lastImpactSummary]),bt=$.foConflictDecisionsByVersion&&typeof $.foConflictDecisionsByVersion=="object"?$.foConflictDecisionsByVersion:{},Et=Q&&bt[Q]&&typeof bt[Q]=="object"?bt[Q]:{},Oe=d.useMemo(()=>{if(!(N!=null&&N.toVersionId))return null;const e=vt.get(N.toVersionId)||null;if(!e)return null;const o=N.fromVersionId&&vt.get(N.fromVersionId)||null;return ut({state:we,fromVersion:o,toVersion:e,nowMonth:Ge()})},[N,n.forecast,n.fos,n.inventory,n.pos,n.products,n.settings,n.suppliers,we,vt]),xt=d.useMemo(()=>{if(!Oe)return[];const e=new Map;return Me.forEach(o=>{e.set(String(o.sku||"").trim().toLowerCase(),String(o.categoryLabel||"Ohne Kategorie"))}),Oe.skuRows.map(o=>({...o,categoryLabel:e.get(String(o.sku||"").trim().toLowerCase())||"Ohne Kategorie"}))},[Oe,Me]),Ot=d.useMemo(()=>Be?xt.filter(o=>o.flagged):xt,[xt,Be]),Ae=d.useMemo(()=>{const e=new Map;Ot.forEach(s=>{var c;const i=String(s.categoryLabel||"Ohne Kategorie");e.has(i)||e.set(i,[]),(c=e.get(i))==null||c.push(s)});const o=Array.from(e.entries()).map(([s,i])=>({key:s,label:s,rows:i}));return $t(o,nt)},[nt,Ot]);d.useEffect(()=>{tt(e=>{if(!Ae.length)return[];const o=new Set(Ae.map(i=>i.key)),s=e.filter(i=>o.has(i));return s.length?s:Ae.map(i=>i.key)})},[Ae]);const it=d.useMemo(()=>Oe?Oe.foConflicts.map(e=>({...e,ignored:an(Et,e.foId)})):[],[Et,Oe]),We=d.useMemo(()=>it.filter(e=>!e.ignored),[it]),Tt=d.useMemo(()=>J?it:We,[it,We,J]),Ut=N&&Q&&N.toVersionId===Q?N.foConflictsOpen:0,dn=d.useMemo(()=>{const e=[{header:"Alias",accessorKey:"alias",meta:{width:300,minWidth:300},cell:({row:s})=>t.jsx(kt,{alias:s.original.alias||(s.original.isPlan?s.original.plannedSku:s.original.sku),sku:s.original.sku})},{header:"Status",meta:{width:86,minWidth:86},cell:({row:s})=>s.original.isPlan?t.jsx(y,{color:"blue",children:"Plan"}):s.original.isActive?t.jsx(y,{color:"green",children:"Aktiv"}):t.jsx(y,{children:"Inaktiv"})}],o=Le.map(s=>({id:s,header:Fn(s),meta:{width:118,minWidth:118,align:"right"},cell:({row:i})=>{var z;const c=i.original.sku,f=(z=E==null?void 0:E[c])==null?void 0:z[s],g=Gn(Ee,c,s),x=Zn(E,Ee,c,s,i.original.plannedUnitsByMonth);if(T==="units")return i.original.isPlan?t.jsxs("div",{className:"v2-forecast-cell",children:[t.jsx("div",{children:_(x,0)}),t.jsx(b,{type:"secondary",style:{fontSize:11},children:"Quelle: Plan (Baseline + Saisonalitaet)"})]}):t.jsxs("div",{className:"v2-forecast-cell",children:[t.jsx(nr,{className:"v2-grid-input",value:Number.isFinite(f)?f:null,onChange:C=>{se(A=>{const R={...A},X={...R[c]||{}},De=typeof C=="number"&&Number.isFinite(C)?C:null;return De==null?delete X[s]:X[s]=De,Object.keys(X).length?R[c]=X:delete R[c],R}),je(!0)},min:0,controls:!1,placeholder:Number.isFinite(x)?String(Math.round(Number(x))):"—",style:{width:"100%"}}),t.jsxs(b,{type:"secondary",style:{fontSize:11},children:["Imp: ",_((g==null?void 0:g.units)??null,0)]})]});const j=Hn(T,x,i.original);return t.jsxs("div",{children:[t.jsx("div",{children:_(j,2)}),t.jsxs(b,{type:"secondary",style:{fontSize:11},children:["Units: ",_(x,0)]})]})}}));return[...e,...o]},[Ee,E,T,Le]),mn=d.useMemo(()=>[{header:"Alias",accessorKey:"alias",meta:{width:260,minWidth:260},cell:({row:e})=>t.jsx(kt,{alias:e.original.alias,sku:e.original.sku})},{header:"ABC",accessorKey:"abcClass",meta:{width:80,minWidth:80,align:"center"},cell:({row:e})=>t.jsx(y,{color:e.original.abcClass==="A"?"red":e.original.abcClass==="B"?"gold":"blue",children:e.original.abcClass})},{header:"Δ 1M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ct(e.original.delta1Units,0)},{header:"Δ 1M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>wt(e.original.delta1Pct)},{header:"Δ 3M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ct(e.original.delta3Units,0)},{header:"Δ 3M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>wt(e.original.delta3Pct)},{header:"Δ 6M Units",meta:{width:120,minWidth:120,align:"right"},cell:({row:e})=>ct(e.original.delta6Units,0)},{header:"Δ 6M %",meta:{width:100,minWidth:100,align:"right"},cell:({row:e})=>wt(e.original.delta6Pct)},{header:"Δ Umsatz 3M",meta:{width:130,minWidth:130,align:"right"},cell:({row:e})=>ct(e.original.delta3Revenue,2)},{header:"Flags",meta:{width:170,minWidth:170},cell:({row:e})=>t.jsxs(w,{wrap:!0,children:[e.original.flagged?t.jsx(y,{color:"gold",children:"Review"}):t.jsx(y,{color:"green",children:"OK"}),e.original.reasons.includes("safety_risk")?t.jsx(y,{color:"red",children:"Safety"}):null,e.original.reasons.includes("abc_threshold")?t.jsx(y,{color:"blue",children:"Δ3M"}):null]})}],[]);function St(){he([]),q([]),ke(""),Z(""),ie(""),H(""),ae(!1)}function fn(e){const o=m==="overwrite"?{}:structuredClone(qe(e||{}));return L.forEach(s=>{const i=String(s.sku||"").trim();if(!i)return;const c=lt(s.month);if(!c)return;const f=ln.get(i.toLowerCase())||null;f&&(O&&!Qn(f)||((!o[i]||typeof o[i]!="object")&&(o[i]={}),o[i][c]={units:s.units,revenueEur:s.revenueEur,profitEur:s.profitEur}))}),qe(o)}async function hn(){await h(e=>{const o=de(e),s=o;xe(s);const i=s.forecast;return i.forecastManual=Jn(E),o},"v2:forecast:manual-save"),je(!1)}async function gn(e){await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=c.settings||{};return f.useForecast=e,c.settings=f,s},"v2:forecast:toggle-useForecast")}async function pn(e){ke(""),q([]);try{const o=await e.text(),s=Mn(o);if(s.error){he([]),ke(s.error),q(s.warnings||[]),ae(!1);return}const i=(s.records||[]).map(c=>({sku:String(c.sku||"").trim(),month:lt(c.month)||String(c.month||""),units:Qe(c.units),revenueEur:Qe(c.revenueEur),profitEur:Qe(c.profitEur)})).filter(c=>c.sku&&lt(c.month));if(!i.length){he([]),ke("Keine gültigen Forecast-Zeilen erkannt."),q(s.warnings||[]),ae(!1);return}he(i),q(s.warnings||[]),Z(e.name),ie(Gt(new Date)),H(""),ae(!0)}catch(o){ke(o instanceof Error?o.message:"Datei konnte nicht gelesen werden."),he([]),ae(!1)}}async function Pt(e){if(L.length){Ve(!0);try{const o=at(),s=G||"VentoryOne CSV",i=String(oe||"").trim()||Gt(new Date(o)),c=String(V||"").trim()||null,f=ot||null,g=fn((f==null?void 0:f.forecastImport)||{});if(!Object.keys(g).length)throw new Error("Keine gültigen Zeilen für den aktuellen Import-Filter.");const x=Un({name:i,note:c,createdAt:o,sourceLabel:s,importMode:m,onlyActiveSkus:O,forecastImport:g});await h(j=>{const z=de(j),C=z;xe(C);const A=C.forecast,R=_e(A),X=Pn(A,x);if(A.lastImportAt=o,A.importSource=s,A.importCadence="monthly",A.lastDriftSummary=cr({previousImport:qe((R==null?void 0:R.forecastImport)||{}),nextImport:qe(X.forecastImport||{}),products:Array.isArray(C.products)?C.products:[],abcBySku:sn(C).bySku,comparedAt:o,profile:"medium"}),e==="activate"){const De=Zt(A,X.id,{touchImportMeta:!0});if(!De.ok)throw new Error(De.reason||"Baseline konnte nicht aktiviert werden.");const Kt=ut({state:C,fromVersion:R,toVersion:De.version||X,nowMonth:Ge()}),kn=(A.foConflictDecisionsByVersion&&typeof A.foConflictDecisionsByVersion=="object"?A.foConflictDecisionsByVersion:{})[X.id]||{};A.lastImpactSummary={...Kt.summary,foConflictsOpen:Dt(Kt,kn)}}return z},e==="activate"?"v2:forecast:import:activate":"v2:forecast:import:save"),e==="activate"?(I("impact"),me.success("Version gespeichert und als aktive Baseline gesetzt.")):me.success("Version gespeichert. Baseline bleibt unverändert."),St()}catch(o){me.error(o instanceof Error?o.message:"Import konnte nicht gespeichert werden.")}finally{Ve(!1)}}}async function yn(){ht.length&&(await h(e=>{var f;const o=de(e),s=o,i=Array.isArray(s.incomings)?[...s.incomings]:[],c=(f=i.slice().reverse().find(g=>String(g.payoutPct||"").trim()))==null?void 0:f.payoutPct;return ht.forEach(g=>{const x=Number(yt.get(g)||0),j=i.findIndex(z=>String(z.month||"")===g);if(j>=0){i[j]={...i[j],month:g,revenueEur:x,payoutPct:i[j].payoutPct||c||"0",source:"forecast"};return}i.push({month:g,revenueEur:x,payoutPct:c||"0",source:"forecast"})}),i.sort((g,x)=>String(g.month||"").localeCompare(String(x.month||""))),s.incomings=i,o},"v2:forecast:transfer-revenue"),ft(!1))}function vn(e){Ce(e.id),pe(e.name||""),ye(e.note||""),K(!0)}async function bn(){if(Pe)try{await h(e=>{const o=de(e),s=o;xe(s);const i=s.forecast;if(!zn(i,Pe,{name:le,note:ue}))throw new Error("Version nicht gefunden.");return o},"v2:forecast:version:rename"),K(!1),Ce(null),me.success("Version aktualisiert.")}catch(e){me.error(e instanceof Error?e.message:"Version konnte nicht gespeichert werden.")}}function xn(e){!(e!=null&&e.id)||e.id===Q||Te.confirm({title:"Aktive Baseline wechseln?",content:`Neue Baseline: ${e.name}`,okText:"Baseline wechseln",cancelText:"Abbrechen",onOk:async()=>{await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=_e(c),g=Zt(c,e.id,{touchImportMeta:!0});if(!g.ok)throw new Error(g.reason||"Baseline konnte nicht gesetzt werden.");const x=g.version||_e(c);if(!x)throw new Error("Aktive Baseline fehlt.");const j=ut({state:i,fromVersion:f,toVersion:x,nowMonth:Ge()}),C=(c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"?c.foConflictDecisionsByVersion:{})[x.id]||{};return c.lastImpactSummary={...j.summary,foConflictsOpen:Dt(j,C)},s},"v2:forecast:version:activate"),I("impact"),me.success("Baseline gewechselt. Impact-Analyse wurde aktualisiert.")}})}function Sn(e){e!=null&&e.id&&Te.confirm({title:"Version löschen?",content:`Die Version "${e.name}" wird dauerhaft gelöscht.`,okText:"Version löschen",okType:"danger",cancelText:"Abbrechen",onOk:async()=>{await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=Rn(c,e.id);if(!f.ok)throw f.reason==="ACTIVE_VERSION"?new Error("Aktive Baseline kann nicht gelöscht werden. Bitte zuerst Baseline wechseln."):new Error("Version konnte nicht gelöscht werden.");if(c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"){const x={...c.foConflictDecisionsByVersion};delete x[e.id],c.foConflictDecisionsByVersion=x}const g=At(c.lastImpactSummary);return g&&(g.toVersionId===e.id||g.fromVersionId===e.id)&&(c.lastImpactSummary=null),s},"v2:forecast:version:delete"),me.success("Version gelöscht.")}})}function zt(e,o,s){if(!o)return;const i=e.foConflictDecisionsByVersion&&typeof e.foConflictDecisionsByVersion=="object"?{...e.foConflictDecisionsByVersion}:{},c={...i[o]||{}};delete c[s],i[o]=c,e.foConflictDecisionsByVersion=i}function Rt(e){e.ignored||Te.confirm({title:`FO ${e.foId} aktualisieren?`,content:t.jsxs(w,{direction:"vertical",size:4,children:[t.jsxs(b,{children:["Aktuell: ",_(e.currentUnits,0)," Units · Target ",e.currentTargetDeliveryDate||"—"]}),t.jsxs(b,{children:["Neu: ",_(e.recommendedUnits,0)," Units · Arrival ",e.recommendedArrivalDate||"—"]})]}),okText:"FO aktualisieren",cancelText:"Abbrechen",onOk:async()=>{await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=_e(c),g=Array.isArray(s.fos)?[...s.fos]:[],x=g.findIndex(R=>String(R.id||"")===e.foId);if(x<0)throw new Error("FO nicht gefunden.");const j=g[x],z=e.recommendedArrivalDate||e.requiredArrivalDate||String(j.targetDeliveryDate||"")||null,C=qt({targetDeliveryDate:z,productionLeadTimeDays:j.productionLeadTimeDays,logisticsLeadTimeDays:j.logisticsLeadTimeDays,bufferDays:j.bufferDays}),A=at();return g[x]={...j,units:Math.max(0,Math.round(Number(e.recommendedUnits||0))),targetDeliveryDate:z,orderDate:C.orderDate,productionEndDate:C.productionEndDate,etdDate:C.etdDate,etaDate:C.etaDate,deliveryDate:C.deliveryDate,forecastBasisVersionId:(f==null?void 0:f.id)||null,forecastBasisVersionName:(f==null?void 0:f.name)||null,forecastBasisSetAt:A,forecastConflictState:"reviewed_updated",supersededByFoId:null,updatedAt:A},s.fos=g,zt(c,(f==null?void 0:f.id)||null,e.foId),Mt(i,c),s},"v2:forecast:conflict:update"),me.success(`FO ${e.foId} wurde aktualisiert.`)}})}function Lt(e){e.ignored||Te.confirm({title:`Draft-FO für ${e.foId} erzeugen?`,content:t.jsxs(w,{direction:"vertical",size:4,children:[t.jsxs(b,{children:["Neue Draft-FO: ",_(e.recommendedUnits,0)," Units · Arrival ",e.recommendedArrivalDate||"—"]}),t.jsx(b,{children:"Bestehende FO bleibt erhalten und wird als superseded markiert."})]}),okText:"Draft erzeugen",cancelText:"Abbrechen",onOk:async()=>{await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=_e(c),g=Array.isArray(s.fos)?[...s.fos]:[],x=g.findIndex(De=>String(De.id||"")===e.foId);if(x<0)throw new Error("FO nicht gefunden.");const j=g[x],z=e.recommendedArrivalDate||e.requiredArrivalDate||String(j.targetDeliveryDate||"")||null,C=qt({targetDeliveryDate:z,productionLeadTimeDays:j.productionLeadTimeDays,logisticsLeadTimeDays:j.logisticsLeadTimeDays,bufferDays:j.bufferDays}),A=at(),R=Sr("fo"),X={...j,id:R,status:"DRAFT",units:Math.max(0,Math.round(Number(e.recommendedUnits||0))),targetDeliveryDate:z,orderDate:C.orderDate,productionEndDate:C.productionEndDate,etdDate:C.etdDate,etaDate:C.etaDate,deliveryDate:C.deliveryDate,convertedPoId:null,convertedPoNo:null,forecastBasisVersionId:(f==null?void 0:f.id)||null,forecastBasisVersionName:(f==null?void 0:f.name)||null,forecastBasisSetAt:A,forecastConflictState:"review_needed",supersedesFoId:String(j.id||e.foId),supersededByFoId:null,createdAt:A,updatedAt:A};return g[x]={...j,forecastConflictState:"superseded",supersededByFoId:R,updatedAt:A},g.push(X),s.fos=g,zt(c,(f==null?void 0:f.id)||null,e.foId),Mt(i,c),s},"v2:forecast:conflict:draft"),me.success(`Neue Draft-FO zu ${e.foId} erstellt.`)}})}async function Wt(e){e.ignored||!Q||(await h(o=>{const s=de(o),i=s;xe(i);const c=i.forecast,f=c.foConflictDecisionsByVersion&&typeof c.foConflictDecisionsByVersion=="object"?{...c.foConflictDecisionsByVersion}:{},g={...f[Q]||{}};return g[e.foId]={ignored:!0,ignoredAt:at(),reason:"manual_ignore"},f[Q]=g,c.foConflictDecisionsByVersion=f,Mt(i,c),s},"v2:forecast:conflict:ignore"),me.success(`FO ${e.foId} für diese Forecast-Version ignoriert.`))}const jn=d.useMemo(()=>[{header:"FO",meta:{width:90,minWidth:90},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsx(b,{strong:!0,children:String(e.original.foId||"").slice(-6).toUpperCase()}),e.original.ignored?t.jsx(y,{color:"default",children:"Ignoriert"}):t.jsx(y,{color:"gold",children:"To Review"})]})},{header:"Produkt",meta:{width:220,minWidth:220},cell:({row:e})=>t.jsx(kt,{alias:e.original.alias,sku:e.original.sku})},{header:"Supplier",accessorKey:"supplierName",meta:{width:170,minWidth:170}},{header:"Aktuelle FO",meta:{width:190,minWidth:190},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(b,{children:[_(e.original.currentUnits,0)," Units"]}),t.jsxs(b,{type:"secondary",children:["Target: ",e.original.currentTargetDeliveryDate||"—"]}),t.jsxs(b,{type:"secondary",children:["ETA: ",e.original.currentEtaDate||"—"]})]})},{header:"Neuer Forecast",meta:{width:190,minWidth:190},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(b,{children:["Safety-Bruch: ",e.original.firstMonthBelowSafety||"—"]}),t.jsxs(b,{type:"secondary",children:["Required Arrival: ",e.original.requiredArrivalDate||"—"]})]})},{header:"Empfehlung",meta:{width:210,minWidth:210},cell:({row:e})=>t.jsxs(w,{direction:"vertical",size:0,children:[t.jsxs(b,{children:[_(e.original.recommendedUnits,0)," Units"]}),t.jsxs(b,{type:"secondary",children:["Order: ",e.original.recommendedOrderDate||"—"]}),t.jsxs(b,{type:"secondary",children:["Arrival: ",e.original.recommendedArrivalDate||"—"]})]})},{header:"Konflikte",meta:{width:220,minWidth:220},cell:({row:e})=>t.jsx(w,{wrap:!0,children:e.original.conflictTypes.map(o=>t.jsx(y,{color:o.includes("late")||o.includes("small")?"red":"orange",children:jr(o)},`${e.original.foId}-${o}`))})},{header:"Aktionen",meta:{width:310,minWidth:310},cell:({row:e})=>t.jsxs("div",{className:"v2-actions-nowrap",children:[t.jsx(F,{size:"small",disabled:e.original.ignored,onClick:()=>Rt(e.original),children:"FO aktualisieren"}),t.jsx(F,{size:"small",disabled:e.original.ignored,onClick:()=>Lt(e.original),children:"Als Draft neu erzeugen"}),t.jsx(F,{size:"small",disabled:e.original.ignored,onClick:()=>{Wt(e.original)},children:"Ignorieren"})]})}],[Wt,Lt,Rt]);return t.jsxs("div",{className:"v2-page",children:[t.jsxs(Ie,{className:"v2-intro-card",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsx($e,{level:3,children:"Forecast"}),t.jsx(nn,{children:"Versionierte VentoryOne-Imports mit aktiver Baseline, Impact-Analyse und FO-Konflikt-Workflow."})]}),t.jsxs(w,{wrap:!0,children:[t.jsxs(y,{color:"blue",children:["Baseline Forecast: ",un]}),Ut>0?t.jsxs(y,{color:"gold",children:["Forecast-Änderung: ",Ut," FOs prüfen"]}):null]})]}),t.jsxs("div",{className:"v2-toolbar",children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsxs(Y.Group,{value:k,onChange:e=>I(e.target.value),children:[t.jsx(Y.Button,{value:"grid",children:"Forecast Grid"}),t.jsx(Y.Button,{value:"versions",children:"Versionen"}),t.jsx(Y.Button,{value:"impact",children:"Impact & FO-Konflikte"})]}),t.jsx(Ne,{checked:!!((_t=ze.settings)!=null&&_t.useForecast),onChange:e=>{gn(e.target.checked)},children:"`useForecast` aktiv"})]}),k==="grid"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(Je,{value:v,onChange:e=>p(e.target.value),placeholder:"Suche SKU, Alias, Kategorie",style:{width:320,maxWidth:"100%"}}),t.jsx(rr,{value:B,onChange:e=>fe(e),options:rn.map(e=>({value:e.value,label:e.label})),style:{width:140,maxWidth:"100%"}}),t.jsxs(Y.Group,{value:T,onChange:e=>ee(e.target.value),children:[t.jsx(Y.Button,{value:"units",children:"Units"}),t.jsx(Y.Button,{value:"revenue",children:"Umsatz"}),t.jsx(Y.Button,{value:"profit",children:"Gewinn"})]}),t.jsx(Ne,{checked:te,onChange:e=>ne(e.target.checked),children:"Nur aktive Produkte"}),t.jsx(Ne,{checked:re,onChange:e=>Fe(e.target.checked),children:"Nur mit Forecast"})]}),t.jsxs("div",{className:"v2-toolbar-row",children:[t.jsx(F,{type:"primary",onClick:()=>{hn()},disabled:!Se,loading:a,children:"Manuelle Änderungen speichern"}),t.jsx(F,{onClick:()=>{const e=Le.filter(o=>Number(yt.get(o)||0)>0);Ft(e),ft(!0)},children:"Umsatz übertragen"}),Se?t.jsx(y,{color:"orange",children:"Ungespeicherte Änderungen"}):t.jsx(y,{color:"green",children:"Synchron"}),u?t.jsxs(y,{color:"green",children:["Gespeichert: ",new Date(u).toLocaleTimeString("de-DE")]}):null]})]}):null]})]}),l?t.jsx(be,{type:"error",showIcon:!0,message:l}):null,r?t.jsx(be,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,rt.length?t.jsx(be,{type:"warning",showIcon:!0,message:`Brutto-Marge fehlt für ${rt.length} aktive Forecast-Produkt(e). Gewinn-Ansicht ist dadurch unvollständig.`,description:t.jsxs(w,{wrap:!0,children:[t.jsxs(b,{type:"secondary",children:["Beispiele: ",rt.slice(0,5).map(e=>e.sku).join(", "),rt.length>5?" ...":""]}),t.jsx(F,{size:"small",onClick:()=>{window.location.hash="/v2/products?issues=revenue&expand=all"},children:"Produkte öffnen"}),t.jsx(F,{size:"small",onClick:()=>{window.location.hash="/v2/plan-products"},children:"Neue Produkte öffnen"})]})}):null,t.jsxs(Ie,{children:[t.jsx($e,{level:4,children:"VentoryOne CSV Import"}),t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx("input",{type:"file",accept:".csv,text/csv",onChange:e=>{var s;const o=(s=e.target.files)==null?void 0:s[0];o&&pn(o)}}),t.jsxs(w,{wrap:!0,children:[t.jsxs(Y.Group,{value:m,onChange:e=>D(e.target.value),children:[t.jsx(Y.Button,{value:"merge",children:"Merge"}),t.jsx(Y.Button,{value:"overwrite",children:"Overwrite"})]}),t.jsx(Ne,{checked:O,onChange:e=>U(e.target.checked),children:"Nur aktive SKUs importieren"}),G?t.jsx(y,{children:G}):null,L.length?t.jsxs(y,{color:"blue",children:[L.length," Zeilen geladen"]}):null,P?t.jsx(y,{color:"gold",children:"Importkandidat bereit"}):null]}),Ze?t.jsx(be,{type:"error",showIcon:!0,message:Ze}):null,ge.length?t.jsx(be,{type:"warning",showIcon:!0,message:`${ge.length} Warnung(en) beim Import`,description:ge.slice(0,5).join(" | ")}):null,t.jsx(b,{type:"secondary",children:"`Merge` startet aus aktiver Baseline und überlagert importierte Zellen. `Overwrite` erstellt eine Version nur aus den Importdaten."})]})]}),k==="grid"?t.jsxs(Ie,{children:[t.jsxs("div",{className:"v2-category-tools",children:[t.jsxs(b,{type:"secondary",children:[pt.length," Produkte in ",ve.length," Kategorien"]}),t.jsxs("div",{className:"v2-actions-inline",children:[t.jsx(F,{size:"small",onClick:()=>et(ve.map(e=>e.key)),disabled:!ve.length,children:"Alles auf"}),t.jsx(F,{size:"small",onClick:()=>et([]),disabled:!Ye.length,children:"Alles zu"})]})]}),ve.length?t.jsx(Ht,{className:"v2-category-collapse",activeKey:Ye,onChange:e=>et((Array.isArray(e)?e:[e]).map(String)),items:ve.map(e=>({key:e.key,label:t.jsxs(w,{children:[t.jsx(b,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," Produkte"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(jt,{className:"v2-products-grid-wrap",data:e.rows,columns:dn,minTableWidth:Math.max(920,400+Le.length*118),tableLayout:"fixed"})})}))}):t.jsx(b,{type:"secondary",children:"Keine Forecast-Zeilen für den aktuellen Filter."})]}):null,k==="versions"?t.jsxs(Ie,{children:[t.jsx($e,{level:4,children:"Forecast-Versionen"}),st.length?t.jsx(w,{direction:"vertical",style:{width:"100%"},children:st.map(e=>{var s,i,c;const o=e.id===Q;return t.jsx(Ie,{size:"small",children:t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsxs(w,{wrap:!0,children:[t.jsx(b,{strong:!0,children:e.name}),o?t.jsx(y,{color:"blue",children:"Aktive Baseline"}):null,t.jsx(y,{children:new Date(e.createdAt).toLocaleString("de-DE")}),e.sourceLabel?t.jsx(y,{children:e.sourceLabel}):null,e.importMode?t.jsx(y,{children:e.importMode}):null]}),t.jsx("div",{children:t.jsxs(b,{type:"secondary",children:["Rows: ",_(((s=e.stats)==null?void 0:s.rowCount)??0,0)," · SKUs: ",_(((i=e.stats)==null?void 0:i.skuCount)??0,0)," · Monate: ",_(((c=e.stats)==null?void 0:c.monthCount)??0,0)]})}),e.note?t.jsx(nn,{type:"secondary",style:{marginBottom:0},children:e.note}):null]}),t.jsxs(w,{wrap:!0,children:[t.jsx(F,{size:"small",onClick:()=>vn(e),children:"Umbenennen / Notiz"}),t.jsx(F,{size:"small",type:o?"default":"primary",disabled:o,onClick:()=>xn(e),children:"Als Baseline aktiv setzen"}),t.jsx(F,{size:"small",danger:!0,disabled:o,onClick:()=>Sn(e),children:"Löschen"})]})]})},e.id)})}):t.jsx(be,{type:"info",showIcon:!0,message:"Noch keine Forecast-Versionen vorhanden."})]}):null,k==="impact"?t.jsxs(Ie,{children:[t.jsx($e,{level:4,children:"Impact & FO-Konflikte"}),!N||!Oe?t.jsx(be,{type:"info",showIcon:!0,message:"Noch keine Impact-Analyse vorhanden.",description:"Die Analyse wird erzeugt, sobald eine Forecast-Version als Baseline aktiviert wird."}):t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsxs(w,{wrap:!0,children:[t.jsxs(y,{color:"blue",children:["Von: ",N.fromVersionName||"—"]}),t.jsxs(y,{color:"blue",children:["Nach: ",N.toVersionName||"—"]}),t.jsxs(y,{children:["Verglichen: ",new Date(N.comparedAt).toLocaleString("de-DE")]}),t.jsxs(y,{color:N.flaggedSkus>0?"gold":"green",children:["Flagged SKUs: ",N.flaggedSkus]}),t.jsxs(y,{color:N.flaggedAB>0?"gold":"green",children:["Flagged A/B: ",N.flaggedAB]}),t.jsxs(y,{color:We.length>0?"red":"green",children:["FO offen: ",We.length]}),t.jsxs(y,{children:["FO total: ",N.foConflictsTotal]})]}),We.length>0?t.jsx(be,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${We.length} FOs prüfen`}):t.jsx(be,{type:"success",showIcon:!0,message:"Keine offenen FO-Konflikte."}),t.jsxs(Ie,{size:"small",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsx($e,{level:5,style:{marginBottom:0},children:"SKU-Abweichungen"}),t.jsxs(w,{wrap:!0,children:[t.jsx(Ne,{checked:Be,onChange:e=>He(e.target.checked),children:"Nur flagged anzeigen"}),t.jsx(F,{size:"small",onClick:()=>tt(Ae.map(e=>e.key)),disabled:!Ae.length,children:"Alles auf"}),t.jsx(F,{size:"small",onClick:()=>tt([]),disabled:!Vt.length,children:"Alles zu"})]})]}),Ae.length?t.jsx(Ht,{className:"v2-category-collapse",activeKey:Vt,onChange:e=>tt((Array.isArray(e)?e:[e]).map(String)),items:Ae.map(e=>({key:e.key,label:t.jsxs(w,{children:[t.jsx(b,{strong:!0,children:e.label}),t.jsxs("span",{className:"v2-category-count",children:[e.rows.length," SKUs"]})]}),children:t.jsx("div",{className:"v2-products-grid-host",children:t.jsx(jt,{className:"v2-products-grid-wrap",data:e.rows,columns:mn,minTableWidth:1460,tableLayout:"fixed"})})}))}):t.jsx(b,{type:"secondary",children:"Keine SKU-Abweichungen für den aktuellen Filter."})]}),t.jsxs(Ie,{size:"small",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsx($e,{level:5,style:{marginBottom:0},children:"FO-Konflikte"}),t.jsx(Ne,{checked:J,onChange:e=>mt(e.target.checked),children:"Ignorierte anzeigen"})]}),Tt.length?t.jsx(jt,{data:Tt,columns:jn,minTableWidth:1800,tableLayout:"fixed"}):t.jsx(b,{type:"secondary",children:"Keine Konflikte im aktuellen Filter."})]})]})]}):null,t.jsx(Te,{title:"Import erfolgreich",open:P,onCancel:()=>{St()},footer:[t.jsx(F,{onClick:()=>St(),disabled:W,children:"Abbrechen (verwerfen)"},"cancel"),t.jsx(F,{onClick:()=>{Pt("save")},loading:W,disabled:!L.length,children:"Nur speichern"},"save"),t.jsx(F,{type:"primary",onClick:()=>{Pt("activate")},loading:W,disabled:!L.length,children:"Als Baseline aktiv setzen"},"activate")],children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsxs(b,{children:[L.length," Forecast-Zeilen erkannt."]}),t.jsx(Je,{value:oe,onChange:e=>ie(e.target.value),placeholder:"Versionsname"}),t.jsx(Je.TextArea,{value:V,onChange:e=>H(e.target.value),placeholder:"Optionale Notiz",rows:3}),t.jsx(b,{type:"secondary",children:"Abbrechen verwirft den aktuellen Importkandidaten (es wird keine Version gespeichert)."})]})}),t.jsx(Te,{title:"Version bearbeiten",open:ce,onCancel:()=>{K(!1),Ce(null)},onOk:()=>{bn()},okText:"Speichern",children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx(Je,{value:le,onChange:e=>pe(e.target.value),placeholder:"Versionsname"}),t.jsx(Je.TextArea,{value:ue,onChange:e=>ye(e.target.value),rows:3,placeholder:"Optionale Notiz"})]})}),t.jsx(Te,{title:"Umsatz in Eingaben übertragen",open:cn,onCancel:()=>ft(!1),onOk:()=>{yn()},children:t.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[t.jsx(b,{type:"secondary",children:"Monate auswählen, deren Forecast-Umsatz in `incomings` übernommen wird."}),t.jsx(Ne.Group,{value:ht,onChange:e=>Ft(e),style:{width:"100%"},children:t.jsx(w,{direction:"vertical",style:{width:"100%"},children:Re.map(e=>t.jsxs(Ne,{value:e,children:[e," · ",_(yt.get(e)||0,2)," €"]},e))})})]})})]})}export{Zr as default};
