import{ao as Se,a4 as i,t as d,ap as q,aD as I,v as Ne,k as e,S as v,K as j,a5 as K,P as D,J as be,L as P,M as ne,R as S,N as c,O as f}from"./index-CAzQztwo.js";import{D as m}from"./DeNumberInput-S8NAtNBo.js";import{T as se}from"./TanStackGrid-DGGNjv9D.js";import{u as Ce,C as w}from"./workspace-xr5uOuIo.js";import{S as ie}from"./index-C15xyCf_.js";import{C as Me}from"./index-5SR9pC2K.js";import"./index-Dab_0RQN.js";import"./Dropdown-CZlZd-6U.js";import"./useBubbleLock-Cjjrx1CM.js";const{Paragraph:oe,Text:le,Title:k}=be,Ee=["EUR","USD","CNY"],Re=[{value:"START",label:"Start (1. Tag)"},{value:"MID",label:"Mitte (15. Tag)"},{value:"END",label:"Ende (letzter Tag)"}];function h(r,u){const x=Number(r);return Number.isFinite(x)?x:u}function b(r){if(r==null||r==="")return null;const u=Number(r);return Number.isFinite(u)?u:null}function V(r){if(!Number.isFinite(r))return null;const u=Number(r);return u<=0?null:1/u}function de(r){const u=r.transportLeadTimesDays||{},x=r.cny||{},C=b(r.fxRate),T=b(r.eurUsdRate)??V(C);return{air:Math.max(0,h(u.air,10)),rail:Math.max(0,h(u.rail,25)),sea:Math.max(0,h(u.sea,45)),defaultBufferDays:Math.max(0,h(r.defaultBufferDays,0)),defaultCurrency:String(r.defaultCurrency||"EUR"),fxRate:C,eurUsdRate:T,defaultProductionLeadTimeDays:Math.max(0,h(r.defaultProductionLeadTimeDays,45)),dutyRatePct:Math.max(0,h(r.dutyRatePct,0)),eustRatePct:Math.max(0,h(r.eustRatePct,0)),defaultDdp:r.defaultDdp===!0,safetyStockDohDefault:Math.max(0,h(r.safetyStockDohDefault,60)),foCoverageDohDefault:Math.max(0,h(r.foCoverageDohDefault,90)),moqDefaultUnits:Math.max(0,Math.round(h(r.moqDefaultUnits,500))),monthAnchorDay:String(r.monthAnchorDay||"START"),cnyStart:String(x.start||""),cnyEnd:String(x.end||"")}}function N(){return new Date().toISOString()}function Ae(r){return`${r}-${Math.random().toString(36).slice(2,9)}`}function H(r){return JSON.stringify({air:Number(r.air||0),rail:Number(r.rail||0),sea:Number(r.sea||0),defaultBufferDays:Number(r.defaultBufferDays||0),defaultCurrency:String(r.defaultCurrency||""),fxRate:b(r.fxRate),eurUsdRate:b(r.eurUsdRate),defaultProductionLeadTimeDays:Number(r.defaultProductionLeadTimeDays||0),dutyRatePct:Number(r.dutyRatePct||0),eustRatePct:Number(r.eustRatePct||0),defaultDdp:r.defaultDdp===!0,safetyStockDohDefault:Number(r.safetyStockDohDefault||0),foCoverageDohDefault:Number(r.foCoverageDohDefault||0),moqDefaultUnits:Number(r.moqDefaultUnits||0),monthAnchorDay:String(r.monthAnchorDay||""),cnyStart:String(r.cnyStart||""),cnyEnd:String(r.cnyEnd||"")})}function we(r){return r instanceof HTMLElement?!!(r.matches("input:not([type='hidden']), textarea, [contenteditable='true']")||r.closest(".ant-select, .ant-picker, .ant-input-number")):!1}function Le(){const{state:r,loading:u,saving:x,error:C,lastSavedAt:T,saveWith:g}=Ce(),Y=Se(),M=r.settings||{},[p]=i.useForm(),W=i.useWatch("fxRate",p),ce=d.useMemo(()=>V(b(W)),[W]),[ue,me]=d.useState(()=>de(M)),[G,$]=d.useState(""),[U,O]=d.useState(null),[E]=i.useForm(),y=d.useRef(null),F=d.useRef(""),[J,X]=d.useState(""),[R]=i.useForm(),[he,z]=d.useState(null),[_,Q]=d.useState(""),[Z,ee]=d.useState("");d.useEffect(()=>{const t=de(M);me(t),p.setFieldsValue(t),F.current=H(t)},[p,M]),d.useEffect(()=>()=>{y.current!=null&&(window.clearTimeout(y.current),y.current=null)},[]);const xe=d.useMemo(()=>{const t=Array.isArray(r.productCategories)?r.productCategories:[],o=Array.isArray(r.products)?r.products:[],n=new Map;return o.forEach(a=>{const s=String(a.categoryId||"");n.set(s,(n.get(s)||0)+1)}),t.map(a=>{const s=a;return{id:String(s.id||""),name:String(s.name||""),sortOrder:h(s.sortOrder,0),productCount:n.get(String(s.id||""))||0}}).sort((a,s)=>a.sortOrder-s.sortOrder||a.name.localeCompare(s.name))},[r.productCategories,r.products]),fe=d.useMemo(()=>{const t=q(M),o=Object.entries(t).map(([a,s])=>({email:a,displayName:s})),n=I(Y.email);return n&&!o.some(a=>I(a.email)===n)&&o.push({email:n,displayName:""}),o.sort((a,s)=>a.email.localeCompare(s.email))},[M,Y.email]),L=d.useMemo(()=>Ne({settings:r.settings,products:r.products,suppliers:r.suppliers,pos:r.pos,fos:r.fos}).issues||[],[r.settings,r.products,r.suppliers,r.pos,r.fos]),ge=d.useMemo(()=>[{header:"Name",accessorKey:"name"},{header:"Sortierung",accessorKey:"sortOrder"},{header:"Produkte",accessorKey:"productCount"},{header:"Aktionen",cell:({row:t})=>e.jsxs(v,{children:[e.jsx(j,{size:"small",onClick:()=>{O(t.original),E.setFieldsValue({name:t.original.name,sortOrder:t.original.sortOrder})},children:"Bearbeiten"}),e.jsx(j,{size:"small",danger:!0,onClick:()=>{K.confirm({title:"Kategorie loeschen?",content:"Produkte dieser Kategorie werden auf 'ohne Kategorie' gesetzt.",onOk:async()=>{await g(o=>{const n=D(o);return n.productCategories=(Array.isArray(n.productCategories)?n.productCategories:[]).filter(a=>String(a.id||"")!==t.original.id),n.products=(Array.isArray(n.products)?n.products:[]).map(a=>{const s=a;return String(s.categoryId||"")!==t.original.id?s:{...s,categoryId:null}}),n},"v2:settings:category-delete")}})},children:"Loeschen"})]})}],[E,g]);async function ye(t,o="v2:settings:save"){if(t.cnyStart&&!t.cnyEnd||!t.cnyStart&&t.cnyEnd)throw new Error("Bitte CNY Start und Ende gemeinsam setzen.");if(t.cnyStart&&t.cnyEnd&&t.cnyStart>t.cnyEnd)throw new Error("CNY Start darf nicht nach dem Ende liegen.");const n=b(t.fxRate),a=V(n);await g(s=>{const l=D(s),A=l.settings||{};return l.settings={...A,transportLeadTimesDays:{...A.transportLeadTimesDays||{},air:Math.max(0,Math.round(t.air)),rail:Math.max(0,Math.round(t.rail)),sea:Math.max(0,Math.round(t.sea))},defaultBufferDays:Math.max(0,Math.round(t.defaultBufferDays)),defaultCurrency:t.defaultCurrency,fxRate:n,eurUsdRate:a,defaultProductionLeadTimeDays:Math.max(0,Math.round(t.defaultProductionLeadTimeDays)),dutyRatePct:Math.max(0,Number(t.dutyRatePct||0)),eustRatePct:Math.max(0,Number(t.eustRatePct||0)),defaultDdp:t.defaultDdp===!0,safetyStockDohDefault:Math.max(0,Math.round(t.safetyStockDohDefault)),foCoverageDohDefault:Math.max(0,Math.round(t.foCoverageDohDefault)),moqDefaultUnits:Math.max(0,Math.round(t.moqDefaultUnits)),monthAnchorDay:t.monthAnchorDay,cny:{start:t.cnyStart||"",end:t.cnyEnd||""},lastUpdatedAt:N()},l},o),F.current=H(t),X(`Gespeichert: ${new Date().toLocaleTimeString("de-DE")}`)}function B(t=420){y.current!=null&&window.clearTimeout(y.current),y.current=window.setTimeout(()=>{if(y.current=null,x){B();return}const o=p.getFieldsValue(!0);H(o)!==F.current&&p.validateFields().then(a=>ye(a,"v2:settings:auto")).catch(()=>{})},Math.max(80,Number(t)||420))}async function te(t,o){const n=I(t),a=String(o||"").trim();if(!n||!a)throw new Error("Bitte E-Mail und Anzeigenamen setzen.");await g(s=>{const l=D(s),A=l.settings||{},ae=q(A);return ae[n]=a,l.settings={...A,collaborationDisplayNames:ae,lastUpdatedAt:N()},l},"v2:settings:collaboration-name-upsert")}async function re(t){const o=I(t);o&&await g(n=>{const a=D(n),s=a.settings||{},l=q(s);return l[o]&&(delete l[o],a.settings={...s,collaborationDisplayNames:l,lastUpdatedAt:N()}),a},"v2:settings:collaboration-name-remove")}const pe=d.useMemo(()=>[{header:"E-Mail",accessorKey:"email",meta:{width:320}},{header:"Anzeigename",accessorKey:"displayName",meta:{width:210},cell:({row:t})=>t.original.displayName||"—"},{header:"Aktionen",meta:{width:190},cell:({row:t})=>e.jsxs("div",{className:"v2-actions-nowrap",children:[e.jsx(j,{size:"small",onClick:()=>{z(t.original.email),R.setFieldsValue({email:t.original.email,displayName:t.original.displayName})},children:"Bearbeiten"}),e.jsx(j,{size:"small",danger:!0,disabled:!t.original.displayName,onClick:()=>{re(t.original.email)},children:"Loeschen"})]})}],[R,re]);async function je(){const t=G.trim();t&&(await g(o=>{const n=D(o),a=Array.isArray(n.productCategories)?[...n.productCategories]:[];if(a.some(l=>String(l.name||"").trim().toLowerCase()===t.toLowerCase()))throw new Error("Kategorie existiert bereits.");return a.push({id:Ae("cat"),name:t,sortOrder:a.length,createdAt:N(),updatedAt:N()}),n.productCategories=a,n},"v2:settings:category-add"),$(""))}async function De(t){if(!U)return;const o=t.name.trim();o&&(await g(n=>{const a=D(n);return a.productCategories=(Array.isArray(a.productCategories)?a.productCategories:[]).map(s=>{const l=s;return String(l.id||"")!==U.id?l:{...l,name:o,sortOrder:Math.max(0,Math.round(t.sortOrder||0)),updatedAt:N()}}),a},"v2:settings:category-update"),O(null),E.resetFields())}return e.jsxs("div",{className:"v2-page",children:[e.jsxs(w,{className:"v2-intro-card",children:[e.jsx("div",{className:"v2-page-head",children:e.jsxs("div",{children:[e.jsx(k,{level:3,children:"Settings"}),e.jsx(oe,{children:"Lead Times, Defaults, CNY-Fenster und Kategorien für die operative Planung."})]})}),e.jsx("div",{className:"v2-toolbar",children:e.jsxs("div",{className:"v2-toolbar-row",children:[x?e.jsx(P,{color:"processing",children:"Speichern..."}):null,T?e.jsxs(P,{color:"green",children:["Gespeichert: ",new Date(T).toLocaleTimeString("de-DE")]}):null,J?e.jsx(P,{color:"blue",children:J}):null]})})]}),C?e.jsx(ne,{type:"error",showIcon:!0,message:C}):null,u?e.jsx(ne,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,e.jsx(w,{children:e.jsxs(i,{name:"v2-settings-form",form:p,layout:"vertical",initialValues:ue,onValuesChange:()=>{X("Ungespeicherte Aenderungen"),B(360)},onBlurCapture:t=>{we(t.target)&&B(120)},children:[e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Air (Tage)",name:"air",rules:[{required:!0}],children:e.jsx(m,{mode:"int",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Rail (Tage)",name:"rail",rules:[{required:!0}],children:e.jsx(m,{mode:"int",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Sea (Tage)",name:"sea",rules:[{required:!0}],children:e.jsx(m,{mode:"int",min:0})})})]}),e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Buffer Days",name:"defaultBufferDays",rules:[{required:!0}],children:e.jsx(m,{mode:"int",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Default Currency",name:"defaultCurrency",rules:[{required:!0}],children:e.jsx(ie,{options:Ee.map(t=>({value:t,label:t}))})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Monats-Anker",name:"monthAnchorDay",rules:[{required:!0}],children:e.jsx(ie,{options:Re})})})]}),e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"FX Kurs (USD je EUR)",name:"fxRate",children:e.jsx(m,{mode:"fx",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"FX Kurs (EUR je USD)",extra:"Automatisch aus USD je EUR berechnet.",children:e.jsx(m,{mode:"fx",min:0,value:ce??void 0,disabled:!0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"MOQ Default (Units)",name:"moqDefaultUnits",children:e.jsx(m,{mode:"int",min:0})})})]}),e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Safety Stock DOH",name:"safetyStockDohDefault",children:e.jsx(m,{mode:"int",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"FO Coverage DOH",name:"foCoverageDohDefault",children:e.jsx(m,{mode:"int",min:0})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Default Production Lead Time (Tage)",name:"defaultProductionLeadTimeDays",children:e.jsx(m,{mode:"int",min:0})})})]}),e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Default Zollsatz %",name:"dutyRatePct",children:e.jsx(m,{mode:"percent",min:0,max:100})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"Default EUSt %",name:"eustRatePct",children:e.jsx(m,{mode:"percent",min:0,max:100})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{name:"defaultDdp",valuePropName:"checked",style:{marginTop:30},children:e.jsx(Me,{children:"Default DDP aktiv"})})})]}),e.jsxs(S,{gutter:16,children:[e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"CNY Start",name:"cnyStart",children:e.jsx(f,{type:"date"})})}),e.jsx(c,{xs:24,md:8,children:e.jsx(i.Item,{label:"CNY Ende",name:"cnyEnd",children:e.jsx(f,{type:"date"})})})]})]})}),e.jsxs(w,{children:[e.jsx(k,{level:4,children:"Team Anzeige-Namen"}),e.jsx(oe,{children:"Hinterlege optionale Vornamen pro E-Mail. Diese Namen werden in Live-Presence und Modal-Hinweisen angezeigt."}),e.jsxs(v,{style:{marginBottom:12},wrap:!0,children:[e.jsx(f,{value:_,onChange:t=>Q(t.target.value),placeholder:"E-Mail",style:{width:280}}),e.jsx(f,{value:Z,onChange:t=>ee(t.target.value),placeholder:"Anzeigename (z. B. Pierre)",style:{width:220}}),e.jsx(j,{onClick:()=>{te(_,Z).then(()=>{Q(""),ee("")})},children:"Speichern"})]}),e.jsx(se,{data:fe,columns:pe,minTableWidth:880,tableLayout:"auto"})]}),e.jsxs(w,{children:[e.jsx(k,{level:4,children:"Produktkategorien"}),e.jsxs(v,{style:{marginBottom:12},children:[e.jsx(f,{value:G,onChange:t=>$(t.target.value),placeholder:"Neue Kategorie",style:{width:260}}),e.jsx(j,{onClick:()=>{je()},children:"Hinzufuegen"})]}),e.jsx(se,{data:xe,columns:ge})]}),e.jsxs(w,{children:[e.jsx(k,{level:4,children:"Data Health"}),L.length?e.jsxs(v,{direction:"vertical",size:6,children:[e.jsxs(P,{color:"orange",children:[L.length," Issues"]}),L.slice(0,10).map(t=>e.jsx(le,{children:t.message},t.id))]}):e.jsx(le,{type:"secondary",children:"Keine Issues gefunden."})]}),e.jsx(K,{title:"Kategorie bearbeiten",open:!!U,onCancel:()=>O(null),onOk:()=>{E.validateFields().then(t=>De(t)).catch(()=>{})},children:e.jsxs(i,{form:E,layout:"vertical",children:[e.jsx(i.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name ist erforderlich."}],children:e.jsx(f,{})}),e.jsx(i.Item,{name:"sortOrder",label:"Sortierung",rules:[{required:!0}],children:e.jsx(m,{mode:"int",min:0})})]})}),e.jsx(K,{title:"Anzeigename bearbeiten",open:!!he,onCancel:()=>z(null),onOk:()=>{R.validateFields().then(t=>{te(t.email,t.displayName).then(()=>{z(null),R.resetFields()})}).catch(()=>{})},children:e.jsxs(i,{form:R,layout:"vertical",children:[e.jsx(i.Item,{name:"email",label:"E-Mail",rules:[{required:!0,message:"E-Mail fehlt."}],children:e.jsx(f,{disabled:!0})}),e.jsx(i.Item,{name:"displayName",label:"Anzeigename",rules:[{required:!0,message:"Anzeigename fehlt."}],children:e.jsx(f,{placeholder:"z. B. Pierre"})})]})})]})}export{Le as default};
