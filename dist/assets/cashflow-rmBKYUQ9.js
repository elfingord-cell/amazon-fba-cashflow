import{g as Tt}from"./planProducts-CfB8BW_g.js";function Pt(e){return Number.isFinite(e)?e:0}function x(e){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim().replace(/\./g,"").replace(",","."),o=Number(n);return Number.isFinite(o)?o:0}function _(e){if(e===""||e===null||e===void 0)return 0;const n=Number(String(e).replace(",","."));return Number.isFinite(n)?n:0}function zt(e){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:2}).format(Pt(Number(e)))}function Ft(e,n){const[o,d]=e.split("-").map(Number),u=new Date(o,d-1+n,1);return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}`}function Dt(e,n){const o=[];for(let d=0;d<n;d++)o.push(Ft(e,d));return o}function J(e){const n=new Date(e);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function Y(e,n){const o=new Date(e.getTime());return o.setDate(o.getDate()+(n||0)),o}function Q(e){return!(e instanceof Date)||Number.isNaN(e.getTime())?null:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function nt(e){if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n}function pt(e){const[n,o]=e.split("-").map(Number);return new Date(n,o,0)}function $t(e,n){var b;const o=e==null?void 0:e.cny;if(o!=null&&o.start&&(o!=null&&o.end)){const h=nt(o.start),r=nt(o.end);if(h&&r&&r>=h)return{start:h,end:r}}const d=(b=e==null?void 0:e.cnyBlackoutByYear)==null?void 0:b[String(n)];if(!d)return null;const u=nt(d.start),f=nt(d.end);return!u||!f||f<u?null:{start:u,end:f}}function Rt(e,n,o){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return{prodDone:e,adjustmentDays:0};const d=Math.max(0,Number(n||0)),u=Y(e,d);if(!o||d===0)return{prodDone:u,adjustmentDays:0};let f=0;const b=e.getUTCFullYear(),h=u.getUTCFullYear();for(let m=b;m<=h;m+=1){const l=$t(o,m);if(!l)continue;const D=l.start>e?l.start:e,T=l.end<u?l.end:u;if(T<D)continue;const $=Math.round((T.getTime()-D.getTime())/(24*60*60*1e3))+1;f+=Math.max(0,$)}return{prodDone:f?Y(u,f):u,adjustmentDays:f}}function bt(e,n){const o=nt(e.orderDate)||new Date,d=Number(e.productionLeadTimeDays??e.prodDays??0),u=Number(e.logisticsLeadTimeDays??e.transitDays??0),b=Rt(o,d,n).prodDone??Y(o,d),h=b,r=Y(h,u),m=nt(e.etdManual),l=nt(e.etaManual);return{ORDER_DATE:o,PROD_DONE:b,PRODUCTION_END:b,ETD:m||h,ETA:l||r}}function vt(e,n){const o=new Date(e.getTime());return o.setMonth(o.getMonth()+n),o}function Ot(e){return new Date(e.getFullYear(),e.getMonth()+1,0)}function et(e){if(!/^\d{4}-\d{2}$/.test(e||""))return null;const[n,o]=e.split("-").map(Number);return n*12+(o-1)}function It(e,n){const o=Array.isArray(e==null?void 0:e.items)?e.items:[];let d=0,u=0;if(o.length)o.forEach(m=>{const l=x((m==null?void 0:m.units)??0),D=x((m==null?void 0:m.unitCostUsd)??0),T=x((m==null?void 0:m.unitExtraUsd)??0),$=x((m==null?void 0:m.extraFlatUsd)??0),L=(D+T)*l+$,E=Math.max(0,Math.round(L*100)/100);Number.isFinite(E)&&(d+=E),Number.isFinite(l)&&(u+=l)});else{const m=x((e==null?void 0:e.units)??0),l=x((e==null?void 0:e.unitCostUsd)??0),D=x((e==null?void 0:e.unitExtraUsd)??0),T=x((e==null?void 0:e.extraFlatUsd)??0),$=(l+D)*m+T;d=Math.max(0,Math.round($*100)/100),Number.isFinite(m)&&(u=m)}const f=x((e==null?void 0:e.fxOverride)??0),b=Number.isFinite(f)&&f>0?f:x((n==null?void 0:n.fxRate)??0)||0,h=b>0?Math.round(d/b*100)/100:0,r=x((e==null?void 0:e.goodsEur)??0);return{usd:d,eur:h>0?h:r,units:u}}function gt(e,n){if(((e==null?void 0:e.freightMode)==="per_unit"?"per_unit":"total")==="per_unit"){const d=x((e==null?void 0:e.freightPerUnitEur)??0),u=Number((n==null?void 0:n.units)??0)||0,f=d*u;return Math.round(f*100)/100}return x((e==null?void 0:e.freightEur)??0)}function kt(e,n,o){const d=new Date(e,n+1,0).getDate(),u=Math.min(Math.max(1,o),d);return new Date(e,n,u)}function Et(e,n){const o=et(e);if(o==null)return null;const d=Math.floor(o/12),u=o%12;if(!n||n==="LAST"||n==="Letzter Tag"||n==="EOM")return new Date(d,u+1,0);const f=Number(n);return Number.isFinite(f)?kt(d,u,f):new Date(d,u+1,0)}function St(e){const n=String(e||"").trim().toUpperCase();return n?n==="PLANNED"?"ACTIVE":n==="CANCELLED"?"ARCHIVED":n:"DRAFT"}function Ct(e){const n=St(e);return n==="DRAFT"||n==="ACTIVE"}function Ut(e,n,o,d){if(!n||!n.proration||n.proration.enabled!==!0)return{amount:e,applied:!1};if(n.proration.method!=="daily")return{amount:e,applied:!1};const u=et(o);if(u==null)return{amount:e,applied:!1};const f=Math.floor(u/12),b=u%12,h=new Date(f,b+1,0).getDate(),r=d instanceof Date&&!Number.isNaN(d.getTime())?d:Et(o,n.anchor),m=r instanceof Date?r.getDate():h;let l=1;n.startMonth&&n.startMonth===o&&(l*=Math.max(0,h-m+1)/h),n.endMonth&&n.endMonth===o&&(l*=Math.max(0,m)/h);const D=Math.round(e*l*100)/100;return!Number.isFinite(D)||D===e?{amount:e,applied:!1}:{amount:D,applied:!0}}function Nt({statusRecord:e,autoEligible:n,autoManualCheck:o,entryTime:d,todayTime:u,defaultPaid:f}){const b=typeof(e==null?void 0:e.manual)=="boolean"?e.manual:void 0;let h=!1,r=!1;typeof b=="boolean"?h=b:n&&!o&&d!=null&&d<=u?(h=!0,r=!0):h=!!f;const m=n&&o&&!r;let l=null;return n&&(r?l="Automatisch bezahlt am Fälligkeitstag":o?l="Automatische Zahlung – manuelle Prüfung aktiv":l="Automatische Zahlung"),{paid:h,autoApplied:r,manualOverride:typeof b=="boolean",autoSuppressed:m,autoTooltip:l}}function _t(e,n={}){const o=e||{},d=n.startMonth||o.settings&&o.settings.startMonth||"2025-01",u=Number(n.horizon||o.settings&&o.settings.horizonMonths||12),f=Array.isArray(n.months)&&n.months.length?n.months:Dt(d,u),b=Array.isArray(o.fixcosts)?o.fixcosts:[],h=o.fixcostOverrides&&typeof o.fixcostOverrides=="object"?o.fixcostOverrides:{},r=n.status&&typeof n.status=="object"?n.status:o.status||{},m=n.statusEvents&&typeof n.statusEvents=="object"?n.statusEvents:r.events||{},l=n.autoManualCheck!=null?n.autoManualCheck===!0:r.autoManualCheck===!0,D=n.today?new Date(n.today):new Date;D.setHours(0,0,0,0);const T=D.getTime(),$=[],L=new Set(f);return b.forEach((E,k)=>{if(!E)return;const S=E.id||`fix-${k}`,W=E.startMonth||d,H=et(W);if(H==null)return;const Z=E.endMonth||null,q=Z?et(Z):null,c=(E.frequency||"monthly").toLowerCase();let g=1;c==="quarterly"?g=3:c==="semiannual"||c==="halbjährlich"?g=6:c==="annual"||c==="jährlich"||c==="yearly"?g=12:(c==="custom"||c==="benutzerdefiniert")&&(g=Number(E.intervalMonths||E.everyMonths||1)||1),g<1&&(g=1);const F=E.anchor,N=!F||F==="Letzter Tag"?"LAST":String(F),A=h[S]&&typeof h[S]=="object"?h[S]:{},P=E.name||"Fixkosten",R=E.category||"Sonstiges",v=Math.abs(x(E.amount)),B=E.notes||"",V=E.autoPaid===!0;f.forEach(z=>{if(!L.has(z))return;const K=et(z);if(K==null||K<H||q!=null&&K>q||(K-H)%g!==0)return;const j=Et(z,N),I=A[z]&&typeof A[z]=="object"?A[z]:{};let C=j;if(I.dueDate&&/^\d{4}-\d{2}-\d{2}$/.test(I.dueDate)){const M=new Date(I.dueDate);Number.isNaN(M.getTime())||(C=M)}let ut=v,at=!1;I.amount!=null&&String(I.amount).trim()!==""&&(ut=Math.abs(x(I.amount)),at=!0);let ot=!1;if(!at){const M=Ut(v,E,z,C);ut=M.amount,ot=M.applied}const st=`fix-${S}-${z}`,ct=C instanceof Date&&!Number.isNaN(C.getTime())?C.getTime():null,rt=m[st],t=Nt({statusRecord:rt,autoEligible:V,autoManualCheck:l,entryTime:ct,todayTime:T,defaultPaid:!1}),a=C instanceof Date&&!Number.isNaN(C.getTime())?Q(C):null,s=I.note||"",i=[P];at&&i.push("Override aktiv"),ot&&i.push("Proratiert");const y=i.length>1?i.join(" · "):null;$.push({id:st,month:z,amount:ut,baseAmount:v,label:P,category:R,dueDate:C,dueDateIso:a,fixedCostId:S,autoPaid:V,notes:B,override:{amount:I.amount||"",dueDate:I.dueDate||"",note:s},overrideActive:at||!!I.dueDate||!!s,prorationApplied:ot,paid:t.paid,autoApplied:t.autoApplied,manualOverride:t.manualOverride,autoTooltip:t.autoTooltip,autoSuppressed:t.autoSuppressed,anchor:N,frequency:c,tooltip:y})})}),$.sort((E,k)=>{if(E.month===k.month){const S=E.dueDate instanceof Date?E.dueDate.getTime():0,W=k.dueDate instanceof Date?k.dueDate.getTime():0;return S-W}return et(E.month)-et(k.month)}),$}function jt(e){const n=e||{};return{dutyRatePct:_(n.dutyRatePct??0),dutyIncludeFreight:n.dutyIncludeFreight!==!1,eustRatePct:_(n.eustRatePct??0),vatRefundLagMonths:Number(n.vatRefundLagMonths??0)||0,vatRefundEnabled:n.vatRefundEnabled!==!1,freightLagDays:Number(n.freightLagDays??0)||0,fxFeePct:_(n.fxFeePct??0)}}function Lt(e,n,o){const d=["freight","duty","eust","vat_refund","fx_fee"],u=Array.isArray(e.autoEvents)?e.autoEvents.filter(Boolean).map(r=>({...r})):[],f=new Map;for(const r of u)!r||!r.type||(r.id||(r.id=`auto-${r.type}`),f.set(r.type,r));const b=(o||[])[0]||null;function h(r,m){if(!f.has(r)){const D={id:`auto-${r}`,type:r,...m};return u.push(D),f.set(r,D),D}const l=f.get(r);l.id||(l.id=`auto-${r}`);for(const[D,T]of Object.entries(m))l[D]===void 0&&(l[D]=T);return l}if(h("freight",{label:"Fracht",anchor:"ETA",lagDays:n.freightLagDays,enabled:!0}),h("duty",{label:"Zoll",percent:n.dutyRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("eust",{label:"EUSt",percent:n.eustRatePct,anchor:"ETA",lagDays:n.freightLagDays}),h("vat_refund",{label:"EUSt-Erstattung",percent:100,anchor:"ETA",lagMonths:n.vatRefundLagMonths,enabled:n.vatRefundEnabled}),h("fx_fee",{label:"FX-Gebühr",percent:n.fxFeePct,anchor:b&&b.anchor||"ORDER_DATE",lagDays:b&&Number(b.lagDays||0)||0}),u.sort((r,m)=>d.indexOf(r.type)-d.indexOf(m.type)),e.ddp)for(const r of u)(r.type==="freight"||r.type==="duty"||r.type==="eust"||r.type==="vat_refund")&&(r.enabled=!1);return u}function yt(e,n,o,d){var q;if(!e)return[];const u=o||"PO",f=e[d],b=f?`${u} ${f}`:u;if(Array.isArray(e.payments)&&e.payments.length){const c=bt(e,n);return e.payments.filter(Boolean).map((g,F)=>{const N=g.triggerEvent||"ORDER_DATE",A=N==="PROD_DONE"?"PROD_DONE":N,P=c[A]||c.ORDER_DATE,R=g.dueDate?new Date(g.dueDate):Y(P,Number(g.offsetDays||0)),v=Number(g.amount||0),B=v>=0?"out":"in",V=Math.abs(v);return{label:`${b}${g.label?` – ${g.label}`:""}`,amount:V,due:R,month:J(R),direction:B,type:"manual",anchor:A,lagDays:Number(g.offsetDays||0)||0,percent:Number(g.percent||0),sourceType:u,sourceNumber:f,sourceId:e.id,id:g.id||`${e.id||u}-pay-${F}`,tooltip:`Fälligkeit: ${A} + ${Number(g.offsetDays||0)} Tage`}})}const h=It(e,n),r=h.eur,m=gt(e,h),l=bt(e,n),D=Array.isArray(e.milestones)?e.milestones:[],T=Lt(e,n,D),$=[];for(const[c,g]of D.entries()){const F=_(g.percent),N=l[g.anchor||"ORDER_DATE"]||l.ORDER_DATE,A=Y(N,Number(g.lagDays||0)),P=g.id||`${e.id||u}-${c}-${g.id||"manual"}`;$.push({label:`${b}${g.label?` – ${g.label}`:""}`,amount:r*(F/100),due:A,month:J(A),direction:"out",type:"manual",anchor:g.anchor||"ORDER_DATE",lagDays:Number(g.lagDays||0)||0,percent:F,sourceType:u,sourceNumber:f,sourceId:e.id,id:P,tooltip:`Fälligkeit: ${g.anchor||"ORDER_DATE"} + ${Number(g.lagDays||0)} Tage`})}const L=e.dutyIncludeFreight!==!1,E=_(e.dutyRatePct??n.dutyRatePct??0),k=_(e.eustRatePct??n.eustRatePct??0),S=_(e.fxFeePct??n.fxFeePct??0),W=Number(e.vatRefundLagMonths??n.vatRefundLagMonths??0),H=e.vatRefundEnabled!==!1,Z={};for(const c of T){if(!c||c.enabled===!1)continue;const g=c.anchor||"ETA",F=l[g]||l.ETA;if(!(!(F instanceof Date)||Number.isNaN(F.getTime()))){if(c.type==="freight"){const N=gt(e,h);if(!N)continue;const A=c.id||`${e.id||u}-auto-freight`,P=Y(F,Number(c.lagDays||0));$.push({label:`${b} – ${c.label||"Fracht"}`,amount:N,due:P,month:J(P),direction:"out",type:"freight",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,sourceType:u,sourceNumber:f,sourceId:e.id,id:A,tooltip:"Frachtkosten laut Eingabe"});continue}if(c.type==="duty"){const N=_(c.percent??E),A=Y(F,Number(c.lagDays||0)),R=(r+(L?m:0))*(N/100),v=c.id||`${e.id||u}-auto-duty`;Z.duty={amount:R,due:A},$.push({label:`${b} – ${c.label||"Zoll"}`,amount:R,due:A,month:J(A),direction:"out",type:"duty",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:f,sourceId:e.id,id:v,tooltip:`Zoll = ${N}% × (Warenwert${L?" + Fracht":""})`});continue}if(c.type==="eust"){const N=_(c.percent??k),A=Math.abs(((q=Z.duty)==null?void 0:q.amount)||0),P=r+m+A,R=Y(F,Number(c.lagDays||0)),v=P*(N/100),B=c.id||`${e.id||u}-auto-eust`;Z.eust={amount:v,due:R},$.push({label:`${b} – ${c.label||"EUSt"}`,amount:v,due:R,month:J(R),direction:"out",type:"eust",anchor:c.anchor||"ETA",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:f,sourceId:e.id,id:B,tooltip:`EUSt = ${N}% × (Warenwert + Fracht + Zoll)`});continue}if(c.type==="vat_refund"){const N=Z.eust;if(!H||!N||N.amount===0)continue;const A=_(c.percent??100),P=Number((c.lagMonths??W)||0),R=Y(N.due||F,Number(c.lagDays||0)),v=Ot(vt(R,P)),B=Math.abs(N.amount)*(A/100),V=c.id||`${e.id||u}-auto-vat`;$.push({label:`${b} – ${c.label||"EUSt-Erstattung"}`,amount:B,due:v,month:J(v),direction:"in",type:"vat_refund",anchor:c.anchor||"ETA",lagMonths:P,percent:A,sourceType:u,sourceNumber:f,sourceId:e.id,id:V,tooltip:`Erstattung am Monatsende nach ${P} Monaten`});continue}if(c.type==="fx_fee"){const N=_(c.percent??S);if(!N)continue;const A=Y(F,Number(c.lagDays||0)),P=r*(N/100),R=c.id||`${e.id||u}-auto-fx`;$.push({label:`${b} – ${c.label||"FX-Gebühr"}`,amount:P,due:A,month:J(A),direction:"out",type:"fx_fee",anchor:c.anchor||"ORDER_DATE",lagDays:Number(c.lagDays||0)||0,percent:N,sourceType:u,sourceNumber:f,sourceId:e.id,id:R,tooltip:`FX-Gebühr = ${N}% × Warenwert`})}}}return $}function Yt(e){var ot,st,ct,rt;const n=e||{},o=n.settings&&n.settings.startMonth||"2025-01",d=Number(n.settings&&n.settings.horizonMonths||12),u=Dt(o,d),f=n.status&&typeof n.status=="object"?n.status:{},b=f.events&&typeof f.events=="object"?f.events:{},h=f.autoManualCheck===!0,r=new Date;r.setHours(0,0,0,0);const m=r.getTime(),l={};u.forEach(t=>{l[t]={entries:[]}});function D(t,a){l[t]&&l[t].entries.push(a)}function T(t,a={}){const s=t.id||`${t.month||""}-${t.label||""}-${t.date||""}`,i=b[s],y=t.date?new Date(t.date):null,M=y&&Number.isFinite(y.getTime())?new Date(y.getFullYear(),y.getMonth(),y.getDate()).getTime():null,O=a.auto===!0,G=O&&a.autoEligible!==!1,w=typeof t.paid=="boolean"?t.paid:!!a.defaultPaid,tt=Nt({statusRecord:i,autoEligible:G,autoManualCheck:h,entryTime:M,todayTime:m,defaultPaid:w});return{id:s,direction:t.direction||"in",amount:Math.abs(t.amount||0),label:t.label||"",month:t.month,date:t.date,kind:t.kind,group:t.group,paid:tt.paid,source:t.source||null,anchor:t.anchor,lagDays:t.lagDays,lagMonths:t.lagMonths,percent:t.percent,scenarioDelta:t.scenarioDelta||0,scenarioAmount:t.scenarioAmount||t.amount||0,meta:t.meta||{},tooltip:t.tooltip,sourceTab:t.sourceTab,sourceNumber:t.sourceNumber,statusId:s,auto:O,autoEligible:G,autoApplied:tt.autoApplied,autoManualCheck:h,manualOverride:tt.manualOverride,autoSuppressed:tt.autoSuppressed,autoTooltip:tt.autoTooltip}}_t(n,{months:u,statusEvents:b,autoManualCheck:h,today:r}).map(t=>({id:t.id,direction:"out",amount:t.amount,label:t.label,month:t.month,date:t.dueDateIso,kind:"fixcost",group:"Fixkosten",source:"fixcosts",sourceTab:"#fixkosten",meta:{fixedCostId:t.fixedCostId,category:t.category,override:t.overrideActive,overrideAmount:t.override.amount,overrideDueDate:t.override.dueDate,overrideNote:t.override.note,notes:t.notes,baseAmount:t.baseAmount,prorationApplied:t.prorationApplied},tooltip:t.tooltip,auto:t.autoPaid,autoEligible:t.autoPaid})).forEach(t=>{D(t.month,T(t,{auto:t.auto,autoEligible:t.autoEligible}))});const L=!!((st=(ot=n==null?void 0:n.forecast)==null?void 0:ot.settings)!=null&&st.useForecast),E={},k={},S={};if(L){(ct=n==null?void 0:n.forecast)!=null&&ct.forecastImport&&typeof n.forecast.forecastImport=="object"?Object.values(n.forecast.forecastImport).forEach(a=>{Object.entries(a||{}).forEach(([s,i])=>{if(!s||!l[s])return;const y=x((i==null?void 0:i.revenueEur)??(i==null?void 0:i.revenue)??null);Number.isFinite(y)&&(E[s]=(E[s]||0)+y)})}):Array.isArray((rt=n==null?void 0:n.forecast)==null?void 0:rt.items)&&n.forecast.items.forEach(a=>{if(!a||!a.month||!a.sku)return;const s=a.month;if(!l[s])return;const i=Number(a.qty??a.quantity??0)||0,y=x(a.priceEur??a.price??0),M=i*y;E[s]=(E[s]||0)+M});const t=Tt({state:n,months:u});Object.entries(t||{}).forEach(([a,s])=>{if(!l[a])return;const i=x(s);Number.isFinite(i)&&(k[a]=(k[a]||0)+i)}),Object.keys(l).forEach(a=>{S[a]=(E[a]||0)+(k[a]||0)})}const W={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(W[t.month]=t.payoutPct)});const H={};(Array.isArray(n.incomings)?n.incomings:[]).forEach(t=>{!t||!t.month||(H[t.month]=x(t.revenueEur))}),Object.keys(l).forEach(t=>{const a=L?S[t]||0:H[t];if(typeof a>"u")return;const s=_(W[t]||0),i=pt(t);if(!L){const w=a*(s/100);D(t,T({id:`sales-${t}`,direction:w>=0?"in":"out",amount:Math.abs(w),label:"Amazon Payout",month:t,date:Q(i),kind:"sales-payout",group:w>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#eingaben"},{auto:!1}));return}const y=E[t]||0,M=k[t]||0,O=y*(s/100),G=M*(s/100);Math.abs(O)>1e-6&&D(t,T({id:`sales-live-${t}`,direction:O>=0?"in":"out",amount:Math.abs(O),label:"Amazon Payout (Prognose - Live/CSV)",month:t,date:Q(i),kind:"sales-payout",group:O>=0?"Sales × Payout":"Extras (Out)",source:"sales",sourceTab:"#forecast"},{auto:!1})),Math.abs(G)>1e-6&&D(t,T({id:`sales-plan-${t}`,direction:G>=0?"in":"out",amount:Math.abs(G),label:"Amazon Payout (Prognose - Plan)",month:t,date:Q(i),kind:"sales-payout",group:G>=0?"Sales × Payout":"Extras (Out)",source:"sales-plan",sourceTab:"#forecast"},{auto:!1}))}),(Array.isArray(n.extras)?n.extras:[]).forEach(t=>{const a=t.month||(t.date?J(t.date):null);if(!a||!l[a])return;const s=x(t.amountEur),i=s>=0?"in":"out",y=a,M=t.date?new Date(t.date):pt(y);D(y,T({id:`extra-${t.id||t.label||y}-${t.date||""}`,direction:i,amount:Math.abs(s),label:t.label||"Extra",month:y,date:Q(M),kind:"extra",group:i==="in"?"Extras (In)":"Extras (Out)",source:"extras",sourceTab:"#eingaben"},{auto:t.autoPaid===!0,autoEligible:t.autoPaid===!0}))}),(Array.isArray(n.dividends)?n.dividends:[]).forEach(t=>{const a=t.month||(t.date?J(t.date):null);if(!a||!l[a])return;const s=x(t.amountEur),i=t.date?new Date(t.date):pt(a);D(a,T({id:`div-${t.id||t.label||a}`,direction:s>=0?"out":"in",amount:Math.abs(s),label:t.label||"Dividende",month:a,date:Q(i),kind:"dividend",group:"Dividende & KapESt",source:"dividends",sourceTab:"#eingaben"},{auto:!1}))});const Z=jt(n.settings);(Array.isArray(n.pos)?n.pos:[]).forEach(t=>{yt(t,Z,"PO","poNo").forEach(a=>{const s=a.month;if(!l[s])return;const i=a.type==="manual"?"po":a.type==="vat_refund"?"po-refund":"po-import",y=i==="po"?"PO/FO-Zahlungen":"Importkosten";D(s,T({id:a.id||`po-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:s,date:Q(a.due),kind:i,group:y,source:"po",sourceTab:"#po",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.poNo,tooltip:a.tooltip},{auto:a.type!=="manual",autoEligible:a.type!=="manual"}))})}),(Array.isArray(n.fos)?n.fos:[]).forEach(t=>{Ct(t==null?void 0:t.status)&&yt(t,Z,"FO","foNo").forEach(a=>{const s=a.month;if(!l[s])return;const i=a.type==="manual"?"fo":a.type==="vat_refund"?"fo-refund":"fo-import",y=i==="fo"?"PO/FO-Zahlungen":"Importkosten";D(s,T({id:a.id||`fo-${t.id||""}-${a.type}-${a.month}`,direction:a.direction==="in"?"in":"out",amount:Math.abs(a.amount||0),label:a.label,month:s,date:Q(a.due),kind:i,group:y,source:"fo",sourceTab:"#fo",anchor:a.anchor,lagDays:a.lagDays,lagMonths:a.lagMonths,percent:a.percent,sourceNumber:a.sourceNumber||t.foNo,tooltip:a.tooltip},{auto:!1,autoEligible:!1,defaultPaid:!1}))})});const q=u.map(t=>{const s=l[t].entries||[],i=s.filter(p=>p.direction==="in"),y=s.filter(p=>p.direction==="out"),M=y.filter(p=>p.group==="Fixkosten"),O=M.reduce((p,U)=>p+(U.amount||0),0),G=M.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),w=Math.max(0,O-G),tt=M.slice().sort((p,U)=>(U.amount||0)-(p.amount||0)).slice(0,3).map(p=>({label:p.label,amount:p.amount,paid:p.paid,category:p.meta&&p.meta.category?p.meta.category:null})),it=i.reduce((p,U)=>p+(U.amount||0),0),lt=y.reduce((p,U)=>p+(U.amount||0),0),dt=i.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),ft=y.filter(p=>p.paid).reduce((p,U)=>p+(U.amount||0),0),Mt=Math.max(0,it-dt),At=Math.max(0,lt-ft),ht=it-lt,mt=dt-ft,xt=ht-mt;return{month:t,inflow:{total:it,paid:dt,open:Mt},outflow:{total:lt,paid:ft,open:At},net:{total:ht,paid:mt,open:xt},fixcost:{total:O,paid:G,open:w,top:tt},itemsIn:i.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),itemsOut:y.map(p=>({kind:p.kind,label:p.label,amount:p.amount})),entries:s}}),c=x(n.settings&&n.settings.openingBalance),g=u.find(t=>{const a=u.indexOf(t);let s=c;for(let i=0;i<=a;i++)s+=q[i].net.total;return s<0})||null,F=q.map(t=>t.itemsIn.filter(a=>a.kind==="sales-payout").reduce((a,s)=>a+s.amount,0)),N=F.length?F.reduce((t,a)=>t+a,0)/(F.filter(t=>t>0).length||1):0,A={},P={};Object.keys(l).forEach(t=>{const a=L?S[t]||0:H[t],s=_(W[t]||0);A[t]=a,P[t]=a*(s/100)});const R={opening:c,openingToday:c,salesPayoutAvg:N,avgSalesPayout:N,firstNegativeMonth:g,actuals:{}};let v=c;const B=u.map((t,a)=>{const s=q[a],i=v;return v+=s.net.total,{month:t,opening:i,closing:v,inflow:s.inflow.total,outflow:s.outflow.total,net:s.net.total,entries:s.entries}}),V=new Map,z=n!=null&&n.monthlyActuals&&typeof n.monthlyActuals=="object"?n.monthlyActuals:{},K=Object.entries(z);K.length?K.forEach(([t,a])=>{if(!t)return;const s=Number(a==null?void 0:a.realRevenueEUR),i=Number(a==null?void 0:a.realPayoutRatePct),y=Number(a==null?void 0:a.realClosingBalanceEUR),M={};Number.isFinite(s)&&(M.revenue=s),Number.isFinite(s)&&Number.isFinite(i)&&(M.payout=s*(i/100)),Number.isFinite(y)&&(M.closing=y),Object.keys(M).length&&V.set(t,M)}):(Array.isArray(n.actuals)?n.actuals:[]).forEach(a=>{if(!a||!a.month)return;const s=a.month;V.set(s,{revenue:x(a.revenueEur),payout:x(a.payoutEur),closing:x(a.closingBalanceEur)})});const X=[];V.forEach((t,a)=>{const s=u.indexOf(a);if(s===-1)return;const i=s>=0&&s<B.length?B[s]:null,y=i?i.closing:null,M=A[a]??null,O=P[a]??null;X.push({month:a,plannedRevenue:M,actualRevenue:t.revenue,revenueDelta:(t.revenue??0)-(M??0),revenueDeltaPct:M?((t.revenue??0)-M)/M*100:null,plannedPayout:O,actualPayout:t.payout,payoutDelta:(t.payout??0)-(O??0),payoutDeltaPct:O?((t.payout??0)-O)/O*100:null,plannedClosing:y,actualClosing:t.closing,closingDelta:(t.closing??0)-(y??0)})}),X.sort((t,a)=>(t.month||"").localeCompare(a.month||""));const j=X[X.length-1]||null,I=X.map(t=>t.revenueDeltaPct).filter(t=>Number.isFinite(t)),C=X.map(t=>t.payoutDeltaPct).filter(t=>Number.isFinite(t)),ut=I.length?I.reduce((t,a)=>t+a,0)/I.length:null,at=C.length?C.reduce((t,a)=>t+a,0)/C.length:null;return R.actuals={count:X.length,lastMonth:j?j.month:null,lastClosing:j?j.actualClosing:null,closingDelta:j?j.closingDelta:null,revenueDeltaPct:j?j.revenueDeltaPct:null,payoutDeltaPct:j?j.payoutDeltaPct:null,avgRevenueDeltaPct:ut,avgPayoutDeltaPct:at},{startMonth:o,horizon:d,months:u,series:q,kpis:R,breakdown:B,actualComparisons:X}}export{Yt as c,_t as e,zt as f,x as p};
