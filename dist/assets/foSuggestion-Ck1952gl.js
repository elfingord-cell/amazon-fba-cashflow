function w(t){if(t instanceof Date)return new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()));if(typeof t!="string")throw new Error(`Invalid date: ${t}`);const[e,n,s]=t.split("-").map(Number);if(!e||!n||!s)throw new Error(`Invalid ISO date: ${t}`);return new Date(Date.UTC(e,n-1,s))}function N(t){const e=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0"),s=String(t.getUTCDate()).padStart(2,"0");return`${e}-${n}-${s}`}function v(t){const e=t.getUTCFullYear(),n=String(t.getUTCMonth()+1).padStart(2,"0");return`${e}-${n}`}function F(t){const[e,n]=t.split("-").map(Number);if(!e||!n)throw new Error(`Invalid month: ${t}`);return{year:e,month:n-1}}function k(t,e){const n=F(t),s=F(e),a=n.year*12+n.month,o=s.year*12+s.month;return a-o}function x(t,e){const{year:n,month:s}=F(t),a=new Date(Date.UTC(n,s,1));return a.setUTCMonth(a.getUTCMonth()+e),v(a)}function $(t){const{year:e,month:n}=F(t);return new Date(Date.UTC(e,n,1))}function M(t,e){return new Date(Date.UTC(t,e+1,0)).getUTCDate()}function p(t,e){return new Date(t.getTime()+e*864e5)}function z(t,e={},n={}){const s=(e==null?void 0:e[t])??{};return{safetyStockDaysTotalDe:s.safetyStockDaysTotalDe??n.safetyStockDaysTotalDe??60,minimumStockDaysTotalDe:s.minimumStockDaysTotalDe??n.minimumStockDaysTotalDe??null,leadTimeDaysTotal:s.leadTimeDaysTotal??n.leadTimeDaysTotal??0,moqUnits:s.moqUnits??n.moqUnits??0,operationalCoverageDaysDefault:s.operationalCoverageDaysOverride??n.operationalCoverageDaysDefault??120}}function L(t,e,n){var s;return((s=t==null?void 0:t[e])==null?void 0:s[n])??null}function G(t,e,n){var s;return((s=t==null?void 0:t[e])==null?void 0:s[n])??null}function O({plansBySku:t,sku:e,month:n,fallbackDailyRate:s,warnings:a}){const o=L(t,e,n),{year:i,month:r}=F(n),c=M(i,r);return o==null?s!=null?(a.push(`Forecast missing for ${n}; using last available daily rate.`),{dailyRate:s,days:c,missingForecast:!0,usedFallback:!0,forecastMonthUnits:null}):(a.push(`Forecast missing for ${n}; daily rate assumed 0.`),{dailyRate:0,days:c,missingForecast:!0,usedFallback:!1,forecastMonthUnits:null}):(o===0&&a.push(`Forecast for ${n} is zero; demand treated as 0.`),{dailyRate:o/c,days:c,missingForecast:!1,usedFallback:!1,forecastMonthUnits:o})}function H({plansBySku:t,sku:e,date:n,fallbackDailyRate:s,warnings:a}){const o=v(n);return O({plansBySku:t,sku:e,month:o,fallbackDailyRate:s,warnings:a}).dailyRate}function V({snapshotsBySku:t,plansBySku:e,sku:n,date:s,fallbackDailyRate:a,warnings:o}){const i=v(s),r=G(t,n,i);if(r==null)return o.push("Latest closing stock snapshot missing."),{inventoryUnits:null,missingSnapshot:!0,missingForecast:!1};const c=L(e,n,i),{year:u,month:m}=F(i),l=M(u,m);let d=c,y=!1;d==null&&(y=!0,a!=null?(d=a*l,o.push(`Forecast missing for ${i}; inventory estimated using fallback rate.`)):(d=0,o.push(`Forecast missing for ${i}; inventory estimated without sales drawdown.`)));const D=d/l,g=r+d,h=s.getUTCDate()-1;return{inventoryUnits:g-h*D,missingSnapshot:!1,missingForecast:y}}function Y({plansBySku:t,sku:e,startDate:n,endDate:s,warnings:a}){let o=new Date(n.getTime()),i=0,r=null,c=!1;const u=[];for(;o<s;){const m=v(o),{year:l,month:d}=F(m),y=M(l,d),D=new Date(Date.UTC(l,d+1,1)),g=D<s?D:s,h=Math.ceil((g.getTime()-o.getTime())/864e5),f=O({plansBySku:t,sku:e,month:m,fallbackDailyRate:r,warnings:a}),T=f.dailyRate*h;i+=T,u.push({month:m,daysCovered:h,forecastMonthUnits:f.forecastMonthUnits,demandUnitsInWindow:T,usedFallback:f.usedFallback}),f.missingForecast?c=!0:r=f.dailyRate,o=g,h>=y&&f.dailyRate!=null&&(r=f.dailyRate)}return{demandUnits:i,missingForecast:c,fallbackDailyRate:r,coverageDemandBreakdown:u}}function J(t,e,n,s){if(!t||!e||!n||!s)return 0;const a=w(t),o=w(e),i=w(n),r=w(s);if(!a||!o||!i||!r)return 0;const c=a>i?a:i,u=p(r,1),l=(o<u?o:u).getTime()-c.getTime();return l<=0?0:Math.ceil(l/864e5)}function Q(t=[]){let e=null;return t.forEach(n=>{const s=n==null?void 0:n.month;s&&(!e||k(s,e)>0)&&(e=s)}),e}function W({sku:t,baselineMonth:e,stock0:n=0,forecastByMonth:s={},inboundByMonth:a={},horizonMonths:o=12}){const i=[],r=[];let c=Number(n||0);for(let u=1;u<=o;u+=1){const m=x(e,u),l=s==null?void 0:s[m],d=Number.isFinite(Number(l))?Number(l):0;l==null&&r.push(m);const y=Number((a==null?void 0:a[m])||0),{year:D,month:g}=F(m),h=M(D,g),f=d===0?0:d/h,T=c+y-d,I=f===0?Number.POSITIVE_INFINITY:Math.max(0,T/f);i.push({month:m,startStock:c,inbound:y,demand:d,endStock:T,avgDailyDemand:f,doh:I}),c=T}return{sku:t,baselineMonth:e,months:i,missingForecastMonths:r}}function X({sku:t,baselineMonth:e,projection:n,plannedSalesBySku:s={},safetyStockDays:a=60,coverageDays:o=90,leadTimeDays:i=0,cnyPeriod:r,inboundWithoutEtaCount:c=0,moqUnits:u=0,requiredArrivalMonth:m=null}){var _;if(!e)return{sku:t,status:"no_snapshot",issues:[]};const l=(_=n==null?void 0:n.months)==null?void 0:_.find(C=>Number.isFinite(C.doh)&&C.doh<a);if(!l)return{sku:t,status:"no_fo_needed",baselineMonth:e,issues:E(n,c)};const d=new Map(((n==null?void 0:n.months)||[]).map(C=>[C.month,C])),y=m&&d.has(m)&&k(m,e)>0?m:l.month,D=d.get(y)||l,g=$(y),h=p(g,-Number(i||0)),f=J(h,g,r==null?void 0:r.start,r==null?void 0:r.end),T=f>0?p(h,-f):h,I=Math.max(1,Number(o||0)),U=Y({plansBySku:s,sku:t,startDate:g,endDate:p(g,I),warnings:[]}),A=Number.isFinite(U==null?void 0:U.demandUnits)?Number(U.demandUnits):Number((D==null?void 0:D.avgDailyDemand)||0)*I,K=Array.isArray(U==null?void 0:U.coverageDemandBreakdown)?U.coverageDemandBreakdown:[],q=Number((D==null?void 0:D.startStock)||0),R=Math.max(0,Math.ceil(A));let S=R,b=!1;return S>0&&u>0&&S<u&&(S=u,b=!0),{sku:t,status:"ok",baselineMonth:e,criticalMonth:l.month,selectedArrivalMonth:y,requiredArrivalDate:N(g),orderDate:N(h),orderDateAdjusted:N(T),overlapDays:f,coverageDaysForOrder:I,coverageDemandUnits:A,coverageDemandBreakdown:K,recommendedUnitsRaw:R,recommendedUnits:S,safetyStockDays:a,coverageDays:o,moqUnits:u,moqApplied:b,moqLiftUnits:b?Math.max(0,S-R):0,stockAtArrival:q,avgDailyDemand:(D==null?void 0:D.avgDailyDemand)??l.avgDailyDemand,issues:E(n,c)}}function E(t,e){var a;const n=[],s=((a=t==null?void 0:t.missingForecastMonths)==null?void 0:a.length)||0;return s>0&&n.push({code:"MISSING_FORECAST",count:s}),e>0&&n.push({code:"INBOUND_WITHOUT_ETA",count:e}),n}const Z={parseIsoDate:w,formatIsoDate:N,monthKey:v,addMonthsToKey:x,monthKeyToDate:$,compareMonthKeys:k,daysInMonth:M,addDays:p,getDailyRateForDate:H,estimateInventoryOnDate:V,integrateDemand:Y,resolveSkuPolicy:z};export{W as b,X as c,Z as f,Q as g};
