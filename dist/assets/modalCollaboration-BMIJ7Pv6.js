import{t as n,bp as $,bq as q,am as K}from"./index-CLY33OwN.js";function A(){return new Date().toISOString()}function B(e){return!e||typeof e!="object"||Array.isArray(e)?{}:e}function z(e,o){const c=B(e.payload);return String(c.modalScope||"")===String(o||"")}function P(e,o){return e?K({userId:e.userId,userEmail:e.userEmail,userDisplayName:e.userDisplayName},o):null}function G(e){const o=String(e.workspaceId||"").trim(),c=String(e.modalScope||"").trim(),r=String(e.userId||"").trim(),S=e.userEmail||null,w=e.userDisplayName||null,[m,O]=n.useState({}),[l,b]=n.useState(null),[M,v]=n.useState(null),[R,h]=n.useState(0),g=n.useRef(null),f=n.useRef(null),p=n.useRef({});n.useEffect(()=>{g.current=l},[l]);const C=n.useMemo(()=>Object.values(m).sort((a,t)=>String(a.joinedAt||"").localeCompare(String(t.joinedAt||""))),[m]),_=n.useMemo(()=>C.filter(a=>a.userId&&a.userId!==r),[C,r]),D=_.length>0,L=!!(l&&l!==r),I=!!(e.isOpen&&r&&l&&l!==r),k=I?"viewer":"editor",u=n.useCallback(async(a,t)=>!o||!c||!r?!1:$({workspaceId:o,event:a,payload:{modalScope:c,userId:r,userEmail:S,userDisplayName:w,sentAt:A(),...t}}),[c,w,S,r,o]),E=n.useMemo(()=>l&&m[l]||null,[l,m]),j=n.useMemo(()=>P(l&&l!==r?E:_[0],e.displayNames),[E,l,e.displayNames,_,r]);n.useEffect(()=>{if(!e.isOpen||!o||!c||!r||l)return;const t=Object.values(m).filter(i=>!!i.userId).sort((i,d)=>{const s=String(i.joinedAt||"").localeCompare(String(d.joinedAt||""));return s!==0?s:String(i.userId||"").localeCompare(String(d.userId||""))})[0];t!=null&&t.userId&&(b(t.userId),t.userId===r&&u("modal_lock",{ownerUserId:r}))},[l,c,e.isOpen,m,u,r,o]);const T=n.useMemo(()=>{if(!e.isOpen||!r)return null;const a=j||"Kollege";return I?{tone:"warning",text:`${a} bearbeitet gerade. Du bist im Lesemodus und kannst Bearbeitung Ã¼bernehmen.`}:D?{tone:"info",text:`Du bearbeitest. ${a} ist ebenfalls im Modal (Lesemodus).`}:null},[e.isOpen,I,D,j,r]),U=n.useCallback(()=>{if(!e.isOpen||I||!Object.keys(p.current).length)return;const a=p.current;p.current={},u("modal_draft_patch",{patch:a})},[e.isOpen,I,u]),x=n.useCallback(a=>{!a||typeof a!="object"||Array.isArray(a)||(p.current={...p.current,...a},f.current!=null&&window.clearTimeout(f.current),f.current=window.setTimeout(()=>{f.current=null,U()},180))},[U]),V=n.useCallback(()=>{p.current={},f.current!=null&&(window.clearTimeout(f.current),f.current=null),e.isOpen&&u("modal_draft_clear",{})},[e.isOpen,u]),W=n.useCallback(()=>{!e.isOpen||!o||!c||!r||(b(r),u("modal_takeover",{ownerUserId:r}),u("modal_lock",{ownerUserId:r}))},[c,e.isOpen,u,r,o]);return n.useEffect(()=>{if(!e.isOpen||!o||!c||!r)return O({}),b(null),v(null),()=>{};O(t=>({...t,[r]:{userId:r,userEmail:S,userDisplayName:w,joinedAt:A()}})),u("modal_presence",{action:"join",role:k});const a=q({workspaceId:o,onBroadcast:t=>{if(!z(t,c))return;const i=B(t.payload),d=String(i.userId||"").trim();if(d){if(t.event==="modal_presence"){const s=i.action==="leave"?"leave":"join";O(y=>{if(s==="leave"){if(!y[d])return y;const N={...y};return delete N[d],d===g.current&&b(null),N}return{...y,[d]:{userId:d,userEmail:i.userEmail?String(i.userEmail):null,userDisplayName:i.userDisplayName?String(i.userDisplayName):null,joinedAt:String(i.sentAt||A())}}}),s==="join"&&d!==r&&g.current===r&&u("modal_lock",{ownerUserId:r});return}if(t.event==="modal_lock"||t.event==="modal_takeover"){const s=String(i.ownerUserId||"").trim();if(!s)return;b(s);return}if(t.event==="modal_unlock"){const s=String(i.ownerUserId||"").trim();(!s||s===l)&&b(null);return}if(t.event==="modal_draft_patch"&&d!==r){const s=i.patch;if(!s||typeof s!="object"||Array.isArray(s))return;v(s),h(y=>y+1);return}t.event==="modal_draft_clear"&&d!==r&&(v(null),h(s=>s+1))}}});return()=>{a(),f.current!=null&&(window.clearTimeout(f.current),f.current=null),o&&c&&r&&(u("modal_draft_clear",{}),g.current===r&&u("modal_unlock",{ownerUserId:r}),u("modal_presence",{action:"leave",role:k}))}},[c,e.isOpen,k,u,w,S,r,o]),{readOnly:I,role:k,lockOwnerUserId:l,remoteUserLabel:j,remoteInModal:D,remoteEditing:L,banner:T,remoteDraftPatch:M,remoteDraftVersion:R,takeOver:W,publishDraftPatch:x,clearDraft:V}}export{G as u};
