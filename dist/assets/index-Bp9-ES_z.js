import{I as Ut,t as i,P as re,J as Re,k as t,S as j,K as Rt,L as z,M as ue,N as Q,O as Vt,T as se,Q as Wt}from"./index-BD5jv3Ko.js";import{E as qt}from"./index-GD18CfbJ.js";import{c as Qt}from"./cashflow-DNlcojUA.js";import{r as Zt,b as Gt,a as Ht,c as Jt}from"./phantomFo-BA2QvLjy.js";import{e as Xt}from"./forecastVersioning-uC4U_OMY.js";import{m as ft,c as Yt,f as oe}from"./months-BTPgK-LH.js";import{u as en,C as Z}from"./workspace-CfM_ALgX.js";import{S as pt}from"./index-D7J6QrOA.js";import{R as ae}from"./InfoCircleOutlined-B35AQKM_.js";import{S as Le}from"./index-CZ-_0UdS.js";import{C as tn}from"./index-klWLJge3.js";import{F as nn}from"./Table-CouXAjFU.js";import"./planProducts-B4oq-gYc.js";import"./cashInRules-r9rlv23d.js";import"./productCompletenessV2-Dt8c4qxB.js";import"./orderUtils-BzDe88pp.js";import"./foSuggestion-Ck1952gl.js";import"./abcClassification-DJqr3kGN.js";import"./inventoryProjection-DKiDOLCQ.js";import"./Dropdown-Cmz6A_Zx.js";import"./DownOutlined-Ulm6ZLmS.js";import"./useBubbleLock-BiNS1nPg.js";import"./index-DBBOINmL.js";import"./Pagination-DKE3OUyX.js";const{Paragraph:gt,Text:y,Title:$e}=Rt,_e=[{value:"next6",label:"Nächste 6 Monate",count:6},{value:"next12",label:"Nächste 12 Monate",count:12},{value:"next18",label:"Nächste 18 Monate",count:18},{value:"all",label:"Alle Monate",count:null}],sn=[{value:re.CORE,label:"Kernportfolio"},{value:re.PLAN,label:"Planprodukte"},{value:re.IDEAS,label:"Ideenprodukte"}],yt=[re.CORE,re.PLAN],bt={full:{label:"Vollständig",color:"green",className:"is-full"},wide:{label:"Weitgehend",color:"lime",className:"is-wide"},partial:{label:"Teilweise",color:"orange",className:"is-partial"},insufficient:{label:"Unzureichend",color:"red",className:"is-insufficient"}};function F(n){const r=Number(n);return Number.isFinite(r)?r.toLocaleString("de-DE",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}):"-"}function xt(n){return Number.isFinite(n)?n<0?`−${F(Math.abs(n))}`:F(n):"-"}function on(n,r=0){const l=Number(n);return Number.isFinite(l)?l.toLocaleString("de-DE",{minimumFractionDigits:r,maximumFractionDigits:r}):"-"}function vt(n){const r=Number(n);return Number.isFinite(r)?`${r.toLocaleString("de-DE",{minimumFractionDigits:0,maximumFractionDigits:0})} %`:"-"}function an(n){if(!n)return"-";const r=new Date(n);return Number.isNaN(r.getTime())?n:r.toLocaleDateString("de-DE")}function rn(n){return bt[n]||bt.insufficient}function ln(n){return n==="ok"?"✅":n==="warn"?"⚠️":"❌"}function cn(n,r){const l=structuredClone(n||{});(!l.settings||typeof l.settings!="object")&&(l.settings={});const c=l.settings;return c.cashInMode=r.safetyMode==="basis"?"basis":"conservative",c.cashInCalibrationEnabled=r.revenueBasisMode==="calibrated",c.cashInRecommendationIgnoreQ4=!r.q4SeasonalityEnabled,r.quoteMode==="recommendation"&&Array.isArray(l.incomings)&&(l.incomings=l.incomings.map(d=>!d||typeof d!="object"?d:{...d,payoutPct:null})),l}function G(n,r){const[l,c=""]=String(n||"").split("?"),d=new URLSearchParams(c);Object.entries(r).forEach(([f,v])=>{if(v==null||v===""){d.delete(f);return}d.set(f,v)});const m=d.toString();return m?`${l}?${m}`:l}function Ve(n){return G("/v2/inventory/projektion",{source:"dashboard",risk:n.risk||"under_safety",abc:n.abc||"ab",month:n.month||null,sku:n.sku||null,mode:n.mode||null,expand:"all"})}function un(n){return G("/v2/products",{source:"dashboard",issues:n.issues,sku:n.sku||null,expand:"all"})}function St(n){return G("/v2/forecast",{source:"dashboard",sku:n.sku||null,month:n.month||null})}function dn(n){return G("/v2/orders/fo",{source:n.source,sku:n.sku||null,month:n.month||null,suggestedUnits:Number.isFinite(Number(n.suggestedUnits))?String(Math.max(0,Math.round(Number(n.suggestedUnits)))):"0",requiredArrivalDate:n.requiredArrivalDate||null,recommendedOrderDate:n.recommendedOrderDate||null,phantomId:null,firstRiskMonth:n.firstRiskMonth||null,orderMonth:n.orderMonth||null,leadTimeDays:Number.isFinite(Number(n.leadTimeDays))?String(Math.max(0,Math.round(Number(n.leadTimeDays)))):null,returnTo:n.returnTo})}function kt(n){const r=String(n.route||"");if(r.startsWith("/v2/forecast"))return St({sku:n.sku||null,month:n.month||null});if(r.startsWith("/v2/inventory/projektion")){const l=n.actionId==="inventory_safety"||n.checkKey==="sku_coverage"?"under_safety":"all",c=n.sku?"all":n.actionId==="inventory_safety"||n.checkKey==="sku_coverage"?"ab":"all";return Ve({risk:l,abc:c,month:n.month||null,sku:n.sku||null,mode:n.mode||null})}if(r.startsWith("/v2/products")){const l=n.actionId==="revenue_inputs"||n.checkKey==="revenue_inputs"?"revenue":"needs_fix";return un({issues:l,sku:n.sku||null})}return r}function mn(n){const r=typeof n.portfolioBucket=="string"?n.portfolioBucket:null;if(r)return r;const l=n.meta&&typeof n.meta=="object"?n.meta:{};return typeof l.portfolioBucket=="string"?String(l.portfolioBucket):null}function ke(n,r){const l=mn(n);return!l||!Re.includes(l)?!0:r.has(l)}function hn(n,r){var d;if(!n.length)return[];const l=Number(((d=n[0])==null?void 0:d.opening)||0);let c=l;return n.map((m,f)=>{const v=f===0?l:c,D=(Array.isArray(m.entries)?m.entries:[]).filter(M=>ke(M,r)),w=D.filter(M=>String(M.direction||"").toLowerCase()==="in").reduce((M,B)=>M+Math.abs(Number(B.amount||0)),0),A=D.filter(M=>String(M.direction||"").toLowerCase()==="out").reduce((M,B)=>M+Math.abs(Number(B.amount||0)),0),O=w-A,N=v+O;return c=N,{...m,opening:v,inflow:w,outflow:A,net:O,closing:N,entries:D}})}function fn(n,r,l){const c={fixcost:0,po:0,fo:0,phantomFo:0,other:0,total:0};return n.forEach(d=>{if(!d||typeof d!="object")return;const m=d;if(l&&!ke(m,l)||String(m.direction||"").toLowerCase()!=="out")return;const f=Math.abs(Number(m.amount||0));if(!Number.isFinite(f)||f<=0)return;c.total+=f;const v=String(m.source||"").toLowerCase();if(v==="po"){c.po+=f;return}if(v==="fo"){const w=String(m.sourceId||"").trim(),A=m.meta&&typeof m.meta=="object"?m.meta:{};m.provisional===!0||A.phantom===!0||(w?(r==null?void 0:r.has(w))===!0:!1)?c.phantomFo+=f:c.fo+=f;return}const D=String(m.group||"").toLowerCase();if(v==="fixcosts"||D==="fixkosten"){c.fixcost+=f;return}c.other+=f}),c}function pn(n,r){const l={amazon:0,amazonCore:0,amazonPlanned:0,amazonNew:0,other:0,total:0};return n.forEach(c=>{if(!c||typeof c!="object")return;const d=c;if(r&&!ke(d,r)||String(d.direction||"").toLowerCase()!=="in")return;const m=Math.abs(Number(d.amount||0));if(!Number.isFinite(m)||m<=0)return;const f=String(d.source||"").toLowerCase(),v=String(d.kind||"").toLowerCase();if(f==="sales"||f==="sales-plan"||v==="sales-payout"){l.amazon+=m;const w=d.meta&&typeof d.meta=="object"?d.meta:{},A=w.cashIn&&typeof w.cashIn=="object"?w.cashIn:{},O=String(A.component||"").trim().toLowerCase(),N=String(d.portfolioBucket||w.portfolioBucket||"").trim(),M=Wt(N,re.CORE);f==="sales-plan"||O==="plan"?l.amazonNew+=m:M===re.CORE?l.amazonCore+=m:l.amazonPlanned+=m}else l.other+=m;l.total+=m}),l}function Ue(n){const r={};return n.forEach(l=>{r[l]=0}),r}function ve(n){return Object.values(n).reduce((r,l)=>r+Math.abs(Number(l||0)),0)}function gn(n){const r=Number(n.paid||0),l=Number(n.open||0),c=Number(n.unknown||0);return r>0&&l<=0&&c<=0?"paid":l>0&&r<=0&&c<=0?"open":c>0&&r<=0&&l<=0?"unknown":"mixed"}function yn(n){const r=[],l=c=>{c.forEach(d=>{!Array.isArray(d.children)||d.children.length===0||(r.push(d.key),l(d.children))})};return l(n),r}function bn(n){const r=new Map;(Array.isArray(n.products)?n.products:[]).forEach(m=>{const f=String(m.sku||"").trim();if(!f)return;const v=String(m.alias||"").trim()||f;r.set(f,v)});const c=new Map,d=(m,f)=>{const v=(m==="po"?[f.poNo,f.id]:[f.foNo,f.foNumber,f.id]).map(N=>String(N||"").trim()).filter(Boolean);if(!v.length)return;const D=Array.isArray(f.items)&&f.items.length?f.items:[{sku:f.sku,units:f.units}],w=new Set;let A=0;D.forEach(N=>{const M=String(N.sku||"").trim();if(!M)return;w.add(r.get(M)||M);const B=Number(N.units??N.qty??N.quantity??0);Number.isFinite(B)&&(A+=B)});const O={aliases:Array.from(w),units:Number.isFinite(A)?A:null};Array.from(new Set(v)).forEach(N=>{c.set(`${m}:${N}`,O)})};return(Array.isArray(n.pos)?n.pos:[]).forEach(m=>d("po",m)),(Array.isArray(n.fos)?n.fos:[]).forEach(m=>d("fo",m)),c}function xn(n){if(!n||typeof n!="object")return{toVersionId:null,foConflictsOpen:0};const r=n;return{toVersionId:r.toVersionId==null?null:String(r.toVersionId||"").trim()||null,foConflictsOpen:Math.max(0,Math.round(Number(r.foConflictsOpen||0)))}}function qn(){var ut,dt,mt,ht;const{state:n,loading:r,error:l}=en(),c=Ut(),[d,m]=i.useState("next6"),[f,v]=i.useState(()=>yt.slice()),[D,w]=i.useState("forecast"),[A,O]=i.useState("manual"),[N,M]=i.useState("basis"),[B,Se]=i.useState(!0),[We,jt]=i.useState(!1),[pe,je]=i.useState(""),[de,Me]=i.useState(""),[Mt,qe]=i.useState(!1),[we,Ne]=i.useState(["inflows","outflows"]),L=n,Ce=n.settings&&typeof n.settings=="object"?n.settings:{},Qe=n.forecast&&typeof n.forecast=="object"?n.forecast:{},ze=Ce.cashInCalibrationEnabled!==!1,wt=Math.max(1,Math.round(Number(Ce.cashInCalibrationHorizonMonths||6))),Ze=Ce.cashInRecommendationIgnoreQ4===!0;i.useEffect(()=>{We||(w(ze?"calibrated":"forecast"),Se(!Ze),jt(!0))},[We,ze,Ze]);const K=i.useMemo(()=>Zt(L,18),[n.settings]),H=i.useMemo(()=>pe&&K.includes(pe)?pe:K[K.length-1]||"",[pe,K]),ie=i.useMemo(()=>Gt({state:L,months:K,targetMonth:H||null}),[K,H,L]),ge=i.useMemo(()=>new Set(ie.map(e=>e.id)),[ie]),Ge=i.useMemo(()=>Ht({state:L,suggestions:ie}),[ie,L]),He=i.useMemo(()=>cn(Ge,{quoteMode:A,safetyMode:N,revenueBasisMode:D,q4SeasonalityEnabled:B}),[Ge,B,A,D,N]),Ae=i.useMemo(()=>Qt(He),[He]),Ee=Ae.months||[],Je=Ae.breakdown||[],k=i.useMemo(()=>{const e=_e.find(s=>s.value===d);return!e||e.count==null?Ee:Ee.slice(0,e.count)},[Ee,d]),Nt=i.useMemo(()=>{const e=_e.find(s=>s.value===d);return(e==null?void 0:e.label)||"Alle Monate"},[d]),Xe=i.useMemo(()=>new Set(k),[k]),V=i.useMemo(()=>new Set(f),[f]),me=i.useMemo(()=>{const e=Je.filter(s=>Xe.has(s.month));return hn(e,V)},[Je,V,Xe]),W=i.useMemo(()=>Jt({state:L,months:k}),[L,k]);i.useEffect(()=>{if(!K.length){je("");return}je(e=>e&&K.includes(e)?e:K[K.length-1])},[K]),i.useEffect(()=>{var e;if(!W.months.length){Me("");return}if(!de||!W.monthMap.has(de)){const s=((e=W.months.find(a=>!a.robust))==null?void 0:e.month)||W.months[0].month;Me(s)}},[W,de]);const Ct=i.useCallback(e=>{Re.includes(e)&&v(s=>{const a=Array.from(new Set((s||[]).filter(p=>Re.includes(p))));if(!a.includes(e))return[...a,e];const b=a.filter(p=>p!==e);return b.length?b:a})},[]),Ye=i.useCallback(e=>{e&&(Me(e),qe(!0))},[]),S=i.useMemo(()=>me.map(e=>({...e})),[me]),q=i.useMemo(()=>{const e=new Map;return S.forEach(s=>{e.set(s.month,pn(Array.isArray(s.entries)?s.entries:[],V))}),e},[V,S]),P=i.useMemo(()=>S.map(e=>q.get(e.month)||{amazon:0,amazonCore:0,amazonPlanned:0,amazonNew:0,other:0,total:0}),[q,S]),$=i.useMemo(()=>{const e=new Map;return S.forEach(s=>{e.set(s.month,fn(Array.isArray(s.entries)?s.entries:[],ge,V))}),e},[V,ge,S]),he=i.useMemo(()=>S.map(e=>$.get(e.month)||{fixcost:0,po:0,fo:0,phantomFo:0,other:0,total:0}),[$,S]),et=i.useMemo(()=>P.map(e=>e.amazonCore),[P]),tt=i.useMemo(()=>P.map(e=>e.amazonPlanned),[P]),nt=i.useMemo(()=>P.map(e=>e.amazonNew),[P]),zt=i.useMemo(()=>P.map(e=>e.amazon),[P]),Ie=i.useMemo(()=>P.map(e=>e.other),[P]),At=zt.reduce((e,s)=>e+Number(s||0),0)+Ie.reduce((e,s)=>e+Number(s||0),0),Et=S.reduce((e,s)=>e+Number(s.outflow||0),0),De=S.reduce((e,s)=>e+Number(s.net||0),0),It=i.useMemo(()=>S.length?Math.min(...S.map(e=>Number(e.closing||0))):null,[S]),Dt=A==="recommendation",Tt=((dt=(ut=Ae.kpis)==null?void 0:ut.cashIn)==null?void 0:dt.calibrationApplied)===!0,st=i.useMemo(()=>{const e=structuredClone(Qe||{});return Xt(e),e},[Qe]),Te=xn(st.lastImpactSummary),ot=String(st.activeVersionId||"").trim()||null,at=Te.toVersionId&&ot&&Te.toVersionId===ot?Te.foConflictsOpen:0,u=de&&W.monthMap.get(de)||null,Fe=u?rn(u.coverage.statusKey):null,ye=i.useMemo(()=>{if(!u)return!1;const e=ft(Yt()),s=ft(u.month);return s==null||e==null?!1:s<e},[u]),rt=u?u.checks.filter(e=>e.key!=="sku_coverage"):[],it=i.useMemo(()=>{if(!u||u.coverage.statusKey==="full")return[];const e=u.month;return[{id:`coverage-warning:${e}`,message:`Coverage ist ${u.coverage.statusLabel}: ${vt(u.coverage.ratio*100)} (${u.coverage.coveredSkus}/${u.coverage.activeSkus}).`,route:Ve({risk:"under_safety",abc:"ab",month:e,mode:u.coverage.projectionMode})}]},[u]),Ft=i.useMemo(()=>{if(!u)return[];const e=[],s=u.coverage.stockIssueCount,a=u.coverage.orderDutyIssueCount;return e.push({key:"stock_lookahead",label:"Bestand robust (mit Lookahead)",state:s===0?"ok":"fail",description:s===0?"Alle aktiven SKUs bleiben im Lookahead-Fenster über Safety.":`${s} aktive SKU(s) unterschreiten Safety im Lookahead-Fenster.`,route:"/v2/inventory/projektion"}),e.push({key:"order_duty",label:"Bestellpflicht rechtzeitig",state:a===0?"ok":u.coverage.overdueOrderDutySkuCount>0?"fail":"warn",description:a===0?"Keine fällige Bestellpflicht für PO/FO im Monat.":`${a} SKU(s) mit fälliger Bestellpflicht.`,route:"/v2/orders/fo"}),rt.forEach(o=>{e.push({key:o.key,label:o.label,state:o.passed?"ok":"fail",description:o.detail,route:o.route||null})}),ye&&e.push({key:"past-info",label:"Vergangen (Info)",state:"warn",description:"Vergangener Monat: Status dient zur Einordnung, nicht als offene To-Do-Pflicht.",route:null}),e},[u,ye,rt]),lt=i.useMemo(()=>{const e=new Map;return k.forEach(s=>{e.set(oe(s),s)}),e},[k]),ct=i.useCallback(e=>{if(!e||typeof e!="object")return;const s=e;let a=null;const o=Number(s.dataIndex);if(Number.isInteger(o)&&o>=0&&o<k.length&&(a=k[o]),!a){const b=[s.name,s.axisValue,s.value].map(p=>typeof p=="string"?p.trim():"").filter(Boolean);for(let p=0;p<b.length;p+=1){const g=lt.get(b[p]);if(g){a=g;break}}}a&&Ye(a)},[lt,Ye,k]),Kt=i.useMemo(()=>({click:ct}),[ct]),Ot=i.useMemo(()=>{const e="Amazon Kern",s="Amazon Plan",a="Amazon Neu",o=new Set([e,s,a]),b=k.map(h=>oe(h)),p=me.map(h=>Number(h.closing||0)),g=me.map(h=>{var I;return!!((I=W.monthMap.get(h.month))!=null&&I.robust)}),x=p.map((h,I)=>g[I]&&h>=0?h:null),E=p.map((h,I)=>g[I]&&h<0?h:null),X=p.map((h,I)=>!g[I]&&h>=0?h:null),U=p.map((h,I)=>!g[I]&&h<0?h:null),Oe=he.map(h=>-h.fixcost),le=he.map(h=>-h.po),Y=he.map(h=>-h.fo),Be=he.map(h=>-h.phantomFo);return{tooltip:{trigger:"axis",formatter:h=>{const I=Array.isArray(h)?h:[h],C=I[0],ce=[`<div><strong>${(C==null?void 0:C.axisValueLabel)||""}</strong></div>`];let ee=0,fe=!1;return I.forEach(xe=>{const T=xe,te=Number(T==null?void 0:T.value);Number.isFinite(te)&&(o.has(String((T==null?void 0:T.seriesName)||""))&&(ee+=te,fe=!0),ce.push(`<div>${(T==null?void 0:T.marker)||""}${(T==null?void 0:T.seriesName)||""}: ${F(te)}</div>`))}),fe&&ce.push(`<div><strong>Amazon gesamt: ${F(ee)}</strong></div>`),ce.join("")}},legend:{type:"scroll",top:0,left:0,right:0,itemGap:10,itemWidth:14,itemHeight:8,textStyle:{fontSize:12,color:"#334155"},pageTextStyle:{fontSize:11,color:"#64748b"},data:[e,s,a,"Sonstige In","Fixkosten","PO","FO","Phantom FO","Netto","Kontostand belastbar","Kontostand belastbar (<0)","Kontostand orientierend","Kontostand orientierend (<0)"]},grid:{left:54,right:68,top:54,bottom:42},xAxis:{type:"category",data:b,triggerEvent:!0,axisLabel:{hideOverlap:!0,fontSize:12,color:"#475569",margin:12},axisLine:{lineStyle:{color:"rgba(15,27,45,0.24)"}}},yAxis:[{type:"value",name:"Cashflow",nameTextStyle:{fontSize:12,color:"#475569"},axisLabel:{formatter:h=>xt(h),fontSize:12,color:"#475569"},splitLine:{lineStyle:{color:"rgba(15,27,45,0.10)"}}},{type:"value",name:"Kontostand",position:"right",nameTextStyle:{fontSize:12,color:"#475569"},axisLabel:{formatter:h=>F(h),fontSize:12,color:"#475569"},splitLine:{show:!1}}],series:[{name:e,type:"bar",stack:"cash",data:et,itemStyle:{color:"#166534"}},{name:s,type:"bar",stack:"cash",data:tt,itemStyle:{color:"#22c55e"}},{name:a,type:"bar",stack:"cash",data:nt,itemStyle:{color:"#86efac"}},{name:"Sonstige In",type:"bar",stack:"cash",data:Ie,itemStyle:{color:"#6ee7b7"}},{name:"Fixkosten",type:"bar",stack:"cash",data:Oe,itemStyle:{color:"#7f1d1d"}},{name:"PO",type:"bar",stack:"cash",data:le,itemStyle:{color:"#e74c3c"}},{name:"FO",type:"bar",stack:"cash",data:Y,itemStyle:{color:"#f97316"}},{name:"Phantom FO",type:"bar",stack:"cash",data:Be,itemStyle:{color:"#fbbf24"}},{name:"Netto",type:"line",smooth:!0,showSymbol:!1,data:S.map(h=>Number(h.net||0)),itemStyle:{color:"#0f1b2d"},lineStyle:{width:2}},{name:"Kontostand belastbar",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,showSymbol:!1,data:x,lineStyle:{width:2,color:"#3bc2a7"},itemStyle:{color:"#3bc2a7"}},{name:"Kontostand belastbar (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,showSymbol:!1,data:E,lineStyle:{width:2,color:"#b42318"},itemStyle:{color:"#b42318"}},{name:"Kontostand orientierend",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,showSymbol:!1,data:X,lineStyle:{width:2,type:"dashed",color:"#94a3b8"},itemStyle:{color:"#94a3b8"}},{name:"Kontostand orientierend (<0)",type:"line",smooth:!0,yAxisIndex:1,connectNulls:!1,showSymbol:!1,data:U,lineStyle:{width:2,type:"dashed",color:"#c2410c"},itemStyle:{color:"#c2410c"}}]}},[et,nt,tt,Ie,he,W.monthMap,S,me,k]),be=i.useMemo(()=>bn(L),[n.fos,n.pos,n.products,L]),J=i.useMemo(()=>{const e={"outflows-po":new Map,"outflows-fo":new Map,"outflows-phantom-fo":new Map};S.forEach(a=>{const o=a.month;(Array.isArray(a.entries)?a.entries:[]).forEach(p=>{if(!p||typeof p!="object")return;const g=p;if(!ke(g,V)||String(g.direction||"").toLowerCase()!=="out")return;const x=Math.abs(Number(g.amount||0));if(!Number.isFinite(x)||x<=0)return;const E=String(g.source||"").toLowerCase();if(E!=="po"&&E!=="fo")return;const X=String(g.sourceNumber||"").trim(),U=String(g.sourceId||"").trim(),Oe=String(g.id||g.label||"").trim(),le=X||U||Oe||"ohne-nummer",Y=g.meta&&typeof g.meta=="object"?g.meta:{},Be=E==="fo"&&(g.provisional===!0||Y.phantom===!0||(U?ge.has(U):!1)),Pe=E==="po"?"outflows-po":Be?"outflows-phantom-fo":"outflows-fo",h=e[Pe],I=`${E}:${le}`;let C=h.get(I);if(!C){const R=be.get(`${E}:${le}`)||(X?be.get(`${E}:${X}`):void 0)||(U?be.get(`${E}:${U}`):void 0);C={key:`order:${Pe}:${E}:${le}`,label:`${String(E).toUpperCase()} ${le}`,values:Ue(k),aliases:new Set((R==null?void 0:R.aliases)||[]),units:(R==null?void 0:R.units)??null,paymentMix:{paid:0,open:0,unknown:0},payments:new Map},h.set(I,C)}C.values[o]+=-x,g.paid===!0?C.paymentMix.paid+=x:g.paid===!1?C.paymentMix.open+=x:C.paymentMix.unknown+=x;const ce=String(Y.alias||"").trim();ce&&C.aliases.add(ce);const ee=Number(Y.units??Y.qty??Y.quantity);if(Number.isFinite(ee)&&ee>0){const R=Number(C.units||0);C.units=Number.isFinite(R)?R+ee:ee}const fe=String(g.label||"").trim()||"Zahlung",xe=String(g.date||"").trim()||null,T=g.paid===!0?"paid":g.paid===!1?"open":"unknown",te=`${fe}|${xe||""}|${T}`;let ne=C.payments.get(te);ne||(ne={key:`payment:${C.key}:${te}`,label:fe,values:Ue(k),paymentDueDate:xe,paymentMix:{paid:0,open:0,unknown:0}},C.payments.set(te,ne)),ne.values[o]+=-x,g.paid===!0?ne.paymentMix.paid+=x:g.paid===!1?ne.paymentMix.open+=x:ne.paymentMix.unknown+=x})});const s=(a,o)=>Array.from(a.values()).sort((b,p)=>ve(p.values)-ve(b.values)).map(b=>{const p=Array.from(b.payments.values()).sort((x,E)=>ve(E.values)-ve(x.values)).map(x=>({key:x.key,label:x.label,values:x.values,rowType:"payment",paymentStatus:gn(x.paymentMix),paymentDueDate:x.paymentDueDate})),g=Number(b.units);return{key:b.key,label:b.label,values:b.values,rowType:"order",orderType:o,aliases:Array.from(b.aliases),units:Number.isFinite(g)&&g>0?g:null,paymentMix:b.paymentMix,children:p.length?p:void 0}});return{po:s(e["outflows-po"],"po"),fo:s(e["outflows-fo"],"fo"),phantom:s(e["outflows-phantom-fo"],"phantom")}},[V,be,ge,S,k]),Ke=i.useMemo(()=>{const e=new Map(S.map(a=>[a.month,a])),s=a=>{const o=Ue(k);return k.forEach(b=>{o[b]=Number(a(b)||0)}),o};return[{key:"inflows",label:"Einnahmen",rowType:"group",values:s(a=>{var o;return((o=q.get(a))==null?void 0:o.total)||0}),children:[{key:"inflows-amazon-core",label:"Amazon Kernprodukte",rowType:"category",values:s(a=>{var o;return((o=q.get(a))==null?void 0:o.amazonCore)||0})},{key:"inflows-amazon-plan",label:"Amazon geplante Produkte",rowType:"category",values:s(a=>{var o;return((o=q.get(a))==null?void 0:o.amazonPlanned)||0})},{key:"inflows-amazon-new",label:"Amazon neue Produkte",rowType:"category",values:s(a=>{var o;return((o=q.get(a))==null?void 0:o.amazonNew)||0})},{key:"inflows-other",label:"Sonstige Einzahlungen",rowType:"category",values:s(a=>{var o;return((o=q.get(a))==null?void 0:o.other)||0})}]},{key:"outflows",label:"Ausgaben",rowType:"group",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.total)||0)}),children:[{key:"outflows-po",label:"PO",rowType:"category",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.po)||0)}),children:J.po.length?J.po:void 0},{key:"outflows-fo",label:"FO",rowType:"category",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.fo)||0)}),children:J.fo.length?J.fo:void 0},{key:"outflows-phantom-fo",label:"Phantom FO",rowType:"category",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.phantomFo)||0)}),children:J.phantom.length?J.phantom:void 0},{key:"outflows-fixcost",label:"Fixkosten",rowType:"category",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.fixcost)||0)})},{key:"outflows-other",label:"Sonstige Auszahlungen",rowType:"category",values:s(a=>{var o;return-(((o=$.get(a))==null?void 0:o.other)||0)})}]},{key:"net",label:"Netto Cashflow",rowType:"total",values:s(a=>{var o;return Number(((o=e.get(a))==null?void 0:o.net)||0)})},{key:"closing",label:"Kontostand",rowType:"total",values:s(a=>{var o;return Number(((o=e.get(a))==null?void 0:o.closing)||0)})}]},[q,J,$,S,k]),_=i.useMemo(()=>yn(Ke),[Ke]);i.useEffect(()=>{const e=new Set(_);Ne(s=>s.filter(a=>e.has(a)))},[_]);const Bt=i.useMemo(()=>{if(!_.length)return!1;const e=new Set(we);return _.every(s=>e.has(s))},[_,we]),Pt=i.useCallback(()=>{Ne(e=>{const s=new Set(e);return _.length>0&&_.every(o=>s.has(o))?[]:_.slice()})},[_]),Lt=i.useMemo(()=>[{title:"Position",key:"label",dataIndex:"label",fixed:"left",width:380,render:(e,s)=>{if(s.rowType==="order"){const o=Array.isArray(s.aliases)?s.aliases.filter(Boolean):[],b=o.length>2?`${o.slice(0,2).join(", ")} +${o.length-2}`:o.join(", "),p=s.paymentMix||{paid:0,open:0,unknown:0},g=p.paid+p.open+p.unknown,x=g>0?g:1,E=`${Math.max(0,Math.min(100,p.paid/x*100))}%`,X=`${Math.max(0,Math.min(100,p.open/x*100))}%`,U=`${Math.max(0,Math.min(100,p.unknown/x*100))}%`;return t.jsxs("div",{className:"v2-dashboard-pnl-label-cell",children:[t.jsxs(j,{size:6,wrap:!0,children:[t.jsx(y,{strong:!0,children:s.label}),s.orderType==="phantom"?t.jsx(z,{color:"gold",children:"Phantom"}):null,b?t.jsxs(y,{type:"secondary",children:["Alias: ",b]}):null,Number.isFinite(Number(s.units))&&Number(s.units)>0?t.jsxs(z,{children:["Stk: ",on(s.units,0)]}):null]}),g>0?t.jsxs("div",{className:"v2-dashboard-pnl-paybar",title:`Bezahlt ${F(p.paid)} · Offen ${F(p.open)} · Unklar ${F(p.unknown)}`,children:[t.jsx("span",{className:"is-paid",style:{width:E}}),t.jsx("span",{className:"is-open",style:{width:X}}),t.jsx("span",{className:"is-unknown",style:{width:U}})]}):null]})}if(s.rowType==="payment"){const o=s.paymentStatus==="paid"?t.jsx(z,{color:"green",children:"Bezahlt"}):s.paymentStatus==="open"?t.jsx(z,{color:"orange",children:"Offen"}):s.paymentStatus==="mixed"?t.jsx(z,{color:"blue",children:"Gemischt"}):t.jsx(z,{children:"Unklar"});return t.jsxs(j,{size:6,wrap:!0,children:[t.jsx(y,{children:s.label}),s.paymentDueDate?t.jsxs(y,{type:"secondary",children:["Fällig: ",an(s.paymentDueDate)]}):null,o]})}const a=s.key==="inflows"||s.key==="outflows"||s.key==="net"||s.key==="closing";return t.jsx(y,{strong:a,children:s.label})}},...k.map(e=>({title:oe(e),key:e,width:132,align:"right",render:(s,a)=>{const o=Number(a.values[e]||0),b=a.key==="closing",p=!b&&o<0;return t.jsx(y,{strong:a.key==="net"||a.key==="closing",type:p?"danger":void 0,children:b?F(o):xt(o)})}}))],[k]);function $t(){m("next6"),v(yt.slice()),w(ze?"calibrated":"forecast"),O("manual"),M("basis"),Se(!0)}function _t(e){if(!u)return;const s=e.month||u.month;if(e.checkKey==="cash_in"){c(G("/v2/abschluss/eingaben",{source:"dashboard",month:s}));return}if(e.checkKey==="fixcost"){c(G("/v2/abschluss/fixkosten",{source:"dashboard",month:s}));return}if(e.checkKey==="vat"){c(G("/v2/abschluss/ust",{source:"dashboard",month:s}));return}if(e.checkKey==="revenue_inputs"&&e.sku){c(G("/v2/products",{source:"dashboard",issues:"revenue",sku:e.sku}));return}if(e.issueType==="order_duty"&&e.sku){c(dn({sku:e.sku,month:s,suggestedUnits:e.suggestedUnits??null,requiredArrivalDate:e.requiredArrivalDate||null,recommendedOrderDate:e.recommendedOrderDate||null,source:"inventory_projection",firstRiskMonth:e.firstRiskMonth||null,orderMonth:e.orderMonth||null,leadTimeDays:e.leadTimeDays??null,returnTo:"/v2/dashboard"}));return}if(e.issueType==="forecast_missing"&&e.sku){c(St({sku:e.sku,month:s}));return}if((e.issueType==="stock_oos"||e.issueType==="stock_under_safety")&&e.sku){c(Ve({risk:e.issueType==="stock_oos"?"oos":"under_safety",abc:e.abcClass&&(e.abcClass==="A"||e.abcClass==="B")?"ab":"all",month:e.firstRiskMonth||s,sku:e.sku,mode:u.coverage.projectionMode||null}));return}c(kt({route:e.route,checkKey:e.checkKey,month:s,sku:e.sku||null,mode:u.coverage.projectionMode||null}))}return((ht=(mt=n.settings)==null?void 0:mt.featureFlags)==null?void 0:ht.executiveDashboardV2)!==!1?t.jsxs("div",{className:"v2-page",children:[t.jsxs(Z,{className:"v2-intro-card",children:[t.jsxs("div",{className:"v2-page-head",children:[t.jsxs("div",{children:[t.jsx($e,{level:3,children:"Dashboard"}),t.jsx(gt,{children:"Berechnungs-Cockpit für Kontostand und Cashflow. Details öffnest du bei Bedarf in den Fach-Tabs."})]}),t.jsxs("div",{className:"v2-toolbar-field",children:[t.jsx(y,{children:"Zeitraum"}),t.jsx(pt,{value:d,onChange:e=>m(e),options:_e.map(e=>({value:e.value,label:e.label})),style:{width:220,maxWidth:"100%"}})]}),t.jsxs("div",{className:"v2-toolbar-field",children:[t.jsx(y,{children:"PFO bis"}),t.jsx(pt,{value:H||void 0,onChange:e=>je(String(e||"")),options:K.map(e=>({value:e,label:oe(e)})),style:{width:220,maxWidth:"100%"},disabled:!K.length})]})]}),t.jsx("div",{className:"v2-toolbar",children:t.jsxs(y,{type:"secondary",children:["Zeitraum: ",Nt," (",k.length," Monate) · PFO bis: ",H?oe(H):"—"]})})]}),l?t.jsx(ue,{type:"error",showIcon:!0,message:l}):null,r?t.jsx(ue,{type:"info",showIcon:!0,message:"Workspace wird geladen..."}):null,at>0?t.jsx(ue,{type:"warning",showIcon:!0,message:`Forecast-Änderung: ${at} FOs prüfen`,description:t.jsx(Q,{size:"small",onClick:()=>c("/v2/forecast?panel=conflicts"),children:"Zur Konfliktliste"})}):null,t.jsx(Vt,{title:u?`Monats-Check: ${oe(u.month)}`:"Monats-Check",placement:"right",width:520,open:Mt&&!!u,onClose:()=>qe(!1),destroyOnClose:!1,children:u?t.jsxs(j,{direction:"vertical",size:12,style:{width:"100%"},children:[t.jsxs(j,{wrap:!0,children:[t.jsx(z,{color:(Fe==null?void 0:Fe.color)||"default",children:u.coverage.statusLabel}),t.jsxs(y,{children:["Coverage ",vt(u.coverage.ratio*100)," (",u.coverage.coveredSkus,"/",u.coverage.activeSkus,"),"," ","Bestand ",u.coverage.stockIssueCount,","," ","Bestellpflicht ",u.coverage.orderDutyIssueCount,","," ","Blocker ",u.coverage.blockerCount]}),ye?t.jsx(z,{children:"Vergangen (Info)"}):null]}),t.jsx(Z,{size:"small",title:"A) Kriterien (transparent & nachvollziehbar)",children:t.jsxs(j,{direction:"vertical",size:8,style:{width:"100%"},children:[t.jsxs(j,{wrap:!0,children:[t.jsx(se,{title:"Coverage zeigt den Anteil aktiver SKUs ohne Bestands- oder Bestellpflicht-Risiko im Monat.",children:t.jsx(z,{icon:t.jsx(ae,{}),children:"Coverage"})}),t.jsx(se,{title:"Blocker sind harte Abweichungen, die den Monatsstatus verschlechtern und aktiv behoben werden sollten.",children:t.jsx(z,{icon:t.jsx(ae,{}),children:"Blocker"})})]}),Ft.map(e=>t.jsxs("div",{style:{border:"1px solid #f0f0f0",borderRadius:8,padding:10},children:[t.jsxs(j,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsxs(y,{strong:!0,children:[ln(e.state)," ",e.label]}),e.route?t.jsx(Q,{size:"small",onClick:()=>c(kt({route:e.route,month:u.month,mode:u.coverage.projectionMode})),children:"Öffnen"}):null]}),t.jsx(y,{type:"secondary",children:e.description})]},e.key))]})}),t.jsx(Z,{size:"small",title:"B) Konkrete Blocker & To-Dos",children:u.coverage.statusKey==="full"?t.jsx(ue,{type:"success",showIcon:!0,message:"Status ist Vollständig. Es sind keine To-Dos offen."}):ye?t.jsx(ue,{type:"info",showIcon:!0,message:"Vergangener Monat",description:"Zur Einordnung werden die Ursachen angezeigt, es besteht keine To-Do-Pflicht mehr."}):t.jsxs(j,{direction:"vertical",size:10,style:{width:"100%"},children:[t.jsxs("div",{children:[t.jsx(y,{strong:!0,children:"1) Blocker"}),u.blockers.length?t.jsx(j,{direction:"vertical",size:8,style:{width:"100%",marginTop:6},children:u.blockers.map(e=>t.jsxs("div",{style:{border:"1px solid #f0f0f0",borderRadius:8,padding:10},children:[t.jsxs(j,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsx(z,{color:"red",children:"Blocker"}),t.jsx(Q,{size:"small",onClick:()=>_t(e),children:"Öffnen"})]}),t.jsx(y,{children:e.message})]},e.id))}):t.jsx("div",{children:t.jsx(y,{type:"secondary",children:"Keine expliziten Blocker gelistet."})})]}),t.jsxs("div",{children:[t.jsx(y,{strong:!0,children:"2) Warnungen"}),it.length?t.jsx(j,{direction:"vertical",size:8,style:{width:"100%",marginTop:6},children:it.map(e=>t.jsxs("div",{style:{border:"1px solid #f0f0f0",borderRadius:8,padding:10},children:[t.jsxs(j,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsx(z,{color:"gold",children:"Warnung"}),t.jsx(Q,{size:"small",onClick:()=>c(e.route),children:"Öffnen"})]}),t.jsx(y,{children:e.message})]},e.id))}):t.jsx("div",{children:t.jsx(y,{type:"secondary",children:"Keine Warnungen."})})]})]})})]}):t.jsx(y,{type:"secondary",children:"Kein Monat gewählt."})}),t.jsxs(Z,{className:"v2-dashboard-chart-card",children:[t.jsx($e,{level:4,children:"Kontostand & Cashflow"}),t.jsxs("div",{className:"v2-calc-cockpit-shell",children:[t.jsxs("div",{className:"v2-calc-cockpit-status",children:[t.jsxs(j,{wrap:!0,children:[t.jsxs(y,{type:"secondary",children:["Min. Kontostand: ",t.jsx("strong",{children:F(It)})]}),t.jsxs(y,{type:"secondary",children:["Summe Netto: ",t.jsx("strong",{children:F(De)})]})]}),t.jsx(Q,{size:"small",onClick:$t,children:"Zurücksetzen"})]}),t.jsxs("div",{className:"v2-calc-cockpit-modules",children:[t.jsxs(Z,{size:"small",className:"v2-calc-cockpit-module",children:[t.jsxs(j,{size:6,children:[t.jsx(y,{strong:!0,children:"Portfolio-Scope"}),t.jsx(se,{title:"Bestimmt, welche Produktgruppen in Umsatz, Cash-In, PnL und Kontostand einfließen. Stammdaten werden nicht verändert.",children:t.jsx(ae,{})})]}),t.jsx("div",{children:t.jsx(y,{type:"secondary",children:"Wirkt auf Kontostand & PnL"})}),t.jsx("div",{className:"v2-calc-cockpit-chip-row",children:sn.map(e=>{const s=f.includes(e.value);return t.jsx(Q,{size:"small",type:s?"primary":"default",onClick:()=>Ct(e.value),children:e.label},e.value)})}),t.jsx(y,{type:"secondary",children:"Bestimmt nur die aktuelle Berechnung im Dashboard."})]}),t.jsxs(Z,{size:"small",className:"v2-calc-cockpit-module",children:[t.jsxs(j,{size:6,children:[t.jsx(y,{strong:!0,children:"Umsatzbasis"}),t.jsx(se,{title:"Forecast-Umsatz = Absatzprognose × Verkaufspreis. Kalibrierter Umsatz = Forecast-Umsatz mit Kalibrierfaktor aus Eingaben.",children:t.jsx(ae,{})})]}),t.jsx("div",{children:t.jsx(y,{type:"secondary",children:"Wirkt auf Kontostand & PnL"})}),t.jsx(Le,{block:!0,value:D,onChange:e=>w(String(e)==="calibrated"?"calibrated":"forecast"),options:[{label:"Forecast-Umsatz",value:"forecast"},{label:"Kalibrierter Umsatz",value:"calibrated"}]}),t.jsxs(y,{type:"secondary",children:[D==="calibrated"?`Kalibrierung aktiv (wirkt über ${wt} Monate).`:"Kalibrierung aus."," ",t.jsx(Q,{size:"small",type:"link",onClick:()=>c("/v2/abschluss/eingaben"),children:D==="calibrated"?"Eingaben öffnen":"In Eingaben aktivieren"})]}),D==="calibrated"&&!Tt?t.jsx(y,{type:"warning",children:"Keine wirksamen Kalibrierdaten gefunden. Das Diagramm entspricht aktuell dem Forecast-Umsatz."}):null]}),t.jsxs(Z,{size:"small",className:"v2-calc-cockpit-module",children:[t.jsxs(j,{size:6,children:[t.jsx(y,{strong:!0,children:"Amazon Auszahlungsquote"}),t.jsx(se,{title:"Manuell nutzt die Monatsquote aus Eingaben. Empfehlung berechnet die Quote automatisch als Vorschlag je Monat.",children:t.jsx(ae,{})})]}),t.jsx("div",{children:t.jsx(y,{type:"secondary",children:"Wirkt auf Kontostand & PnL"})}),t.jsx(Le,{block:!0,value:A,onChange:e=>O(String(e)==="recommendation"?"recommendation":"manual"),options:[{label:"Manuelle Quote",value:"manual"},{label:"Empfehlung",value:"recommendation"}]}),t.jsxs(j,{direction:"vertical",size:6,style:{width:"100%"},children:[t.jsxs(j,{size:6,children:[t.jsx(y,{strong:!0,children:"Sicherheitsmodus"}),t.jsx(se,{title:"Basis: keine Sicherheitsmarge. Konservativ: reduziert die Quote in zukünftigen Monaten um 1pp pro Monat (max. 5pp).",children:t.jsx(ae,{})})]}),t.jsx(Le,{block:!0,value:N,onChange:e=>M(String(e)==="conservative"?"conservative":"basis"),options:[{label:"Basis",value:"basis"},{label:"Konservativ",value:"conservative"}]})]}),Dt?t.jsxs("div",{className:"v2-calc-cockpit-q4-row",children:[t.jsx(tn,{checked:B,onChange:e=>Se(e.target.checked),children:"Saisonalität (Q4) berücksichtigen"}),t.jsx(se,{title:"Q4 berücksichtigt saisonale Besonderheiten für Oktober bis Dezember. Gilt nur für die Empfehlung.",children:t.jsx(ae,{})})]}):null,t.jsx(y,{type:"secondary",children:A==="manual"?"Verwendet die manuell gepflegte Auszahlungsquote je Monat.":"Empfehlung wird je Monat automatisch berechnet und direkt im Chart angewendet."})]})]})]}),t.jsxs("div",{className:"v2-dashboard-chart-summary",children:[t.jsxs(z,{color:"green",children:["Einzahlungen: ",F(At)]}),t.jsxs(z,{color:"red",children:["Auszahlungen: ",F(Et)]}),t.jsxs(z,{color:De>=0?"green":"red",children:["Netto: ",F(De)]}),ie.length?t.jsxs(z,{color:"gold",children:["PFO: ",ie.length]}):null,H?t.jsxs(z,{color:"gold",children:["bis ",oe(H)]}):null]}),t.jsx(y,{type:"secondary",className:"v2-dashboard-chart-hint",children:"Klick auf Monat oder Balken für Details. Legende ist scrollbar."}),t.jsx(qt,{style:{height:430},option:Ot,onEvents:Kt})]}),t.jsxs(Z,{children:[t.jsxs(j,{style:{width:"100%",justifyContent:"space-between"},wrap:!0,children:[t.jsxs("div",{children:[t.jsx($e,{level:4,children:"Monatliche PnL (Matrix)"}),t.jsx(gt,{type:"secondary",children:"Zeilen = Einnahmen/Ausgaben-Struktur, Spalten = gewählter Zeitraum. Bei PO/FO/Phantom siehst du auf Wunsch die einzelnen Zahlungen."})]}),t.jsx(Q,{size:"small",onClick:Pt,children:Bt?"Alles zuklappen":"Alles aufklappen"})]}),t.jsx(nn,{className:"v2-dashboard-pnl-table",columns:Lt,dataSource:Ke,pagination:!1,size:"small",rowKey:"key",rowClassName:e=>e.rowType==="order"?"v2-dashboard-pnl-table-row-order":e.rowType==="payment"?"v2-dashboard-pnl-table-row-payment":e.key==="net"||e.key==="closing"?"v2-dashboard-pnl-table-row-total":Array.isArray(e.children)&&e.children.length?"v2-dashboard-pnl-table-row-group":"v2-dashboard-pnl-table-row-detail",expandable:{expandedRowKeys:we,onExpandedRowsChange:e=>Ne(e.map(s=>String(s)))},scroll:{x:"max-content"}})]})]}):t.jsx("div",{className:"v2-page",children:t.jsx(ue,{type:"info",showIcon:!0,message:"Executive Dashboard ist per Feature-Flag deaktiviert (settings.featureFlags.executiveDashboardV2=false)."})})}export{qn as default};
